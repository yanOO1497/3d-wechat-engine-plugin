"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _get(e,t,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var r=_superPropBase(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(i):n.value}})(e,t,i||e)}function set(e,t,i,r){return(set="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,i,r){var n,s=_superPropBase(e,t);if(s){if((n=Object.getOwnPropertyDescriptor(s,t)).set)return n.set.call(r,i),!0;if(!n.writable)return!1}if(n=Object.getOwnPropertyDescriptor(r,t)){if(!n.writable)return!1;n.value=i,Object.defineProperty(r,t,n)}else _defineProperty(r,t,i);return!0})(e,t,i,r)}function _set(e,t,i,r,n){if(!set(e,t,i,r||e)&&n)throw new Error("failed to set property");return i}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _initializerDefineProperty(e,t,i,r){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(r):void 0})}function _applyDecoratedDescriptor(i,r,e,t,n){var s={};return Object.keys(t).forEach(function(e){s[e]=t[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=e.slice().reverse().reduce(function(e,t){return t(i,r,e)||e},s),n&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(n):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(i,r,s),s=null),s}Object.defineProperty(exports,"__esModule",{value:!0});var _global="undefined"==typeof window?global:window,cc$1=_global.cc=_global.cc||{};function defineMacro(e,t){void 0===_global[e]&&(_global[e]=t)}function defined(e){return"object"===_typeof(_global[e])}cc$1.internal=cc$1.internal||{},cc$1._global=_global,defineMacro("CC_BUILD",!1),_global.CC_BUILD=!0,_global.CC_TEST=!1,_global.CC_EDITOR=!1,_global.CC_PREVIEW=!1,_global.CC_DEV=!1,_global.CC_DEBUG=!1,_global.CC_JSB=!1,_global.CC_WECHATGAME=!0,_global.CC_QQPLAY=!1,_global.CC_RUNTIME=!1,_global.CC_SUPPORT_JIT=!1,_global.CC_PHYSICS_BUILTIN=!1,_global.CC_PHYSICS_CANNON=!0,_global.CC_PHYSICS_AMMO=!1;var engineVersion="1.0.1";_global.CocosEngine=cc$1.ENGINE_VERSION=engineVersion,Object.defineProperty(_global,"CC_PHYSICS_BUILT_IN",{get:function(){return console.warn("CC_PHYSICS_BUILT_IN is deprecated, please using CC_PHYSICS_BUILTIN instead."),_global.CC_PHYSICS_BUILTIN}});var debugInfos={1100:"Expected 'data' dict, but not found. Config file: %s",1101:"Please load the resource first : %s",1200:"cocos2d: Director: Error in gettimeofday",1204:"running scene should not null",1205:"the scene should not null",1206:"loadScene: The scene index to load (%s) is out of range.",1207:"loadScene: Unknown name type to load: '%s'",1208:"loadScene: Failed to load scene '%s' because '%s' is already loading",1209:"loadScene: Can not load the scene '%s' because it was not in the build settings before playing.",1210:"Failed to preload '%s', %s",1211:"loadScene: The scene index to load (%s) is out of range.",1212:"loadScene: Unknown name type to load: '%s'",1213:"loadScene: Failed to load scene '%s' because '%s' is already loading",1214:"loadScene: Can not load the scene '%s' because it was not in the build settings before playing.",1215:"Failed to preload '%s', %s",1216:"Director.runSceneImmediate: scene is not valid",1300:"element type is wrong!",1400:"'%s' is deprecated, please use '%s' instead.",1401:"The first argument should be the destination object",1402:"The 'visible' property of %s is deprecated, use 'enabled' instead please.",1403:"Sorry, cc.audioEngine.willPlayMusic is removed.",1404:"cc.spriteFrameCache is removed, please use cc.loader to load and cache sprite frames of atlas format.",1405:"The '%s' will be removed in v2.0, please use '%s' instead.",1406:"'%s.%s' is removed",1407:"cc.pool is being removed from v2.0, you are getting cc.js.Pool instead",1502:"cc.scheduler.scheduleCallbackForTarget(): target should be non-null.",1503:"cc.Scheduler.pauseTarget():target should be non-null",1504:"cc.Scheduler.resumeTarget():target should be non-null",1505:"cc.Scheduler.isTargetPaused():target should be non-null",1506:"warning: you CANNOT change update priority in scheduled function",1507:"scheduler#scheduleSelector. Selector already scheduled. Updating interval from: %.4f to %.4f",1508:"Argument callback must not be empty",1509:"Argument target must be non-nullptr",1510:"cc.Scheduler: Illegal target which doesn't have id, you should do Scheduler.enableForTarget(target) before all scheduler API usage on target",1511:"cc.Scheduler: pause state of the scheduled task doesn't match the element pause state in Scheduler, the given paused state will be ignored.",1512:"cc.Scheduler: updateFunc parameter is deprecated in scheduleUpdate function, and will be removed in v2.0",1513:"cc.Scheduler: scheduler stopped using `__instanceId` as id since v2.0, you should do Scheduler.enableForTarget(target) before all scheduler API usage on target",1605:"child already added. It can't be added again",1606:"child must be non-null",1607:"removeFromParentAndCleanup is deprecated. Use removeFromParent instead",1608:"boundingBox is deprecated. Use getBoundingBox instead",1609:"argument tag is an invalid tag",1619:"callback function must be non-null",1620:"interval must be positive",1623:"Set '%s' to normal node (not persist root node).",1624:"Replacing with the same sgNode",1625:"The replacement sgNode should not contain any child.",1626:"Should not set alpha via 'color', set 'opacity' please.",1627:"Not support for asynchronous creating node in SG",1632:"Node name can not include '/'.",1633:"Internal error, should not remove unknown node from parent.",1634:"addChild: The child to add must be instance of cc.Node, not %s.",1635:"reorderChild: this child is not in children list.",1636:"Node's zIndex value can't be greater than cc.macro.MAX_ZINDEX, setting to the maximum value",1637:"Node's zIndex value can't be smaller than cc.macro.MIN_ZINDEX, setting to the minimum value",1638:"Private node's zIndex can't be set, it will keep cc.macro.MIN_ZINDEX as its value",1800:"cc._EventListenerKeyboard.checkAvailable(): Invalid EventListenerKeyboard!",1801:"cc._EventListenerTouchOneByOne.checkAvailable(): Invalid EventListenerTouchOneByOne!",1802:"cc._EventListenerTouchAllAtOnce.checkAvailable(): Invalid EventListenerTouchAllAtOnce!",1803:"cc._EventListenerAcceleration.checkAvailable(): _onAccelerationEvent must be non-nil",1900:"Invalid parameter.",2200:"Resolution not valid",2201:"should set resolutionPolicy",2300:"The touches is more than MAX_TOUCHES, nUnusedIndex = %s",3103:"textureUtil.addImage(): path should be non-null",3119:"Lazy init texture with image element failed due to image loading failure: %s",3300:"Rect width exceeds maximum margin: %s",3301:"Rect height exceeds maximum margin: %s",3500:"0 priority is forbidden for fixed priority since it's used for scene graph based priority.",3501:"Invalid listener type!",3502:"Can't set fixed priority with scene graph based listener.",3503:"Invalid parameters.",3504:"listener must be a cc.EventListener object when adding a fixed priority listener",3505:"The listener has been registered, please don't register it again.",3506:"Unsupported listener target.",3507:"Invalid scene graph priority!",3508:"If program goes here, there should be event in dispatch.",3509:"_inDispatch should be 1 here.",3510:"%s's scene graph node not contains in the parent's children",3511:"event is undefined",3512:"Event manager only support scene graph priority for ui nodes which contain UIComponent",3600:"cc.Class will automatically call super constructor of %s, you should not call it manually.",3601:"The editor property 'playOnFocus' should be used with 'executeInEditMode' in class '%s'",3602:"Unknown editor property '%s' in class '%s'.",3603:"Use 'cc.Float' or 'cc.Integer' instead of 'cc.Number' please.",3604:"Can only indicate one type attribute for %s.",3605:"The default value of %s is not instance of %s.",3606:"No needs to indicate the '%s' attribute for %s, which its default value is type of %s.",3607:"The default value of %s must be an empty string.",3608:"The type of %s must be CCString, not String.",3609:"The type of %s must be CCBoolean, not Boolean.",3610:"The type of %s must be CCFloat or CCInteger, not Number.",3611:"Can not indicate the '%s' attribute for %s, which its default value is type of %s.",3612:"%s Just set the default value to 'new %s()' and it will be handled properly.",3613:"'No need to use 'serializable: false' or 'editorOnly: true' for the getter of '%s.%s', every getter is actually non-serialized.",3614:"Should not define constructor for cc.Component %s.",3615:"Each script can have at most one Component.",3616:"Should not specify class name %s for Component which defines in project.",3617:"Can not instantiate CCClass '%s' with arguments.",3618:"ctor of '%s' can not be another CCClass",3619:"ctor of '%s' must be function type",3620:"this._super declared in '%s.%s' but no super method defined",3621:"Unknown type of %s.%s, maybe you want is '%s'.",3622:"Unknown type of %s.%s, property should be defined in 'properties' or 'ctor'",3623:"Can not use 'editor' attribute, '%s' not inherits from Components.",3624:"'%s' overrided '%s' but '%s' is defined as 'false' so the super method will not be called. You can set '%s' to null to disable this warning.",3625:"[isChildClassOf] superclass should be function type, not",3626:"Can't remove '%s' because '%s' depends on it.",3627:"Should not add renderer component (%s) to a Canvas node.",3628:"Should not add %s to a node which size is already used by its other component.",3629:"attribute must be type object",3633:"Properties function of '%s' should return an object!",3634:"Disallow to use '.' in property name",3635:"Default array must be empty, set default value of %s.%s to [], and initialize in 'onLoad' or 'ctor' please. (just like 'this.%s = [...];')",3636:"Do not set default value to non-empty object, unless the object defines its own 'clone' function. Set default value of %s.%s to null or {}, and initialize in 'onLoad' or 'ctor' please. (just like 'this.%s = {foo: bar};')",3637:"Can not declare %s.%s, it is already defined in the prototype of %s",3638:"'%s': the getter of '%s' is already defined!",3639:"Can not apply the specified attribute to the getter of '%s.%s', attribute index: %s",3640:"'%s': the setter of '%s' is already defined!",3641:"Can not construct %s because it contains object property.",3642:"Cannot define %s.%s because static member name can not be '%s'.",3643:"Can not define a member called 'constructor' in the class '%s', please use 'ctor' instead.",3644:"Please define 'type' parameter of %s.%s as the actual constructor.",3645:"Please define 'type' parameter of %s.%s as the constructor of %s.",3646:"Unknown 'type' parameter of %s.%s：%s",3647:"The length of range array must be equal or greater than 2",3648:"Can not declare %s.%s method, it is already defined in the properties of %s.",3649:"CCClass %s have conflict between its ctor and __ctor__.",3651:'Can not call `_super` or `prototype.ctor` in ES6 Classes "%s", use `super` instead please.',3652:'Failed to construct a dummy instance of the "%s" class using `new` behind the scenes. This is for getting default values declared in TypeScript. Please ensure the class will be able to construct during script\'s initialization. %s.',3653:'Please do not specifiy "default" attribute in decorator of "%s" property in "%s" class.\nDefault value must be initialized at their declaration:\n \n// Before:\n@property({ default: 0 }) // <-- \n@integer\nvalue;\n// After:\n@integer\nvalue = 0;    // <--',3654:'Please specifiy a default value for "%s" property at its declaration:\n \n// Before:\n@property(...)\nvalue;\n// After:\n@property(...)\nvalue = 0',3655:'Can not specifiy "get" or "set"  attribute in decorator for "%s" property in "%s" class.\nPlease use:\n \n@property(...)\nget %s () {\n    ...\n}\n@property\nset %s (value) {\n    ...\n}',3656:"The default value of %s.%s must be an empty string. (changed since 1.8)",3657:"The value assigned to %s should be Texture2D object, not url string. Since 1.8,\nyou can declare a texture object directly in properties by using:\n \n{\n    default: null,\n    type: cc.Texture2D  // use 'type:' instead of 'url:'\n}",3658:"browser does not support getters",3659:"Violation error: extending enumerations shall have non-overlaped member names or member values",3700:"internal error: _prefab is undefined",3701:"Failed to load prefab asset for node '%s'",3800:"The target can not be made persist because it's not a cc.Node or it doesn't have _id property.",3801:"The node can not be made persist because it's not under root node.",3802:"The node can not be made persist because it's not in current scene.",3803:"The target can not be made persist because it's not a cc.Node or it doesn't have _id property.",3804:"getComponent: Type must be non-nil",3805:"Can't add component '%s' because %s already contains the same component.",3806:"Can't add component '%s' to %s because it conflicts with the existing '%s' derived component.",3807:"addComponent: Failed to get class '%s'",3808:"addComponent: Should not add component ('%s') when the scripts are still loading.",3809:"addComponent: The component to add must be a constructor",3810:"addComponent: The component to add must be child class of cc.Component",3811:"_addComponentAt: The component to add must be a constructor",3812:"_addComponentAt: Index out of range",3813:"removeComponent: Component must be non-nil",3814:"Argument must be non-nil",3815:"Component not owned by this entity",3816:"Node '%s' is already activating",3817:"Sorry, the component of '%s' which with an index of %s is corrupted! It has been removed.",3818:"Failed to read or parse project.json",3819:"Warning: target element is not a DIV or CANVAS",3820:"The renderer doesn't support the renderMode %s",3821:"Cannot change hierarchy while activating or deactivating the parent.",3822:"addComponent: Cannot add any component to the scene.",3900:"Invalid clip to add",3901:"Invalid clip to remove",3902:"clip is defaultClip, set force to true to force remove clip and animation state",3903:"animation state is playing, set force to true to force stop and remove clip and animation state",3904:"motion path of target [%s] in prop [%s] frame [%s] is not valid",3905:"sprite frames must be an Array.",3906:"Can't find easing type [%s]",3907:"animator not added or already removed",3908:"animation not added or already removed",3912:"already-playing",4e3:"Sorry, the cc.Font has been modified from Raw Asset to Asset. Please load the font asset before using.",4003:"Label font size can't be shirnked less than 0!",4004:"force notify all fonts loaded!",4011:"Property spriteFrame of Font '%s' is invalid. Using system font instead.",4012:"The texture of Font '%s' must be already loaded on JSB. Using system font instead.",4013:"Sorry, lineHeight of system font not supported on JSB.",4100:"Property padding is deprecated, please use paddingLeft, paddingRight, paddingTop and paddingBottom instead",4200:"MaskType: IMAGE_STENCIL only support WebGL mode.",4201:"The alphaThreshold invalid in Canvas Mode.",4202:"The inverted invalid in Canvas Mode.",4300:"can not found the %s page.",4400:"Invalid RichText img tag! The sprite frame name can't be found in the ImageAtlas!",4600:"Script attached to '%s' is missing or invalid.",4700:"The dom control is not created!",4800:"unknown asset type",4901:"loadRes: should not specify the extname in %s %s",4902:"No need to release non-cached asset.",4903:"Can not get class '%s'",4914:"Resources url '%s' does not exist.",4915:"Pack indices and data do not match in size",4916:"Failed to download package for %s",4920:"Sorry, you shouldn't use id as item identity any more, please use url or uuid instead, the current id is being set as url: (%s)",4921:"Invalid pipe or invalid index provided!",4922:"The pipe to be inserted is already in the pipeline!",4923:"Uuid Loader: Parse asset [ %s ] failed : %s",4924:"JSON Loader: Input item doesn't contain string content",4925:"Uuid Loader: Deserialize asset [ %s ] failed : %s",4926:"Audio Downloader: no web audio context.",4927:"Audio Downloader: audio not supported on this browser!",4928:"Load %s failed!",4929:"Load Webp ( %s ) failed",4930:"Load image ( %s ) failed",4931:"Download Uuid: can not find type of raw asset[ %s ]: %s",4932:'Since v1.10, for any atlas ("%s") in the "resources" directory, it is not possible to find the contained SpriteFrames via `loadRes`, `getRes` or `releaseRes`. Load the SpriteAtlas first and then use `spriteAtlas.getSpriteFrame(name)` instead please.',4933:"Download Font [ %s ] failed, using Arial or system default font instead",4934:"Please assure that the full path of sub asset is correct!",5e3:"object already destroyed",5001:"object not yet destroyed",5100:"Not a plist file!",5200:"Warning: localStorage isn't enabled. Please confirm browser cookie or privacy option",5201:"browser don't support web audio",5202:"This feature supports WebGL render mode only.",5300:"Type of target to deserialize not matched with data: target is %s, data is %s",5301:"Can not find script '%s'",5302:"Can not find class '%s'",5400:"'%s' is deprecated, use '%s' instead please.",5401:"'%s' is deprecated, use '%s' instead please.",5402:"cc.js.addon called on non-object:",5403:"cc.js.mixin: arguments must be type object:",5404:"The base class to extend from must be non-nil",5405:"The class to extend must be non-nil",5406:"Class should be extended before assigning any prototype members.",5500:"'notify' can't work with 'get/set' !",5501:"'notify' must work with 'default' !",5502:"Invalid url of %s.%s",5503:"The 'url' attribute of '%s.%s' is undefined when loading script.",5504:"The 'url' type of '%s.%s' must be child class of cc.RawAsset.",5505:"The 'url' type of '%s.%s' must not be child class of cc.Asset, otherwise you should use 'type: %s' instead.",5506:"Can not specify 'type' attribute for '%s.%s', because its 'url' is already defined.",5507:"The 'default' attribute of '%s.%s' must be an array",5508:"Invalid type of %s.%s",5510:"The 'type' attribute of '%s.%s' can not be 'Number', use 'Float' or 'Integer' instead please.",5511:"The 'type' attribute of '%s.%s' is undefined when loading script",5512:"Can not serialize '%s.%s' because the specified type is anonymous, please provide a class name or set the 'serializable' attribute of '%s.%s' to 'false'.",5513:"The 'default' value of '%s.%s' should not be used with a 'get' function.",5514:"The 'default' value of '%s.%s' should not be used with a 'set' function.",5515:"The 'default' value of '%s.%s' can not be an constructor. Set default to null please.",5516:"Property '%s.%s' must define at least one of 'default', 'get' or 'set'.",5517:"'%s.%s' hides inherited property '%s.%s'. To make the current property override that implementation, add the `override: true` attribute please.",5600:"Argument must be non-nil",5601:"Can not get current scene.",5602:"Scene is destroyed",5603:"reference node is destroyed",5700:"no %s or %s on %s",5800:"%s.lerp not yet implemented.",5801:"%s.clone not yet implemented.",5802:"%s.equals not yet implemented.",5900:"MotionStreak only support WebGL mode.",5901:"cc.MotionStreak.getOpacity has not been supported.",5902:"cc.MotionStreak.setOpacity has not been supported.",6e3:"Custom should not be false if file is not specified.",6001:"The new %s must not be NaN",6017:"Incomplete or corrupt PNG file",6018:"Invalid filter algorithm: %s",6019:"Invalid byte order value.",6020:"You forgot your towel!",6021:"Unknown Field Tag: %s",6022:"Too many bits requested",6023:"No bits requested",6024:"Cannot recover from missing StripByteCounts",6025:"Cannot handle sub-byte bits per sample",6026:"Cannot handle sub-byte bits per pixel",6027:"Palette image missing color map",6028:"Unknown Photometric Interpretation: %s",6029:"Unkown error",6030:"cc.ParticleSystem: error decoding or ungzipping textureImageData",6031:"cc.ParticleSystem: unknown image format with Data",6032:"cc.ParticleSystem.initWithDictionary() : error loading the texture",6200:"Canvas doesn't support mesh slot!",6300:"only cc.DrawNode is accepted as stencil",6301:"Stencil buffer is not enabled.",6302:"Nesting more than %d stencils is not supported. Everything will be drawn without stencil for this node and its children.",6400:"asset.url is not usable in core process",6401:"asset.urls is not usable in core process",6402:"AssetLibrary has already been initialized!",6500:"Widget target must be one of the parent nodes of it",6501:"%s's widget target must have UITransformComponent, Please add it in target",6600:"collider not added or already removed",6601:"Can't find testFunc for (%s, $s).",6700:"Can't init canvas '%s' because it conflicts with the existing '%s', the scene should only have one active canvas at the same time",6701:"Should not add Canvas to a node which already contains a renderer component (%s).",6702:"Should not add Canvas to a node which size is already used by its other component.",6703:"Can't initialise DrawingPrimitiveWebGL. context need is WebGLRenderingContext",6704:"Polygon's point must greater than 2",6705:"Argument must be non-nil",6800:"Callback of event must be non-nil",6801:"The message must be provided",6900:"The thing you want to instantiate must be an object",6901:"The thing you want to instantiate is nil",6902:"The thing you want to instantiate is destroyed",6903:"The instantiate method for given asset do not implemented",6904:"Can not instantiate array",6905:"Can not instantiate DOM element",7e3:"Failed to init asset's raw path.",7001:"Should not load '%s' from script dynamically, unless it is placed in the 'resources' folder.",7002:"Sorry can not load '%s' because it is not placed in the 'resources' folder.",7003:"Failed to init builtin asset's raw path.",7100:"%s already defined in Enum.",7101:"Sorry, 'cc.Enum' not available on this platform, please report this error here: https://github.com/cocos-creator/engine/issues/new",7200:"Method 'initWithTMXFile' is no effect now, please set property 'tmxAsset' instead.",7201:"Method 'initWithXML' is no effect now, please set property 'tmxAsset' instead.",7202:"Add component TiledLayer into node failed.",7203:"Property 'mapLoaded' is unused now. Please write the logic to the callback 'start'.",7210:"TMX Hexa zOrder not supported",7211:"TMX invalid value",7214:"propertiesForGID is deprecated. Please use getPropertiesForGID instead.",7215:"cocos2d: Warning: TMX Layer %s has no tiles",7216:"cocos2d: TMXFormat: Unsupported TMX version: %s",7217:"cocos2d: TMXFomat: Unsupported orientation: %s",7218:"cc.TMXMapInfo.parseXMLFile(): unsupported compression method",7219:"cc.TMXMapInfo.parseXMLFile(): Only base64 and/or gzip/zlib maps are supported",7221:"cc.TMXMapInfo.parseXMLFile(): Texture '%s' not found.",7222:"Parse %s failed.",7236:"cc.TMXLayer.getTileAt(): TMXLayer: the tiles map has been released",7237:"cc.TMXLayer.getTileGIDAt(): TMXLayer: the tiles map has been released",7238:"cc.TMXLayer.setTileGID(): TMXLayer: the tiles map has been released",7239:"cc.TMXLayer.setTileGID(): invalid gid: %s",7240:"cc.TMXLayer.getTileFlagsAt(): TMXLayer: the tiles map has been released",7241:"cc.TiledMap.initWithXML(): Map not found. Please check the filename.",7401:"Failed to set _defaultArmatureIndex for '%s' because the index is out of range.",7402:"Failed to set _animationIndex for '%s' because the index is out of range.",7501:"Failed to set _defaultSkinIndex for '%s' because the index is out of range.",7502:"Failed to set _animationIndex for '%s' because its skeletonData is invalid.",7503:"Failed to set _animationIndex for '%s' because the index is out of range.",7504:"Can not render dynamic created SkeletonData",7505:"Invalid type of atlasFile, atlas should be registered as raw asset.",7506:"Failed to load spine atlas '$s'",7507:"Please re-import '%s' because its textures is not initialized! (This workflow will be improved in the future.)",7508:"The atlas asset of '%s' is not exists!",7509:"Spine: Animation not found: %s",7510:"Spine: Animation not found: %s",7600:"The context of RenderTexture is invalid.",7601:"cc.RenderTexture._initWithWidthAndHeightForWebGL() : only RGB and RGBA formats are valid for a render texture;",7602:"Could not attach texture to the framebuffer",7603:"clearDepth isn't supported on Cocos2d-Html5",7604:"saveToFile isn't supported on Cocos2d-Html5",7605:"newCCImage isn't supported on Cocos2d-Html5",7700:"On the web is always keep the aspect ratio",7701:"Can't know status",7702:"Video player's duration is not ready to get now!",7800:"Web does not support loading",7801:"Web does not support query history",7802:"Web does not support query history",7803:"The current browser does not support the GoBack",7804:"The current browser does not support the GoForward",7805:"Web does not support zoom",7900:"cc.math.Matrix3.assign(): current matrix equals matIn",7901:"cc.math.mat4Assign(): pOut equals pIn",7902:"cc.mat.Matrix4.assignFrom(): mat4 equals current matrix",7903:"cc.math.Matrix4 equal: pMat1 and pMat2 are same object.",7904:"cc.math.Matrix4.extractPlane: Invalid plane index",7905:"cc.math.mat4Assign(): pOut equals pIn",7906:"cc.mat.Matrix4.assignFrom(): mat4 equals current matrix",7907:"cc.math.Matrix4 equals: pMat1 and pMat2 are same object.",7908:"Invalid matrix mode specified",7909:"current quaternion is an invalid value",8e3:"Can't handle this field type or size",8001:"No bytes requested",8002:"Too many bytes requested",8003:"Missing StripByteCounts!",8100:"cocos2d: ERROR: Failed to compile shader:\n %s",8101:"cocos2d: ERROR: Failed to compile vertex shader",8102:"cocos2d: ERROR: Failed to compile fragment shader",8103:"cc.GLProgram.link(): Cannot link invalid program",8104:"cocos2d: ERROR: Failed to link program: %s",8105:"cocos2d: cc.shaderCache._loadDefaultShader, error shader type",8106:"Please load the resource firset : %s",8107:"cc.GLProgram.getUniformLocationForName(): uniform name should be non-null",8108:"cc.GLProgram.getUniformLocationForName(): Invalid operation. Cannot get uniform location when program is not initialized",8109:"modelView matrix is undefined.",8200:"Please set node's active instead of rigidbody's enabled.",8300:"Should only one camera exists, please check your project.",8301:"Camera does not support Canvas Mode.",8400:"Wrong type arguments, 'filePath' must be a String.",8401:"Since 1.10, `%s` accept %s instance directly, not a URL string. Please directly reference the %s object in your script, or load %s by loader first. Don't use %s's URL anymore.",9e3:"Stencil manager does not support level bigger than %d in this device.",9001:"Stencil manager is already empty, cannot pop any mask",9100:"texture size exceeds current device limits %d/%d","0100":"%s not yet implemented.","0200":"You should specify a valid DOM canvas element."},ERROR_MAP_URL="https://github.com/cocos-creator/engine/blob/3d-v1.0.0/EngineErrorMap.md",logList=null,ccLog=console.log,ccWarn=console.log,ccError=console.log,ccAssert=function(e,t){if(!e){for(var i=arguments.length,r=new Array(2<i?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];console.log("ASSERT: "+formatString.apply(void 0,[t].concat(r)))}};function formatString(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return cc.js.formatStr.apply(null,[e].concat(i))}function log(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return ccLog.apply(void 0,[e].concat(i))}function warn(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return ccWarn.apply(void 0,[e].concat(i))}function error(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return ccError.apply(void 0,[e].concat(i))}function assert(e,t){for(var i=arguments.length,r=new Array(2<i?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];return ccAssert.apply(void 0,[e,t].concat(r))}function _resetDebugSetting(e){if(ccLog=ccWarn=ccError=ccAssert=function(){},e!==DebugMode.NONE){if(e>DebugMode.ERROR){var s=function(e){if(cc.game.canvas){if(!logList){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",cc.game.canvas.height);var i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(logList=document.createElement("textarea")).setAttribute("rows","20"),logList.setAttribute("cols","30"),logList.setAttribute("disabled","true");var r=logList.style;r.backgroundColor="transparent",r.borderBottom="1px solid #cccccc",r.borderTopWidth=r.borderLeftWidth=r.borderRightWidth="0px",r.borderTopStyle=r.borderLeftStyle=r.borderRightStyle="none",r.padding="0px",r.margin="0px",t.appendChild(logList),cc.game.canvas.parentNode.appendChild(t)}logList.value=logList.value+e+"\r\n",logList.scrollTop=logList.scrollHeight}};ccError=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];s("ERROR :  "+formatString.apply(void 0,[e].concat(i)))},ccAssert=function(e,t){if(!e){for(var i=arguments.length,r=new Array(2<i?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];s("ASSERT: "+formatString.apply(void 0,[t].concat(r)))}},e!==DebugMode.ERROR_FOR_WEB_PAGE&&(ccWarn=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];s("WARN :  "+formatString.apply(void 0,[e].concat(i)))}),e===DebugMode.INFO_FOR_WEB_PAGE&&(ccLog=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];s(formatString.apply(void 0,[e].concat(i)))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),ccError=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return console.error.apply(console,[e].concat(i))},ccAssert=function(e,t){if(!e){for(var i=arguments.length,r=new Array(2<i?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];var s=formatString.apply(void 0,[t].concat(r));throw new Error(s)}});e!==DebugMode.ERROR&&(ccWarn=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return console.warn.apply(console,[e].concat(i))}),e===DebugMode.INFO&&(ccLog=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return console.log.apply(console,[e].concat(i))})}}function _throw(e){var t=e.stack;error(t||e)}function getTypedFormatter(s){return function(e){for(var t="".concat(s," ").concat(e,", please go to ").concat(ERROR_MAP_URL,"#").concat(e," to see details."),i=arguments.length,r=new Array(1<i?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];return 0===r.length?t:t+" Arguments: "+r.join(", ")}}var logFormatter=getTypedFormatter("Log");function logID(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];log(logFormatter.apply(void 0,[e].concat(i)))}var warnFormatter=getTypedFormatter("Warning");function warnID(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];warn(warnFormatter.apply(void 0,[e].concat(i)))}var errorFormatter=getTypedFormatter("Error");function errorID(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];error(errorFormatter.apply(void 0,[e].concat(i)))}var DebugMode,assertFormatter=getTypedFormatter("Assert");function assertID(e,t){if(!e){for(var i=arguments.length,r=new Array(2<i?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];assert(!1,assertFormatter.apply(void 0,[t].concat(r)))}}function getError(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return errorFormatter.apply(void 0,[e].concat(i))}function isDisplayStats(){return!!cc.profiler&&cc.profiler.isShowingStats()}function setDisplayStats(e){cc.profiler&&(e?cc.profiler.showStats():cc.profiler.hideStats(),cc.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE"}(DebugMode=DebugMode||{});var debug=Object.freeze({log:log,warn:warn,error:error,assert:assert,_resetDebugSetting:_resetDebugSetting,_throw:_throw,logID:logID,warnID:warnID,errorID:errorID,assertID:assertID,get DebugMode(){return DebugMode},getError:getError,isDisplayStats:isDisplayStats,setDisplayStats:setDisplayStats}),EXTNAME_RE=/(\.[^\.\/\?\\]*)(\?.*)?$/,DIRNAME_RE=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,NORMALIZE_RE=/[^\.\/]+\/\.\.\//;function join(){for(var e="",t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];for(var n=0,s=i;n<s.length;n++){e=(e+(""===e?"":"/")+s[n]).replace(/(\/|\\\\)$/,"")}return e}function extname(e){var t=EXTNAME_RE.exec(e);return t?t[1]:""}function mainFileName(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function basename(e,t){var i=e.indexOf("?");0<i&&(e=e.substring(0,i));var r=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!r)return"";var n=r[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?n.substring(0,n.length-t.length):n}function dirname(e){var t=DIRNAME_RE.exec(e);return t?t[2]:""}function changeExtname(e,t){t=t||"";var i=e.indexOf("?"),r="";return 0<i&&(r=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+r:e.substring(0,i)+t+r}function changeBasename(e,t,i){if(0===t.indexOf("."))return changeExtname(e,t);var r=e.indexOf("?"),n="",s=i?extname(e):"";return 0<r&&(n=e.substring(r),e=e.substring(0,r)),r=(r=e.lastIndexOf("/"))<=0?0:r+1,e.substring(0,r)+t+s+n}function _normalize(e){for(var t=e=String(e);e=(t=e).replace(NORMALIZE_RE,""),t.length!==e.length;);return e}function stripSep(e){return e.replace(/[\/\\]$/,"")}function getSeperator(){return cc.sys.os===cc.sys.OS_WINDOWS?"\\":"/"}var path=Object.freeze({join:join,extname:extname,mainFileName:mainFileName,basename:basename,dirname:dirname,changeExtname:changeExtname,changeBasename:changeBasename,_normalize:_normalize,stripSep:stripSep,getSeperator:getSeperator});cc.log=log,cc.warn=warn,cc.error=error,cc.assert=assert,cc._throw=_throw,cc.logID=logID,cc.warnID=warnID,cc.errorID=errorID,cc.assertID=assertID,cc.debug=debug,cc.path={join:join,extname:extname,mainFileName:mainFileName,basename:basename,dirname:dirname,changeExtname:changeExtname,changeBasename:changeBasename,_normalize:_normalize,stripSep:stripSep,get sep(){return getSeperator()}};var INT_BITS=32,INT_MAX=2147483647,INT_MIN=-1<<INT_BITS-1;function sign(e){return(0<e)-(e<0)}function abs(e){var t=e>>INT_BITS-1;return(e^t)-t}function min(e,t){return t^(e^t)&-(e<t)}function max(e,t){return e^(e^t)&-(e<t)}function isPow2(e){return!(e&e-1||!e)}function log2(e){var t,i;return t=(65535<e)<<4,t|=i=(255<(e>>>=t))<<3,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1}function log10(e){return 1e9<=e?9:1e8<=e?8:1e7<=e?7:1e6<=e?6:1e5<=e?5:1e4<=e?4:1e3<=e?3:100<=e?2:10<=e?1:0}function popCount(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24}function countTrailingZeros(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function nextPow2(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)+1}function prevPow2(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)}function parity(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1}var REVERSE_TABLE=new Array(256);function reverse(e){return REVERSE_TABLE[255&e]<<24|REVERSE_TABLE[e>>>8&255]<<16|REVERSE_TABLE[e>>>16&255]<<8|REVERSE_TABLE[e>>>24&255]}function interleave2(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function deinterleave2(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16}function interleave3(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2}function deinterleave3(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22}function nextCombination(e){var t=e|e-1;return 1+t|(~t&-~t)-1>>>countTrailingZeros(e)+1}!function(e){for(var t=0;t<256;++t){var i=t,r=t,n=7;for(i>>>=1;i;i>>>=1)r<<=1,r|=1&i,--n;e[t]=r<<n&255}}(REVERSE_TABLE);var bits=Object.freeze({INT_BITS:INT_BITS,INT_MAX:INT_MAX,INT_MIN:INT_MIN,sign:sign,abs:abs,min:min,max:max,isPow2:isPow2,log2:log2,log10:log10,popCount:popCount,countTrailingZeros:countTrailingZeros,nextPow2:nextPow2,prevPow2:prevPow2,parity:parity,reverse:reverse,interleave2:interleave2,deinterleave2:deinterleave2,interleave3:interleave3,deinterleave3:deinterleave3,nextCombination:nextCombination}),MutableForwardIterator=function(){function t(e){_classCallCheck(this,t),this.array=e,this.i=0}return _createClass(t,[{key:"remove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}},{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),t}();function removeAt(e,t){e.splice(t,1)}function fastRemoveAt(e,t){var i=e.length;t<0||i<=t||(e[t]=e[i-1],e.length=i-1)}function remove(e,t){var i=e.indexOf(t);return 0<=i&&(removeAt(e,i),!0)}function fastRemove(e,t){var i=e.indexOf(t);0<=i&&(e[i]=e[e.length-1],--e.length)}function removeIf(e,t){var i=e.findIndex(t);if(0<=i){var r=e[i];return removeAt(e,i),r}}function verifyType(e,t){if(e&&0<e.length){var i=e,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}if(!(s instanceof t))return cc.logID(1300),!1}}return!0}function removeArray(e,t){for(var i=0,r=t.length;i<r;i++)remove(e,t[i])}function appendObjectsAt(e,t,i){return e.splice.apply(e,[i,0].concat(_toConsumableArray(t))),e}function indexOf(e,t,i){return Array.prototype.indexOf.call(e,[t,i])}function contains(e,t){return 0<=e.indexOf(t)}function copy(e){for(var t=e.length,i=new Array(t),r=0;r<t;r+=1)i[r]=e[r];return i}var jsarray=Object.freeze({removeAt:removeAt,fastRemoveAt:fastRemoveAt,remove:remove,fastRemove:fastRemove,removeIf:removeIf,verifyType:verifyType,removeArray:removeArray,appendObjectsAt:appendObjectsAt,indexOf:indexOf,contains:contains,copy:copy,MutableForwardIterator:MutableForwardIterator}),NonUuidMark=".",IDGenerator=function(){function t(e){_classCallCheck(this,t),this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+NonUuidMark:""}return _createClass(t,[{key:"getNewId",value:function(){return this.prefix+ ++this.id}}]),t}();IDGenerator.global=new IDGenerator("global");var tempCIDGenerator=new IDGenerator("TmpCId.");function isNumber(e){return"number"==typeof e||e instanceof Number}function isString(e){return"string"==typeof e||e instanceof String}var value=function(){var s={value:void 0,enumerable:!1,writable:!1,configurable:!0};return function(e,t,i,r,n){s.value=i,s.writable=r,s.enumerable=n,Object.defineProperty(e,t,s),s.value=void 0}}(),getset=function(){var a={get:void 0,set:void 0,enumerable:!1};return function(e,t,i,r){var n=4<arguments.length&&void 0!==arguments[4]&&arguments[4],s=5<arguments.length&&void 0!==arguments[5]&&arguments[5];"boolean"==typeof r&&(n=r,r=void 0),a.get=i,a.set=r,a.enumerable=n,a.configurable=s,Object.defineProperty(e,t,a),a.get=void 0,a.set=void 0}}(),get=function(){var s={get:void 0,enumerable:!1,configurable:!1};return function(e,t,i,r,n){s.get=i,s.enumerable=r,s.configurable=n,Object.defineProperty(e,t,s),s.get=void 0}}(),set$1=function(){var s={set:void 0,enumerable:!1,configurable:!1};return function(e,t,i,r,n){s.set=i,s.enumerable=r,s.configurable=n,Object.defineProperty(e,t,s),s.set=void 0}}();function createMap(e){var t=Object.create(null);if(e){t["."]=!0,t["/"]=!0,delete t["."],delete t["/"]}return t}function getClassName(e){if("function"!=typeof e)return e&&e.constructor?getClassName(e.constructor):"";var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var i="";if(e.name&&(i=e.name),e.toString){var r,n=e.toString();(r="["===n.charAt(0)?n.match(/\[\w+\s*(\w+)\]/):n.match(/function\s*(\w+)/))&&2===r.length&&(i=r[1])}return"Object"!==i?i:""}function obsolete(e,t,i,r){var n=/([^.]+)$/,s=n.exec(t)[0],a=n.exec(i)[0];function o(){return this[a]}r?getset(e,s,o,function(e){this[a]=e}):get(e,s,o)}function obsoletes(e,t,i,r){for(var n in i){obsolete(e,t+"."+n,i[n],r)}}var REGEXP_NUM_OR_STR=/(%d)|(%s)/,REGEXP_STR=/%s/;function formatStr(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(0===arguments.length)return"";if(0===i.length)return""+e;if("string"==typeof e&&REGEXP_NUM_OR_STR.test(e)){var n=i,s=Array.isArray(n),a=0;for(n=s?n:n[Symbol.iterator]();;){var o;if(s){if(a>=n.length)break;o=n[a++]}else{if((a=n.next()).done)break;o=a.value}var c=o,l="number"==typeof c?REGEXP_NUM_OR_STR:REGEXP_STR;l.test(e)?e=e.replace(l,c):e+=" "+c}}else{var u=i,h=Array.isArray(u),_=0;for(u=h?u:u[Symbol.iterator]();;){var p;if(h){if(_>=u.length)break;p=u[_++]}else{if((_=u.next()).done)break;p=_.value}e+=" "+p}}return e}function shiftArguments(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function getPropertyDescriptor(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function _copyprop(e,t,i){var r=getPropertyDescriptor(t,e);r&&Object.defineProperty(i,e,r)}function addon(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];for(var n=0,s=i;n<s.length;n++){var a=s[n];if(a){if("object"!==_typeof(a)){cc.errorID(5402,a);continue}for(var o in a)o in e||_copyprop(o,a,e)}}return e}function mixin(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];for(var n=0,s=i;n<s.length;n++){var a=s[n];if(a){if("object"!==_typeof(a)){cc.errorID(5403,a);continue}for(var o in a)_copyprop(o,a,e)}}return e}function extend(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function getSuper(e){var t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function isChildClassOf(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=getSuper(e)))return!1;if(e===t)return!0}}return!1}function clear(e){for(var t=0,i=Object.keys(e);t<i.length;t++){delete e[i[t]]}}function isTempClassId(e){return"string"!=typeof e||e.startsWith(tempCIDGenerator.prefix)}var _idToClass={},_nameToClass={};function _setClassId(e,t){var i="__cid__",r=_idToClass;if(t.prototype.hasOwnProperty(i)&&delete r[t.prototype[i]],value(t.prototype,i,e),e){var n=r[e];if(n&&n!==t){var s="A Class already exists with the same "+i+' : "'+e+'".';0,cc.error(s)}else r[e]=t}}function doSetClassName(e,t){var i="__classname__",r=_nameToClass;if(t.prototype.hasOwnProperty(i)&&delete r[t.prototype[i]],value(t.prototype,i,e),e){var n=r[e];if(n&&n!==t){var s="A Class already exists with the same "+i+' : "'+e+'".';0,cc.error(s)}else r[e]=t}}function setClassName(e,t){if(doSetClassName(e,t),!t.prototype.hasOwnProperty("__cid__")){var i=e||tempCIDGenerator.getNewId();i&&_setClassId(i,t)}}function unregisterClass(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var r=0,n=t;r<n.length;r++){var s=n[r].prototype,a=s.__cid__;a&&delete _idToClass[a];var o=s.__classname__;o&&delete _nameToClass[o]}}function _getClassById(e){return _idToClass[e]}function getClassByName(e){return _nameToClass[e]}function _getClassId(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty("__cid__"))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty("__cid__"))return e.__cid__}return""}var Pool=function(){function n(e,t){_classCallCheck(this,n),this.count=void 0,this._pool=void 0;var i=(this._cleanup=void 0)===t?e:t,r=void 0===t?null:e;this.count=0,this._pool=new Array(i),this._cleanup=r}return _createClass(n,[{key:"get",value:function(){return this._get()}}]),_createClass(n,[{key:"_get",value:function(){if(0<this.count){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){0<=e&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),n}(),array=jsarray,js={IDGenerator:IDGenerator,Pool:Pool,array:jsarray,isNumber:isNumber,isString:isString,getPropertyDescriptor:getPropertyDescriptor,addon:addon,mixin:mixin,extend:extend,getSuper:getSuper,isChildClassOf:isChildClassOf,clear:clear,value:value,getset:getset,get:get,set:set$1,unregisterClass:unregisterClass,getClassName:getClassName,setClassName:setClassName,getClassByName:getClassByName,_getClassId:_getClassId,_setClassId:_setClassId,_getClassById:_getClassById,obsolete:obsolete,obsoletes:obsoletes,formatStr:formatStr,shiftArguments:shiftArguments,createMap:createMap};cc.js=js;for(var js$1=Object.freeze({array:array,js:js,IDGenerator:IDGenerator,Pool:Pool,isNumber:isNumber,isString:isString,value:value,getset:getset,get:get,set:set$1,createMap:createMap,getClassName:getClassName,obsolete:obsolete,obsoletes:obsoletes,formatStr:formatStr,shiftArguments:shiftArguments,getPropertyDescriptor:getPropertyDescriptor,addon:addon,mixin:mixin,extend:extend,getSuper:getSuper,isChildClassOf:isChildClassOf,clear:clear,_idToClass:_idToClass,_nameToClass:_nameToClass,_setClassId:_setClassId,setClassName:setClassName,unregisterClass:unregisterClass,_getClassById:_getClassById,getClassByName:getClassByName,_getClassId:_getClassId}),BUILTIN_CLASSID_RE=/^(?:cc|dragonBones|sp|ccsg)\..+/,BASE64_KEYS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",values=new Array(123),i=0;i<123;++i)values[i]=64;for(var _i=0;_i<64;++_i)values[BASE64_KEYS.charCodeAt(_i)]=_i;var BASE64_VALUES=values;function propertyDefine(e,t,i){function r(e,t,i,r){var n=Object.getOwnPropertyDescriptor(e,t);if(n)n.get&&(e[i]=n.get),n.set&&r&&(e[r]=n.set);else{var s=e[i];getset(e,t,s,e[r])}}for(var n,s=e.prototype,a=0;a<t.length;a++){var o=(n=t[a])[0].toUpperCase()+n.slice(1);r(s,n,"get"+o,"set"+o)}for(n in i){var c=i[n];r(s,n,c[0],c[1])}}function nextPOT(e){return e-=1,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)+1}function pushToMap(e,t,i,r){var n=e[t];n?Array.isArray(n)?r?(n.push(n[0]),n[0]=i):n.push(i):e[t]=r?[i,n]:[n,i]:e[t]=i}function contains$1(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}function isDomNode(e){return"object"===("undefined"==typeof window?"undefined":_typeof(window))&&"function"==typeof Node?e instanceof Node:e&&"object"===_typeof(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function callInNextTick(e,t,i){e&&setTimeout(function(){e(t,i)},0)}function tryCatchFunctor_EDITOR(e,t,i,r){return Function("arg","return "+function(e){try{target._FUNC_(_U_ARGS_)}catch(e){cc._throw(e)}_AFTER_CALL_}.toString().replace(/_FUNC_/g,e).replace("_R_ARGS_","target"+(t?", "+t:"")).replace("_U_ARGS_",t||"").replace("_AFTER_CALL_",i||""))(r)}function isPlainEmptyObj_DEV(e){if(!e||e.constructor!==Object)return!1;for(var t in e)return!1;return!0}function cloneable_DEV(e){return e&&"function"==typeof e.clone&&(e.constructor&&e.constructor.prototype.hasOwnProperty("clone")||e.hasOwnProperty("clone"))}cc.misc={BUILTIN_CLASSID_RE:BUILTIN_CLASSID_RE,BASE64_VALUES:BASE64_VALUES,propertyDefine:propertyDefine,nextPOT:nextPOT,pushToMap:pushToMap,contains:contains$1,isDomNode:isDomNode,callInNextTick:callInNextTick,tryCatchFunctor_EDITOR:tryCatchFunctor_EDITOR,isPlainEmptyObj_DEV:isPlainEmptyObj_DEV,cloneable_DEV:cloneable_DEV};var _TestEnum,misc=Object.freeze({BUILTIN_CLASSID_RE:BUILTIN_CLASSID_RE,BASE64_VALUES:BASE64_VALUES,propertyDefine:propertyDefine,nextPOT:nextPOT,pushToMap:pushToMap,contains:contains$1,isDomNode:isDomNode,callInNextTick:callInNextTick,tryCatchFunctor_EDITOR:tryCatchFunctor_EDITOR,isPlainEmptyObj_DEV:isPlainEmptyObj_DEV,cloneable_DEV:cloneable_DEV});function BitMask(e){if("__bitmask__"in e)return e;value(e,"__bitmask__",null,!0);for(var t=-1,i=Object.keys(e),r=0;r<i.length;r++){var n=i[r],s=e[n];if(-1===s)s=++t,e[n]=s;else if("number"==typeof s)t=s;else if("string"==typeof s&&Number.isInteger(parseFloat(n)))continue;var a=""+s;n!==a&&value(e,a,n)}return e}function Enum(e){if("__enums__"in e)return e;value(e,"__enums__",null,!0);for(var t=-1,i=Object.keys(e),r=0;r<i.length;r++){var n=i[r],s=e[n];if(-1===s)s=++t,e[n]=s;else if("number"==typeof s)t=s;else if("string"==typeof s&&Number.isInteger(parseFloat(n)))continue;var a=""+s;n!==a&&value(e,a,n)}return e}function ccenum(e){"__enums__"in e||value(e,"__enums__",null,!0)}BitMask.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},BitMask.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var i in e){var r=e[i];Number.isInteger(r)&&t.push({name:i,value:r})}return t.sort(function(e,t){return e.value-t.value}),t},cc.BitMask=BitMask,Enum.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},Enum.getList=function(e){if(e.__enums__)return e.__enums__;var t=e.__enums__=[];for(var i in e){var r=e[i];Number.isInteger(r)&&t.push({name:i,value:r})}return t.sort(function(e,t){return e.value-t.value}),t},cc.Enum=Enum;var ValueType=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"clone",value:function(){return errorID(100,getClassName(this)+".clone"),this}},{key:"equals",value:function(e){return!1}},{key:"set",value:function(e){errorID(100,getClassName(this)+".set")}},{key:"toString",value:function(){return""+{}}}]),e}();setClassName("cc.ValueType",ValueType),cc.ValueType=ValueType;var DELIMETER="$_$";function createAttrsSingle(e,t,i){var r;r=function(){},i&&extend(r,i.constructor);var n=new r;return value(e,"__attrs__",n),n}function createAttrs(e){for(var t,i=cc.Class.getInheritanceChain(e),r=i.length-1;0<=r;r--){var n=i[r];n.hasOwnProperty("__attrs__")&&n.__attrs__||createAttrsSingle(n,n,(t=i[r+1])&&t.__attrs__)}return createAttrsSingle(e,e,(t=i[0])&&t.__attrs__),e.__attrs__}function attr(e,t,i){var r,n;if("function"==typeof e)n=(r=getClassAttrs(e)).constructor.prototype;else{var s=e;if(!(r=s.__attrs__))r=createAttrsSingle(s,e=s.constructor,getClassAttrs(e));n=r}if(void 0===i){var a=t+DELIMETER,o={};for(var c in r)c.startsWith(a)&&(o[c.slice(a.length)]=r[c]);return o}if("object"===_typeof(i))for(var l in i)95!==l.charCodeAt(0)&&(n[t+DELIMETER+l]=i[l]);else 0}function getClassAttrs(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||createAttrs(e)}function getClassAttrsProto(e){return getClassAttrs(e).constructor.prototype}function setClassAttr(e,t,i,r){getClassAttrsProto(e)[t+DELIMETER+i]=r}var PrimitiveType=function(){function i(e,t){_classCallCheck(this,i),this.name=void 0,this.default=void 0,this.name=e,this.default=t}return _createClass(i,[{key:"toString",value:function(){return this.name}}]),i}(),CCInteger=new PrimitiveType("Integer",0);cc.Integer=CCInteger,cc.CCInteger=CCInteger;var CCFloat=new PrimitiveType("Float",0);cc.Float=CCFloat,cc.CCFloat=CCFloat;var CCBoolean=new PrimitiveType("Boolean",!1);cc.Boolean=CCBoolean,cc.CCBoolean=CCBoolean;var CCString=new PrimitiveType("String","");function getTypeChecker(c,l){return function(e,t){var i='"'+getClassName(e)+"."+t+'"',r=attr(e,t);if(!r.saveUrlAsAsset){var n=r.type;if(n===CCInteger||n===CCFloat?n="Number":n!==CCString&&n!==CCBoolean||(n=n.toString()),n!==c)return void warnID(3604,i)}if(r.hasOwnProperty("default")){var s=r.default;if(void 0!==s)if(!(Array.isArray(s)||isPlainEmptyObj_DEV(s))){var a=_typeof(s),o=c.toLowerCase();if(a===o){if(!r.saveUrlAsAsset)if("object"===o){if(!s||s instanceof r.ctor)return;warnID(3605,i,getClassName(r.ctor))}else"Number"!==c&&warnID(3606,l,i,c)}else{if("function"===a)return;c===CCString.default&&null==s?isChildClassOf(r.ctor,cc.RawAsset)||warnID(3607,i):warnID(3611,l,i,a)}delete r.type}}}}function getObjTypeChecker(a){return function(e,t){getTypeChecker("Object","type")(e,t);var i=getClassAttrs(e)[t+DELIMETER+"default"],r=cc.Class.getDefault(i);if(!Array.isArray(r)&&isChildClassOf(a,cc.ValueType)){var n=getClassName(a),s=formatStr('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',getClassName(e),t,n);i?log(s):warnID(3612,s,n,getClassName(e),t,n)}}}cc.String=CCString,cc.CCString=CCString;var attributeUtils=Object.freeze({DELIMETER:DELIMETER,createAttrsSingle:createAttrsSingle,createAttrs:createAttrs,attr:attr,getClassAttrs:getClassAttrs,getClassAttrsProto:getClassAttrsProto,setClassAttr:setClassAttr,PrimitiveType:PrimitiveType,CCInteger:CCInteger,CCFloat:CCFloat,CCBoolean:CCBoolean,CCString:CCString,getTypeChecker:getTypeChecker,getObjTypeChecker:getObjTypeChecker}),SerializableAttrs={url:{canUsedInGet:!0},default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}},TYPO_TO_CORRECT_DEV=!1;function parseNotify(e,t,i,r){if(!e.get&&!e.set)if(e.hasOwnProperty("default")){var n="_N$"+t;e.get=function(){return this[n]},e.set=function(e){var t=this[n];this[n]=e,i.call(this,t)};var s={};for(var a in r[n]=s,SerializableAttrs){var o=SerializableAttrs[a];e.hasOwnProperty(a)&&(s[a]=e[a],o.canUsedInGet||delete e[a])}}else 0}function checkUrl(e,t,i,r){Array.isArray(r)&&0<r.length&&(r=r[0]),e.type=r}function parseType(e,t,i,r){if(Array.isArray(t)){if(!(0<t.length))return errorID(5508,i,r);if(cc.RawAsset.isRawAssetType(t[0]))return e.url=t[0],void delete e.type;e.type=t=t[0]}}function postCheckType(e,t,i,r){0}function getBaseClassWherePropertyDefined_DEV(e,t){}function getFullFormOfProperty(e,t,i){if(e&&e.constructor===Object)return null;if(Array.isArray(e)&&0<e.length){e[0];return{default:[],type:e,_short:!0}}if("function"!=typeof e)return e instanceof PrimitiveType?{default:e.default,_short:!0}:{default:e,_short:!0};var r=e;return cc.RawAsset.isRawAssetType(r)?{default:"",url:r,_short:!0}:{default:isChildClassOf(r,cc.ValueType)?new r:null,type:r,_short:!0}}function preprocessAttrs(e,t,i,r){for(var n in e){var s=e[n],a=getFullFormOfProperty(s);if(a&&(s=e[n]=a),s){var o=s.notify;o&&parseNotify(s,n,o,e),"type"in s&&parseType(s,s.type,t,n),"url"in s&&checkUrl(s,t,n,s.url),"type"in s&&postCheckType(s,s.type,t,n)}}}var CALL_SUPER_DESTROY_REG_DEV=/\b\._super\b|destroy.*\.call\s*\(\s*\w+\s*[,|)]/;function doValidateMethodWithProps_DEV(e,t,i,r,n){if(r.__props__&&0<=r.__props__.indexOf(t))return errorID(3648,i,t,getClassName(getBaseClassWherePropertyDefined_DEV(t,r))),!1;"destroy"===t&&isChildClassOf(n,cc.Component)&&!CALL_SUPER_DESTROY_REG_DEV.test(e)&&error("Overwriting '".concat(t,"' function in '").concat(i,"' class without calling super is not allowed. Call the super function in '").concat(t,"' please."))}function validateMethodWithProps(e,t,i,r,n){return"function"==typeof e||null===e}var requiringFrames=[];function push(e,t,i){void 0===i&&(i=t,t=""),requiringFrames.push({uuid:t,script:i,module:e,exports:e.exports,beh:null})}function pop(){var e=requiringFrames.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var r in i)return;t.exports=i=e.cls}}function peek(){return requiringFrames[requiringFrames.length-1]}cc._RF={push:push,pop:pop,peek:peek};var DELIMETER$1=DELIMETER,BUILTIN_ENTRIES=["name","extends","mixins","ctor","__ctor__","properties","statics","editor","__ES6__"],INVALID_STATICS_DEV=["name","__ctors__","__props__","arguments","call","apply","caller","length","prototype"];function pushUnique(e,t){e.indexOf(t)<0&&e.push(t)}var deferredInitializer={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout(function(){t.init()},0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var i=e[t],r=i.cls,n=i.props;"function"==typeof n&&(n=n());var s=getClassName(r);n?declareProperties(r,s,n,r.$super,i.mixins):errorID(3633,s)}this.datas=null}}};function appendProp(e,t){pushUnique(e.__props__,t)}var tmpArray=[];function defineProp(e,t,i,r,n){var s=r.default;setClassAttr(e,i,"default",s),appendProp(e,i);var a=parseAttributes(e,r,t,i,!1);if(a){for(var o=tmpArray,c=0;c<a.length;c++){var l=a[c];attr(e,i,l),!1===l.serializable&&pushUnique(e.__values__,i),l._onAfterProp&&o.push(l._onAfterProp)}for(var u=0;u<o.length;u++)o[u](e,i);tmpArray.length=0,a.length=0}}function defineGetSet(e,t,i,r,n){var s=r.get,a=r.set,o=e.prototype,c=Object.getOwnPropertyDescriptor(o,i),l=!c;if(s){0;for(var u=parseAttributes(e,r,t,i,!0),h=0;h<u.length;h++)attr(e,i,u[h]);u.length=0,setClassAttr(e,i,"serializable",!1),n||get(o,i,s,l,l)}a&&(n||set$1(o,i,a,l,l))}function getDefault(e){return"function"==typeof e?e():e}function mixinWithInherited(e,t,i){for(var r in t)e.hasOwnProperty(r)||i&&!i(r)||Object.defineProperty(e,r,getPropertyDescriptor(t,r))}function doDefine(e,t,i,r){var n,s,a=r.__ctor__,o=r.ctor,c=r.__ES6__;c?(n=[o],s=o):(n=a?[a]:_getAllCtors(t,i,r),s=_createCtor(n,t,e,r),value(s,"extend",function(e){return e.extends=this,CCClass(e)},!0)),value(s,"__ctors__",0<n.length?n:null,!0);var l=s.prototype;if(t&&(c||(extend(s,t),l=s.prototype),s.$super=t),i){for(var u=function(e){var t=i[e];mixinWithInherited(l,t.prototype),mixinWithInherited(s,t,function(e){return t.hasOwnProperty(e)&&!0}),CCClass._isCCClass(t)&&mixinWithInherited(getClassAttrs(s).constructor.prototype,getClassAttrs(t).constructor.prototype)},h=i.length-1;0<=h;h--)u(h);l.constructor=s}return c||(l.__initProps__=compileProps),setClassName(e,s),s}function define(e,t,i,r){var n=cc.Component,s=peek();if(s&&isChildClassOf(t,n)){if(isChildClassOf(s.cls,n))return errorID(3615),null;0,e=e||s.script}var a=doDefine(e,t,i,r);if(s)if(isChildClassOf(t,n)){var o=s.uuid;o&&_setClassId(o,a),s.cls=a}else isChildClassOf(s.cls,n)||(s.cls=a);return a}function normalizeClassName_DEV(e){if(e){e=e.replace(/^[^$A-Za-z_]/,"_").replace(/[^0-9A-Za-z_$]/g,"_");try{return Function("function "+e+"(){}")(),e}catch(e){}}return"CCClass"}function getNewValueTypeCodeJit(e){for(var t=getClassName(e),i=e.constructor,r="new "+t+"(",n=0;n<i.__props__.length;n++){var s=e[i.__props__[n]];0,r+=s,n<i.__props__.length-1&&(r+=",")}return r+")"}function escapeForJS(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}function getInitPropsJit(e,t){for(var i=[],r="",n=0;n<t.length;n++){var s=t[n],a=s+DELIMETER$1+"default";if(a in e){var o=void 0;o=IDENTIFIER_RE.test(s)?"this."+s+"=":"this["+escapeForJS(s)+"]=";var c=void 0,l=e[a];if("object"===_typeof(l)&&l)c=l instanceof cc.ValueType?getNewValueTypeCodeJit(l):Array.isArray(l)?"[]":"{}";else if("function"==typeof l){var u=i.length;i.push(l),c="F["+u+"]()"}else c="string"==typeof l?escapeForJS(l):l;r+=o=o+c+";\n"}}return 0===i.length?Function(r):Function("F","return (function(){\n"+r+"})")(i)}function getInitProps(e,t){for(var s=[],a=[],o=[],c=[],i=0;i<t.length;++i){var r=t[i],n=r+DELIMETER$1+"default";if(n in e){var l=e[n];"object"===_typeof(l)&&l||"function"==typeof l?(s.push(r),a.push(l)):(o.push(r),c.push(l))}}return function(){for(var e=0;e<o.length;++e)this[o[e]]=c[e];for(var t=0;t<s.length;t++){var i=s[t],r=void 0,n=a[t];r="object"===_typeof(n)?n instanceof cc.ValueType?n.clone():Array.isArray(n)?[]:{}:n(),this[i]=r}}}var IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/;function compileProps(e){var t=getClassAttrs(e),i=e.__props__;null===i&&(deferredInitializer.init(),i=e.__props__);var r=getInitProps(t,i);(e.prototype.__initProps__=r).call(this)}var _createCtor=function(t,e,i,r){var n,s=e&&boundSuperCalls(e,r,i),a=t.length;return n=0<a?s?2===a?function(){this._super=null,this.__initProps__(n),t[0].apply(this,arguments),t[1].apply(this,arguments)}:function(){this._super=null,this.__initProps__(n);for(var e=0;e<t.length;++e)t[e].apply(this,arguments)}:3===a?function(){this.__initProps__(n),t[0].apply(this,arguments),t[1].apply(this,arguments),t[2].apply(this,arguments)}:function(){this.__initProps__(n);for(var e=n.__ctors__,t=0;t<e.length;++t)e[t].apply(this,arguments)}:function(){s&&(this._super=null),this.__initProps__(n)}};function _validateCtor_DEV(e,t,i,r){return!(0<e.length)||i&&i.startsWith("cc.")||warnID(3617,i),e}function _getAllCtors(e,t,i){for(var r,n=[],s=[e].concat(t),a=0;a<s.length;a++){var o=s[a];if(o)for(var c=(r=o,CCClass._isCCClass(r)?r.__ctors__||[]:[r]),l=0;l<c.length;l++)pushUnique(n,c[l])}var u=i.ctor;return u&&n.push(u),n}var superCllRegCondition=/xyz/.test(function(){}.toString()),SuperCallReg=superCllRegCondition?/\b\._super\b/:/.*/,SuperCallRegStrict=superCllRegCondition?/this\._super\s*\(/:/(NONE){99}/;function boundSuperCalls(e,t,i){var r=!1;for(var n in t)if(!(0<=BUILTIN_ENTRIES.indexOf(n))){var s=t[n];if("function"==typeof s){var a=getPropertyDescriptor(e.prototype,n);if(a){var o=a.value;if("function"==typeof o){SuperCallReg.test(s)&&(r=!0,t[n]=function(i,r){return function(){var e=this._super;this._super=i;var t=r.apply(this,arguments);return this._super=e,t}}(o,s));continue}}0}}return r}function declareProperties(t,e,i,r,n,s){if(t.__props__=[],r&&r.__props__&&(t.__props__=r.__props__.slice()),n)for(var a=0;a<n.length;++a){var o=n[a];o.__props__&&(t.__props__=t.__props__.concat(o.__props__.filter(function(e){return t.__props__.indexOf(e)<0})))}if(i)for(var c in preprocessAttrs(i,e,t,s),i){var l=i[c];"default"in l?defineProp(t,e,c,l,s):defineGetSet(t,e,c,l,s)}var u=getClassAttrs(t);t.__values__=t.__props__.filter(function(e){return!1!==u[e+DELIMETER$1+"serializable"]})}function CCClass(e){var t=(e=e||{}).name,i=e.extends,r=e.mixins,n=define(t,i,r,e);t=t||cc.js.getClassName(n),n._sealed=!0,i&&(i._sealed=!1);var s=e.properties;"function"==typeof s||i&&null===i.__props__||r&&r.some(function(e){return null===e.__props__})?(deferredInitializer.push({cls:n,props:s,mixins:r}),n.__props__=n.__values__=null):declareProperties(n,t,s,i,e.mixins,e.__ES6__);var a,o=e.statics;if(o)for(a in o)n[a]=o[a];for(var c in e)if(!(0<=BUILTIN_ENTRIES.indexOf(c))){var l=e[c];validateMethodWithProps(l,c,t,n,i)&&value(n.prototype,c,l,!0,!0)}var u=e.editor;return u&&isChildClassOf(i,cc.Component)&&cc.Component._registerEditorProps(n,u),n}function getInheritanceChain(e){for(var t=[];e=getSuper(e);)e!==Object&&t.push(e);return t}CCClass._isCCClass=function(e){return e&&e.hasOwnProperty&&e.hasOwnProperty("__ctors__")},CCClass.fastDefine=function(e,t,i){setClassName(e,t);for(var r=t.__props__=t.__values__=Object.keys(i),n=getClassAttrsProto(t),s=0;s<r.length;s++){var a=r[s];n[a+DELIMETER$1+"visible"]=!1,n[a+DELIMETER$1+"default"]=i[a]}},CCClass.Attr=attributeUtils,CCClass.attr=attr,CCClass.getInheritanceChain=getInheritanceChain;var PrimitiveTypes={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"},tmpAttrs=[];function parseAttributes(e,r,t,i,n){var s=null,a="";function o(){return a=i+DELIMETER$1,s=getClassAttrsProto(e)}tmpAttrs.length=0;var c=tmpAttrs,l=r.type;if(l){var u=PrimitiveTypes[l];if(u)c.push({type:l,_onAfterProp:void 0});else if("Object"===l)0;else if("object"===_typeof(l))Enum.isEnum(l)?c.push({type:"Enum",enumList:Enum.getList(l)}):BitMask.isBitMask(l)&&c.push({type:"BitMask",bitmaskList:BitMask.getList(l)});else if("function"==typeof l){var h;0,c.push({type:"Object",ctor:l,_onAfterProp:h})}else 0}function _(e,t){if(e in r){var i=r[e];_typeof(i)===t&&((s||o())[a+e]=i)}}r.editorOnly&&((s||o())[a+"editorOnly"]=!0),r.url&&((s||o())[a+"saveUrlAsAsset"]=!0),!1===r.serializable&&((s||o())[a+"serializable"]=!1),_("formerlySerializedAs","string");var p=r.range;return p&&Array.isArray(p)&&2<=p.length&&((s||o())[a+"min"]=p[0],(s||o())[a+"max"]=p[1],2<p.length&&((s||o())[a+"step"]=p[2])),_("min","number"),_("max","number"),_("step","number"),c}CCClass.isArray=function(e){return e=getDefault(e),Array.isArray(e)},CCClass.getDefault=getDefault,CCClass.escapeForJS=escapeForJS,CCClass.IDENTIFIER_RE=IDENTIFIER_RE,CCClass.getNewValueTypeCode=!1,cc.Class=CCClass;var _d2r=Math.PI/180,_r2d=180/Math.PI,EPSILON=1e-6;function equals(e,t){return Math.abs(e-t)<=EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}function approx(e,t,i){return i=i||EPSILON,Math.abs(e-t)<=i}function clamp(e,t,i){if(i<t){var r=t;t=i,i=r}return e<t?t:i<e?i:e}function clamp01(e){return e<0?0:1<e?1:e}function lerp(e,t,i){return e+(t-e)*i}function toRadian(e){return e*_d2r}function toDegree(e){return e*_r2d}var random=Math.random;function randomRange(e,t){return Math.random()*(t-e)+e}function randomRangeInt(e,t){return Math.floor(randomRange(e,t))}function pseudoRandom(e){return(e=(9301*e+49297)%233280)/233280}function pseudoRandomRange(e,t,i){return pseudoRandom(e)*(i-t)+t}function pseudoRandomRangeInt(e,t,i){return Math.floor(pseudoRandomRange(e,t,i))}function nextPow2$1(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function repeat(e,t){return e-Math.floor(e/t)*t}function pingPong(e,t){return e=repeat(e,2*t),e=t-Math.abs(e-t)}function inverseLerp(e,t,i){return(i-e)/(t-e)}var _x=0,_y=0,Vec2=function(){function r(e,t){var i;return _classCallCheck(this,r),(i=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this))).x=void 0,i.y=void 0,e&&"object"===_typeof(e)?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=t||0),i}return _inherits(r,ValueType),_createClass(r,null,[{key:"clone",value:function(e){return new r(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,i){return e.x=t,e.y=i,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}},{key:"scaleAndAdd",value:function(e,t,i,r){return e.x=t.x+i.x*r,e.y=t.y+i.y*r,e}},{key:"distance",value:function(e,t){return _x=t.x-e.x,_y=t.y-e.y,Math.sqrt(_x*_x+_y*_y)}},{key:"squaredDistance",value:function(e,t){return _x=t.x-e.x,_y=t.y-e.y,_x*_x+_y*_y}},{key:"len",value:function(e){return _x=e.x,_y=e.y,Math.sqrt(_x*_x+_y*_y)}},{key:"lengthSqr",value:function(e){return _x=e.x,_y=e.y,_x*_x+_y*_y}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){return _x=t.x,_y=t.y,Math.abs(_x)<EPSILON?e.x=0:e.x=1/_x,Math.abs(_y)<EPSILON?e.y=0:e.y=1/_y,e}},{key:"normalize",value:function(e,t){_x=t.x,_y=t.y;var i=_x*_x+_y*_y;return 0<i&&(i=1/Math.sqrt(i),e.x=_x*i,e.y=_y*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}},{key:"lerp",value:function(e,t,i,r){return _x=t.x,_y=t.y,e.x=_x+r*(i.x-_x),e.y=_y+r*(i.y-_y),e}},{key:"random",value:function(e,t){t=t||1;var i=2*random()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}},{key:"transformMat3",value:function(e,t,i){return _x=t.x,_y=t.y,e.x=i.m00*_x+i.m03*_y+i.m06,e.y=i.m01*_x+i.m04*_y+i.m07,e}},{key:"transformMat4",value:function(e,t,i){return _x=t.x,_y=t.y,e.x=i.m00*_x+i.m04*_y+i.m12,e.y=i.m01*_x+i.m05*_y+i.m13,e}},{key:"str",value:function(e){return"Vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"toArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e[r+0]=t.x,e[r+1]=t.y,e}},{key:"fromArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e.x=t[r+0],e.y=t[r+1],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:EPSILON;return Math.abs(e.x-t.x)<=r*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=r*Math.max(1,Math.abs(e.y),Math.abs(t.y))}},{key:"angle",value:function(e,t){r.normalize(v2_1,e),r.normalize(v2_2,t);var i=r.dot(v2_1,v2_2);return 1<i?0:i<-1?Math.PI:Math.acos(i)}}]),_createClass(r,[{key:"clone",value:function(){return new r(this.x,this.y)}},{key:"set",value:function(e,t){return e&&"object"===_typeof(e)?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:EPSILON;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))}},{key:"equals2f",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:EPSILON;return Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"strictEquals2f",value:function(e,t){return this.x===e&&this.y===t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerp",value:function(e,t){return _x=this.x,_y=this.y,this.x=_x+t*(e.x-_x),this.y=_y+t*(e.y-_y),this}},{key:"clampf",value:function(e,t){return this.x=clamp(this.x,e.x,t.x),this.y=clamp(this.y,e.y,t.y),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this}},{key:"add2f",value:function(e,t){return this.x=this.x+e,this.y=this.y+t,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this}},{key:"subtract2f",value:function(e,t){return this.x=this.x-e,this.y=this.y-t,this}},{key:"multiplyScalar",value:function(e){return"object"===_typeof(e)&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this}},{key:"multiply",value:function(e){return"object"!==_typeof(e)&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this}},{key:"multiply2f",value:function(e,t){return this.x=this.x*e,this.y=this.y*t,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}},{key:"divide2f",value:function(e,t){return this.x=this.x/e,this.y=this.y/t,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){_x=this.x,_y=this.y;var e=_x*_x+_y*_y;return 0<e&&(e=1/Math.sqrt(e),this.x=this.x*e,this.y=this.y*e),this}},{key:"angle",value:function(e){var t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;var r=this.dot(e)/Math.sqrt(t*i);return r=clamp(r,-1,1),Math.acos(r)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotate",value:function(e){_x=this.x,_y=this.y;var t=Math.sin(e),i=Math.cos(e);return this.x=i*_x-t*_y,this.y=t*_x+i*_y,this}},{key:"project",value:function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}},{key:"transformMat4",value:function(e){return _x=this.x,_y=this.y,this.x=e.m00*_x+e.m04*_y+e.m12,this.y=e.m01*_x+e.m05*_y+e.m13,this}}]),r}();Vec2.ZERO=Object.freeze(new Vec2(0,0)),Vec2.ONE=Object.freeze(new Vec2(1,1)),Vec2.NEG_ONE=Object.freeze(new Vec2(-1,-1)),Vec2.UNIT_X=Object.freeze(new Vec2(1,0)),Vec2.UNIT_Y=Object.freeze(new Vec2(0,1));var v2_1=new Vec2,v2_2=new Vec2;function v2(e,t){return new Vec2(e,t)}CCClass.fastDefine("cc.Vec2",Vec2,{x:0,y:0}),cc.Vec2=Vec2,cc.v2=v2;var _x$1=0,_y$1=0,_z=0,Vec3=function(){function n(e,t,i){var r;return _classCallCheck(this,n),(r=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this))).x=void 0,r.y=void 0,r.z=void 0,e&&"object"===_typeof(e)?(r.x=e.x,r.y=e.y,r.z=e.z):(r.x=e||0,r.y=t||0,r.z=i||0),r}return _inherits(n,ValueType),_createClass(n,null,[{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new n(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,i,r){return e.x=t,e.y=i,e.z=r,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}},{key:"scaleAndAdd",value:function(e,t,i,r){return e.x=t.x+i.x*r,e.y=t.y+i.y*r,e.z=t.z+i.z*r,e}},{key:"distance",value:function(e,t){return _x$1=t.x-e.x,_y$1=t.y-e.y,_z=t.z-e.z,Math.sqrt(_x$1*_x$1+_y$1*_y$1+_z*_z)}},{key:"squaredDistance",value:function(e,t){return _x$1=t.x-e.x,_y$1=t.y-e.y,_z=t.z-e.z,_x$1*_x$1+_y$1*_y$1+_z*_z}},{key:"len",value:function(e){return _x$1=e.x,_y$1=e.y,_z=e.z,Math.sqrt(_x$1*_x$1+_y$1*_y$1+_z*_z)}},{key:"lengthSqr",value:function(e){return _x$1=e.x,_y$1=e.y,_z=e.z,_x$1*_x$1+_y$1*_y$1+_z*_z}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){return _x$1=t.x,_y$1=t.y,_z=t.z,Math.abs(_x$1)<EPSILON?e.x=0:e.x=1/_x$1,Math.abs(_y$1)<EPSILON?e.y=0:e.y=1/_y$1,Math.abs(_z)<EPSILON?e.z=0:e.z=1/_z,e}},{key:"normalize",value:function(e,t){_x$1=t.x,_y$1=t.y,_z=t.z;var i=_x$1*_x$1+_y$1*_y$1+_z*_z;return 0<i&&(i=1/Math.sqrt(i),e.x=_x$1*i,e.y=_y$1*i,e.z=_z*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,i){var r=t.x,n=t.y,s=t.z,a=i.x,o=i.y,c=i.z;return e.x=n*c-s*o,e.y=s*a-r*c,e.z=r*o-n*a,e}},{key:"lerp",value:function(e,t,i,r){return e.x=t.x+r*(i.x-t.x),e.y=t.y+r*(i.y-t.y),e.z=t.z+r*(i.z-t.z),e}},{key:"random",value:function(e,t){t=t||1;var i=2*random()*Math.PI,r=2*random()-1,n=Math.sqrt(1-r*r);return e.x=n*Math.cos(i)*t,e.y=n*Math.sin(i)*t,e.z=r*t,e}},{key:"transformMat4",value:function(e,t,i){_x$1=t.x,_y$1=t.y,_z=t.z;var r=i.m03*_x$1+i.m07*_y$1+i.m11*_z+i.m15;return r=r?1/r:1,e.x=(i.m00*_x$1+i.m04*_y$1+i.m08*_z+i.m12)*r,e.y=(i.m01*_x$1+i.m05*_y$1+i.m09*_z+i.m13)*r,e.z=(i.m02*_x$1+i.m06*_y$1+i.m10*_z+i.m14)*r,e}},{key:"transformMat4Normal",value:function(e,t,i){_x$1=t.x,_y$1=t.y,_z=t.z;var r=i.m03*_x$1+i.m07*_y$1+i.m11*_z;return r=r?1/r:1,e.x=(i.m00*_x$1+i.m04*_y$1+i.m08*_z)*r,e.y=(i.m01*_x$1+i.m05*_y$1+i.m09*_z)*r,e.z=(i.m02*_x$1+i.m06*_y$1+i.m10*_z)*r,e}},{key:"transformMat3",value:function(e,t,i){return _x$1=t.x,_y$1=t.y,_z=t.z,e.x=_x$1*i.m00+_y$1*i.m03+_z*i.m06,e.y=_x$1*i.m01+_y$1*i.m04+_z*i.m07,e.z=_x$1*i.m02+_y$1*i.m05+_z*i.m08,e}},{key:"transformAffine",value:function(e,t,i){return _x$1=t.x,_y$1=t.y,_z=t.z,e.x=i.m00*_x$1+i.m01*_y$1+i.m02*_z+i.m03,e.y=i.m04*_x$1+i.m05*_y$1+i.m06*_z+i.m07,e.x=i.m08*_x$1+i.m09*_y$1+i.m10*_z+i.m11,e}},{key:"transformQuat",value:function(e,t,i){var r=i.w*t.x+i.y*t.z-i.z*t.y,n=i.w*t.y+i.z*t.x-i.x*t.z,s=i.w*t.z+i.x*t.y-i.y*t.x,a=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=r*i.w+a*-i.x+n*-i.z-s*-i.y,e.y=n*i.w+a*-i.y+s*-i.x-r*-i.z,e.z=s*i.w+a*-i.z+r*-i.y-n*-i.x,e}},{key:"transformRTS",value:function(e,t,i,r,n){var s=t.x*n.x,a=t.y*n.y,o=t.z*n.z,c=i.w*s+i.y*o-i.z*a,l=i.w*a+i.z*s-i.x*o,u=i.w*o+i.x*a-i.y*s,h=-i.x*s-i.y*a-i.z*o;return e.x=c*i.w+h*-i.x+l*-i.z-u*-i.y+r.x,e.y=l*i.w+h*-i.y+u*-i.x-c*-i.z+r.y,e.z=u*i.w+h*-i.z+c*-i.y-l*-i.x+r.z,e}},{key:"transformInverseRTS",value:function(e,t,i,r,n){var s=t.x-r.x,a=t.y-r.y,o=t.z-r.z,c=i.w*s-i.y*o+i.z*a,l=i.w*a-i.z*s+i.x*o,u=i.w*o-i.x*a+i.y*s,h=i.x*s+i.y*a+i.z*o;return e.x=(c*i.w+h*i.x+l*i.z-u*i.y)/n.x,e.y=(l*i.w+h*i.y+u*i.x-c*i.z)/n.y,e.z=(u*i.w+h*i.z+c*i.y-l*i.x)/n.z,e}},{key:"rotateX",value:function(e,t,i,r){_x$1=t.x-i.x,_y$1=t.y-i.y,_z=t.z-i.z;var n=Math.cos(r),s=Math.sin(r),a=_x$1,o=_y$1*n-_z*s,c=_y$1*s+_z*n;return e.x=a+i.x,e.y=o+i.y,e.z=c+i.z,e}},{key:"rotateY",value:function(e,t,i,r){_x$1=t.x-i.x,_y$1=t.y-i.y,_z=t.z-i.z;var n=Math.cos(r),s=Math.sin(r),a=_z*s+_x$1*n,o=_y$1,c=_z*n-_x$1*s;return e.x=a+i.x,e.y=o+i.y,e.z=c+i.z,e}},{key:"rotateZ",value:function(e,t,i,r){_x$1=t.x-i.x,_y$1=t.y-i.y,_z=t.z-i.z;var n=Math.cos(r),s=Math.sin(r),a=_x$1*n-_y$1*s,o=_x$1*s+_y$1*n,c=_z;return e.x=a+i.x,e.y=o+i.y,e.z=c+i.z,e}},{key:"toArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e[r+0]=t.x,e[r+1]=t.y,e[r+2]=t.z,e}},{key:"fromArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e.x=t[r+0],e.y=t[r+1],e.z=t[r+2],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:EPSILON,n=e.x,s=e.y,a=e.z,o=t.x,c=t.y,l=t.z;return Math.abs(n-o)<=r*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(s-c)<=r*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(a-l)<=r*Math.max(1,Math.abs(a),Math.abs(l))}},{key:"angle",value:function(e,t){n.normalize(v3_1,e),n.normalize(v3_2,t);var i=n.dot(v3_1,v3_2);return 1<i?0:i<-1?Math.PI:Math.acos(i)}},{key:"projectOnPlane",value:function(e,t,i){return n.subtract(e,t,n.project(e,t,i))}},{key:"project",value:function(e,t,i){var r=n.lengthSqr(i);return r<1e-6?n.set(e,0,0,0):n.multiplyScalar(e,i,n.dot(t,i)/r)}}]),_createClass(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.z)}},{key:"set",value:function(e,t,i){return e&&"object"===_typeof(e)?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=i||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:EPSILON;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))}},{key:"equals3f",value:function(e,t,i,r){var n=3<arguments.length&&void 0!==r?r:EPSILON;return Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=n*Math.max(1,Math.abs(this.z),Math.abs(i))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"strictEquals3f",value:function(e,t,i){return this.x===e&&this.y===t&&this.z===i}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerp",value:function(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this}},{key:"add3f",value:function(e,t,i){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this}},{key:"subtract3f",value:function(e,t,i){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this}},{key:"multiplyScalar",value:function(e){return"object"===_typeof(e)&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this}},{key:"multiply",value:function(e){return"object"!==_typeof(e)&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this}},{key:"multiply3f",value:function(e,t,i){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this}},{key:"divide3f",value:function(e,t,i){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"clampf",value:function(e,t){return this.x=clamp(this.x,e.x,t.x),this.y=clamp(this.y,e.y,t.y),this.z=clamp(this.z,e.z,t.z),this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e){var t=this.x,i=this.y,r=this.z,n=e.x,s=e.y,a=e.z;return this.x=i*a-r*s,this.y=r*n-t*a,this.z=t*s-i*n,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalize",value:function(){_x$1=this.x,_y$1=this.y,_z=this.z;var e=_x$1*_x$1+_y$1*_y$1+_z*_z;return 0<e&&(e=1/Math.sqrt(e),this.x=_x$1*e,this.y=_y$1*e,this.z=_z*e),this}},{key:"transformMat4",value:function(e){_x$1=this.x,_y$1=this.y,_z=this.z;var t=e.m03*_x$1+e.m07*_y$1+e.m11*_z+e.m15;return t=t?1/t:1,this.x=(e.m00*_x$1+e.m04*_y$1+e.m08*_z+e.m12)*t,this.y=(e.m01*_x$1+e.m05*_y$1+e.m09*_z+e.m13)*t,this.z=(e.m02*_x$1+e.m06*_y$1+e.m10*_z+e.m14)*t,this}}]),n}();Vec3.UNIT_X=Object.freeze(new Vec3(1,0,0)),Vec3.UNIT_Y=Object.freeze(new Vec3(0,1,0)),Vec3.UNIT_Z=Object.freeze(new Vec3(0,0,1)),Vec3.ZERO=Object.freeze(new Vec3(0,0,0)),Vec3.ONE=Object.freeze(new Vec3(1,1,1)),Vec3.NEG_ONE=Object.freeze(new Vec3(-1,-1,-1));var v3_1=new Vec3,v3_2=new Vec3;function v3(e,t,i){return new Vec3(e,t,i)}CCClass.fastDefine("cc.Vec3",Vec3,{x:0,y:0,z:0}),cc.Vec3=Vec3,cc.v3=v3;var _x$2=0,_y$2=0,_z$1=0,_w=0,Vec4=function(){function s(e,t,i,r){var n;return _classCallCheck(this,s),(n=_possibleConstructorReturn(this,_getPrototypeOf(s).call(this))).x=void 0,n.y=void 0,n.z=void 0,n.w=void 0,e&&"object"===_typeof(e)?(n.x=e.x,n.y=e.y,n.z=e.z,n.w=e.w):(n.x=e||0,n.y=t||0,n.z=i||0,n.w=r||0),n}return _inherits(s,ValueType),_createClass(s,null,[{key:"clone",value:function(e){return new s(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,r,n){return e.x=t,e.y=i,e.z=r,e.w=n,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,r){return e.x=t.x+i.x*r,e.y=t.y+i.y*r,e.z=t.z+i.z*r,e.w=t.w+i.w*r,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,r=t.y-e.y,n=t.z-e.z,s=t.w-e.w;return Math.sqrt(i*i+r*r+n*n+s*s)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,r=t.y-e.y,n=t.z-e.z,s=t.w-e.w;return i*i+r*r+n*n+s*s}},{key:"len",value:function(e){return _x$2=e.x,_y$2=e.y,_z$1=e.z,_w=e.w,Math.sqrt(_x$2*_x$2+_y$2*_y$2+_z$1*_z$1+_w*_w)}},{key:"lengthSqr",value:function(e){return _x$2=e.x,_y$2=e.y,_z$1=e.z,_w=e.w,_x$2*_x$2+_y$2*_y$2+_z$1*_z$1+_w*_w}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){return _x$2=t.x,_y$2=t.y,_z$1=t.z,_w=t.w,Math.abs(_x$2)<EPSILON?e.x=0:e.x=1/_x$2,Math.abs(_y$2)<EPSILON?e.y=0:e.y=1/_y$2,Math.abs(_z$1)<EPSILON?e.z=0:e.z=1/_z$1,Math.abs(_w)<EPSILON?e.w=0:e.w=1/_w,e}},{key:"normalize",value:function(e,t){_x$2=t.x,_y$2=t.y,_z$1=t.z,_w=t.w;var i=_x$2*_x$2+_y$2*_y$2+_z$1*_z$1+_w*_w;return 0<i&&(i=1/Math.sqrt(i),e.x=_x$2*i,e.y=_y$2*i,e.z=_z$1*i,e.w=_w*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,r){return e.x=t.x+r*(i.x-t.x),e.y=t.y+r*(i.y-t.y),e.z=t.z+r*(i.z-t.z),e.w=t.w+r*(i.w-t.w),e}},{key:"random",value:function(e,t){t=t||1;var i=2*random()*Math.PI,r=2*random()-1,n=Math.sqrt(1-r*r);return e.x=n*Math.cos(i)*t,e.y=n*Math.sin(i)*t,e.z=r*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,i){return _x$2=t.x,_y$2=t.y,_z$1=t.z,_w=t.w,e.x=i.m00*_x$2+i.m04*_y$2+i.m08*_z$1+i.m12*_w,e.y=i.m01*_x$2+i.m05*_y$2+i.m09*_z$1+i.m13*_w,e.z=i.m02*_x$2+i.m06*_y$2+i.m10*_z$1+i.m14*_w,e.w=i.m03*_x$2+i.m07*_y$2+i.m11*_z$1+i.m15*_w,e}},{key:"transformAffine",value:function(e,t,i){return _x$2=t.x,_y$2=t.y,_z$1=t.z,_w=t.w,e.x=i.m00*_x$2+i.m01*_y$2+i.m02*_z$1+i.m03*_w,e.y=i.m04*_x$2+i.m05*_y$2+i.m06*_z$1+i.m07*_w,e.x=i.m08*_x$2+i.m09*_y$2+i.m10*_z$1+i.m11*_w,e.w=t.w,e}},{key:"transformQuat",value:function(e,t,i){var r=t.x,n=t.y,s=t.z;_x$2=i.x,_y$2=i.y,_z$1=i.z;var a=(_w=i.w)*r+_y$2*s-_z$1*n,o=_w*n+_z$1*r-_x$2*s,c=_w*s+_x$2*n-_y$2*r,l=-_x$2*r-_y$2*n-_z$1*s;return e.x=a*_w+l*-_x$2+o*-_z$1-c*-_y$2,e.y=o*_w+l*-_y$2+c*-_x$2-a*-_z$1,e.z=c*_w+l*-_z$1+a*-_y$2-o*-_x$2,e.w=t.w,e}},{key:"toArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e[r+0]=t.x,e[r+1]=t.y,e[r+2]=t.z,e[r+3]=t.w,e}},{key:"fromArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e.x=t[r+0],e.y=t[r+1],e.z=t[r+2],e.w=t[r+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:EPSILON;return Math.abs(e.x-t.x)<=r*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=r*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=r*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=r*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),_createClass(s,[{key:"clone",value:function(){return new s(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,r){return e&&"object"===_typeof(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=r||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:EPSILON;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=i*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"equals4f",value:function(e,t,i,r,n){var s=4<arguments.length&&void 0!==n?n:EPSILON;return Math.abs(this.x-e)<=s*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=s*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=s*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-r)<=s*Math.max(1,Math.abs(this.w),Math.abs(r))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"strictEquals4f",value:function(e,t,i,r){return this.x===e&&this.y===t&&this.z===i&&this.w===r}},{key:"lerp",value:function(e,t){return _x$2=this.x,_y$2=this.y,_z$1=this.z,_w=this.w,this.x=_x$2+t*(e.x-_x$2),this.y=_y$2+t*(e.y-_y$2),this.z=_z$1+t*(e.z-_z$1),this.w=_w+t*(e.w-_w),this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=clamp(this.x,e.x,t.x),this.y=clamp(this.y,e.y,t.y),this.z=clamp(this.z,e.z,t.z),this.w=clamp(this.w,e.w,t.w),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this.w=this.w+e.w,this}},{key:"add4f",value:function(e,t,i,r){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this.w=this.w+r,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this.w=this.w-e.w,this}},{key:"subtract4f",value:function(e,t,i,r){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this.w=this.w-r,this}},{key:"multiplyScalar",value:function(e){return"object"===_typeof(e)&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e,this}},{key:"multiply",value:function(e){return"object"!==_typeof(e)&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this.w=this.w*e.w,this}},{key:"multiply4f",value:function(e,t,i,r){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this.w=this.w*r,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this.w=this.w/e.w,this}},{key:"divide4f",value:function(e,t,i,r){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this.w=this.w/r,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e){var t=this.x,i=this.y,r=this.z,n=e.x,s=e.y,a=e.z;return this.x=i*a-r*s,this.y=r*n-t*a,this.z=t*s-i*n,this}},{key:"length",value:function(){return _x$2=this.x,_y$2=this.y,_z$1=this.z,_w=this.w,Math.sqrt(_x$2*_x$2+_y$2*_y$2+_z$1*_z$1+_w*_w)}},{key:"lengthSqr",value:function(){return _x$2=this.x,_y$2=this.y,_z$1=this.z,_w=this.w,_x$2*_x$2+_y$2*_y$2+_z$1*_z$1+_w*_w}},{key:"normalize",value:function(){_x$2=this.x,_y$2=this.y,_z$1=this.z,_w=this.w;var e=_x$2*_x$2+_y$2*_y$2+_z$1*_z$1+_w*_w;return 0<e&&(e=1/Math.sqrt(e),this.x=_x$2*e,this.y=_y$2*e,this.z=_z$1*e,this.w=_w*e),this}},{key:"transformMat4",value:function(e){return _x$2=this.x,_y$2=this.y,_z$1=this.z,_w=this.w,this.x=e.m00*_x$2+e.m04*_y$2+e.m08*_z$1+e.m12*_w,this.y=e.m01*_x$2+e.m05*_y$2+e.m09*_z$1+e.m13*_w,this.z=e.m02*_x$2+e.m06*_y$2+e.m10*_z$1+e.m14*_w,this.w=e.m03*_x$2+e.m07*_y$2+e.m11*_z$1+e.m15*_w,this}}]),s}();function v4(e,t,i,r){return new Vec4(e,t,i,r)}Vec4.ZERO=Object.freeze(new Vec4(0,0,0,0)),Vec4.ONE=Object.freeze(new Vec4(1,1,1,1)),Vec4.NEG_ONE=Object.freeze(new Vec4(-1,-1,-1,-1)),CCClass.fastDefine("cc.Vec4",Vec4,{x:0,y:0,z:0,w:0}),cc.Vec4=Vec4,cc.v4=v4;var _a00=0,_a01=0,_a02=0,_a10=0,_a11=0,_a12=0,_a20=0,_a21=0,_a22=0,Mat3=function(){function u(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,s=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,c=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:1;return _classCallCheck(this,u),(e=_possibleConstructorReturn(this,_getPrototypeOf(u).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,"object"===_typeof(t)?(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08):(e.m00=t,e.m01=i,e.m02=r,e.m03=n,e.m04=s,e.m05=a,e.m06=o,e.m07=c,e.m08=l),e}return _inherits(u,ValueType),_createClass(u,null,[{key:"clone",value:function(e){return new u(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,i,r,n,s,a,o,c,l){return e.m00=t,e.m01=i,e.m02=r,e.m03=n,e.m04=s,e.m05=a,e.m06=o,e.m07=c,e.m08=l,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){return e===t?(_a01=t.m01,_a02=t.m02,_a12=t.m05,e.m01=t.m03,e.m02=t.m06,e.m03=_a01,e.m05=t.m07,e.m06=_a02,e.m07=_a12):(e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08),e}},{key:"invert",value:function(e,t){_a00=t.m00,_a01=t.m01,_a02=t.m02,_a10=t.m03,_a11=t.m04,_a12=t.m05,_a20=t.m06,_a21=t.m07;var i=(_a22=t.m08)*_a11-_a12*_a21,r=-_a22*_a10+_a12*_a20,n=_a21*_a10-_a11*_a20,s=_a00*i+_a01*r+_a02*n;return s&&(s=1/s,e.m00=i*s,e.m01=(-_a22*_a01+_a02*_a21)*s,e.m02=(_a12*_a01-_a02*_a11)*s,e.m03=r*s,e.m04=(_a22*_a00-_a02*_a20)*s,e.m05=(-_a12*_a00+_a02*_a10)*s,e.m06=n*s,e.m07=(-_a21*_a00+_a01*_a20)*s,e.m08=(_a11*_a00-_a01*_a10)*s),e}},{key:"determinant",value:function(e){return _a00=e.m00,_a01=e.m01,_a02=e.m02,_a10=e.m03,_a11=e.m04,_a12=e.m05,_a20=e.m06,_a21=e.m07,_a22=e.m08,_a00*(_a22*_a11-_a12*_a21)+_a01*(-_a22*_a10+_a12*_a20)+_a02*(_a21*_a10-_a11*_a20)}},{key:"multiply",value:function(e,t,i){_a00=t.m00,_a01=t.m01,_a02=t.m02,_a10=t.m03,_a11=t.m04,_a12=t.m05,_a20=t.m06,_a21=t.m07,_a22=t.m08;var r=i.m00,n=i.m01,s=i.m02,a=i.m03,o=i.m04,c=i.m05,l=i.m06,u=i.m07,h=i.m08;return e.m00=r*_a00+n*_a10+s*_a20,e.m01=r*_a01+n*_a11+s*_a21,e.m02=r*_a02+n*_a12+s*_a22,e.m03=a*_a00+o*_a10+c*_a20,e.m04=a*_a01+o*_a11+c*_a21,e.m05=a*_a02+o*_a12+c*_a22,e.m06=l*_a00+u*_a10+h*_a20,e.m07=l*_a01+u*_a11+h*_a21,e.m08=l*_a02+u*_a12+h*_a22,e}},{key:"multiplyMat4",value:function(e,t,i){_a00=t.m00,_a01=t.m01,_a02=t.m02,_a10=t.m03,_a11=t.m04,_a12=t.m05,_a20=t.m06,_a21=t.m07,_a22=t.m08;var r=i.m00,n=i.m01,s=i.m02,a=i.m04,o=i.m05,c=i.m06,l=i.m08,u=i.m09,h=i.m10;return e.m00=r*_a00+n*_a10+s*_a20,e.m01=r*_a01+n*_a11+s*_a21,e.m02=r*_a02+n*_a12+s*_a22,e.m03=a*_a00+o*_a10+c*_a20,e.m04=a*_a01+o*_a11+c*_a21,e.m05=a*_a02+o*_a12+c*_a22,e.m06=l*_a00+u*_a10+h*_a20,e.m07=l*_a01+u*_a11+h*_a21,e.m08=l*_a02+u*_a12+h*_a22,e}},{key:"transfrom",value:function(e,t,i){_a00=t.m00,_a01=t.m01,_a02=t.m02,_a10=t.m03,_a11=t.m04,_a12=t.m05,_a20=t.m06,_a21=t.m07,_a22=t.m08;var r=i.x,n=i.y;return e.m00=_a00,e.m01=_a01,e.m02=_a02,e.m03=_a10,e.m04=_a11,e.m05=_a12,e.m06=r*_a00+n*_a10+_a20,e.m07=r*_a01+n*_a11+_a21,e.m08=r*_a02+n*_a12+_a22,e}},{key:"scale",value:function(e,t,i){var r=i.x,n=i.y;return e.m00=r*t.m00,e.m01=r*t.m01,e.m02=r*t.m02,e.m03=n*t.m03,e.m04=n*t.m04,e.m05=n*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,i){_a00=t.m00,_a01=t.m01,_a02=t.m02,_a10=t.m03,_a11=t.m04,_a12=t.m05,_a20=t.m06,_a21=t.m07,_a22=t.m08;var r=Math.sin(i),n=Math.cos(i);return e.m00=n*_a00+r*_a10,e.m01=n*_a01+r*_a11,e.m02=n*_a02+r*_a12,e.m03=n*_a10-r*_a00,e.m04=n*_a11-r*_a01,e.m05=n*_a12-r*_a02,e.m06=_a20,e.m07=_a21,e.m08=_a22,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,t,i){return Vec3.lengthSqr(t)<EPSILON*EPSILON?(u.identity(e),e):(i=i||Vec3.UNIT_Y,Vec3.normalize(v3_1$1,Vec3.cross(v3_1$1,i,t)),Vec3.lengthSqr(v3_1$1)<EPSILON*EPSILON?u.identity(e):(Vec3.cross(v3_2$1,t,v3_1$1),u.set(e,v3_1$1.x,v3_1$1.y,v3_1$1.z,v3_2$1.x,v3_2$1.y,v3_2$1.z,t.x,t.y,t.z)),e)}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var i=Math.sin(t),r=Math.cos(t);return e.m00=r,e.m01=i,e.m02=0,e.m03=-i,e.m04=r,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,r=t.y,n=t.z,s=t.w,a=i+i,o=r+r,c=n+n,l=i*a,u=r*a,h=r*o,_=n*a,p=n*o,d=n*c,f=s*a,m=s*o,y=s*c;return e.m00=1-h-d,e.m03=u-y,e.m06=_+m,e.m01=u+y,e.m04=1-l-d,e.m07=p-f,e.m02=_-m,e.m05=p+f,e.m08=1-l-h,e}},{key:"inverseTransposeMat4",value:function(e,t){var i=t.m00,r=t.m01,n=t.m02,s=t.m03,a=t.m04,o=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,p=t.m11,d=t.m12,f=t.m13,m=t.m14,y=t.m15,v=i*o-r*a,g=i*c-n*a,b=i*l-s*a,x=r*c-n*o,T=r*l-s*o,C=n*l-s*c,S=u*f-h*d,E=u*m-_*d,w=u*y-p*d,A=h*m-_*f,$=h*y-p*f,O=_*y-p*m,D=v*O-g*$+b*A+x*w-T*E+C*S;return D?(D=1/D,e.m00=(o*O-c*$+l*A)*D,e.m01=(c*w-a*O-l*E)*D,e.m02=(a*$-o*w+l*S)*D,e.m03=(n*$-r*O-s*A)*D,e.m04=(i*O-n*w+s*E)*D,e.m05=(r*w-i*$-s*S)*D,e.m06=(f*C-m*T+y*x)*D,e.m07=(m*b-d*C-y*g)*D,e.m08=(d*T-f*b+y*v)*D,e):null}},{key:"toArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e[r+0]=t.m00,e[r+1]=t.m01,e[r+2]=t.m02,e[r+3]=t.m03,e[r+4]=t.m04,e[r+5]=t.m05,e[r+6]=t.m06,e[r+7]=t.m07,e[r+8]=t.m08,e}},{key:"fromArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e.m00=t[r+0],e.m01=t[r+1],e.m02=t[r+2],e.m03=t[r+3],e.m04=t[r+4],e.m05=t[r+5],e.m06=t[r+6],e.m07=t[r+7],e.m08=t[r+8],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,r){return e.m00=i.m00*r+t.m00,e.m01=i.m01*r+t.m01,e.m02=i.m02*r+t.m02,e.m03=i.m03*r+t.m03,e.m04=i.m04*r+t.m04,e.m05=i.m05*r+t.m05,e.m06=i.m06*r+t.m06,e.m07=i.m07*r+t.m07,e.m08=i.m08*r+t.m08,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:EPSILON;return Math.abs(e.m00-t.m00)<=r*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=r*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=r*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=r*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=r*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=r*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=r*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=r*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=r*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}}]),_createClass(u,[{key:"clone",value:function(){var e=this;return new u(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"set",value:function(e,t,i,r,n,s,a,o,c){var l=0<arguments.length&&void 0!==e?e:1,u=1<arguments.length&&void 0!==t?t:0,h=2<arguments.length&&void 0!==i?i:0,_=3<arguments.length&&void 0!==r?r:0,p=4<arguments.length&&void 0!==n?n:1,d=5<arguments.length&&void 0!==s?s:0,f=6<arguments.length&&void 0!==a?a:0,m=7<arguments.length&&void 0!==o?o:0,y=8<arguments.length&&void 0!==c?c:1;return"object"===_typeof(l)?(this.m00=l.m00,this.m01=l.m01,this.m02=l.m02,this.m03=l.m03,this.m04=l.m04,this.m05=l.m05,this.m06=l.m06,this.m07=l.m07,this.m08=l.m08):(this.m00=l,this.m01=u,this.m02=h,this.m03=_,this.m04=p,this.m05=d,this.m06=f,this.m07=m,this.m08=y),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:EPSILON;return Math.abs(this.m00-e.m00)<=i*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=i*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=i*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=i*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=i*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=i*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=i*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=i*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=i*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}},{key:"toString",value:function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this}},{key:"invert",value:function(){_a00=this.m00,_a01=this.m01,_a02=this.m02,_a10=this.m03,_a11=this.m04,_a12=this.m05,_a20=this.m06,_a21=this.m07;var e=(_a22=this.m08)*_a11-_a12*_a21,t=-_a22*_a10+_a12*_a20,i=_a21*_a10-_a11*_a20,r=_a00*e+_a01*t+_a02*i;return r?(r=1/r,this.m00=e*r,this.m01=(-_a22*_a01+_a02*_a21)*r,this.m02=(_a12*_a01-_a02*_a11)*r,this.m03=t*r,this.m04=(_a22*_a00-_a02*_a20)*r,this.m05=(-_a12*_a00+_a02*_a10)*r,this.m06=i*r,this.m07=(-_a21*_a00+_a01*_a20)*r,this.m08=(_a11*_a00-_a01*_a10)*r,this):null}},{key:"determinant",value:function(){return _a00=this.m00,_a01=this.m01,_a02=this.m02,_a10=this.m03,_a11=this.m04,_a12=this.m05,_a20=this.m06,_a21=this.m07,_a22=this.m08,_a00*(_a22*_a11-_a12*_a21)+_a01*(-_a22*_a10+_a12*_a20)+_a02*(_a21*_a10-_a11*_a20)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,r=this.m02,n=this.m03,s=this.m04,a=this.m05,o=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,_=e.m02,p=e.m03,d=e.m04,f=e.m05,m=e.m06,y=e.m07,v=e.m08;return this.m00=u*t+h*n+_*o,this.m01=u*i+h*s+_*c,this.m02=u*r+h*a+_*l,this.m03=p*t+d*n+f*o,this.m04=p*i+d*s+f*c,this.m05=p*r+d*a+f*l,this.m06=m*t+y*n+v*o,this.m07=m*i+y*s+v*c,this.m08=m*r+y*a+v*l,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this}},{key:"scale",value:function(e){var t=e.x,i=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}},{key:"rotate",value:function(e){_a00=this.m00,_a01=this.m01,_a02=this.m02,_a10=this.m03,_a11=this.m04,_a12=this.m05,_a20=this.m06,_a21=this.m07,_a22=this.m08;var t=Math.sin(e),i=Math.cos(e);return this.m00=i*_a00+t*_a10,this.m01=i*_a01+t*_a11,this.m02=i*_a02+t*_a12,this.m03=i*_a10-t*_a00,this.m04=i*_a11-t*_a01,this.m05=i*_a12-t*_a02,this.m06=_a20,this.m07=_a21,this.m08=_a22,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,r=e.z,n=e.w,s=t+t,a=i+i,o=r+r,c=t*s,l=i*s,u=i*a,h=r*s,_=r*a,p=r*o,d=n*s,f=n*a,m=n*o;return this.m00=1-u-p,this.m03=l-m,this.m06=h+f,this.m01=l+m,this.m04=1-c-p,this.m07=_-d,this.m02=h-f,this.m05=_+d,this.m08=1-c-u,this}}]),u}();Mat3.IDENTITY=Object.freeze(new Mat3);var v3_1$1=new Vec3,v3_2$1=new Vec3;CCClass.fastDefine("cc.Mat3",Mat3,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),cc.Mat3=Mat3;var _x$3=0,_y$3=0,_z$2=0,_w$1=0,Quat=function(){function a(e,t,i,r){var n;return _classCallCheck(this,a),(n=_possibleConstructorReturn(this,_getPrototypeOf(a).call(this))).x=void 0,n.y=void 0,n.z=void 0,n.w=void 0,e&&"object"===_typeof(e)?(n.x=e.x,n.y=e.y,n.z=e.z,n.w=e.w):(n.x=e||0,n.y=t||0,n.z=i||0,n.w=r||1),n}return _inherits(a,ValueType),_createClass(a,null,[{key:"clone",value:function(e){return new a(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,r,n){return e.x=t,e.y=i,e.z=r,e.w=n,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,t,i){var r=Vec3.dot(t,i);return r<-.999999?(Vec3.cross(v3_1$2,Vec3.UNIT_X,t),v3_1$2.length()<1e-6&&Vec3.cross(v3_1$2,Vec3.UNIT_Y,t),Vec3.normalize(v3_1$2,v3_1$2),a.fromAxisAngle(e,v3_1$2,Math.PI),e):.999999<r?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Vec3.cross(v3_1$2,t,i),e.x=v3_1$2.x,e.y=v3_1$2.y,e.z=v3_1$2.z,e.w=1+r,a.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var i=2*Math.acos(t.w),r=Math.sin(i/2);return 0!==r?(e.x=t.x/r,e.y=t.y/r,e.z=t.z/r):(e.x=1,e.y=0,e.z=0),i}},{key:"multiply",value:function(e,t,i){return _x$3=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,_y$3=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,_z$2=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,_w$1=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z,e.x=_x$3,e.y=_y$3,e.z=_z$2,e.w=_w$1,e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,r){return e.x=t.x+i.x*r,e.y=t.y+i.y*r,e.z=t.z+i.z*r,e.w=t.w+i.w*r,e}},{key:"rotateX",value:function(e,t,i){i*=.5;var r=Math.sin(i),n=Math.cos(i);return e.x=t.x*n+t.w*r,e.y=t.y*n+t.z*r,e.z=t.z*n-t.y*r,e.w=t.w*n-t.x*r,e}},{key:"rotateY",value:function(e,t,i){i*=.5;var r=Math.sin(i),n=Math.cos(i);return e.x=t.x*n-t.z*r,e.y=t.y*n+t.w*r,e.z=t.z*n+t.x*r,e.w=t.w*n-t.y*r,e}},{key:"rotateZ",value:function(e,t,i){i*=.5;var r=Math.sin(i),n=Math.cos(i);return e.x=t.x*n+t.y*r,e.y=t.y*n-t.x*r,e.z=t.z*n+t.w*r,e.w=t.w*n-t.z*r,e}},{key:"rotateAround",value:function(e,t,i,r){return a.invert(qt_1,t),Vec3.transformQuat(v3_1$2,i,qt_1),a.fromAxisAngle(qt_1,v3_1$2,r),a.multiply(e,t,qt_1),e}},{key:"rotateAroundLocal",value:function(e,t,i,r){return a.fromAxisAngle(qt_1,i,r),a.multiply(e,t,qt_1),e}},{key:"calculateW",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,r){return e.x=t.x+r*(i.x-t.x),e.y=t.y+r*(i.y-t.y),e.z=t.z+r*(i.z-t.z),e.w=t.w+r*(i.w-t.w),e}},{key:"slerp",value:function(e,t,i,r){var n=0,s=0,a=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(a<0&&(a=-a,i.x=-i.x,i.y=-i.y,i.z=-i.z,i.w=-i.w),1e-6<1-a){var o=Math.acos(a),c=Math.sin(o);n=Math.sin((1-r)*o)/c,s=Math.sin(r*o)/c}else n=1-r,s=r;return e.x=n*t.x+s*i.x,e.y=n*t.y+s*i.y,e.z=n*t.z+s*i.z,e.w=n*t.w+s*i.w,e}},{key:"sqlerp",value:function(e,t,i,r,n,s){return a.slerp(qt_1,t,n,s),a.slerp(qt_2,i,r,s),a.slerp(e,qt_1,qt_2,2*s*(1-s)),e}},{key:"invert",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,r=i?1/i:0;return e.x=-t.x*r,e.y=-t.y*r,e.z=-t.z*r,e.w=t.w*r,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"len",value:function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}},{key:"lengthSqr",value:function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}},{key:"normalize",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return 0<i&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e}},{key:"fromAxes",value:function(e,t,i,r){return Mat3.set(m3_1,t.x,t.y,t.z,i.x,i.y,i.z,r.x,r.y,r.z),a.normalize(e,a.fromMat3(e,m3_1))}},{key:"fromViewUp",value:function(e,t,i){return Mat3.fromViewUp(m3_1,t,i),a.normalize(e,a.fromMat3(e,m3_1))}},{key:"fromAxisAngle",value:function(e,t,i){i*=.5;var r=Math.sin(i);return e.x=r*t.x,e.y=r*t.y,e.z=r*t.z,e.w=Math.cos(i),e}},{key:"fromMat3",value:function(e,t){var i=t.m00,r=t.m03,n=t.m06,s=t.m01,a=t.m04,o=t.m07,c=t.m02,l=t.m05,u=t.m08,h=i+a+u;if(0<h){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(l-o)*_,e.y=(n-c)*_,e.z=(s-r)*_}else if(a<i&&u<i){var p=2*Math.sqrt(1+i-a-u);e.w=(l-o)/p,e.x=.25*p,e.y=(r+s)/p,e.z=(n+c)/p}else if(u<a){var d=2*Math.sqrt(1+a-i-u);e.w=(n-c)/d,e.x=(r+s)/d,e.y=.25*d,e.z=(o+l)/d}else{var f=2*Math.sqrt(1+u-i-a);e.w=(s-r)/f,e.x=(n+c)/f,e.y=(o+l)/f,e.z=.25*f}return e}},{key:"fromEuler",value:function(e,t,i,r){t*=halfToRad,i*=halfToRad,r*=halfToRad;var n=Math.sin(t),s=Math.cos(t),a=Math.sin(i),o=Math.cos(i),c=Math.sin(r),l=Math.cos(r);return e.x=n*o*l+s*a*c,e.y=s*a*l+n*o*c,e.z=s*o*c-n*a*l,e.w=s*o*l-n*a*c,e}},{key:"toAxisX",value:function(e,t){var i=2*t.y,r=2*t.z;return e.x=1-i*t.y-r*t.z,e.y=i*t.x+r*t.w,e.z=r*t.x+i*t.w,e}},{key:"toAxisY",value:function(e,t){var i=2*t.x,r=2*t.y,n=2*t.z;return e.x=r*t.x-n*t.w,e.y=1-i*t.x-n*t.z,e.z=n*t.y+i*t.w,e}},{key:"toAxisZ",value:function(e,t){var i=2*t.x,r=2*t.y,n=2*t.z;return e.x=n*t.x-r*t.w,e.y=n*t.y-i*t.w,e.z=1-i*t.x-r*t.y,e}},{key:"toEuler",value:function(e,t,i){var r=t.x,n=t.y,s=t.z,a=t.w,o=0,c=0,l=0,u=r*n+s*a;if(.499999<u)o=0,c=toDegree(2*Math.atan2(r,a)),l=90;else if(u<-.499999)o=0,c=-toDegree(2*Math.atan2(r,a)),l=-90;else{var h=r*r,_=n*n,p=s*s;o=toDegree(Math.atan2(2*r*a-2*n*s,1-2*h-2*p)),c=toDegree(Math.atan2(2*n*a-2*r*s,1-2*_-2*p)),l=toDegree(Math.asin(2*u)),i&&(o=-180*Math.sign(o+1e-6)+o,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=o,e.y=c,e.z=l,e}},{key:"toArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e[r+0]=t.x,e[r+1]=t.y,e[r+2]=t.z,e[r+3]=t.w,e}},{key:"fromArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e.x=t[r+0],e.y=t[r+1],e.z=t[r+2],e.w=t[r+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:EPSILON;return Math.abs(e.x-t.x)<=r*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=r*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=r*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=r*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),_createClass(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,r){return e&&"object"===_typeof(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=r||1),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:EPSILON;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=i*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return a.toEuler(e,this)}},{key:"lerp",value:function(e,t){var i=0,r=0,n=this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w;if(n<0&&(n=-n,e.x=-e.x,e.y=-e.y,e.z=-e.z,e.w=-e.w),1e-6<1-n){var s=Math.acos(n),a=Math.sin(s);i=Math.sin((1-t)*s)/a,r=Math.sin(t*s)/a}else i=1-t,r=t;return this.x=i*this.x+r*e.x,this.y=i*this.y+r*e.y,this.z=i*this.z+r*e.z,this.w=i*this.w+r*e.w,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}]),a}();Quat.IDENTITY=Object.freeze(new Quat);var qt_1=new Quat,qt_2=new Quat,v3_1$2=new Vec3,m3_1=new Mat3,halfToRad=.5*Math.PI/180;function quat(){return new Quat(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:1)}CCClass.fastDefine("cc.Quat",Quat,{x:0,y:0,z:0,w:1}),cc.Quat=Quat,cc.quat=quat;var _a00$1=0,_a01$1=0,_a02$1=0,_a03=0,_a10$1=0,_a11$1=0,_a12$1=0,_a13=0,_a20$1=0,_a21$1=0,_a22$1=0,_a23=0,_a30=0,_a31=0,_a32=0,_a33=0,Mat4=function(){function y(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,s=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,c=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,u=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,h=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,_=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,p=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,d=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,f=14<arguments.length&&void 0!==arguments[14]?arguments[14]:0,m=15<arguments.length&&void 0!==arguments[15]?arguments[15]:1;return _classCallCheck(this,y),(e=_possibleConstructorReturn(this,_getPrototypeOf(y).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,e.m09=void 0,e.m10=void 0,e.m11=void 0,e.m12=void 0,e.m13=void 0,e.m14=void 0,e.m15=void 0,"object"===_typeof(t)?(e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e.m00=t.m00):(e.m01=i,e.m02=r,e.m03=n,e.m04=s,e.m05=a,e.m06=o,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=p,e.m13=d,e.m14=f,e.m15=m,e.m00=t),e}return _inherits(y,ValueType),_createClass(y,null,[{key:"clone",value:function(e){return new y(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,i,r,n,s,a,o,c,l,u,h,_,p,d,f,m){return e.m00=t,e.m01=i,e.m02=r,e.m03=n,e.m04=s,e.m05=a,e.m06=o,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=p,e.m13=d,e.m14=f,e.m15=m,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,r=t.m02,n=t.m03,s=t.m06,a=t.m07,o=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=r,e.m09=s,e.m11=t.m14,e.m12=n,e.m13=a,e.m14=o}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){_a00$1=t.m00,_a01$1=t.m01,_a02$1=t.m02,_a03=t.m03,_a10$1=t.m04,_a11$1=t.m05,_a12$1=t.m06,_a13=t.m07,_a20$1=t.m08,_a21$1=t.m09,_a22$1=t.m10,_a23=t.m11,_a30=t.m12,_a31=t.m13,_a32=t.m14,_a33=t.m15;var i=_a00$1*_a11$1-_a01$1*_a10$1,r=_a00$1*_a12$1-_a02$1*_a10$1,n=_a00$1*_a13-_a03*_a10$1,s=_a01$1*_a12$1-_a02$1*_a11$1,a=_a01$1*_a13-_a03*_a11$1,o=_a02$1*_a13-_a03*_a12$1,c=_a20$1*_a31-_a21$1*_a30,l=_a20$1*_a32-_a22$1*_a30,u=_a20$1*_a33-_a23*_a30,h=_a21$1*_a32-_a22$1*_a31,_=_a21$1*_a33-_a23*_a31,p=_a22$1*_a33-_a23*_a32,d=i*p-r*_+n*h+s*u-a*l+o*c;return 0===d||(d=1/d,e.m00=(_a11$1*p-_a12$1*_+_a13*h)*d,e.m01=(_a02$1*_-_a01$1*p-_a03*h)*d,e.m02=(_a31*o-_a32*a+_a33*s)*d,e.m03=(_a22$1*a-_a21$1*o-_a23*s)*d,e.m04=(_a12$1*u-_a10$1*p-_a13*l)*d,e.m05=(_a00$1*p-_a02$1*u+_a03*l)*d,e.m06=(_a32*n-_a30*o-_a33*r)*d,e.m07=(_a20$1*o-_a22$1*n+_a23*r)*d,e.m08=(_a10$1*_-_a11$1*u+_a13*c)*d,e.m09=(_a01$1*u-_a00$1*_-_a03*c)*d,e.m10=(_a30*a-_a31*n+_a33*i)*d,e.m11=(_a21$1*n-_a20$1*a-_a23*i)*d,e.m12=(_a11$1*l-_a10$1*h-_a12$1*c)*d,e.m13=(_a00$1*h-_a01$1*l+_a02$1*c)*d,e.m14=(_a31*r-_a30*s-_a32*i)*d,e.m15=(_a20$1*s-_a21$1*r+_a22$1*i)*d),e}},{key:"determinant",value:function(e){return _a00$1=e.m00,_a01$1=e.m01,_a02$1=e.m02,_a03=e.m03,_a10$1=e.m04,_a11$1=e.m05,_a12$1=e.m06,_a13=e.m07,_a20$1=e.m08,_a21$1=e.m09,_a22$1=e.m10,_a23=e.m11,_a30=e.m12,_a31=e.m13,_a32=e.m14,_a33=e.m15,(_a00$1*_a11$1-_a01$1*_a10$1)*(_a22$1*_a33-_a23*_a32)-(_a00$1*_a12$1-_a02$1*_a10$1)*(_a21$1*_a33-_a23*_a31)+(_a00$1*_a13-_a03*_a10$1)*(_a21$1*_a32-_a22$1*_a31)+(_a01$1*_a12$1-_a02$1*_a11$1)*(_a20$1*_a33-_a23*_a30)-(_a01$1*_a13-_a03*_a11$1)*(_a20$1*_a32-_a22$1*_a30)+(_a02$1*_a13-_a03*_a12$1)*(_a20$1*_a31-_a21$1*_a30)}},{key:"multiply",value:function(e,t,i){_a00$1=t.m00,_a01$1=t.m01,_a02$1=t.m02,_a03=t.m03,_a10$1=t.m04,_a11$1=t.m05,_a12$1=t.m06,_a13=t.m07,_a20$1=t.m08,_a21$1=t.m09,_a22$1=t.m10,_a23=t.m11,_a30=t.m12,_a31=t.m13,_a32=t.m14,_a33=t.m15;var r=i.m00,n=i.m01,s=i.m02,a=i.m03;return e.m00=r*_a00$1+n*_a10$1+s*_a20$1+a*_a30,e.m01=r*_a01$1+n*_a11$1+s*_a21$1+a*_a31,e.m02=r*_a02$1+n*_a12$1+s*_a22$1+a*_a32,e.m03=r*_a03+n*_a13+s*_a23+a*_a33,r=i.m04,n=i.m05,s=i.m06,a=i.m07,e.m04=r*_a00$1+n*_a10$1+s*_a20$1+a*_a30,e.m05=r*_a01$1+n*_a11$1+s*_a21$1+a*_a31,e.m06=r*_a02$1+n*_a12$1+s*_a22$1+a*_a32,e.m07=r*_a03+n*_a13+s*_a23+a*_a33,r=i.m08,n=i.m09,s=i.m10,a=i.m11,e.m08=r*_a00$1+n*_a10$1+s*_a20$1+a*_a30,e.m09=r*_a01$1+n*_a11$1+s*_a21$1+a*_a31,e.m10=r*_a02$1+n*_a12$1+s*_a22$1+a*_a32,e.m11=r*_a03+n*_a13+s*_a23+a*_a33,r=i.m12,n=i.m13,s=i.m14,a=i.m15,e.m12=r*_a00$1+n*_a10$1+s*_a20$1+a*_a30,e.m13=r*_a01$1+n*_a11$1+s*_a21$1+a*_a31,e.m14=r*_a02$1+n*_a12$1+s*_a22$1+a*_a32,e.m15=r*_a03+n*_a13+s*_a23+a*_a33,e}},{key:"transform",value:function(e,t,i){var r=i.x,n=i.y,s=i.z;return t===e?(e.m12=t.m00*r+t.m04*n+t.m08*s+t.m12,e.m13=t.m01*r+t.m05*n+t.m09*s+t.m13,e.m14=t.m02*r+t.m06*n+t.m10*s+t.m14,e.m15=t.m03*r+t.m07*n+t.m11*s+t.m15):(_a00$1=t.m00,_a01$1=t.m01,_a02$1=t.m02,_a03=t.m03,_a10$1=t.m04,_a11$1=t.m05,_a12$1=t.m06,_a13=t.m07,_a20$1=t.m08,_a21$1=t.m09,_a22$1=t.m10,_a23=t.m11,_a30=t.m12,_a31=t.m13,_a32=t.m14,_a33=t.m15,e.m00=_a00$1,e.m01=_a01$1,e.m02=_a02$1,e.m03=_a03,e.m04=_a10$1,e.m05=_a11$1,e.m06=_a12$1,e.m07=_a13,e.m08=_a20$1,e.m09=_a21$1,e.m10=_a22$1,e.m11=_a23,e.m12=_a00$1*r+_a10$1*n+_a20$1*s+t.m12,e.m13=_a01$1*r+_a11$1*n+_a21$1*s+t.m13,e.m14=_a02$1*r+_a12$1*n+_a22$1*s+t.m14,e.m15=_a03*r+_a13*n+_a23*s+t.m15),e}},{key:"translate",value:function(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.y):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}},{key:"scale",value:function(e,t,i){var r=i.x,n=i.y,s=i.z;return e.m00=t.m00*r,e.m01=t.m01*r,e.m02=t.m02*r,e.m03=t.m03*r,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*s,e.m09=t.m09*s,e.m10=t.m10*s,e.m11=t.m11*s,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,i,r){var n=r.x,s=r.y,a=r.z,o=Math.sqrt(n*n+s*s+a*a);if(Math.abs(o)<EPSILON)return null;n*=o=1/o,s*=o,a*=o;var c=Math.sin(i),l=Math.cos(i),u=1-l;_a00$1=t.m00,_a01$1=t.m01,_a02$1=t.m02,_a03=t.m03,_a10$1=t.m04,_a11$1=t.m05,_a12$1=t.m06,_a13=t.m07,_a20$1=t.m08,_a21$1=t.m09,_a22$1=t.m10,_a23=t.m11;var h=n*n*u+l,_=s*n*u+a*c,p=a*n*u-s*c,d=n*s*u-a*c,f=s*s*u+l,m=a*s*u+n*c,y=n*a*u+s*c,v=s*a*u-n*c,g=a*a*u+l;return e.m00=_a00$1*h+_a10$1*_+_a20$1*p,e.m01=_a01$1*h+_a11$1*_+_a21$1*p,e.m02=_a02$1*h+_a12$1*_+_a22$1*p,e.m03=_a03*h+_a13*_+_a23*p,e.m04=_a00$1*d+_a10$1*f+_a20$1*m,e.m05=_a01$1*d+_a11$1*f+_a21$1*m,e.m06=_a02$1*d+_a12$1*f+_a22$1*m,e.m07=_a03*d+_a13*f+_a23*m,e.m08=_a00$1*y+_a10$1*v+_a20$1*g,e.m09=_a01$1*y+_a11$1*v+_a21$1*g,e.m10=_a02$1*y+_a12$1*v+_a22$1*g,e.m11=_a03*y+_a13*v+_a23*g,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,i){var r=Math.sin(i),n=Math.cos(i),s=t.m04,a=t.m05,o=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=s*n+l*r,e.m05=a*n+u*r,e.m06=o*n+h*r,e.m07=c*n+_*r,e.m08=l*n-s*r,e.m09=u*n-a*r,e.m10=h*n-o*r,e.m11=_*n-c*r,e}},{key:"rotateY",value:function(e,t,i){var r=Math.sin(i),n=Math.cos(i),s=t.m00,a=t.m01,o=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=s*n-l*r,e.m01=a*n-u*r,e.m02=o*n-h*r,e.m03=c*n-_*r,e.m08=s*r+l*n,e.m09=a*r+u*n,e.m10=o*r+h*n,e.m11=c*r+_*n,e}},{key:"rotateZ",value:function(e,t,i){var r=Math.sin(i),n=Math.cos(i),s=t.m00,a=t.m01,o=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=s*n+l*r,e.m01=a*n+u*r,e.m02=o*n+h*r,e.m03=c*n+_*r,e.m04=l*n-s*r,e.m05=u*n-a*r,e.m06=h*n-o*r,e.m07=_*n-c*r,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,i){var r=i.x,n=i.y,s=i.z,a=Math.sqrt(r*r+n*n+s*s);if(Math.abs(a)<EPSILON)return null;r*=a=1/a,n*=a,s*=a;var o=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=r*r*l+c,e.m01=n*r*l+s*o,e.m02=s*r*l-n*o,e.m03=0,e.m04=r*n*l-s*o,e.m05=n*n*l+c,e.m06=s*n*l+r*o,e.m07=0,e.m08=r*s*l+n*o,e.m09=n*s*l-r*o,e.m10=s*s*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var i=Math.sin(t),r=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=r,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=r,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var i=Math.sin(t),r=Math.cos(t);return e.m00=r,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=r,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var i=Math.sin(t),r=Math.cos(t);return e.m00=r,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=r,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,i){var r=t.x,n=t.y,s=t.z,a=t.w,o=r+r,c=n+n,l=s+s,u=r*o,h=r*c,_=r*l,p=n*c,d=n*l,f=s*l,m=a*o,y=a*c,v=a*l;return e.m00=1-(p+f),e.m01=h+v,e.m02=_-y,e.m03=0,e.m04=h-v,e.m05=1-(u+f),e.m06=d+m,e.m07=0,e.m08=_+y,e.m09=d-m,e.m10=1-(u+p),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var i=m3_1$1.m00=t.m00,r=m3_1$1.m01=t.m01,n=m3_1$1.m02=t.m02,s=m3_1$1.m03=t.m04,a=m3_1$1.m04=t.m05,o=m3_1$1.m05=t.m06,c=m3_1$1.m06=t.m08,l=m3_1$1.m07=t.m09,u=m3_1$1.m08=t.m10;return e.x=Math.sqrt(i*i+r*r+n*n),e.y=Math.sqrt(s*s+a*a+o*o),e.z=Math.sqrt(c*c+l*l+u*u),Mat3.determinant(m3_1$1)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var i=t.m00+t.m05+t.m10,r=0;return 0<i?(r=2*Math.sqrt(i+1),e.w=.25*r,e.x=(t.m06-t.m09)/r,e.y=(t.m08-t.m02)/r,e.z=(t.m01-t.m04)/r):t.m00>t.m05&&t.m00>t.m10?(r=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/r,e.x=.25*r,e.y=(t.m01+t.m04)/r,e.z=(t.m08+t.m02)/r):t.m05>t.m10?(r=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/r,e.x=(t.m01+t.m04)/r,e.y=.25*r,e.z=(t.m06+t.m09)/r):(r=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/r,e.x=(t.m08+t.m02)/r,e.y=(t.m06+t.m09)/r,e.z=.25*r),e}},{key:"toRTS",value:function(e,t,i,r){r.x=Vec3.set(v3_1$3,e.m00,e.m01,e.m02).length(),m3_1$1.m00=e.m00/r.x,m3_1$1.m01=e.m01/r.x,m3_1$1.m02=e.m02/r.x,r.y=Vec3.set(v3_1$3,e.m04,e.m05,e.m06).length(),m3_1$1.m03=e.m04/r.y,m3_1$1.m04=e.m05/r.y,m3_1$1.m05=e.m06/r.y,r.z=Vec3.set(v3_1$3,e.m08,e.m09,e.m10).length(),m3_1$1.m06=e.m08/r.z,m3_1$1.m07=e.m09/r.z,m3_1$1.m08=e.m10/r.z,Mat3.determinant(m3_1$1)<0&&(r.x*=-1,m3_1$1.m00*=-1,m3_1$1.m01*=-1,m3_1$1.m02*=-1),Quat.fromMat3(t,m3_1$1),Vec3.set(i,e.m12,e.m13,e.m14)}},{key:"fromRTS",value:function(e,t,i,r){var n=t.x,s=t.y,a=t.z,o=t.w,c=n+n,l=s+s,u=a+a,h=n*c,_=n*l,p=n*u,d=s*l,f=s*u,m=a*u,y=o*c,v=o*l,g=o*u,b=r.x,x=r.y,T=r.z;return e.m00=(1-(d+m))*b,e.m01=(_+g)*b,e.m02=(p-v)*b,e.m03=0,e.m04=(_-g)*x,e.m05=(1-(h+m))*x,e.m06=(f+y)*x,e.m07=0,e.m08=(p+v)*T,e.m09=(f-y)*T,e.m10=(1-(h+d))*T,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,i,r,n){var s=t.x,a=t.y,o=t.z,c=t.w,l=s+s,u=a+a,h=o+o,_=s*l,p=s*u,d=s*h,f=a*u,m=a*h,y=o*h,v=c*l,g=c*u,b=c*h,x=r.x,T=r.y,C=r.z,S=n.x,E=n.y,w=n.z;return e.m00=(1-(f+y))*x,e.m01=(p+b)*x,e.m02=(d-g)*x,e.m03=0,e.m04=(p-b)*T,e.m05=(1-(_+y))*T,e.m06=(m+v)*T,e.m07=0,e.m08=(d+g)*C,e.m09=(m-v)*C,e.m10=(1-(_+f))*C,e.m11=0,e.m12=i.x+S-(e.m00*S+e.m04*E+e.m08*w),e.m13=i.y+E-(e.m01*S+e.m05*E+e.m09*w),e.m14=i.z+w-(e.m02*S+e.m06*E+e.m10*w),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,r=t.y,n=t.z,s=t.w,a=i+i,o=r+r,c=n+n,l=i*a,u=r*a,h=r*o,_=n*a,p=n*o,d=n*c,f=s*a,m=s*o,y=s*c;return e.m00=1-h-d,e.m01=u+y,e.m02=_-m,e.m03=0,e.m04=u-y,e.m05=1-l-d,e.m06=p+f,e.m07=0,e.m08=_+m,e.m09=p-f,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,i,r,n,s,a){var o=1/(i-t),c=1/(n-r),l=1/(s-a);return e.m00=2*s*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*s*c,e.m06=0,e.m07=0,e.m08=(i+t)*o,e.m09=(n+r)*c,e.m10=(a+s)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*s*2*l,e.m15=0,e}},{key:"perspective",value:function(e,t,i,r,n){var s=1/Math.tan(t/2),a=1/(r-n);return e.m00=s/i,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=s,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(n+r)*a,e.m11=-1,e.m12=0,e.m13=0,e.m14=2*n*r*a,e.m15=0,e}},{key:"ortho",value:function(e,t,i,r,n,s,a){var o=1/(t-i),c=1/(r-n),l=1/(s-a);return e.m00=-2*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=-2*c,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=2*l,e.m11=0,e.m12=(t+i)*o,e.m13=(n+r)*c,e.m14=(a+s)*l,e.m15=1,e}},{key:"lookAt",value:function(e,t,i,r){var n=t.x,s=t.y,a=t.z,o=r.x,c=r.y,l=r.z,u=n-i.x,h=s-i.y,_=a-i.z,p=1/Math.sqrt(u*u+h*h+_*_),d=c*(_*=p)-l*(h*=p),f=l*(u*=p)-o*_,m=o*h-c*u,y=h*(m*=p=1/Math.sqrt(d*d+f*f+m*m))-_*(f*=p),v=_*(d*=p)-u*m,g=u*f-h*d;return e.m00=d,e.m01=y,e.m02=u,e.m03=0,e.m04=f,e.m05=v,e.m06=h,e.m07=0,e.m08=m,e.m09=g,e.m10=_,e.m11=0,e.m12=-(d*n+f*s+m*a),e.m13=-(y*n+v*s+g*a),e.m14=-(u*n+h*s+_*a),e.m15=1,e}},{key:"inverseTranspose",value:function(e,t){_a00$1=t.m00,_a01$1=t.m01,_a02$1=t.m02,_a03=t.m03,_a10$1=t.m04,_a11$1=t.m05,_a12$1=t.m06,_a13=t.m07,_a20$1=t.m08,_a21$1=t.m09,_a22$1=t.m10,_a23=t.m11,_a30=t.m12,_a31=t.m13,_a32=t.m14,_a33=t.m15;var i=_a00$1*_a11$1-_a01$1*_a10$1,r=_a00$1*_a12$1-_a02$1*_a10$1,n=_a00$1*_a13-_a03*_a10$1,s=_a01$1*_a12$1-_a02$1*_a11$1,a=_a01$1*_a13-_a03*_a11$1,o=_a02$1*_a13-_a03*_a12$1,c=_a20$1*_a31-_a21$1*_a30,l=_a20$1*_a32-_a22$1*_a30,u=_a20$1*_a33-_a23*_a30,h=_a21$1*_a32-_a22$1*_a31,_=_a21$1*_a33-_a23*_a31,p=_a22$1*_a33-_a23*_a32,d=i*p-r*_+n*h+s*u-a*l+o*c;return d?(d=1/d,e.m00=(_a11$1*p-_a12$1*_+_a13*h)*d,e.m01=(_a12$1*u-_a10$1*p-_a13*l)*d,e.m02=(_a10$1*_-_a11$1*u+_a13*c)*d,e.m03=0,e.m04=(_a02$1*_-_a01$1*p-_a03*h)*d,e.m05=(_a00$1*p-_a02$1*u+_a03*l)*d,e.m06=(_a01$1*u-_a00$1*_-_a03*c)*d,e.m07=0,e.m08=(_a31*o-_a32*a+_a33*s)*d,e.m09=(_a32*n-_a30*o-_a33*r)*d,e.m10=(_a30*a-_a31*n+_a33*i)*d,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"toArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e[r+0]=t.m00,e[r+1]=t.m01,e[r+2]=t.m02,e[r+3]=t.m03,e[r+4]=t.m04,e[r+5]=t.m05,e[r+6]=t.m06,e[r+7]=t.m07,e[r+8]=t.m08,e[r+9]=t.m09,e[r+10]=t.m10,e[r+11]=t.m11,e[r+12]=t.m12,e[r+13]=t.m13,e[r+14]=t.m14,e[r+15]=t.m15,e}},{key:"fromArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return e.m00=t[r+0],e.m01=t[r+1],e.m02=t[r+2],e.m03=t[r+3],e.m04=t[r+4],e.m05=t[r+5],e.m06=t[r+6],e.m07=t[r+7],e.m08=t[r+8],e.m09=t[r+9],e.m10=t[r+10],e.m11=t[r+11],e.m12=t[r+12],e.m13=t[r+13],e.m14=t[r+14],e.m15=t[r+15],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,r){return e.m00=t.m00+i.m00*r,e.m01=t.m01+i.m01*r,e.m02=t.m02+i.m02*r,e.m03=t.m03+i.m03*r,e.m04=t.m04+i.m04*r,e.m05=t.m05+i.m05*r,e.m06=t.m06+i.m06*r,e.m07=t.m07+i.m07*r,e.m08=t.m08+i.m08*r,e.m09=t.m09+i.m09*r,e.m10=t.m10+i.m10*r,e.m11=t.m11+i.m11*r,e.m12=t.m12+i.m12*r,e.m13=t.m13+i.m13*r,e.m14=t.m14+i.m14*r,e.m15=t.m15+i.m15*r,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:EPSILON;return Math.abs(e.m00-t.m00)<=r*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=r*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=r*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=r*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=r*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=r*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=r*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=r*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=r*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=r*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=r*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=r*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=r*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=r*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=r*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=r*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}}]),_createClass(y,[{key:"clone",value:function(){var e=this;return new y(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"set",value:function(e,t,i,r,n,s,a,o,c,l,u,h,_,p,d,f){var m=0<arguments.length&&void 0!==e?e:1,y=1<arguments.length&&void 0!==t?t:0,v=2<arguments.length&&void 0!==i?i:0,g=3<arguments.length&&void 0!==r?r:0,b=4<arguments.length&&void 0!==n?n:0,x=5<arguments.length&&void 0!==s?s:1,T=6<arguments.length&&void 0!==a?a:0,C=7<arguments.length&&void 0!==o?o:0,S=8<arguments.length&&void 0!==c?c:0,E=9<arguments.length&&void 0!==l?l:0,w=10<arguments.length&&void 0!==u?u:1,A=11<arguments.length&&void 0!==h?h:0,$=12<arguments.length&&void 0!==_?_:0,O=13<arguments.length&&void 0!==p?p:0,D=14<arguments.length&&void 0!==d?d:0,k=15<arguments.length&&void 0!==f?f:1;return"object"===_typeof(m)?(this.m01=m.m01,this.m02=m.m02,this.m03=m.m03,this.m04=m.m04,this.m05=m.m05,this.m06=m.m06,this.m07=m.m07,this.m08=m.m08,this.m09=m.m09,this.m10=m.m10,this.m11=m.m11,this.m12=m.m12,this.m13=m.m13,this.m14=m.m14,this.m15=m.m15,this.m00=m.m00):(this.m01=y,this.m02=v,this.m03=g,this.m04=b,this.m05=x,this.m06=T,this.m07=C,this.m08=S,this.m09=E,this.m10=w,this.m11=A,this.m12=$,this.m13=O,this.m14=D,this.m15=k,this.m00=m),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:EPSILON;return Math.abs(this.m00-e.m00)<=i*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=i*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=i*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=i*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=i*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=i*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=i*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=i*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=i*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=i*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=i*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=i*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=i*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=i*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=i*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=i*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m03,r=this.m06,n=this.m07,s=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=r,this.m11=this.m14,this.m12=i,this.m13=n,this.m14=s,this}},{key:"invert",value:function(){_a00$1=this.m00,_a01$1=this.m01,_a02$1=this.m02,_a03=this.m03,_a10$1=this.m04,_a11$1=this.m05,_a12$1=this.m06,_a13=this.m07,_a20$1=this.m08,_a21$1=this.m09,_a22$1=this.m10,_a23=this.m11,_a30=this.m12,_a31=this.m13,_a32=this.m14,_a33=this.m15;var e=_a00$1*_a11$1-_a01$1*_a10$1,t=_a00$1*_a12$1-_a02$1*_a10$1,i=_a00$1*_a13-_a03*_a10$1,r=_a01$1*_a12$1-_a02$1*_a11$1,n=_a01$1*_a13-_a03*_a11$1,s=_a02$1*_a13-_a03*_a12$1,a=_a20$1*_a31-_a21$1*_a30,o=_a20$1*_a32-_a22$1*_a30,c=_a20$1*_a33-_a23*_a30,l=_a21$1*_a32-_a22$1*_a31,u=_a21$1*_a33-_a23*_a31,h=_a22$1*_a33-_a23*_a32,_=e*h-t*u+i*l+r*c-n*o+s*a;return 0===_?null:(_=1/_,this.m00=(_a11$1*h-_a12$1*u+_a13*l)*_,this.m01=(_a02$1*u-_a01$1*h-_a03*l)*_,this.m02=(_a31*s-_a32*n+_a33*r)*_,this.m03=(_a22$1*n-_a21$1*s-_a23*r)*_,this.m04=(_a12$1*c-_a10$1*h-_a13*o)*_,this.m05=(_a00$1*h-_a02$1*c+_a03*o)*_,this.m06=(_a32*i-_a30*s-_a33*t)*_,this.m07=(_a20$1*s-_a22$1*i+_a23*t)*_,this.m08=(_a10$1*u-_a11$1*c+_a13*a)*_,this.m09=(_a01$1*c-_a00$1*u-_a03*a)*_,this.m10=(_a30*n-_a31*i+_a33*e)*_,this.m11=(_a21$1*i-_a20$1*n-_a23*e)*_,this.m12=(_a11$1*o-_a10$1*l-_a12$1*a)*_,this.m13=(_a00$1*l-_a01$1*o+_a02$1*a)*_,this.m14=(_a31*t-_a30*r-_a32*e)*_,this.m15=(_a20$1*r-_a21$1*t+_a22$1*e)*_,this)}},{key:"determinant",value:function(){return _a00$1=this.m00,_a01$1=this.m01,_a02$1=this.m02,_a03=this.m03,_a10$1=this.m04,_a11$1=this.m05,_a12$1=this.m06,_a13=this.m07,_a20$1=this.m08,_a21$1=this.m09,_a22$1=this.m10,_a23=this.m11,_a30=this.m12,_a31=this.m13,_a32=this.m14,_a33=this.m15,(_a00$1*_a11$1-_a01$1*_a10$1)*(_a22$1*_a33-_a23*_a32)-(_a00$1*_a12$1-_a02$1*_a10$1)*(_a21$1*_a33-_a23*_a31)+(_a00$1*_a13-_a03*_a10$1)*(_a21$1*_a32-_a22$1*_a31)+(_a01$1*_a12$1-_a02$1*_a11$1)*(_a20$1*_a33-_a23*_a30)-(_a01$1*_a13-_a03*_a11$1)*(_a20$1*_a32-_a22$1*_a30)+(_a02$1*_a13-_a03*_a12$1)*(_a20$1*_a31-_a21$1*_a30)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this.m09=this.m09+e.m09,this.m10=this.m10+e.m10,this.m11=this.m11+e.m11,this.m12=this.m12+e.m12,this.m13=this.m13+e.m13,this.m14=this.m14+e.m14,this.m15=this.m15+e.m15,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this.m09=this.m09-e.m09,this.m10=this.m10-e.m10,this.m11=this.m11-e.m11,this.m12=this.m12-e.m12,this.m13=this.m13-e.m13,this.m14=this.m14-e.m14,this.m15=this.m15-e.m15,this}},{key:"multiply",value:function(e){_a00$1=this.m00,_a01$1=this.m01,_a02$1=this.m02,_a03=this.m03,_a10$1=this.m04,_a11$1=this.m05,_a12$1=this.m06,_a13=this.m07,_a20$1=this.m08,_a21$1=this.m09,_a22$1=this.m10,_a23=this.m11,_a30=this.m12,_a31=this.m13,_a32=this.m14,_a33=this.m15;var t=e.m00,i=e.m01,r=e.m02,n=e.m03;return this.m00=t*_a00$1+i*_a10$1+r*_a20$1+n*_a30,this.m01=t*_a01$1+i*_a11$1+r*_a21$1+n*_a31,this.m02=t*_a02$1+i*_a12$1+r*_a22$1+n*_a32,this.m03=t*_a03+i*_a13+r*_a23+n*_a33,t=e.m04,i=e.m05,r=e.m06,n=e.m07,this.m04=t*_a00$1+i*_a10$1+r*_a20$1+n*_a30,this.m05=t*_a01$1+i*_a11$1+r*_a21$1+n*_a31,this.m06=t*_a02$1+i*_a12$1+r*_a22$1+n*_a32,this.m07=t*_a03+i*_a13+r*_a23+n*_a33,t=e.m08,i=e.m09,r=e.m10,n=e.m11,this.m08=t*_a00$1+i*_a10$1+r*_a20$1+n*_a30,this.m09=t*_a01$1+i*_a11$1+r*_a21$1+n*_a31,this.m10=t*_a02$1+i*_a12$1+r*_a22$1+n*_a32,this.m11=t*_a03+i*_a13+r*_a23+n*_a33,t=e.m12,i=e.m13,r=e.m14,n=e.m15,this.m12=t*_a00$1+i*_a10$1+r*_a20$1+n*_a30,this.m13=t*_a01$1+i*_a11$1+r*_a21$1+n*_a31,this.m14=t*_a02$1+i*_a12$1+r*_a22$1+n*_a32,this.m15=t*_a03+i*_a13+r*_a23+n*_a33,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this.m09=this.m09*e,this.m10=this.m10*e,this.m11=this.m11*e,this.m12=this.m12*e,this.m13=this.m13*e,this.m14=this.m14*e,this.m15=this.m15*e,this}},{key:"translate",value:function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.y,this}},{key:"scale",value:function(e){var t=e.x,i=e.y,r=e.z;return this.m00=this.m00*t,this.m01=this.m01*t,this.m02=this.m02*t,this.m03=this.m03*t,this.m04=this.m04*i,this.m05=this.m05*i,this.m06=this.m06*i,this.m07=this.m07*i,this.m08=this.m08*r,this.m09=this.m09*r,this.m10=this.m10*r,this.m11=this.m11*r,this.m12=this.m12,this.m13=this.m13,this.m14=this.m14,this.m15=this.m15,this}},{key:"rotate",value:function(e,t){var i=t.x,r=t.y,n=t.z,s=Math.sqrt(i*i+r*r+n*n);if(Math.abs(s)<EPSILON)return null;i*=s=1/s,r*=s,n*=s;var a=Math.sin(e),o=Math.cos(e),c=1-o;_a00$1=this.m00,_a01$1=this.m01,_a02$1=this.m02,_a03=this.m03,_a10$1=this.m04,_a11$1=this.m05,_a12$1=this.m06,_a13=this.m07,_a20$1=this.m08,_a21$1=this.m09,_a22$1=this.m10,_a23=this.m11;var l=i*i*c+o,u=r*i*c+n*a,h=n*i*c-r*a,_=i*r*c-n*a,p=r*r*c+o,d=n*r*c+i*a,f=i*n*c+r*a,m=r*n*c-i*a,y=n*n*c+o;return this.m00=_a00$1*l+_a10$1*u+_a20$1*h,this.m01=_a01$1*l+_a11$1*u+_a21$1*h,this.m02=_a02$1*l+_a12$1*u+_a22$1*h,this.m03=_a03*l+_a13*u+_a23*h,this.m04=_a00$1*_+_a10$1*p+_a20$1*d,this.m05=_a01$1*_+_a11$1*p+_a21$1*d,this.m06=_a02$1*_+_a12$1*p+_a22$1*d,this.m07=_a03*_+_a13*p+_a23*d,this.m08=_a00$1*f+_a10$1*m+_a20$1*y,this.m09=_a01$1*f+_a11$1*m+_a21$1*y,this.m10=_a02$1*f+_a12$1*m+_a22$1*y,this.m11=_a03*f+_a13*m+_a23*y,this}},{key:"getTranslation",value:function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}},{key:"getScale",value:function(e){var t=m3_1$1.m00=this.m00,i=m3_1$1.m01=this.m01,r=m3_1$1.m02=this.m02,n=m3_1$1.m03=this.m04,s=m3_1$1.m04=this.m05,a=m3_1$1.m05=this.m06,o=m3_1$1.m06=this.m08,c=m3_1$1.m07=this.m09,l=m3_1$1.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+r*r),e.y=Math.sqrt(n*n+s*s+a*a),e.z=Math.sqrt(o*o+c*c+l*l),Mat3.determinant(m3_1$1)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e){var t=this.m00+this.m05+this.m10,i=0;return 0<t?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this.m06-this.m09)/i,e.y=(this.m08-this.m02)/i,e.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/i,e.x=.25*i,e.y=(this.m01+this.m04)/i,e.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/i,e.x=(this.m01+this.m04)/i,e.y=.25*i,e.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/i,e.x=(this.m08+this.m02)/i,e.y=(this.m06+this.m09)/i,e.z=.25*i),e}},{key:"fromRTS",value:function(e,t,i){var r=e.x,n=e.y,s=e.z,a=e.w,o=r+r,c=n+n,l=s+s,u=r*o,h=r*c,_=r*l,p=n*c,d=n*l,f=s*l,m=a*o,y=a*c,v=a*l,g=i.x,b=i.y,x=i.z;return this.m00=(1-(p+f))*g,this.m01=(h+v)*g,this.m02=(_-y)*g,this.m03=0,this.m04=(h-v)*b,this.m05=(1-(u+f))*b,this.m06=(d+m)*b,this.m07=0,this.m08=(_+y)*x,this.m09=(d-m)*x,this.m10=(1-(u+p))*x,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,r=e.z,n=e.w,s=t+t,a=i+i,o=r+r,c=t*s,l=i*s,u=i*a,h=r*s,_=r*a,p=r*o,d=n*s,f=n*a,m=n*o;return this.m00=1-u-p,this.m01=l+m,this.m02=h-f,this.m03=0,this.m04=l-m,this.m05=1-c-p,this.m06=_+d,this.m07=0,this.m08=h+f,this.m09=_-d,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}]),y}();Mat4.IDENTITY=Object.freeze(new Mat4);var v3_1$3=new Vec3,m3_1$1=new Mat3;function mat4(e,t,i,r,n,s,a,o,c,l,u,h,_,p,d,f){return new Mat4(e,t,i,r,n,s,a,o,c,l,u,h,_,p,d,f)}CCClass.fastDefine("cc.Mat4",Mat4,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),cc.Mat4=Mat4,cc.mat4=mat4;var _a=0,_b=0,_c=0,_d=0,_tx=0,_ty=0,AffineTransform=function(){function a(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0;_classCallCheck(this,a),this.a=void 0,this.b=void 0,this.c=void 0,this.d=void 0,this.tx=void 0,this.ty=void 0,this.a=e,this.b=t,this.c=i,this.d=r,this.tx=n,this.ty=s}return _createClass(a,null,[{key:"identity",value:function(){return new a}},{key:"clone",value:function(e){return new a(e.a,e.b,e.c,e.d,e.tx,e.ty)}},{key:"concat",value:function(e,t,i){_a=t.a,_b=t.b,_c=t.c,_d=t.d,_tx=t.tx,_ty=t.ty,e.a=_a*i.a+_b*i.c,e.b=_a*i.b+_b*i.d,e.c=_c*i.a+_d*i.c,e.d=_c*i.b+_d*i.d,e.tx=_tx*i.a+_ty*i.c+i.tx,e.ty=_tx*i.b+_ty*i.d+i.ty}},{key:"invert",value:function(e,t){var i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}},{key:"fromMat4",value:function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}},{key:"transformVec2",value:function(e,t,i,r){var n,s;s=void 0===r?(r=i,n=t.x,t.y):(n=t,i),e.x=r.a*n+r.c*s+r.tx,e.y=r.b*n+r.d*s+r.ty}},{key:"transformSize",value:function(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}},{key:"transformRect",value:function(e,t,i){var r=t.x+t.width,n=t.y+t.height,s=i.a*t.x+i.c*t.y+i.tx,a=i.b*t.x+i.d*t.y+i.ty,o=i.a*r+i.c*t.y+i.tx,c=i.b*r+i.d*t.y+i.ty,l=i.a*t.x+i.c*n+i.tx,u=i.b*t.x+i.d*n+i.ty,h=i.a*r+i.c*n+i.tx,_=i.b*r+i.d*n+i.ty,p=Math.min(s,o,l,h),d=Math.max(s,o,l,h),f=Math.min(a,c,u,_),m=Math.max(a,c,u,_);e.x=p,e.y=f,e.width=d-p,e.height=m-f}},{key:"transformObb",value:function(e,t,i,r,n,s){var a=s.a*n.x+s.c*n.y+s.tx,o=s.b*n.x+s.d*n.y+s.ty,c=s.a*n.width,l=s.b*n.width,u=s.c*n.height,h=s.d*n.height;t.x=a,t.y=o,i.x=c+a,i.y=l+o,e.x=u+a,e.y=h+o,r.x=c+u+a,r.y=l+h+o}}]),a}();cc.AffineTransform=AffineTransform;var Size=function(){function r(e,t){var i;return _classCallCheck(this,r),(i=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this))).width=void 0,i.height=void 0,e&&"object"===_typeof(e)?(i.height=e.height,i.width=e.width):(i.width=e||0,i.height=t||0),i}return _inherits(r,ValueType),_createClass(r,[{key:"x",set:function(e){this.width=e},get:function(){return this.width}},{key:"y",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"lerp",value:function(e,t,i,r){return e.width=t.width+(i.width-t.width)*r,e.height=t.height+(i.height-t.height)*r,e}},{key:"ZERO",get:function(){return new r(0,0)}}]),_createClass(r,[{key:"clone",value:function(){return new r(this.width,this.height)}},{key:"set",value:function(e,t){return e&&"object"===_typeof(e)?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return this.width=this.width+(e.width-this.width)*t,this.height=this.height+(e.height-this.height)*t,this}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}]),r}();function size(){return new Size(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0)}CCClass.fastDefine("cc.Size",Size,{width:0,height:0}),cc.size=size,cc.Size=Size;var _x$4=0,_y$4=0,_w$2=0,_h=0,Rect=function(){function s(e,t,i,r){var n;return _classCallCheck(this,s),(n=_possibleConstructorReturn(this,_getPrototypeOf(s).call(this))).x=void 0,n.y=void 0,n.width=void 0,n.height=void 0,e&&"object"===_typeof(e)?(n.y=e.y,n.width=e.width,n.height=e.height,n.x=e.x):(n.x=e||0,n.y=t||0,n.width=i||0,n.height=r||0),n}return _inherits(s,ValueType),_createClass(s,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Vec2(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new cc.Vec2(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new Size(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",set:function(e){this.width=e},get:function(){return this.width}},{key:"w",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"fromMinMax",value:function(e,t,i){var r=Math.min(t.x,i.x),n=Math.min(t.y,i.y),s=Math.max(t.x,i.x),a=Math.max(t.y,i.y);return e.x=r,e.y=n,e.width=s-r,e.height=a-n,e}},{key:"lerp",value:function(e,t,i,r){return _x$4=t.x,_y$4=t.y,_w$2=t.width,_h=t.height,e.x=_x$4+(i.x-_x$4)*r,e.y=_y$4+(i.y-_y$4)*r,e.width=_w$2+(i.width-_w$2)*r,e.height=_h+(i.height-_h)*r,e}},{key:"intersection",value:function(e,t,i){var r=t.x,n=t.y,s=t.x+t.width,a=t.y+t.height,o=i.x,c=i.y,l=i.x+i.width,u=i.y+i.height;return e.x=Math.max(r,o),e.y=Math.max(n,c),e.width=Math.min(s,l)-e.x,e.height=Math.min(a,u)-e.y,e}},{key:"union",value:function(e,t,i){_x$4=t.x,_y$4=t.y,_w$2=t.width,_h=t.height;var r=i.x,n=i.y,s=i.width,a=i.height;return e.x=Math.min(_x$4,r),e.y=Math.min(_y$4,n),e.width=Math.max(_x$4+_w$2,r+s)-e.x,e.height=Math.max(_y$4+_h,n+a)-e.y,e}}]),_createClass(s,[{key:"clone",value:function(){return new s(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e,t,i,r){return e&&"object"===_typeof(e)?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=r||0),this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return _x$4=this.x,_y$4=this.y,_w$2=this.width,_h=this.height,this.x=_x$4+(e.x-_x$4)*t,this.y=_y$4+(e.y-_y$4)*t,this.width=_w$2+(e.width-_w$2)*t,this.height=_h+(e.height-_h)*t,this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,i=this.y+this.height,r=e.x+e.width,n=e.y+e.height;return!(t<e.x||r<this.x||i<e.y||n<this.y)}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,r=t+this.width,n=i+this.height,s=e.m00*t+e.m04*i+e.m12,a=e.m01*t+e.m05*i+e.m13,o=e.m00*r+e.m04*i+e.m12,c=e.m01*r+e.m05*i+e.m13,l=e.m00*t+e.m04*n+e.m12,u=e.m01*t+e.m05*n+e.m13,h=e.m00*r+e.m04*n+e.m12,_=e.m01*r+e.m05*n+e.m13,p=Math.min(s,o,l,h),d=Math.max(s,o,l,h),f=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=p,this.y=f,this.width=d-p,this.height=m-f,this}}]),s}();function rect(){return new Rect(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:0)}CCClass.fastDefine("cc.Rect",Rect,{x:0,y:0,width:0,height:0}),cc.Rect=Rect,cc.rect=rect;var toFloat=1/255,_r=0,_g=0,_b$1=0,_a$1=0,Color=function(){function s(e,t,i,r){var n;return _classCallCheck(this,s),(n=_possibleConstructorReturn(this,_getPrototypeOf(s).call(this)))._val=0,"string"==typeof e?n.fromHEX(e):("object"===_typeof(e)&&(t=e.g,i=e.b,r=e.a,e=e.r),e=e||0,t=t||0,i=i||0,r="number"==typeof r?r:255,n._val=(r<<24>>>0)+(i<<16)+(t<<8)+e),n}return _inherits(s,ValueType),_createClass(s,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~clamp(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~clamp(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~clamp(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~clamp(e,0,255),this._val=(16777215&this._val|e<<24>>>0)>>>0}},{key:"x",get:function(){return this.r*toFloat},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*toFloat},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*toFloat},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*toFloat},set:function(e){this.a=255*e}}],[{key:"clone",value:function(e){var t=new s;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,i,r,n){return e.r=t,e.g=i,e.b=r,e.a=n,e}},{key:"fromHex",value:function(e,t){return e.r=(t>>24)/255,e.g=(t>>16&255)/255,e.b=(t>>8&255)/255,e.a=(255&t)/255,e}},{key:"add",value:function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}},{key:"subtract",value:function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}},{key:"multiply",value:function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}},{key:"divide",value:function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}},{key:"scale",value:function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}},{key:"lerp",value:function(e,t,i,r){return _r=t.r,_g=t.g,_b$1=t.b,_a$1=t.a,_r+=(i.r-_r)*r,_g+=(i.g-_g)*r,_b$1+=(i.b-_b$1)*r,_a$1+=(i.a-_a$1)*r,e._val=Math.floor((_a$1<<24>>>0)+(_b$1<<16)+(_g<<8)+_r),e}},{key:"toArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0,n=t instanceof s||1<t.a?1/255:1;return e[r+0]=t.r*n,e[r+1]=t.g*n,e[r+2]=t.b*n,e[r+3]=t.a*n,e}},{key:"fromArray",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:0;return t.r=255*e[r+0],t.g=255*e[r+1],t.b=255*e[r+2],t.a=255*e[r+3],t}},{key:"strictEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:EPSILON;return Math.abs(e.r-t.r)<=r*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=r*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=r*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=r*Math.max(1,Math.abs(e.a),Math.abs(t.a))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),_createClass(s,[{key:"clone",value:function(){var e=new s;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerp",value:function(e,t){return _r=this.r,_g=this.g,_b$1=this.b,_a$1=this.a,_r+=(e.r-_r)*t,_g+=(e.g-_g)*t,_b$1+=(e.b-_b$1)*t,_a$1+=(e.a-_a$1)*t,this._val=Math.floor((_a$1<<24>>>0)+(_b$1<<16)+(_g<<8)+_r),this}},{key:"toString",value:function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"}},{key:"toCSS",value:function(e){return"rgba"===e?"rgba("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+","+(this.a*toFloat).toFixed(2)+")":"rgb"===e?"rgb("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+")":"#"+this.toHEX(e)}},{key:"fromHEX",value:function(e){return e=0===e.indexOf("#")?e.substring(1):e,_r=parseInt(e.substr(0,2),16)||0,_g=parseInt(e.substr(2,2),16)||0,_b$1=parseInt(e.substr(4,2),16)||0,_a$1=parseInt(e.substr(6,2),16)||255,this._val=(_a$1<<24>>>0)+(_b$1<<16)+(_g<<8)+_r,this}},{key:"toHEX",value:function(e){var t=[(0|this.r).toString(16),(0|this.g).toString(16),(0|this.b).toString(16)],i=-1;if("#rrggbb"===e)for(i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);else if("#rrggbbaa"===e)for(t.push((0|this.a).toString(16)),i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);return t.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,i){if((_b$1=_g=_r=0)===t)_r=_g=_b$1=i;else if(0===i)_r=_g=_b$1=0;else{1===e&&(e=0),e*=6,t=t,i=i;var r=Math.floor(e),n=e-r,s=i*(1-t),a=i*(1-t*n),o=i*(1-t*(1-n));switch(r){case 0:_r=i,_g=o,_b$1=s;break;case 1:_r=a,_g=i,_b$1=s;break;case 2:_r=s,_g=i,_b$1=o;break;case 3:_r=s,_g=a,_b$1=i;break;case 4:_r=o,_g=s,_b$1=i;break;case 5:_r=i,_g=s,_b$1=a}}return _r*=255,_g*=255,_b$1*=255,this._val=(this.a<<24>>>0)+(_b$1<<16)+(_g<<8)+_r,this}},{key:"toHSV",value:function(){_r=this.r*toFloat,_g=this.g*toFloat,_b$1=this.b*toFloat;var e={h:0,s:0,v:0},t=Math.max(_r,_g,_b$1),i=Math.min(_r,_g,_b$1),r=0;return e.v=t,e.s=t?(t-i)/t:0,e.s?(r=t-i,e.h=_r===t?(_g-_b$1)/r:_g===t?2+(_b$1-_r)/r:4+(_r-_g)/r,e.h/=6,e.h<0&&(e.h+=1)):e.h=0,e}},{key:"set",value:function(e,t,i,r){return"object"===_typeof(e)&&(t=e.g,i=e.b,r=e.a,e=e.r),e=e||0,t=t||0,i=i||0,r="number"==typeof r?r:255,this._val=(r<<24>>>0)+(i<<16)+(t<<8)+e,this}},{key:"multiply",value:function(e){return _r=(255&this._val)*e.r>>8,_g=(65280&this._val)*e.g>>8,_b$1=(16711680&this._val)*e.b>>8,_a$1=((4278190080&this._val)>>>8)*e.a,this._val=4278190080&_a$1|16711680&_b$1|65280&_g|255&_r,this}},{key:"_set_r_unsafe",value:function(e){return this._val=(4294967040&this._val|e)>>>0,this}},{key:"_set_g_unsafe",value:function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}},{key:"_set_b_unsafe",value:function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}},{key:"_set_a_unsafe",value:function(e){return this._val=(16777215&this._val|e<<24>>>0)>>>0,this}}]),s}();function color(e,t,i,r){return new Color(e,t,i,r)}Color.WHITE=Object.freeze(new Color(255,255,255,255)),Color.GRAY=Object.freeze(new Color(127,127,127,255)),Color.BLACK=Object.freeze(new Color(0,0,0,255)),Color.TRANSPARENT=Object.freeze(new Color(0,0,0,0)),Color.RED=Object.freeze(new Color(255,0,0,255)),Color.GREEN=Object.freeze(new Color(0,255,0,255)),Color.BLUE=Object.freeze(new Color(0,0,255,255)),Color.CYAN=Object.freeze(new Color(0,255,255,255)),Color.MAGENTA=Object.freeze(new Color(255,0,255,255)),Color.YELLOW=Object.freeze(new Color(255,255,0,255)),CCClass.fastDefine("cc.Color",Color,{r:0,g:0,b:0,a:255}),cc.Color=Color,cc.color=color;var replacePropertyLog,markAsWarningLog,removePropertyLog,defaultLogTimes=10;function setDefaultLogTimes(e){0<e&&(defaultLogTimes=e)}var messageID=0,messageMap=new Map;replacePropertyLog=function(e,t,i,r,n,s){var a=messageMap.get(s);a&&a.logTimes>a.count&&(n("'%s' is deprecated, please use '%s' instead.","".concat(e,".").concat(t),"".concat(i,".").concat(r)),a.count++)},exports.replaceProperty=function(o,c,e){null!=o&&e.forEach(function(t){var i=messageID++;messageMap.set(i,{id:i,count:0,logTimes:void 0!==t.logTimes?t.logTimes:defaultLogTimes});var r=null!=t.target?t.target:o,n=null!=t.newName?t.newName:t.name,s=null!=t.targetName?t.targetName:c;if(null!=t.customFunction)o[t.name]=function(){return replacePropertyLog(c,t.name,s,n,warn,i),t.customFunction.call(this,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3],arguments.length<=4?void 0:arguments[4],arguments.length<=5?void 0:arguments[5],arguments.length<=6?void 0:arguments[6],arguments.length<=7?void 0:arguments[7],arguments.length<=8?void 0:arguments[8],arguments.length<=9?void 0:arguments[9],arguments.length<=10?void 0:arguments[10],arguments.length<=11?void 0:arguments[11])};else if(null!=t.customSetter||null!=t.customGetter){var e=null!=t.customSetter,a=null!=t.customGetter;e&&a?Object.defineProperty(o,t.name,{get:function(){return replacePropertyLog(c,t.name,s,n,warn,i),t.customGetter.call(this)},set:function(e){replacePropertyLog(c,t.name,s,n,warn,i),t.customSetter.call(this,e)}}):e?Object.defineProperty(o,t.name,{set:function(e){replacePropertyLog(c,t.name,s,n,warn,i),t.customSetter.call(this,e)}}):a&&Object.defineProperty(o,t.name,{get:function(){return replacePropertyLog(c,t.name,s,n,warn,i),t.customGetter.call(this)}})}else Object.defineProperty(o,t.name,{get:function(){return replacePropertyLog(c,t.name,s,n,warn,i),r[n]},set:function(e){replacePropertyLog(c,t.name,s,n,warn,i),r[n]=e}})})},removePropertyLog=function(e,t,i,r){var n=messageMap.get(r);n&&n.logTimes>n.count&&(i("'%s' has been removed.","".concat(e,".").concat(t)),n.count++)},exports.removeProperty=function(i,r,e){null!=i&&e.forEach(function(e){var t=messageID++;messageMap.set(t,{id:t,count:0,logTimes:void 0!==e.logTimes?e.logTimes:defaultLogTimes}),Object.defineProperty(i,e.name,{get:function(){return removePropertyLog(r,e.name,error,t)},set:function(){removePropertyLog(r,e.name,error,t)}})})},markAsWarningLog=function(e,t,i,r){var n=messageMap.get(r);n&&n.logTimes>n.count&&(i("'%s' is deprecated.","".concat(e,".").concat(t)),n.count++)},exports.markAsWarning=function(s,a,e){if(null!=s){var o=function(e,t,i,r,n,s,a){if(i.get){var o=i.get();i.get=function(){return markAsWarningLog(r,n,s,a),o.call(this)}}if(i.set){var c=Object.create(i.set);i.set=function(e){markAsWarningLog(r,n,s,a),c.call(this,e)}}};e.forEach(function(e){var t=e.name,i=Object.getOwnPropertyDescriptor(s,t);if(i){var r=messageID++;if(messageMap.set(r,{id:r,count:0,logTimes:void 0!==e.logTimes?e.logTimes:defaultLogTimes}),null!=i.value)if("function"==typeof i.value){var n=i.value;s[t]=function(){return markAsWarningLog(a,t,warn,r),n.call(this)}}else o(0,0,i,a,t,warn,r);else o(0,0,i,a,t,warn,r)}})}},exports.replaceProperty(Vec2,"Vec2",[{name:"sub",newName:"subtract",target:Vec2,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Vec2,targetName:"Vec2"},{name:"div",newName:"divide",target:Vec2,targetName:"Vec2"},{name:"dist",newName:"distance",target:Vec2,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Vec2,targetName:"Vec2"},{name:"mag",newName:"len",target:Vec2,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Vec2,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Vec2,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Vec2,targetName:"Vec2"}]),exports.replaceProperty(Vec2.prototype,"Vec2",[{name:"mag",newName:"length",target:Vec2.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Vec2.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Vec2.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Vec2.prototype,targetName:"Vec2"}]),exports.removeProperty(Vec2.prototype,"vmath",[{name:"divide"}]),exports.replaceProperty(Vec3,"Vec3",[{name:"sub",newName:"subtract",target:Vec3,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Vec3,targetName:"Vec3"},{name:"div",newName:"divide",target:Vec3,targetName:"Vec3"},{name:"dist",newName:"distance",target:Vec3,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Vec3,targetName:"Vec3"},{name:"mag",newName:"len",target:Vec3,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Vec3,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Vec3,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Vec3,targetName:"Vec3"}]),exports.replaceProperty(Vec3.prototype,"Vec3",[{name:"mag",newName:"length",target:Vec3.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Vec3.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Vec3.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Vec3.prototype,targetName:"Vec3"}]),exports.removeProperty(Vec3.prototype,"vmath",[{name:"divide"}]),exports.replaceProperty(Vec4,"Vec4",[{name:"sub",newName:"subtract",target:Vec4,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Vec4,targetName:"Vec4"},{name:"div",newName:"divide",target:Vec4,targetName:"Vec4"},{name:"dist",newName:"distance",target:Vec4,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Vec4,targetName:"Vec4"},{name:"mag",newName:"len",target:Vec4,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Vec4,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Vec4,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Vec4,targetName:"Vec4"}]),exports.replaceProperty(Vec4.prototype,"Vec4",[{name:"mag",newName:"length",target:Vec4.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Vec4.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Vec4.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Vec4.prototype,targetName:"Vec4"}]),exports.removeProperty(Vec4.prototype,"vmath",[{name:"divide"}]),exports.replaceProperty(Quat,"Quat",[{name:"mag",newName:"len",target:Quat,targetName:"Quat"},{name:"mul",newName:"multiply",target:Quat,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Quat,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Quat,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Quat,targetName:"Quat"}]),exports.replaceProperty(Quat.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Quat.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Quat.prototype,targetName:"Quat"}]),exports.replaceProperty(Color,"Color",[{name:"sub",newName:"subtract",target:Color,targetName:"Color"},{name:"mul",newName:"multiply",target:Color,targetName:"Color"},{name:"div",newName:"divide",target:Color,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:Color,targetName:"Color"}]),exports.replaceProperty(Mat3,"Mat3",[{name:"sub",newName:"subtract",target:Mat3,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Mat3,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Mat3,targetName:"Mat3"}]),exports.replaceProperty(Mat3.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Mat3.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Mat3.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Mat3.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Mat3.prototype,targetName:"Mat3"}]),exports.replaceProperty(Mat4,"Mat4",[{name:"sub",newName:"subtract",target:Mat4,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Mat4,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Mat4,targetName:"Mat4"}]),exports.replaceProperty(Mat4.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Mat4.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Mat4.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Mat4.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Mat4.prototype,targetName:"Mat4"}]);var math=Object.freeze({bits:bits,Vec2:Vec2,v2:v2,Vec3:Vec3,v3:v3,Vec4:Vec4,v4:v4,Quat:Quat,quat:quat,Mat3:Mat3,Mat4:Mat4,mat4:mat4,AffineTransform:AffineTransform,Size:Size,size:size,Rect:Rect,rect:rect,Color:Color,color:color,EPSILON:EPSILON,equals:equals,approx:approx,clamp:clamp,clamp01:clamp01,lerp:lerp,toRadian:toRadian,toDegree:toDegree,random:random,randomRange:randomRange,randomRangeInt:randomRangeInt,pseudoRandom:pseudoRandom,pseudoRandomRange:pseudoRandomRange,pseudoRandomRangeInt:pseudoRandomRangeInt,nextPow2:nextPow2$1,repeat:repeat,pingPong:pingPong,inverseLerp:inverseLerp}),enums={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256},X=new Vec3,Y=new Vec3,Z=new Vec3,d=new Vec3,min$1=new Vec3,max$1=new Vec3,u=new Array(3),e=new Array(3);function point_plane(e,t){return Vec3.dot(t.n,e)-t.d}function pt_point_plane(e,t,i){var r=point_plane(t,i);return Vec3.subtract(e,t,Vec3.multiplyScalar(e,i.n,r))}function pt_point_aabb(e,t,i){return Vec3.copy(e,t),Vec3.subtract(min$1,i.center,i.halfExtents),Vec3.add(max$1,i.center,i.halfExtents),e.x=e.x<min$1.x?min$1.x:e.x,e.y=e.y<min$1.x?min$1.y:e.y,e.z=e.z<min$1.x?min$1.z:e.z,e.x=e.x>max$1.x?max$1.x:e.x,e.y=e.y>max$1.x?max$1.y:e.y,e.z=e.z>max$1.x?max$1.z:e.z,e}function pt_point_obb(t,i,r){Vec3.set(X,r.orientation.m00,r.orientation.m01,r.orientation.m02),Vec3.set(Y,r.orientation.m03,r.orientation.m04,r.orientation.m05),Vec3.set(Z,r.orientation.m06,r.orientation.m07,r.orientation.m08),u[0]=X,u[1]=Y,u[2]=Z,e[0]=r.halfExtents.x,e[1]=r.halfExtents.y,e[2]=r.halfExtents.z,Vec3.subtract(d,i,r.center),Vec3.set(t,r.center.x,r.center.y,r.center.z);for(var n=0;n<3;n++){var s=Vec3.dot(d,u[n]);s>e[n]&&(s=e[n]),s<-e[n]&&(s=-e[n]),t.x+=s*u[n].x,t.y+=s*u[n].y,t.z+=s*u[n].z}return t}var distance=Object.freeze({point_plane:point_plane,pt_point_plane:pt_point_plane,pt_point_aabb:pt_point_aabb,pt_point_obb:pt_point_obb}),ray=function(){function a(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;_classCallCheck(this,a),this.o=void 0,this.d=void 0,this._type=void 0,this._type=enums.SHAPE_RAY,this.o=new Vec3(e,t,i),this.d=new Vec3(r,n,s)}return _createClass(a,null,[{key:"create",value:function(e,t,i,r,n,s){return new a(0<arguments.length&&void 0!==e?e:0,1<arguments.length&&void 0!==t?t:0,2<arguments.length&&void 0!==i?i:0,3<arguments.length&&void 0!==r?r:0,4<arguments.length&&void 0!==n?n:0,5<arguments.length&&void 0!==s?s:1)}},{key:"clone",value:function(e){return new a(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)}},{key:"copy",value:function(e,t){return Vec3.copy(e.o,t.o),Vec3.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,i){return Vec3.copy(e.o,t),Vec3.normalize(e.d,Vec3.subtract(e.d,i,t)),e}},{key:"set",value:function(e,t,i,r,n,s,a){return e.o.x=t,e.o.y=i,e.o.z=r,e.d.x=n,e.d.y=s,e.d.z=a,e}}]),_createClass(a,[{key:"computeHit",value:function(e,t){Vec3.normalize(e,this.d),Vec3.scaleAndAdd(e,this.o,e,t)}}]),a}(),ray_plane=function(){var n=new Vec3(0,0,0);return function(e,t){var i=Vec3.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;Vec3.multiplyScalar(n,t.n,t.d);var r=Vec3.dot(Vec3.subtract(n,n,e.o),t.n)/i;return r<0?0:r}}(),ray_triangle=function(){var c=new Vec3(0,0,0),l=new Vec3(0,0,0),u=new Vec3(0,0,0),h=new Vec3(0,0,0),_=new Vec3(0,0,0);return function(e,t,i){Vec3.subtract(c,t.b,t.a),Vec3.subtract(l,t.c,t.a),Vec3.cross(u,e.d,l);var r=Vec3.dot(c,u);if(r<Number.EPSILON&&(!i||r>-Number.EPSILON))return 0;var n=1/r;Vec3.subtract(h,e.o,t.a);var s=Vec3.dot(h,u)*n;if(s<0||1<s)return 0;Vec3.cross(_,h,c);var a=Vec3.dot(e.d,_)*n;if(a<0||1<s+a)return 0;var o=Vec3.dot(l,_)*n;return o<0?0:o}}(),ray_sphere=function(){var _=new Vec3(0,0,0);return function(e,t){var i=t.radius,r=t.center,n=e.o,s=e.d,a=i*i;Vec3.subtract(_,r,n);var o=_.lengthSqr(),c=Vec3.dot(_,s),l=a-(o-c*c);if(l<0)return 0;var u=Math.sqrt(l),h=o<a?c+u:c-u;return h<0?0:h}}(),ray_aabb=function(){var f=new Vec3,m=new Vec3;return function(e,t){var i=e.o,r=e.d,n=1/r.x,s=1/r.y,a=1/r.z;Vec3.subtract(f,t.center,t.halfExtents),Vec3.add(m,t.center,t.halfExtents);var o=(f.x-i.x)*n,c=(m.x-i.x)*n,l=(f.y-i.y)*s,u=(m.y-i.y)*s,h=(f.z-i.z)*a,_=(m.z-i.z)*a,p=Math.max(Math.max(Math.min(o,c),Math.min(l,u)),Math.min(h,_)),d=Math.min(Math.min(Math.max(o,c),Math.max(l,u)),Math.max(h,_));return d<0||d<p?0:p}}(),ray_obb=function(){var s=new Vec3,a=new Vec3,o=new Vec3,c=new Vec3,l=new Vec3,u=new Vec3,h=new Vec3,_=new Array(3),p=new Array(3),d=new Array(3),f=new Array(6);return function(e,t){_[0]=t.halfExtents.x,_[1]=t.halfExtents.y,_[2]=t.halfExtents.z,s=t.center,a=e.o,o=e.d,Vec3.set(c,t.orientation.m00,t.orientation.m01,t.orientation.m02),Vec3.set(l,t.orientation.m03,t.orientation.m04,t.orientation.m05),Vec3.set(u,t.orientation.m06,t.orientation.m07,t.orientation.m08),Vec3.subtract(h,s,a),p[0]=Vec3.dot(c,o),p[1]=Vec3.dot(l,o),p[2]=Vec3.dot(u,o),d[0]=Vec3.dot(c,h),d[1]=Vec3.dot(l,h),d[2]=Vec3.dot(u,h);for(var i=0;i<3;++i){if(0===p[i]){if(0<-d[i]-_[i]||-d[i]+_[i]<0)return 0;p[i]=1e-7}f[2*i+0]=(d[i]+_[i])/p[i],f[2*i+1]=(d[i]-_[i])/p[i]}var r=Math.max(Math.max(Math.min(f[0],f[1]),Math.min(f[2],f[3])),Math.min(f[4],f[5])),n=Math.min(Math.min(Math.max(f[0],f[1]),Math.max(f[2],f[3])),Math.max(f[4],f[5]));return n<0||n<r||r<0?0:r}}(),line_plane=function(){var r=new Vec3(0,0,0);return function(e,t){Vec3.subtract(r,e.e,e.s);var i=(t.d-Vec3.dot(e.s,t.n))/Vec3.dot(r,t.n);return i<0||1<i?0:i}}(),line_triangle=function(){var l=new Vec3(0,0,0),u=new Vec3(0,0,0),h=new Vec3(0,0,0),_=new Vec3(0,0,0),p=new Vec3(0,0,0),d=new Vec3(0,0,0);return function(e,t,i){Vec3.subtract(l,t.b,t.a),Vec3.subtract(u,t.c,t.a),Vec3.subtract(h,e.s,e.e),Vec3.cross(p,l,u);var r=Vec3.dot(h,p);if(r<=0)return 0;Vec3.subtract(_,e.s,t.a);var n=Vec3.dot(_,p);if(n<0||r<n)return 0;Vec3.cross(d,h,_);var s=Vec3.dot(u,d);if(s<0||r<s)return 0;var a=-Vec3.dot(l,d);if(a<0||r<s+a)return 0;if(i){var o=1/r,c=1-(s*=o)-(a*=o);Vec3.set(i,t.a.x*c+t.b.x*s+t.c.x*a,t.a.y*c+t.b.y*s+t.c.y*a,t.a.z*c+t.b.z*s+t.c.z*a)}return 1}}(),r_t=new ray;function line_aabb(e,t){r_t.o.set(e.s),Vec3.subtract(r_t.d,e.e,e.s),r_t.d.normalize();var i=ray_aabb(r_t,t);return i<=e.length()?i:0}function line_obb(e,t){r_t.o.set(e.s),Vec3.subtract(r_t.d,e.e,e.s),r_t.d.normalize();var i=ray_obb(r_t,t);return i<=e.length()?i:0}function line_sphere(e,t){r_t.o.set(e.s),Vec3.subtract(r_t.d,e.e,e.s),r_t.d.normalize();var i=ray_sphere(r_t,t);return i<=e.length()?i:0}var aabb_aabb=function(){var i=new Vec3,r=new Vec3,n=new Vec3,s=new Vec3;return function(e,t){return Vec3.subtract(i,e.center,e.halfExtents),Vec3.add(r,e.center,e.halfExtents),Vec3.subtract(n,t.center,t.halfExtents),Vec3.add(s,t.center,t.halfExtents),i.x<=s.x&&r.x>=n.x&&i.y<=s.y&&r.y>=n.y&&i.z<=s.z&&r.z>=n.z}}();function getAABBVertices(e,t,i){Vec3.set(i[0],e.x,t.y,t.z),Vec3.set(i[1],e.x,t.y,e.z),Vec3.set(i[2],e.x,e.y,t.z),Vec3.set(i[3],e.x,e.y,e.z),Vec3.set(i[4],t.x,t.y,t.z),Vec3.set(i[5],t.x,t.y,e.z),Vec3.set(i[6],t.x,e.y,t.z),Vec3.set(i[7],t.x,e.y,e.z)}function getOBBVertices(e,t,i,r,n,s){Vec3.set(s[0],e.x+i.x*t.x+r.x*t.y+n.x*t.z,e.y+i.y*t.x+r.y*t.y+n.y*t.z,e.z+i.z*t.x+r.z*t.y+n.z*t.z),Vec3.set(s[1],e.x-i.x*t.x+r.x*t.y+n.x*t.z,e.y-i.y*t.x+r.y*t.y+n.y*t.z,e.z-i.z*t.x+r.z*t.y+n.z*t.z),Vec3.set(s[2],e.x+i.x*t.x-r.x*t.y+n.x*t.z,e.y+i.y*t.x-r.y*t.y+n.y*t.z,e.z+i.z*t.x-r.z*t.y+n.z*t.z),Vec3.set(s[3],e.x+i.x*t.x+r.x*t.y-n.x*t.z,e.y+i.y*t.x+r.y*t.y-n.y*t.z,e.z+i.z*t.x+r.z*t.y-n.z*t.z),Vec3.set(s[4],e.x-i.x*t.x-r.x*t.y-n.x*t.z,e.y-i.y*t.x-r.y*t.y-n.y*t.z,e.z-i.z*t.x-r.z*t.y-n.z*t.z),Vec3.set(s[5],e.x+i.x*t.x-r.x*t.y-n.x*t.z,e.y+i.y*t.x-r.y*t.y-n.y*t.z,e.z+i.z*t.x-r.z*t.y-n.z*t.z),Vec3.set(s[6],e.x-i.x*t.x+r.x*t.y-n.x*t.z,e.y-i.y*t.x+r.y*t.y-n.y*t.z,e.z-i.z*t.x+r.z*t.y-n.z*t.z),Vec3.set(s[7],e.x-i.x*t.x-r.x*t.y+n.x*t.z,e.y-i.y*t.x-r.y*t.y+n.y*t.z,e.z-i.z*t.x-r.z*t.y+n.z*t.z)}function getInterval(e,t){for(var i=Vec3.dot(t,e[0]),r=i,n=1;n<8;++n){var s=Vec3.dot(t,e[n]);i=s<i?s:i,r=r<s?s:r}return[i,r]}var aabb_obb=function(){for(var a=new Array(15),e=0;e<15;e++)a[e]=new Vec3(0,0,0);for(var o=new Array(8),c=new Array(8),t=0;t<8;t++)o[t]=new Vec3(0,0,0),c[t]=new Vec3(0,0,0);var l=new Vec3,u=new Vec3;return function(e,t){Vec3.set(a[0],1,0,0),Vec3.set(a[1],0,1,0),Vec3.set(a[2],0,0,1),Vec3.set(a[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Vec3.set(a[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Vec3.set(a[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Vec3.cross(a[6+3*i+0],a[i],a[0]),Vec3.cross(a[6+3*i+1],a[i],a[1]),Vec3.cross(a[6+3*i+1],a[i],a[2]);Vec3.subtract(l,e.center,e.halfExtents),Vec3.add(u,e.center,e.halfExtents),getAABBVertices(l,u,o),getOBBVertices(t.center,t.halfExtents,a[3],a[4],a[5],c);for(var r=0;r<15;++r){var n=getInterval(o,a[r]),s=getInterval(c,a[r]);if(s[0]>n[1]||n[0]>s[1])return 0}return 1}}(),aabb_plane=function(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),r=Vec3.dot(t.n,e.center);return r+i<t.d?-1:r-i>t.d?0:1},aabb_frustum=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===aabb_plane(e,t.planes[i]))return 0;return 1},aabb_frustum_accurate=function(){for(var l=new Array(8),u=0,h=0,e=0;e<l.length;e++)l[e]=new Vec3(0,0,0);return function(e,t){for(var i=0,r=!1,n=0;n<t.planes.length;n++){if(-1===(i=aabb_plane(e,t.planes[n])))return 0;1===i&&(r=!0)}if(!r)return 1;for(var s=0;s<t.vertices.length;s++)Vec3.subtract(l[s],t.vertices[s],e.center);for(var a=h=u=0;a<t.vertices.length;a++)l[a].x>e.halfExtents.x?u++:l[a].x<-e.halfExtents.x&&h++;if(u===t.vertices.length||h===t.vertices.length)return 0;for(var o=h=u=0;o<t.vertices.length;o++)l[o].y>e.halfExtents.y?u++:l[o].y<-e.halfExtents.y&&h++;if(u===t.vertices.length||h===t.vertices.length)return 0;for(var c=h=u=0;c<t.vertices.length;c++)l[c].z>e.halfExtents.z?u++:l[c].z<-e.halfExtents.z&&h++;return u===t.vertices.length||h===t.vertices.length?0:1}}(),obb_point=function(){var i=new Vec3(0,0,0),r=new Mat3;return function(e,t){return Vec3.subtract(i,t,e.center),Vec3.transformMat3(i,i,Mat3.transpose(r,e.orientation)),function(e,t){return Math.abs(e.x)<t.x&&Math.abs(e.y)<t.y&&Math.abs(e.z)<t.z}(i,e.halfExtents)}}(),obb_plane=function(){function n(e,t,i,r){return Math.abs(e.x*t+e.y*i+e.z*r)}return function(e,t){var i=e.halfExtents.x*n(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*n(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*n(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),r=Vec3.dot(t.n,e.center);return r+i<t.d?-1:r-i>t.d?0:1}}(),obb_frustum=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===obb_plane(e,t.planes[i]))return 0;return 1},obb_frustum_accurate=function(){for(var l=new Array(8),u=0,h=0,_=0,e=0;e<l.length;e++)l[e]=new Vec3(0,0,0);function p(e,t,i,r){return e.x*t+e.y*i+e.z*r}return function(e,t){for(var i=0,r=!1,n=0;n<t.planes.length;n++){if(-1===(i=obb_plane(e,t.planes[n])))return 0;1===i&&(r=!0)}if(!r)return 1;for(var s=0;s<t.vertices.length;s++)Vec3.subtract(l[s],t.vertices[s],e.center);for(var a=_=h=0;a<t.vertices.length;a++)(u=p(l[a],e.orientation.m00,e.orientation.m01,e.orientation.m02))>e.halfExtents.x?h++:u<-e.halfExtents.x&&_++;if(h===t.vertices.length||_===t.vertices.length)return 0;for(var o=_=h=0;o<t.vertices.length;o++)(u=p(l[o],e.orientation.m03,e.orientation.m04,e.orientation.m05))>e.halfExtents.y?h++:u<-e.halfExtents.y&&_++;if(h===t.vertices.length||_===t.vertices.length)return 0;for(var c=_=h=0;c<t.vertices.length;c++)(u=p(l[c],e.orientation.m06,e.orientation.m07,e.orientation.m08))>e.halfExtents.z?h++:u<-e.halfExtents.z&&_++;return h===t.vertices.length||_===t.vertices.length?0:1}}(),obb_obb=function(){for(var a=new Array(15),e=0;e<15;e++)a[e]=new Vec3(0,0,0);for(var o=new Array(8),c=new Array(8),t=0;t<8;t++)o[t]=new Vec3(0,0,0),c[t]=new Vec3(0,0,0);return function(e,t){Vec3.set(a[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),Vec3.set(a[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),Vec3.set(a[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),Vec3.set(a[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Vec3.set(a[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Vec3.set(a[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Vec3.cross(a[6+3*i+0],a[i],a[0]),Vec3.cross(a[6+3*i+1],a[i],a[1]),Vec3.cross(a[6+3*i+1],a[i],a[2]);getOBBVertices(e.center,e.halfExtents,a[0],a[1],a[2],o),getOBBVertices(t.center,t.halfExtents,a[3],a[4],a[5],c);for(var r=0;r<15;++r){var n=getInterval(o,a[r]),s=getInterval(c,a[r]);if(s[0]>n[1]||n[0]>s[1])return 0}return 1}}(),sphere_plane=function(e,t){var i=Vec3.dot(t.n,e.center),r=e.radius*t.n.length();return i+r<t.d?-1:i-r>t.d?0:1},sphere_frustum=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===sphere_plane(e,t.planes[i]))return 0;return 1},sphere_frustum_accurate=function(){var h=new Vec3(0,0,0),_=[1,-1,1,-1,1,-1];return function(e,t){for(var i=0;i<6;i++){var r=t.planes[i],n=e.radius,s=e.center,a=r.n,o=r.d,c=Vec3.dot(a,s);if(c+n<o)return 0;if(!(o<c-n)){Vec3.add(h,s,Vec3.multiplyScalar(h,a,n));for(var l=0;l<6;l++)if(l!==i&&l!==i+_[i]){var u=t.planes[l];if(Vec3.dot(u.n,h)<u.d)return 0}}}return 1}}(),sphere_sphere=function(e,t){var i=e.radius+t.radius;return Vec3.squaredDistance(e.center,t.center)<i*i},sphere_aabb=function(){var i=new Vec3;return function(e,t){return pt_point_aabb(i,e.center,t),Vec3.squaredDistance(e.center,i)<e.radius*e.radius}}(),sphere_obb=function(){var i=new Vec3;return function(e,t){return pt_point_obb(i,e.center,t),Vec3.squaredDistance(e.center,i)<e.radius*e.radius}}(),intersect={ray_sphere:ray_sphere,ray_aabb:ray_aabb,ray_obb:ray_obb,ray_plane:ray_plane,ray_triangle:ray_triangle,line_sphere:line_sphere,line_aabb:line_aabb,line_obb:line_obb,line_plane:line_plane,line_triangle:line_triangle,sphere_sphere:sphere_sphere,sphere_aabb:sphere_aabb,sphere_obb:sphere_obb,sphere_plane:sphere_plane,sphere_frustum:sphere_frustum,sphere_frustum_accurate:sphere_frustum_accurate,aabb_aabb:aabb_aabb,aabb_obb:aabb_obb,aabb_plane:aabb_plane,aabb_frustum:aabb_frustum,aabb_frustum_accurate:aabb_frustum_accurate,obb_obb:obb_obb,obb_plane:obb_plane,obb_frustum:obb_frustum,obb_frustum_accurate:obb_frustum_accurate,obb_point:obb_point,resolve:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:null,n=e._type,s=t._type,a=this[n|s];return n<s?a(e,t,r):a(t,e,r)}};intersect[enums.SHAPE_RAY|enums.SHAPE_SPHERE]=ray_sphere,intersect[enums.SHAPE_RAY|enums.SHAPE_AABB]=ray_aabb,intersect[enums.SHAPE_RAY|enums.SHAPE_OBB]=ray_obb,intersect[enums.SHAPE_RAY|enums.SHAPE_PLANE]=ray_plane,intersect[enums.SHAPE_RAY|enums.SHAPE_TRIANGLE]=ray_triangle,intersect[enums.SHAPE_LINE|enums.SHAPE_SPHERE]=line_sphere,intersect[enums.SHAPE_LINE|enums.SHAPE_AABB]=line_aabb,intersect[enums.SHAPE_LINE|enums.SHAPE_OBB]=line_obb,intersect[enums.SHAPE_LINE|enums.SHAPE_PLANE]=line_plane,intersect[enums.SHAPE_LINE|enums.SHAPE_TRIANGLE]=line_triangle,intersect[enums.SHAPE_SPHERE]=sphere_sphere,intersect[enums.SHAPE_SPHERE|enums.SHAPE_AABB]=sphere_aabb,intersect[enums.SHAPE_SPHERE|enums.SHAPE_OBB]=sphere_obb,intersect[enums.SHAPE_SPHERE|enums.SHAPE_PLANE]=sphere_plane,intersect[enums.SHAPE_SPHERE|enums.SHAPE_FRUSTUM]=sphere_frustum,intersect[enums.SHAPE_SPHERE|enums.SHAPE_FRUSTUM_ACCURATE]=sphere_frustum_accurate,intersect[enums.SHAPE_AABB]=aabb_aabb,intersect[enums.SHAPE_AABB|enums.SHAPE_OBB]=aabb_obb,intersect[enums.SHAPE_AABB|enums.SHAPE_PLANE]=aabb_plane,intersect[enums.SHAPE_AABB|enums.SHAPE_FRUSTUM]=aabb_frustum,intersect[enums.SHAPE_AABB|enums.SHAPE_FRUSTUM_ACCURATE]=aabb_frustum_accurate,intersect[enums.SHAPE_OBB]=obb_obb,intersect[enums.SHAPE_OBB|enums.SHAPE_PLANE]=obb_plane,intersect[enums.SHAPE_OBB|enums.SHAPE_FRUSTUM]=obb_frustum,intersect[enums.SHAPE_OBB|enums.SHAPE_FRUSTUM_ACCURATE]=obb_frustum_accurate;var line=function(){function a(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;_classCallCheck(this,a),this.s=void 0,this.e=void 0,this._type=void 0,this._type=enums.SHAPE_LINE,this.s=new Vec3(e,t,i),this.e=new Vec3(r,n,s)}return _createClass(a,null,[{key:"create",value:function(e,t,i,r,n,s){return new a(e,t,i,r,n,s)}},{key:"clone",value:function(e){return new a(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)}},{key:"copy",value:function(e,t){return Vec3.copy(e.s,t.s),Vec3.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,i){return Vec3.copy(e.s,t),Vec3.copy(e.e,i),e}},{key:"set",value:function(e,t,i,r,n,s,a){return e.s.x=t,e.s.y=i,e.s.z=r,e.e.x=n,e.e.y=s,e.e.z=a,e}},{key:"len",value:function(e){return Vec3.distance(e.s,e.e)}}]),_createClass(a,[{key:"length",value:function(){return Vec3.distance(this.s,this.e)}}]),a}(),v1=new Vec3(0,0,0),v2$1=new Vec3(0,0,0),temp_mat=cc.mat4(),temp_vec4=cc.v4(),plane=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,n),this.n=void 0,this.d=void 0,this._type=void 0,this._type=enums.SHAPE_PLANE,this.n=new Vec3(e,t,i),this.d=r}return _createClass(n,null,[{key:"create",value:function(e,t,i,r){return new n(e,t,i,r)}},{key:"clone",value:function(e){return new n(e.n.x,e.n.y,e.n.z,e.d)}},{key:"copy",value:function(e,t){return Vec3.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,i,r){return Vec3.subtract(v1,i,t),Vec3.subtract(v2$1,r,t),Vec3.normalize(e.n,Vec3.cross(e.n,v1,v2$1)),e.d=Vec3.dot(e.n,t),e}},{key:"set",value:function(e,t,i,r,n){return e.n.x=t,e.n.y=i,e.n.z=r,e.d=n,e}},{key:"fromNormalAndPoint",value:function(e,t,i){return Vec3.copy(e.n,t),e.d=Vec3.dot(t,i),e}},{key:"normalize",value:function(e,t){var i=t.n.length();return Vec3.normalize(e.n,t.n),0<i&&(e.d=t.d/i),e}}]),_createClass(n,[{key:"transform",value:function(e){Mat4.invert(temp_mat,e),Mat4.transpose(temp_mat,temp_mat),Vec4.set(temp_vec4,this.n.x,this.n.y,this.n.z,this.d),Vec4.transformMat4(temp_vec4,temp_vec4,temp_mat),Vec3.set(this.n,temp_vec4.x,temp_vec4.y,temp_vec4.z),this.d=temp_vec4.w}}]),n}(),triangle=function(){function l(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,a=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:1,c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0;_classCallCheck(this,l),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=enums.SHAPE_TRIANGLE,this.a=new Vec3(e,t,i),this.b=new Vec3(r,n,s),this.c=new Vec3(a,o,c)}return _createClass(l,null,[{key:"create",value:function(e,t,i,r,n,s,a,o,c){return new l(0<arguments.length&&void 0!==e?e:1,1<arguments.length&&void 0!==t?t:0,2<arguments.length&&void 0!==i?i:0,3<arguments.length&&void 0!==r?r:0,4<arguments.length&&void 0!==n?n:0,5<arguments.length&&void 0!==s?s:0,6<arguments.length&&void 0!==a?a:0,7<arguments.length&&void 0!==o?o:0,8<arguments.length&&void 0!==c?c:1)}},{key:"clone",value:function(e){return new l(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)}},{key:"copy",value:function(e,t){return Vec3.copy(e.a,t.a),Vec3.copy(e.b,t.b),Vec3.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,i,r){return Vec3.copy(e.a,t),Vec3.copy(e.b,i),Vec3.copy(e.c,r),e}},{key:"set",value:function(e,t,i,r,n,s,a,o,c,l){return e.a.x=t,e.a.y=i,e.a.z=r,e.b.x=n,e.b.y=s,e.b.z=a,e.c.x=o,e.c.y=c,e.c.z=l,e}}]),l}(),_v3_tmp=new Vec3;function maxComponent(e){return Math.max(Math.max(e.x,e.y),e.z)}var sphere=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;_classCallCheck(this,n),this.center=void 0,this.radius=void 0,this._type=void 0,this._type=enums.SHAPE_SPHERE,this.center=new Vec3(e,t,i),this.radius=r}return _createClass(n,null,[{key:"create",value:function(e,t,i,r){return new n(e,t,i,r)}},{key:"clone",value:function(e){return new n(e.center.x,e.center.y,e.center.z,e.radius)}},{key:"copy",value:function(e,t){return Vec3.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,i){return Vec3.multiplyScalar(e.center,Vec3.add(_v3_tmp,t,i),.5),e.radius=.5*Vec3.subtract(_v3_tmp,i,t).length(),e}},{key:"set",value:function(e,t,i,r,n){return e.center.x=t,e.center.y=i,e.center.z=r,e.radius=n,e}}]),_createClass(n,[{key:"clone",value:function(){return n.clone(this)}},{key:"copy",value:function(e){return n.copy(this,e)}},{key:"getBoundary",value:function(e,t){Vec3.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Vec3.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,i,r,n){Vec3.transformMat4(n.center,this.center,e),n.radius=this.radius*maxComponent(r)}},{key:"translateAndRotate",value:function(e,t,i){Vec3.transformMat4(i.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*maxComponent(e)}}]),n}(),_v3_tmp$1=new Vec3,_v3_tmp2=new Vec3,_v3_tmp3=new Vec3,_v3_tmp4=new Vec3,_m3_tmp=new Mat3,transform_extent_m4=function(e,t,i){_m3_tmp.m00=Math.abs(i.m00),_m3_tmp.m01=Math.abs(i.m01),_m3_tmp.m02=Math.abs(i.m02),_m3_tmp.m03=Math.abs(i.m04),_m3_tmp.m04=Math.abs(i.m05),_m3_tmp.m05=Math.abs(i.m06),_m3_tmp.m06=Math.abs(i.m08),_m3_tmp.m07=Math.abs(i.m09),_m3_tmp.m08=Math.abs(i.m10),Vec3.transformMat3(e,t,_m3_tmp)},aabb=function(){function a(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1;_classCallCheck(this,a),this.center=void 0,this.halfExtents=void 0,this._type=enums.SHAPE_AABB,this.center=new Vec3(e,t,i),this.halfExtents=new Vec3(r,n,s)}return _createClass(a,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,r,n,s){return new a(e,t,i,r,n,s)}},{key:"clone",value:function(e){return new a(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)}},{key:"copy",value:function(e,t){return Vec3.copy(e.center,t.center),Vec3.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,i){return Vec3.multiplyScalar(e.center,Vec3.add(_v3_tmp$1,t,i),.5),Vec3.multiplyScalar(e.halfExtents,Vec3.subtract(_v3_tmp2,i,t),.5),e}},{key:"set",value:function(e,t,i,r,n,s,a){return Vec3.set(e.center,t,i,r),Vec3.set(e.halfExtents,n,s,a),e}},{key:"merge",value:function(e,t,i){return Vec3.subtract(_v3_tmp$1,t.center,t.halfExtents),Vec3.subtract(_v3_tmp2,i.center,i.halfExtents),Vec3.add(_v3_tmp3,t.center,t.halfExtents),Vec3.add(_v3_tmp4,i.center,i.halfExtents),Vec3.max(_v3_tmp4,_v3_tmp3,_v3_tmp4),Vec3.min(_v3_tmp3,_v3_tmp$1,_v3_tmp2),a.fromPoints(e,_v3_tmp3,_v3_tmp4)}},{key:"transform",value:function(e,t,i){return Vec3.transformMat4(e.center,t.center,i),transform_extent_m4(e.halfExtents,t.halfExtents,i),e}}]),_createClass(a,[{key:"getBoundary",value:function(e,t){Vec3.subtract(e,this.center,this.halfExtents),Vec3.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,i,r,n){Vec3.transformMat4(n.center,this.center,e),transform_extent_m4(n.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return a.clone(this)}},{key:"copy",value:function(e){return a.copy(this,e)}}]),a}(),_v3_tmp$2=new Vec3,_v3_tmp2$1=new Vec3,_m3_tmp$1=new Mat3,transform_extent_m3=function(e,t,i){_m3_tmp$1.m00=Math.abs(i.m00),_m3_tmp$1.m01=Math.abs(i.m01),_m3_tmp$1.m02=Math.abs(i.m02),_m3_tmp$1.m03=Math.abs(i.m03),_m3_tmp$1.m04=Math.abs(i.m04),_m3_tmp$1.m05=Math.abs(i.m05),_m3_tmp$1.m06=Math.abs(i.m06),_m3_tmp$1.m07=Math.abs(i.m07),_m3_tmp$1.m08=Math.abs(i.m08),Vec3.transformMat3(e,t,_m3_tmp$1)},obb=function(){function f(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,a=6<arguments.length&&void 0!==arguments[6]?arguments[6]:1,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,l=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,u=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,h=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,_=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,p=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,d=14<arguments.length&&void 0!==arguments[14]?arguments[14]:1;_classCallCheck(this,f),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=enums.SHAPE_OBB,this.center=new Vec3(e,t,i),this.halfExtents=new Vec3(r,n,s),this.orientation=new Mat3(a,o,c,l,u,h,_,p,d)}return _createClass(f,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,r,n,s,a,o,c,l,u,h,_,p,d){return new f(e,t,i,r,n,s,a,o,c,l,u,h,_,p,d)}},{key:"clone",value:function(e){return new f(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)}},{key:"copy",value:function(e,t){return Vec3.copy(e.center,t.center),Vec3.copy(e.halfExtents,t.halfExtents),Mat3.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,i){return Vec3.multiplyScalar(e.center,Vec3.add(_v3_tmp$2,t,i),.5),Vec3.multiplyScalar(e.halfExtents,Vec3.subtract(_v3_tmp2$1,i,t),.5),Mat3.identity(e.orientation),e}},{key:"set",value:function(e,t,i,r,n,s,a,o,c,l,u,h,_,p,d,f){return Vec3.set(e.center,t,i,r),Vec3.set(e.halfExtents,n,s,a),Mat3.set(e.orientation,o,c,l,u,h,_,p,d,f),e}}]),_createClass(f,[{key:"getBoundary",value:function(e,t){transform_extent_m3(_v3_tmp$2,this.halfExtents,this.orientation),Vec3.subtract(e,this.center,_v3_tmp$2),Vec3.add(t,this.center,_v3_tmp$2)}},{key:"transform",value:function(e,t,i,r,n){Vec3.transformMat4(n.center,this.center,e),Mat3.fromQuat(n.orientation,i),Vec3.multiply(n.halfExtents,this.halfExtents,r)}},{key:"translateAndRotate",value:function(e,t,i){Vec3.transformMat4(i.center,this.center,e),Mat3.fromQuat(i.orientation,t)}},{key:"setScale",value:function(e,t){Vec3.multiply(t.halfExtents,this.halfExtents,e)}}]),f}(),_v=new Array(8);_v[0]=new Vec3(1,1,1),_v[1]=new Vec3(-1,1,1),_v[2]=new Vec3(-1,-1,1),_v[3]=new Vec3(1,-1,1),_v[4]=new Vec3(1,1,-1),_v[5]=new Vec3(-1,1,-1),_v[6]=new Vec3(-1,-1,-1),_v[7]=new Vec3(1,-1,-1);var frustum=function(){function i(){_classCallCheck(this,i),this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=enums.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=plane.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new Vec3}return _createClass(i,[{key:"accurate",set:function(e){this._type=e?enums.SHAPE_FRUSTUM_ACCURATE:enums.SHAPE_FRUSTUM}}],[{key:"create",value:function(){return new i}},{key:"clone",value:function(e){return i.copy(new i,e)}},{key:"copy",value:function(e,t){e._type=t._type;for(var i=0;i<6;++i)plane.copy(e.planes[i],t.planes[i]);for(var r=0;r<8;++r)Vec3.copy(e.vertices[r],t.vertices[r]);return e}}]),_createClass(i,[{key:"update",value:function(e,t){if(Vec3.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Vec3.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Vec3.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Vec3.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Vec3.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Vec3.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===enums.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var r=this.planes[i],n=1/r.n.length();Vec3.multiplyScalar(r.n,r.n,n),r.d*=n}for(var s=0;s<8;s++)Vec3.transformMat4(this.vertices[s],_v[s],t)}}},{key:"transform",value:function(e){if(this._type===enums.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Vec3.transformMat4(this.vertices[t],this.vertices[t],e);plane.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),plane.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),plane.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),plane.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),plane.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),plane.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),i}();frustum.createOrtho=function(){var c=new Vec3;return function(e,t,i,r,n,s){var a=t/2,o=i/2;Vec3.set(c,a,o,r),Vec3.transformMat4(e.vertices[0],c,s),Vec3.set(c,-a,o,r),Vec3.transformMat4(e.vertices[1],c,s),Vec3.set(c,-a,-o,r),Vec3.transformMat4(e.vertices[2],c,s),Vec3.set(c,a,-o,r),Vec3.transformMat4(e.vertices[3],c,s),Vec3.set(c,a,o,n),Vec3.transformMat4(e.vertices[4],c,s),Vec3.set(c,-a,o,n),Vec3.transformMat4(e.vertices[5],c,s),Vec3.set(c,-a,-o,n),Vec3.transformMat4(e.vertices[6],c,s),Vec3.set(c,a,-o,n),Vec3.transformMat4(e.vertices[7],c,s),plane.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),plane.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),plane.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),plane.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),plane.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),plane.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])}}();var CircularPool=function(){function r(e,t){_classCallCheck(this,r),this._cursor=void 0,this._data=void 0,this._cursor=0,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return _createClass(r,[{key:"request",value:function(){var e=this._data[this._cursor];return this._cursor=(this._cursor+1)%this._data.length,e}}]),r}(),DEFAULT_MIN_MERGE=32,DEFAULT_MIN_GALLOPING=7,DEFAULT_TMP_STORAGE_LENGTH=256,POWERS_OF_TEN=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function log10$1(e){return e<1e5?e<100?e<10?0:1:e<1e4?e<1e3?2:3:4:e<1e7?e<1e6?5:6:e<1e9?e<1e8?7:8:9}function alphabeticalCompare(e,t){if(e===t)return 0;if(~~e===e&&~~t===t){if(0===e||0===t)return e<t?-1:1;if(e<0||t<0){if(0<=t)return-1;if(0<=e)return 1;e=-e,t=-t}var i=log10$1(e),r=log10$1(t),n=0;return i<r?(e*=POWERS_OF_TEN[r-i-1],t/=10,n=-1):r<i&&(t*=POWERS_OF_TEN[i-r-1],e/=10,n=1),e===t?n:e<t?-1:1}var s=String(e),a=String(t);return s===a?0:s<a?-1:1}function minRunLength(e){for(var t=0;DEFAULT_MIN_MERGE<=e;)t|=1&e,e>>=1;return e+t}function makeAscendingRun(e,t,i,r){var n=t+1;if(n===i)return 1;if(r(e[n++],e[t])<0){for(;n<i&&r(e[n],e[n-1])<0;)n++;reverseRun(e,t,n)}else for(;n<i&&0<=r(e[n],e[n-1]);)n++;return n-t}function reverseRun(e,t,i){for(i--;t<i;){var r=e[t];e[t++]=e[i],e[i--]=r}}function binaryInsertionSort(e,t,i,r,n){for(r===t&&r++;r<i;r++){for(var s=e[r],a=t,o=r;a<o;){var c=a+o>>>1;n(s,e[c])<0?o=c:a=1+c}var l=r-a;switch(l){case 3:e[a+3]=e[a+2];case 2:e[a+2]=e[a+1];case 1:e[a+1]=e[a];break;default:for(;0<l;)e[a+l]=e[a+l-1],l--}e[a]=s}}function gallopLeft(e,t,i,r,n,s){var a=0,o=0,c=1;if(0<s(e,t[i+n])){for(o=r-n;c<o&&0<s(e,t[i+n+c]);)(c=1+((a=c)<<1))<=0&&(c=o);o<c&&(c=o),a+=n,c+=n}else{for(o=n+1;c<o&&s(e,t[i+n-c])<=0;)(c=1+((a=c)<<1))<=0&&(c=o);o<c&&(c=o);var l=a;a=n-c,c=n-l}for(a++;a<c;){var u=a+(c-a>>>1);0<s(e,t[i+u])?a=u+1:c=u}return c}function gallopRight(e,t,i,r,n,s){var a=0,o=0,c=1;if(s(e,t[i+n])<0){for(o=n+1;c<o&&s(e,t[i+n-c])<0;)(c=1+((a=c)<<1))<=0&&(c=o);o<c&&(c=o);var l=a;a=n-c,c=n-l}else{for(o=r-n;c<o&&0<=s(e,t[i+n+c]);)(c=1+((a=c)<<1))<=0&&(c=o);o<c&&(c=o),a+=n,c+=n}for(a++;a<c;){var u=a+(c-a>>>1);s(e,t[i+u])<0?c=u:a=u+1}return c}var TimSort=function(){function i(e,t){_classCallCheck(this,i),this.array=void 0,this.compare=void 0,this.minGallop=void 0,this.length=void 0,this.tmpStorageLength=void 0,this.tmp=void 0,this.stackLength=void 0,this.runStart=void 0,this.runLength=void 0,this.stackSize=void 0,this.array=e,this.compare=t,this.minGallop=DEFAULT_MIN_GALLOPING,this.length=e.length,this.tmpStorageLength=DEFAULT_TMP_STORAGE_LENGTH,this.length<2*DEFAULT_TMP_STORAGE_LENGTH&&(this.tmpStorageLength=this.length>>>1),this.tmp=new Array(this.tmpStorageLength),this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40,this.runStart=new Array(this.stackLength),this.runLength=new Array(this.stackLength),this.stackSize=0}return _createClass(i,[{key:"pushRun",value:function(e,t){this.runStart[this.stackSize]=e,this.runLength[this.stackSize]=t,this.stackSize+=1}},{key:"mergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;if(1<=e&&this.runLength[e-1]<=this.runLength[e]+this.runLength[e+1]||2<=e&&this.runLength[e-2]<=this.runLength[e]+this.runLength[e-1])this.runLength[e-1]<this.runLength[e+1]&&e--;else if(this.runLength[e]>this.runLength[e+1])break;this.mergeAt(e)}}},{key:"forceMergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;0<e&&this.runLength[e-1]<this.runLength[e+1]&&e--,this.mergeAt(e)}}},{key:"mergeAt",value:function(e){var t=this.compare,i=this.array,r=this.runStart[e],n=this.runLength[e],s=this.runStart[e+1],a=this.runLength[e+1];this.runLength[e]=n+a,e===this.stackSize-3&&(this.runStart[e+1]=this.runStart[e+2],this.runLength[e+1]=this.runLength[e+2]),this.stackSize--;var o=gallopRight(i[s],i,r,n,0,t);r+=o,0!==(n-=o)&&0!==(a=gallopLeft(i[r+n-1],i,s,a,a-1,t))&&(n<=a?this.mergeLow(r,n,s,a):this.mergeHigh(r,n,s,a))}},{key:"mergeLow",value:function(e,t,i,r){var n=this.compare,s=this.array,a=this.tmp,o=0;for(o=0;o<t;o++)a[o]=s[e+o];var c=0,l=i,u=e;if(s[u++]=s[l++],0!=--r)if(1!==t){for(var h=this.minGallop;;){var _=0,p=0,d=!1;do{if(n(s[l],a[c])<0){if(s[u++]=s[l++],p++,(_=0)==--r){d=!0;break}}else if(s[u++]=a[c++],_++,p=0,1==--t){d=!0;break}}while((_|p)<h);if(d)break;do{if(0!==(_=gallopRight(s[l],a,c,t,0,n))){for(o=0;o<_;o++)s[u+o]=a[c+o];if(u+=_,c+=_,(t-=_)<=1){d=!0;break}}if(s[u++]=s[l++],0==--r){d=!0;break}if(0!==(p=gallopLeft(a[c],s,l,r,0,n))){for(o=0;o<p;o++)s[u+o]=s[l+o];if(u+=p,l+=p,0===(r-=p)){d=!0;break}}if(s[u++]=a[c++],1==--t){d=!0;break}h--}while(DEFAULT_MIN_GALLOPING<=_||DEFAULT_MIN_GALLOPING<=p);if(d)break;h<0&&(h=0),h+=2}if((this.minGallop=h)<1&&(this.minGallop=1),1===t){for(o=0;o<r;o++)s[u+o]=s[l+o];s[u+r]=a[c]}else{if(0===t)throw new Error("mergeLow preconditions were not respected");for(o=0;o<t;o++)s[u+o]=a[c+o]}}else{for(o=0;o<r;o++)s[u+o]=s[l+o];s[u+r]=a[c]}else for(o=0;o<t;o++)s[u+o]=a[c+o]}},{key:"mergeHigh",value:function(e,t,i,r){var n=this.compare,s=this.array,a=this.tmp,o=0;for(o=0;o<r;o++)a[o]=s[i+o];var c=e+t-1,l=r-1,u=i+r-1,h=0,_=0;if(s[u--]=s[c--],0!=--t)if(1!==r){for(var p=this.minGallop;;){var d=0,f=0,m=!1;do{if(n(a[l],s[c])<0){if(s[u--]=s[c--],d++,(f=0)==--t){m=!0;break}}else if(s[u--]=a[l--],f++,d=0,1==--r){m=!0;break}}while((d|f)<p);if(m)break;do{if(0!==(d=t-gallopRight(a[l],s,e,t,t-1,n))){for(t-=d,_=(u-=d)+1,h=(c-=d)+1,o=d-1;0<=o;o--)s[_+o]=s[h+o];if(0===t){m=!0;break}}if(s[u--]=a[l--],1==--r){m=!0;break}if(0!==(f=r-gallopLeft(s[c],a,0,r,r-1,n))){for(r-=f,_=(u-=f)+1,h=(l-=f)+1,o=0;o<f;o++)s[_+o]=a[h+o];if(r<=1){m=!0;break}}if(s[u--]=s[c--],0==--t){m=!0;break}p--}while(DEFAULT_MIN_GALLOPING<=d||DEFAULT_MIN_GALLOPING<=f);if(m)break;p<0&&(p=0),p+=2}if((this.minGallop=p)<1&&(this.minGallop=1),1===r){for(_=(u-=t)+1,h=(c-=t)+1,o=t-1;0<=o;o--)s[_+o]=s[h+o];s[u]=a[l]}else{if(0===r)throw new Error("mergeHigh preconditions were not respected");for(h=u-(r-1),o=0;o<r;o++)s[h+o]=a[o]}}else{for(_=(u-=t)+1,h=(c-=t)+1,o=t-1;0<=o;o--)s[_+o]=s[h+o];s[u]=a[l]}else for(h=u-(r-1),o=0;o<r;o++)s[h+o]=a[o]}}]),i}();function _sort(e,t,i,r){if(!Array.isArray(e))throw new TypeError("Can only sort arrays");void 0===t&&(t=0),void 0===i&&(i=e.length),void 0===r&&(r=alphabeticalCompare);var n=i-t;if(!(n<2)){var s=0;if(n<DEFAULT_MIN_MERGE)binaryInsertionSort(e,t,i,t+(s=makeAscendingRun(e,t,i,r)),r);else{var a=new TimSort(e,r),o=minRunLength(n);do{if((s=makeAscendingRun(e,t,i,r))<o){var c=n;o<c&&(c=o),binaryInsertionSort(e,t,t+c,t+s,r),s=c}a.pushRun(t,s),a.mergeRuns(),n-=s,t+=s}while(0!==n);a.forceMergeRuns()}}}for(var FixedArray=function(){function t(e){_classCallCheck(this,t),this._count=void 0,this._data=void 0,this._count=0,this._data=new Array(e)}return _createClass(t,[{key:"_resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=void 0}},{key:"reset",value:function(){for(var e=0;e<this._count;++e)this._data[e]=void 0;this._count=0}},{key:"push",value:function(e){this._count>=this._data.length&&this._resize(2*this._data.length),this._data[this._count]=e,++this._count}},{key:"pop",value:function(){--this._count,this._count<0&&(this._count=0);var e=this._data[this._count];return this._data[this._count]=void 0,e}},{key:"fastRemove",value:function(e){if(!(e>=this._count||e<0)){var t=this._count-1;this._data[e]=this._data[t],this._data[t]=void 0,this._count-=1}}},{key:"indexOf",value:function(e){return this._data.indexOf(e)}},{key:"sort",value:function(e){return _sort(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(),Pool$1=function(){function r(e,t){_classCallCheck(this,r),this._fn=void 0,this._idx=void 0,this._frees=void 0,this._fn=e,this._idx=t-1,this._frees=new Array(t);for(var i=0;i<t;++i)this._frees[i]=e()}return _createClass(r,[{key:"alloc",value:function(){this._idx<0&&this._expand(Math.round(1.2*this._frees.length)+1);var e=this._frees[this._idx];return this._frees.splice(this._idx),--this._idx,e}},{key:"free",value:function(e){++this._idx,this._frees[this._idx]=e}},{key:"clear",value:function(e){for(var t=0;t<=this._idx;t++)e&&e(this._frees[t]);this._frees.splice(0),this._idx=-1}},{key:"_expand",value:function(e){var t=this._frees;this._frees=new Array(e);for(var i=e-t.length,r=0;r<i;++r)this._frees[r]=this._fn();for(var n=i,s=0;n<e;++n,++s)this._frees[n]=t[s];this._idx+=i}}]),r}(),LinkedArray=function(){function i(e,t){_classCallCheck(this,i),this._fn=void 0,this._count=void 0,this._head=void 0,this._tail=void 0,this._pool=void 0,this._fn=e,this._count=0,this._head=null,this._tail=null,this._pool=new Pool$1(e,t)}return _createClass(i,[{key:"add",value:function(){var e=this._pool.alloc();return this._tail?(this._tail._next=e)._prev=this._tail:this._head=e,this._tail=e,this._count+=1,e}},{key:"remove",value:function(e){e._prev?e._prev._next=e._next:this._head=e._next,e._next?e._next._prev=e._prev:this._tail=e._prev,e._next=null,e._prev=null,this._pool.free(e),this._count-=1}},{key:"forEach",value:function(e,t){var i=this._head;if(i){t&&(e=e.bind(t));for(var r=0,n=i;i;)n=i._next,e(i,r,this),i=n,++r}}},{key:"head",get:function(){return this._head}},{key:"tail",get:function(){return this._tail}},{key:"length",get:function(){return this._count}}]),i}(),RecyclePool=function(){function r(e,t){_classCallCheck(this,r),this._fn=void 0,this._count=0,this._data=void 0,this._fn=e,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return _createClass(r,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}},{key:"sort",value:function(e){return _sort(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),r}(),_bufferPools=Array(8),i$1=0;i$1<8;++i$1)_bufferPools[i$1]=[];function _nextPow16(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}function _log2(e){var t=(65535<e)<<4,i=(255<(e>>>=t))<<3;return t|=i,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1}function _alloc(e){var t=_nextPow16(e),i=_bufferPools[_log2(t)>>2];return 0<i.length?i.pop():new ArrayBuffer(t)}function _free(e){_bufferPools[_log2(e.byteLength)>>2].push(e)}var typedArrayPool={alloc_int8:function(e){var t=new Int8Array(_alloc(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint8:function(e){var t=new Uint8Array(_alloc(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int16:function(e){var t=new Int16Array(_alloc(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint16:function(e){var t=new Uint16Array(_alloc(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int32:function(e){var t=new Int32Array(_alloc(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint32:function(e){var t=new Uint32Array(_alloc(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float32:function(e){var t=new Float32Array(_alloc(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float64:function(e){var t=new Float64Array(_alloc(8*e),0,e);return t.length!==e?t.subarray(0,e):t},free:function(e){_free(e.buffer)},reset:function(){_bufferPools=Array(8);for(var e=0;e<8;++e)_bufferPools[e]=[]}},mul=function(e,t,i,r,n){return Vec3.set(e,t.x*i,t.y*r,t.z*n)},OctreeBlock=function(){function a(e,t,i,r,n,s){_classCallCheck(this,a),this.minPos=void 0,this.maxPos=void 0,this.boundingBox=void 0,this.capacity=void 0,this.depth=void 0,this.maxDepth=void 0,this.blocks=void 0,this.entries=void 0,this._getBoundingShape=void 0,this.minPos=e,this.maxPos=t,this.boundingBox=aabb.fromPoints(aabb.create(),e,t),this.capacity=i,this.depth=r,this.maxDepth=n,this._getBoundingShape=s,this.blocks=null,this.entries=new FixedArray(this.capacity)}return _createClass(a,[{key:"addEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.addEntry(e)}}else{var s=this._getBoundingShape(e);if(!intersect.resolve(this.boundingBox,s))return;this.entries.push(e),this.entries.length>=this.capacity&&this.depth<this.maxDepth&&(this.blocks=Octree.createBlocks(this.minPos,this.maxPos,this.entries,this.capacity,this.depth,this.maxDepth,this._getBoundingShape),this.entries.reset())}}},{key:"removeEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.removeEntry(e)}}else this.entries.fastRemove(this.entries.indexOf(e))}},{key:"select",value:function(e,t){if(intersect.resolve(this.boundingBox,t))if(this.blocks){var i=this.blocks,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}s.select(e,t)}}else for(var a=0;a<this.entries.length;a++)e.add(this.entries.data[a])}},{key:"frustumSelect",value:function(e,t){if(intersect.aabb_frustum(this.boundingBox,t))if(this.blocks){var i=this.blocks,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}s.frustumSelect(e,t)}}else for(var a=0;a<this.entries.length;a++)e.add(this.entries.data[a])}}]),a}(),Octree=function(){function u(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:32,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:5;_classCallCheck(this,u),this.blockCapacity=void 0,this.maxDepth=void 0,this.blocks=void 0,this.dynamics=void 0,this._selection=void 0,this._getBoundingShape=void 0,this.blockCapacity=t,this.maxDepth=i,this.blocks=[],this.dynamics=[],this._selection=new Set,this._getBoundingShape=function(){return e._getBoundingShape}}return _createClass(u,null,[{key:"createBlocks",value:function(e,t,i,r,n,s,a){var o=[],c=new Vec3;Vec3.multiplyScalar(c,Vec3.subtract(c,t,e),.5);for(var l=0;l<2;l++)for(var u=0;u<2;u++)for(var h=0;h<2;h++){var _=new Vec3,p=new Vec3;Vec3.add(_,e,mul(_,c,l,u,h)),Vec3.add(p,e,mul(p,c,l+1,u+1,h+1));for(var d=new OctreeBlock(_,p,r,n+1,s,a),f=0;f<i.length;f++){var m=(i.data||i)[f];d.addEntry(m)}o.push(d)}return o}}]),_createClass(u,[{key:"build",value:function(e,t){var i=new Vec3(1/0,1/0,1/0),r=new Vec3(-1/0,-1/0,-1/0),n=new Vec3,s=new Vec3,a=[];this.dynamics=[];for(var o=0;o<e.length;o++){var c=(e.data||e)[o],l=t(c);l?(l.getBoundary(n,s),Vec3.min(i,i,n),Vec3.max(r,r,s),a.push(c)):this.dynamics.push(c)}this.blocks=u.createBlocks(i,r,a,this.blockCapacity,0,this.maxDepth,t),this._getBoundingShape=t}},{key:"addEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.addEntry(e)}}else this.dynamics.push(e)}},{key:"removeEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.removeEntry(e)}}else this.dynamics.splice(this.dynamics.indexOf(e),1)}},{key:"select",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.select(this._selection,e)}var s=this.dynamics,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if(a){if(o>=s.length)break;c=s[o++]}else{if((o=s.next()).done)break;c=o.value}var l=c;this._selection.add(l)}return this._selection}},{key:"frustumSelect",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.frustumSelect(this._selection,e)}var s=this.dynamics,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if(a){if(o>=s.length)break;c=s[o++]}else{if((o=s.next()).done)break;c=o.value}var l=c;this._selection.add(l)}return this._selection}}]),u}(),LOOK_FORWARD=3,WrapMode=Enum({Default:0,Once:1,Loop:2,PingPong:3,ClampForever:4}),Keyframe=function e(){_classCallCheck(this,e),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};CCClass.fastDefine("cc.Keyframe",Keyframe,{time:0,value:0,inTangent:0,outTangent:0});var OptimizedKey=function(){function e(){_classCallCheck(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return _createClass(e,[{key:"evaluate",value:function(e){return evalOptCurve(e-this.time,this.coefficient)}}]),e}();function evalOptCurve(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}var AnimationCurve=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;_classCallCheck(this,t),this.keyFrames=void 0,this.preWrapMode=WrapMode.Loop,this.postWrapMode=WrapMode.Loop,this.cachedKey=void 0,this.keyFrames=e||[].concat(t.defaultKF),this.cachedKey=new OptimizedKey}return _createClass(t,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,r=this.keyFrames[0].time,n=this.keyFrames[this.keyFrames.length-1].time;switch(i){case WrapMode.Loop:t=repeat(e-r,n-r)+r;break;case WrapMode.PingPong:t=pingPong(e-r,n-r)+r;break;case WrapMode.ClampForever:t=clamp(e,r,n)}var s=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)s=this.keyFrames.length-2;else for(var a=0;a<this.keyFrames.length-1;a++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[a+1].time){s=a;break}var o=this.keyFrames[s],c=this.keyFrames[s+1],l=inverseLerp(o.time,c.time,t),u=c.time-o.time,h=o.outTangent*u,_=c.inTangent*u,p=l*l,d=p*l,f=d-2*p+l,m=d-p,y=-2*d+3*p;return(2*d-3*p+1)*o.value+f*h+m*_+y*c.value}},{key:"evaluate",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,r=this.keyFrames[0].time,n=this.keyFrames[this.keyFrames.length-1].time;switch(i){case WrapMode.Loop:t=repeat(e-r,n-r)+r;break;case WrapMode.PingPong:t=pingPong(e-r,n-r)+r;break;case WrapMode.ClampForever:t=clamp(e,r,n)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var s=this.findIndex(this.cachedKey,t),a=s+1;return a===this.keyFrames.length&&(a-=1),this.calcOptimizedKey(this.cachedKey,s,a),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,i){var r=this.keyFrames[t],n=this.keyFrames[i];e.index=t,e.time=r.time,e.endTime=n.time;var s=n.time-r.time,a=n.value-r.value,o=1/(s*s),c=r.outTangent*s,l=n.inTangent*s;e.coefficient[0]=(c+l-a-a)*o/s,e.coefficient[1]=(a+a+a-c-c-l)*o,e.coefficient[2]=r.outTangent,e.coefficient[3]=r.value}},{key:"findIndex",value:function(e,t){var i=e.index;if(-1!==i)if(this.keyFrames[i].time<t)for(var r=0;r<LOOK_FORWARD;r++){var n=i+r;if(n+1<this.keyFrames.length&&this.keyFrames[n+1].time>t)return n}else for(var s=0;s<LOOK_FORWARD;s++){var a=i-s;if(0<=a&&this.keyFrames[a-1].time<=t)return a-1}for(var o=0,c=this.keyFrames.length,l=Math.floor((o+c)/2);1<c-o;)this.keyFrames[l].time>=t?c=l:o=l+1,l=Math.floor((o+c)/2);return o}}]),t}();AnimationCurve.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],CCClass.fastDefine("cc.AnimationCurve",AnimationCurve,{preWrapMode:WrapMode.Default,postWrapMode:WrapMode.Default,keyFrames:[]}),exports.replaceProperty(line.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),exports.removeProperty(intersect,"intersect",[{name:"line_quad"}]);var geometry=Object.freeze({distance:distance,enums:enums,intersect:intersect,line:line,plane:plane,ray:ray,triangle:triangle,sphere:sphere,aabb:aabb,obb:obb,frustum:frustum,Octree:Octree,Keyframe:Keyframe,AnimationCurve:AnimationCurve}),WORD_REG=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,SYMBOL_REG=/^[!,.:;'}\]%\?>、‘“》？。，！]/,LAST_WORD_REG=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,LAST_ENGLISH_REG=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,FIRST_ENGLISH_REG=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function isUnicodeCJK(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function isUnicodeSpace(e){var t=e.charCodeAt(0);return 9<=t&&t<=13||32===t||133===t||160===t||5760===t||8192<=t&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function safeMeasureText(e,t){var i=e.measureText(t);return i&&i.width||0}function fragmentText(e,t,i,r){var n=[];if(0===e.length||i<0)return n.push(""),n;for(var s=e;i<t&&1<s.length;){for(var a=s.length*(i/t)|0,o=s.substr(a),c=t-r(o),l=o,u=0,h=0;i<c&&h++<10;)a*=i/c,a|=0,c=t-r(o=s.substr(a));for(h=0;c<=i&&h++<10;){if(o){var _=WORD_REG.exec(o);u=_?_[0].length:1,l=o}a+=u,c=t-r(o=s.substr(a))}0===(a-=u)&&(a=1,l=l.substr(1));var p=s.substr(0,a),d=void 0;SYMBOL_REG.test(l||o)&&(0===(a-=(d=LAST_WORD_REG.exec(p))?d[0].length:0)&&(a=1),l=s.substr(a),p=s.substr(0,a)),FIRST_ENGLISH_REG.test(l)&&(d=LAST_ENGLISH_REG.exec(p))&&p!==d[0]&&(a-=d[0].length,l=s.substr(a),p=s.substr(0,a)),0===n.length?n.push(p):0<(p=p.trim()).length&&n.push(p),t=r(s=l||o)}return 0===n.length?n.push(s):0<(s=s.trim()).length&&n.push(s),n}var eventRegx=/^(click)(\s)*=|(param)(\s)*=/,imageAttrReg=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,HtmlTextParser=function(){function e(){_classCallCheck(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return _createClass(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0;for(var t=this._stack.length=0,i=e.length;t<i;){var r=e.indexOf("<",t);if(r<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{this._processResult(e.substring(t,r));var n=e.indexOf(">",t);-1===n?n=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(e.substring(r+1,n)),t=n+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){var t={},i=(e=e.trim()).match(/^(color|size)(\s)*=/),r="",n=0,s="";if(i){if(r=i[0],""===(e=e.substring(r.length).trim()))return t;switch(n=e.indexOf(" "),r[0]){case"c":t.color=-1<n?e.substring(0,n).trim():e;break;case"s":t.size=parseInt(e)}return-1<n&&(s=e.substring(n+1).trim(),t.event=this._processEventHandler(s)),t}if((i=e.match(/^(br(\s)*\/)/))&&0<i[0].length&&(r=i[0].trim()).startsWith("br")&&"/"===r[r.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{newline:!0}}),t;var a="";if((i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/))&&0<i[0].length&&(r=i[0].trim()).startsWith("img")&&"/"===r[r.length-1]){var o;i=e.match(imageAttrReg);for(var c=!1;i;)r=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),o=-1<(n=(a=e.substring(r.length).trim()).indexOf(" "))?a.substr(0,n):a,r=(r=r.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=a.substring(n).trim(),"src"===r?(t.isImage=!0,o.endsWith("/")&&(o=o.substring(0,o.length-1)),0===o.indexOf("'")?(c=!0,o=o.substring(1,o.length-1)):0===o.indexOf('"')&&(c=!0,o=o.substring(1,o.length-1)),t.src=o):"height"===r?t.imageHeight=parseInt(o):"width"===r?t.imageWidth=parseInt(o):"click"===r&&(t.event=this._processEventHandler(r+"="+o)),t.event&&"param"===r&&(t.event[r]=o.replace(/^\"|\"$/g,"")),i=e.match(imageAttrReg);return c&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/)){var l={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=e.match(h);i;)r=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),u=-1<(n=(a=e.substring(r.length).trim()).indexOf(" "))?a.substr(0,n):a,r=(r=r.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=a.substring(n).trim(),"click"===r?t.event=this._processEventHandler(r+"="+u):"color"===r?l.color=u:"width"===r&&(l.width=parseInt(u)),t.event&&"param"===r&&(t.event[r]=u.replace(/^\"|\"$/g,"")),i=e.match(h)}t.outline=l}if((i=e.match(/^(on|u|b|i)(\s)*/))&&0<i[0].length){switch(r=i[0],e=e.substring(r.length).trim(),r[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"_processEventHandler",value:function(e){for(var t=0,i=new Map,r=e.match(eventRegx),n=!1;r;){var s=r[0],a="";if(n=!1,'"'===(e=e.substring(s.length).trim()).charAt(0))-1<(t=e.indexOf('"',1))&&(a=e.substring(1,t).trim(),n=!0),t++;else if("'"===e.charAt(0))-1<(t=e.indexOf("'",1))&&(a=e.substring(1,t).trim(),n=!0),t++;else{var o=e.match(/(\S)+/);t=(a=o?o[0]:"").length}n&&(i[s=s.substring(0,s.length-1).trim()]=a),r=(e=e.substring(t).trim()).match(eventRegx)}return i}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var r in i)t[r]||(t[r]=i[r]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),0<this._stack.length?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){var t=this._specialSymbolArray,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n,a=s[0],o=s[1];e=e.replace(a,o)}return e}}]),e}();var CACHE_KEY="__ccclassCache__";function fNOP(e){return e}function getSubDict(e,t){return e[t]||(e[t]={})}function checkCtorArgument(i){return function(t){return"function"==typeof t?i(t):function(e){return i(e,t)}}}function _checkNormalArgument(e,i,t){return function(t){return function(e){return i(e,t)}}}var checkCompArgument=_checkNormalArgument.bind(null,!1);function _argumentChecker(e){return _checkNormalArgument.bind(null,!1)}var checkStringArgument=_argumentChecker("string"),checkNumberArgument=_argumentChecker("number");function getClassCache(e,t){return getSubDict(e,CACHE_KEY)}function getDefaultFromInitializer(t){var e;try{e=t()}catch(e){return t}return"object"!==_typeof(e)||null===e?e:t}function extractActualDefaultValues(e){var t;try{t=new e}catch(e){return{}}return t}function genProperty(e,t,i,r,n,s){var a;r&&(a=(a=getFullFormOfProperty(r))||r);var o=mixin(t[i]||{},a||{});if(n&&(n.get||n.set)){n.get&&(o.get=n.get),n.set&&(o.set=n.set)}else{var c;0;if(n)n.initializer&&(c=getDefaultFromInitializer(n.initializer),!0);else{var l=s.default||(s.default=extractActualDefaultValues(e));l.hasOwnProperty(i)&&(c=l[i],!0)}0,o.default=c}t[i]=o}var ccclass=checkCtorArgument(function(e,t){var i=getSuper(e);i===Object&&(i=null);var r={name:t,extends:i,ctor:e,__ES6__:!0},n=e[CACHE_KEY];if(n){var s=n.proto;s&&mixin(r,s),e[CACHE_KEY]=void 0}return cc.Class(r)});function property(e,t,i){var s=null;function r(e,t,i){var r=getClassCache(e.constructor);if(r){var n=getSubDict(getSubDict(r,"proto"),"properties");genProperty(e.constructor,n,t,s,i,r)}}if(void 0===t)return s=e,r;r(e,t,i)}function createEditorDecorator(e,n,s){return e(function(e,t){var i=getClassCache(e,n);if(i){var r=void 0!==s?s:t;getSubDict(getSubDict(i,"proto"),"editor")[n]=r}},n)}function createDummyDecorator(e){return e(fNOP)}var executeInEditMode=createDummyDecorator(checkCtorArgument,"executeInEditMode",!0),requireComponent=createEditorDecorator(checkCompArgument,"requireComponent"),menu=createDummyDecorator(checkStringArgument,"menu"),executionOrder=createEditorDecorator(checkNumberArgument,"executionOrder"),disallowMultiple=createDummyDecorator(checkCtorArgument,"disallowMultiple"),playOnFocus=createDummyDecorator(checkCtorArgument,"playOnFocus"),inspector=createDummyDecorator(checkStringArgument,"inspector"),icon=createDummyDecorator(checkStringArgument,"icon"),help=createDummyDecorator(checkStringArgument,"help");function mixins(){for(var i=[],e=0;e<arguments.length;e++)i[e]=e<0||arguments.length<=e?void 0:arguments[e];return function(e){var t=getClassCache(e,"mixins");t&&(getSubDict(t,"proto").mixins=i)}}var integer=type(CCInteger),_float=type(CCFloat),_boolean=type(CCBoolean),string=type(CCString);function type(e){return property({type:e})}var _dec,_class,_class2,_descriptor,_descriptor2,_descriptor3,_descriptor4,_descriptor5,_temp,_decorator=Object.freeze({ccclass:ccclass,property:property,executeInEditMode:executeInEditMode,requireComponent:requireComponent,menu:menu,executionOrder:executionOrder,disallowMultiple:disallowMultiple,playOnFocus:playOnFocus,inspector:inspector,icon:icon,help:help,mixins:mixins,integer:integer,float:_float,boolean:_boolean,string:string,type:type}),PrefabInfo=(_dec=ccclass("cc.PrefabInfo"))((_descriptor=_applyDecoratedDescriptor((_class2=_temp=function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"root",_descriptor,this),_initializerDefineProperty(this,"asset",_descriptor2,this),_initializerDefineProperty(this,"fileId",_descriptor3,this),_initializerDefineProperty(this,"sync",_descriptor4,this),_initializerDefineProperty(this,"_synced",_descriptor5,this)}).prototype,"root",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2=_applyDecoratedDescriptor(_class2.prototype,"asset",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor3=_applyDecoratedDescriptor(_class2.prototype,"fileId",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor4=_applyDecoratedDescriptor(_class2.prototype,"sync",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor5=_applyDecoratedDescriptor(_class2.prototype,"_synced",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),_class=_class2))||_class;cc._PrefabInfo=PrefabInfo;var _temp_vec3_1=new Vec3;function WorldNode3DToLocalNodeUI(e,t,i,r){r=r||new Vec3,e.worldToScreen(t,_temp_vec3_1),_temp_vec3_1.x=_temp_vec3_1.x/cc.view.getScaleX(),_temp_vec3_1.y=_temp_vec3_1.y/cc.view.getScaleY();var n=i.getComponent("cc.UITransformComponent");if(!n)return r;n.convertToNodeSpaceAR(_temp_vec3_1,r);var s=i.getPosition();return r.add(s),r}function WorldNode3DToWorldNodeUI(e,t,i){return i=i||new Vec3,e.worldToScreen(t,i),i.x=i.x/cc.view.getScaleX(),i.y=i.y/cc.view.getScaleY(),i}var convertUtils={WorldNode3DToLocalNodeUI:WorldNode3DToLocalNodeUI,WorldNode3DToWorldNodeUI:WorldNode3DToWorldNodeUI};cc.pipelineUtils=convertUtils;var Destroyed=1,RealDestroyed=2,ToDestroy=4,DontSave=8,EditorOnly=16,Dirty=32,DontDestroy=64,Destroying=128,Deactivating=256,LockedInEditor=512,HideInHierarchy=1024,IsOnEnableCalled=2048,IsEditorOnEnableCalled=4096,IsPreloadStarted=8192,IsOnLoadCalled=16384,IsOnLoadStarted=32768,IsStartCalled=65536,IsRotationLocked=1<<17,IsScaleLocked=1<<18,IsAnchorLocked=1<<19,IsSizeLocked=1<<20,IsPositionLocked=1<<21,PersistentMask=~(ToDestroy|Dirty|Destroying|DontDestroy|Deactivating|IsPreloadStarted|IsOnLoadStarted|IsOnLoadCalled|IsStartCalled|IsOnEnableCalled|IsEditorOnEnableCalled|IsRotationLocked|IsScaleLocked|IsAnchorLocked|IsSizeLocked|IsPositionLocked),objectsToDestroy=[],deferredDestroyTimer=null;function compileDestruct(e,t){var i,r=e instanceof cc._BaseNode||e instanceof cc.Component,n=r?"_id":null,s={};for(i in e)if(e.hasOwnProperty(i)){if(i===n)continue;switch(_typeof(e[i])){case"string":s[i]="";break;case"object":case"function":s[i]=null}}if(CCClass._isCCClass(t))for(var a=cc.Class.Attr.getClassAttrs(t),o=t.__props__,c=0;c<o.length;c++){var l=(i=o[c])+cc.Class.Attr.DELIMETER+"default";if(l in a){if(r&&"_id"===i)continue;switch(_typeof(a[l])){case"string":s[i]="";break;case"object":case"function":s[i]=null;break;case"undefined":s[i]=void 0}}}return function(e){for(var t in s)e[t]=s[t]}}var CCObject=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";_classCallCheck(this,t),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}return _createClass(t,null,[{key:"_deferredDestroy",value:function(){for(var e=objectsToDestroy.length,t=0;t<e;++t){var i=objectsToDestroy[t];i._objFlags&Destroyed||i._destroyImmediate()}e===objectsToDestroy.length?objectsToDestroy.length=0:objectsToDestroy.splice(0,e)}}]),_createClass(t,[{key:"destroy",value:function(){return this._objFlags&Destroyed?(cc.warnID(5e3),!1):!(this._objFlags&ToDestroy)&&(this._objFlags|=ToDestroy,objectsToDestroy.push(this),!0)}},{key:"_destruct",value:function(){var e=this.constructor,t=e.__destruct__;t||(t=compileDestruct(this,e),value(e,"__destruct__",t,!0)),t(this)}},{key:"_destroyImmediate",value:function(){this._objFlags&Destroyed?cc.errorID(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=Destroyed)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"isValid",get:function(){return!(this._objFlags&Destroyed)}}]),t}(),prototype=CCObject.prototype;function isValid(e,t){return"object"===_typeof(e)?!(!e||e._objFlags&(t?Destroyed|ToDestroy:Destroyed)):void 0!==e}prototype._deserialize=null,prototype._onPreDestroy=null,CCClass.fastDefine("cc.Object",CCObject,{_name:"",_objFlags:0}),value(CCObject,"Flags",{Destroyed:Destroyed,DontSave:DontSave,EditorOnly:EditorOnly,Dirty:Dirty,DontDestroy:DontDestroy,PersistentMask:PersistentMask,Destroying:Destroying,Deactivating:Deactivating,LockedInEditor:LockedInEditor,HideInHierarchy:HideInHierarchy,IsPreloadStarted:IsPreloadStarted,IsOnLoadStarted:IsOnLoadStarted,IsOnLoadCalled:IsOnLoadCalled,IsOnEnableCalled:IsOnEnableCalled,IsStartCalled:IsStartCalled,IsEditorOnEnableCalled:IsEditorOnEnableCalled,IsPositionLocked:IsPositionLocked,IsRotationLocked:IsRotationLocked,IsScaleLocked:IsScaleLocked,IsAnchorLocked:IsAnchorLocked,IsSizeLocked:IsSizeLocked}),cc.isValid=isValid,cc.Object=CCObject;var Details=function(){function e(){_classCallCheck(this,e),this.assignAssetsBy=void 0,this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=createMap(!0)}return _createClass(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,clear(this._stillUseUrl)}},{key:"push",value:function(e,t,i,r){r&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(i),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();function _dereference(e){var t,i,r,n=e.deserializedList,s=e._idPropList,a=e._idList,o=e._idObjList;e._classFinder&&e._classFinder.onDereferenced;for(t=0;t<a.length;t++)i=s[t],r=a[t],o[t][i]=n[r]}function compileObjectTypeJit(e,t,i,r,n,s){if(t instanceof cc.ValueType){n||e.push("if(prop){");var a=getClassName(t);e.push("s._deserializeTypedObject(o".concat(i,",prop,").concat(a,");")),n||e.push("}else o"+i+"=null;")}else e.push("if(prop){"),e.push("s._deserializeObjField(o,prop,"+r+",null,"+!!s+");"),e.push("}else o"+i+"=null;")}Details.pool=void 0,Details.pool=new Pool(function(e){e.reset()},10),Details.pool.get=function(){return this._get()||new Details};var compileDeserialize=function(e,d){var f,m=BUILTIN_CLASSID_RE.test(_getClassId(d)),h=cc.js.isChildClassOf(d,cc._BaseNode)||cc.js.isChildClassOf(d,cc.Component),y=[],v=y,g=[],b=g,x=[],T=[];return function(){var e=d.__values__;f="_$erialized"===e[e.length-1];for(var t=getClassAttrs(d),i=DELIMETER+"type",r=DELIMETER+"default",n=DELIMETER+"saveUrlAsAsset",s=DELIMETER+"formerlySerializedAs",a=0;a<e.length;a++){var o=e[a],c=o;t[o+s]&&(c=t[o+s]);var l=t[o+n],u=CCClass.getDefault(t[o+r]),h=!1;if(m){var _=t[o+i];if(void 0===u&&_)h=_===cc.String||_===cc.Integer||_===cc.Float||_===cc.Boolean;else{var p=_typeof(u);h="string"===p&&!l||"number"===p||"boolean"===p}}m&&h?(c!==o&&v===y&&(v=y.slice()),y.push(o),v!==y&&v.push(c)):(c!==o&&b===g&&(b=g.slice()),g.push(o),b!==g&&b.push(c),x.push(l),T.push(u instanceof cc.ValueType&&u.constructor))}}(),function(e,t,i,r,n){for(var s=0;s<y.length;++s){var a=i[v[s]];void 0!==a&&(t[y[s]]=a)}for(var o=0;o<g.length;++o){var c=g[o],l=i[b[o]];if(void 0!==l)if(m||"object"===_typeof(l)){var u=T[o];u?m||l?e._deserializeTypedObject(t[c],l,u):t[c]=null:l?e._deserializeObjField(t,l,c,null,x[o]):t[c]=null}else t[c]=l}h&&i._id&&(t._id=i._id),f&&(t._$erialized=JSON.parse(JSON.stringify(i)),e._deserializePrimitiveObject(t._$erialized,i))}};function unlinkUnusedPrefab(e,t,i){var r=t.asset&&t.asset.__uuid__;if(r){var n=e.result.uuidList.length-1;if(e.result.uuidList[n]===r&&e.result.uuidObjList[n]===i&&"asset"===e.result.uuidPropList[n])e.result.uuidList.pop(),e.result.uuidObjList.pop(),e.result.uuidPropList.pop();else{cc.warn("Failed to skip prefab asset while deserializing PrefabInfo")}}}function _deserializeFireClass(e,t,i,r,n){var s;r.hasOwnProperty("__deserialize__")?s=r.__deserialize__:(s=compileDeserialize(e,r),value(r,"__deserialize__",s,!0)),s(e,t,i,r,n),t.__postDeserialize&&t.__postDeserialize()}var _Deserializer=function(){function s(e,t,i,r,n){_classCallCheck(this,s),this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=e,this.customEnv=r,this.deserializedList=[],this.deserializedData=null,this._classFinder=i,this._idList=[],this._idObjList=[],this._idPropList=[]}return _createClass(s,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,i=t.length;this.deserializedList.length=i;for(var r=0;r<i;r++){if(t[r])this.deserializedList[r]=this._deserializeObject(t[r],!1)}this.deserializedData=0<i?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return _dereference(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,t,i,r,n){var s,a=null,o=null,c=e.__type__;if("TypedArray"===c){var l=e.array;a=new window[e.ctor](l.length);for(var u=0;u<l.length;++u)a[u]=l[u];return a}if(c){var h=function(){(a=new o)._deserialize?a._deserialize(e.content,_):cc.Class._isCCClass(o)?_deserializeFireClass(_,a,e,o,i):_._deserializeTypedObject(a,e,o)};if(!(o=this._classFinder(c,e,r,n)))return this._classFinder===_getClassById&&cc.deserialize.reportMissingClass(c),null;var _=this;h()}else if(Array.isArray(e)){a=new Array(e.length);for(var p=0;p<e.length;p++)"object"===_typeof(s=e[p])&&s?this._deserializeObjField(a,s,""+p,null,t):a[p]=s}else a={},this._deserializePrimitiveObject(a,e);return a}},{key:"_deserializeObjField",value:function(e,t,i,r,n){var s=t.__id__;if(void 0===s){var a=t.__uuid__;a?this.result.push(e,i,a,n):e[i]=this._deserializeObject(t,n)}else{var o=this.deserializedList[s];o?e[i]=o:(this._idList.push(s),this._idObjList.push(e),this._idPropList.push(i))}}},{key:"_deserializePrimitiveObject",value:function(e,t){for(var i in t)if(t.hasOwnProperty(i)){var r=t[i];"object"!==_typeof(r)?"__type__"!==i&&(e[i]=r):r?this._deserializeObjField(e,r,i):e[i]=null}}},{key:"_deserializeTypedObject",value:function(e,t,i){if(i===cc.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(i===cc.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(i!==cc.Color){if(i===cc.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var r=DELIMETER+"default",n=getClassAttrs(i),s=i.__props__||Object.keys(e),a=0;a<s.length;a++){var o=s[a],c=t[o];void 0!==c&&t.hasOwnProperty(o)||(c=CCClass.getDefault(n[o+r])),"object"!==_typeof(c)?e[o]=c:c?this._deserializeObjField(e,c,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var l=t.a;e.a=void 0===l?255:l}}}]),s}();function deserialize(e,t,i){var r=(i=i||{}).classFinder||_getClassById,n=i.createAssetRefs||cc.sys.platform===cc.sys.EDITOR_CORE,s=i.customEnv,a=i.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var o=!t;t=t||Details.pool.get();var c=_Deserializer.pool.get(t,!1,r,s,a);cc.game._isCloning=!0;var l=c.deserialize(e);return cc.game._isCloning=!1,_Deserializer.pool.put(c),n&&t.assignAssetsBy(Editor.serialize.asAsset),o&&Details.pool.put(t),l}_Deserializer.pool=void 0,_Deserializer.pool=new Pool(function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0},1),_Deserializer.pool.get=function(e,t,i,r,n){var s=this._get();return s?(s.result=e,s.customEnv=r,s._classFinder=i,s):new _Deserializer(e,t,i,r,n)},deserialize.Details=Details,deserialize.reportMissingClass=function(e){cc.warnID(5302,e)},cc.deserialize=deserialize;var _dec$1,_class$1,_class2$1,_descriptor$1,_descriptor2$1,_descriptor3$1,_descriptor4$1,_class3,_temp$1,_BuiltinElementTypeTr,StorageUnit,ElementType,Destroyed$1=CCObject.Flags.Destroyed,PersistentMask$1=CCObject.Flags.PersistentMask,objsToClearTmpVar=[];function instantiate(e,t){if(!t){if("object"!==_typeof(e)||Array.isArray(e))return null;if(!e)return null;if(!cc.isValid(e))return null;0}var i;if(e instanceof CCObject){if((e=e)._instantiate)return cc.game._isCloning=!0,i=e._instantiate(),cc.game._isCloning=!1,i;if(e instanceof cc.Asset)return null}return cc.game._isCloning=!0,i=doInstantiate(e),cc.game._isCloning=!1,i}function doInstantiate(e,t){if(Array.isArray(e))return null;if(isDomNode&&isDomNode(e))return null;var i;if(e._iN$t)i=e._iN$t;else if(e.constructor){i=new e.constructor}else i=Object.create(null);enumerateObject(e,i,t);for(var r=0,n=objsToClearTmpVar.length;r<n;++r)objsToClearTmpVar[r]._iN$t=null;return objsToClearTmpVar.length=0,i}function enumerateCCClass(e,t,i,r){for(var n=e.__values__,s=0;s<n.length;s++){var a=n[s],o=t[a];if("object"===_typeof(o)&&o){var c=i[a];c instanceof ValueType&&c.constructor===o.constructor?c.set(o):i[a]=o._iN$t||instantiateObj(o,r)}else i[a]=o}}function enumerateObject(e,t,i){value(e,"_iN$t",t,!0),objsToClearTmpVar.push(e);var r=e.constructor;if(cc.Class._isCCClass(r))enumerateCCClass(r,e,t,i);else for(var n in e)if(e.hasOwnProperty(n)&&(95!==n.charCodeAt(0)||95!==n.charCodeAt(1)||"__type__"===n)){var s=e[n];if("object"===_typeof(s)&&s){if(s===t)continue;t[n]=s._iN$t||instantiateObj(s,i)}else t[n]=s}e instanceof CCObject&&(t._objFlags&=PersistentMask$1)}function instantiateObj(e,t){if(e instanceof ValueType)return e.clone();if(e instanceof cc.Asset)return e;var i;if(Array.isArray(e)){var r=e.length;i=new Array(r),e._iN$t=i;for(var n=0;n<r;++n){var s=e[n];"object"===_typeof(s)&&s?i[n]=s._iN$t||instantiateObj(s,t):i[n]=s}return objsToClearTmpVar.push(e),i}if(e._objFlags&Destroyed$1)return null;var a=e.constructor;if(cc.Class._isCCClass(a)){if(t)if(t instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return e}else if(t instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof cc.Component&&!e.node.isChildOf(t))return e;i=new a}else if(a===Object)i={};else{if(a)return e;i=Object.create(null)}return enumerateObject(e,i,t),i}instantiate._clone=doInstantiate,cc.instantiate=instantiate,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(StorageUnit=StorageUnit||{}),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat"}(ElementType=ElementType||{});var elementTypeBits=3;function combineStorageUnitElementType(e,t){return(t<<elementTypeBits)+e}function extractStorageUnitElementType(e){return{storageUnit:~(-1<<elementTypeBits)&e,elementType:e>>elementTypeBits}}var CompactValueTypeArray=(_dec$1=ccclass("cc.CompactValueTypeArray"))((_temp$1=_class3=function(){function _(){_classCallCheck(this,_),_initializerDefineProperty(this,"_byteOffset",_descriptor$1,this),_initializerDefineProperty(this,"_unitCount",_descriptor2$1,this),_initializerDefineProperty(this,"_unitElement",_descriptor3$1,this),_initializerDefineProperty(this,"_length",_descriptor4$1,this)}return _createClass(_,[{key:"decompress",value:function(e){for(var t=extractStorageUnitElementType(this._unitElement),i=t.storageUnit,r=getElementTraits(t.elementType),n=new(getStorageConstructor(i))(e,this._byteOffset,this._unitCount),s=new Array(this._length),a=0;a<this._length;++a)s[a]=r.decompress(n,a);return s}}],[{key:"lengthFor",value:function(e,t,i){return getElementTraits(t).requiredUnits*e.length*getStorageConstructor(i).BYTES_PER_ELEMENT}},{key:"compress",value:function(e,t,i,r,n,s){for(var a=getElementTraits(t),o=getStorageConstructor(i),c=a.requiredUnits*e.length,l=new o(r,n,c),u=0;u<e.length;++u)a.compress(l,u,e[u]);var h=new _;return h._unitElement=combineStorageUnitElementType(i,t),h._byteOffset=s,h._unitCount=c,h._length=e.length,h}}]),_}(),_class3.StorageUnit=StorageUnit,_class3.ElementType=ElementType,_descriptor$1=_applyDecoratedDescriptor((_class2$1=_temp$1).prototype,"_byteOffset",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor2$1=_applyDecoratedDescriptor(_class2$1.prototype,"_unitCount",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor3$1=_applyDecoratedDescriptor(_class2$1.prototype,"_unitElement",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return combineStorageUnitElementType(StorageUnit.Uint8,ElementType.Scalar)}}),_descriptor4$1=_applyDecoratedDescriptor(_class2$1.prototype,"_length",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_class$1=_class2$1))||_class$1;function getElementTraits(e){return BuiltinElementTypeTraits[e]}function getStorageConstructor(e){switch(e){case StorageUnit.Uint8:return Uint8Array;case StorageUnit.Uint16:return Uint16Array;case StorageUnit.Uint32:return Uint32Array;case StorageUnit.Int8:return Int8Array;case StorageUnit.Int16:return Int16Array;case StorageUnit.Int32:return Int32Array;case StorageUnit.Float32:return Float32Array;case StorageUnit.Float64:return Float64Array}}var BuiltinElementTypeTraits=(_defineProperty(_BuiltinElementTypeTr={},ElementType.Scalar,{requiredUnits:1,compress:function(e,t,i){e[t]=i},decompress:function(e,t){return e[t]}}),_defineProperty(_BuiltinElementTypeTr,ElementType.Vec2,{requiredUnits:2,compress:function(e,t,i){e[2*t]=i.x,e[2*t+1]=i.y},decompress:function(e,t){return new Vec3(e[2*t],e[2*t+1])}}),_defineProperty(_BuiltinElementTypeTr,ElementType.Vec3,{requiredUnits:3,compress:function(e,t,i){e[3*t]=i.x,e[3*t+1]=i.y,e[3*t+2]=i.z},decompress:function(e,t){return new Vec3(e[3*t],e[3*t+1],e[3*t+2])}}),_defineProperty(_BuiltinElementTypeTr,ElementType.Vec4,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new Vec4(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),_defineProperty(_BuiltinElementTypeTr,ElementType.Quat,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new Quat(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),_BuiltinElementTypeTr);cc._decorator=_decorator;var Event=function(){function i(e,t){_classCallCheck(this,i),this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}return _createClass(i,[{key:"unuse",value:function(){this.type=i.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=i.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),i}();Event.NO_TYPE="no_type",Event.TOUCH="touch",Event.MOUSE="mouse",Event.KEYBOARD="keyboard",Event.ACCELERATION="acceleration",Event.NONE=0,Event.CAPTURING_PHASE=1,Event.AT_TARGET=2,Event.BUBBLING_PHASE=3,cc.Event=Event;var fastRemoveAt$1=array.fastRemoveAt;function empty(){}var CallbackInfo=function(){function e(){_classCallCheck(this,e),this.callback=empty,this.target=void 0,this.once=!1}return _createClass(e,[{key:"set",value:function(e,t,i){this.callback=e,this.target=t,this.once=!!i}}]),e}(),callbackInfoPool=new Pool$1(function(){return new CallbackInfo},32),CallbackList=function(){function e(){_classCallCheck(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return _createClass(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(callbackInfoPool.free(i),fastRemoveAt$1(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(callbackInfoPool.free(i),fastRemoveAt$1(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(callbackInfoPool.free(t),this.callbackInfos[e]=null),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(callbackInfoPool.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;0<=e;--e){this.callbackInfos[e]||fastRemoveAt$1(this.callbackInfos,e)}this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),MAX_SIZE=16,callbackListPool=new Pool$1(function(){return new CallbackList},MAX_SIZE),CallbacksInvoker=function(){function e(){_classCallCheck(this,e),this._callbackTable=createMap(!0)}return _createClass(e,[{key:"on",value:function(e,t,i,r){var n=this._callbackTable[e];n=n||(this._callbackTable[e]=callbackListPool.alloc());var s=callbackInfoPool.alloc();s.set(t,i,r),n.callbackInfos.push(s)}},{key:"hasEventListener",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:null,n=this._callbackTable[e];if(!n)return!1;var s=n.callbackInfos;if(!t){if(n.isInvoking){var a=s,o=Array.isArray(a),c=0;for(a=o?a:a[Symbol.iterator]();;){var l;if(o){if(c>=a.length)break;l=a[c++]}else{if((c=a.next()).done)break;l=c.value}if(l)return!0}return!1}return 0<s.length}var u=s,h=Array.isArray(u),_=0;for(u=h?u:u[Symbol.iterator]();;){var p;if(h){if(_>=u.length)break;p=u[_++]}else{if((_=u.next()).done)break;p=_.value}var d=p;if(d&&d.callback===t&&d.target===r)return!0}return!1}},{key:"removeAll",value:function(e){if("string"==typeof e){var t=this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),callbackListPool.free(t),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var n=r.callbackInfos,s=0;s<n.length;++s){var a=n[s];a&&a.target===e&&r.cancel(s)}else r.removeByTarget(e)}}},{key:"off",value:function(e,t,i){var r=this._callbackTable[e];if(r){var n=r.callbackInfos;if(t)for(var s=0;s<n.length;++s){var a=n[s];if(a&&a.callback===t&&a.target===i){r.isInvoking?r.cancel(s):(fastRemoveAt$1(n,s),callbackInfoPool.free(a));break}}else this.removeAll(e)}}},{key:"emit",value:function(e){var t=this._callbackTable[e];if(t){var i=!t.isInvoking;t.isInvoking=!0;for(var r=t.callbackInfos,n=arguments.length,s=new Array(1<n?n-1:0),a=1;a<n;a++)s[a-1]=arguments[a];for(var o=0,c=r.length;o<c;++o){var l=r[o];if(l){var u=l.callback,h=l.target;l.once&&this.off(e,u,h),h?u.call.apply(u,[h].concat(s)):u.apply(void 0,s)}}i&&(t.isInvoking=!1,t.containCanceled&&t.purgeCanceled())}}}]),e}();var fastRemove$1=array.fastRemove,EventTarget=function(){function n(){return _classCallCheck(this,n),_possibleConstructorReturn(this,_getPrototypeOf(n).apply(this,arguments))}return _inherits(n,CallbacksInvoker),_createClass(n,[{key:"on",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){_get(_getPrototypeOf(n.prototype),"on",this).call(this,e,t,i);var r=i;i&&(r.__eventTargets?r.__eventTargets.push(this):r.node&&r.node.__eventTargets&&r.node.__eventTargets.push(this))}return t}cc.errorID(6800)}},{key:"off",value:function(e,t,i){if(t){_get(_getPrototypeOf(n.prototype),"off",this).call(this,e,t,i);var r=i;i&&(r.__eventTargets?fastRemove$1(r.__eventTargets,this):r.node&&r.node.__eventTargets&&fastRemove$1(r.node.__eventTargets,this))}else this.removeAll(e)}},{key:"targetOff",value:function(e){this.removeAll(e)}},{key:"once",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){_get(_getPrototypeOf(n.prototype),"on",this).call(this,e,t,i,!0);var r=i;i&&(r.__eventTargets?r.__eventTargets.push(this):r.node&&r.node.__eventTargets&&r.node.__eventTargets.push(this))}return t}cc.errorID(6800)}}]),n}();cc.EventTarget=EventTarget;var platform,w,h,ratio,capabilities,_env,_w2,_h2,_ratio2,win,nav,doc,docEle,ua,currLanguage,isAndroid,iOS,osVersion,osMainVersion,uaResult,osName,_w3,_h3,_ratio3,_tmpCanvas1,create3DContext,localStorage,warn$1,_supportWebp,_supportCanvas,_supportWebGL,browserVer,_capabilities,__audioSupport,formatSupport,sys={};sys.LANGUAGE_ENGLISH="en",sys.LANGUAGE_CHINESE="zh",sys.LANGUAGE_FRENCH="fr",sys.LANGUAGE_ITALIAN="it",sys.LANGUAGE_GERMAN="de",sys.LANGUAGE_SPANISH="es",sys.LANGUAGE_DUTCH="du",sys.LANGUAGE_RUSSIAN="ru",sys.LANGUAGE_KOREAN="ko",sys.LANGUAGE_JAPANESE="ja",sys.LANGUAGE_HUNGARIAN="hu",sys.LANGUAGE_PORTUGUESE="pt",sys.LANGUAGE_ARABIC="ar",sys.LANGUAGE_NORWEGIAN="no",sys.LANGUAGE_POLISH="pl",sys.LANGUAGE_TURKISH="tr",sys.LANGUAGE_UKRAINIAN="uk",sys.LANGUAGE_ROMANIAN="ro",sys.LANGUAGE_BULGARIAN="bg",sys.LANGUAGE_UNKNOWN="unknown",sys.OS_IOS="iOS",sys.OS_ANDROID="Android",sys.OS_WINDOWS="Windows",sys.OS_MARMALADE="Marmalade",sys.OS_LINUX="Linux",sys.OS_BADA="Bada",sys.OS_BLACKBERRY="Blackberry",sys.OS_OSX="OS X",sys.OS_WP8="WP8",sys.OS_WINRT="WINRT",sys.OS_UNKNOWN="Unknown",sys.UNKNOWN=-1,sys.WIN32=0,sys.LINUX=1,sys.MACOS=2,sys.ANDROID=3,sys.IPHONE=4,sys.IPAD=5,sys.BLACKBERRY=6,sys.NACL=7,sys.EMSCRIPTEN=8,sys.TIZEN=9,sys.WINRT=10,sys.WP8=11,sys.MOBILE_BROWSER=100,sys.DESKTOP_BROWSER=101,sys.EDITOR_PAGE=102,sys.EDITOR_CORE=103,sys.WECHAT_GAME=104,sys.QQ_PLAY=105,sys.BROWSER_TYPE_WECHAT="wechat",sys.BROWSER_TYPE_WECHAT_GAME="wechatgame",sys.BROWSER_TYPE_WECHAT_GAME_SUB="wechatgamesub",sys.BROWSER_TYPE_QQ_PLAY="qqplay",sys.BROWSER_TYPE_ANDROID="androidbrowser",sys.BROWSER_TYPE_IE="ie",sys.BROWSER_TYPE_QQ="qqbrowser",sys.BROWSER_TYPE_MOBILE_QQ="mqqbrowser",sys.BROWSER_TYPE_UC="ucbrowser",sys.BROWSER_TYPE_UCBS="ucbs",sys.BROWSER_TYPE_360="360browser",sys.BROWSER_TYPE_BAIDU_APP="baiduboxapp",sys.BROWSER_TYPE_BAIDU="baidubrowser",sys.BROWSER_TYPE_MAXTHON="maxthon",sys.BROWSER_TYPE_OPERA="opera",sys.BROWSER_TYPE_OUPENG="oupeng",sys.BROWSER_TYPE_MIUI="miuibrowser",sys.BROWSER_TYPE_FIREFOX="firefox",sys.BROWSER_TYPE_SAFARI="safari",sys.BROWSER_TYPE_CHROME="chrome",sys.BROWSER_TYPE_LIEBAO="liebao",sys.BROWSER_TYPE_QZONE="qzone",sys.BROWSER_TYPE_SOUGOU="sogou",sys.BROWSER_TYPE_UNKNOWN="unknown",sys.isNative=!1,sys.isBrowser="object"===("undefined"==typeof window?"undefined":_typeof(window))&&"object"===("undefined"==typeof document?"undefined":_typeof(document))&&!1,sys.isLittleEndian=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}();var env=wx.getSystemInfoSync();sys.isMobile=!0,sys.platform=sys.WECHAT_GAME,sys.language=env.language.substr(0,2);var system=env.system.toLowerCase();"android"===env.platform?sys.os=sys.OS_ANDROID:"ios"===env.platform?sys.os=sys.OS_IOS:"devtools"===env.platform&&(sys.isMobile=!1,-1<system.indexOf("android")?sys.os=sys.OS_ANDROID:-1<system.indexOf("ios")&&(sys.os=sys.OS_IOS)),"android p"===system&&(system="android p 9.0");var version=/[\d\.]+/.exec(system);sys.osVersion=version?version[0]:system,sys.osMainVersion=parseInt(sys.osVersion),wx.getFileSystemManager?sys.browserType=sys.BROWSER_TYPE_WECHAT_GAME:sys.browserType=sys.BROWSER_TYPE_WECHAT_GAME_SUB,sys.browserVersion=env.version;var _w$3=env.windowWidth,_h$1=env.windowHeight,_ratio=env.pixelRatio||1;sys.windowPixelResolution={width:_ratio*_w$3,height:_ratio*_h$1},sys.localStorage=window.localStorage,sys.capabilities={canvas:!0,opengl:sys.browserType!==sys.BROWSER_TYPE_WECHAT_GAME_SUB,webp:!1},sys.__audioSupport={ONLY_ONE:!1,WEB_AUDIO:!1,DELAY_CREATE_CTX:!1,format:[".mp3"]},sys.NetworkType={NONE:0,LAN:1,WWAN:2},sys.getNetworkType=function(){return sys.NetworkType.LAN},sys.getBatteryLevel=function(){return 1},sys.garbageCollect=function(){},sys.dumpRoot=function(){},sys.restartVM=function(){},sys.cleanScript=function(e){},sys.isObjectValid=function(e){return!!e},sys.dump=function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",e+="Using "+(cc.game.renderType===cc.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n",cc.log(e)},sys.openURL=function(e){window.open(e)},sys.now=function(){return Date.now?Date.now():+new Date},cc.sys=sys;var SUPPORT_TEXTURE_FORMATS=[".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY={none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},ImageFormat=cc.Enum({JPG:0,PNG:1,TIFF:2,WEBP:3,PVR:4,ETC:5,S3TC:6,ATITC:7,TGA:8,RAWDATA:9,UNKNOWN:10}),macro={SUPPORT_TEXTURE_FORMATS:SUPPORT_TEXTURE_FORMATS,KEY:KEY,ImageFormat:ImageFormat,RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,MIN_ZINDEX:-Math.pow(2,15),MAX_ZINDEX:Math.pow(2,15)-1,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,DENSITYDPI_DEVICE:"device-dpi",DENSITYDPI_HIGH:"high-dpi",DENSITYDPI_MEDIUM:"medium-dpi",DENSITYDPI_LOW:"low-dpi",FIX_ARTIFACTS_BY_STRECHING_TEXEL_TMX:!0,DIRECTOR_STATS_POSITION:new Vec2(0,0),ENABLE_STACKABLE_ACTIONS:!0,TOUCH_TIMEOUT:5e3,BATCH_VERTEX_COUNT:2e4,ENABLE_TILEDMAP_CULLING:!0,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,ENABLE_CULLING:!1,CLEANUP_IMAGE_CACHE:!1,SHOW_MESH_WIREFRAME:!1};cc.macro=macro;var visibleRect={topLeft:cc.v2(0,0),topRight:cc.v2(0,0),top:cc.v2(0,0),bottomLeft:cc.v2(0,0),bottomRight:cc.v2(0,0),bottom:cc.v2(0,0),center:cc.v2(0,0),left:cc.v2(0,0),right:cc.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,r=e.x,n=e.y,s=n+i,a=r+t;this.topLeft.x=r,this.topLeft.y=s,this.topRight.x=a,this.topRight.y=s,this.top.x=r+t/2,this.top.y=s,this.bottomLeft.x=r,this.bottomLeft.y=n,this.bottomRight.x=a,this.bottomRight.y=n,this.bottom.x=r+t/2,this.bottom.y=n,this.center.x=r+t/2,this.center.y=n+i/2,this.left.x=r,this.left.y=n+i/2,this.right.x=a,this.right.y=n+i/2}};function constant(){return 0}function linear(e){return e}function quadIn(e){return e*e}function quadOut(e){return e*(2-e)}function quadInOut(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function cubicIn(e){return e*e*e}function cubicOut(e){return--e*e*e+1}function cubicInOut(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function quartIn(e){return e*e*e*e}function quartOut(e){return 1- --e*e*e*e}function quartInOut(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function quintIn(e){return e*e*e*e*e}function quintOut(e){return--e*e*e*e*e+1}function quintInOut(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function sineIn(e){return 1-Math.cos(e*Math.PI/2)}function sineOut(e){return Math.sin(e*Math.PI/2)}function sineInOut(e){return.5*(1-Math.cos(Math.PI*e))}function expoIn(e){return 0===e?0:Math.pow(1024,e-1)}function expoOut(e){return 1===e?1:1-Math.pow(2,-10*e)}function expoInOut(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function circIn(e){return 1-Math.sqrt(1-e*e)}function circOut(e){return Math.sqrt(1- --e*e)}function circInOut(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function elasticIn(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))}function elasticOut(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)}function elasticInOut(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*.5+1)}function backIn(e){return e*e*(2.70158*e-1.70158)}function backOut(e){return--e*e*(2.70158*e+1.70158)+1}function backInOut(e){var t=2.5949095;return(e*=2)<1?e*e*((1+t)*e-t)*.5:.5*((e-=2)*e*((1+t)*e+t)+2)}function bounceIn(e){return 1-bounceOut(1-e)}function bounceOut(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function bounceInOut(e){return e<.5?.5*bounceIn(2*e):.5*bounceOut(2*e-1)+.5}function smooth(e){return e<=0?0:1<=e?1:e*e*(3-2*e)}function fade(e){return e<=0?0:1<=e?1:e*e*e*(e*(6*e-15)+10)}cc.visibleRect=visibleRect;var quadOutIn=_makeOutIn(quadIn,quadOut),cubicOutIn=_makeOutIn(cubicIn,cubicOut),quartOutIn=_makeOutIn(quartIn,quartOut),quintOutIn=_makeOutIn(quintIn,quintOut),sineOutIn=_makeOutIn(sineIn,sineOut),expoOutIn=_makeOutIn(expoIn,expoOut),circOutIn=_makeOutIn(circIn,circOut),backOutIn=_makeOutIn(backIn,backOut),bounceOutIn=_makeOutIn(bounceIn,bounceOut);function _makeOutIn(t,i){return function(e){return e<.5?i(2*e)/2:t(2*e-1)/2+.5}}var easing=Object.freeze({constant:constant,linear:linear,quadIn:quadIn,quadOut:quadOut,quadInOut:quadInOut,cubicIn:cubicIn,cubicOut:cubicOut,cubicInOut:cubicInOut,quartIn:quartIn,quartOut:quartOut,quartInOut:quartInOut,quintIn:quintIn,quintOut:quintOut,quintInOut:quintInOut,sineIn:sineIn,sineOut:sineOut,sineInOut:sineInOut,expoIn:expoIn,expoOut:expoOut,expoInOut:expoInOut,circIn:circIn,circOut:circOut,circInOut:circInOut,elasticIn:elasticIn,elasticOut:elasticOut,elasticInOut:elasticInOut,backIn:backIn,backOut:backOut,backInOut:backInOut,bounceIn:bounceIn,bounceOut:bounceOut,bounceInOut:bounceInOut,smooth:smooth,fade:fade,quadOutIn:quadOutIn,cubicOutIn:cubicOutIn,quartOutIn:quartOutIn,quintOutIn:quintOutIn,sineOutIn:sineOutIn,expoOutIn:expoOutIn,circOutIn:circOutIn,backOutIn:backOutIn,bounceOutIn:bounceOutIn}),GFX_MAX_VERTEX_ATTRIBUTES=16,GFX_MAX_TEXTURE_UNITS=16,GFX_MAX_ATTACHMENTS=4,GFX_MAX_BUFFER_BINDINGS=24;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BUFFER=1]="BUFFER",e[e.TEXTURE=2]="TEXTURE",e[e.TEXTURE_VIEW=3]="TEXTURE_VIEW",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=9]="PIPELINE_STATE",e[e.BINDING_LAYOUT=10]="BINDING_LAYOUT",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COMMAND_ALLOCATOR=12]="COMMAND_ALLOCATOR",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.WINDOW=15]="WINDOW"}(exports.GFXObjectType||(exports.GFXObjectType={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(exports.GFXStatus||(exports.GFXStatus={}));var GFXObject=function(){function t(e){_classCallCheck(this,t),this._gfxType=exports.GFXObjectType.UNKNOWN,this._status=exports.GFXStatus.UNREADY,this._gfxType=e}return _createClass(t,[{key:"gfxType",get:function(){return this._gfxType}},{key:"status",get:function(){return this._status}}]),t}();!function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(exports.GFXAttributeName||(exports.GFXAttributeName={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.COUNT=32]="COUNT"}(exports.GFXType||(exports.GFXType={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.SRGB8_A8=36]="SRGB8_A8",e[e.RGBA8SN=37]="RGBA8SN",e[e.RGBA8UI=38]="RGBA8UI",e[e.RGBA8I=39]="RGBA8I",e[e.RGBA16F=40]="RGBA16F",e[e.RGBA16UI=41]="RGBA16UI",e[e.RGBA16I=42]="RGBA16I",e[e.RGBA32F=43]="RGBA32F",e[e.RGBA32UI=44]="RGBA32UI",e[e.RGBA32I=45]="RGBA32I",e[e.R5G6B5=46]="R5G6B5",e[e.R11G11B10F=47]="R11G11B10F",e[e.RGB5A1=48]="RGB5A1",e[e.RGBA4=49]="RGBA4",e[e.RGB10A2=50]="RGB10A2",e[e.RGB10A2UI=51]="RGB10A2UI",e[e.RGB9E5=52]="RGB9E5",e[e.D16=53]="D16",e[e.D16S8=54]="D16S8",e[e.D24=55]="D24",e[e.D24S8=56]="D24S8",e[e.D32F=57]="D32F",e[e.D32F_S8=58]="D32F_S8",e[e.BC1=59]="BC1",e[e.BC1_ALPHA=60]="BC1_ALPHA",e[e.BC1_SRGB=61]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=62]="BC1_SRGB_ALPHA",e[e.BC2=63]="BC2",e[e.BC2_SRGB=64]="BC2_SRGB",e[e.BC3=65]="BC3",e[e.BC3_SRGB=66]="BC3_SRGB",e[e.BC4=67]="BC4",e[e.BC4_SNORM=68]="BC4_SNORM",e[e.BC5=69]="BC5",e[e.BC5_SNORM=70]="BC5_SNORM",e[e.BC6H_UF16=71]="BC6H_UF16",e[e.BC6H_SF16=72]="BC6H_SF16",e[e.BC7=73]="BC7",e[e.BC7_SRGB=74]="BC7_SRGB",e[e.ETC_RGB8=75]="ETC_RGB8",e[e.ETC2_RGB8=76]="ETC2_RGB8",e[e.ETC2_SRGB8=77]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=78]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=79]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=80]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=81]="ETC2_SRGB8_A8",e[e.EAC_R11=82]="EAC_R11",e[e.EAC_R11SN=83]="EAC_R11SN",e[e.EAC_RG11=84]="EAC_RG11",e[e.EAC_RG11SN=85]="EAC_RG11SN",e[e.PVRTC_RGB2=86]="PVRTC_RGB2",e[e.PVRTC_RGBA2=87]="PVRTC_RGBA2",e[e.PVRTC_RGB4=88]="PVRTC_RGB4",e[e.PVRTC_RGBA4=89]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=90]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=91]="PVRTC2_4BPP"}(exports.GFXFormat||(exports.GFXFormat={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(exports.GFXBufferUsageBit||(exports.GFXBufferUsageBit={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(exports.GFXMemoryUsageBit||(exports.GFXMemoryUsageBit={})),function(e){e[e.NONE=0]="NONE",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(exports.GFXBufferFlagBit||(exports.GFXBufferFlagBit={})),function(e){e[e.NONE=0]="NONE",e[e.READ=1]="READ",e[e.WRITE=2]="WRITE"}(exports.GFXBufferAccessBit||(exports.GFXBufferAccessBit={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(exports.GFXPrimitiveMode||(exports.GFXPrimitiveMode={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(exports.GFXPolygonMode||(exports.GFXPolygonMode={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(exports.GFXShadeModel||(exports.GFXShadeModel={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(exports.GFXCullMode||(exports.GFXCullMode={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(exports.GFXComparisonFunc||(exports.GFXComparisonFunc={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(exports.GFXStencilOp||(exports.GFXStencilOp={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(exports.GFXBlendOp||(exports.GFXBlendOp={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(exports.GFXBlendFactor||(exports.GFXBlendFactor={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(exports.GFXColorMask||(exports.GFXColorMask={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(exports.GFXFilter||(exports.GFXFilter={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(exports.GFXAddress||(exports.GFXAddress={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D"}(exports.GFXTextureType||(exports.GFXTextureType={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",e[e.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(exports.GFXTextureUsageBit||(exports.GFXTextureUsageBit={})),function(e){e[e.X1=0]="X1",e[e.X2=1]="X2",e[e.X4=2]="X4",e[e.X8=3]="X8",e[e.X16=4]="X16",e[e.X32=5]="X32",e[e.X64=6]="X64"}(exports.GFXSampleCount||(exports.GFXSampleCount={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.CUBEMAP=2]="CUBEMAP",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(exports.GFXTextureFlagBit||(exports.GFXTextureFlagBit={})),function(e){e[e.TV1D=0]="TV1D",e[e.TV2D=1]="TV2D",e[e.TV3D=2]="TV3D",e[e.CUBE=3]="CUBE",e[e.TV1D_ARRAY=4]="TV1D_ARRAY",e[e.TV2D_ARRAY=5]="TV2D_ARRAY"}(exports.GFXTextureViewType||(exports.GFXTextureViewType={})),function(e){e[e.VERTEX=0]="VERTEX",e[e.HULL=1]="HULL",e[e.DOMAIN=2]="DOMAIN",e[e.GEOMETRY=3]="GEOMETRY",e[e.FRAGMENT=4]="FRAGMENT",e[e.COMPUTE=5]="COMPUTE",e[e.COUNT=6]="COUNT"}(exports.GFXShaderType||(exports.GFXShaderType={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.SAMPLER=2]="SAMPLER",e[e.STORAGE_BUFFER=3]="STORAGE_BUFFER"}(exports.GFXBindingType||(exports.GFXBindingType={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(exports.GFXCommandBufferType||(exports.GFXCommandBufferType={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(exports.GFXLoadOp||(exports.GFXLoadOp={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(exports.GFXStoreOp||(exports.GFXStoreOp={})),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.GENERAL=1]="GENERAL",e[e.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",e[e.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",e[e.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",e[e.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",e[e.PREINITIALIZED=8]="PREINITIALIZED",e[e.PRESENT_SRC=9]="PRESENT_SRC"}(exports.GFXTextureLayout||(exports.GFXTextureLayout={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(exports.GFXPipelineBindPoint||(exports.GFXPipelineBindPoint={})),function(e){e[e.VIEWPORT=0]="VIEWPORT",e[e.SCISSOR=1]="SCISSOR",e[e.LINE_WIDTH=2]="LINE_WIDTH",e[e.DEPTH_BIAS=3]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=5]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=6]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=7]="STENCIL_COMPARE_MASK"}(exports.GFXDynamicState||(exports.GFXDynamicState={})),function(e){e[e.FRONT=0]="FRONT",e[e.BACK=1]="BACK",e[e.ALL=2]="ALL"}(exports.GFXStencilFace||(exports.GFXStencilFace={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(exports.GFXQueueType||(exports.GFXQueueType={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(exports.GFXClearFlag||(exports.GFXClearFlag={}));var GFXTextureSubres=function e(){_classCallCheck(this,e),this.baseMipLevel=0,this.levelCount=1,this.baseArrayLayer=0,this.layerCount=1},GFXTextureCopy=function e(){_classCallCheck(this,e),this.srcSubres=new GFXTextureSubres,this.srcOffset={x:0,y:0,z:0},this.dstSubres=new GFXTextureSubres,this.dstOffset={x:0,y:0,z:0},this.extent={width:0,height:0,depth:0}},GFXBufferTextureCopy=function e(){_classCallCheck(this,e),this.buffOffset=0,this.buffStride=0,this.buffTexHeight=0,this.texOffset={x:0,y:0,z:0},this.texExtent={width:0,height:0,depth:0},this.texSubres=new GFXTextureSubres};!function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(exports.GFXFormatType||(exports.GFXFormatType={}));var GFXFormatInfos=[{name:"UNKNOWN",size:0,count:0,type:exports.GFXFormatType.NONE,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"A8",size:1,count:1,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"L8",size:1,count:1,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"LA8",size:1,count:2,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8",size:1,count:1,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8SN",size:1,count:1,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8UI",size:1,count:1,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8I",size:1,count:1,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16F",size:2,count:1,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16UI",size:2,count:1,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16I",size:2,count:1,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32F",size:4,count:1,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32UI",size:4,count:1,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32I",size:4,count:1,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8",size:2,count:2,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8SN",size:2,count:2,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8UI",size:2,count:2,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8I",size:2,count:2,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16F",size:4,count:2,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16UI",size:4,count:2,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16I",size:4,count:2,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32F",size:8,count:2,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32UI",size:8,count:2,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32I",size:8,count:2,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8",size:3,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8",size:3,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8SN",size:3,count:3,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8UI",size:3,count:3,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8I",size:3,count:3,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16F",size:6,count:3,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16UI",size:6,count:3,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16I",size:6,count:3,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32F",size:12,count:3,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32UI",size:12,count:3,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32I",size:12,count:3,type:exports.GFXFormatType.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8",size:4,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8_A8",size:4,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8SN",size:4,count:4,type:exports.GFXFormatType.SNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8UI",size:4,count:4,type:exports.GFXFormatType.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8I",size:4,count:4,type:exports.GFXFormatType.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16F",size:8,count:4,type:exports.GFXFormatType.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16UI",size:8,count:4,type:exports.GFXFormatType.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16I",size:8,count:4,type:exports.GFXFormatType.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32F",size:16,count:4,type:exports.GFXFormatType.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32UI",size:16,count:4,type:exports.GFXFormatType.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32I",size:16,count:4,type:exports.GFXFormatType.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R5G6B5",size:2,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R11G11B10F",size:4,count:3,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB5A1",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA4",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2UI",size:2,count:4,type:exports.GFXFormatType.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB9E5",size:2,count:4,type:exports.GFXFormatType.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"D16",size:2,count:1,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D16S8",size:3,count:2,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D24",size:3,count:1,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D24S8",size:4,count:2,type:exports.GFXFormatType.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D32F",size:4,count:1,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D32FS8",size:5,count:2,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"BC1",size:1,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_ALPHA",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB",size:1,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB_ALPHA",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2_SRGB",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3_SRGB",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4",size:1,count:1,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4_SNORM",size:1,count:1,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5",size:1,count:2,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5_SNORM",size:1,count:2,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_UF16",size:1,count:3,type:exports.GFXFormatType.UFLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_SF16",size:1,count:3,type:exports.GFXFormatType.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7_SRGB",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC_RGB8",size:1,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8",size:1,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8",size:1,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8_A1",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A1",size:1,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGBA8",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A8",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11",size:1,count:1,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11SN",size:1,count:1,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11",size:2,count:2,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11SN",size:2,count:2,type:exports.GFXFormatType.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB2",size:2,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA2",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB4",size:2,count:3,type:exports.GFXFormatType.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA4",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_2BPP",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_4BPP",size:2,count:4,type:exports.GFXFormatType.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0}];function GFXFormatSize(e,t,i,r){if(!GFXFormatInfos[e].isCompressed)return t*i*r*GFXFormatInfos[e].size;switch(e){case exports.GFXFormat.BC1:case exports.GFXFormat.BC1_ALPHA:case exports.GFXFormat.BC1_SRGB:case exports.GFXFormat.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*r;case exports.GFXFormat.BC2:case exports.GFXFormat.BC2_SRGB:case exports.GFXFormat.BC3:case exports.GFXFormat.BC3_SRGB:case exports.GFXFormat.BC4:case exports.GFXFormat.BC4_SNORM:case exports.GFXFormat.BC6H_SF16:case exports.GFXFormat.BC6H_UF16:case exports.GFXFormat.BC7:case exports.GFXFormat.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*r;case exports.GFXFormat.BC5:case exports.GFXFormat.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*r;case exports.GFXFormat.ETC_RGB8:case exports.GFXFormat.ETC2_RGB8:case exports.GFXFormat.ETC2_SRGB8:case exports.GFXFormat.ETC2_RGB8_A1:case exports.GFXFormat.ETC2_SRGB8_A1:case exports.GFXFormat.EAC_R11:case exports.GFXFormat.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*r;case exports.GFXFormat.EAC_RG11:case exports.GFXFormat.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*r;case exports.GFXFormat.PVRTC_RGB2:case exports.GFXFormat.PVRTC_RGBA2:case exports.GFXFormat.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*r;case exports.GFXFormat.PVRTC_RGB4:case exports.GFXFormat.PVRTC_RGBA4:case exports.GFXFormat.PVRTC2_4BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/2)*r;default:return 0}}function GFXFormatSurfaceSize(e,t,i,r,n){for(var s=0,a=0;a<n;++a)s+=GFXFormatSize(e,t,i,r),t=Math.max(t>>1,1),i=Math.max(i>>1,1),r=Math.max(r>>1,1);return s}var _type2size=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function GFXGetTypeSize(e){return _type2size[e]||0}var GFXAPI,GFXFeature,GFXDefines=Object.freeze({GFX_MAX_VERTEX_ATTRIBUTES:GFX_MAX_VERTEX_ATTRIBUTES,GFX_MAX_TEXTURE_UNITS:GFX_MAX_TEXTURE_UNITS,GFX_MAX_ATTACHMENTS:GFX_MAX_ATTACHMENTS,GFX_MAX_BUFFER_BINDINGS:GFX_MAX_BUFFER_BINDINGS,get GFXObjectType(){return exports.GFXObjectType},get GFXStatus(){return exports.GFXStatus},GFXObject:GFXObject,get GFXAttributeName(){return exports.GFXAttributeName},get GFXType(){return exports.GFXType},get GFXFormat(){return exports.GFXFormat},get GFXBufferUsageBit(){return exports.GFXBufferUsageBit},get GFXMemoryUsageBit(){return exports.GFXMemoryUsageBit},get GFXBufferFlagBit(){return exports.GFXBufferFlagBit},get GFXBufferAccessBit(){return exports.GFXBufferAccessBit},get GFXPrimitiveMode(){return exports.GFXPrimitiveMode},get GFXPolygonMode(){return exports.GFXPolygonMode},get GFXShadeModel(){return exports.GFXShadeModel},get GFXCullMode(){return exports.GFXCullMode},get GFXComparisonFunc(){return exports.GFXComparisonFunc},get GFXStencilOp(){return exports.GFXStencilOp},get GFXBlendOp(){return exports.GFXBlendOp},get GFXBlendFactor(){return exports.GFXBlendFactor},get GFXColorMask(){return exports.GFXColorMask},get GFXFilter(){return exports.GFXFilter},get GFXAddress(){return exports.GFXAddress},get GFXTextureType(){return exports.GFXTextureType},get GFXTextureUsageBit(){return exports.GFXTextureUsageBit},get GFXSampleCount(){return exports.GFXSampleCount},get GFXTextureFlagBit(){return exports.GFXTextureFlagBit},get GFXTextureViewType(){return exports.GFXTextureViewType},get GFXShaderType(){return exports.GFXShaderType},get GFXBindingType(){return exports.GFXBindingType},get GFXCommandBufferType(){return exports.GFXCommandBufferType},get GFXLoadOp(){return exports.GFXLoadOp},get GFXStoreOp(){return exports.GFXStoreOp},get GFXTextureLayout(){return exports.GFXTextureLayout},get GFXPipelineBindPoint(){return exports.GFXPipelineBindPoint},get GFXDynamicState(){return exports.GFXDynamicState},get GFXStencilFace(){return exports.GFXStencilFace},get GFXQueueType(){return exports.GFXQueueType},get GFXClearFlag(){return exports.GFXClearFlag},GFXTextureSubres:GFXTextureSubres,GFXTextureCopy:GFXTextureCopy,GFXBufferTextureCopy:GFXBufferTextureCopy,get GFXFormatType(){return exports.GFXFormatType},GFXFormatInfos:GFXFormatInfos,GFXFormatSize:GFXFormatSize,GFXFormatSurfaceSize:GFXFormatSurfaceSize,GFXGetTypeSize:GFXGetTypeSize});ccenum(exports.GFXFormat),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.WEBGL=1]="WEBGL",e[e.WEBGL2=2]="WEBGL2"}(GFXAPI=GFXAPI||{}),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_D24S8=7]="FORMAT_D24S8",e[e.FORMAT_ETC1=8]="FORMAT_ETC1",e[e.FORMAT_ETC2=9]="FORMAT_ETC2",e[e.FORMAT_DXT=10]="FORMAT_DXT",e[e.FORMAT_PVRTC=11]="FORMAT_PVRTC",e[e.FORMAT_ASTC=12]="FORMAT_ASTC",e[e.MSAA=13]="MSAA",e[e.COUNT=14]="COUNT"}(GFXFeature=GFXFeature||{});var GFXDevice=function(){function e(){_classCallCheck(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=GFXAPI.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(GFXFeature.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._mainWindow=null,this._cmdAllocator=null,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=GFX_MAX_BUFFER_BINDINGS,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._depthBits=0,this._stencilBits=0,this._colorFmt=exports.GFXFormat.UNKNOWN,this._depthStencilFmt=exports.GFXFormat.UNKNOWN,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numTris=0,this._memoryStatus={bufferSize:0,textureSize:0}}return _createClass(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"genShaderId",value:function(){return this._shaderIdGen++}},{key:"defineMacro",value:function(e,t){var i=void 0!==t?t:"";this._macros.set(e,i)}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"commandAllocator",get:function(){return this._cmdAllocator}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"maxTextureSize",get:function(){return this._maxTextureSize}},{key:"maxCubeMapTextureSize",get:function(){return this._maxCubeMapTextureSize}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}}]),e}(),layerList={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Layers=function(){function i(){_classCallCheck(this,i)}return _createClass(i,null,[{key:"makeMaskInclude",value:function(e){var t=0,i=e,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}t|=s}return t}},{key:"makeMaskExclude",value:function(e){return~i.makeMaskInclude(e)}},{key:"addLayer",value:function(e,t){void 0!==t?19<t||t<0?console.warn("maximum layers reached."):(i.Enum[e]=1<<t,i.Enum[t]=e,i.BitMask[e]=1<<t,i.BitMask[t]=e):console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(e){19<e||e<0?console.warn("do not change buildin layers."):(delete i.Enum[i.Enum[e]],delete i.Enum[e],delete i.BitMask[i.BitMask[e]],delete i.BitMask[e])}}]),i}();Layers.Enum=Enum(layerList),Layers.BitMask=BitMask(Object.assign({},layerList)),cc.Layers=Layers;var RenderPriority,PIPELINE_FLOW_FORWARD="ForwardFlow",PIPELINE_FLOW_TONEMAP="ToneMapFlow";!function(e){e[e.DEFAULT=100]="DEFAULT"}(exports.RenderPassStage||(exports.RenderPassStage={})),function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(RenderPriority=RenderPriority||{});var UniformBinding,MAX_BINDING_SUPPORTED=24;!function(e){e[e.UBO_GLOBAL=MAX_BINDING_SUPPORTED-1]="UBO_GLOBAL",e[e.UBO_SHADOW=MAX_BINDING_SUPPORTED-2]="UBO_SHADOW",e[e.UBO_LOCAL=MAX_BINDING_SUPPORTED-3]="UBO_LOCAL",e[e.UBO_LOCAL_BATCHED=MAX_BINDING_SUPPORTED-4]="UBO_LOCAL_BATCHED",e[e.UBO_FORWARD_LIGHTS=MAX_BINDING_SUPPORTED-5]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=MAX_BINDING_SUPPORTED-6]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=MAX_BINDING_SUPPORTED-7]="UBO_SKINNING_TEXTURE",e[e.UBO_UI=MAX_BINDING_SUPPORTED-8]="UBO_UI",e[e.SAMPLER_JOINTS=MAX_BINDING_SUPPORTED+1]="SAMPLER_JOINTS",e[e.SAMPLER_ENVIRONMENT=MAX_BINDING_SUPPORTED+2]="SAMPLER_ENVIRONMENT",e[e.CUSTUM_UBO_BINDING_END_POINT=MAX_BINDING_SUPPORTED-8]="CUSTUM_UBO_BINDING_END_POINT",e[e.CUSTOM_SAMPLER_BINDING_START_POINT=MAX_BINDING_SUPPORTED+6]="CUSTOM_SAMPLER_BINDING_START_POINT"}(UniformBinding=UniformBinding||{});var isBuiltinBinding=function(e){return e>=UniformBinding.CUSTUM_UBO_BINDING_END_POINT&&e<UniformBinding.CUSTOM_SAMPLER_BINDING_START_POINT},UBOGlobal=function e(){_classCallCheck(this,e),this.view=new Float32Array(e.COUNT)};UBOGlobal.TIME_OFFSET=0,UBOGlobal.SCREEN_SIZE_OFFSET=UBOGlobal.TIME_OFFSET+4,UBOGlobal.SCREEN_SCALE_OFFSET=UBOGlobal.SCREEN_SIZE_OFFSET+4,UBOGlobal.NATIVE_SIZE_OFFSET=UBOGlobal.SCREEN_SCALE_OFFSET+4,UBOGlobal.MAT_VIEW_OFFSET=UBOGlobal.NATIVE_SIZE_OFFSET+4,UBOGlobal.MAT_VIEW_INV_OFFSET=UBOGlobal.MAT_VIEW_OFFSET+16,UBOGlobal.MAT_PROJ_OFFSET=UBOGlobal.MAT_VIEW_INV_OFFSET+16,UBOGlobal.MAT_PROJ_INV_OFFSET=UBOGlobal.MAT_PROJ_OFFSET+16,UBOGlobal.MAT_VIEW_PROJ_OFFSET=UBOGlobal.MAT_PROJ_INV_OFFSET+16,UBOGlobal.MAT_VIEW_PROJ_INV_OFFSET=UBOGlobal.MAT_VIEW_PROJ_OFFSET+16,UBOGlobal.CAMERA_POS_OFFSET=UBOGlobal.MAT_VIEW_PROJ_INV_OFFSET+16,UBOGlobal.EXPOSURE_OFFSET=UBOGlobal.CAMERA_POS_OFFSET+4,UBOGlobal.MAIN_LIT_DIR_OFFSET=UBOGlobal.EXPOSURE_OFFSET+4,UBOGlobal.MAIN_LIT_COLOR_OFFSET=UBOGlobal.MAIN_LIT_DIR_OFFSET+4,UBOGlobal.AMBIENT_SKY_OFFSET=UBOGlobal.MAIN_LIT_COLOR_OFFSET+4,UBOGlobal.AMBIENT_GROUND_OFFSET=UBOGlobal.AMBIENT_SKY_OFFSET+4,UBOGlobal.COUNT=UBOGlobal.AMBIENT_GROUND_OFFSET+4,UBOGlobal.SIZE=4*UBOGlobal.COUNT,UBOGlobal.BLOCK={binding:UniformBinding.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:exports.GFXType.FLOAT4,count:1},{name:"cc_screenSize",type:exports.GFXType.FLOAT4,count:1},{name:"cc_screenScale",type:exports.GFXType.FLOAT4,count:1},{name:"cc_nativeSize",type:exports.GFXType.FLOAT4,count:1},{name:"cc_matView",type:exports.GFXType.MAT4,count:1},{name:"cc_matViewInv",type:exports.GFXType.MAT4,count:1},{name:"cc_matProj",type:exports.GFXType.MAT4,count:1},{name:"cc_matProjInv",type:exports.GFXType.MAT4,count:1},{name:"cc_matViewProj",type:exports.GFXType.MAT4,count:1},{name:"cc_matViewProjInv",type:exports.GFXType.MAT4,count:1},{name:"cc_cameraPos",type:exports.GFXType.FLOAT4,count:1},{name:"cc_exposure",type:exports.GFXType.FLOAT4,count:1},{name:"cc_mainLitDir",type:exports.GFXType.FLOAT4,count:1},{name:"cc_mainLitColor",type:exports.GFXType.FLOAT4,count:1},{name:"cc_ambientSky",type:exports.GFXType.FLOAT4,count:1},{name:"cc_ambientGround",type:exports.GFXType.FLOAT4,count:1}]};var UBOShadow=function e(){_classCallCheck(this,e),this.view=new Float32Array(e.COUNT)};UBOShadow.MAT_LIGHT_PLANE_PROJ_OFFSET=0,UBOShadow.SHADOW_COLOR_OFFSET=UBOShadow.MAT_LIGHT_PLANE_PROJ_OFFSET+16,UBOShadow.COUNT=UBOShadow.SHADOW_COLOR_OFFSET+4,UBOShadow.SIZE=4*UBOShadow.COUNT,UBOShadow.BLOCK={binding:UniformBinding.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:exports.GFXType.MAT4,count:1},{name:"cc_shadowColor",type:exports.GFXType.FLOAT4,count:1}]};var UNIFORM_ENVIRONMENT={binding:UniformBinding.SAMPLER_ENVIRONMENT,name:"cc_environment",type:exports.GFXType.SAMPLER_CUBE,count:1},localBindingsDesc=new Map,UBOLocal=function e(){_classCallCheck(this,e),this.view=new Float32Array(e.COUNT)};UBOLocal.MAT_WORLD_OFFSET=0,UBOLocal.MAT_WORLD_IT_OFFSET=UBOLocal.MAT_WORLD_OFFSET+16,UBOLocal.COUNT=UBOLocal.MAT_WORLD_IT_OFFSET+16,UBOLocal.SIZE=4*UBOLocal.COUNT,UBOLocal.BLOCK={binding:UniformBinding.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:exports.GFXType.MAT4,count:1},{name:"cc_matWorldIT",type:exports.GFXType.MAT4,count:1}]},localBindingsDesc.set(UBOLocal.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:UBOLocal.BLOCK});var UBOLocalBatched=function e(){_classCallCheck(this,e),this.view=new Float32Array(e.COUNT)};UBOLocalBatched.BATCHING_COUNT=10,UBOLocalBatched.MAT_WORLDS_OFFSET=0,UBOLocalBatched.COUNT=16*UBOLocalBatched.BATCHING_COUNT,UBOLocalBatched.SIZE=4*UBOLocalBatched.COUNT,UBOLocalBatched.BLOCK={binding:UniformBinding.UBO_LOCAL_BATCHED,name:"CCLocalBatched",members:[{name:"cc_matWorlds",type:exports.GFXType.MAT4,count:UBOLocalBatched.BATCHING_COUNT}]},localBindingsDesc.set(UBOLocalBatched.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:UBOLocalBatched.BLOCK});var UBOForwardLight=function e(){_classCallCheck(this,e),this.view=new Float32Array(e.COUNT)};UBOForwardLight.MAX_SPHERE_LIGHTS=2,UBOForwardLight.MAX_SPOT_LIGHTS=2,UBOForwardLight.SPHERE_LIGHT_POS_OFFSET=0,UBOForwardLight.SPHERE_LIGHT_SIZE_RANGE_OFFSET=UBOForwardLight.SPHERE_LIGHT_POS_OFFSET+4*UBOForwardLight.MAX_SPHERE_LIGHTS,UBOForwardLight.SPHERE_LIGHT_COLOR_OFFSET=UBOForwardLight.SPHERE_LIGHT_SIZE_RANGE_OFFSET+4*UBOForwardLight.MAX_SPHERE_LIGHTS,UBOForwardLight.SPOT_LIGHT_POS_OFFSET=UBOForwardLight.SPHERE_LIGHT_COLOR_OFFSET+4*UBOForwardLight.MAX_SPOT_LIGHTS,UBOForwardLight.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET=UBOForwardLight.SPOT_LIGHT_POS_OFFSET+4*UBOForwardLight.MAX_SPOT_LIGHTS,UBOForwardLight.SPOT_LIGHT_DIR_OFFSET=UBOForwardLight.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*UBOForwardLight.MAX_SPOT_LIGHTS,UBOForwardLight.SPOT_LIGHT_COLOR_OFFSET=UBOForwardLight.SPOT_LIGHT_DIR_OFFSET+4*UBOForwardLight.MAX_SPOT_LIGHTS,UBOForwardLight.COUNT=UBOForwardLight.SPOT_LIGHT_COLOR_OFFSET+4*UBOForwardLight.MAX_SPOT_LIGHTS,UBOForwardLight.SIZE=4*UBOForwardLight.COUNT,UBOForwardLight.BLOCK={binding:UniformBinding.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_sphereLitPos",type:exports.GFXType.FLOAT4,count:UBOForwardLight.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitSizeRange",type:exports.GFXType.FLOAT4,count:UBOForwardLight.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitColor",type:exports.GFXType.FLOAT4,count:UBOForwardLight.MAX_SPHERE_LIGHTS},{name:"cc_spotLitPos",type:exports.GFXType.FLOAT4,count:UBOForwardLight.MAX_SPOT_LIGHTS},{name:"cc_spotLitSizeRangeAngle",type:exports.GFXType.FLOAT4,count:UBOForwardLight.MAX_SPOT_LIGHTS},{name:"cc_spotLitDir",type:exports.GFXType.FLOAT4,count:UBOForwardLight.MAX_SPOT_LIGHTS},{name:"cc_spotLitColor",type:exports.GFXType.FLOAT4,count:UBOForwardLight.MAX_SPOT_LIGHTS}]},localBindingsDesc.set(UBOForwardLight.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:UBOForwardLight.BLOCK});var UBOSkinningTexture=function e(){_classCallCheck(this,e)};UBOSkinningTexture.JOINTS_TEXTURE_INFO_OFFSET=0,UBOSkinningTexture.COUNT=UBOSkinningTexture.JOINTS_TEXTURE_INFO_OFFSET+4,UBOSkinningTexture.SIZE=4*UBOSkinningTexture.COUNT,UBOSkinningTexture.BLOCK={binding:UniformBinding.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointsTextureInfo",type:exports.GFXType.FLOAT4,count:1}]},localBindingsDesc.set(UBOSkinningTexture.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:UBOSkinningTexture.BLOCK});var UBOSkinningAnimation=function e(){_classCallCheck(this,e)};UBOSkinningAnimation.JOINTS_ANIM_INFO_OFFSET=0,UBOSkinningAnimation.COUNT=UBOSkinningAnimation.JOINTS_ANIM_INFO_OFFSET+4,UBOSkinningAnimation.SIZE=4*UBOSkinningAnimation.COUNT,UBOSkinningAnimation.BLOCK={binding:UniformBinding.UBO_SKINNING_ANIMATION,name:"CCSkinningAnimation",members:[{name:"cc_jointsAnimInfo",type:exports.GFXType.FLOAT4,count:1}]},localBindingsDesc.set(UBOSkinningAnimation.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:UBOSkinningAnimation.BLOCK});var UniformJointsTexture={binding:UniformBinding.SAMPLER_JOINTS,name:"cc_jointsTexture",type:exports.GFXType.SAMPLER2D,count:1};localBindingsDesc.set(UniformJointsTexture.name,{type:exports.GFXBindingType.SAMPLER,samplerInfo:UniformJointsTexture});var _type2reader,_type2writer,_type2default,CameraDefaultMask=Layers.makeMaskExclude([Layers.BitMask.UI_2D,Layers.BitMask.GIZMOS,Layers.BitMask.EDITOR,Layers.BitMask.SCENE_GIZMO,Layers.BitMask.PROFILER]),CameraEditorMask=Layers.makeMaskExclude([Layers.BitMask.UI_2D,Layers.BitMask.PROFILER]),ModelAlwaysMask=Layers.Enum.ALL,btMask=4026531840,typeMask=264241152,bindingMask=4177920,offsetMask=16383,genHandle=function(e,t,i,r){return e<<28&btMask|i<<22&typeMask|t<<14&bindingMask|(3<arguments.length&&void 0!==r?r:0)&offsetMask},getBindingTypeFromHandle=function(e){return(e&btMask)>>>28},getTypeFromHandle=function(e){return(e&typeMask)>>>22},getBindingFromHandle=function(e){return(e&bindingMask)>>>14},getOffsetFromHandle=function(e){return e&offsetMask},customizeType=function(e,t){return e&~typeMask|t<<22&typeMask},type2reader=(_defineProperty(_type2reader={},exports.GFXType.UNKNOWN,function(e,t){return console.warn("illegal uniform handle")}),_defineProperty(_type2reader,exports.GFXType.INT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]}),_defineProperty(_type2reader,exports.GFXType.INT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec2.fromArray(t,e,i)}),_defineProperty(_type2reader,exports.GFXType.INT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec3.fromArray(t,e,i)}),_defineProperty(_type2reader,exports.GFXType.INT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec4.fromArray(t,e,i)}),_defineProperty(_type2reader,exports.GFXType.FLOAT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]}),_defineProperty(_type2reader,exports.GFXType.FLOAT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec2.fromArray(t,e,i)}),_defineProperty(_type2reader,exports.GFXType.FLOAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec3.fromArray(t,e,i)}),_defineProperty(_type2reader,exports.GFXType.FLOAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec4.fromArray(t,e,i)}),_defineProperty(_type2reader,exports.GFXType.MAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mat3.fromArray(t,e,i)}),_defineProperty(_type2reader,exports.GFXType.MAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mat4.fromArray(t,e,i)}),_type2reader),type2writer=(_defineProperty(_type2writer={},exports.GFXType.UNKNOWN,function(e,t){return console.warn("illegal uniform handle")}),_defineProperty(_type2writer,exports.GFXType.INT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),_defineProperty(_type2writer,exports.GFXType.INT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec2.toArray(e,t,i)}),_defineProperty(_type2writer,exports.GFXType.INT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec3.toArray(e,t,i)}),_defineProperty(_type2writer,exports.GFXType.INT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec4.toArray(e,t,i)}),_defineProperty(_type2writer,exports.GFXType.FLOAT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),_defineProperty(_type2writer,exports.GFXType.FLOAT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec2.toArray(e,t,i)}),_defineProperty(_type2writer,exports.GFXType.FLOAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec3.toArray(e,t,i)}),_defineProperty(_type2writer,exports.GFXType.FLOAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Vec4.toArray(e,t,i)}),_defineProperty(_type2writer,exports.GFXType.MAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mat3.toArray(e,t,i)}),_defineProperty(_type2writer,exports.GFXType.MAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mat4.toArray(e,t,i)}),_type2writer),type2default=(_defineProperty(_type2default={},exports.GFXType.INT,[0]),_defineProperty(_type2default,exports.GFXType.INT2,[0,0]),_defineProperty(_type2default,exports.GFXType.INT3,[0,0,0]),_defineProperty(_type2default,exports.GFXType.INT4,[0,0,0,0]),_defineProperty(_type2default,exports.GFXType.FLOAT,[0]),_defineProperty(_type2default,exports.GFXType.FLOAT2,[0,0]),_defineProperty(_type2default,exports.GFXType.FLOAT3,[0,0,0]),_defineProperty(_type2default,exports.GFXType.FLOAT4,[0,0,0,0]),_defineProperty(_type2default,exports.GFXType.MAT3,[1,0,0,0,1,0,0,0,1]),_defineProperty(_type2default,exports.GFXType.MAT4,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),_defineProperty(_type2default,exports.GFXType.SAMPLER2D,"default-texture"),_defineProperty(_type2default,exports.GFXType.SAMPLER_CUBE,"default-cube-texture"),_type2default);function getBitCount(e){return Math.ceil(Math.log2(Math.max(e,2)))}function mapDefine(e,t){switch(e.type){case"boolean":return t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"-1"}function prepareDefines(e,t){var i=[],r=t,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=a,c=o.name,l=e[c],u=mapDefine(o,l),h=!l||"0"===l;i.push({name:c,value:u,isDefault:h})}return i}function getShaderInstanceName(e,t){return e+t.reduce(function(e,t){return t.isDefault?e:"".concat(e,"|").concat(t.name).concat(t.value)},"")}function insertBuiltinBindings(e,t,i){var r=e.builtins[i],n=e.blocks,s=r.blocks,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if(a){if(o>=s.length)break;c=s[o++]}else{if((o=s.next()).done)break;c=o.value}var l=c,u=t.get(l.name);if(u&&u.type===exports.GFXBindingType.UNIFORM_BUFFER){var h=Object.assign({defines:l.defines,size:getSize(u.blockInfo),bindingType:exports.GFXBindingType.UNIFORM_BUFFER},u.blockInfo);n.push(h)}else console.warn("builtin UBO '".concat(l.name,"' not available!"))}var _=e.samplers,p=r.samplers,d=Array.isArray(p),f=0;for(p=d?p:p[Symbol.iterator]();;){var m;if(d){if(f>=p.length)break;m=p[f++]}else{if((f=p.next()).done)break;m=f.value}var y=m,v=t.get(y.name);if(v&&v.type===exports.GFXBindingType.SAMPLER){var g=Object.assign({defines:y.defines,bindingType:exports.GFXBindingType.SAMPLER},v.samplerInfo);_.push(g)}else console.warn("builtin sampler '".concat(y.name,"' not available!"))}}function getSize(e){return e.members.reduce(function(e,t){return e+GFXGetTypeSize(t.type)*t.count},0)}function genHandles(e){for(var t={},i=0;i<e.blocks.length;i++)for(var r=e.blocks[i],n=r.members,s=0,a=0;a<n.length;a++){var o=n[a];t[o.name]=genHandle(exports.GFXBindingType.UNIFORM_BUFFER,r.binding,o.type,s),s+=(GFXGetTypeSize(o.type)>>2)*o.count}for(var c=0;c<e.samplers.length;c++){var l=e.samplers[c];t[l.name]=genHandle(exports.GFXBindingType.SAMPLER,l.binding,l.type)}return t}var _dec$2,_class$2,_temp$2,ProgramLib=function(){function e(){_classCallCheck(this,e),this._templates=void 0,this._cache=void 0,this._templates={},this._cache={}}return _createClass(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){var i=e,r=0,n=function(){if(a){if(o>=s.length)return"break";c=s[o++]}else{if((o=s.next()).done)return"break";c=o.value}var e=c,t=1;if("number"===e.type){var i=e.range;t=getBitCount(i[1]-i[0]+1),e._map=function(e){return e-i[0]}}else"string"===e.type?(t=getBitCount(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex(function(e){return e===t}))}):"boolean"===e.type&&(e._map=function(e){return e?1:0});e._offset=r,r+=t},s=i.defines,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if("break"===n())break}i.blocks.forEach(function(e){return e.size=getSize(e),e.bindingType=exports.GFXBindingType.UNIFORM_BUFFER}),i.samplers.forEach(function(e){return e.bindingType=exports.GFXBindingType.SAMPLER}),i.handleMap=genHandles(i),i.localsInited||(insertBuiltinBindings(i,localBindingsDesc,"locals"),i.localsInited=!0),this._templates[e.name]=i}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var i=this._templates[e],r=0,n=i.defines,s=Array.isArray(n),a=0;for(n=s?n:n[Symbol.iterator]();;){var o;if(s){if(a>=n.length)break;o=n[a++]}else{if((a=n.next()).done)break;o=a.value}var c=o,l=t[c.name];if(void 0!==l&&c._map)r|=c._map(l)<<c._offset}return"".concat(r.toString(16),"|").concat(i.hash)}},{key:"destroyShaderByDefines",value:function(i){var r=this,e=Object.keys(i);if(e.length){var n=e.map(function(e){var t=i[e];return"boolean"==typeof t&&(t=t?"1":"0"),new RegExp(e+t)}),t=Object.keys(this._cache).filter(function(t){return n.every(function(e){return e.test(r._cache[t].name)})}),s=Array.isArray(t),a=0;for(t=s?t:t[Symbol.iterator]();;){var o;if(s){if(a>=t.length)break;o=t[a++]}else{if((a=t.next()).done)break;o=a.value}var c=o;console.log("destroyed shader ".concat(this._cache[c].name)),this._cache[c].destroy(),delete this._cache[c]}}}},{key:"getGFXShader",value:function(e,t,i,r){Object.assign(i,r.macros);var n=this.getKey(t,i),s=this._cache[n];if(void 0!==s)return s;var a=this._templates[t];a.globalsInited||(insertBuiltinBindings(a,r.globalBindings,"globals"),a.globalsInited=!0);var o=prepareDefines(i,a.defines),c=o.reduce(function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.value,"\n")},""),l="",u="";return u=e.gfxAPI===GFXAPI.WEBGL2?(l="#version 300 es\n".concat(c,"\n").concat(a.glsl3.vert),"#version 300 es\n".concat(c,"\n").concat(a.glsl3.frag)):(l="#version 100\n".concat(c,"\n").concat(a.glsl1.vert),"#version 100\n".concat(c,"\n").concat(a.glsl1.frag)),s=e.createShader({name:getShaderInstanceName(t,o),blocks:a.blocks,samplers:a.samplers,stages:[{type:exports.GFXShaderType.VERTEX,source:l},{type:exports.GFXShaderType.FRAGMENT,source:u}]}),this._cache[n]=s}}]),e}(),programLib=new ProgramLib;function applyMixins(i,e){e.forEach(function(t){Object.getOwnPropertyNames(t.prototype).forEach(function(e){"constructor"!==e&&Object.defineProperty(i.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e))})})}cc.programLib=programLib;var _dec$3,_dec2,_class$3,_class2$2,_descriptor$2,_class3$1,_temp$3,RawAsset=(_dec$2=ccclass("cc.RawAsset"))(_class$2=_temp$2=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._uuid=void 0,Object.defineProperty(_assertThisInitialized(t),"_uuid",{value:"",writable:!0}),t}return _inherits(s,CCObject),_createClass(s,null,[{key:"isRawAssetType",value:function(e){return isChildClassOf(e,cc.RawAsset)&&!isChildClassOf(e,cc.Asset)}}]),s}())||_class$2;cc.RawAsset=RawAsset;var _dec$4,_class$4,_class2$3,_descriptor$3,_descriptor2$2,_descriptor3$2,_class3$2,_temp$4,Asset=(_dec$3=ccclass("cc.Asset"),_dec2=property({visible:!1}),_dec$3((_temp$3=_class3$1=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r)))).loaded=!0,_initializerDefineProperty(t,"_native",_descriptor$2,_assertThisInitialized(t)),t._file=null,t._callbackTable=createMap(!0),t}return _inherits(s,RawAsset),_createClass(s,null,[{key:"deserialize",value:function(e){return cc.deserialize(e)}}]),_createClass(s,[{key:"on",value:function(e,t,i){}},{key:"off",value:function(e,t,i){}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"toString",value:function(){return this.nativeUrl}},{key:"_setRawAsset",value:function(e,t){var i=!(1<arguments.length&&void 0!==t)||t;this._native=!1!==i?e||"":"/"+e}},{key:"nativeUrl",get:function(){if(this._native){var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);if(cc.AssetLibrary){var t=cc.AssetLibrary.getLibUrlNoExt(this._uuid,!0);return 46===e.charCodeAt(0)?t+e:t+"/"+e}cc.errorID(6400)}return""}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}}]),s}(),_class3$1.preventDeferredLoadDependents=!1,_class3$1.preventPreloadNativeObject=!1,_descriptor$2=_applyDecoratedDescriptor((_class2$2=_temp$3).prototype,"_native",[string],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_applyDecoratedDescriptor(_class2$2.prototype,"nativeUrl",[_dec2],Object.getOwnPropertyDescriptor(_class2$2.prototype,"nativeUrl"),_class2$2.prototype),_applyDecoratedDescriptor(_class2$2.prototype,"_nativeAsset",[property],Object.getOwnPropertyDescriptor(_class2$2.prototype,"_nativeAsset"),_class2$2.prototype),_class$3=_class2$2))||_class$3);applyMixins(Asset,[CallbacksInvoker,EventTarget]),Asset.prototype.createNode=null,cc.Asset=Asset;var PixelFormat,WrapMode$1,Filter,DepthStencilFormat,_dec$5,_dec2$1,_class$5,_class2$4,_class3$3,_temp$5,effects={},EffectAsset=(_dec$4=ccclass("cc.EffectAsset"))((_temp$4=_class3$2=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"techniques",_descriptor$3,_assertThisInitialized(t)),_initializerDefineProperty(t,"shaders",_descriptor2$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"combinations",_descriptor3$2,_assertThisInitialized(t)),t}return _inherits(s,Asset),_createClass(s,[{key:"onLoaded",value:function(){this.shaders.forEach(function(e){return programLib.define(e)}),cc.game.once(cc.Game.EVENT_ENGINE_INITED,this._precompile,this),s.register(this)}},{key:"_precompile",value:function(){for(var i=this,r=cc.director.root,e=function(e){var t=i.shaders[e],s=i.combinations[e];if(!s)return"continue";Object.keys(s).reduce(function(e,n){return e.reduce(function(e,t){var i=s[n],r=[t].concat(_toConsumableArray(Array(i.length-1)).map(function(){return Object.assign({},t)}));return r.forEach(function(e,t){return e[n]=i[t]}),e.concat(r)},[])},[{}]).forEach(function(e){return programLib.getGFXShader(r.device,t.name,e,r.pipeline)})},t=0;t<this.shaders.length;t++)e(t)}}],[{key:"register",value:function(e){effects[e.name]=e}},{key:"remove",value:function(e){if(effects[e])delete effects[e];else for(var t in effects)if(effects[t]._uuid===e)return void delete effects[t]}},{key:"get",value:function(e){if(effects[e])return effects[e];for(var t in effects)if(effects[t]._uuid===e)return effects[t];return null}},{key:"getAll",value:function(){return effects}}]),s}(),_class3$2._effects={},_descriptor$3=_applyDecoratedDescriptor((_class2$3=_temp$4).prototype,"techniques",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor2$2=_applyDecoratedDescriptor(_class2$3.prototype,"shaders",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor3$2=_applyDecoratedDescriptor(_class2$3.prototype,"combinations",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_class$4=_class2$3))||_class$4;function murmurhash2_32_gc(e,t){for(var i=e.length,r=t^i,n=0;4<=i;){var s=255&e.charCodeAt(n)|(255&e.charCodeAt(++n))<<8|(255&e.charCodeAt(++n))<<16|(255&e.charCodeAt(++n))<<24;s=1540483477*(65535&s)+((1540483477*(s>>>16)&65535)<<16),r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16)^(s=1540483477*(65535&(s^=s>>>24))+((1540483477*(s>>>16)&65535)<<16)),i-=4,++n}switch(i){case 3:r^=(255&e.charCodeAt(n+2))<<16;case 2:r^=(255&e.charCodeAt(n+1))<<8;case 1:r=1540483477*(65535&(r^=255&e.charCodeAt(n)))+((1540483477*(r>>>16)&65535)<<16)}return r=1540483477*(65535&(r^=r>>>13))+((1540483477*(r>>>16)&65535)<<16),(r^=r>>>15)>>>0}cc.EffectAsset=EffectAsset,function(e){e[e.RGB565=exports.GFXFormat.R5G6B5]="RGB565",e[e.RGB5A1=exports.GFXFormat.RGB5A1]="RGB5A1",e[e.RGBA4444=exports.GFXFormat.RGBA4]="RGBA4444",e[e.RGB888=exports.GFXFormat.RGB8]="RGB888",e[e.RGBA8888=exports.GFXFormat.RGBA8]="RGBA8888",e[e.RGBA32F=exports.GFXFormat.RGBA32F]="RGBA32F",e[e.A8=exports.GFXFormat.A8]="A8",e[e.I8=exports.GFXFormat.L8]="I8",e[e.AI8=exports.GFXFormat.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=exports.GFXFormat.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=exports.GFXFormat.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=exports.GFXFormat.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=exports.GFXFormat.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_ETC1=exports.GFXFormat.ETC_RGB8]="RGB_ETC1",e[e.RGB_ETC2=exports.GFXFormat.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=exports.GFXFormat.ETC2_RGBA8]="RGBA_ETC2"}(PixelFormat=PixelFormat||{}),function(e){e[e.REPEAT=exports.GFXAddress.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=exports.GFXAddress.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=exports.GFXAddress.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=exports.GFXAddress.BORDER]="CLAMP_TO_BORDER"}(WrapMode$1=WrapMode$1||{}),function(e){e[e.NONE=exports.GFXFilter.NONE]="NONE",e[e.LINEAR=exports.GFXFilter.LINEAR]="LINEAR",e[e.NEAREST=exports.GFXFilter.POINT]="NEAREST"}(Filter=Filter||{}),function(e){e[e.NONE=exports.GFXFormat.UNKNOWN]="NONE",e[e.DEPTH_16=exports.GFXFormat.D16]="DEPTH_16",e[e.DEPTH_24=exports.GFXFormat.D24]="DEPTH_24",e[e.DEPTH_32=exports.GFXFormat.D32F]="DEPTH_32",e[e.DEPTH_16_STENCIL_8=exports.GFXFormat.D16S8]="DEPTH_16_STENCIL_8",e[e.DEPTH_24_STENCIL_8=exports.GFXFormat.D24S8]="DEPTH_24_STENCIL_8",e[e.DEPTH_32_STENCIL_8=exports.GFXFormat.D32F_S8]="DEPTH_32_STENCIL_8"}(DepthStencilFormat=DepthStencilFormat||{});var SamplerInfoIndex,ImageAsset=(_dec$5=ccclass("cc.ImageAsset"),_dec2$1=property({override:!0}),_dec$5((_temp$5=_class3$3=function(){function b(e){var t;return _classCallCheck(this,b),(t=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this)))._nativeData=void 0,t._tex=void 0,t._url=void 0,t._exportedExts=void 0,t._format=PixelFormat.RGBA8888,t._width=0,t._height=0,t._url="",t.loaded=!1,t._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&(t._nativeAsset=e),t}return _inherits(b,Asset),_createClass(b,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){this.reset(e)}},{key:"data",get:function(){var e=this._nativeData._data;return ArrayBuffer.isView(e)||e instanceof ArrayBuffer?e:this._nativeData}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=PixelFormat.RGB_ETC1&&this._format<=PixelFormat.RGBA_PVRTC_4BPPV1}},{key:"url",get:function(){return this._url}},{key:"_texture",set:function(e){this._tex=e},get:function(){if(!this._tex){var e=new cc.Texture2D;e.name=this._url,(e.image=this)._tex=e}return this._tex}}]),_createClass(b,[{key:"reset",value:function(e){e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._nativeData.format=this._format),this._onDataComplete()}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";var t=[],i=e,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s,o=a.split("@"),c=b.extnames.indexOf(o[0]),l=c<0?a:"".concat(c);o[1]&&(l+="@"+o[1]),t.push(l)}return{fmt:t.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,t){var i="";i="string"==typeof e?e:(this._width=e.w,this._height=e.h,e.fmt);var r=_getGlobalDevice(),n=i.split("_"),s=Number.MAX_VALUE,a=this._format,o="",c=cc.macro.SUPPORT_TEXTURE_FORMATS,l=n,u=Array.isArray(l),h=0;for(l=u?l:l[Symbol.iterator]();;){var _;if(u){if(h>=l.length)break;_=l[h++]}else{if((h=l.next()).done)break;_=h.value}var p=_.split("@"),d=parseInt(p[0],void 0),f=b.extnames[d]||p.join(),m=c.indexOf(f);if(-1!==m&&m<s){var y=p[1]?parseInt(p[1]):this._format;if(!(".pvr"!==f||r&&r.hasFeature(GFXFeature.FORMAT_PVRTC)))continue;if(!(y!==PixelFormat.RGB_ETC1||r&&r.hasFeature(GFXFeature.FORMAT_ETC1)))continue;if(!(y!==PixelFormat.RGB_ETC2&&y!==PixelFormat.RGBA_ETC2||r&&r.hasFeature(GFXFeature.FORMAT_ETC2)))continue;if(".webp"===f&&!cc.sys.capabilities.webp)continue;s=m,o=f,a=y}}o&&(this._setRawAsset(o),this._format=a);var v=t.customEnv,g=v&&v.uuid;g&&(this._uuid=g,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),b}(),_class3$3.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm"],_applyDecoratedDescriptor((_class2$4=_temp$5).prototype,"_nativeAsset",[_dec2$1],Object.getOwnPropertyDescriptor(_class2$4.prototype,"_nativeAsset"),_class2$4.prototype),_class$5=_class2$4))||_class$5);function _getGlobalDevice(){return cc.director.root?cc.director.root.device:null}cc.ImageAsset=ImageAsset,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.minLOD=8]="minLOD",e[e.maxLOD=9]="maxLOD",e[e.mipLODBias=10]="mipLODBias",e[e.borderColor=11]="borderColor",e[e.total=15]="total"}(SamplerInfoIndex=SamplerInfoIndex||{});var defaultInfo=[exports.GFXFilter.LINEAR,exports.GFXFilter.LINEAR,exports.GFXFilter.NONE,exports.GFXAddress.WRAP,exports.GFXAddress.WRAP,exports.GFXAddress.WRAP,8,exports.GFXComparisonFunc.NEVER,0,0,0,0,0,0,0],defaultHash=genSamplerHash(defaultInfo),gfxInfo={};function genSamplerHash(e){for(var t=0,i=0,r=0;r<defaultInfo.length;r++)switch(t=e[r]||defaultInfo[r],r){case SamplerInfoIndex.minFilter:i|=t;break;case SamplerInfoIndex.magFilter:i|=t<<2;break;case SamplerInfoIndex.mipFilter:i|=t<<4;break;case SamplerInfoIndex.addressU:i|=t<<6;break;case SamplerInfoIndex.addressV:i|=t<<8;break;case SamplerInfoIndex.addressW:i|=t<<10;break;case SamplerInfoIndex.maxAnisotropy:i|=t<<12;break;case SamplerInfoIndex.cmpFunc:i|=t<<16;break;case SamplerInfoIndex.minLOD:i|=t<<20;break;case SamplerInfoIndex.maxLOD:i|=t<<24;break;case SamplerInfoIndex.mipLODBias:i|=t<<28}return i}var _dec$6,_class$6,_class2$5,_descriptor$4,_descriptor2$3,_descriptor3$3,_descriptor4$2,_descriptor5$1,_descriptor6,_descriptor7,_descriptor8,_descriptor9,_descriptor10,_class3$4,_temp$6,_dec$7,_class$7,_class2$6,_descriptor$5,_class3$5,_temp$7,SamplerLib=function(){function e(){_classCallCheck(this,e),this._cache={}}return _createClass(e,[{key:"getSampler",value:function(e,t){0===t&&(t=defaultHash);var i=this._cache[t];return i||(gfxInfo.minFilter=3&t,gfxInfo.magFilter=t>>2&3,gfxInfo.mipFilter=t>>4&3,gfxInfo.addressU=t>>6&3,gfxInfo.addressV=t>>8&3,gfxInfo.addressW=t>>10&3,gfxInfo.maxAnisotropy=t>>12&15,gfxInfo.cmpFunc=t>>16&15,gfxInfo.minLOD=t>>20&15,gfxInfo.maxLOD=t>>24&15,gfxInfo.mipLODBias=t>>28&15,gfxInfo.borderColor={r:0,g:0,b:0,a:0},this._cache[t]=e.createSampler(gfxInfo))}}]),e}(),samplerLib=new SamplerLib,CHAR_CODE_1=49,idGenerator=new IDGenerator("Tex"),TextureBase=(_dec$6=ccclass("cc.TextureBase"))((_temp$6=_class3$4=function(){function i(){var e,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return _classCallCheck(this,i),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this)),"_format",_descriptor$4,_assertThisInitialized(e)),_initializerDefineProperty(e,"_premultiplyAlpha",_descriptor2$3,_assertThisInitialized(e)),_initializerDefineProperty(e,"_flipY",_descriptor3$3,_assertThisInitialized(e)),_initializerDefineProperty(e,"_minFilter",_descriptor4$2,_assertThisInitialized(e)),_initializerDefineProperty(e,"_magFilter",_descriptor5$1,_assertThisInitialized(e)),_initializerDefineProperty(e,"_mipFilter",_descriptor6,_assertThisInitialized(e)),_initializerDefineProperty(e,"_wrapS",_descriptor7,_assertThisInitialized(e)),_initializerDefineProperty(e,"_wrapT",_descriptor8,_assertThisInitialized(e)),_initializerDefineProperty(e,"_wrapR",_descriptor9,_assertThisInitialized(e)),_initializerDefineProperty(e,"_anisotropy",_descriptor10,_assertThisInitialized(e)),e._width=0,e._height=0,e._id=void 0,e._samplerInfo=[],e._samplerHash=0,e._flipY=t,e._id=idGenerator.getNewId(),e.loaded=!1,e}return _inherits(i,Asset),_createClass(i,[{key:"isCompressed",get:function(){return this._format>=PixelFormat.RGB_ETC1&&this._format<=PixelFormat.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),_createClass(i,[{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"hasPremultipliedAlpha",value:function(){return this._premultiplyAlpha||!1}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,i){this._wrapS=e,this._samplerInfo[SamplerInfoIndex.addressU]=e,this._wrapT=t,this._samplerInfo[SamplerInfoIndex.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[SamplerInfoIndex.addressW]=i),this._samplerHash=genSamplerHash(this._samplerInfo)}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[SamplerInfoIndex.minFilter]=e,this._magFilter=t,this._samplerInfo[SamplerInfoIndex.magFilter]=t,this._samplerHash=genSamplerHash(this._samplerInfo)}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[SamplerInfoIndex.mipFilter]=e,this._samplerInfo[SamplerInfoIndex.maxLOD]=e===Filter.NONE?0:15,this._samplerHash=genSamplerHash(this._samplerInfo)}},{key:"setFlipY",value:function(e){this._flipY=e}},{key:"setPremultiplyAlpha",value:function(e){this._premultiplyAlpha=e}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[SamplerInfoIndex.maxAnisotropy]=e,this._samplerHash=genSamplerHash(this._samplerInfo)}},{key:"destroy",value:function(){return _get(_getPrototypeOf(i.prototype),"destroy",this).call(this)}},{key:"getGFXTextureView",value:function(){return null}},{key:"getSamplerHash",value:function(){return this._samplerHash}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+(this._premultiplyAlpha?1:0)+","+this._mipFilter+","+this._anisotropy+","+(this._flipY?1:0)}},{key:"_deserialize",value:function(e,t){var i=e.split(",");i.unshift(""),6<=i.length&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4])),this._premultiplyAlpha=i[5].charCodeAt(0)===CHAR_CODE_1),8<=i.length&&(this.setMipFilter(parseInt(i[6])),this.setAnisotropy(parseInt(i[7]))),9<=i.length&&(this._flipY=i[8].charCodeAt(0)===CHAR_CODE_1)}},{key:"_getGFXDevice",value:function(){return cc.director.root&&cc.director.root.device}},{key:"_getGFXFormat",value:function(){return this._format}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?PixelFormat.RGBA8888:e}}]),i}(),_class3$4.PixelFormat=PixelFormat,_class3$4.WrapMode=WrapMode$1,_class3$4.Filter=Filter,_descriptor$4=_applyDecoratedDescriptor((_class2$5=_temp$6).prototype,"_format",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PixelFormat.RGBA8888}}),_descriptor2$3=_applyDecoratedDescriptor(_class2$5.prototype,"_premultiplyAlpha",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor3$3=_applyDecoratedDescriptor(_class2$5.prototype,"_flipY",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor4$2=_applyDecoratedDescriptor(_class2$5.prototype,"_minFilter",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Filter.LINEAR}}),_descriptor5$1=_applyDecoratedDescriptor(_class2$5.prototype,"_magFilter",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Filter.LINEAR}}),_descriptor6=_applyDecoratedDescriptor(_class2$5.prototype,"_mipFilter",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Filter.NONE}}),_descriptor7=_applyDecoratedDescriptor(_class2$5.prototype,"_wrapS",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WrapMode$1.REPEAT}}),_descriptor8=_applyDecoratedDescriptor(_class2$5.prototype,"_wrapT",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WrapMode$1.REPEAT}}),_descriptor9=_applyDecoratedDescriptor(_class2$5.prototype,"_wrapR",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WrapMode$1.REPEAT}}),_descriptor10=_applyDecoratedDescriptor(_class2$5.prototype,"_anisotropy",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),_class$6=_class2$5))||_class$6;cc.TextureBase=TextureBase,ccenum(DepthStencilFormat);var _dec$8,_class$8,_temp$8,RenderTexture=(_dec$7=ccclass("cc.RenderTexture"))((_temp$7=_class3$5=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._window=null,_initializerDefineProperty(t,"_depthStencilFormat",_descriptor$5,_assertThisInitialized(t)),t}return _inherits(s,TextureBase),_createClass(s,[{key:"getGFXWindow",value:function(){return this._window}},{key:"getGFXTextureView",value:function(){return this._window?this._window.colorTexView:null}},{key:"getGFXStencilTexture",value:function(){return this._window?this._window.depthStencilTexView:null}},{key:"reset",value:function(e){e&&(this._width=e.width,this._height=e.height,e.colorFormat&&(this._format=e.colorFormat),e.depthStencilFormat&&(this._depthStencilFormat=e.depthStencilFormat),this._tryResetWindow(),this.emit("resize",this))}},{key:"destroy",value:function(){return this._window&&(cc.director.root.destroyWindow(this._window),this._window=null),_get(_getPrototypeOf(s.prototype),"destroy",this).call(this)}},{key:"onLoaded",value:function(){this._tryResetWindow(),this.loaded=!0,this.emit("load")}},{key:"_serialize",value:function(e){return{base:_get(_getPrototypeOf(s.prototype),"_serialize",this).call(this),name:this._name,width:this._width,height:this._height,colorFormat:this._format,depthStencilFormat:this._depthStencilFormat}}},{key:"_deserialize",value:function(e,t){_get(_getPrototypeOf(s.prototype),"_deserialize",this).call(this,e.base,t);var i=e;this.name=i.name||"",this._width=i.width,this._height=i.height,this._format=i.colorFormat,this._depthStencilFormat=i.depthStencilFormat}},{key:"_tryResetWindow",value:function(){var e=this._getGFXDevice();e&&(this._window&&this._window.destroy(),this._createWindow(e))}},{key:"_createWindow",value:function(e){var t={title:this.name,isOffscreen:!0,width:this._width,height:this._height,colorFmt:this._format,depthStencilFmt:this._depthStencilFormat};if(this._window)return this._window.initialize(t),this._window;this._window=cc.director.root.createWindow(t)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this.reset()}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this.reset()}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat},set:function(e){this._depthStencilFormat=e,this.reset()}}]),s}(),_class3$5.DepthStencilFormat=DepthStencilFormat,_descriptor$5=_applyDecoratedDescriptor((_class2$6=_temp$7).prototype,"_depthStencilFormat",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DepthStencilFormat.NONE}}),_applyDecoratedDescriptor(_class2$6.prototype,"width",[property],Object.getOwnPropertyDescriptor(_class2$6.prototype,"width"),_class2$6.prototype),_applyDecoratedDescriptor(_class2$6.prototype,"height",[property],Object.getOwnPropertyDescriptor(_class2$6.prototype,"height"),_class2$6.prototype),_applyDecoratedDescriptor(_class2$6.prototype,"depthStencilFormat",[property],Object.getOwnPropertyDescriptor(_class2$6.prototype,"depthStencilFormat"),_class2$6.prototype),_class$7=_class2$6))||_class$7;cc.RenderTexture=RenderTexture;var _regions=[{buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{baseMipLevel:1,levelCount:1,baseArrayLayer:0,layerCount:1}}];function getMipLevel(e,t){for(var i=Math.max(e,t),r=0;i;)i>>=1,r++;return r}function isPOT(e){return e&&0==(e&e-1)}var _dec$9,_dec2$2,_class$9,_class2$7,_descriptor$6,_temp$9,SimpleTexture=(_dec$8=ccclass("cc.SimpleTexture"))(_class$8=_temp$8=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._gfxTexture=null,t._gfxTextureView=null,t._mipmapLevel=1,t}return _inherits(s,TextureBase),_createClass(s,[{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"getGFXTextureView",value:function(){return this._gfxTextureView}},{key:"destroy",value:function(){return this._tryDestroyTexture(),_get(_getPrototypeOf(s.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e,t,i){var r=1<arguments.length&&void 0!==t?t:0,n=2<arguments.length&&void 0!==i?i:0;if(this._gfxTexture&&!(this._gfxTexture.mipLevel<=r)){var s=this._getGFXDevice();if(s){var a=_regions[0];a.texExtent.width=this._gfxTexture.width>>r,a.texExtent.height=this._gfxTexture.height>>r,a.texSubres.baseMipLevel=r,a.texSubres.baseArrayLayer=n,e instanceof ArrayBuffer?s.copyBuffersToTexture([e],this._gfxTexture,_regions):s.copyTexImagesToTexture([e],this._gfxTexture,_regions)}}}},{key:"_assignImage",value:function(i,r,n){function e(){var e,t=i.data;t&&(e=ArrayBuffer.isView(t)?t.buffer:t,s.uploadData(e,r,n),s._checkTextureLoaded())}var s=this;if(i.loaded)e();else{if(i.once("load",function(){e()}),!this.isCompressed){var t=cc.builtinResMgr.get("black-texture").image;this.uploadData(t.data,r,n)}cc.textureUtil.postLoadImage(i)}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(e){return null}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return null}},{key:"_tryReset",value:function(){this._tryDestroyTexture();var e=this._getGFXDevice();e&&this._createTexture(e)}},{key:"_createTexture",value:function(e){var t=exports.GFXTextureFlagBit.NONE;this._mipFilter!==Filter.NONE&&isPOT(this._width)&&isPOT(this._height)&&(this._mipmapLevel=getMipLevel(this._width,this._height),t=exports.GFXTextureFlagBit.GEN_MIPMAP);var i=this._getGfxTextureCreateInfo({usage:exports.GFXTextureUsageBit.SAMPLED|exports.GFXTextureUsageBit.TRANSFER_DST,format:this._getGFXFormat(),mipLevel:this._mipmapLevel,flags:t});if(i){var r=e.createTexture(i),n=this._getGfxTextureViewCreateInfo({texture:r,format:this._getGFXFormat()});if(n){var s=e.createTextureView(n);s?(this._gfxTexture=r,this._gfxTextureView=s):r.destroy()}else r.destroy()}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null),this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)}},{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),s}())||_class$8;cc.SimpleTexture=SimpleTexture;var _dec$a,_class$a,_temp$a,Texture2D=(_dec$9=ccclass("cc.Texture2D"),_dec2$2=property([ImageAsset]),_dec$9((_descriptor$6=_applyDecoratedDescriptor((_class2$7=_temp$9=function(){function s(){var e;return _classCallCheck(this,s),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(s).call(this,!0)),"_mipmaps",_descriptor$6,_assertThisInitialized(e)),e}return _inherits(s,SimpleTexture),_createClass(s,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var i=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),0<this._mipmaps.length){var t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,t){i._assignImage(e,t)})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),_createClass(s,[{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t,i,r){var n=2<arguments.length&&void 0!==i?i:PixelFormat.RGBA8888,s=3<arguments.length&&void 0!==r?r:1;this.reset({width:e,height:t,format:n,mipmapLevel:s})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(e,t){var i=0<arguments.length&&void 0!==e?e:0,r=1<arguments.length?t:void 0;if(!(i>=this._mipmaps.length))for(var n=Math.min(void 0===r?this._mipmaps.length:r,this._mipmaps.length-i),s=0;s<n;++s){var a=i+s;this._assignImage(this._mipmaps[a],a)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],_get(_getPrototypeOf(s.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(t){return{base:_get(_getPrototypeOf(s.prototype),"_serialize",this).call(this,t),mipmaps:this._mipmaps.map(function(e){return e&&e._uuid?t?Editor.Utils.UuidUtils.compressUuid(e._uuid,!0):e._uuid:null})}}},{key:"_deserialize",value:function(e,t){var i=e;_get(_getPrototypeOf(s.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new ImageAsset,i.mipmaps[r]){var n=i.mipmaps[r];t.result.push(this._mipmaps,"".concat(r),n),this._mipmaps[r]._texture=this}}},{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"_getGfxTextureCreateInfo",value:function(e){return Object.assign({type:exports.GFXTextureType.TEX2D,width:this._width,height:this._height},e)}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:exports.GFXTextureViewType.TV2D},e)}},{key:"_checkTextureLoaded",value:function(){for(var e=!0,t=0;t<this._mipmaps.length;++t){if(!this._mipmaps[t].loaded){e=!1;break}}e&&_get(_getPrototypeOf(s.prototype),"_textureReady",this).call(this)}}]),s}()).prototype,"_mipmaps",[_dec2$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_class$9=_class2$7))||_class$9);cc.Texture2D=Texture2D;var _dec$b,_class$b,_class2$8,_descriptor$7,_class3$6,_temp$b,FaceIndex,INSET_LEFT=0,INSET_TOP=1,INSET_RIGHT=2,INSET_BOTTOM=3,temp_uvs=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],SpriteFrame=(_dec$a=ccclass("cc.SpriteFrame"))(_class$a=_temp$a=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this))).vertices=null,e.uv=[],e.uvHash=0,e._image=null,e.uvSliced=[],e._rect=new Rect,e._offset=new Vec2,e._originalSize=new Size,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._flipUv=!1,e}return _inherits(t,Asset),_createClass(t,[{key:"insetTop",get:function(){return this._capInsets[INSET_TOP]},set:function(e){this._capInsets[INSET_TOP]=e,this._calculateSlicedUV()}},{key:"insetBottom",get:function(){return this._capInsets[INSET_BOTTOM]},set:function(e){this._capInsets[INSET_BOTTOM]=e,this._calculateSlicedUV()}},{key:"insetLeft",get:function(){return this._capInsets[INSET_LEFT]},set:function(e){this._capInsets[INSET_LEFT]=e,this._calculateSlicedUV()}},{key:"insetRight",get:function(){return this._capInsets[INSET_RIGHT]},set:function(e){this._capInsets[INSET_RIGHT]=e,this._calculateSlicedUV()}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.set(e),this._calculateUV()}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.set(e),this._calculateUV()}},{key:"_imageSource",set:function(e){this._image=e,window.Editor&&Editor.isBuilder||(this._texture=e._texture,this._texture.on("load",this._textureLoaded,this),this._calculateUV())}},{key:"texture",get:function(){return this._texture||(this._texture=!this._image||window.Editor&&Editor.isBuilder?new Texture2D:this._image._texture,this._texture.on("load",this._textureLoaded,this)),this._texture},set:function(e){e?(this.reset({texture:e},!0),this._texture instanceof RenderTexture&&this.onLoaded()):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}}]),_createClass(t,[{key:"textureLoaded",value:function(){return this.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this._rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this._rect.set(e)}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this._originalSize.set(e)}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this._offset.set(e)}},{key:"getGFXTextureView",value:function(){return this._texture.getGFXTextureView()}},{key:"reset",value:function(e,t){var i=!1;1<arguments.length&&void 0!==t&&t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],i=!(this._rotated=!1)),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._texture&&this._texture.off("load"),this._texture=e.texture,this.checkRect(this._texture),this._texture.on("load",this._textureLoaded,this)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[INSET_TOP]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[INSET_BOTTOM]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[INSET_LEFT]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[INSET_RIGHT]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._flipUv=!!e.isFlipUv),this._texture instanceof RenderTexture&&(this._flipUv=!0),i=!0),i&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,i=t.x,r=t.y;return this._rotated?(i+=t.height,r+=t.width):(i+=t.width,r+=t.height),i>e.width?(cc.errorID(3300,this.name+"/"+e.name,i,e.width),!1):!(r>e.height)||(cc.errorID(3301,this.name+"/"+e.name,r,e.height),!1)}},{key:"onLoaded",value:function(){this.loaded=!0,this.emit("load")}},{key:"destroy",value:function(){return this._texture&&this._texture.off("load"),_get(_getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,i=t.width,r=t.height,n=this._capInsets[INSET_LEFT],s=this._capInsets[INSET_RIGHT],a=e.width-n-s,o=this._capInsets[INSET_TOP],c=this._capInsets[INSET_BOTTOM],l=e.height-o-c,u=this.uvSliced;if(u.length=0,this._rotated){temp_uvs[0].u=(e.x+e.height)/i,temp_uvs[1].u=(e.x+c+l)/i,temp_uvs[2].u=(e.x+c)/i,temp_uvs[3].u=e.x/i,temp_uvs[3].v=(e.y+e.width)/r,temp_uvs[2].v=(e.y+n+a)/r,temp_uvs[1].v=(e.y+n)/r,temp_uvs[0].v=e.y/r;for(var h=0;h<4;++h)for(var _=temp_uvs[h],p=0;p<4;++p){var d=temp_uvs[3-p];u.push({u:_.u,v:d.v})}}else{temp_uvs[0].u=e.x/i,temp_uvs[1].u=(e.x+n)/i,temp_uvs[2].u=(e.x+n+a)/i,temp_uvs[3].u=(e.x+e.width)/i,temp_uvs[3].v=e.y/r,temp_uvs[2].v=(e.y+o)/r,temp_uvs[1].v=(e.y+o+l)/r,temp_uvs[0].v=(e.y+e.height)/r;for(var f=0;f<4;++f)for(var m=temp_uvs[f],y=0;y<4;++y){var v=temp_uvs[y];u.push({u:v.u,v:m.v})}}}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,i=this.texture,r=i.width,n=i.height;if(this._rotated){var s=0===r?0:e.x/r,a=0===r?0:(e.x+e.height)/r,o=0===n?0:e.y/n,c=0===n?0:(e.y+e.width)/n;this._flipUv?(t[0]=s,t[1]=o,t[2]=s,t[3]=c,t[4]=a,t[5]=o,t[6]=a,t[7]=c):(t[0]=a,t[1]=c,t[2]=a,t[3]=o,t[4]=s,t[5]=c,t[6]=s,t[7]=o)}else{var l=0===r?0:e.x/r,u=0===r?0:(e.x+e.width)/r,h=0===n?0:(e.y+e.height)/n,_=0===n?0:e.y/n;this._flipUv?(t[0]=l,t[1]=_,t[2]=u,t[3]=_,t[4]=l,t[5]=h,t[6]=u,t[7]=h):(t[0]=l,t[1]=h,t[2]=u,t[3]=h,t[4]=l,t[5]=_,t[6]=u,t[7]=_)}for(var p="",d=0;d<t.length;d++)p+=t[d];this.uvHash=murmurhash2_32_gc(p,666);var f=this.vertices;if(f){f.nu.length=0;for(var m=f.nv.length=0;m<f.u.length;m++)f.nu[m]=f.u[m]/r,f.nv[m]=f.v[m]/n}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,i=this._rect,r=this._offset,n=this._originalSize,s=this._uuid;return s&&e&&(s=Editor.Utils.UuidUtils.compressUuid(s,!0)),this.vertices&&(t={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{image:this._image?e?Editor.Utils.UuidUtils.compressUuid(this._image._uuid,!0):this._image._uuid:void 0,name:this._name,atlas:e?void 0:this._atlasUuid,rect:i,offset:r,originalSize:n,rotated:this._rotated,capInsets:this._capInsets,vertices:t}}},{key:"_deserialize",value:function(e,t){var i=e,r=i.rect;r&&this.setRect(new Rect(r.x,r.y,r.width,r.height));var n=i.offset;i.offset&&this.setOffset(new Vec2(n.x,n.y));var s=i.originalSize;i.originalSize&&this.setOriginalSize(new Size(s.width,s.height)),this._rotated=!!i.rotated,this._name=i.name;var a=i.capInsets;a&&(this._capInsets[INSET_LEFT]=a[INSET_LEFT],this._capInsets[INSET_TOP]=a[INSET_TOP],this._capInsets[INSET_RIGHT]=a[INSET_RIGHT],this._capInsets[INSET_BOTTOM]=a[INSET_BOTTOM]),t.result.push(this,"_imageSource",i.image),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"_textureLoaded",value:function(){var e=this._texture,t={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new Rect(0,0,e.width,e.height),i=!0),0!==this._originalSize.width&&0!==this._originalSize.height&&!i||(t.originalSize=new Size(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded())}}]),t}())||_class$a;cc.SpriteFrame=SpriteFrame,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(FaceIndex=FaceIndex||{});var TextureCube=(_dec$b=ccclass("cc.TextureCube"))((_temp$b=_class3$6=function(){function a(){var e;return _classCallCheck(this,a),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(a).call(this)),"_mipmaps",_descriptor$7,_assertThisInitialized(e)),e}return _inherits(a,SimpleTexture),_createClass(a,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var r=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),0<this._mipmaps.length){var t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,i){_forEachFace(e,function(e,t){r._assignImage(e,i,t)})})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,t){for(var i=[],r=e.length/6,n=0;n<r;n++){var s=6*n;i.push({front:e[s+FaceIndex.front].image,back:e[s+FaceIndex.back].image,left:e[s+FaceIndex.left].image,right:e[s+FaceIndex.right].image,top:e[s+FaceIndex.top].image,bottom:e[s+FaceIndex.bottom].image})}return(t=t||new a).mipmaps=i,t}}]),_createClass(a,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(e,t){var r=this,n=0<arguments.length&&void 0!==e?e:0,i=1<arguments.length?t:void 0;if(!(n>=this._mipmaps.length))for(var s=Math.min(void 0===i?this._mipmaps.length:i,this._mipmaps.length-n),a=function(e){var i=n+e;_forEachFace(r._mipmaps[i],function(e,t){r._assignImage(e,i,t)})},o=0;o<s;++o)a(o)}},{key:"destroy",value:function(){return this._mipmaps=[],_get(_getPrototypeOf(a.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(t){return{base:_get(_getPrototypeOf(a.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map(function(e){return t?{front:Editor.Utils.UuidUtils.compressUuid(e.front._uuid,!0),back:Editor.Utils.UuidUtils.compressUuid(e.back._uuid,!0),left:Editor.Utils.UuidUtils.compressUuid(e.left._uuid,!0),right:Editor.Utils.UuidUtils.compressUuid(e.right._uuid,!0),top:Editor.Utils.UuidUtils.compressUuid(e.top._uuid,!0),bottom:Editor.Utils.UuidUtils.compressUuid(e.bottom._uuid,!0)}:{front:e.front._uuid,back:e.back._uuid,left:e.left._uuid,right:e.right._uuid,top:e.top._uuid,bottom:e.bottom._uuid}})}}},{key:"_deserialize",value:function(e,t){var i=e;_get(_getPrototypeOf(a.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new ImageAsset,back:new ImageAsset,left:new ImageAsset,right:new ImageAsset,top:new ImageAsset,bottom:new ImageAsset};var n=i.mipmaps[r];t.result.push(this._mipmaps[r],"front",n.front),t.result.push(this._mipmaps[r],"back",n.back),t.result.push(this._mipmaps[r],"left",n.left),t.result.push(this._mipmaps[r],"right",n.right),t.result.push(this._mipmaps[r],"top",n.top),t.result.push(this._mipmaps[r],"bottom",n.bottom)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=Object.assign({type:exports.GFXTextureType.TEX2D,width:this._width,height:this._height,arrayLayer:6},e);return t.flags=(t.flags||0)|exports.GFXTextureFlagBit.CUBEMAP,t}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:exports.GFXTextureViewType.CUBE,layerCount:6},e)}}]),a}(),_class3$6.FaceIndex=FaceIndex,_descriptor$7=_applyDecoratedDescriptor((_class2$8=_temp$b).prototype,"_mipmaps",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_class$b=_class2$8))||_class$b;function _forEachFace(e,t){t(e.front,FaceIndex.front),t(e.back,FaceIndex.back),t(e.left,FaceIndex.left),t(e.right,FaceIndex.right),t(e.top,FaceIndex.top),t(e.bottom,FaceIndex.bottom)}cc.TextureCube=TextureCube,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.POSITION_PART="position-part",e.ROTATION_PART="rotation-part",e.SCALE_PART="scale-part",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed"}(exports.SystemEventType||(exports.SystemEventType={})),ccenum(exports.SystemEventType),cc.SystemEventType=exports.SystemEventType;var EventMouse=function(){function r(e,t){var i;return _classCallCheck(this,r),(i=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this,Event.MOUSE,t))).movementX=0,i.movementY=0,i._eventType=void 0,i._button=0,i._x=0,i._y=0,i._prevX=0,i._prevY=0,i._scrollX=0,i._scrollY=0,i._eventType=e,i}return _inherits(r,Event),_createClass(r,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e=e||new Vec2,Vec2.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e=e||new Vec2,Vec2.set(e,this._x,cc.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e=e||new Vec2,Vec2.set(e,this._x,this._y),cc.view._convertPointWithScale(e),e}},{key:"_setPrevCursor",value:function(e,t){this._prevX=e,this._prevY=t}},{key:"getPreviousLocation",value:function(e){return e=e||new Vec2,Vec2.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e=e||new Vec2,Vec2.set(e,this._prevX,this._prevY),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e=e||new Vec2,Vec2.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e=e||new Vec2,Vec2.set(e,(this._x-this._prevX)/cc.view.getScaleX(),(this._y-this._prevY)/cc.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/cc.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/cc.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._y-e.y)/cc.view.getScaleY()}}]),r}();EventMouse.NONE=0,EventMouse.DOWN=1,EventMouse.UP=2,EventMouse.MOVE=3,EventMouse.SCROLL=4,EventMouse.BUTTON_LEFT=0,EventMouse.BUTTON_RIGHT=2,EventMouse.BUTTON_MIDDLE=1,EventMouse.BUTTON_4=3,EventMouse.BUTTON_5=4,EventMouse.BUTTON_6=5,EventMouse.BUTTON_7=6,EventMouse.BUTTON_8=7;var EventTouch=function(){function r(e,t){var i;return _classCallCheck(this,r),(i=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this,Event.TOUCH,t))).touch=null,i._eventCode=0,i.simulate=!1,i._touches=void 0,i._eventCode=0,i._touches=e||[],i}return _inherits(r,Event),_createClass(r,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"_setEventCode",value:function(e){this._eventCode=e}},{key:"_setTouches",value:function(e){this._touches=e}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new Vec2}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new Vec2}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Vec2}},{key:"getUILocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Vec2}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new Vec2}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new Vec2}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new Vec2}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new Vec2}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new Vec2}},{key:"getDeltaX",value:function(e){return this.touch?this.touch.getDelta(e).x:0}},{key:"getDeltaY",value:function(e){return this.touch?this.touch.getDelta(e).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),r}();EventTouch.MAX_TOUCHES=5,EventTouch.BEGAN=0,EventTouch.MOVED=1,EventTouch.ENDED=2,EventTouch.CANCELLED=3;var EventAcceleration=function(){function r(e,t){var i;return _classCallCheck(this,r),(i=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this,Event.ACCELERATION,t))).acc=void 0,i.acc=e,i}return _inherits(r,Event),r}(),EventKeyboard=function(){function n(e,t,i){var r;return _classCallCheck(this,n),(r=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this,Event.KEYBOARD,i))).keyCode=void 0,r.rawEvent=void 0,r.isPressed=void 0,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r.isPressed=t,r}return _inherits(n,Event),n}();Event.EventMouse=EventMouse,Event.EventTouch=EventTouch,Event.EventAcceleration=EventAcceleration,Event.EventKeyboard=EventKeyboard;var EventListener=function(){function r(e,t,i){_classCallCheck(this,r),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=e||0,this._listenerID=t||""}return _createClass(r,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){cc.assertID(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===cc.EventListener.TOUCH_ONE_BY_ONE?i=new TouchOneByOne:t===cc.EventListener.TOUCH_ALL_AT_ONCE?i=new TouchAllAtOnce:t===cc.EventListener.MOUSE?i=new Mouse:t===cc.EventListener.KEYBOARD?i=new Keyboard:t===cc.EventListener.ACCELERATION&&(i=new Acceleration(e.callback),delete e.callback),i)for(var r=0,n=Object.keys(e);r<n.length;r++){var s=n[r];i[s]=e[s]}return i}}]),_createClass(r,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),r}();EventListener.UNKNOWN=0,EventListener.TOUCH_ONE_BY_ONE=1,EventListener.TOUCH_ALL_AT_ONCE=2,EventListener.KEYBOARD=3,EventListener.MOUSE=4,EventListener.ACCELERATION=6,EventListener.CUSTOM=8,EventListener.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var ListenerID=EventListener.ListenerID,Mouse=function(){function i(){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,EventListener.MOUSE,ListenerID.MOUSE,null))).onMouseDown=null,t.onMouseUp=null,t.onMouseMove=null,t.onMouseScroll=null,t._onEvent=function(e){return t._callback(e)},t}return _inherits(i,EventListener),_createClass(i,[{key:"_callback",value:function(e){var t=cc.Event.EventMouse;switch(e._eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new i;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),i}(),TouchOneByOne=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,EventListener.TOUCH_ONE_BY_ONE,ListenerID.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return _inherits(t,EventListener),_createClass(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(cc.logID(1801),!1)}}]),t}(),TouchAllAtOnce=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,EventListener.TOUCH_ALL_AT_ONCE,ListenerID.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return _inherits(t,EventListener),_createClass(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(cc.logID(1802),!1)}}]),t}(),Acceleration=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,EventListener.ACCELERATION,ListenerID.ACCELERATION,null)))._onAccelerationEvent=null,t._onEvent=function(e){return t._callback(e)},t._onAccelerationEvent=e,t}return _inherits(i,EventListener),_createClass(i,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return cc.assertID(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new i(this._onAccelerationEvent)}}]),i}(),Keyboard=function(){function i(){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,EventListener.KEYBOARD,ListenerID.KEYBOARD,null))).onKeyPressed=null,t.onKeyReleased=null,t._onEvent=function(e){return t._callback(e)},t}return _inherits(i,EventListener),_createClass(i,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new i;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(cc.logID(1800),!1)}}]),i}(),ListenerID$1=(cc.EventListener=EventListener).ListenerID;function checkUINode(e){for(;e;){if(e.getComponent("cc.CanvasComponent"))return!0;e=e.parent}return!1}var _EventListenerVector=function(){function e(){_classCallCheck(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return _createClass(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();function __getListenerID(e){var t=Event,i=e.type;return i===t.ACCELERATION?ListenerID$1.ACCELERATION:i===t.KEYBOARD?ListenerID$1.KEYBOARD:i.startsWith(t.MOUSE)?ListenerID$1.MOUSE:(i.startsWith(t.TOUCH)&&cc.logID(2e3),"")}var _dec$c,_class$c,_dec2$3,_class2$9,_dec3,_class3$7,DIRTY_NONE=0,DIRTY_FIXED_PRIORITY=1,DIRTY_SCENE_GRAPH_PRIORITY=2,EventManager=function(){function e(){_classCallCheck(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[]}return _createClass(e,[{key:"pauseTarget",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(e instanceof cc._BaseNode){var r=this._nodeListenersMap[e.uuid];if(r)for(var n=0;n<r.length;++n){r[n]._setPaused(!0)}if(!0===i){var s=e.children;if(s)for(var a=0;a<s.length;++a){var o=s[a];this.pauseTarget(o,!0)}}}else cc.warnID(3506)}},{key:"resumeTarget",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(e instanceof cc._BaseNode){var r=this._nodeListenersMap[e.uuid];if(r)for(var n=0;n<r.length;++n){r[n]._setPaused(!1)}if(this._setDirtyForNode(e),!0===i&&0<e.children.length){var s=e.children;if(s)for(var a=0;a<s.length;++a){var o=s[a];this.resumeTarget(o,!0)}}}else cc.warnID(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var r=this._toAddedListeners;if(0!==r.length){for(var n=0,s=r.length;n<s;n++)this._forceAddEventListener(r[n]);r.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if(cc.assertID(e&&t,3503),cc.js.isNumber(t)||t instanceof cc._BaseNode){if(e instanceof cc.EventListener){if(e._isRegistered())return void cc.logID(3505)}else cc.assertID(!cc.js.isNumber(t),3504),e=cc.EventListener.create(e);if(e.checkAvailable()){if(cc.js.isNumber(t)){if(0===t)return void cc.logID(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!checkUINode(t))return void cc.logID(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}return e}}else cc.warnID(3506)}},{key:"addCustomListener",value:function(e,t){var i=EventListener.create({event:cc.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i}},{key:"removeListener",value:function(e){if(null!=e){var t=!1,i=this._listenersMap;for(var r in i){var n=i[r],s=n.getFixedPriorityListeners(),a=n.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(a,e))?this._setDirty(e._getListenerID(),DIRTY_SCENE_GRAPH_PRIORITY):(t=this._removeListenerInVector(s,e))&&this._setDirty(e._getListenerID(),DIRTY_FIXED_PRIORITY),n.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[r]),t)break}if(!t)for(var o=this._toAddedListeners,c=o.length-1;0<=c;c--){var l=o[c];if(l===e){cc.js.array.removeAt(o,c),l._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(cc.js.isNumber(e)||e instanceof cc._BaseNode)if(void 0!==e._id){var r=this._nodeListenersMap[e._id];if(r){for(var n=cc.js.array.copy(r),s=0;s<n.length;++s){var a=n[s];this.removeListener(a)}delete this._nodeListenersMap[e._id]}for(var o=this._toAddedListeners,c=0;c<o.length;){var l=o[c];l._getSceneGraphPriority()===e?(l._setSceneGraphPriority(null),l._setRegistered(!1),o.splice(c,1)):++c}if(!0===i)for(var u=e.getChildren(),h=0;h<u.length;++h){var _=u[h];this.removeListeners(_,!0)}}else e===cc.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(ListenerID$1.TOUCH_ONE_BY_ONE):e===cc.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(ListenerID$1.TOUCH_ALL_AT_ONCE):e===cc.EventListener.MOUSE?this._removeListenersForListenerID(ListenerID$1.MOUSE):e===cc.EventListener.ACCELERATION?this._removeListenersForListenerID(ListenerID$1.ACCELERATION):e===cc.EventListener.KEYBOARD?this._removeListenersForListenerID(ListenerID$1.KEYBOARD):cc.logID(3501);else cc.warnID(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}},{key:"setPriority",value:function(e,t){if(null!=e){var i=this._listenersMap;for(var r in i){var n=i[r].getFixedPriorityListeners();if(n)if(-1!==n.indexOf(e))return null!=e._getSceneGraphPriority()&&cc.logID(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),DIRTY_FIXED_PRIORITY)))}}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(cc.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=__getListenerID(e);this._sortEventListeners(t);var i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}else cc.errorID(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var i=new cc.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)}},{key:"_setDirtyForNode",value:function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var i=0,r=t.length;i<r;i++){var n=t[i]._getListenerID();null==this._dirtyListeners[n]&&(this._dirtyListeners[n]=!0)}if(0<e.children.length)for(var s=e.children,a=0,o=s?s.length:0;a<o;a++)this._setDirtyForNode(s[a])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new _EventListenerVector,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,DIRTY_SCENE_GRAPH_PRIORITY);var r=e._getSceneGraphPriority();null===r&&cc.logID(3507),this._associateNodeAndEventListener(r,e),r.activeInHierarchy&&this.resumeTarget(r)}else this._setDirty(t,DIRTY_FIXED_PRIORITY)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,DIRTY_SCENE_GRAPH_PRIORITY);this._dirtyListeners.length=0}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,i=e.length-1;0<=i;i--)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&cc.js.array.removeAt(e,i)}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),r=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(r),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var n=this._toAddedListeners,s=n.length-1;0<=s;s--){var a=n[s];a&&a._getListenerID()===e&&cc.js.array.removeAt(n,s)}}},{key:"_sortEventListeners",value:function(e){var t=DIRTY_NONE,i=this._priorityDirtyFlagMap;i[e]&&(t=i[e]),t!==DIRTY_NONE&&(i[e]=DIRTY_NONE,t&DIRTY_FIXED_PRIORITY&&this._sortListenersOfFixedPriority(e),t&DIRTY_SCENE_GRAPH_PRIORITY&&cc.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))}},{key:"_sortListenersOfSceneGraphPriority",value:function(e){var t=this._getListeners(e);if(t){var i=t.getSceneGraphPriorityListeners();i&&0!==i.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var i=e._getSceneGraphPriority(),r=t._getSceneGraphPriority();if(!(t&&r&&r._activeInHierarchy))return-1;if(!e||!i||!i._activeInHierarchy)return 1;for(var n=i,s=r,a=!1;n.parent._id!==s.parent._id;)n=null===n.parent.parent?(a=!0)&&r:n.parent,s=null===s.parent.parent?(a=!0)&&i:s.parent;if(n._id===s._id){if(n._id===r._id)return-1;if(n._id===i._id)return 1}var o=n.getSiblingIndex(),c=s.getSiblingIndex();return a?o-c:c-o}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var r=0,n=i.length;r<n&&!(0<=i[r]._getFixedPriority());)++r;t.gt0Index=r}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),r=this._toRemovedListeners;if(i)for(var n=i.length-1;0<=n;n--){var s=i[n];if(!s._isRegistered()){cc.js.array.removeAt(i,n);var a=r.indexOf(s);-1!==a&&r.splice(a,1)}}if(t)for(var o=t.length-1;0<=o;o--){var c=t[o];if(!c._isRegistered()){cc.js.array.removeAt(t,o);var l=r.indexOf(c);-1!==l&&r.splice(l,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if(cc.assertID(0<t,3508),!(1<t)){var i;(i=this._listenersMap[ListenerID$1.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(i),(i=this._listenersMap[ListenerID$1.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(i),cc.assertID(1===t,3509);var r=this._toAddedListeners;if(0!==r.length){for(var n=0,s=r.length;n<s;n++)this._forceAddEventListener(r[n]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var i=e[t],r=this._listenersMap[i._getListenerID()];if(r){var n=r.getFixedPriorityListeners(),s=r.getSceneGraphPriorityListeners();if(s){var a=s.indexOf(i);-1!==a&&s.splice(a,1)}if(n){var o=n.indexOf(i);-1!==o&&n.splice(o,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,r=i.touch;i.currentTarget=e._getSceneGraphPriority();var n=!1,s=-1,a=i.getEventCode();return a===EventTouch.BEGAN?e.onTouchBegan&&(n=e.onTouchBegan(r,i))&&e._isRegistered()&&e._claimedTouches.push(r):0<e._claimedTouches.length&&-1!==(s=e._claimedTouches.indexOf(r))&&(n=!0,a===EventTouch.MOVED&&e.onTouchMoved?e.onTouchMoved(r,i):a===EventTouch.ENDED?(e.onTouchEnded&&e.onTouchEnded(r,i),e._isRegistered()&&e._claimedTouches.splice(s,1)):a===EventTouch.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(r,i),e._isRegistered()&&e._claimedTouches.splice(s,1))),i.isStopped()?(eventManager._updateTouchListeners(i),!0):!!(n&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(r,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(ListenerID$1.TOUCH_ONE_BY_ONE),this._sortEventListeners(ListenerID$1.TOUCH_ALL_AT_ONCE);var t=this._getListeners(ListenerID$1.TOUCH_ONE_BY_ONE),i=this._getListeners(ListenerID$1.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var r=e.getTouches(),n=cc.js.array.copy(r),s={event:e,needsMutableSet:t&&i,touches:n,selTouch:null};if(t)for(var a=0;a<r.length;++a){var o=r[a];e.touch=o,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,s)}i&&0<n.length&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:n}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,r=t.touches,n=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),n===EventTouch.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(r,i):n===EventTouch.MOVED&&e.onTouchesMoved?e.onTouchesMoved(r,i):n===EventTouch.ENDED&&e.onTouchesEnded?e.onTouchesEnded(r,i):n===EventTouch.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(r,i),!!i.isStopped()&&(eventManager._updateTouchListeners(i),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(cc.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,i){var r=!1,n=e.getFixedPriorityListeners(),s=e.getSceneGraphPriorityListeners(),a=0;if(n&&0!==n.length)for(;a<e.gt0Index;++a){var o=n[a];if(o.isEnabled()&&!o._isPaused()&&o._isRegistered()&&t(o,i)){r=!0;break}}if(s&&!r)for(var c=0;c<s.length;++c){var l=s[c];if(l.isEnabled()&&!l._isPaused()&&l._isRegistered()&&t(l,i)){r=!0;break}}if(n&&!r)for(;a<n.length;++a){var u=n[a];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,i)){r=!0;break}}}},{key:"_setDirty",value:function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;0<=i;i--){var r=e[i];if(r._onCustomEvent===t||r.onEvent===t)return r._setRegistered(!1),null!=r._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(r._getSceneGraphPriority(),r),r._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(r),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;0<=i;i--){var r=e[i];if(r===t)return r._setRegistered(!1),null!=r._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(r._getSceneGraphPriority(),r),r._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(r),!0}return!1}}]),e}(),eventManager=new EventManager;cc.eventManager=eventManager;var Script=(_dec$c=ccclass("cc.Script"))(_class$c=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,Asset),e}())||_class$c;cc._Script=Script;var JavaScript=(_dec2$3=ccclass("cc.JavaScript"))(_class2$9=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,Script),e}())||_class2$9;cc._JavaScript=JavaScript;var _dec$d,_dec2$4,_dec3$1,_dec4,_dec5,_dec6,_dec7,_class$d,_class2$a,_descriptor$8,_descriptor2$4,_class3$8,_temp$c,TypeScript=(_dec3=ccclass("cc.TypeScript"))(_class3$7=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,Script),e}())||_class3$7;cc._TypeScript=TypeScript;var idGenerator$1=new IDGenerator("Comp"),IsOnEnableCalled$1=CCObject.Flags.IsOnEnableCalled,IsOnLoadCalled$1=CCObject.Flags.IsOnLoadCalled,NullNode=null,Component=(_dec$d=ccclass("cc.Component"),_dec2$4=property({visible:!1}),_dec3$1=property({visible:!1}),_dec4=property({displayName:"Script",type:Script,tooltip:void 0}),_dec5=property({visible:!1}),_dec6=property({visible:!1}),_dec7=property({visible:!1}),_dec$d((_temp$c=_class3$8=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"node",_descriptor$8,_assertThisInitialized(t)),_initializerDefineProperty(t,"_enabled",_descriptor2$4,_assertThisInitialized(t)),t._sceneGetter=null,t._id=idGenerator$1.getNewId(),t._eventTargets=[],t}return _inherits(s,CCObject),_createClass(s,[{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){_get(_getPrototypeOf(s.prototype),"destroy",this).call(this)&&this._enabled&&this.node.activeInHierarchy&&cc.director._compScheduler.disableComp(this)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks();for(var e=this._eventTargets,t=0,i=e.length;t<i;++t){var r=e[t];r&&r.targetOff(this)}e.length=0,cc.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return(e=e||cc.instantiate._clone(this,this)).node=null,e}},{key:"schedule",value:function(e,t,i,r){var n=1<arguments.length&&void 0!==t?t:0,s=2<arguments.length&&void 0!==i?i:cc.macro.REPEAT_FOREVER,a=3<arguments.length&&void 0!==r?r:0;cc.assertID(e,1619),cc.assertID(0<=n,1620),n=n||0,s=isNaN(s)?cc.macro.REPEAT_FOREVER:s,a=a||0;var o=cc.director.getScheduler(),c=o.isTargetPaused(this);o.schedule(e,this,n,s,a,c)}},{key:"scheduleOnce",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;this.schedule(e,0,0,i)}},{key:"unschedule",value:function(e){e&&cc.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){cc.director.getScheduler().unscheduleAllForTarget(this)}},{key:"name",get:function(){if(this._name)return this._name;var e=getClassName(this),t=e.lastIndexOf(".");return 0<=t&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=cc.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&IsOnLoadCalled$1}}]),s}(),_class3$8.system=null,_applyDecoratedDescriptor((_class2$a=_temp$c).prototype,"name",[_dec2$4],Object.getOwnPropertyDescriptor(_class2$a.prototype,"name"),_class2$a.prototype),_applyDecoratedDescriptor(_class2$a.prototype,"uuid",[_dec3$1],Object.getOwnPropertyDescriptor(_class2$a.prototype,"uuid"),_class2$a.prototype),_applyDecoratedDescriptor(_class2$a.prototype,"__scriptAsset",[_dec4],Object.getOwnPropertyDescriptor(_class2$a.prototype,"__scriptAsset"),_class2$a.prototype),_applyDecoratedDescriptor(_class2$a.prototype,"enabled",[_dec5],Object.getOwnPropertyDescriptor(_class2$a.prototype,"enabled"),_class2$a.prototype),_applyDecoratedDescriptor(_class2$a.prototype,"enabledInHierarchy",[_dec6],Object.getOwnPropertyDescriptor(_class2$a.prototype,"enabledInHierarchy"),_class2$a.prototype),_descriptor$8=_applyDecoratedDescriptor(_class2$a.prototype,"node",[_dec7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NullNode}}),_descriptor2$4=_applyDecoratedDescriptor(_class2$a.prototype,"_enabled",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_class$d=_class2$a))||_class$d),proto=Component.prototype;proto.update=null,proto.lateUpdate=null,proto.__preload=null,proto.onLoad=null,proto.start=null,proto.onEnable=null,proto.onDisable=null,proto.onDestroy=null,proto.onFocusInEditor=null,proto.onLostFocusInEditor=null,proto.resetInEditor=null,proto._getLocalBounds=null,proto.onRestore=null,Component._requireComponent=null,Component._executionOrder=0,value(Component,"_registerEditorProps",function(e,t){var i=t.requireComponent;i&&(e._requireComponent=i);var r=t.executionOrder;r&&"number"==typeof r&&(e._executionOrder=r)}),cc.Component=Component;var Destroying$1=CCObject.Flags.Destroying;function baseNodePolyfill(e){}var _cachedArray=new Array(16),_currentHovered=null,pos=new Vec2,_touchEvents=[exports.SystemEventType.TOUCH_START.toString(),exports.SystemEventType.TOUCH_MOVE.toString(),exports.SystemEventType.TOUCH_END.toString(),exports.SystemEventType.TOUCH_CANCEL.toString()],_mouseEvents=[exports.SystemEventType.MOUSE_DOWN.toString(),exports.SystemEventType.MOUSE_ENTER.toString(),exports.SystemEventType.MOUSE_MOVE.toString(),exports.SystemEventType.MOUSE_LEAVE.toString(),exports.SystemEventType.MOUSE_UP.toString(),exports.SystemEventType.MOUSE_WHEEL.toString()];function _touchStartHandler(e,t){var i=this.owner;return!(!i||!i.uiTransfromComp)&&(e.getUILocation(pos),!!i.uiTransfromComp.isHit(pos,this)&&(t.type=exports.SystemEventType.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),!0))}function _touchMoveHandler(e,t){var i=this.owner;if(!i||!i.uiTransfromComp)return!1;t.type=exports.SystemEventType.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function _touchEndHandler(e,t){var i=this.owner;i&&i.uiTransfromComp&&(e.getUILocation(pos),i.uiTransfromComp.isHit(pos,this)?t.type=exports.SystemEventType.TOUCH_END.toString():t.type=exports.SystemEventType.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function _touchCancelHandler(e,t){var i=this.owner;i&&i.uiTransfromComp&&(t.type=exports.SystemEventType.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function _mouseDownHandler(e){var t=this.owner;t&&t.uiTransfromComp&&(pos=e.getUILocation(),t.uiTransfromComp.isHit(pos,this)&&(e.type=exports.SystemEventType.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function _mouseMoveHandler(e){var t=this.owner;if(t&&t.uiTransfromComp){if(pos=e.getUILocation(),t.uiTransfromComp.isHit(pos,this))this._previousIn||(_currentHovered&&_currentHovered.eventProcessor.mouseListener&&(e.type=exports.SystemEventType.MOUSE_LEAVE,_currentHovered.dispatchEvent(e),_currentHovered.eventProcessor.mouseListener&&(_currentHovered.eventProcessor.mouseListener._previousIn=!1)),_currentHovered=t,e.type=exports.SystemEventType.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=exports.SystemEventType.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=exports.SystemEventType.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,_currentHovered=null}e.propagationStopped=!0}}function _mouseUpHandler(e){var t=this.owner;t&&t.uiTransfromComp&&(pos=e.getUILocation(),t.uiTransfromComp.isHit(pos,this)&&(e.type=exports.SystemEventType.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function _mouseWheelHandler(e){var t=this.owner;t&&t.uiTransfromComp&&(pos=e.getUILocation(),t.uiTransfromComp.isHit(pos,this)&&(e.type=exports.SystemEventType.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function _doDispatchEvent(e,t){var i,r=0;for(t.target=e,_cachedArray.length=0,e.eventProcessor.getCapturingTargets(t.type,_cachedArray),t.eventPhase=1,r=_cachedArray.length-1;0<=r;--r)if((i=_cachedArray[r]).eventProcessor.capturingTargets&&((t.currentTarget=i).eventProcessor.capturingTargets.emit(t.type,t,_cachedArray),t.propagationStopped))return void(_cachedArray.length=0);if(_cachedArray.length=0,t.eventPhase=2,(t.currentTarget=e).eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,_cachedArray),t.eventPhase=3,r=0;r<_cachedArray.length;++r)if((i=_cachedArray[r]).eventProcessor.bubblingTargets&&((t.currentTarget=i).eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(_cachedArray.length=0);_cachedArray.length=0}function _searchMaskInParent(e){var t=cc.MaskComponent;if(t)for(var i=0,r=e;r&&cc.Node.isNode(r);r=r.parent,++i)if(r.getComponent(t))return{index:i,node:r};return null}function _checkListeners(e,t){if(e._persistNode)return!0;var i=0;if(e.eventProcessor.bubblingTargets)for(;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}var _dec$e,_class$e,_class2$b,_descriptor$9,_descriptor2$5,_descriptor3$4,_descriptor4$3,_descriptor5$2,_class3$9,_temp$d,NodeEventProcessor=function(){function t(e){_classCallCheck(this,t),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}return _createClass(t,[{key:"node",get:function(){return this._node}}]),_createClass(t,[{key:"reattach",value:function(){if(this.touchListener){var e=this.touchListener.mask=_searchMaskInParent(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=_searchMaskInParent(this._node))}},{key:"destroy",value:function(){_currentHovered===this._node&&(_currentHovered=null),(this.touchListener||this.mouseListener)&&(eventManager.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null))}},{key:"on",value:function(e,t,i,r){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,r):(this.bubblingTargets||(this.bubblingTargets=new EventTarget),this.bubblingTargets.on(e,t,i))}},{key:"once",value:function(e,t,i,r){(this._checknSetupSysEvent(e)&&r?this.capturingTargets=this.capturingTargets||new EventTarget:this.bubblingTargets=this.bubblingTargets||new EventTarget).once(e,t,i)}},{key:"off",value:function(e,t,i,r){var n=-1!==_touchEvents.indexOf(e),s=!n&&-1!==_mouseEvents.indexOf(e);n||s?(this._offDispatch(e,t,i,r),n?this.touchListener&&!_checkListeners(this._node,_touchEvents)&&(eventManager.removeListener(this.touchListener),this.touchListener=null):s&&this.mouseListener&&!_checkListeners(this._node,_mouseEvents)&&(eventManager.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}},{key:"emit",value:function(e){if(this.bubblingTargets){for(var t,i=arguments.length,r=new Array(1<i?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];(t=this.bubblingTargets).emit.apply(t,[e].concat(r))}}},{key:"dispatchEvent",value:function(e){_doDispatchEvent(this._node,e),_cachedArray.length=0}},{key:"hasEventListener",value:function(e){var t=!1;return this.bubblingTargets&&(t=this.bubblingTargets.hasEventListener(e)),!t&&this.capturingTargets&&(t=this.capturingTargets.hasEventListener(e)),t}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.targetOff(e),this.bubblingTargets&&this.bubblingTargets.targetOff(e),this.touchListener&&!_checkListeners(this.node,_touchEvents)&&(eventManager.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!_checkListeners(this.node,_mouseEvents)&&(eventManager.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"getBubblingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,i=!1,r=!1;return-1!==_touchEvents.indexOf(e)?(this.touchListener||(this.touchListener=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:_searchMaskInParent(this._node),onTouchBegan:_touchStartHandler,onTouchMoved:_touchMoveHandler,onTouchEnded:_touchEndHandler,onTouchCancelled:_touchCancelHandler}),eventManager.addListener(this.touchListener,this._node),i=!0),r=!0):-1!==_mouseEvents.indexOf(e)&&(this.mouseListener||(this.mouseListener=cc.EventListener.create({event:cc.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:_searchMaskInParent(this._node),onMouseDown:_mouseDownHandler,onMouseMove:_mouseMoveHandler,onMouseUp:_mouseUpHandler,onMouseScroll:_mouseWheelHandler}),eventManager.addListener(this.mouseListener,this._node),i=!0),r=!0),i&&!this._node.activeInHierarchy&&cc.director.getScheduler().schedule(function(){t._node.activeInHierarchy||eventManager.pauseTarget(t._node)},this._node,0,0,0,!1),r}},{key:"_onDispatch",value:function(e,t,i,r){if("boolean"==typeof i?(r=i,i=void 0):r=!!r,t){var n=null;return(n=r?this.capturingTargets=this.capturingTargets||new EventTarget:this.bubblingTargets=this.bubblingTargets||new EventTarget).hasEventListener(e,t,i)||n.on(e,t,i),t}cc.errorID(6800)}},{key:"_offDispatch",value:function(e,t,i,r){if("boolean"==typeof i?(r=i,i=void 0):r=!!r,t){var n=r?this.capturingTargets:this.bubblingTargets;n&&n.off(e,t,i)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),t}();cc.NodeEventProcessor=NodeEventProcessor;var Destroying$2=CCObject.Flags.Destroying,DontDestroy$1=CCObject.Flags.DontDestroy,Deactivating$1=CCObject.Flags.Deactivating,Activating=CCObject.Flags.Activating,ChangingState=Activating|Deactivating$1,TRANFORM_ON=1,idGenerator$2=new IDGenerator("Node"),NullScene=null;function getConstructor(e){return e?"string"==typeof e?getClassByName(e):e:(errorID(3804),null)}var NodeSpace,TransformDirtyBit,_dec$f,_dec2$5,_class$f,_class2$c,_descriptor$a,_descriptor2$6,_descriptor3$5,_descriptor4$4,_descriptor5$3,_class3$a,_temp$e,BaseNode=(_dec$e=ccclass("cc._BaseNode"))((_temp$d=_class3$9=function(){function l(e){var t;return _classCallCheck(this,l),_initializerDefineProperty(t=_possibleConstructorReturn(this,_getPrototypeOf(l).call(this,e)),"_parent",_descriptor$9,_assertThisInitialized(t)),_initializerDefineProperty(t,"_children",_descriptor2$5,_assertThisInitialized(t)),_initializerDefineProperty(t,"_active",_descriptor3$4,_assertThisInitialized(t)),_initializerDefineProperty(t,"_components",_descriptor4$3,_assertThisInitialized(t)),_initializerDefineProperty(t,"_prefab",_descriptor5$2,_assertThisInitialized(t)),t._scene=NullScene,t._activeInHierarchy=!1,t._id=idGenerator$2.getNewId(),t._name=void 0,t._eventProcessor=new NodeEventProcessor(_assertThisInitialized(t)),t._eventMask=0,t.__eventTargets=[],t._siblingIndex=0,t._name=void 0!==e?e:"New Node",t}return _inherits(l,CCObject),_createClass(l,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return 0<(this._objFlags&DontDestroy$1)},set:function(e){e?this._objFlags|=DontDestroy$1:this._objFlags&=~DontDestroy$1}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&cc.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"_setScene",value:function(e){e instanceof cc.Scene?e._scene=e:null==e._parent?cc.error("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){var i=t,r=e._components;if(i._sealed)for(var n=0;n<r.length;++n){var s=r[n];if(s.constructor===t)return s}else for(var a=0;a<r.length;++a){var o=r[a];if(o instanceof t)return o}return null}},{key:"_findComponents",value:function(e,t,i){var r=t,n=e._components;if(r._sealed)for(var s=0;s<n.length;++s){var a=n[s];a.constructor===t&&i.push(a)}else for(var o=0;o<n.length;++o){var c=n[o];c instanceof t&&i.push(c)}}},{key:"_findChildComponent",value:function(e,t){for(var i=0;i<e.length;++i){var r=e[i],n=l._findComponent(r,t);if(n)return n;if(0<r._children.length&&(n=l._findChildComponent(r._children,t)))return n}return null}},{key:"_findChildComponents",value:function(e,t,i){for(var r=0;r<e.length;++r){var n=e[r];l._findComponents(n,t,i),0<n._children.length&&l._findChildComponents(n._children,t,i)}}}]),_createClass(l,[{key:"attr",value:function(e){mixin(this,e)}},{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(this._parent!==e){var r=this._parent;if(this._parent=e,this._siblingIndex=0,this._onSetParent(r,i),this.emit&&this.emit(exports.SystemEventType.PARENT_CHANGED,r),e&&(e._children.push(this),this._siblingIndex=e._children.length-1,e.emit&&e.emit(exports.SystemEventType.CHILD_ADDED,this)),r&&!(r._objFlags&Destroying$2)){var n=r._children.indexOf(this);0,r._children.splice(n,1),r._updateSiblingIndex(),r.emit&&r.emit(exports.SystemEventType.CHILD_REMOVED,this)}this._onHierarchyChanged(r)}}},{key:"getChildByUuid",value:function(e){if(!e)return cc.log("Invalid uuid"),null;for(var t=this._children,i=0,r=t.length;i<r;i++)if(t[i]._id===e)return t[i];return null}},{key:"getChildByName",value:function(e){if(!e)return cc.log("Invalid name"),null;for(var t=this._children,i=0,r=t.length;i<r;i++)if(t[i]._name===e)return t[i];return null}},{key:"getChildByPath",value:function(e){for(var r=e.split("/"),n=this,t=function(e){var t=r[e];if(0===t.length)return"continue";var i=n.children.find(function(e){return e.name===t});if(!i)return{v:null};n=i},i=0;i<r.length;++i){var s=t(i);switch(s){case"continue":continue;default:if("object"===_typeof(s))return s.v}}return n}},{key:"addChild",value:function(e){cc.assertID(e,1606),cc.assertID(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&Deactivating$1)errorID(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,t){var i=1,r=null,n=null,s=0,a=l._stacks[l._stackId];a||(a=[],l._stacks.push(a)),l._stackId++,a.length=0,a[0]=this;for(var o=null,c=!1;i;)if(n=a[--i])if(!c&&e?e(n):c&&t&&t(n),a[i]=null,c){if(c=!1,r)if(r[++s])a[i]=r[s],i++;else if(o&&(a[i]=o,i++,c=!0,o._parent?(s=(r=o._parent._children).indexOf(o),o=o._parent):r=o=null,s<0))break}else 0<n._children.length?(r=(o=n)._children,s=0,a[i]=r[s],i++):(a[i]=n,i++,c=!0);a.length=0,l._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){-1<this._children.indexOf(e)&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;0<=t;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var t=getConstructor(e);return t?l._findComponent(this,t):null}},{key:"getComponents",value:function(e){var t=getConstructor(e),i=[];return t&&l._findComponents(this,t,i),i}},{key:"getComponentInChildren",value:function(e){var t=getConstructor(e);return t?l._findChildComponent(this._children,t):null}},{key:"getComponentsInChildren",value:function(e){var t=getConstructor(e),i=[];return t&&(l._findComponents(this,t,i),l._findChildComponents(this._children,t,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=getClassByName(e)))return errorID(3807,e),cc._RF.peek()&&errorID(3808,e),null}else{if(!e)return errorID(3804),null;t=e}if("function"!=typeof t)return errorID(3809),null;if(!isChildClassOf(t,cc.Component))return errorID(3810),null;var i=t._requireComponent;if(i&&!this.getComponent(i)&&!this.addComponent(i))return null;var r=new t;return(r.node=this)._components.push(r),this._activeInHierarchy&&cc.director._nodeActivator.activateComp(r),r}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof Component?e:this.getComponent(e))&&t.destroy()}else errorID(3813)}},{key:"on",value:function(e,t,i,r){switch(e){case exports.SystemEventType.TRANSFORM_CHANGED:this._eventMask|=TRANFORM_ON}this._eventProcessor.on(e,t,i,r)}},{key:"off",value:function(e,t,i,r){if(this._eventProcessor.off(e,t,i,r),!this._eventProcessor.hasEventListener(e))switch(e){case exports.SystemEventType.TRANSFORM_CHANGED:this._eventMask&=~TRANFORM_ON}}},{key:"once",value:function(e,t,i,r){this._eventProcessor.once(e,t,i,r)}},{key:"emit",value:function(e){for(var t,i=arguments.length,r=new Array(1<i?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];(t=this._eventProcessor).emit.apply(t,[e].concat(r))}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e){return this._eventProcessor.hasEventListener(e)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),this._eventMask&TRANFORM_ON&&!this._eventProcessor.hasEventListener(exports.SystemEventType.TRANSFORM_CHANGED)&&(this._eventMask&=~TRANFORM_ON)}},{key:"destroy",value:function(){return!!_get(_getPrototypeOf(l.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&Destroying$2)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&errorID(3815)}}else errorID(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(function(e){l._setScene(e)}))}},{key:"_onPostActivated",value:function(e){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e=e||cc.instantiate._clone(this,this);var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof cc.Scene||cc.game.removePersistRootNode(this);var i=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==i&&cc.director._nodeActivator.activateNode(this,i)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=Destroying$2;var e=this._parent,t=null!==e&&0!=(e._objFlags&Destroying$2);for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var n=this._components,s=0;s<n.length;++s)n[s]._destroyImmediate();for(var a=this.__eventTargets,o=0;o<a.length;++o){var c=a[o];c&&c.targetOff(this)}if(a.length=0,this._persistNode&&cc.game.removePersistRootNode(this),!t&&e){var l=e._children.indexOf(this);e._children.splice(l,1),this._siblingIndex=0,e.emit&&e.emit("child-removed",this)}return t}},{key:"_disableChildComps",value:function(){for(var e=this._components,t=0;t<e.length;++t){var i=e[t];i._enabled&&cc.director._compScheduler.disableComp(i)}for(var r=this._children,n=0;n<r.length;++n){var s=r[n];s._active&&s._disableChildComps()}}}]),l}(),_class3$9.idGenerator=idGenerator$2,_class3$9._stacks=[[]],_class3$9._stackId=0,_applyDecoratedDescriptor((_class2$b=_temp$d).prototype,"_persistNode",[property],Object.getOwnPropertyDescriptor(_class2$b.prototype,"_persistNode"),_class2$b.prototype),_applyDecoratedDescriptor(_class2$b.prototype,"name",[property],Object.getOwnPropertyDescriptor(_class2$b.prototype,"name"),_class2$b.prototype),_applyDecoratedDescriptor(_class2$b.prototype,"uuid",[property],Object.getOwnPropertyDescriptor(_class2$b.prototype,"uuid"),_class2$b.prototype),_applyDecoratedDescriptor(_class2$b.prototype,"children",[property],Object.getOwnPropertyDescriptor(_class2$b.prototype,"children"),_class2$b.prototype),_applyDecoratedDescriptor(_class2$b.prototype,"active",[property],Object.getOwnPropertyDescriptor(_class2$b.prototype,"active"),_class2$b.prototype),_applyDecoratedDescriptor(_class2$b.prototype,"activeInHierarchy",[property],Object.getOwnPropertyDescriptor(_class2$b.prototype,"activeInHierarchy"),_class2$b.prototype),_applyDecoratedDescriptor(_class2$b.prototype,"parent",[property],Object.getOwnPropertyDescriptor(_class2$b.prototype,"parent"),_class2$b.prototype),_descriptor$9=_applyDecoratedDescriptor(_class2$b.prototype,"_parent",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$5=_applyDecoratedDescriptor(_class2$b.prototype,"_children",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor3$4=_applyDecoratedDescriptor(_class2$b.prototype,"_active",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor4$3=_applyDecoratedDescriptor(_class2$b.prototype,"_components",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor5$2=_applyDecoratedDescriptor(_class2$b.prototype,"_prefab",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$e=_class2$b))||_class$e;baseNodePolyfill(BaseNode),cc._BaseNode=BaseNode,function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(NodeSpace=NodeSpace||{}),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(TransformDirtyBit=TransformDirtyBit||{});var _dec$g,_class$g,_class2$d,_descriptor$b,_temp$f,_dec2$6,_class4,_class5,_descriptor2$7,_temp2,v3_a=new Vec3,q_a=new Quat,q_b=new Quat,array_a=new Array(10),qt_1$1=new Quat,m3_1$2=new Mat3,m3_scaling=new Mat3,m4_1=new Mat4,bookOfChange=new Map,Node$1=(_dec$f=ccclass("cc.Node"),_dec2$5=property({type:Vec3}),_dec$f((_temp$e=_class3$a=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._pos=new Vec3,t._rot=new Quat,t._scale=new Vec3(1,1,1),t._mat=new Mat4,_initializerDefineProperty(t,"_lpos",_descriptor$a,_assertThisInitialized(t)),_initializerDefineProperty(t,"_lrot",_descriptor2$6,_assertThisInitialized(t)),_initializerDefineProperty(t,"_lscale",_descriptor3$5,_assertThisInitialized(t)),_initializerDefineProperty(t,"_layer",_descriptor4$4,_assertThisInitialized(t)),_initializerDefineProperty(t,"_euler",_descriptor5$3,_assertThisInitialized(t)),t._dirtyFlags=TransformDirtyBit.NONE,t._eulerDirty=!1,t._uiTransfromComp=null,t._uiComp=null,t}return _inherits(s,BaseNode),_createClass(s,[{key:"setParent",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;i&&this.updateWorldTransform(),_get(_getPrototypeOf(s.prototype),"setParent",this).call(this,e,i)}},{key:"_onSetParent",value:function(e,t){if(_get(_getPrototypeOf(s.prototype),"_onSetParent",this).call(this,e,t),t){var i=this._parent;i?(i.updateWorldTransform(),Mat4.multiply(m4_1,Mat4.invert(m4_1,i._mat),this._mat),Mat4.toRTS(m4_1,this._lrot,this._lpos,this._lscale)):(Vec3.copy(this._lpos,this._pos),Quat.copy(this._lrot,this._rot),Vec3.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(TransformDirtyBit.TRS)}},{key:"_onBatchCreated",value:function(){_get(_getPrototypeOf(s.prototype),"_onBatchCreated",this).call(this),bookOfChange.set(this._id,TransformDirtyBit.TRS),this._dirtyFlags=TransformDirtyBit.TRS;for(var e=this._children.length,t=0;t<e;++t)this._children[t]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"translate",value:function(e,t){var i=t||NodeSpace.LOCAL;if(i===NodeSpace.LOCAL)Vec3.transformQuat(v3_a,e,this._lrot),this._lpos.x+=v3_a.x,this._lpos.y+=v3_a.y,this._lpos.z+=v3_a.z;else if(i===NodeSpace.WORLD)if(this._parent){Quat.invert(q_a,this._parent.worldRotation),Vec3.transformQuat(v3_a,e,q_a);var r=this.worldScale;this._lpos.x+=v3_a.x/r.x,this._lpos.y+=v3_a.y/r.y,this._lpos.z+=v3_a.z/r.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(TransformDirtyBit.POSITION),this._eventMask&TRANFORM_ON&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.POSITION_PART)}},{key:"rotate",value:function(e,t){var i=t||NodeSpace.LOCAL;if(Quat.normalize(q_a,e),i===NodeSpace.LOCAL)Quat.multiply(this._lrot,this._lrot,q_a);else if(i===NodeSpace.WORLD){var r=this.worldRotation;Quat.multiply(q_b,q_a,r),Quat.invert(q_a,r),Quat.multiply(q_b,q_a,q_b),Quat.multiply(this._lrot,this._lrot,q_b)}this._eulerDirty=!0,this.invalidateChildren(TransformDirtyBit.ROTATION),this._eventMask&TRANFORM_ON&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.ROTATION_PART)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(v3_a),Vec3.subtract(v3_a,v3_a,e),Vec3.normalize(v3_a,v3_a),Quat.fromViewUp(q_a,v3_a,t),this.setWorldRotation(q_a)}},{key:"invalidateChildren",value:function(e){if((this._dirtyFlags&this.hasChangedFlags&e)!==e){this._dirtyFlags|=e,bookOfChange.set(this._id,this.hasChangedFlags|e),e|=TransformDirtyBit.POSITION;for(var t=this._children.length,i=0;i<t;++i)this._children[i].invalidateChildren(e)}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,i=0;t&&t._dirtyFlags;)t=(array_a[i++]=t)._parent;for(var r=0;i;)r|=(e=array_a[--i])._dirtyFlags,t?(r&TransformDirtyBit.POSITION&&(Vec3.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),r&TransformDirtyBit.RS&&(Mat4.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Mat4.multiply(e._mat,t._mat,e._mat),r&TransformDirtyBit.ROTATION&&Quat.multiply(e._rot,t._rot,e._lrot),Mat3.fromQuat(m3_1$2,Quat.conjugate(qt_1$1,e._rot)),Mat3.multiplyMat4(m3_1$2,m3_1$2,e._mat),e._scale.x=m3_1$2.m00,e._scale.y=m3_1$2.m04,e._scale.z=m3_1$2.m08)):(r&TransformDirtyBit.POSITION&&(Vec3.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),r&TransformDirtyBit.RS&&(r&TransformDirtyBit.ROTATION?Quat.copy(e._rot,e._lrot):Vec3.copy(e._scale,e._lscale),Mat4.fromRTS(e._mat,e._rot,e._pos,e._scale))),e._dirtyFlags=TransformDirtyBit.NONE,t=e}}},{key:"setPosition",value:function(e,t,i){void 0===t||void 0===i?Vec3.copy(this._lpos,e):Vec3.set(this._lpos,e,t,i),this.invalidateChildren(TransformDirtyBit.POSITION),this._eventMask&TRANFORM_ON&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.POSITION_PART)}},{key:"getPosition",value:function(e){return e?Vec3.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Vec3.copy(new Vec3,this._lpos)}},{key:"setRotation",value:function(e,t,i,r){void 0===t||void 0===i||void 0===r?Quat.copy(this._lrot,e):Quat.set(this._lrot,e,t,i,r),this._eulerDirty=!0,this.invalidateChildren(TransformDirtyBit.ROTATION),this._eventMask&TRANFORM_ON&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.ROTATION_PART)}},{key:"setRotationFromEuler",value:function(e,t,i){Vec3.set(this._euler,e,t,i),Quat.fromEuler(this._lrot,e,t,i),this._eulerDirty=!1,this.invalidateChildren(TransformDirtyBit.ROTATION),this._eventMask&TRANFORM_ON&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.ROTATION_PART)}},{key:"getRotation",value:function(e){return e?Quat.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Quat.copy(new Quat,this._lrot)}},{key:"setScale",value:function(e,t,i){void 0===t||void 0===i?Vec3.copy(this._lscale,e):Vec3.set(this._lscale,e,t,i),this.invalidateChildren(TransformDirtyBit.SCALE),this._eventMask&TRANFORM_ON&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.SCALE_PART)}},{key:"getScale",value:function(e){return e?Vec3.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Vec3.copy(new Vec3,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){Vec3.copy(e,t);for(var i=this,r=0;i._parent;)i=(array_a[r++]=i)._parent;for(;0<=r;)Vec3.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=array_a[--r];return e}},{key:"setWorldPosition",value:function(e,t,i){void 0===t||void 0===i?Vec3.copy(this._pos,e):Vec3.set(this._pos,e,t,i);var r=this._parent,n=this._lpos;r?(r.updateWorldTransform(),Vec3.transformMat4(n,this._pos,Mat4.invert(m4_1,r._mat))):Vec3.copy(n,this._pos),this.invalidateChildren(TransformDirtyBit.POSITION),this._eventMask&TRANFORM_ON&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.POSITION_PART)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?Vec3.copy(e,this._pos):Vec3.copy(new Vec3,this._pos)}},{key:"setWorldRotation",value:function(e,t,i,r){void 0===t||void 0===i||void 0===r?Quat.copy(this._rot,e):Quat.set(this._rot,e,t,i,r),this._parent?(this._parent.updateWorldTransform(),Quat.multiply(this._lrot,Quat.conjugate(this._lrot,this._parent._rot),this._rot)):Quat.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(TransformDirtyBit.ROTATION),this._eventMask&TRANFORM_ON&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.ROTATION_PART)}},{key:"setWorldRotationFromEuler",value:function(e,t,i){Quat.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),Quat.multiply(this._lrot,Quat.conjugate(this._lrot,this._parent._rot),this._rot)):Quat.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(TransformDirtyBit.ROTATION),this._eventMask&TRANFORM_ON&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.ROTATION_PART)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?Quat.copy(e,this._rot):Quat.copy(new Quat,this._rot)}},{key:"setWorldScale",value:function(e,t,i){void 0===t||void 0===i?Vec3.copy(this._scale,e):Vec3.set(this._scale,e,t,i);var r=this._parent;r?(r.updateWorldTransform(),Mat3.fromQuat(m3_1$2,Quat.conjugate(qt_1$1,r._rot)),Mat3.multiplyMat4(m3_1$2,m3_1$2,r._mat),m3_scaling.m00=this._scale.x,m3_scaling.m04=this._scale.y,m3_scaling.m08=this._scale.z,Mat3.multiply(m3_1$2,m3_scaling,Mat3.invert(m3_1$2,m3_1$2)),this._lscale.x=m3_1$2.m00,this._lscale.y=m3_1$2.m04,this._lscale.z=m3_1$2.m08):Vec3.copy(this._lscale,this._scale),this.invalidateChildren(TransformDirtyBit.SCALE),this._eventMask&TRANFORM_ON&&this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.SCALE_PART)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?Vec3.copy(e,this._scale):Vec3.copy(new Vec3,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransform(),e=e||new Mat4,Mat4.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransform(),e=e||new Mat4,Mat4.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e=e||new Mat4,Mat4.fromRT(e,this._rot,this._pos)}},{key:"getAnchorPoint",value:function(e){return(e=e||new Vec2).set(this.uiTransfromComp.anchorPoint),e}},{key:"setAnchorPoint",value:function(e,t){this.uiTransfromComp.setAnchorPoint(e,t)}},{key:"getContentSize",value:function(e){return(e=e||new Size).set(this.uiTransfromComp.contentSize),e}},{key:"setContentSize",value:function(e,t){this.uiTransfromComp.setContentSize(e,t)}},{key:"pauseSystemEvents",value:function(e){eventManager.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){eventManager.resumeTarget(this,e)}},{key:"_onPostActivated",value:function(e){e?(eventManager.resumeTarget(this),this.eventProcessor.reattach()):eventManager.pauseTarget(this)}},{key:"_onPreDestroy",value:function(){this._eventProcessor.destroy(),_get(_getPrototypeOf(s.prototype),"_onPreDestroy",this).call(this)}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(Quat.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Mat4.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(TransformDirtyBit.TRS),this._eulerDirty=!0,this._eventMask&TRANFORM_ON&&(this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.POSITION_PART),this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.ROTATION_PART),this.emit(exports.SystemEventType.TRANSFORM_CHANGED,exports.SystemEventType.SCALE_PART))}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return Vec3.transformQuat(new Vec3,Vec3.UNIT_Z,this.worldRotation)},set:function(e){var t=e.length();Vec3.multiplyScalar(v3_a,e,-1/t),Quat.fromViewUp(q_a,v3_a),this.setWorldRotation(q_a)}},{key:"layer",set:function(e){this._layer=e},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return bookOfChange.get(this._id)||0},set:function(e){bookOfChange.set(this._id,e)}},{key:"uiTransfromComp",get:function(){return this._uiTransfromComp||(this._uiTransfromComp=this.getComponent("cc.UITransformComponent")),this._uiTransfromComp},set:function(e){this._uiTransfromComp=e}},{key:"width",get:function(){return this.uiTransfromComp.width},set:function(e){this.uiTransfromComp.width=e}},{key:"height",get:function(){return this.uiTransfromComp.height},set:function(e){this.uiTransfromComp.height=e}},{key:"anchorX",get:function(){return this.uiTransfromComp.anchorX},set:function(e){this.uiTransfromComp.anchorX=e}},{key:"anchorY",get:function(){return this.uiTransfromComp.anchorY},set:function(e){this.uiTransfromComp.anchorY=e}}],[{key:"isNode",value:function(e){return e instanceof s&&(e.constructor===s||!(e instanceof cc.Scene))}}]),s}(),_class3$a.bookOfChange=bookOfChange,_class3$a.EventType=exports.SystemEventType,_class3$a.NodeSpace=NodeSpace,_class3$a.TransformDirtyBit=TransformDirtyBit,_descriptor$a=_applyDecoratedDescriptor((_class2$c=_temp$e).prototype,"_lpos",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3}}),_descriptor2$6=_applyDecoratedDescriptor(_class2$c.prototype,"_lrot",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Quat}}),_descriptor3$5=_applyDecoratedDescriptor(_class2$c.prototype,"_lscale",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3(1,1,1)}}),_descriptor4$4=_applyDecoratedDescriptor(_class2$c.prototype,"_layer",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Layers.Enum.DEFAULT}}),_descriptor5$3=_applyDecoratedDescriptor(_class2$c.prototype,"_euler",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3}}),_applyDecoratedDescriptor(_class2$c.prototype,"eulerAngles",[_dec2$5],Object.getOwnPropertyDescriptor(_class2$c.prototype,"eulerAngles"),_class2$c.prototype),_applyDecoratedDescriptor(_class2$c.prototype,"layer",[property],Object.getOwnPropertyDescriptor(_class2$c.prototype,"layer"),_class2$c.prototype),_class$f=_class2$c))||_class$f);function isPropertyModifier(e){return"string"==typeof e}function isElementModifier(e){return"number"==typeof e}function isCustomTargetModifier(e,t){return e instanceof t}cc.Node=Node$1,cc.isPropertyModifier=isPropertyModifier,cc.isElementModifier=isElementModifier,cc.isCustomTargetModifier=isCustomTargetModifier;var HierachyModifier=(_dec$g=ccclass("cc.HierachyModifier"))((_descriptor$b=_applyDecoratedDescriptor((_class2$d=_temp$f=function(){function t(e){_classCallCheck(this,t),_initializerDefineProperty(this,"path",_descriptor$b,this),this.path=e||""}return _createClass(t,[{key:"get",value:function(e){if(!(e instanceof Node$1))throw new Error("Target of hierachy modifier shall be Node.");var t=e.getChildByPath(this.path);if(!t)throw new Error('Node "'.concat(e.name,'" has no path "').concat(this.path,'"'));return t}}]),t}()).prototype,"path",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_class$g=_class2$d))||_class$g;cc.HierachyModifier=HierachyModifier;var ComponentModifier=(_dec2$6=ccclass("cc.ComponentModifier"))((_descriptor2$7=_applyDecoratedDescriptor((_class5=_temp2=function(){function t(e){_classCallCheck(this,t),_initializerDefineProperty(this,"component",_descriptor2$7,this),this.component=e||""}return _createClass(t,[{key:"get",value:function(e){if(!(e instanceof Node$1))throw new Error("Target of hierachy modifier shall be Node.");var t=e.getComponent(this.component);if(!t)throw new Error('Node "'.concat(e.name,'" has no component "').concat(this.component,'"'));return t}}]),t}()).prototype,"component",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_class4=_class5))||_class4;cc.ComponentModifier=ComponentModifier;var BoundTarget=function(){function a(e,t,i){var r;_classCallCheck(this,a),this._isProxy=void 0,this._assignmentOrProxy=void 0;for(var n=0;n<t.length;++n){var s=t[n];if(isElementModifier(s)||isPropertyModifier(s))if(n!==t.length-1||i){if(!(s in e))throw new Error('Target object has no property "'.concat(s,'"'));e=e[s]}else r=s;else e=s.get(e)}if(void 0!==r)this._assignmentOrProxy={object:e,propertyOrElement:r},this._isProxy=!1;else{if(!i)throw new Error("Bad animation curve.");this._assignmentOrProxy=i.forTarget(e),this._isProxy=!0}}return _createClass(a,[{key:"setValue",value:function(e){this._isProxy?this._assignmentOrProxy.set(e):this._assignmentOrProxy.object[this._assignmentOrProxy.propertyOrElement]=e}}]),a}(),SkelAnimDataHub=function(){function i(){_classCallCheck(this,i)}return _createClass(i,null,[{key:"getOrExtract",value:function(e){var t=i.pool.get(e);return t||(t=convertToSkeletalCurves(e),i.pool.set(e,t)),t}}]),i}();function convertToSkeletalCurves(s){s.hash;var a=s.keys,o={};s.curves.forEach(function(e){if(!e.valueAdapter&&isCustomTargetModifier(e.modifiers[0],HierachyModifier)&&isPropertyModifier(e.modifiers[1])){var t=e.modifiers[0].path,i=o[t];i=i||(o[t]={props:{}});var r=e.modifiers[1];i.props[r]=e.data}});for(var e=function(){var r=i[t],n=o[r]&&o[r].props;if(!n)return"continue";Object.defineProperty(n,"worldMatrix",{get:function(){if(!n._worldMatrix){var e=n.position,t=n.rotation,i=n.scale;convertToUniformSample(s,a,e),convertToUniformSample(s,a,t),convertToUniformSample(s,a,i),convertToWorldSpace(o,r,n)}return n._worldMatrix}})},t=0,i=Object.keys(o);t<i.length;t++)e();for(var r=new Array(Math.ceil(s.sample*s.duration/s.speed)+1),n=0;n<r.length;n++)r[n]=n;return s.curves=[{modifiers:[new HierachyModifier(""),new ComponentModifier(getClassName(cc.SkeletalAnimationComponent)),"frameID"],data:{keys:0,values:r,interpolate:!1}}],s.keys=[r.map(function(e,t){return t*s.speed/s.sample})],s.duration=s.keys[0][r.length-1],o}function convertToUniformSample(e,t,i){var r=t[i.keys];i.keys=0;var n=e.keys[0].length,s=[];if(r&&1!==r.length)for(var a=0,o=0;a<n;a++){for(var c=a*e.speed/e.sample;r[o]<=c;)o++;o>r.length-1?c=r[o=r.length-1]:0===o&&(o=1);var l=i.values[o-1].clone();l.lerp(i.values[o],(c-r[o-1])/(r[o]-r[o-1])),s[a]=l}else for(var u=0;u<n;u++)s[u]=i.values[0].clone();i.values=s}function convertToWorldSpace(e,t,i){var r=i.position.values,n=i.rotation.values,s=i.scale.values,a=r.map(function(){return new Mat4}),o=t.lastIndexOf("/"),c=null;if(0<o){var l=e[t.substring(0,o)];if(!l||!l.props)return void console.warn("no data for parent bone?");c=l.props.worldMatrix.values}for(var u=0;u<r.length;u++){var h=r[u],_=n[u],p=s[u],d=a[u];Mat4.fromRTS(d,_,h,p),c&&Mat4.multiply(d,c[u],d)}Object.keys(i).forEach(function(e){return delete i[e]}),i._worldMatrix={keys:0,interpolate:!1,values:a}}function nearestPO2(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}SkelAnimDataHub.pool=new Map;var _jointsFormat2,JointsMediumType,TextureBufferPool=function(){function t(e){_classCallCheck(this,t),this._device=void 0,this._format=exports.GFXFormat.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new GFXBufferTextureCopy,this._region1=new GFXBufferTextureCopy,this._region2=new GFXBufferTextureCopy,this._roundUpFn=null,this._inOrderFree=!1,this._device=e}return _createClass(t,[{key:"initialize",value:function(e){return this._format=e.format,this._formatSize=GFXFormatInfos[this._format].size,this._chunks=new Array(e.maxChunks),this._roundUpFn=e.roundUpFn||null,this._inOrderFree=e.inOrderFree||!1,!0}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e){var t=this._chunks[e];t.texView.destroy(),t.texture.destroy()}this._chunks.splice(0),this._handles.splice(0)}},{key:"alloc",value:function(c){var l=this;if(0===c)return null;for(var e=function(t){var e=l._chunks[t],i=!1,r=e.start;if(r+c<=e.end)i=!0;else if(l._inOrderFree)r>e.end?r+c<=e.size?i=!0:c<=e.end&&(e.start=r=0,i=!0):r===e.end&&(e.start=r=0,e.end=e.size,c<=e.end&&(i=!0));else{r=0;for(var n=l._handles.filter(function(e){return e.chunkIdx===t}).sort(function(e,t){return e.start-t.start}),s=0;s<n.length;s++){var a=n[s];if(r+c<=a.start){i=!0;break}r=a.end}!i&&r+c<=e.size&&(i=!0)}if(i){e.start+=c;var o={chunkIdx:t,start:r,end:r+c,texture:e.texture,texView:e.texView};return l._handles.push(o),{v:o}}},t=0;t<this._chunkCount;++t){var i=e(t);if("object"===_typeof(i))return i.v}if(this._chunkCount>=this._chunks.length)return console.error("TextureBufferPool: Reach max chunk count."),null;var r=Math.sqrt(c/this._formatSize),n=this._roundUpFn&&this._roundUpFn(r,this._formatSize)||Math.max(1024,nearestPO2(r)),s=n*n*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+s);var a=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.SAMPLED,format:this._format,width:n,height:n,mipLevel:1}),o=this._device.createTextureView({texture:a,type:exports.GFXTextureViewType.TV2D,format:this._format}),u={chunkIdx:this._chunkCount,start:0,end:c,texture:a,texView:o};return this._handles.push(u),this._chunks[this._chunkCount++]={texture:a,texView:o,size:s,start:c,end:s},u}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"update",value:function(e,t){var i=[],r=[],n=e.start/this._formatSize,s=t.byteLength/this._formatSize,a=n%e.texture.width,o=Math.floor(n/e.texture.width),c=Math.min(e.texture.width-a,s),l=0;0<a&&(this._region0.texOffset.x=a,this._region0.texOffset.y=o,this._region0.texExtent.width=c,this._region0.texExtent.height=1,i.push(t.slice(l*this._formatSize,(l+c)*this._formatSize)),r.push(this._region0),a=0,o+=1,s-=c,l+=c),0<s&&(this._region1.texOffset.x=a,this._region1.texOffset.y=o,s>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(s/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=s,this._region1.texExtent.width=c,this._region1.texExtent.height=1),i.push(t.slice(l*this._formatSize,(l+c)*this._formatSize)),r.push(this._region1),a=0,o+=this._region1.texExtent.height,s-=c,l+=c),0<s&&(this._region2.texOffset.x=a,this._region2.texOffset.y=o,this._region2.texExtent.width=s,this._region2.texExtent.height=1,i.push(t.slice(l*this._formatSize,(l+s)*this._formatSize)),r.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,r)}}]),t}(),uploadJointData=uploadJointDataDQS;function selectJointsMediumType(e){return e.hasFeature(GFXFeature.TEXTURE_FLOAT)?JointsMediumType.RGBA32F:JointsMediumType.RGBA8}!function(e){e[e.NONE=0]="NONE",e[e.RGBA8=1]="RGBA8",e[e.RGBA32F=2]="RGBA32F"}(JointsMediumType=JointsMediumType||{});var id_m4=Object.freeze(new Mat4),m4_1$1=new Mat4,dq_0=new Quat,dq_1=new Quat,v3_1$4=new Vec3,qt_1$2=new Quat,v3_2$2=new Vec3;function makeStable(e){return e||0}function uploadJointDataDQS(e,t,i,r){Mat4.toRTS(i,qt_1$2,v3_1$4,v3_2$2),r?Quat.copy(dq_0,qt_1$2):Quat.dot(dq_0,qt_1$2)<0&&Quat.multiplyScalar(qt_1$2,qt_1$2,-1),Quat.set(dq_1,v3_1$4.x,v3_1$4.y,v3_1$4.z,0),Quat.multiplyScalar(dq_1,Quat.multiply(dq_1,dq_1,qt_1$2),.5),e[t+0]=makeStable(qt_1$2.x),e[t+1]=makeStable(qt_1$2.y),e[t+2]=makeStable(qt_1$2.z),e[t+3]=makeStable(qt_1$2.w),e[t+4]=makeStable(dq_1.x),e[t+5]=makeStable(dq_1.y),e[t+6]=makeStable(dq_1.z),e[t+7]=makeStable(dq_1.w),e[t+8]=makeStable(v3_2$2.x),e[t+9]=makeStable(v3_2$2.y),e[t+10]=makeStable(v3_2$2.z)}function roundUpTextureSize(e,t){var i=4/Math.sqrt(t);return 12*Math.ceil(Math.max(204*i,e)/12)}var _jointsFormat=(_defineProperty(_jointsFormat2={},JointsMediumType.RGBA8,exports.GFXFormat.RGBA8),_defineProperty(_jointsFormat2,JointsMediumType.RGBA32F,exports.GFXFormat.RGBA32F),_jointsFormat2),JointsTexturePool=function(){function t(e){_classCallCheck(this,t),this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=0,this._device=e,this._pool=new TextureBufferPool(e)}return _createClass(t,[{key:"initialize",value:function(e){var t=0<arguments.length&&void 0!==e?e:8,i=_jointsFormat[selectJointsMediumType(this._device)];this._formatSize=GFXFormatInfos[i].size;var r=16/this._formatSize;this._pool.initialize({format:i,maxChunks:t*r,roundUpFn:roundUpTextureSize})}},{key:"destroy",value:function(){this._pool.destroy()}},{key:"getDefaultJointsTexture",value:function(e){var t=e&&e.joints.length||1,i=this._textureBuffers.get(t)||null;if(i)return i.refCount++,i;var r=this._pool.alloc(12*t*Float32Array.BYTES_PER_ELEMENT);if(!r)return null;i={pixelOffset:r.start/this._formatSize,refCount:1,hash:t,handle:r};for(var n=new Float32Array(12*t),s=0;s<t;s++)uploadJointData(n,12*s,id_m4,0===s);return this._pool.update(r,n.buffer),this._textureBuffers.set(t,i),i}},{key:"getJointsTextureWithAnimation",value:function(e,t){var i=e.hash^t.hash,r=this._textureBuffers.get(i)||null;if(r)return r.refCount++,r;var n=t.keys[0].length,s=12*e.joints.length*n,a=this._pool.alloc(s*Float32Array.BYTES_PER_ELEMENT);if(!a)return null;r={pixelOffset:a.start/this._formatSize,refCount:1,hash:i,handle:a};for(var o=new Float32Array(s),c=SkelAnimDataHub.getOrExtract(t),l=0;l<e.joints.length;l++){var u=c[e.joints[l]];if(u&&u.props)for(var h=e.bindposes[l],_=u.props.worldMatrix.values,p=0;p<n;p++){var d=_[p];Mat4.multiply(m4_1$1,d,h),uploadJointData(o,12*(n*l+p),m4_1$1,0===l)}}return this._pool.update(a,o.buffer),this._textureBuffers.set(i,r),r}},{key:"releaseTexture",value:function(e){0==--e.refCount&&(this._pool.free(e.handle),this._textureBuffers.delete(e.hash))}}]),t}(),effects$1=[{name:"builtin-billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:1060434011,glsl3:{vert:"\nprecision mediump float;\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if 1\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nuniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(0., 0., cc_size_rotation.z), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewInv;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if 1\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(0., 0., cc_size_rotation.z), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean"},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean"},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean"},{name:"CC_USE_MESH",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:767569309,glsl3:{vert:"\nprecision mediump float;\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n    out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n    highp vec4 pos = vec4(a_position, 1);\n    vec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n#endif\n    float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n    vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n    pos.xyz += camUp * vertOffset;\n    pos = cc_matViewProj * pos;\n    uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n    color = a_color;\n#if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n#endif\n    return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\n  precision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\n  vec4 multiply () {\n    vec4 col;\n    vec4 texColor = texture(mainTexture, uv);\n    col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n    col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., col.a);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n    highp vec4 pos = vec4(a_position, 1);\n    vec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n#endif\n    float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n    vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n    pos.xyz += camUp * vertOffset;\n    pos = cc_matViewProj * pos;\n    uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n    color = a_color;\n#if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n#endif\n    return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\n  precision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\n  vec4 multiply () {\n    vec4 col;\n    vec4 texColor = texture2D(mainTexture, uv);\n    col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n    col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., col.a);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean"},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean"},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean"},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean"},{name:"CC_USE_MESH",type:"boolean"},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:522881683,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n    in vec3 a_color1;\n#endif\n#if CC_USE_MESH\n    in vec3 a_texCoord3;\n    in vec3 a_normal;\n    in vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n    vec3 compScale = scale.xyz * a_texCoord1;\n    vec4 pos = vec4(a_position, 1);\n#if CC_USE_STRETCHED_BILLBOARD\n    vec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n        velocity = cc_matWorld * velocity;\n    #endif\n#endif\n#if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_USE_BILLBOARD\n        vec3 rotEuler = a_texCoord2;\n    #elif CC_USE_STRETCHED_BILLBOARD\n        vec3 rotEuler = vec3(0.);\n    #else\n        vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n        , cc_matViewInv\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n#else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n#endif\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    pos = cc_matViewProj * pos;\n    return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewInv;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n    attribute vec3 a_color1;\n#endif\n#if CC_USE_MESH\n    attribute vec3 a_texCoord3;\n    attribute vec3 a_normal;\n    attribute vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n    vec3 compScale = scale.xyz * a_texCoord1;\n    vec4 pos = vec4(a_position, 1);\n#if CC_USE_STRETCHED_BILLBOARD\n    vec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n        velocity = cc_matWorld * velocity;\n    #endif\n#endif\n#if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_USE_BILLBOARD\n        vec3 rotEuler = a_texCoord2;\n    #elif CC_USE_STRETCHED_BILLBOARD\n        vec3 rotEuler = vec3(0.);\n    #else\n        vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n        , cc_matViewInv\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n#else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n#endif\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    pos = cc_matViewProj * pos;\n    return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean"},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean"},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean"},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean"},{name:"CC_USE_MESH",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",priority:244,depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"white",type:28}}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:1088715623,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if USE_LOCAL\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nin vec3 a_position;\nin vec4 a_color;\nout vec4 color;\nin vec2 a_texCoord;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 color;\nattribute vec2 a_texCoord;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}]}]},{name:"builtin-standard",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},albedo:{value:[1,1,1,1],type:16},albedoScale:{value:[1,1,1,0],type:16},pbrParams:{value:[.8,.6,1,1],type:16},pbrScale:{value:[1,1,1,1],type:16},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1,1],type:16},albedoMap:{value:"grey",type:28},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:2481836677,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if CC_USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec4 a_tangent;\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = vec4(a_position, 1.0);\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n}\n#if CC_USE_SKINNING\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n  In.index = attr.index;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\n#if USE_VERTEX_COLOR\n  in vec3 a_color;\n  out vec3 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n#endif\nhighp vec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  highp mat4 matWorld, matWorldIT;\n  CCGetWorldMatrixFull(matWorld, matWorldIT);\n  highp vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform CCForwardLight {\n  highp vec4 cc_sphereLitPos[2];\n  vec4 cc_sphereLitSizeRange[2];\n  vec4 cc_sphereLitColor[2];\n  highp vec4 cc_spotLitPos[2];\n  vec4 cc_spotLitSizeRangeAngle[2];\n  vec4 cc_spotLitDir[2];\n  vec4 cc_spotLitColor[2];\n};\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec4 envmap = textureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n    #if CC_USE_IBL == 2\n      vec3 env = unpackRGBE(envmap);\n    #else\n      vec3 env = SRGBToLinear(envmap.rgb) * cc_ambientSky.w;\n    #endif\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = ACESToneMap(color.rgb);\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\nin vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 v_uv;\n#endif\n#if USE_VERTEX_COLOR\n  in vec3 v_color;\n#endif\nin vec3 v_normal;\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScale.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScale.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\n#if CC_USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec4 a_tangent;\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = vec4(a_position, 1.0);\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n}\n#if CC_USE_SKINNING\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n  In.index = attr.index;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform vec4 tilingOffset;\n#if USE_VERTEX_COLOR\n  attribute vec3 a_color;\n  varying vec3 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n#endif\nhighp vec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  highp mat4 matWorld, matWorldIT;\n  CCGetWorldMatrixFull(matWorld, matWorldIT);\n  highp vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\n#if CC_USE_IBL\n  #ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n  #endif\n#endif\nprecision highp float;\nuniform vec4 cc_cameraPos;\nuniform vec4 cc_exposure;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_mainLitColor;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform highp vec4 cc_sphereLitPos[2];\nuniform vec4 cc_sphereLitSizeRange[2];\nuniform vec4 cc_sphereLitColor[2];\nuniform highp vec4 cc_spotLitPos[2];\nuniform vec4 cc_spotLitSizeRangeAngle[2];\nuniform vec4 cc_spotLitDir[2];\nuniform vec4 cc_spotLitColor[2];\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    #ifdef GL_EXT_shader_texture_lod\n      vec4 envmap = textureCubeLodEXT(cc_environment, R, s.roughness * cc_ambientGround.w);\n    #else\n      vec4 envmap = textureCube(cc_environment, R);\n    #endif\n    #if CC_USE_IBL == 2\n      vec3 env = unpackRGBE(envmap);\n    #else\n      vec3 env = SRGBToLinear(envmap.rgb) * cc_ambientSky.w;\n    #endif\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = ACESToneMap(color.rgb);\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScale;\nuniform vec4 pbrParams;\nuniform vec4 pbrScale;\nuniform vec4 emissive;\nuniform vec4 emissiveScale;\nvarying vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  varying vec2 v_uv;\n#endif\n#if USE_VERTEX_COLOR\n  varying vec3 v_color;\n#endif\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScale.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScale.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture2D(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture2D(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocalBatched",defines:["CC_USE_BATCHING"]},{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]},{name:"CCForwardLight",defines:[]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"number",range:[0,2]},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"ROUGHNESS_CHANNEL",type:"string",options:["r","g","b"]},{name:"METALLIC_CHANNEL",type:"string",options:["g","r","b"]},{name:"OCCLUSION_CHANNEL",type:"string",options:["b","r","g"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScale",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"pbrScale",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScale",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],binding:30},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],binding:31},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],binding:32},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],binding:33},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],binding:34},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],binding:35}]}]},{name:"builtin-terrain",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:936791507,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 uvw;\nout vec2 uv0;\nout vec2 uv1;\nout vec2 uv2;\nout vec2 uv3;\nout vec3 diffuse;\nuniform TexCoords {\n  vec4 UVScale;\n};\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 uvw;\nvarying vec2 uv0;\nvarying vec2 uv1;\nvarying vec2 uv2;\nvarying vec2 uv3;\nvarying vec3 diffuse;\nuniform vec4 UVScale;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,3]}],blocks:[{name:"TexCoords",defines:[],binding:0,members:[{name:"UVScale",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],binding:30},{name:"detailMap0",type:28,count:1,defines:[],binding:31},{name:"detailMap1",type:28,count:1,defines:[],binding:32},{name:"detailMap2",type:28,count:1,defines:[],binding:33},{name:"detailMap3",type:28,count:1,defines:[],binding:34}]}]},{name:"builtin-unlit",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{color:{value:[1,1,1,1],type:16},tilingOffset:{value:[1,1,0,0],type:16},mainTexture:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:84121543,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if CC_USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  in vec4 a_color;\n  out vec4 v_color;\n#endif\n#if USE_TEXTURE\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n  uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nhighp vec4 vert () {\n  vec4 position;\n  CCVertInput(position);\n  highp mat4 matWorld;\n  CCGetWorldMatrix(matWorld);\n  highp vec4 pos = cc_matProj * (cc_matView * matWorld) * position;\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n    #if FLIP_UV\n      v_uv.y = 1.0 - v_uv.y;\n    #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform Constant {\n    vec4 color;\n  };\n#endif\n#if USE_VERTEX_COLOR\n  in vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\n#if CC_USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  attribute vec4 a_color;\n  varying vec4 v_color;\n#endif\n#if USE_TEXTURE\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nhighp vec4 vert () {\n  vec4 position;\n  CCVertInput(position);\n  highp mat4 matWorld;\n  CCGetWorldMatrix(matWorld);\n  highp vec4 pos = cc_matProj * (cc_matView * matWorld) * position;\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n    #if FLIP_UV\n      v_uv.y = 1.0 - v_uv.y;\n    #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\n#if USE_VERTEX_COLOR\n  varying vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocalBatched",defines:["CC_USE_BATCHING"]},{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"number",range:[0,2]},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"FLIP_UV",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_COLOR",type:"boolean"}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:["USE_COLOR"],binding:1,members:[{name:"color",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}]}]},{name:"pipeline/planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:938761954,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if CC_USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nhighp vec4 vert () {\n  highp vec4 position;\n  CCVertInput(position);\n  highp mat4 matWorld;\n  CCGetWorldMatrix(matWorld);\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\n#if CC_USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nuniform highp mat4 cc_matLightPlaneProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nhighp vec4 vert () {\n  highp vec4 position;\n  CCVertInput(position);\n  highp mat4 matWorld;\n  CCGetWorldMatrix(matWorld);\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_shadowColor;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocalBatched",defines:["CC_USE_BATCHING"]},{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[]}]},{name:"pipeline/skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:925089992,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nout vec4 viewDir;\nhighp vec4 vert () {\n  CCDecode(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = matViewRotOnly * viewDir;\n  highp vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = ACESToneMap(color.rgb);\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nin vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb) * cc_ambientSky.w;\n  #endif\n  return CCFragOutput(vec4(c, 1.0));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 cc_screenSize;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nvarying vec4 viewDir;\nhighp vec4 vert () {\n  CCDecode(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = matViewRotOnly * viewDir;\n  highp vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = ACESToneMap(color.rgb);\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nvarying vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb) * cc_ambientSky.w;\n  #endif\n  return CCFragOutput(vec4(c, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[]}]},{name:"util/profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:529846440,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nin vec4 a_color;\nout vec2 v_uv;\nuniform Constants {\n  vec4 offset;\n  vec4 symbols[4];\n};\nuniform PerFrameInfo {\n  vec4 digits[16 * 9 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v[0]; }\n  else if (i < 2.0) { return v[1]; }\n  else if (i < 3.0) { return v[2]; }\n  else { return v[3]; }\n}\nvec4 vert () {\n  vec4 position;\n  CCDecode(position);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  if(a_color.z < 0.0){\n    v_uv = a_color.xy;\n  }\n  else{\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    float row = floor(n / 4.0), col = n - row * 4.0;\n    v_uv = a_color.xy + vec2(getComponent(symbols[int(row)], col), 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 cc_screenSize;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 symbols[4];\nuniform vec4 digits[36];\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v[0]; }\n  else if (i < 2.0) { return v[1]; }\n  else if (i < 3.0) { return v[2]; }\n  else { return v[3]; }\n}\nvec4 vert () {\n  vec4 position;\n  CCDecode(position);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  if(a_color.z < 0.0){\n    v_uv = a_color.xy;\n  }\n  else{\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    float row = floor(n / 4.0), col = n - row * 4.0;\n    v_uv = a_color.xy + vec2(getComponent(symbols[int(row)], col), 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"offset",type:16,count:1},{name:"symbols",type:16,count:4}]},{name:"PerFrameInfo",defines:[],binding:1,members:[{name:"digits",type:16,count:36}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]}],BuiltinResMgr=function(){function e(){_classCallCheck(this,e),this._device=null,this._resources={}}return _createClass(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,i=document.createElement("canvas"),r=i.getContext("2d"),n=new ImageAsset(i),s=i.width=i.height=2;r.fillStyle="#000",r.fillRect(0,0,s,s);var a=new Texture2D;a._uuid="black-texture",a.image=n,t[a._uuid]=a;var o=new TextureCube;o._uuid="black-cube-texture",o.setMipFilter(TextureCube.Filter.LINEAR),o.image={front:new ImageAsset(i),back:new ImageAsset(i),left:new ImageAsset(i),right:new ImageAsset(i),top:new ImageAsset(i),bottom:new ImageAsset(i)},t[o._uuid]=o,r.fillStyle="#777",r.fillRect(0,0,s,s);var c=new Texture2D;c._uuid="grey-texture",c.image=n,t[c._uuid]=c,r.fillStyle="#fff",r.fillRect(0,0,s,s);var l=new Texture2D;l._uuid="white-texture",l.image=n,t[l._uuid]=l;var u=new TextureCube;u._uuid="white-cube-texture",u.setMipFilter(TextureCube.Filter.LINEAR),u.image={front:new ImageAsset(i),back:new ImageAsset(i),left:new ImageAsset(i),right:new ImageAsset(i),top:new ImageAsset(i),bottom:new ImageAsset(i)},t[u._uuid]=u,r.fillStyle="#7f7fff",r.fillRect(0,0,s,s);var h=new Texture2D;h._uuid="normal-texture",h.image=n,t[h._uuid]=h,i.width=i.height=16,r.fillStyle="#ddd",r.fillRect(0,0,16,16),r.fillStyle="#555",r.fillRect(0,0,8,8),r.fillStyle="#555",r.fillRect(8,8,8,8);var _=new Texture2D;_._uuid="default-texture",_.image=n,t[_._uuid]=_;var p=new TextureCube;p.setMipFilter(TextureCube.Filter.LINEAR),p._uuid="default-cube-texture",p.image={front:new ImageAsset(i),back:new ImageAsset(i),left:new ImageAsset(i),right:new ImageAsset(i),top:new ImageAsset(i),bottom:new ImageAsset(i)},t[p._uuid]=p;var d=new SpriteFrame,f=n._texture;d.texture=f,d._uuid="default-spriteframe",t[d._uuid]=d,effects$1.forEach(function(e){Object.assign(new cc.EffectAsset,e).onLoaded()});var m=new cc.Material;m._uuid="standard-material",m.initialize({effectName:"builtin-standard"}),t[m._uuid]=m;var y=new cc.Material;y._uuid="missing-material",y.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),y.setProperty("color",cc.color("#ff00ff")),t[y._uuid]=y;var v=new cc.Material;v._uuid="missing-skinning-material";var g=selectJointsMediumType(e);v.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0,CC_USE_SKINNING:g}}),v.setProperty("color",cc.color("#ff00ff")),t[v._uuid]=v;var b=new cc.Material;b._uuid="missing-effect-material",b.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),b.setProperty("color",cc.color("#ffff00")),t[b._uuid]=b;var x=new cc.Material;x._uuid="ui-base-material",x.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),t[x._uuid]=x;var T=new cc.Material;T._uuid="ui-sprite-material",T.initialize({defines:{USE_TEXTURE:!0,IS_GRAY:!1},effectName:"builtin-sprite"}),t[T._uuid]=T;var C=new cc.Material;C._uuid="ui-sprite-gray-material",C.initialize({defines:{USE_TEXTURE:!0,IS_GRAY:!0},effectName:"builtin-sprite"}),t[C._uuid]=C;var S=new cc.Material;S._uuid="default-particle-material",S.initialize({effectName:"builtin-particle"}),t[S._uuid]=S;var E=new cc.Material;E._uuid="default-trail-material",E.initialize({effectName:"builtin-particle-trail"}),t[E._uuid]=E;var w=new cc.Material;w._uuid="default-billboard-material",w.initialize({effectName:"builtin-billboard"}),t[w._uuid]=w}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),builtinResMgr=cc.builtinResMgr=new BuiltinResMgr,GFXTextureView=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.TEXTURE_VIEW)))._device=void 0,t._texture=null,t._type=exports.GFXTextureViewType.TV2D,t._format=exports.GFXFormat.UNKNOWN,t._baseLevel=0,t._levelCount=1,t._baseLayer=0,t._layerCount=1,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"texture",get:function(){return this._texture}},{key:"type",get:function(){return this._type}},{key:"format",get:function(){return this._format}},{key:"baseLevel",get:function(){return this._baseLevel}},{key:"levelCount",get:function(){return this._levelCount}},{key:"baseLayer",get:function(){return this._baseLayer}},{key:"layerCount",get:function(){return this._layerCount}}]),i}(),GFXRasterizerState=function(){function e(){_classCallCheck(this,e),this.isDiscard=!1,this.polygonMode=exports.GFXPolygonMode.FILL,this.shadeModel=exports.GFXShadeModel.GOURAND,this.cullMode=exports.GFXCullMode.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}return _createClass(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}(),GFXDepthStencilState=function(){function e(){_classCallCheck(this,e),this.depthTest=!0,this.depthWrite=!0,this.depthFunc=exports.GFXComparisonFunc.LESS,this.stencilTestFront=!1,this.stencilFuncFront=exports.GFXComparisonFunc.ALWAYS,this.stencilReadMaskFront=4294967295,this.stencilWriteMaskFront=4294967295,this.stencilFailOpFront=exports.GFXStencilOp.KEEP,this.stencilZFailOpFront=exports.GFXStencilOp.KEEP,this.stencilPassOpFront=exports.GFXStencilOp.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=exports.GFXComparisonFunc.ALWAYS,this.stencilReadMaskBack=4294967295,this.stencilWriteMaskBack=4294967295,this.stencilFailOpBack=exports.GFXStencilOp.KEEP,this.stencilZFailOpBack=exports.GFXStencilOp.KEEP,this.stencilPassOpBack=exports.GFXStencilOp.KEEP,this.stencilRefBack=1}return _createClass(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}(),GFXBlendTarget=function(){function e(){_classCallCheck(this,e),this.blend=!1,this.blendSrc=exports.GFXBlendFactor.ONE,this.blendDst=exports.GFXBlendFactor.ZERO,this.blendEq=exports.GFXBlendOp.ADD,this.blendSrcAlpha=exports.GFXBlendFactor.ONE,this.blendDstAlpha=exports.GFXBlendFactor.ZERO,this.blendAlphaEq=exports.GFXBlendOp.ADD,this.blendColorMask=exports.GFXColorMask.ALL}return _createClass(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}(),GFXBlendState=function e(){_classCallCheck(this,e),this.isA2C=!1,this.isIndepend=!1,this.blendColor=[0,0,0,0],this.targets=[new GFXBlendTarget]},GFXInputState=function e(){_classCallCheck(this,e),this.attributes=[]},GFXPipelineState=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.PIPELINE_STATE)))._device=void 0,t._shader=null,t._primitive=exports.GFXPrimitiveMode.TRIANGLE_LIST,t._is=null,t._rs=null,t._dss=null,t._bs=null,t._dynamicStates=[],t._layout=null,t._renderPass=null,t._hash=0,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"shader",get:function(){return this._shader}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"pipelineLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}},{key:"hash",get:function(){return this._hash}}]),i}(),GFX_DRAW_INFO_SIZE=56,GFXBuffer=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.BUFFER)))._device=void 0,t._usage=exports.GFXBufferUsageBit.NONE,t._memUsage=exports.GFXMemoryUsageBit.NONE,t._size=0,t._stride=1,t._count=0,t._flags=exports.GFXBufferFlagBit.NONE,t._bufferView=null,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}},{key:"bufferView",get:function(){return this._bufferView}}]),i}(),GFXCommandBuffer=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.COMMAND_BUFFER)))._device=void 0,t._allocator=null,t._type=exports.GFXCommandBufferType.PRIMARY,t._numDrawCalls=0,t._numTris=0,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"type",get:function(){return this._type}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}}]),i}(),GFXFramebuffer=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.FRAMEBUFFER)))._device=void 0,t._renderPass=null,t._colorViews=[],t._depthStencilView=null,t._isOffscreen=!0,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorViews",get:function(){return this._colorViews}},{key:"depthStencilView",get:function(){return this._depthStencilView}},{key:"isOffscreen",get:function(){return this._isOffscreen}}]),i}();function find(e,t){if(t)0;else{var i=cc.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}cc.find=find;var _dec$h,_class$h,_class2$e,_descriptor$c,_descriptor2$8,_temp$g,BufferBlob=function(){function e(){_classCallCheck(this,e),this._arrayBufferOrPaddings=[],this._length=0}return _createClass(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!=t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var t=new Uint8Array(this._length),i=0;return this._arrayBufferOrPaddings.forEach(function(e){"number"==typeof e?i+=e:(t.set(new Uint8Array(e),i),i+=e.byteLength)}),t.buffer}}]),e}();function postLoadMesh(i,r){i.loaded?r&&r():i.nativeUrl?cc.loader.load({url:i.nativeUrl},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),r&&r(e)}):r&&r()}function getIndexStrideCtor(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}var RenderingMesh=function(){function t(e){_classCallCheck(this,t),this._subMeshes=e}return _createClass(t,[{key:"getSubmesh",value:function(e){return this._subMeshes[e]}},{key:"destroySubMeshes",value:function(){for(var e=0;e<this._subMeshes.length;++e){for(var t=this._subMeshes[e],i=0;i<t.vertexBuffers.length;++i)t.vertexBuffers[i].destroy();t.indexBuffer&&t.indexBuffer.destroy()}this._subMeshes.splice(0)}},{key:"destroy",value:function(){this.destroySubMeshes(),this._subMeshes.length=0}},{key:"subMeshes",get:function(){return this._subMeshes}},{key:"subMeshCount",get:function(){return this._subMeshes.length}}]),t}(),Mesh=(_dec$h=ccclass("cc.Mesh"))((_descriptor$c=_applyDecoratedDescriptor((_class2$e=_temp$g=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"_struct",_descriptor$c,_assertThisInitialized(e)),_initializerDefineProperty(e,"_dataLength",_descriptor2$8,_assertThisInitialized(e)),e._data=null,e._initialized=!1,e._hasFlatBuffers=!1,e._renderingMesh=null,e.loaded=!1,e}return _inherits(t,Asset),_createClass(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),cc.loader._cache[this.nativeUrl]&&(cc.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingMesh;return e?e.subMeshCount:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hasFlatBuffers",get:function(){return this._hasFlatBuffers}}]),_createClass(t,[{key:"initialize",value:function(){var u=this;if(!this._initialized){this._initialized=!0,this._data||(this._data=new Uint8Array(this._dataLength),postLoadMesh(this));var h=this._data.buffer,_=cc.director.root.device,p=this._createVertexBuffers(_,h),d=[],e=function(){if(m){if(y>=f.length)return"break";v=f[y++]}else{if((y=f.next()).done)return"break";v=y.value}var e=v;if(0===e.vertexBundelIndices.length)return"continue";var t=null,i=null;if(e.indexView){var r=e.indexView;t=_.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:r.length,stride:r.stride}),i=new(getIndexStrideCtor(r.stride))(h,r.offset,r.count),u.loaded?t.update(i):u.once("load",function(){t.update(i)})}var n=e.vertexBundelIndices.map(function(e){return p[e]}),s=[];if(0<e.vertexBundelIndices.length){var a=e.vertexBundelIndices[0];s=u._struct.vertexBundles[a].attributes}var o={primitiveMode:e.primitiveMode,vertexBuffers:n,flatBuffers:[],indexBuffer:t,attributes:s};if(e.geometricInfo){var c=e.geometricInfo,l=new Float32Array(h,c.view.offset,c.view.length/4);o.geometricInfo={indices:i,positions:l}}d.push(o)};var f=this._struct.primitives,m=Array.isArray(f),y=0;e:for(f=m?f:f[Symbol.iterator]();;){var v;switch(e()){case"break":break e;case"continue":continue}}this._renderingMesh=new RenderingMesh(d)}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),_get(_getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){this._renderingMesh&&(this._renderingMesh.destroy(),this._renderingMesh=null,this._data=null,this._initialized=!1)}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this.loaded=!0,this.emit("load")}},{key:"getSubMesh",value:function(e){return this.renderingMesh.getSubmesh(e)}},{key:"merge",value:function(e,t){if(void 0!==t&&t&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;if(!this._initialized&&e._data){var i=JSON.parse(JSON.stringify(e._struct)),r=e._data.slice();return this.reset({struct:i,data:r}),this.initialize(),!0}for(var n,s,a,o,c,l=new BufferBlob,u=0,h=0,_=0,p=0,d=0,f=0,m=0,y=0,v=!1,g=new Array(this._struct.vertexBundles.length),b=0;b<this._struct.vertexBundles.length;++b){var x=this._struct.vertexBundles[b],T=e._struct.vertexBundles[b];_=x.view.offset,p=T.view.offset,h=x.view.stride,u=x.view.count+T.view.count,n=new ArrayBuffer(u*h),s=new Uint8Array(n),_+=(a=this._data.subarray(_,_+x.view.length)).length,p+=(o=e._data.subarray(p,p+T.view.length)).length,s.set(a),d=0;var C=x.attributes,S=Array.isArray(C),E=0;for(C=S?C:C[Symbol.iterator]();;){var w;if(S){if(E>=C.length)break;w=C[E++]}else{if((E=C.next()).done)break;w=E.value}var A=w;m=0,v=!1;var $=T.attributes,O=Array.isArray($),D=0;for($=O?$:$[Symbol.iterator]();;){var k;if(O){if(D>=$.length)break;k=$[D++]}else{if((D=$.next()).done)break;k=D.value}var R=k;if(A.name===R.name&&A.format===R.format){v=!0;break}m+=GFXFormatInfos[R.format].size}if(v){y=GFXFormatInfos[A.format].size,f=x.view.length+d;for(var I=0;I<T.view.count;++I)c=o.subarray(m,m+y),s.set(c,f),f+=x.view.stride,m+=T.view.stride}d+=GFXFormatInfos[A.format].size}g[b]={attributes:x.attributes,view:{offset:l.getLength(),length:n.byteLength,count:u,stride:h}},l.addBuffer(n)}for(var F,P,M,L=0,z=2,B=0,N=new Array(this._struct.primitives.length),G=0;G<this._struct.primitives.length;++G){var V=this._struct.primitives[G],U=e._struct.primitives[G];N[G]={primitiveMode:V.primitiveMode,vertexBundelIndices:V.vertexBundelIndices};var X=V.vertexBundelIndices,W=Array.isArray(X),H=0;for(X=W?X:X[Symbol.iterator]();;){var q;if(W){if(H>=X.length)break;q=X[H++]}else{if((H=X.next()).done)break;q=H.value}var j=q;B=Math.max(B,this._struct.vertexBundles[j].view.count)}if(V.indexView&&U.indexView){L=V.indexView.count,L+=U.indexView.count,_=V.indexView.offset,p=U.indexView.offset,z=L<256?1:L<65536?2:4;var Y=new ArrayBuffer(L*z);if(F=2===z?new Uint16Array(Y):1===z?new Uint8Array(Y):new Uint32Array(Y),P=2===V.indexView.stride?new Uint16Array(this._data.buffer,_,V.indexView.count):1===V.indexView.stride?new Uint8Array(this._data.buffer,_,V.indexView.count):new Uint32Array(this._data.buffer,_,V.indexView.count),z===V.indexView.stride)F.set(P);else for(var Q=0;Q<V.indexView.count;++Q)F[Q]=P[Q];_+=V.indexView.length,M=2===U.indexView.stride?new Uint16Array(e._data.buffer,p,U.indexView.count):1===U.indexView.stride?new Uint8Array(e._data.buffer,p,U.indexView.count):new Uint32Array(e._data.buffer,p,U.indexView.count);for(var K=0;K<U.indexView.count;++K)F[V.indexView.count+K]=B+M[K];p+=U.indexView.length,N[G].indexView={offset:l.getLength(),length:Y.byteLength,count:L,stride:z},l.setNextAlignment(z),l.addBuffer(Y)}if(V.geometricInfo&&U.geometricInfo){var Z=V.geometricInfo.view.length+U.geometricInfo.view.length,J=new ArrayBuffer(Z),ee=new Uint8Array(J),te=new Uint8Array(this._data.buffer,V.geometricInfo.view.offset,V.geometricInfo.view.length),ie=new Uint8Array(e._data.buffer,U.geometricInfo.view.offset,U.geometricInfo.view.length);ee.set(te),ee.set(ie,te.length),l.setNextAlignment(4),N[G].geometricInfo={doubleSided:V.geometricInfo.doubleSided,view:{offset:l.getLength(),length:ee.length,count:V.geometricInfo.view.count+U.geometricInfo.view.count,stride:V.geometricInfo.view.stride}},l.addBuffer(J)}}var re={vertexBundles:g,primitives:N,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return re.minPosition&&e._struct.minPosition&&Vec3.min(re.minPosition,re.minPosition,e._struct.minPosition),re.maxPosition&&e._struct.maxPosition&&Vec3.max(re.maxPosition,re.maxPosition,e._struct.maxPosition),this.reset({struct:re,data:new Uint8Array(l.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(!this._data&&e._data)return!0;if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],r=e._struct.vertexBundles[t];if(i.attributes.length!==r.attributes.length)return!1;for(var n=0;n<i.attributes.length;++n)if(i.attributes[n].format!==r.attributes[n].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var s=0;s<this._struct.primitives.length;++s){var a=this._struct.primitives[s],o=e._struct.primitives[s];if(a.vertexBundelIndices.length!==o.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==o.vertexBundelIndices[c])return!1;if(a.primitiveMode!==o.primitiveMode)return!1;if(a.indexView){if(void 0===o.indexView)return!1}else if(o.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var p=this,d=null;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,r=new DataView(p._data.buffer,e.view.offset+getOffset(e.attributes,t)),n=GFXFormatInfos[i],s=getStorageConstructor$1(i),a=getReader(r,i);if(s&&a){for(var o=e.view.count,c=n.count,l=new s(o*c),u=e.view.stride,h=0;h<o;++h)for(var _=0;_<c;++_)l[c*h+_]=a(u*h+l.BYTES_PER_ELEMENT*_);d=l}}),d}},{key:"copyAttribute",value:function(e,t,m,y,v){var g=this,b=!1;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,r=new DataView(g._data.buffer,e.view.offset+getOffset(e.attributes,t)),n=new DataView(m,v),s=GFXFormatInfos[i],a=getReader(r,i),o=getWriter(n,i);if(a&&o){for(var c=e.view.count,l=s.count,u=e.view.stride,h=getComponentByteLength(i),_=y,p=h,d=0;d<c;++d)for(var f=0;f<l;++f){o(_*d+p*f,a(u*d+h*f))}b=!0}}),b}},{key:"readIndices",value:function(e){if(!this._data||e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;for(var i=t.indexView.count,r=i<256?exports.GFXFormat.R8UI:i<65536?exports.GFXFormat.R16UI:exports.GFXFormat.R32UI,n=new(getStorageConstructor$1(r))(i),s=getReader(new DataView(this._data.buffer),r),a=0;a<i;++a)n[a]=s(t.indexView.offset+n.BYTES_PER_ELEMENT*a);return n}},{key:"copyIndices",value:function(e,t){if(!this._data||e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var r=i.indexView.count,n=1===i.indexView.stride?exports.GFXFormat.R8UI:2===i.indexView.stride?exports.GFXFormat.R16UI:exports.GFXFormat.R32UI,s=getReader(new DataView(this._data.buffer),n),a=0;a<r;++a)t[a]=s(i.indexView.offset+GFXFormatInfos[n].size*a);return!0}},{key:"createFlatBuffers",value:function(){if(!this._renderingMesh||this._hasFlatBuffers)return!1;cc.director.root.device;for(var e,t=0,i=0;i<this._struct.primitives.length;++i){var r=this._struct.primitives[i],n=this._renderingMesh.subMeshes[i];r.indexView&&(t=r.indexView.count);var s=r.vertexBundelIndices,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if(a){if(o>=s.length)break;c=s[o++]}else{if((o=s.next()).done)break;c=o.value}var l=c,u=this._struct.vertexBundles[l],h=r.indexView?r.indexView.count:u.view.count,_=u.view.stride,p=_*h,d=new Uint8Array(this._data.buffer,u.view.offset,u.view.length);if(r.indexView){var f=new Uint8Array(p);e=2===(t<65536?2:4)?new Uint16Array(this._data.buffer,r.indexView.offset,r.indexView.count):new Uint32Array(this._data.buffer,r.indexView.offset,r.indexView.count);for(var m=0;m<t;++m)for(var y=m*_,v=e[m]*_,g=0;g<_;++g)f[y+g]=d[v+g];n.flatBuffers.push({stride:_,count:h,buffer:f})}else n.flatBuffers.push({stride:_,count:h,buffer:d})}}return this._hasFlatBuffers=!0}},{key:"destroyFlatBuffers",value:function(){if(this._hasFlatBuffers){if(this._renderingMesh)for(var e=this._renderingMesh.subMeshes,t=0;t<e.length;++t)e[t].flatBuffers.splice(0);this._hasFlatBuffers=!1}}},{key:"_accessAttribute",value:function(e,t,i){if(this._data&&!(e>=this._struct.primitives.length)){var r=this._struct.primitives[e].vertexBundelIndices,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=a,c=this._struct.vertexBundles[o],l=c.attributes.findIndex(function(e){return e.name===t});if(!(l<0)){i(c,l);break}}}}},{key:"_createVertexBuffers",value:function(r,n){var s=this;return this._struct.vertexBundles.map(function(e){var t=r.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:e.view.length,stride:e.view.stride}),i=new Uint8Array(n,e.view.offset,e.view.length);return s.loaded?t.update(i):s.once("load",function(){t.update(i)}),t})}},{key:"renderingMesh",get:function(){return this.initialize(),this._renderingMesh}}]),t}()).prototype,"_struct",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),_descriptor2$8=_applyDecoratedDescriptor(_class2$e.prototype,"_dataLength",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_class$h=_class2$e))||_class$h;function getOffset(e,t){for(var i=0,r=0;r<t;++r){var n=e[r];i+=GFXFormatInfos[n.format].size}return i}function getStorageConstructor$1(e){var t=GFXFormatInfos[e],i=t.size/t.count;switch(t.type){case exports.GFXFormatType.UNORM:case exports.GFXFormatType.UINT:switch(i){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case exports.GFXFormatType.SNORM:case exports.GFXFormatType.INT:switch(i){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case exports.GFXFormatType.FLOAT:return Float32Array}return null}cc.Mesh=Mesh;var isLittleEndian=cc.sys.isLittleEndian;function getComponentByteLength(e){var t=GFXFormatInfos[e];return t.size/t.count}function getReader(t,e){var i=GFXFormatInfos[e],r=i.size/i.count;switch(i.type){case exports.GFXFormatType.UNORM:switch(r){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,isLittleEndian)};case 4:return function(e){return t.getUint32(e,isLittleEndian)}}break;case exports.GFXFormatType.SNORM:switch(r){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,isLittleEndian)};case 4:return function(e){return t.getInt32(e,isLittleEndian)}}break;case exports.GFXFormatType.INT:switch(r){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,isLittleEndian)};case 4:return function(e){return t.getInt32(e,isLittleEndian)}}break;case exports.GFXFormatType.UINT:switch(r){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,isLittleEndian)};case 4:return function(e){return t.getUint32(e,isLittleEndian)}}break;case exports.GFXFormatType.FLOAT:return function(e){return t.getFloat32(e,isLittleEndian)}}return null}function getWriter(i,e){var t=GFXFormatInfos[e],r=t.size/t.count;switch(t.type){case exports.GFXFormatType.UNORM:switch(r){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,isLittleEndian)};case 4:return function(e,t){return i.setUint32(e,t,isLittleEndian)}}break;case exports.GFXFormatType.SNORM:switch(r){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,isLittleEndian)};case 4:return function(e,t){return i.setInt32(e,t,isLittleEndian)}}break;case exports.GFXFormatType.INT:switch(r){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,isLittleEndian)};case 4:return function(e,t){return i.setInt32(e,t,isLittleEndian)}}break;case exports.GFXFormatType.UINT:switch(r){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,isLittleEndian)};case 4:return function(e,t){return i.setUint32(e,t,isLittleEndian)}}break;case exports.GFXFormatType.FLOAT:return function(e,t){return i.setFloat32(e,t,isLittleEndian)}}return null}var Customization=function(){function t(e){_classCallCheck(this,t),this._onAttach=void 0,this._onDetach=void 0,this._models={},this._onAttach=e.onAttach,this._onDetach=e.onDetach}return _createClass(t,[{key:"attach",value:function(e){var t=this._models,i=e.id;t[i]?t[i]++:(this._onAttach&&this._onAttach(e),t[i]=1)}},{key:"detach",value:function(e){var t=this._models,i=e.id;!t[i]||0<--t[i]||this._onDetach&&this._onDetach(e)}}]),t}(),CustomizationManager=function(){function e(){_classCallCheck(this,e),this._customs={}}return _createClass(e,[{key:"register",value:function(e,t){this._customs[e]=new Customization(t)}},{key:"attach",value:function(e,t){var i=this._customs[e];i?i.attach(t):console.warn("no customization named '".concat(e,"'"))}},{key:"detach",value:function(e,t){var i=this._customs[e];i?i.detach(t):console.warn("no customization named '".concat(e,"'"))}}]),e}(),customizationManager=new CustomizationManager;cc.customizationManager=customizationManager;var SubModel=function(){function e(){_classCallCheck(this,e),this._subMeshObject=void 0,this._inputAssembler=void 0,this._material=void 0,this._cmdBuffers=void 0,this._psos=void 0,this._priority=void 0,this._subMeshObject=null,this._material=null,this._cmdBuffers=new Array,this._psos=null,this._inputAssembler=null,this._priority=RenderPriority.DEFAULT}return _createClass(e,[{key:"initialize",value:function(e,t,i){this._psos=i,this.subMeshData=e,this.material=t}},{key:"destroy",value:function(){this._inputAssembler&&this._inputAssembler.destroy();for(var e=0;e<this.passes.length;e++)this.passes[e].destroyPipelineState(this._psos[e]);var t=this._cmdBuffers,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.destroy()}this._cmdBuffers.splice(0),this._material=null}},{key:"updateCommandBuffer",value:function(){if(this._material){for(var e=0;e<this._material.passes.length;e++)this._subMeshObject&&this._material.passes[e].primitive!==this._subMeshObject.primitiveMode&&console.warn("mesh primitive type doesn't match with pass settings"),this.recordCommandBuffer(e);for(var t=this._cmdBuffers.length-1;t>=this._material.passes.length;t--){var i=this._cmdBuffers.pop();i&&i.destroy()}}}},{key:"recordCommandBuffer",value:function(e){var t=cc.director.root.device,i=this._psos[e];if(null==this._cmdBuffers[e]){var r={allocator:t.commandAllocator,type:exports.GFXCommandBufferType.SECONDARY};this._cmdBuffers[e]=t.createCommandBuffer(r)}else this._cmdBuffers[e].status===exports.GFXStatus.UNREADY&&this._cmdBuffers[e].initialize({allocator:t.commandAllocator,type:exports.GFXCommandBufferType.SECONDARY});var n=this._inputAssembler,s=this._cmdBuffers[e];s.begin(),s.bindPipelineState(i),s.bindBindingLayout(i.pipelineLayout.layouts[0]),s.bindInputAssembler(n),s.draw(n),s.end()}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"subMeshData",set:function(e){this._inputAssembler&&this._inputAssembler.destroy(),this._subMeshObject=e;var t={};t.attributes=this._subMeshObject.attributes,t.vertexBuffers=this._subMeshObject.vertexBuffers,this._subMeshObject.indexBuffer&&(t.indexBuffer=this._subMeshObject.indexBuffer),this._subMeshObject.indirectBuffer&&(t.indirectBuffer=this._subMeshObject.indirectBuffer),this._inputAssembler?this._inputAssembler.initialize(t):this._inputAssembler=cc.director.root.device.createInputAssembler(t)},get:function(){return this._subMeshObject}},{key:"psos",get:function(){return this._psos},set:function(e){this._psos=e}},{key:"material",set:function(e){null!=(this._material=e)&&this.updateCommandBuffer()},get:function(){return this._material}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"passes",get:function(){return this._material.passes}},{key:"commandBuffers",get:function(){return this._cmdBuffers}}]),e}(),m4_1$2=new Mat4,_subMeshPool=new Pool$1(function(){return new SubModel},32);function getUniformBlockSize(e){var t=0,i=e.members,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;t+=GFXGetTypeSize(a.type)*a.count}return t}var Model=function(){function i(e,t){_classCallCheck(this,i),this._type="default",this._device=void 0,this._scene=void 0,this._node=void 0,this._transform=void 0,this._id=void 0,this._enabled=!1,this._visFlags=Layers.Enum.NONE,this._cameraID=-1,this._userKey=-1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._matPSORecord=void 0,this._matRefCount=void 0,this._uboLocal=void 0,this._localUBO=null,this._localBindings=new Map,this._inited=!1,this._uboUpdated=!1,this._castShadow=!1,this._isDynamicBatching=!1,this._transformUpdated=!0,this._device=cc.director.root.device,this._scene=e,this._id=this._scene.generateModelId(),this._transform=this._node=t,this._matPSORecord=new Map,this._matRefCount=new Map,this._uboLocal=new UBOLocal}return _createClass(i,[{key:"scene",set:function(e){this._scene=e,this._id=this._scene.generateModelId()},get:function(){return this._scene}},{key:"id",get:function(){return this._id}},{key:"subModels",get:function(){return this._subModels}},{key:"subModelNum",get:function(){return this._subModels.length}},{key:"inited",get:function(){return this._inited}},{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"userKey",set:function(e){this._userKey=e}},{key:"uboLocal",get:function(){return this._uboLocal}},{key:"localUBO",get:function(){return this._localUBO}},{key:"localBindings",get:function(){return this._localBindings}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"isDynamicBatching",get:function(){return this._isDynamicBatching},set:function(e){this._isDynamicBatching=e}},{key:"UBOUpdated",get:function(){return this._uboUpdated}}]),_createClass(i,[{key:"destroy",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;n.destroy(),_subMeshPool.free(n)}for(var s=this._localBindings.values(),a=s.next();!a.done;){var o=a.value;o.buffer&&(o.buffer.destroy(),o.buffer=void 0),a=s.next()}this._localBindings.has(UBOForwardLight.BLOCK.name)&&this._localBindings.delete(UBOForwardLight.BLOCK.name),this._worldBounds=null,this._modelBounds=null,this._subModels.splice(0),this._matPSORecord.clear(),this._matRefCount.clear(),this._inited=!1}},{key:"getSubModel",value:function(e){return this._subModels[e]}},{key:"updateTransform",value:function(){var e=this._transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdated=!0,this._modelBounds&&this._worldBounds&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds))}},{key:"_resetUBOUpdateFlag",value:function(){this._uboUpdated=!1}},{key:"updateUBOs",value:function(){if(this._uboUpdated)return!1;if(this._uboUpdated=!0,this._transformUpdated&&!this._isDynamicBatching){var e=this._transform._mat;Mat4.toArray(this._uboLocal.view,e,UBOLocal.MAT_WORLD_OFFSET),Mat4.inverseTranspose(m4_1$2,e),Mat4.toArray(this._uboLocal.view,m4_1$2,UBOLocal.MAT_WORLD_IT_OFFSET);var t=this._localBindings.get(UBOLocal.BLOCK.name);t&&t.buffer&&t.buffer.update(this._uboLocal.view),this._transformUpdated=!1}return this._matPSORecord.forEach(this._updatePass,this),!0}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=aabb.fromPoints(aabb.create(),e,t),this._worldBounds=aabb.clone(this._modelBounds),this._transform.updateWorldTransform(),this._modelBounds.transform(this._transform._mat,this._transform._pos,this._transform._rot,this._transform._scale,this._worldBounds))}},{key:"initSubModel",value:function(e,t,i){if(this.initLocalBindings(i),null==this._subModels[e])this._subModels[e]=_subMeshPool.alloc();else{var r=this._subModels[e].material;this._subModels[e].destroy(),this.releasePSO(r)}this.allocatePSO(i),this._subModels[e].initialize(t,i,this._matPSORecord.get(i)),this._inited=!0}},{key:"setSubModelMesh",value:function(e,t){null==this._subModels[e]&&(this._subModels[e]=_subMeshPool.alloc()),this._subModels[e].subMeshData=t}},{key:"setSubModelMaterial",value:function(e,t){null!=this._subModels[e]&&(this.initLocalBindings(t),this._subModels[e].material===t?t&&(this.destroyPipelineState(t,this._matPSORecord.get(t)),this._matPSORecord.set(t,this.createPipelineState(t))):(this._subModels[e].material&&this.releasePSO(this._subModels[e].material),t&&this.allocatePSO(t)),this._subModels[e].psos=t&&this._matPSORecord.get(t)||null,this._subModels[e].material=t)}},{key:"onPipelineChange",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}for(var n=r,s=n.material,a=this._matPSORecord.get(s),o=0;o<s.passes.length;o++){var c=s.passes[o];c.tryCompile(),c.destroyPipelineState(a[o]),a[o]=this._doCreatePSO(c),a[o].pipelineLayout.layouts[0].update()}n.updateCommandBuffer()}}},{key:"createPipelineState",value:function(e){for(var t=new Array(e.passes.length),i=0;i<t.length;i++){var r=e.passes[i],n=r.customizations,s=Array.isArray(n),a=0;for(n=s?n:n[Symbol.iterator]();;){var o;if(s){if(a>=n.length)break;o=n[a++]}else{if((a=n.next()).done)break;o=a.value}var c=o;customizationManager.attach(c,this)}t[i]=this._doCreatePSO(r)}return t}},{key:"destroyPipelineState",value:function(e,t){for(var i=0;i<e.passes.length;i++){var r=e.passes[i];r.destroyPipelineState(t[i]);var n=r.customizations,s=Array.isArray(n),a=0;for(n=s?n:n[Symbol.iterator]();;){var o;if(s){if(a>=n.length)break;o=n[a++]}else{if((a=n.next()).done)break;o=a.value}var c=o;customizationManager.detach(c,this)}}}},{key:"_doCreatePSO",value:function(e,t,i){(t=t||{}).CC_USE_BATCHING=this._isDynamicBatching;var r=e.createPipelineState(t,i);return r.pipelineLayout.layouts[0].bindBuffer(UBOLocal.BLOCK.binding,this._localBindings.get(UBOLocal.BLOCK.name).buffer),this._localBindings.has(UBOForwardLight.BLOCK.name)&&r.pipelineLayout.layouts[0].bindBuffer(UBOForwardLight.BLOCK.binding,this._localBindings.get(UBOForwardLight.BLOCK.name).buffer),r}},{key:"onSetLocalBindings",value:function(e){this._localBindings.has(UBOLocal.BLOCK.name)||this._localBindings.set(UBOLocal.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:UBOLocal.BLOCK});var t=!1,i=e.passes,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}if(s.bindings.find(function(e){return e.name===UBOForwardLight.BLOCK.name})){t=!0;break}}t&&"ForwardPipeline"===cc.director.root.pipeline.name&&(this._localBindings.has(UBOForwardLight.BLOCK.name)||this._localBindings.set(UBOForwardLight.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:UBOForwardLight.BLOCK}))}},{key:"initLocalBindings",value:function(e){if(e){this.onSetLocalBindings(e);for(var t=this._localBindings.values(),i=t.next();!i.done;){var r=i.value;r.buffer||(r.buffer=this._device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:getUniformBlockSize(r.blockInfo)})),i=t.next()}}}},{key:"_updatePass",value:function(e,t){for(var i=0;i<t.passes.length;i++)t.passes[i].update();for(var r=0;r<e.length;r++)e[r].pipelineLayout.layouts[0].update()}},{key:"allocatePSO",value:function(e){null==this._matRefCount.get(e)?(this._matRefCount.set(e,1),this._matPSORecord.set(e,this.createPipelineState(e))):this._matRefCount.set(e,this._matRefCount.get(e)+1)}},{key:"releasePSO",value:function(e){this._matRefCount.set(e,this._matRefCount.get(e)-1),0===this._matRefCount.get(e)&&(this.destroyPipelineState(e,this._matPSORecord.get(e)),this._matPSORecord.delete(e),this._matRefCount.delete(e))}}]),i}(),JointsAnimationInfo=function(){function s(){_classCallCheck(this,s)}return _createClass(s,null,[{key:"create",value:function(e){var t=s.pool.get(e);if(t)return t;var i=cc.director.root.device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:UBOSkinningAnimation.SIZE,stride:UBOSkinningAnimation.SIZE}),r=new Float32Array([1,0,0,0]);i.update(r);var n={buffer:i,data:r};return s.pool.set(e,n),n}},{key:"destroy",value:function(e){var t=s.pool.get(e);t&&(t.buffer.destroy(),s.pool.delete(e))}},{key:"switchClip",value:function(e,t){var i=s.pool.get(e);i&&(i.data[0]=t?t.keys[0].length:1,i.data[1]=0,i.buffer.update(i.data))}},{key:"get",value:function(e){return s.pool.get(e)||s.create(-1)}}]),s}();JointsAnimationInfo.pool=new Map;var _typeMap2,_keyMap,jointsTextureSamplerHash=genSamplerHash([exports.GFXFilter.POINT,exports.GFXFilter.POINT,exports.GFXFilter.NONE,exports.GFXAddress.CLAMP,exports.GFXAddress.CLAMP,exports.GFXAddress.CLAMP]),SkinningModel=function(){function o(e,t){var i;_classCallCheck(this,o),(i=_possibleConstructorReturn(this,_getPrototypeOf(o).call(this,e,t))).uploadedAnim=null,i._jointsMedium=void 0,i._skeleton=null,i._type="skinning";var r=new Float32Array(4),n=i._scene.texturePool.getDefaultJointsTexture();return i._jointsMedium={buffer:null,jointsTextureInfo:r,texture:n},i}return _inherits(o,Model),_createClass(o,[{key:"worldBounds",get:function(){return this.uploadedAnim?null:this._worldBounds}}]),_createClass(o,[{key:"destroy",value:function(){_get(_getPrototypeOf(o.prototype),"destroy",this).call(this),this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null)}},{key:"bindSkeleton",value:function(e,t){(this._skeleton=e)&&t&&(this._transform=t,this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:UBOSkinningTexture.SIZE,stride:UBOSkinningTexture.SIZE})))}},{key:"uploadAnimation",value:function(e){if(this._skeleton){var t=(this.uploadedAnim=e)?this._scene.texturePool.getJointsTextureWithAnimation(this._skeleton,e):this._scene.texturePool.getDefaultJointsTexture(this._skeleton);JointsAnimationInfo.switchClip(this._transform.uuid,e),this._applyJointsTexture(t)}}},{key:"_applyJointsTexture",value:function(e){if(e){this._jointsMedium.texture=e;var t=this._jointsMedium,i=t.buffer,r=t.jointsTextureInfo;r[0]=e.handle.texture.width,r[1]=1/r[0],r[2]=e.pixelOffset+.1,i&&i.update(r);var n=samplerLib.getSampler(this._device,jointsTextureSamplerHash),s=this._subModels,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if(a){if(o>=s.length)break;c=s[o++]}else{if((o=s.next()).done)break;c=o.value}var l=c;if(l.psos){var u=l.psos,h=Array.isArray(u),_=0;for(u=h?u:u[Symbol.iterator]();;){var p;if(h){if(_>=u.length)break;p=u[_++]}else{if((_=u.next()).done)break;p=_.value}var d=p;d.pipelineLayout.layouts[0].bindTextureView(UniformJointsTexture.binding,e.handle.texView),d.pipelineLayout.layouts[0].bindSampler(UniformJointsTexture.binding,n)}}}}}},{key:"_doCreatePSO",value:function(e){var t=_get(_getPrototypeOf(o.prototype),"_doCreatePSO",this).call(this,e,{CC_USE_SKINNING:selectJointsMediumType(this._device)}),i=this._jointsMedium,r=i.buffer,n=i.texture,s=JointsAnimationInfo.get(this._transform.uuid);t.pipelineLayout.layouts[0].bindBuffer(UBOSkinningTexture.BLOCK.binding,r),t.pipelineLayout.layouts[0].bindBuffer(UBOSkinningAnimation.BLOCK.binding,s.buffer);var a=samplerLib.getSampler(this._device,jointsTextureSamplerHash);return n&&(t.pipelineLayout.layouts[0].bindTextureView(UniformJointsTexture.binding,n.handle.texView),t.pipelineLayout.layouts[0].bindSampler(UniformJointsTexture.binding,a)),t}}]),o}();function toPPM(e,t,i){return"P3 ".concat(t," ").concat(i," 255\n").concat(e.filter(function(e,t){return t%4<3}).toString(),"\n")}!function(e){e[e.positions=exports.GFXAttributeName.ATTR_POSITION]="positions",e[e.normals=exports.GFXAttributeName.ATTR_NORMAL]="normals",e[e.uvs=exports.GFXAttributeName.ATTR_TEX_COORD]="uvs",e[e.colors=exports.GFXAttributeName.ATTR_COLOR]="colors"}(_keyMap=_keyMap||{});var _defAttrs=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_NORMAL,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RG32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA32F}],v3_1$5=new Vec3;function createMesh(e,t,i){i=i||{};var r,n=[],s=0,a=[],o=0;if(0<e.positions.length){if(r=null,e.attributes){var c=e.attributes,l=Array.isArray(c),u=0;for(c=l?c:c[Symbol.iterator]();;){var h;if(l){if(u>=c.length)break;h=c[u++]}else{if((u=c.next()).done)break;h=u.value}var _=h;if(_.name===exports.GFXAttributeName.ATTR_POSITION){r=_;break}}}r=r||_defAttrs[0];var p=GFXFormatInfos[r.format];n.push(r),o=Math.max(o,Math.floor(e.positions.length/p.count)),a.push({offset:s,data:e.positions,attribute:r}),s+=p.size}if(e.normals&&0<e.normals.length){if(r=null,e.attributes){var d=e.attributes,f=Array.isArray(d),m=0;for(d=f?d:d[Symbol.iterator]();;){var y;if(f){if(m>=d.length)break;y=d[m++]}else{if((m=d.next()).done)break;y=m.value}var v=y;if(v.name===exports.GFXAttributeName.ATTR_NORMAL){r=v;break}}}r=r||_defAttrs[1];var g=GFXFormatInfos[r.format];n.push(r),o=Math.max(o,Math.floor(e.normals.length/g.count)),a.push({offset:s,data:e.normals,attribute:r}),s+=g.size}if(e.uvs&&0<e.uvs.length){if(r=null,e.attributes){var b=e.attributes,x=Array.isArray(b),T=0;for(b=x?b:b[Symbol.iterator]();;){var C;if(x){if(T>=b.length)break;C=b[T++]}else{if((T=b.next()).done)break;C=T.value}var S=C;if(S.name===exports.GFXAttributeName.ATTR_TEX_COORD){r=S;break}}}r=r||_defAttrs[2];var E=GFXFormatInfos[r.format];n.push(r),o=Math.max(o,Math.floor(e.uvs.length/E.count)),a.push({offset:s,data:e.uvs,attribute:r}),s+=E.size}if(e.colors&&0<e.colors.length){if(r=null,e.attributes){var w=e.attributes,A=Array.isArray(w),$=0;for(w=A?w:w[Symbol.iterator]();;){var O;if(A){if($>=w.length)break;O=w[$++]}else{if(($=w.next()).done)break;O=$.value}var D=O;if(D.name===exports.GFXAttributeName.ATTR_COLOR){r=D;break}}}r=r||_defAttrs[3];var k=GFXFormatInfos[r.format];n.push(r),o=Math.max(o,Math.floor(e.colors.length/k.count)),a.push({offset:s,data:e.colors,attribute:r}),s+=k.size}if(e.customAttributes){var R=e.customAttributes,I=Array.isArray(R),F=0;for(R=I?R:R[Symbol.iterator]();;){var P;if(I){if(F>=R.length)break;P=R[F++]}else{if((F=R.next()).done)break;P=F.value}var M=P,L=GFXFormatInfos[M.attr.format];n.push(M.attr),o=Math.max(o,Math.floor(M.values.length/L.count)),a.push({offset:s,data:M.values,attribute:M.attr}),s+=L.size}}for(var z=new BufferBlob,B=new ArrayBuffer(o*s),N=new DataView(B),G=0,V=a;G<V.length;G++){var U=V[G];writeBuffer(N,U.data,U.attribute.format,U.offset,s)}z.setNextAlignment(0);var X={attributes:n,view:{offset:z.getLength(),length:B.byteLength,count:o,stride:s}};z.addBuffer(B);var W=null,H=0;if(e.indices){var q=e.indices;H=q.length,W=new ArrayBuffer(2*H),writeBuffer(new DataView(W),q,exports.GFXFormat.R16UI)}var j={primitiveMode:e.primitiveMode||exports.GFXPrimitiveMode.TRIANGLE_LIST,vertexBundelIndices:[0]};if(j.primitiveMode>=exports.GFXPrimitiveMode.TRIANGLE_LIST){var Y=Float32Array.from(e.positions);z.setNextAlignment(4),j.geometricInfo={doubleSided:e.doubleSided,view:{offset:z.getLength(),length:Y.byteLength,count:e.positions.length/4,stride:4}},z.addBuffer(Y.buffer)}W&&(z.setNextAlignment(2),j.indexView={offset:z.getLength(),length:W.byteLength,count:H,stride:2},z.addBuffer(W));var Q=e.minPos;if(!Q&&i.calculateBounds){Q=Vec3.set(new Vec3,1/0,1/0,1/0);for(var K=0;K<o;++K)Vec3.set(v3_1$5,e.positions[3*K+0],e.positions[3*K+1],e.positions[3*K+2]),Vec3.min(Q,Q,v3_1$5)}var Z=e.maxPos;if(!Z&&i.calculateBounds){Z=Vec3.set(new Vec3,-1/0,-1/0,-1/0);for(var J=0;J<o;++J)Vec3.set(v3_1$5,e.positions[3*J+0],e.positions[3*J+1],e.positions[3*J+2]),Vec3.max(Z,Z,v3_1$5)}var ee={vertexBundles:[X],primitives:[j]};return Q&&(ee.minPosition=new Vec3(Q.x,Q.y,Q.z)),Z&&(ee.maxPosition=new Vec3(Z.x,Z.y,Z.z)),(t=t||new Mesh).reset({struct:ee,data:new Uint8Array(z.getCombined())}),t}function readMesh(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i={positions:[]},r=new DataView(e._nativeAsset),n=e.struct,s=n.primitives[t],a=s.vertexBundelIndices,o=Array.isArray(a),c=0;for(a=o?a:a[Symbol.iterator]();;){var l;if(o){if(c>=a.length)break;l=a[c++]}else{if((c=a.next()).done)break;l=c.value}var u=l,h=n.vertexBundles[u],_=h.view.offset,p=h.view,d=p.length,f=p.stride,m=h.attributes,y=Array.isArray(m),v=0;for(m=y?m:m[Symbol.iterator]();;){var g;if(y){if(v>=m.length)break;g=m[v++]}else{if((v=m.next()).done)break;g=v.value}var b=g,x=_keyMap[b.name];x&&(i[x]=(i[x]||[]).concat(readBuffer(r,b.format,_,d,f))),_+=GFXFormatInfos[b.format].size}}var T=s.indexView;return i.indices=readBuffer(r,exports.GFXFormat["R".concat(8*T.stride,"UI")],T.offset,T.length),i}var isLittleEndian$1=cc.sys.isLittleEndian,_typeMap=(_defineProperty(_typeMap2={},exports.GFXFormatType.UNORM,"Uint"),_defineProperty(_typeMap2,exports.GFXFormatType.SNORM,"Int"),_defineProperty(_typeMap2,exports.GFXFormatType.UINT,"Uint"),_defineProperty(_typeMap2,exports.GFXFormatType.INT,"Int"),_defineProperty(_typeMap2,exports.GFXFormatType.UFLOAT,"Float"),_defineProperty(_typeMap2,exports.GFXFormatType.FLOAT,"Float"),_defineProperty(_typeMap2,"default","Uint"),_typeMap2);function _getDataViewType(e){return(_typeMap[e.type]||_typeMap.default)+e.size/e.count*8}function writeBuffer(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:exports.GFXFormat.R32F,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=GFXFormatInfos[i];n=n||s.size;for(var a="set"+_getDataViewType(s),o=s.size/s.count,c=Math.floor(t.length/s.count),l=0;l<c;++l)for(var u=r+n*l,h=0;h<s.count;++h){var _=u+o*h;e[a](_,t[s.count*l+h],isLittleEndian$1)}}function readBuffer(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:exports.GFXFormat.R32F,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:e.byteLength-i,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[],a=GFXFormatInfos[t];n=n||a.size;for(var o="get"+_getDataViewType(a),c=a.size/a.count,l=Math.floor(r/n),u=0;u<l;++u)for(var h=i+n*u,_=0;_<a.count;++_){var p=h+c*_;s[a.count*u+_]=e[o](p,isLittleEndian$1)}return s}function mapBuffer(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:exports.GFXFormat.R32F,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:e.byteLength-r,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,a=6<arguments.length?arguments[6]:void 0;a=a||new DataView(new ArrayBuffer(e.byteLength));var o=GFXFormatInfos[i];s=s||o.size;for(var c="set"+_getDataViewType(o),l="get"+_getDataViewType(o),u=o.size/o.count,h=Math.floor(n/s),_=0;_<h;++_)for(var p=r+s*_,d=0;d<o.count;++d){var f=p+u*d,m=e[l](f,isLittleEndian$1);a[c](f,t(m,d,e),isLittleEndian$1)}return a}var _path=[],LCA=function(e,t){if(e===t)return e;var i=t;for(_path.length=0;i;)_path.push(i),i=i.parent;for(i=e;i;){if(_path.find(function(e){return e===i}))return i;i=i.parent}return null},v3_2$3=new Vec3;function calculateBoneSpaceBounds(e,t){for(var i=new Array(t.joints.length),r=0;r<i.length;++r)i[r]={hasValue:!1,min:new Vec3(1/0,1/0,1/0),max:new Vec3(-1/0,-1/0,-1/0)};for(var n=0;n<e.struct.primitives.length;++n){var s=e.readAttribute(n,exports.GFXAttributeName.ATTR_JOINTS);if(s){var a=e.readAttribute(n,exports.GFXAttributeName.ATTR_WEIGHTS);if(a){var o=e.readAttribute(n,exports.GFXAttributeName.ATTR_POSITION);if(o)for(var c=Math.min(s.length/4,a.length/4,o.length/3),l=0;l<c;++l){Vec3.set(v3_1$5,o[3*l+0],o[3*l+1],o[3*l+2]);for(var u=0;u<4;++u){if(0!==a[4*l+u]){var h=s[4*l+u];if(!(h>=t.joints.length)){t.bindposes?Vec3.transformMat4(v3_2$3,v3_1$5,t.bindposes[h]):Vec3.copy(v3_2$3,v3_1$5);var _=i[h];_.hasValue=!0,Vec3.min(_.min,_.min,v3_2$3),Vec3.max(_.max,_.max,v3_2$3)}}}}}}}return i.map(function(e){return e.hasValue?aabb.fromPoints(new aabb,e.min,e.max):null})}var BoneSpaceBoundsManager=function(){function e(){_classCallCheck(this,e),this._cached=new Map}return _createClass(e,[{key:"use",value:function(e,t){var i=this._cached.get(e);i||(i=new Map,this._cached.set(e,i));var r=i.get(t);return r||(r={bounds:calculateBoneSpaceBounds(e,t),referenceCount:0},i.set(t,r)),++r.referenceCount,r.bounds}},{key:"unuse",value:function(e,t){var i=this._cached.get(e);if(i){var r=i.get(t);r&&(--r.referenceCount,0===r.referenceCount&&i.delete(t)),0===i.size&&this._cached.delete(e)}}}]),e}(),boneSpaceBoundsManager=new BoneSpaceBoundsManager,m4_1$3=new Mat4,m4_2=new Mat4,ab_1=new aabb,v3_3=new Vec3,v3_4=new Vec3;function calculateSkinnedBounds(e,t){if(t.model&&t.mesh){var i=t.skeleton,r=t.skinningRoot,n=t.model.uploadedAnim,s=r&&JointsAnimationInfo.get(r.uuid);if(!(i&&r&&n&&s)){if(!t.model.worldBounds)return;return aabb.copy(e,t.model.worldBounds),!0}Vec3.set(v3_3,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Vec3.set(v3_4,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),r.getWorldMatrix(m4_1$3);for(var a=boneSpaceBoundsManager.use(t.mesh,i),o=i.joints.length,c=SkelAnimDataHub.getOrExtract(n),l=s.data[1],u=0;u<o;++u){var h=a[u],_=c[i.joints[u]];if(h&&_&&_.props){var p=_.props.worldMatrix.values[l];Mat4.multiply(m4_2,m4_1$3,p),aabb.transform(ab_1,h,m4_2),ab_1.getBoundary(v3_1$5,v3_2$3),Vec3.min(v3_3,v3_3,v3_1$5),Vec3.max(v3_4,v3_4,v3_2$3)}}return aabb.fromPoints(e,v3_3,v3_4),!0}}var utils=Object.freeze({toPPM:toPPM,createMesh:createMesh,readMesh:readMesh,writeBuffer:writeBuffer,readBuffer:readBuffer,mapBuffer:mapBuffer,LCA:LCA,calculateSkinnedBounds:calculateSkinnedBounds,find:find}),GFXInputAssembler=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.INPUT_ASSEMBLER)))._device=void 0,t._attributes=[],t._vertexBuffers=[],t._indexBuffer=null,t._vertexCount=0,t._firstVertex=0,t._indexCount=0,t._firstIndex=0,t._vertexOffset=0,t._instanceCount=0,t._firstInstance=0,t._isIndirect=!1,t._indirectBuffer=null,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"isIndirect",get:function(){return this._isIndirect}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),_createClass(i,[{key:"getVertexBuffer",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;return t<this._vertexBuffers.length?this._vertexBuffers[t]:null}},{key:"extractDrawInfo",value:function(e){e.vertexCount=this._vertexCount,e.firstVertex=this._firstVertex,e.indexCount=this._indexCount,e.firstIndex=this._firstIndex,e.vertexOffset=this._vertexOffset,e.instanceCount=this._instanceCount,e.firstInstance=this._firstInstance}},{key:"updateVertexAttr",value:function(e,t,i,r,n){var s=3<arguments.length&&void 0!==r?r:0,a=!(4<arguments.length&&void 0!==n)||n,o=0,c=exports.GFXFormat.UNKNOWN,l=this._attributes,u=Array.isArray(l),h=0;for(l=u?l:l[Symbol.iterator]();;){var _;if(u){if(h>=l.length)break;_=l[h++]}else{if((h=l.next()).done)break;_=h.value}var p=_;if(p.name===t){c=p.format;break}o+=GFXFormatInfos[p.format].size}var d=this._vertexBuffers[s];c&&d&&(writeBuffer(new DataView(e),i,c,o,d.stride),a&&d.update(e,0,d.stride*d.count))}},{key:"updateIndexBuffer",value:function(e,t){var i=this._indexCount,r=this._indexBuffer;i&&r&&(writeBuffer(new DataView(e),t,exports.GFXFormat["R".concat(8*r.stride,"UI")]),r.update(e,0,r.stride*r.count),this._indexCount=t.length)}}]),i}(),GFXPipelineLayout=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.PIPELINE_LAYOUT)))._device=void 0,t._pushConstantsRanges=[],t._layouts=[],t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"layouts",get:function(){return this._layouts}}]),i}(),GFXQueue=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.QUEUE)))._device=void 0,t._type=exports.GFXQueueType.GRAPHICS,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"type",get:function(){return this._type}}]),i}(),GFXRenderPass=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.RENDER_PASS)))._device=void 0,t._colorInfos=[],t._depthStencilInfo=null,t._device=e,t}return _inherits(i,GFXObject),i}(),GFXSamplerState=function(){function e(){_classCallCheck(this,e),this.name="",this.minFilter=exports.GFXFilter.LINEAR,this.magFilter=exports.GFXFilter.LINEAR,this.mipFilter=exports.GFXFilter.NONE,this.addressU=exports.GFXAddress.WRAP,this.addressV=exports.GFXAddress.WRAP,this.addressW=exports.GFXAddress.WRAP,this.maxAnisotropy=16,this.cmpFunc=exports.GFXComparisonFunc.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}return _createClass(e,[{key:"compare",value:function(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}]),e}(),GFXSampler=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.SAMPLER)))._device=void 0,t._state=new GFXSamplerState,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"state",get:function(){return this._state}}]),i}(),GFXShader=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.SHADER)))._device=void 0,t._id=void 0,t._name="",t._stages=[],t._blocks=[],t._samplers=[],t._device=e,t._id=e.genShaderId(),t}return _inherits(i,GFXObject),_createClass(i,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}}]),i}(),GFXTexture=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.TEXTURE)))._device=void 0,t._type=exports.GFXTextureType.TEX2D,t._usage=exports.GFXTextureUsageBit.NONE,t._format=exports.GFXFormat.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._arrayLayer=1,t._mipLevel=1,t._samples=exports.GFXSampleCount.X1,t._flags=exports.GFXTextureFlagBit.NONE,t._isPowerOf2=!1,t._size=0,t._buffer=null,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"arrayLayer",get:function(){return this._arrayLayer}},{key:"mipLevel",get:function(){return this._mipLevel}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),i}();cc.GFXDevice=GFXDevice,cc.GFXBuffer=GFXBuffer,cc.GFXTexture=GFXTexture,cc.GFXTextureView=GFXTextureView,cc.GFXSampler=GFXSampler,cc.GFXShader=GFXShader,cc.GFXInputAssembler=GFXInputAssembler,cc.GFXRenderPass=GFXRenderPass,cc.GFXFramebuffer=GFXFramebuffer,cc.GFXPipelineLayout=GFXPipelineLayout,cc.GFXPipelineState=GFXPipelineState,cc.GFXCommandBuffer=GFXCommandBuffer,cc.GFXQueue=GFXQueue,Object.assign(cc,GFXDefines);var _dec$i,_dec2$7,_class$i,_class2$f,_descriptor$d,_descriptor2$9,_descriptor3$6,_descriptor4$5,_descriptor5$4,_temp$h,_localBatched=new UBOLocalBatched,BatchedBuffer=function(){function t(e){_classCallCheck(this,t),this.batches=[],this.pass=void 0,this.pass=e}return _createClass(t,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.splice(0)}},{key:"merge",value:function(e,t,i){var r=e.subMeshData.flatBuffers;if(0!==r.length){for(var n=0,s=0,a=r[0].count,o=i.pipelineLayout.layouts[0],c=!1,l=0;l<this.batches.length;++l){var u=this.batches[l];if(u.vbs.length===r.length&&u.mergeCount<UBOLocalBatched.BATCHING_COUNT){c=!0;for(var h=0;h<u.vbs.length;++h){if(u.vbs[h].stride!==r[h].stride){c=!1;break}}if(c){for(var _=0;_<u.vbs.length;++_){var p=r[_],d=u.vbs[_],f=u.vbDatas[_];(n=(a+u.vbCount)*p.stride)>d.size&&(d.resize(n),f=u.vbDatas[_]=new Uint8Array(d.bufferView.buffer)),f.set(p.buffer,u.vbCount*p.stride)}(s=4*(a+u.vbCount))>u.vbIdx.size&&(u.vbIdx.resize(s),u.vbIdxData=new Float32Array(u.vbIdx.bufferView.buffer));var m=u.vbCount,y=m+a,v=u.vbIdxData,g=u.mergeCount;if(v[m]!==g||v[y-1]!==g)for(var b=m;b<y;b++)v[b]=g;return Mat4.toArray(u.uboData.view,t.model.transform.worldMatrix,UBOLocalBatched.MAT_WORLDS_OFFSET+16*u.mergeCount),u.mergeCount||u.pso===i||(o.bindBuffer(UniformBinding.UBO_LOCAL_BATCHED,u.ubo),o.update(),u.pso=i),++u.mergeCount,u.vbCount+=a,void(u.ia.vertexCount+=a)}}}for(var x=this.pass.device,T=[],C=[],S=[],E=0;E<r.length;++E){var w=r[E],A=x.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:w.count*w.stride,stride:w.stride,flags:exports.GFXBufferFlagBit.BAKUP_BUFFER});A.update(w.buffer.buffer),T.push(A),C.push(new Uint8Array(A.bufferView.buffer)),S.push(A)}var $=x.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:4*a,stride:4,flags:exports.GFXBufferFlagBit.BAKUP_BUFFER}),O=new Float32Array(a);O.fill(0),$.update(O),S.push($);for(var D=new Float32Array($.bufferView.buffer),k=e.inputAssembler.attributes,R=new Array(k.length+1),I=0;I<k.length;++I)R[I]=k[I];R[k.length]={name:"a_dyn_batch_id",format:exports.GFXFormat.R32F,stream:r.length};var F=x.createInputAssembler({attributes:R,vertexBuffers:S}),P=this.pass.device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:UBOLocalBatched.SIZE});o.bindBuffer(UniformBinding.UBO_LOCAL_BATCHED,P),o.update();var M=new UBOLocalBatched;Mat4.toArray(M.view,t.model.transform.worldMatrix,UBOLocalBatched.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:T,vbDatas:C,vbIdx:$,vbIdxData:D,vbCount:a,ia:F,ubo:P,uboData:M,pso:i})}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}},{key:"clearUBO",value:function(){for(var e=0;e<this.batches.length;++e){this.batches[e].ubo.update(_localBatched.view.buffer)}}}]),t}(),getPhaseID=function(){var t=new Map,i=0;return function(e){return"number"==typeof e?e:(t.has(e)||(t.set(e,1<<i),i++),t.get(e))}}(),_bfInfo={memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:0,usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST},_blInfo={bindings:null},_plInfo={layouts:null},_psoInfo={primitive:0,shader:null,inputState:new GFXInputState,rasterizerState:null,depthStencilState:null,blendState:null,dynamicStates:null,layout:null,renderPass:null,hash:0,program:"",defines:null,stage:0},Pass=function(){function C(e){_classCallCheck(this,C),this._buffers={},this._samplers={},this._textureViews={},this._resources=[],this._phase=getPhaseID("default"),this._idxInTech=0,this._programName="",this._priority=RenderPriority.DEFAULT,this._primitive=exports.GFXPrimitiveMode.TRIANGLE_LIST,this._stage=exports.RenderPassStage.DEFAULT,this._bindings=[],this._bs=new GFXBlendState,this._dss=new GFXDepthStencilState,this._rs=new GFXRasterizerState,this._dynamicStates=[],this._dynamics={},this._customizations=[],this._handleMap={},this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._device=void 0,this._renderPass=null,this._shader=null,this._batchedBuffer=null,this._device=e}return _createClass(C,null,[{key:"createPasses",value:function(e,t){var i=t.techIdx,r=t.defines,n=t.states,s=e.techniques[i||0];if(!s)return[];for(var a=s.passes.length,o=[],c=0;c<a;++c){var l=s.passes[c],u=l.curDefs=r.length>c?r[c]:{};if(!l.switch||u[l.switch]){l.states=n.length>c?n[c]:{},l.idxInTech=c;var h=new C(cc.game._gfxDevice);h.initialize(l),o.push(h)}}return o}},{key:"fillinPipelineInfo",value:function(e,t){void 0!==t.priority&&(e._priority=t.priority),void 0!==t.primitive&&(e._primitive=t.primitive),void 0!==t.stage&&(e._stage=t.stage),void 0!==t.dynamicStates&&(e._dynamicStates=t.dynamicStates),t.customizations&&(e._customizations=t.customizations),t.phase&&(e._phase=getPhaseID(t.phase));var i=e._bs;if(t.blendState){var r=Object.assign({},t.blendState);r.targets&&r.targets.forEach(function(e,t){return Object.assign(i.targets[t]||(i.targets[t]=new GFXBlendTarget),e)}),delete r.targets,Object.assign(i,r)}Object.assign(e._rs,t.rasterizerState),Object.assign(e._dss,t.depthStencilState)}},{key:"getPSOHash",value:function(e){var t=programLib.getKey(e.program,e.defines),i="".concat(t,",").concat(e.stage,",").concat(e.primitive);return i+=serializeBlendState(e.blendState),i+=serializeDepthStencilState(e.depthStencilState),murmurhash2_32_gc(i+=serializeRasterizerState(e.rasterizerState),666)}}]),_createClass(C,[{key:"initialize",value:function(e){this._idxInTech=e.idxInTech,this._programName=e.program,this._defines=e.curDefs,this._shaderInfo=programLib.getTemplate(e.program),this._properties=e.properties||this._properties;var t=this._device;C.fillinPipelineInfo(this,e),C.fillinPipelineInfo(this,e.states);for(var i=this._shaderInfo.blocks,r=0;r<i.length;r++){var n=i[r],s=n.size,a=n.binding;if(!isBuiltinBinding(a)){_bfInfo.size=16*Math.ceil(s/16),this._buffers[a]=t.createBuffer(_bfInfo);var o=new ArrayBuffer(s);this._blocks[a]={buffer:o,dirty:!1,view:new Float32Array(o)}}}var c=this._handleMap=this._shaderInfo.handleMap,l={};for(var u in this._properties){var h=this._properties[u];h.handleInfo&&(l[u]=this.getHandle.apply(this,h.handleInfo))}Object.assign(c,l),this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e,t,i){var r=1<arguments.length&&void 0!==t?t:0,n=2<arguments.length&&void 0!==i?i:exports.GFXType.UNKNOWN,s=this._handleMap[e];if(s)return n?s=customizeType(s,n):r&&(s=customizeType(s,getTypeFromHandle(s)-r)),s+r}},{key:"getBinding",value:function(e){var t=this.getHandle(e);if(void 0!==t)return C.getBindingFromHandle(t)}},{key:"setUniform",value:function(e,t){var i=C.getBindingFromHandle(e),r=C.getTypeFromHandle(e),n=C.getOffsetFromHandle(e),s=this._blocks[i];type2writer[r](s.view,t,n),s.dirty=!0}},{key:"getUniform",value:function(e,t){var i=C.getBindingFromHandle(e),r=C.getTypeFromHandle(e),n=C.getOffsetFromHandle(e),s=this._blocks[i];return type2reader[r](s.view,t,n)}},{key:"setUniformArray",value:function(e,t){for(var i=C.getBindingFromHandle(e),r=C.getTypeFromHandle(e),n=GFXGetTypeSize(r)>>2,s=this._blocks[i],a=C.getOffsetFromHandle(e),o=0;o<t.length;o++,a+=n)null!==t[o]&&type2writer[r](s.view,t[o],a);s.dirty=!0}},{key:"bindBuffer",value:function(e,t){if(this._buffers[e]!==t){this._buffers[e]=t;for(var i=this._resources.length,r=0;r<i;r++){this._resources[r].bindingLayout.bindBuffer(e,t)}}}},{key:"bindTextureView",value:function(e,t){if(this._textureViews[e]!==t){this._textureViews[e]=t;for(var i=this._resources.length,r=0;r<i;r++){this._resources[r].bindingLayout.bindTextureView(e,t)}}}},{key:"bindSampler",value:function(e,t){if(this._samplers[e]!==t){this._samplers[e]=t;for(var i=this._resources.length,r=0;r<i;r++){this._resources[r].bindingLayout.bindSampler(e,t)}}}},{key:"setDynamicState",value:function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){this._bs=new GFXBlendState,this._dss=new GFXDepthStencilState,this._rs=new GFXRasterizerState,C.fillinPipelineInfo(this,e),C.fillinPipelineInfo(this,t)}},{key:"update",value:function(){for(var e=this._blocks.length,t=0;t<e;t++){var i=this._blocks[t];i.dirty&&(this._buffers[t].update(i.buffer),i.dirty=!1)}for(var r=cc.director.root.pipeline.globalBindings,n=this._shaderInfo.builtins.globals,s=n.samplers.length,a=0;a<s;a++){var o=n.samplers[a],c=r.get(o.name);c.sampler&&this.bindSampler(c.samplerInfo.binding,c.sampler),this.bindTextureView(c.samplerInfo.binding,c.textureView)}}},{key:"destroy",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;isBuiltinBinding(n.binding)||this._buffers[n.binding].destroy()}this._buffers={},this._samplers={},this._textureViews={},this._batchedBuffer&&(this._batchedBuffer.destroy(),this._batchedBuffer=null)}},{key:"resetUBOs",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;if(!isBuiltinBinding(n.binding)){for(var s=this._blocks[n.binding],a=0,o=0;o<n.members.length;o++){for(var c=n.members[o],l=this._properties[c.name],u=l&&l.value,h=u||type2default[c.type],_=GFXGetTypeSize(c.type)>>2,p=0;p<c.count;p++)s.view.set(h,a+p*_);a+=_*c.count}s.dirty=!0}}}},{key:"resetTextures",value:function(){var e=this._shaderInfo.samplers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;if(!isBuiltinBinding(n.binding)){var s=this._properties[n.name],a=s&&s.value?s.value+"-texture":type2default[n.type],o=builtinResMgr.get(a),c=o&&o.getGFXTextureView();if(c){this._textureViews[n.binding]=c;for(var l=s&&void 0!==s.samplerHash?s.samplerHash:o.getSamplerHash(),u=this._samplers[n.binding]=samplerLib.getSampler(this._device,l),h=0;h<this._resources.length;h++){var _=this._resources[h];_.bindingLayout.bindSampler(n.binding,u),_.bindingLayout.bindTextureView(n.binding,c)}}else console.warn("illegal texture default value: "+a)}}}},{key:"tryCompile",value:function(e,t){var i=!(1<arguments.length&&void 0!==t)||t,r=cc.director.root.pipeline;if(!r)return null;if(this._renderPass=r.getRenderPass(this._stage),!this._renderPass)return console.warn("illegal pass stage."),null;var n=this._defines;e&&(i?Object.assign(this._defines,e):(Object.assign(e,this._defines),n=e));var s=programLib.getGFXShader(this._device,this._programName,n,r);if(!s)return console.warn("create shader ".concat(this._programName," failed")),null;i&&(this._shader=s);var a=this._shaderInfo,o=a.blocks,c=a.samplers;e:for(var l=this._bindings.length=0;l<o.length;l++){for(var u=o[l],h=0;h<u.defines.length;h++)if(!n[u.defines[h]])continue e;this._bindings.push(u)}e:for(var _=0;_<c.length;_++){for(var p=c[_],d=0;d<p.defines.length;d++)if(!n[p.defines[d]])continue e;this._bindings.push(p)}return s}},{key:"createPipelineState",value:function(e,t){if(!(this._renderPass&&this._shader&&this._bindings.length||this.tryCompile()))return console.warn("pass resources not complete, create PSO failed"),null;var i=this._shader;e&&(i=this.tryCompile(e,!1)),_blInfo.bindings=this._bindings;var r=this._device.createBindingLayout(_blInfo);for(var n in this._buffers)r.bindBuffer(parseInt(n),this._buffers[n]);for(var s in this._samplers)r.bindSampler(parseInt(s),this._samplers[s]);for(var a in this._textureViews)r.bindTextureView(parseInt(a),this._textureViews[a]);var o=cc.director.root.pipeline.globalBindings,c=this._shaderInfo.builtins.globals,l=c.blocks,u=Array.isArray(l),h=0;for(l=u?l:l[Symbol.iterator]();;){var _;if(u){if(h>=l.length)break;_=l[h++]}else{if((h=l.next()).done)break;_=h.value}var p=_,d=o.get(p.name);d&&d.type===exports.GFXBindingType.UNIFORM_BUFFER?r.bindBuffer(d.blockInfo.binding,d.buffer):console.warn("builtin UBO '".concat(p.name,"' not available!"))}var f=c.samplers,m=Array.isArray(f),y=0;for(f=m?f:f[Symbol.iterator]();;){var v;if(m){if(y>=f.length)break;v=f[y++]}else{if((y=f.next()).done)break;v=y.value}var g=v,b=o.get(g.name);b&&b.type===exports.GFXBindingType.SAMPLER?(b.sampler&&r.bindSampler(b.samplerInfo.binding,b.sampler),r.bindTextureView(b.samplerInfo.binding,b.textureView)):console.warn("builtin texture '".concat(g.name,"' not available!"))}_plInfo.layouts=[r];var x=this._device.createPipelineLayout(_plInfo);_psoInfo.primitive=t&&t.primitive||this._primitive,_psoInfo.shader=i,_psoInfo.rasterizerState=t&&t.rasterizerState||this._rs,_psoInfo.depthStencilState=t&&t.depthStencilState||this._dss,_psoInfo.blendState=t&&t.blendState||this._bs,_psoInfo.dynamicStates=t&&t.dynamicStates||this._dynamicStates,_psoInfo.layout=x,_psoInfo.renderPass=this._renderPass,_psoInfo.program=this._programName,_psoInfo.defines=e||this._defines,_psoInfo.stage=this._stage,_psoInfo.hash=C.getPSOHash(_psoInfo);var T=this._device.createPipelineState(_psoInfo);return this._resources.push({bindingLayout:r,pipelineLayout:x,pipelineState:T}),T}},{key:"destroyPipelineState",value:function(t){var e=this._resources.findIndex(function(e){return e.pipelineState===t});if(0<=e){var i=this._resources[e],r=i.bindingLayout,n=i.pipelineLayout,s=i.pipelineState;r.destroy(),n.destroy(),s.destroy(),this._resources.splice(e,1)}}},{key:"createBatchedBuffer",value:function(){this._batchedBuffer||(this._batchedBuffer=new BatchedBuffer(this))}},{key:"clearBatchedBuffer",value:function(){this._batchedBuffer&&this._batchedBuffer.clearUBO()}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"customizations",get:function(){return this._customizations}},{key:"phase",get:function(){return this._phase}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"idxInTech",get:function(){return this._idxInTech}},{key:"device",get:function(){return this._device}},{key:"bindings",get:function(){return this._bindings}},{key:"shader",get:function(){return this._shader}},{key:"dynamics",get:function(){return this._dynamics}},{key:"batchedBuffer",get:function(){return this._batchedBuffer}},{key:"blocks",get:function(){return this._blocks}}]),C}();function serializeBlendState(e){var t=",bs,".concat(e.isA2C,",").concat(e.blendColor),i=e.targets,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;t+=",bt,".concat(a.blend,",").concat(a.blendEq,",").concat(a.blendAlphaEq,",").concat(a.blendColorMask),t+=",".concat(a.blendSrc,",").concat(a.blendDst,",").concat(a.blendSrcAlpha,",").concat(a.blendDstAlpha)}return t}function serializeRasterizerState(e){return",rs,".concat(e.cullMode,",").concat(e.depthBias,",").concat(e.isFrontFaceCCW)}function serializeDepthStencilState(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)}Pass.getBindingTypeFromHandle=getBindingTypeFromHandle,Pass.getTypeFromHandle=getTypeFromHandle,Pass.getBindingFromHandle=getBindingFromHandle,Pass.getOffsetFromHandle=getOffsetFromHandle;var Material=(_dec$i=ccclass("cc.Material"),_dec2$7=property(EffectAsset),_dec$i((_descriptor$d=_applyDecoratedDescriptor((_class2$f=_temp$h=function(){function n(){var e;return _classCallCheck(this,n),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this)),"_effectAsset",_descriptor$d,_assertThisInitialized(e)),_initializerDefineProperty(e,"_techIdx",_descriptor2$9,_assertThisInitialized(e)),_initializerDefineProperty(e,"_defines",_descriptor3$6,_assertThisInitialized(e)),_initializerDefineProperty(e,"_states",_descriptor4$5,_assertThisInitialized(e)),_initializerDefineProperty(e,"_props",_descriptor5$4,_assertThisInitialized(e)),e._passes=[],e._owner=null,e._hash=0,e.loaded=!1,e}return _inherits(n,Asset),_createClass(n,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}}],[{key:"getInstantiatedMaterial",value:function(e,t,i){if(e._owner===t)return e;var r=new n;return r.copy(e),r._native=e._native+" (Instance)",r._owner=t,i&&(r._uuid=e._uuid),r}}]),_createClass(n,[{key:"reset",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=EffectAsset.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"initialize",value:function(e){this.reset(e)}},{key:"destroy",value:function(){if(this._passes&&this._passes.length){var e=this._passes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy()}}return this._passes=[],this._effectAsset=null,this._props=[],this._defines=[],this._states=[],_get(_getPrototypeOf(n.prototype),"destroy",this).call(this)}},{key:"resetUniforms",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e;this._props.length=this._passes.length;for(var i=0;i<this._props.length;i++)this._props[i]={};if(t){var r=this._passes,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=a;o.resetUBOs(),o.resetTextures()}}}},{key:"recompileShaders",value:function(e,t){if(this._passes&&this._effectAsset){if(void 0===t){var i=this._passes,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}s.tryCompile(e)}}else this._passes[t].tryCompile(e);this._onPassesChange()}}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this._effectAsset){var i=this._effectAsset.techniques[this._techIdx].passes;if(void 0===t)for(var r=0;r<this._passes.length;r++){var n=this._passes[r];this._states[r]=e,n.overridePipelineStates(i[n.idxInTech],e)}else this._states[t]=e,this._passes[t].overridePipelineStates(i[t],e);this._onPassesChange()}}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"setProperty",value:function(e,t,i){var r=!1;if(void 0===i)for(var n=this._passes,s=n.length,a=0;a<s;a++){var o=n[a];this._uploadProperty(o,e,t)&&(this._props[a][e]=t,r=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: ".concat(i,"."));var c=this._passes[i];this._uploadProperty(c,e,t)&&(this._props[i][e]=t,r=!0)}r||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var i=this._props,r=i.length,n=0;n<r;n++){var s=i[n];for(var a in s)if(a===e)return s[a]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;var o=this._props[t];for(var c in o)if(c===e)return o[c]}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=Object.assign({},e._props[t]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=Object.assign({},e._defines[i]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=Object.assign({},e._states[r]);this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(i).fill(e)}for(var r=0;r<e.length;++r)Object.assign(t[r]||(t[r]={}),e[r])}},{key:"_update",value:function(e){var n=this,t=!(0<arguments.length&&void 0!==e)||e;if(this._effectAsset){if(this._passes&&this._passes.length){var i=this._passes,r=Array.isArray(i),s=0;for(i=r?i:i[Symbol.iterator]();;){var a;if(r){if(s>=i.length)break;a=i[s++]}else{if((s=i.next()).done)break;a=s.value}a.destroy()}}this._passes=Pass.createPasses(this._effectAsset,{techIdx:this._techIdx,defines:this._defines,states:this._states});var o=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=o,t)this._passes.forEach(function(e,t){var i=n._props[e.idxInTech];for(var r in i=i||(n._props[t]={})){i[r]&&n._uploadProperty(e,r,i[r])}});else for(var c=0;c<this._props.length;c++)this._props[c]={}}else{var l=builtinResMgr.get("missing-effect-material");l&&(this._passes=l._passes.slice())}this._onPassesChange()}},{key:"_uploadProperty",value:function(e,t,i){var r=e.getHandle(t);if(void 0===r)return!1;var n=Pass.getBindingTypeFromHandle(r);if(n===exports.GFXBindingType.UNIFORM_BUFFER)Array.isArray(i)?e.setUniformArray(r,i):e.setUniform(r,i);else if(n===exports.GFXBindingType.SAMPLER){var s=Pass.getBindingFromHandle(r);if(i instanceof GFXTextureView)e.bindTextureView(s,i);else if(i instanceof TextureBase||i instanceof SpriteFrame){var a=i.getGFXTextureView();if(!a||!a.texture.width||!a.texture.height)return!1;e.bindTextureView(s,a),i instanceof TextureBase&&e.bindSampler(s,samplerLib.getSampler(cc.game._gfxDevice,i.getSamplerHash()))}}return!0}},{key:"_onPassesChange",value:function(){var t=this,e="",i=this._passes,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;e+=Pass.getPSOHash(a)}if(this._hash=murmurhash2_32_gc(e,666),this._owner){var o=this._owner,c=o.sharedMaterials.findIndex(function(e){return e===t});0<=c&&o._onRebuildPSO(c,this)}}}]),n}()).prototype,"_effectAsset",[_dec2$7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$9=_applyDecoratedDescriptor(_class2$f.prototype,"_techIdx",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor3$6=_applyDecoratedDescriptor(_class2$f.prototype,"_defines",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor4$5=_applyDecoratedDescriptor(_class2$f.prototype,"_states",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor5$4=_applyDecoratedDescriptor(_class2$f.prototype,"_props",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_class$i=_class2$f))||_class$i);cc.Material=Material;var SplashScreen=function(){function t(){_classCallCheck(this,t),this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.setting=void 0,this.image=void 0,this.device=void 0,this.cmdBuff=void 0,this.assmebler=void 0,this.vertexBuffers=void 0,this.indicesBuffers=void 0,this.pso=void 0,this.framebuffer=void 0,this.renderArea=void 0,this.region=void 0,this.material=void 0,this.texture=void 0,this.textureView=void 0,this.clearColors=void 0,this._splashFinish=!1,this._loadFinish=!1,this.textImg=void 0,this.textRegion=void 0,this.textTexture=void 0,this.textTextureView=void 0,this.textVB=void 0,this.textIB=void 0,this.textAssmebler=void 0,this.textMaterial=void 0,this.textPSO=void 0,this.program=void 0,this.effect=void 0,this.screenWidth=void 0,this.screenHeight=void 0}return _createClass(t,[{key:"main",value:function(e){if(window._CCSettings&&window._CCSettings.splashScreen?(this.setting=window._CCSettings.splashScreen,this.setting.totalTime=null!=this.setting.totalTime?this.setting.totalTime:3e3,this.setting.base64src=null!=this.setting.base64src?this.setting.base64src:"",this.setting.effect=null!=this.setting.effect?this.setting.effect:"Fade-InOut",this.setting.clearColor=null!=this.setting.clearColor?this.setting.clearColor:{r:.88,g:.88,b:.88,a:1},this.setting.displayRatio=null!=this.setting.displayRatio?this.setting.displayRatio:.4,this.setting.displayWatermark=null==this.setting.displayWatermark||this.setting.displayWatermark):this.setting={totalTime:3e3,base64src:"",effect:"Fade-InOut",clearColor:{r:.88,g:.88,b:.88,a:1},displayRatio:.4,displayWatermark:!0},""==this.setting.base64src||this.setting.totalTime<=0)return this.callBack&&this.callBack(),this.callBack=null,this.setting=null,void delete t._ins;cc.game.once(cc.Game.EVENT_GAME_INITED,function(){cc.director._lateUpdate=performance.now()},cc.director),this.program={name:"util/splash-image",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"util/splash-image|splash-vs:vert|splash-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},u_precent:{type:13}}}]}],shaders:[{name:"util/splash-image|splash-vs:vert|splash-fs:frag",hash:2381344969,glsl3:{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform float u_precent;\nvec4 frag () {\n  vec4 color = texture2D(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[{name:"splashFrag",defines:[],binding:0,members:[{name:"u_precent",type:13,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},this.effect=new EffectAsset,this.effect.name=this.program.name,this.effect.techniques=this.program.techniques,this.effect.shaders=this.program.shaders,this.effect.onLoaded(),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.clearColors=[this.setting.clearColor],this.device=e,this.screenWidth=this.device.width,this.screenHeight=this.device.height,this.device.nativeWidth<this.device.nativeHeight?this.device.width>this.device.height&&(this.screenWidth=this.device.height,this.screenHeight=this.device.width):this.device.width<this.device.height&&(this.screenWidth=this.device.height,this.screenHeight=this.device.width),this.image=new Image,this.image.onload=this.init.bind(this),this.image.src=this.setting.base64src}},{key:"setOnFinish",value:function(e){this.callBack=e}},{key:"_tryToStart",value:function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide())}},{key:"init",value:function(){var n=this;this.initCMD(),this.initIA(),this.initPSO(),this.setting.displayWatermark&&this.initText();this.handle=requestAnimationFrame(function e(t){if(!n.cancelAnimate){n.startTime<0&&(n.startTime=t);var i=t-n.startTime,r=cubicOut(clamp01(i/n.setting.totalTime));n.material.setProperty("u_precent",r),n.material.passes[0].update(),n.setting.displayWatermark&&n.textMaterial&&(n.textMaterial.setProperty("u_precent",r),n.textMaterial.passes[0].update()),n.frame(t),i>n.setting.totalTime&&(n.splashFinish=!0),requestAnimationFrame(e)}})}},{key:"hide",value:function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,this.destoy()}},{key:"frame",value:function(e){var t=this.device,i=this.cmdBuff,r=this.framebuffer,n=this.renderArea;i.begin(),i.beginRenderPass(r,n,exports.GFXClearFlag.ALL,this.clearColors,1,0),i.bindPipelineState(this.pso),i.bindBindingLayout(this.pso.pipelineLayout.layouts[0]),i.bindInputAssembler(this.assmebler),i.draw(this.assmebler),this.setting.displayWatermark&&this.textPSO&&this.textAssmebler&&(i.bindPipelineState(this.textPSO),i.bindBindingLayout(this.textPSO.pipelineLayout.layouts[0]),i.bindInputAssembler(this.textAssmebler),i.draw(this.textAssmebler)),i.endRenderPass(),i.end(),t.queue.submit([i]),t.present()}},{key:"initText",value:function(){this.textImg=document.createElement("canvas"),this.textImg.width=300,this.textImg.height=30,this.textImg.style.width="".concat(this.textImg.width),this.textImg.style.height="".concat(this.textImg.height);var e=this.textImg.getContext("2d");e.font="".concat(18,"px Arial"),e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`",e.fillText("Powered by Cocos Creator 3D",30,8),this.textRegion=new GFXBufferTextureCopy,this.textRegion.texExtent.width=this.textImg.width,this.textRegion.texExtent.height=this.textImg.height,this.textRegion.texExtent.depth=1,this.textTexture=this.device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.SAMPLED,format:exports.GFXFormat.RGBA8,width:this.textImg.width,height:this.textImg.height,mipLevel:1}),this.textTextureView=this.device.createTextureView({texture:this.textTexture,type:exports.GFXTextureViewType.TV2D,format:exports.GFXFormat.RGBA8}),this.device.copyTexImagesToTexture([this.textImg],this.textTexture,[this.textRegion]),this.textMaterial=new Material,this.textMaterial.initialize({effectAsset:this.effect});var t=this.textMaterial.passes[0],i=t.getBinding("mainTexture");t.bindTextureView(i,this.textTextureView),this.textPSO=t.createPipelineState(),this.textPSO.pipelineLayout.layouts[0].update();var r=4*Float32Array.BYTES_PER_ELEMENT,n=4*r;this.textVB=this.device.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:n,stride:r});var s=new Float32Array(16),a=-this.textImg.width/2,o=-this.textImg.height/2;o=this.screenWidth<this.screenHeight?(a=-this.screenWidth/2*.5)/(this.textImg.width/this.textImg.height):(a=-this.screenHeight/2*.5)/(this.textImg.width/this.textImg.height);var c=0;s[c++]=a,s[c++]=o,s[c++]=0,s[c++]=1,s[c++]=-a,s[c++]=o,s[c++]=1,s[c++]=1,s[c++]=a,s[c++]=-o,s[c++]=0,s[c++]=0,s[c++]=-a,s[c++]=-o,s[c++]=1;for(var l=s[c++]=0;l<s.length;l+=4)s[l]=s[l]+this.screenWidth/2,s[l+1]=s[l+1]+.1*this.screenHeight;for(var u=0;u<s.length;u+=4)s[u]=s[u]/this.screenWidth*2-1,s[u+1]=s[u+1]/this.screenHeight*2-1;this.textVB.update(s);var h=Uint8Array.BYTES_PER_ELEMENT,_=6*h;this.textIB=this.device.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:_,stride:h});var p=new Uint8Array(6);p[0]=0,p[1]=1,p[2]=2,p[3]=1,p[4]=3,p[5]=2,this.textIB.update(p);var d=[{name:"a_position",format:exports.GFXFormat.RG32F},{name:"a_texCoord",format:exports.GFXFormat.RG32F}];this.textAssmebler=this.device.createInputAssembler({attributes:d,vertexBuffers:[this.textVB],indexBuffer:this.textIB})}},{key:"initCMD",value:function(){var e=this.device;this.renderArea={x:0,y:0,width:e.width,height:e.height},this.framebuffer=e.mainWindow.framebuffer,this.cmdBuff=e.createCommandBuffer({allocator:e.commandAllocator,type:exports.GFXCommandBufferType.PRIMARY})}},{key:"initIA",value:function(){var e=this.device,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t;this.vertexBuffers=e.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:i,stride:t});var r=new Float32Array(16),n=-this.image.width/2,s=-this.image.height/2;s=this.screenWidth<this.screenHeight?(n=-this.screenWidth/2*this.setting.displayRatio)/(this.image.width/this.image.height):(n=-this.screenHeight/2*this.setting.displayRatio)/(this.image.width/this.image.height);var a=0;r[a++]=n,r[a++]=s,r[a++]=0,r[a++]=1,r[a++]=-n,r[a++]=s,r[a++]=1,r[a++]=1,r[a++]=n,r[a++]=-s,r[a++]=0,r[a++]=0,r[a++]=-n,r[a++]=-s,r[a++]=1;for(var o=r[a++]=0;o<r.length;o+=4)r[o]=r[o]+this.screenWidth/2,r[o+1]=r[o+1]+this.screenHeight/2;for(var c=0;c<r.length;c+=4)r[c]=r[c]/this.screenWidth*2-1,r[c+1]=r[c+1]/this.screenHeight*2-1;this.vertexBuffers.update(r);var l=Uint8Array.BYTES_PER_ELEMENT,u=6*l;this.indicesBuffers=e.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:u,stride:l});var h=new Uint8Array(6);h[0]=0,h[1]=1,h[2]=2,h[3]=1,h[4]=3,h[5]=2,this.indicesBuffers.update(h);var _=[{name:"a_position",format:exports.GFXFormat.RG32F},{name:"a_texCoord",format:exports.GFXFormat.RG32F}];this.assmebler=e.createInputAssembler({attributes:_,vertexBuffers:[this.vertexBuffers],indexBuffer:this.indicesBuffers})}},{key:"initPSO",value:function(){var e=this.device;this.material=new Material,this.material.initialize({effectAsset:this.effect}),this.texture=e.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.SAMPLED,format:exports.GFXFormat.RGBA8,width:this.image.width,height:this.image.height,mipLevel:1}),this.textureView=e.createTextureView({texture:this.texture,type:exports.GFXTextureViewType.TV2D,format:exports.GFXFormat.RGBA8});var t=this.material.passes[0],i=t.getBinding("mainTexture");t.bindTextureView(i,this.textureView),this.pso=t.createPipelineState(),this.pso.pipelineLayout.layouts[0].update(),this.region=new GFXBufferTextureCopy,this.region.texExtent.width=this.image.width,this.region.texExtent.height=this.image.height,this.region.texExtent.depth=1,e.copyTexImagesToTexture([this.image],this.texture,[this.region])}},{key:"destoy",value:function(){this.callBack=null,this.clearColors=null,this.device=null,this.image=null,this.framebuffer=null,this.renderArea=null,this.region=null,this.program=null,this.effect.destroy(),this.effect=null,this.cmdBuff.destroy(),this.cmdBuff=null,this.pso.destroy(),this.pso=null,this.material.destroy(),this.material=null,this.textureView.destroy(),this.textureView=null,this.texture.destroy(),this.texture=null,this.assmebler.destroy(),this.assmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.setting.displayWatermark&&this.textImg&&(this.textImg=null,this.textRegion=null,this.textPSO.destroy(),this.textPSO=null,this.textMaterial.destroy(),this.textMaterial=null,this.textTextureView.destroy(),this.textTextureView=null,this.textTexture.destroy(),this.textTexture=null,this.textAssmebler.destroy(),this.textAssmebler=null,this.textVB.destroy(),this.textVB=null,this.textIB.destroy(),this.textIB=null),this.setting=null,delete t._ins}},{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return null==t._ins&&(t._ins=new t),t._ins}}]),t}();SplashScreen._ins=void 0;var Game=function(){function p(){var e,t;_classCallCheck(this,p);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(p)).call.apply(e,[this].concat(r)))).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=_get(_getPrototypeOf(p.prototype),"on",_assertThisInitialized(t)),t.eventTargetOnce=_get(_getPrototypeOf(p.prototype),"once",_assertThisInitialized(t)),t.config={},t.onStart=null,t._persistRootNodes={},t._paused=!0,t._configLoaded=!1,t._isCloning=!1,t._prepared=!1,t._rendererInitialized=!1,t._gfxDevice=null,t._intervalId=null,t._lastTime=null,t._frameTime=null,t._sceneInfos=[],t.collisionMatrix=[],t.groupList=[],t}return _inherits(p,EventTarget),_createClass(p,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate||0}},{key:"step",value:function(){cc.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0)}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){cc.director.once(cc.Director.EVENT_AFTER_DRAW,function(){for(var e in cc.game._persistRootNodes)cc.game.removePersistRootNode(cc.game._persistRootNodes[e]);cc.director.getScene().destroy(),cc.Object._deferredDestroy(),cc.director.purgeDirector(),cc.director.reset(),cc.game.onStart()})}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,t,i){this._prepared&&e===p.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOn(e,t,i)}},{key:"once",value:function(e,t,i){this._prepared&&e===p.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOnce(e,t,i)}},{key:"run",value:function(e,t){this._initConfig(e),this._initRenderer(),this.onStart=t,SplashScreen.instance.main(this._gfxDevice),this.prepare(cc.game.onStart&&cc.game.onStart.bind(cc.game))}},{key:"addPersistRootNode",value:function(e){if(cc.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=cc.director._scene;if(cc.isValid(i))if(e.parent){if(!(e.parent instanceof cc.Scene))return void warnID(3801);if(e.parent!==i)return void warnID(3802)}else e.parent=i;(this._persistRootNodes[t]=e)._persistNode=!0}}else warnID(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"prepare",value:function(t){if(this._prepared)t&&t();else{var e=this.config.jsList;if(e&&0<e.length){var i=this;cc.loader.load(e,function(e){if(e)throw new Error(JSON.stringify(e));i._prepareFinished(t)})}else this._prepareFinished(t)}}},{key:"_initEngine",value:function(){this._initEvents(),this.emit(p.EVENT_ENGINE_INITED)}},{key:"_prepareFinished",value:function(e){var t=this;this._prepared=!0,this._initEngine(),console.log("Cocos Creator 3D v"+cc.ENGINE_VERSION);function i(){t._setAnimFrame(),t._runMainLoop(),t.emit(p.EVENT_GAME_INITED),e&&e()}SplashScreen.instance.setOnFinish(i),SplashScreen.instance.loadFinish=!0}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=cc.game.config.frameRate;this._frameTime=1e3/e,60!==e&&30!==e?(window.requestAnimationFrame=this._stTime,window.cancelAnimationFrame=this._ctTime):(window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cancelAnimationFrame=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),i=Math.max(0,cc.game._frameTime-(t-cc.game._lastTime)),r=window.setTimeout(function(){e()},i);return cc.game._lastTime=t+i,r}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var t,i=this,e=i.config,r=cc.director,n=!0,s=e.frameRate;setDisplayStats(!!e.showFPS),t=function(e){if(!i._paused){if(i._intervalId=window.requestAnimationFrame(t),30===s&&(n=!n))return;r.mainLoop(e)}},i._intervalId=window.requestAnimationFrame(t),i._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||2<t||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],_resetDebugSetting(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,t=parseInt(e.renderMode);this.renderType=p.RENDER_TYPE_CANVAS;var i=!1;if(0===t?cc.sys.capabilities.opengl?(this.renderType=p.RENDER_TYPE_WEBGL,i=!0):cc.sys.capabilities.canvas&&(this.renderType=p.RENDER_TYPE_CANVAS,i=!0):1===t&&cc.sys.capabilities.canvas?(this.renderType=p.RENDER_TYPE_CANVAS,i=!0):2===t&&cc.sys.capabilities.opengl&&(this.renderType=p.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(getError(3820,t))}},{key:"_initRenderer",value:function(){if(!this._rendererInitialized){var e,t,i,r,n,s,a=this.config.id,o=cc.sys.platform===cc.sys.WECHAT_GAME,c=cc.sys.platform===cc.sys.QQ_PLAY;if(o)this.container=r=document.createElement("div"),this.frame=r.parentNode===document.body?document.documentElement:r.parentNode,i=cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?window.sharedCanvas||wx.getSharedCanvas():window.canvas,this.canvas=i;else if(c)this.container=cc.container=document.createElement("div"),this.frame=document.documentElement,this.canvas=i=window.canvas;else{var l=a?a instanceof HTMLElement?a:document.querySelector(a)||document.querySelector("#"+a):null;if(!l)throw new Error(getError(200));"CANVAS"===l.tagName?(e=l.width,t=l.height,this.canvas=i=l,this.container=r=document.createElement("div"),i&&i.parentNode&&i.parentNode.insertBefore(r,i)):("DIV"!==l.tagName&&warnID(3819),e=l.clientWidth,t=l.clientHeight,this.canvas=i=document.createElement("canvas"),this.container=r=document.createElement("div"),l.appendChild(r)),r.setAttribute("id","Cocos3dGameContainer"),r.appendChild(i),this.frame=r.parentNode===document.body?document.documentElement:r.parentNode,s="gameCanvas",-1<(" "+(n=i).className+" ").indexOf(" "+s+" ")||(n.className&&(n.className+=" "),n.className+=s),i.setAttribute("width",e||"480"),i.setAttribute("height",t||"320"),i.setAttribute("tabindex","99")}if(this._determineRenderType(),this.renderType===p.RENDER_TYPE_WEBGL){var u=!!window.WebGL2RenderingContext,h=navigator.userAgent.toLowerCase();-1!==h.indexOf("safari")&&-1===h.indexOf("chrome")&&(u=!1),u&&cc.WebGL2GFXDevice?this._gfxDevice=new cc.WebGL2GFXDevice:cc.WebGLGFXDevice&&(this._gfxDevice=new cc.WebGLGFXDevice);var _={canvasElm:i,debug:!0,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*cc.view._devicePixelRatio),nativeHeight:Math.floor(screen.height*cc.view._devicePixelRatio)};!this._gfxDevice.initialize(_)&&u&&(this._gfxDevice=new cc.WebGLGFXDevice,this._gfxDevice.initialize(_))}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=p.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!cc._isContextMenuEnable)return!1},this._rendererInitialized=!0,this.emit(p.EVENT_RENDERER_INITED)}}},{key:"_initEvents",value:function(){var i,e=window;void 0!==document.hidden?i="hidden":void 0!==document.mozHidden?i="mozHidden":void 0!==document.msHidden?i="msHidden":void 0!==document.webkitHidden&&(i="webkitHidden");var t=!1;function r(){t||(t=!0,cc.game.emit(p.EVENT_HIDE))}function n(){t&&(t=!1,cc.game.emit(p.EVENT_SHOW))}if(i)for(var s=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<s.length;a++)document.addEventListener(s[a],function(e){var t=document[i];(t=t||e.hidden)?r():n()});else e.addEventListener("blur",r),e.addEventListener("focus",n);-1<navigator.userAgent.indexOf("MicroMessenger")&&(e.onfocus=n),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&(wx.onShow&&wx.onShow(n),wx.onHide&&wx.onHide(r)),"onpageshow"in window&&"onpagehide"in window&&(e.addEventListener("pagehide",r),e.addEventListener("pageshow",n),document.addEventListener("pagehide",r),document.addEventListener("pageshow",n)),this.on(p.EVENT_HIDE,function(){cc.game.pause()}),this.on(p.EVENT_SHOW,function(){cc.game.resume()})}}]),p}();Game.EVENT_HIDE="game_on_hide",Game.EVENT_SHOW="game_on_show",Game.EVENT_GAME_INITED="game_inited",Game.EVENT_ENGINE_INITED="engine_inited",Game.EVENT_RENDERER_INITED="renderer_inited",Game.RENDER_TYPE_CANVAS=0,Game.RENDER_TYPE_WEBGL=1,Game.RENDER_TYPE_OPENGL=2,cc.Game=Game;var game=cc.game=new Game,BrowserGetter=function(){function e(){_classCallCheck(this,e),this.html=void 0,this.meta={width:"device-width"},this.adaptationType=cc.sys.browserType}return _createClass(e,[{key:"init",value:function(){0}},{key:"availWidth",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth}},{key:"availHeight",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight}}]),e}(),__BrowserGetter=new BrowserGetter;switch(cc.sys.os===cc.sys.OS_IOS&&(__BrowserGetter.adaptationType=cc.sys.BROWSER_TYPE_SAFARI),cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?__BrowserGetter.adaptationType=cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:__BrowserGetter.adaptationType=cc.sys.BROWSER_TYPE_WECHAT_GAME,__BrowserGetter.adaptationType){case cc.sys.BROWSER_TYPE_SAFARI:__BrowserGetter.meta["minimal-ui"]="true";case cc.sys.BROWSER_TYPE_SOUGOU:case cc.sys.BROWSER_TYPE_UC:__BrowserGetter.availWidth=function(e){return e.clientWidth},__BrowserGetter.availHeight=function(e){return e.clientHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME:__BrowserGetter.availWidth=function(){return window.innerWidth},__BrowserGetter.availHeight=function(){return window.innerHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:var sharedCanvas=window.sharedCanvas||wx.getSharedCanvas();__BrowserGetter.availWidth=function(){return sharedCanvas.width},__BrowserGetter.availHeight=function(){return sharedCanvas.height}}var _scissorRect=null,View=function(){function r(){var e;_classCallCheck(this,r),(e=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this)))._frameSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._devicePixelRatio=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resizing=void 0,e._orientationChanging=void 0,e._isRotated=void 0,e._orientation=void 0,e._isAdjustViewport=void 0,e._antiAliasEnabled=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0,e._resizeWithBrowserSize=void 0,e._designResolutionSize=void 0,e._originalDesignResolutionSize=void 0;_assertThisInitialized(e);var t=ContainerStrategy,i=ContentStrategy;return e._frameSize=new Size(0,0),e._designResolutionSize=new Size(0,0),e._originalDesignResolutionSize=new Size(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Rect(0,0,0,0),e._visibleRect=new Rect(0,0,0,0),e._autoFullScreen=!1,e._devicePixelRatio=1,e._retinaEnabled=!1,e._resizeCallback=null,e._resizing=!1,e._resizeWithBrowserSize=!1,e._orientationChanging=!0,e._isRotated=!1,e._orientation=cc.macro.ORIENTATION_AUTO,e._isAdjustViewport=!0,e._antiAliasEnabled=!1,e._resolutionPolicy=null,e._rpExactFit=new ResolutionPolicy(t.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new ResolutionPolicy(t.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new ResolutionPolicy(t.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new ResolutionPolicy(t.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new ResolutionPolicy(t.EQUAL_TO_FRAME,i.FIXED_WIDTH),cc.game.once(cc.Game.EVENT_ENGINE_INITED,e.init,_assertThisInitialized(e)),e}return _inherits(r,EventTarget),_createClass(r,[{key:"init",value:function(){__BrowserGetter.init(),this._initFrameSize(),this.enableAntiAlias(!0);var e=cc.game.canvas.width,t=cc.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect)}},{key:"resizeWithBrowserSize",value:function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){(e&=cc.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}},{key:"adjustViewportMeta",value:function(e){this._isAdjustViewport=e}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAntiAlias",value:function(e){if(this._antiAliasEnabled!==e)if(this._antiAliasEnabled=e,cc.game.renderType===cc.Game.RENDER_TYPE_WEBGL){var t=cc.loader._cache;for(var i in t){var r=t[i],n=r&&r.content instanceof cc.Texture2D?r.content:null;if(n){var s=cc.Texture2D.Filter;e?n.setFilters(s.LINEAR,s.LINEAR):n.setFilters(s.NEAREST,s.NEAREST)}}}else if(cc.game.renderType===cc.Game.RENDER_TYPE_CANVAS){var a=cc.game.canvas.getContext("2d");a.imageSmoothingEnabled=e,a.mozImageSmoothingEnabled=e}}},{key:"isAntiAliasEnabled",value:function(){return this._antiAliasEnabled}},{key:"enableAutoFullScreen",value:function(e){e&&e!==this._autoFullScreen&&cc.sys.isMobile&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,cc.screen.autoFullScreen(cc.game.frame)):this._autoFullScreen=!1}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){var i=cc.game.canvas,r=cc.game.container;i.width=e*this._devicePixelRatio,i.height=t*this._devicePixelRatio,i.style.width=e+"px",i.style.height=t+"px",r.style.width=e+"px",r.style.height=t+"px",this._resizeEvent()}},{key:"getCanvasSize",value:function(){return cc.size(cc.game.canvas.width,cc.game.canvas.height)}},{key:"getFrameSize",value:function(){return cc.size(this._frameSize.width,this._frameSize.height)}},{key:"setFrameSize",value:function(e,t){this._frameSize.width=e,this._frameSize.height=t,cc.frame.style.width=e+"px",cc.frame.style.height=t+"px",this._resizeEvent()}},{key:"getVisibleSize",value:function(){return cc.size(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return cc.size(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return cc.v2(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return cc.v2(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"setResolutionPolicy",value:function(e){var t=this;if(e instanceof ResolutionPolicy)t._resolutionPolicy=e;else{var i=ResolutionPolicy;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}}},{key:"setDesignResolutionSize",value:function(e,t,i){if(0<e||0<t){this.setResolutionPolicy(i);var r=this._resolutionPolicy;if(r&&r.preApply(this),cc.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),r){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var n=r.apply(this,this._designResolutionSize);if(n.scale&&2===n.scale.length&&(this._scaleX=n.scale[0],this._scaleY=n.scale[1]),n.viewport){var s=this._viewportRect,a=this._visibleRect,o=n.viewport;s.x=o.x,s.y=o.y,s.width=o.width,s.height=o.height,a.x=0,a.y=0,a.width=o.width/this._scaleX,a.height=o.height/this._scaleY}r.postApply(this),cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect),this.emit("design-resolution-changed")}else cc.logID(2201)}else cc.logID(2200)}},{key:"getDesignResolutionSize",value:function(){return cc.size(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,i){this.setDesignResolutionSize(e,t,i)}},{key:"setViewportInPoints",value:function(e,t,i,r){var n=this._scaleX,s=this._scaleY;cc.game._renderContext.viewport(e*n+this._viewportRect.x,t*s+this._viewportRect.y,i*n,r*s)}},{key:"setScissorInPoints",value:function(e,t,i,r){var n=this._scaleX,s=this._scaleY,a=Math.ceil(e*n+this._viewportRect.x),o=Math.ceil(t*s+this._viewportRect.y),c=Math.ceil(i*n),l=Math.ceil(r*s),u=cc.game._renderContext;if(!_scissorRect){var h=u.getParameter(u.SCISSOR_BOX);_scissorRect=new Rect(h[0],h[1],h[2],h[3])}_scissorRect.x===a&&_scissorRect.y===o&&_scissorRect.width===c&&_scissorRect.height===l||(_scissorRect.x=a,_scissorRect.y=o,_scissorRect.width=c,_scissorRect.height=l,u.scissor(a,o,c,l))}},{key:"isScissorEnabled",value:function(){var e=cc.game._renderContext;return e.isEnabled(e.SCISSOR_TEST)}},{key:"getScissorRect",value:function(){var e=cc.game._renderContext;if(!_scissorRect){var t=e.getParameter(e.SCISSOR_BOX);_scissorRect=new Rect(t[0],t[1],t[2],t[3])}var i=1/this._scaleX,r=1/this._scaleY;return new Rect((_scissorRect.x-this._viewportRect.x)*i,(_scissorRect.y-this._viewportRect.y)*r,_scissorRect.width*i,_scissorRect.height*r)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return this._devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,i,r){var n=r||cc.v2(),s=this._devicePixelRatio*(e-i.left),a=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(n.x=cc.game.canvas.width-a,n.y=s):(n.x=s,n.y=a),n}},{key:"_resizeEvent",value:function(){var e,t=(e=this.setDesignResolutionSize?this:cc.view)._frameSize.width,i=e._frameSize.height,r=e._isRotated;if(cc.sys.isMobile){var n=cc.game.container.style,s=n.margin;n.margin="0",n.display="none",e._initFrameSize(),n.margin=s,n.display="block"}else e._initFrameSize();if(e._orientationChanging||e._isRotated!==r||e._frameSize.width!==t||e._frameSize.height!==i){var a=e._originalDesignResolutionSize.width,o=e._originalDesignResolutionSize.height;e._resizing=!0,0<a&&e.setDesignResolutionSize(a,o,e._resolutionPolicy),e._resizing=!1,e._resizeCallback&&e._resizeCallback.call()}}},{key:"_orientationChange",value:function(){cc.view._orientationChanging=!0,cc.view._resizeEvent()}},{key:"_initFrameSize",value:function(){var e=this._frameSize,t=__BrowserGetter.availWidth(cc.game.frame),i=__BrowserGetter.availHeight(cc.game.frame),r=i<=t;!cc.sys.isMobile||r&&this._orientation&cc.macro.ORIENTATION_LANDSCAPE||!r&&this._orientation&cc.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,cc.game.container.style["-webkit-transform"]="rotate(0deg)",cc.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,cc.game.container.style["-webkit-transform"]="rotate(90deg)",cc.game.container.style.transform="rotate(90deg)",cc.game.container.style["-webkit-transform-origin"]="0px 0px 0px",cc.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,cc.game.canvas.style["-webkit-transform"]="translateZ(0px)",cc.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout(function(){cc.view._orientationChanging=!1},1e3)}},{key:"_adjustSizeKeepCanvasSize",value:function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;0<e&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)}},{key:"_setViewportMeta",value:function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var r,n,s,a=document.getElementsByName("viewport"),o=a?a[0]:null;for(n in r=o?o.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===r.indexOf(n)?r+=","+n+"="+e[n]:t&&(s=new RegExp(n+"s*=s*[^,]+"),r.replace(s,n+"="+e[n]));/^,/.test(r)&&(r=r.substr(1)),i.content=r,o&&(o.content=r),document.head.appendChild(i)}},{key:"_adjustViewportMeta",value:function(){this._isAdjustViewport,0}},{key:"_convertMouseToLocation",value:function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y)}},{key:"_convertPointWithScale",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_convertTouchWidthScale",value:function(e){var t=this._viewportRect,i=this._scaleX,r=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/r,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/r}},{key:"_convertTouchesWithScale",value:function(e){for(var t,i,r=this._viewportRect,n=this._scaleX,s=this._scaleY,a=0;a<e.length;a++){var o=e[a];t=o._point,i=o._prevPoint,t.x=(t.x-r.x)/n,t.y=(t.y-r.y)/s,i.x=(i.x-r.x)/n,i.y=(i.y-r.y)/s}}}]),r}();View.instance=void 0;var ContainerStrategy=function(){function e(){_classCallCheck(this,e),this.name="ContainerStrategy"}return _createClass(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){}},{key:"postApply",value:function(e){}},{key:"_setupContainer",value:function(e,t,i){var r=cc.game.canvas,n=cc.game.container;cc.sys.platform!==cc.sys.WECHAT_GAME&&(cc.sys.os===cc.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),n.style.width=r.style.width=t+"px",n.style.height=r.style.height=i+"px");var s=e._devicePixelRatio=1;e.isRetinaEnabled()&&(s=e._devicePixelRatio=Math.min(2,window.devicePixelRatio||1)),r.width=t*s,r.height=i*s}},{key:"_fixContainer",value:function(){document.body.insertBefore(cc.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=cc.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}]),e}();ContainerStrategy.EQUAL_TO_FRAME=void 0,ContainerStrategy.PROPORTION_TO_FRAME=void 0;var ContentStrategy=function(){function e(){_classCallCheck(this,e),this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}return _createClass(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){return{scale:[1,1]}}},{key:"postApply",value:function(e){}},{key:"_buildResult",value:function(e,t,i,r,n,s){Math.abs(e-i)<2&&(i=e),Math.abs(t-r)<2&&(r=t);var a=new Rect(Math.round((e-i)/2),Math.round((t-r)/2),i,r);return this._result.scale=[n,s],this._result.viewport=a,this._result}}]),e}();ContentStrategy.EXACT_FIT=void 0,ContentStrategy.SHOW_ALL=void 0,ContentStrategy.NO_BORDER=void 0,ContentStrategy.FIXED_HEIGHT=void 0,ContentStrategy.FIXED_WIDTH=void 0,function(){var e=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r)))).name="EqualToFrame",t}return _inherits(s,ContainerStrategy),_createClass(s,[{key:"apply",value:function(e){var t=e._frameSize.height,i=cc.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"}}]),s}(),t=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r)))).name="ProportionalToFrame",t}return _inherits(s,ContainerStrategy),_createClass(s,[{key:"apply",value:function(e,t){var i,r,n=e._frameSize.width,s=e._frameSize.height,a=cc.game.container.style,o=t.width,c=t.height,l=n/o,u=s/c;r=l<u?(i=n,c*l):(i=o*u,s);var h=Math.round((n-i)/2),_=Math.round((s-r)/2);i=n-2*h,r=s-2*_,this._setupContainer(e,i,r),e._isRotated?a.margin="0 0 0 "+s+"px":a.margin="0px",a.paddingLeft=h+"px",a.paddingRight=h+"px",a.paddingTop=_+"px",a.paddingBottom=_+"px"}}]),s}();ContainerStrategy.EQUAL_TO_FRAME=new e,ContainerStrategy.PROPORTION_TO_FRAME=new t;var i=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r)))).name="ExactFit",t}return _inherits(s,ContentStrategy),_createClass(s,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,r=cc.game.canvas.height,n=i/t.width,s=r/t.height;return this._buildResult(i,r,i,r,n,s)}}]),s}(),r=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r)))).name="ShowAll",t}return _inherits(s,ContentStrategy),_createClass(s,[{key:"apply",value:function(e,t){var i,r,n=cc.game.canvas.width,s=cc.game.canvas.height,a=t.width,o=t.height,c=n/a,l=s/o,u=0;return r=c<l?(i=n,o*(u=c)):(i=a*(u=l),s),this._buildResult(n,s,i,r,u,u)}}]),s}(),n=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r)))).name="NoBorder",t}return _inherits(s,ContentStrategy),_createClass(s,[{key:"apply",value:function(e,t){var i,r,n,s=cc.game.canvas.width,a=cc.game.canvas.height,o=t.width,c=t.height,l=s/o,u=a/c;return n=l<u?(r=o*(i=u),a):(r=s,c*(i=l)),this._buildResult(s,a,r,n,i,i)}}]),s}(),s=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r)))).name="FixedHeight",t}return _inherits(s,ContentStrategy),_createClass(s,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,r=cc.game.canvas.height,n=r/t.height,s=i,a=r;return this._buildResult(i,r,s,a,n,n)}}]),s}(),a=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r)))).name="FixedWidth",t}return _inherits(s,ContentStrategy),_createClass(s,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,r=cc.game.canvas.height,n=i/t.width,s=i,a=r;return this._buildResult(i,r,s,a,n,n)}}]),s}();ContentStrategy.EXACT_FIT=new i,ContentStrategy.SHOW_ALL=new r,ContentStrategy.NO_BORDER=new n,ContentStrategy.FIXED_HEIGHT=new s,ContentStrategy.FIXED_WIDTH=new a}();var ResolutionPolicy=function(){function i(e,t){_classCallCheck(this,i),this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}return _createClass(i,[{key:"preApply",value:function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof ContainerStrategy&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof ContentStrategy&&(this._contentStrategy=e)}},{key:"canvasSize",get:function(){return cc.v2(cc.game.canvas.width,cc.game.canvas.height)}}]),i}();ResolutionPolicy.EXACT_FIT=void 0,ResolutionPolicy.SHOW_ALL=void 0,ResolutionPolicy.NO_BORDER=void 0,ResolutionPolicy.FIXED_HEIGHT=void 0,ResolutionPolicy.FIXED_WIDTH=void 0,ResolutionPolicy.UNKNOWN=void 0,ResolutionPolicy.ContainerStrategy=void 0,ResolutionPolicy.ContentStrategy=void 0,ResolutionPolicy.EXACT_FIT=0,ResolutionPolicy.NO_BORDER=1,ResolutionPolicy.SHOW_ALL=2,ResolutionPolicy.FIXED_HEIGHT=3,ResolutionPolicy.FIXED_WIDTH=4,ResolutionPolicy.UNKNOWN=5,ResolutionPolicy.ContainerStrategy=ContainerStrategy,ResolutionPolicy.ContentStrategy=ContentStrategy,cc.ResolutionPolicy=ResolutionPolicy;var view=View.instance=cc.view=new View;cc.winSize=cc.v2();var _vec2=new Vec2,Touch=function(){function r(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;_classCallCheck(this,r),this._point=new Vec2,this._prevPoint=new Vec2,this._lastModified=0,this._id=null,this._startPoint=new Vec2,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}return _createClass(r,[{key:"getLocation",value:function(e){return(e=e||new Vec2).set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return(e=e||new Vec2).set(this._point.x,this._point.y),cc.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._point.x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._point.y-e.y)/cc.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return(e=e||new Vec2).set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return(e=e||new Vec2).set(this._prevPoint.x,this._prevPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return(e=e||new Vec2).set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return(e=e||new Vec2).set(this._startPoint.x,this._startPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return(e=e||new Vec2).set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e=e||new Vec2,_vec2.set(this._point),_vec2.subtract(this._prevPoint),e.set(cc.view.getScaleX(),cc.view.getScaleY()),Vec2.divide(e,_vec2,e),e}},{key:"getLocationInView",value:function(e){return(e=e||new Vec2).set(this._point.x,cc.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return(e=e||new Vec2).set(this._prevPoint.x,cc.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return(e=e||new Vec2).set(this._startPoint.x,cc.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(e,t,i){var r=0<arguments.length&&void 0!==e?e:null,n=1<arguments.length?t:void 0,s=2<arguments.length?i:void 0;this._prevPoint=this._point,this._point=new Vec2(n||0,s||0),this._id=r,this._startPointCaptured||(this._startPoint=new Vec2(this._point),this._startPointCaptured=!0)}},{key:"_setPoint",value:function(e,t){"object"===_typeof(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0)}},{key:"_setPrevPoint",value:function(e,t){"object"===_typeof(e)?this._prevPoint=new Vec2(e.x,e.y):this._prevPoint=new Vec2(e||0,t||0)}}]),r}();cc.Touch=Touch;var _didAccelerateFun,TOUCH_TIMEOUT=macro.TOUCH_TIMEOUT,LANDSCAPE_LEFT=-90,PORTRAIT_UPSIDE_DOWN=180,LANDSCAPE_RIGHT=90,_vec2$1=new Vec2,_preLocation=new Vec2,Acceleration$1=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=i,this.z=r,this.timestamp=n},InputManager=function(){function e(){_classCallCheck(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new Vec2,this._prevMousePoint=new Vec2,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._minus=0,this._pointLocked=!1}return _createClass(e,[{key:"handleTouchesBegin",value:function(e){for(var t=[],i=this._touchesIntegerDict,r=sys.now(),n=0;n<e.length;++n){var s=e[n],a=s.getID();if(null!==a)if(void 0===i[a]){var o=this._getUnUsedIndex();if(-1===o){cc.logID(2300,o);continue}var c=new Touch(s._point.x,s._point.y,s.getID());(this._touches[o]=c)._lastModified=r,c._setPrevPoint(s._prevPoint),i[a]=o,t.push(c)}}if(0<t.length){var l=new EventTouch(t);l._eventCode=EventTouch.BEGAN,eventManager.dispatchEvent(l)}}},{key:"handleTouchesMove",value:function(e){for(var t=[],i=this._touches,r=sys.now(),n=0;n<e.length;++n){var s=e[n],a=s.getID();if(null!==a){var o=this._touchesIntegerDict[a];void 0!==o&&i[o]&&(i[o]._setPoint(s._point),i[o]._setPrevPoint(s._prevPoint),i[o]._lastModified=r,t.push(i[o]))}}if(0<t.length){var c=new EventTouch(t);c._eventCode=EventTouch.MOVED,eventManager.dispatchEvent(c)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new EventTouch(t);i._eventCode=EventTouch.ENDED,eventManager.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new EventTouch(t);i._eventCode=EventTouch.CANCELLED,eventManager.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){for(var t=[],i=this._touches,r=this._touchesIntegerDict,n=0;n<e.length;++n){var s=e[n],a=s.getID();if(null!==a){var o=r[a];void 0!==o&&i[o]&&(i[o]._setPoint(s._point),i[o]._setPrevPoint(s._prevPoint),t.push(i[o]),this._removeUsedIndexBit(o),delete r[a])}}return t}},{key:"getHTMLElementPosition",value:function(e){if(sys.platform===sys.WECHAT_GAME)return{left:0,top:0,width:window.innerWidth,height:window.innerHeight};var t=document.documentElement,i=window.pageXOffset-t.clientLeft,r=window.pageYOffset-t.clientTop;if(e.getBoundingClientRect){var n=e.getBoundingClientRect();return{left:n.left+i,top:n.top+r,width:n.width,height:n.height}}return e instanceof HTMLCanvasElement?{left:i,top:r,width:e.width,height:e.height}:{left:i,top:r,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,i=this._preTouchPool,r=e.getID(),n=i.length-1;0<=n;n--)if(i[n].getID()===r){t=i[n];break}return t=t||e}},{key:"setPreTouch",value:function(e){for(var t=!1,i=this._preTouchPool,r=e.getID(),n=i.length-1;0<=n;n--)if(i[n].getID()===r){i[n]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,i,r){var n=this._preTouchPoint,s=this._glView.convertToLocationInView(t,i,r);this._pointLocked&&(s.x=n.x+e.movementX,s.y=n.y-e.movementY);var a=new Touch(s.x,s.y,0);return a._setPrevPoint(n.x,n.y),n.x=s.x,n.y=s.y,a}},{key:"getMouseEvent",value:function(e,t,i){var r=this._prevMousePoint,n=new EventMouse(i);return n._setPrevCursor(r.x,r.y),r.x=e.x,r.y=e.y,this._glView._convertMouseToLocation(r,t),n.setLocation(r.x,r.y),n}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(sys.platform===sys.WECHAT_GAME?(t.left=0,t.top=0):(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop),{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var i=[],r=this._glView,n=this._preTouchPoint,s=e.changedTouches.length,a=0;a<s;a++){var o=e.changedTouches[a];if(o){var c=void 0;c=sys.BROWSER_TYPE_FIREFOX===sys.browserType?r.convertToLocationInView(o.pageX,o.pageY,t,_vec2$1):r.convertToLocationInView(o.clientX,o.clientY,t,_vec2$1);var l=void 0;null!=o.identifier?(l=new Touch(c.x,c.y,o.identifier),this.getPreTouch(l).getLocation(_preLocation),l._setPrevPoint(_preLocation.x,_preLocation.y),this.setPreTouch(l)):(l=new Touch(c.x,c.y))._setPrevPoint(n.x,n.y),n.x=c.x,n.y=c.y,i.push(l)}}return i}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent&&e){this._glView=cc.view;var t=sys.isMobile,i="mouse"in sys.capabilities,r="touches"in sys.capabilities;sys.platform===sys.WECHAT_GAME&&(i=!(r=!(t=!1))),i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),r&&this._registerTouchEvents(e),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=cc.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,i=0,r=0,n=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var s=e.accelerationIncludingGravity;s&&(i=this._accelMinus*(s.x||0)*.1,r=this._accelMinus*(s.y||0)*.1,n=.1*(s.z||0))}else{var a=e;i=(a.gamma||0)/90*.981,r=-(a.beta||0)/90*.981,n=(a.alpha||0)/90*.981}if(cc.view._isRotated){var o=i;i=-r,r=o}t.x=i,t.y=r,t.z=n,t.timestamp=e.timeStamp||Date.now();var c=t.x;window.orientation===LANDSCAPE_RIGHT?(t.x=-t.y,t.y=c):window.orientation===LANDSCAPE_LEFT?(t.x=t.y,t.y=-c):window.orientation===PORTRAIT_UPSIDE_DOWN&&(t.x=-t.x,t.y=-t.y),cc.sys.os===cc.sys.OS_ANDROID&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,eventManager.dispatchEvent(new EventAcceleration(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=cc.sys.now(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var r=this._touches[i];if(t-r._lastModified>TOUCH_TIMEOUT){this._removeUsedIndexBit(i);var n=r.getID();return null!==n&&delete this._touchesIntegerDict[n],i}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){function e(){var e=cc.game.canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1}var t=this;"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)}},{key:"_registerWindowMouseEvents",value:function(n){var s=this;window.addEventListener("mousedown",function(){s._mousePressed=!0},!1),window.addEventListener("mouseup",function(e){if(s._mousePressed){s._mousePressed=!1;var t=s.getHTMLElementPosition(n),i=s.getPointByEvent(e,t);if(!rect(t.left,t.top,t.width,t.height).contains(new Vec2(i.x,i.y))){s.handleTouchesEnd([s.getTouchByXY(e,i.x,i.y,t)]);var r=s.getMouseEvent(i,t,EventMouse.UP);r.setButton(e.button),eventManager.dispatchEvent(r)}}},!1)}},{key:"_registerElementMouseEvents",value:function(a,e){function t(e,n,s){a.addEventListener(e,function(e){var t=o.getHTMLElementPosition(a),i=o.getPointByEvent(e,t),r=o.getMouseEvent(i,t,n);r.setButton(e.button),s(e,r,i,t),eventManager.dispatchEvent(r),e.stopPropagation(),e.preventDefault()})}var o=this;e||(t("mousedown",EventMouse.DOWN,function(e,t,i,r){o._mousePressed=!0,o.handleTouchesBegin([o.getTouchByXY(e,i.x,i.y,r)]),a.focus()}),t("mouseup",EventMouse.UP,function(e,t,i,r){o._mousePressed=!1,o.handleTouchesEnd([o.getTouchByXY(e,i.x,i.y,r)])}),t("mousemove",EventMouse.MOVE,function(e,t,i,r){o.handleTouchesMove([o.getTouchByXY(e,i.x,i.y,r)]),o._mousePressed||t.setButton(null),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)})),t("mousewheel",EventMouse.SCROLL,function(e,t,i,r){t.setScrollData(0,e.wheelDelta)}),t("DOMMouseScroll",EventMouse.SCROLL,function(e,t,i,r){t.setScrollData(0,-120*e.detail)})}},{key:"_registerMousePointerEvents",value:function(r){function e(e){var i=t[e];r.addEventListener(e,function(e){var t=n.getHTMLElementPosition(r);t.left-=document.documentElement.scrollLeft,t.top-=document.documentElement.scrollTop,i.call(n,[n.getTouchByXY(e,e.clientX,e.clientY,t)]),e.stopPropagation()},!1)}var n=this,t={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel};for(var i in t)e(i)}},{key:"_registerTouchEvents",value:function(e){cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?this._registerWXGameTouchEvents(e):this._registerHTMLTouchEvents(e)}},{key:"_registerWXGameTouchEvents",value:function(n){function e(r){return function(e){var t=s.getHTMLElementPosition(n),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,r(s.getTouchesByEvent(e,t))}}var s=this;wx.onTouchStart(e(function(e){s.handleTouchesBegin(e)})),wx.onTouchEnd(e(function(e){s.handleTouchesEnd(e)})),wx.onTouchMove(e(function(e){s.handleTouchesMove(e)})),wx.onTouchCancel(e(function(e){s.handleTouchesCancel(e)}))}},{key:"_registerHTMLTouchEvents",value:function(n){function e(r){return function(e){if(e.changedTouches){var t=s.getHTMLElementPosition(n),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,r(s.getTouchesByEvent(e,t)),e.stopPropagation(),e.preventDefault()}}}var s=this;n.addEventListener("touchstart",e(function(e){s.handleTouchesBegin(e),sys.platform!==sys.WECHAT_GAME&&n.focus()}),!1),n.addEventListener("touchmove",e(function(e){s.handleTouchesMove(e)}),!1),n.addEventListener("touchend",e(function(e){s.handleTouchesEnd(e)}),!1),n.addEventListener("touchcancel",e(function(e){s.handleTouchesCancel(e)}),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=cc.game.canvas;e.addEventListener("keydown",function(e){eventManager.dispatchEvent(new EventKeyboard(e,!0)),e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("keyup",function(e){eventManager.dispatchEvent(new EventKeyboard(e,!1)),e.stopPropagation(),e.preventDefault()},!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new Acceleration$1,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,cc.sys.browserType===cc.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation",i=navigator.userAgent;(/Android/.test(i)||/Adr/.test(i)&&cc.sys.browserType===cc.BROWSER_TYPE_UC)&&(this._minus=-1),_didAccelerateFun=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,_didAccelerateFun,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";_didAccelerateFun&&window.removeEventListener(e,_didAccelerateFun,!1)}}]),e}(),inputManager=new InputManager;game.on(Game.EVENT_ENGINE_INITED,function(){game.config.registerSystemEvent&&inputManager.registerSystemEvent(game.canvas)}),cc.internal.inputManager=inputManager;var keyboardListener=null,accelerationListener=null,touchListener=null,mouseListener=null,SystemEvent=function(){function p(){return _classCallCheck(this,p),_possibleConstructorReturn(this,_getPrototypeOf(p).call(this))}return _inherits(p,EventTarget),_createClass(p,[{key:"setAccelerometerEnabled",value:function(e){inputManager.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){inputManager.setAccelerometerInterval(e)}},{key:"on",value:function(e,t,i){return _get(_getPrototypeOf(p.prototype),"on",this).call(this,e,t,i),e!==exports.SystemEventType.KEY_DOWN&&e!==exports.SystemEventType.KEY_UP||keyboardListener||(keyboardListener=EventListener.create({event:EventListener.KEYBOARD,onKeyPressed:function(e,t){t.type=exports.SystemEventType.KEY_DOWN,systemEvent.emit(t.type,t)},onKeyReleased:function(e,t){t.type=exports.SystemEventType.KEY_UP,systemEvent.emit(t.type,t)}}),eventManager.addListener(keyboardListener,256)),e===exports.SystemEventType.DEVICEMOTION&&(accelerationListener||(accelerationListener=EventListener.create({event:EventListener.ACCELERATION,callback:function(e,t){t.type=exports.SystemEventType.DEVICEMOTION,cc.systemEvent.emit(t.type,t)}}),eventManager.addListener(accelerationListener,256))),e!==exports.SystemEventType.TOUCH_START&&e!==exports.SystemEventType.TOUCH_MOVE&&e!==exports.SystemEventType.TOUCH_END&&e!==exports.SystemEventType.TOUCH_CANCEL||touchListener||(touchListener=EventListener.create({event:EventListener.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=exports.SystemEventType.TOUCH_START,cc.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=exports.SystemEventType.TOUCH_MOVE,cc.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=exports.SystemEventType.TOUCH_END,cc.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=exports.SystemEventType.TOUCH_CANCEL,cc.systemEvent.emit(t.type,e,t)}}),eventManager.addListener(touchListener,256)),e!==exports.SystemEventType.MOUSE_DOWN&&e!==exports.SystemEventType.MOUSE_MOVE&&e!==exports.SystemEventType.MOUSE_UP&&e!==exports.SystemEventType.MOUSE_WHEEL||mouseListener||(mouseListener=EventListener.create({event:EventListener.MOUSE,onMouseDown:function(e){e.type=exports.SystemEventType.MOUSE_DOWN,cc.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=exports.SystemEventType.MOUSE_MOVE,cc.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=exports.SystemEventType.MOUSE_UP,cc.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=exports.SystemEventType.MOUSE_WHEEL,cc.systemEvent.emit(e.type,e)}}),eventManager.addListener(mouseListener,256)),t}},{key:"off",value:function(e,t,i){if(_get(_getPrototypeOf(p.prototype),"off",this).call(this,e,t,i),keyboardListener&&(e===exports.SystemEventType.KEY_DOWN||e===exports.SystemEventType.KEY_UP)){var r=this.hasEventListener(exports.SystemEventType.KEY_DOWN),n=this.hasEventListener(exports.SystemEventType.KEY_UP);r||n||(eventManager.removeListener(keyboardListener),keyboardListener=null)}if(accelerationListener&&e===exports.SystemEventType.DEVICEMOTION&&(eventManager.removeListener(accelerationListener),accelerationListener=null),touchListener&&(e===exports.SystemEventType.TOUCH_START||e===exports.SystemEventType.TOUCH_MOVE||e===exports.SystemEventType.TOUCH_END||e===exports.SystemEventType.TOUCH_CANCEL)){var s=this.hasEventListener(exports.SystemEventType.TOUCH_START),a=this.hasEventListener(exports.SystemEventType.TOUCH_MOVE),o=this.hasEventListener(exports.SystemEventType.TOUCH_END),c=this.hasEventListener(exports.SystemEventType.TOUCH_CANCEL);s||a||o||c||(eventManager.removeListener(touchListener),touchListener=null)}if(mouseListener&&(e===exports.SystemEventType.MOUSE_DOWN||e===exports.SystemEventType.MOUSE_MOVE||e===exports.SystemEventType.MOUSE_UP||e===exports.SystemEventType.MOUSE_WHEEL)){var l=this.hasEventListener(exports.SystemEventType.MOUSE_DOWN),u=this.hasEventListener(exports.SystemEventType.MOUSE_MOVE),h=this.hasEventListener(exports.SystemEventType.MOUSE_UP),_=this.hasEventListener(exports.SystemEventType.MOUSE_WHEEL);l||u||h||_||(eventManager.removeListener(mouseListener),mouseListener=null)}}}]),p}();SystemEvent.EventType=exports.SystemEventType;var systemEvent=new(cc.SystemEvent=SystemEvent);cc.systemEvent=systemEvent;var screen$1={_supportsFullScreen:!1,_preOnFullScreenChange:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){this._fn={};var e,t,i,r,n=this._fnMap;for(e=0,t=n.length;e<t;e++)if((i=n[e])&&void 0!==document[i[1]]){for(e=0,r=i.length;e<r;e++)this._fn[n[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},fullScreen:function(){return!!this._supportsFullScreen&&(void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement])},requestFullScreen:function(e,t){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var i=this._fn.fullscreenchange;this._preOnFullScreenChange&&document.removeEventListener(i,this._preOnFullScreenChange),this._preOnFullScreenChange=t,document.addEventListener(i,t,!1)}return e[this._fn.requestFullscreen]()}},exitFullScreen:function(){return!this._supportsFullScreen||document[this._fn.exitFullscreen]()},autoFullScreen:function(t,i){t=t||document.body;var r=cc.game.canvas||t,n=this;this.requestFullScreen(t,i),r.addEventListener(this._touchEvent,function e(){r.removeEventListener(n._touchEvent,e),n.requestFullScreen(t,i)})}};function deepFlatten(e,t){var i=t,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;Array.isArray(a)?deepFlatten(e,a):e.push(a)}}function flattenCodeArray(e){var t=[];return deepFlatten(t,e),t.join("")}screen$1.init(),cc.screen=screen$1;var Destroyed$2=CCObject.Flags.Destroyed,PersistentMask$2=CCObject.Flags.PersistentMask,DEFAULT=DELIMETER+"default",IDENTIFIER_RE$1=CCClass.IDENTIFIER_RE,VAR="var ",LOCAL_OBJ="o",LOCAL_TEMP_OBJ="t",LOCAL_ARRAY="a",LINE_INDEX_OF_NEW_OBJ=0,DEFAULT_MODULE_CACHE={"cc.Node":"cc.Node","cc.Sprite":"cc.Sprite","cc.Label":"cc.Label","cc.Button":"cc.Button","cc.Widget":"cc.Widget","cc.Animation":"cc.Animation","cc.ClickEvent":!1,"cc.PrefabInfo":!1},escapeForJS$1=CCClass.escapeForJS,Declaration=function(){function i(e,t){_classCallCheck(this,i),this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return _createClass(i,[{key:"toString",value:function(){return VAR+this.varName+"="+this.expression+";"}}]),i}();function mergeDeclaration(e,t){return t instanceof Declaration?new Declaration(t.varName,e+t.expression):e+t}function writeAssignment(e,t,i){Array.isArray(i)?(i[0]=mergeDeclaration(t,i[0]),e.push(i)):e.push(mergeDeclaration(t,i)+";")}var Assignments=function(){function t(e){_classCallCheck(this,t),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}return _createClass(t,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(1<this._exps.length)e.push(LOCAL_TEMP_OBJ+"="+this._targetExp+";"),t=LOCAL_TEMP_OBJ;else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var r=this._exps[i];writeAssignment(e,t+getPropAccessor(r[0])+"=",r[1])}}}]),t}();function getPropAccessor(e){return IDENTIFIER_RE$1.test(e)?"."+e:"["+escapeForJS$1(e)+"]"}Assignments.pool=void 0,Assignments.pool=new Pool(function(e){e._exps.length=0,e._targetExp=null},1),Assignments.pool.get=function(e){var t=this._get()||new Assignments;return t._targetExp=e,t};var _dec$j,_class$j,_class2$g,_descriptor$e,_descriptor2$a,_descriptor3$7,_class3$b,_temp$i,Parser=function(){function a(e,t){var i;_classCallCheck(this,a),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=createMap(),mixin(this.funcModuleCache,DEFAULT_MODULE_CACHE),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push(VAR+LOCAL_OBJ+","+LOCAL_TEMP_OBJ+";","if(R){",LOCAL_OBJ+"=R;","}else{",LOCAL_OBJ+"=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),0<this.globalVariables.length&&(i=VAR+this.globalVariables.join(",")+";");var r=flattenCodeArray(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",r)(this.objs,this.funcs);for(var n=0,s=this.objsToClear_iN$t.length;n<s;++n)this.objsToClear_iN$t[n]._iN$t=null;this.objsToClear_iN$t.length=0}return _createClass(a,[{key:"getFuncModule",value:function(e,t){var i=getClassName(e);if(i){var r=this.funcModuleCache[i];if(r)return r;if(void 0===r){var n=-1!==i.indexOf(".");if(n)try{if(n=e===Function("return "+i)())return this.funcModuleCache[i]=i}catch(e){}}}var s=this.funcs.indexOf(e);s<0&&(s=this.funcs.length,this.funcs.push(e));var a="F["+s+"]";return t&&(a="("+a+")"),this.funcModuleCache[i]=a}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,i,r){var n=Assignments.pool.get(r),s=t.constructor.__props__;s=s||Object.keys(t);for(var a=0;a<s.length;a++){var o=s[a],c=i[o];if(t[o]!==c){var l=this.enumerateField(i,o,c);n.append(o,l)}}n.writeCode(e),Assignments.pool.put(n)}},{key:"enumerateCCClass",value:function(e,t,i){for(var r=i.__values__,n=getClassAttrs(i),s=0;s<r.length;s++){var a=r[s],o=t[a],c=n[a+DEFAULT];if(!equalsToDefault(c,o))if("object"===_typeof(o)&&o instanceof cc.ValueType&&(c=CCClass.getDefault(c))&&c.constructor===o.constructor){var l=LOCAL_OBJ+getPropAccessor(a);this.setValueType(e,c,o,l)}else this.setObjProp(e,t,a,o)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t=LOCAL_ARRAY+ ++this.localVariableId,i=[new Declaration(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r){writeAssignment(i,t+"["+r+"]=",this.enumerateField(e,r,e[r]))}return i}},{key:"enumerateField",value:function(e,t,i){if("object"===_typeof(i)&&i){var r=i._iN$t;if(r){var n=r.globalVar;if(!n){n=r.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(n);var s=r.source[LINE_INDEX_OF_NEW_OBJ];r.source[LINE_INDEX_OF_NEW_OBJ]=mergeDeclaration(n+"=",s)}return n}return Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?escapeForJS$1(i):("_objFlags"===t&&e instanceof CCObject&&(i&=PersistentMask$2),i)}},{key:"setObjProp",value:function(e,t,i,r){writeAssignment(e,LOCAL_OBJ+getPropAccessor(i)+"=",this.enumerateField(t,i,r))}},{key:"enumerateObject",value:function(e,t){var i=t.constructor;if(cc.Class._isCCClass(i))this.enumerateCCClass(e,t,i);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var n=t[r];"object"===_typeof(n)&&n&&n===t._iN$t||this.setObjProp(e,t,r,n)}}},{key:"instantiateObj",value:function(e){if(e instanceof cc.ValueType)return CCClass.getNewValueTypeCode(e);if(e instanceof cc.Asset)return this.getObjRef(e);if(e._objFlags&Destroyed$2)return null;var t,i=e.constructor;if(cc.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return this.getObjRef(e)}else if(this.parent instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof cc.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new Declaration(LOCAL_OBJ,"new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new Declaration(LOCAL_OBJ,"{}");else{if(i)return this.getObjRef(e);t=new Declaration(LOCAL_OBJ,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]}}]),a}();function equalsToDefault(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof cc.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}function compile(e){var t=e instanceof cc._BaseNode&&e;return new Parser(e,t).result}var _dec$k,_class$k,_class2$h,_descriptor$f,_descriptor2$b,_temp$j,OptimizationPolicy=Enum({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Prefab=(_dec$j=ccclass("cc.Prefab"))((_temp$i=_class3$b=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"data",_descriptor$e,_assertThisInitialized(e)),_initializerDefineProperty(e,"optimizationPolicy",_descriptor2$a,_assertThisInitialized(e)),_initializerDefineProperty(e,"asyncLoadAssets",_descriptor3$7,_assertThisInitialized(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return _inherits(t,Asset),_createClass(t,[{key:"createNode",value:function(e){var t=cc.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){this._createFunction=compile(this.data)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:cc.warnID(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e,t=!1;return t?(e=this._doInstantiate(),this.data._instantiate(e)):(this.data._prefab._synced=!0,e=this.data._instantiate()),++this._instantiatedTimes,e}}]),t}(),_class3$b.OptimizationPolicy=OptimizationPolicy,_class3$b.OptimizationPolicyThreshold=3,_descriptor$e=_applyDecoratedDescriptor((_class2$g=_temp$i).prototype,"data",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$a=_applyDecoratedDescriptor(_class2$g.prototype,"optimizationPolicy",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OptimizationPolicy.AUTO}}),_descriptor3$7=_applyDecoratedDescriptor(_class2$g.prototype,"asyncLoadAssets",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_class$j=_class2$g))||_class$j;cc.Prefab=Prefab,obsolete(cc,"cc._Prefab","Prefab");var _dec$l,_class$l,_class2$i,_descriptor$g,_temp$k,SceneAsset=(_dec$k=ccclass("cc.SceneAsset"))((_descriptor$f=_applyDecoratedDescriptor((_class2$h=_temp$j=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"scene",_descriptor$f,_assertThisInitialized(t)),_initializerDefineProperty(t,"asyncLoadAssets",_descriptor2$b,_assertThisInitialized(t)),t}return _inherits(s,Asset),s}()).prototype,"scene",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$b=_applyDecoratedDescriptor(_class2$h.prototype,"asyncLoadAssets",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_class$k=_class2$h))||_class$k;cc.SceneAsset=SceneAsset;var _dec$m,_class$m,_class2$j,_descriptor$h,_temp$l,SpriteAtlas=(_dec$l=ccclass("cc.SpriteAtlas"))((_descriptor$g=_applyDecoratedDescriptor((_class2$i=_temp$k=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"spriteFrames",_descriptor$g,_assertThisInitialized(t)),t}return _inherits(s,Asset),_createClass(s,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(0<e.length){var t=this.spriteFrames[e[0]];return t&&t._image}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,i=0,r=Object.keys(t);i<r.length;i++){var n=r[i];e.push(t[n])}return e}},{key:"_serialize",value:function(e){for(var t=[],i=0,r=Object.keys(this.spriteFrames);i<r.length;i++){var n=r[i],s=this.spriteFrames[n],a=s?s._uuid:"";a&&e&&(a=Editor.Utils.UuidUtils.compressUuid(a,!0)),t.push(n),t.push(a)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var i=e;this._name=i.name;var r=i.spriteFrames;this.spriteFrames=createMap();for(var n=0;n<r.length;n+=2)t.result.push(this.spriteFrames,r[n],r[n+1])}}]),s}()).prototype,"spriteFrames",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return createMap()}}),_class$l=_class2$i))||_class$l;cc.SpriteAtlas=SpriteAtlas;var _dec$n,_class$n,_class2$k,_descriptor$i,_temp$m,TextAsset=(_dec$m=ccclass("cc.TextAsset"))((_descriptor$h=_applyDecoratedDescriptor((_class2$j=_temp$l=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"text",_descriptor$h,_assertThisInitialized(t)),t}return _inherits(s,Asset),_createClass(s,[{key:"toString",value:function(){return this.text}}]),s}()).prototype,"text",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_class$m=_class2$j))||_class$m;cc.TextAsset=TextAsset;var JsonAsset=(_dec$n=ccclass("cc.JsonAsset"))((_descriptor$i=_applyDecoratedDescriptor((_class2$k=_temp$m=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"json",_descriptor$i,_assertThisInitialized(t)),t}return _inherits(s,Asset),s}()).prototype,"json",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$n=_class2$k))||_class$n;cc.JsonAsset=JsonAsset;var HexChars="0123456789abcdef".split(""),_t=["","","",""],UuidTemplate=_t.concat(_t,"-",_t,"-",_t,"-",_t,"-",_t,_t,_t),Indices=UuidTemplate.map(function(e,t){return"-"===e?NaN:t}).filter(isFinite);function decodeUuid(e){var t=e.split("@")[0];if(22!==t.length)return e;UuidTemplate[0]=e[0],UuidTemplate[1]=e[1];for(var i=2,r=2;i<22;i+=2){var n=BASE64_VALUES[e.charCodeAt(i)],s=BASE64_VALUES[e.charCodeAt(i+1)];UuidTemplate[Indices[r++]]=HexChars[n>>2],UuidTemplate[Indices[r++]]=HexChars[(3&n)<<2|s>>4],UuidTemplate[Indices[r++]]=HexChars[15&s]}return e.replace(t,UuidTemplate.join(""))}var url={_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=cc.loader._getResUuid(e.slice(10),cc.Asset,null,!0);if(t)return cc.AssetLibrary.getLibUrlNoExt(t,!0)+cc.path.extname(e)}else cc.errorID(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=cc.path.stripSep(e)+"/"}};cc.url=url;var Entry=function e(t,i){_classCallCheck(this,e),this.uuid=void 0,this.type=void 0,this.uuid=t,this.type=i};function isMatchByWord(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}var AssetTable=function(){function e(){_classCallCheck(this,e),this._pathToUuid=void 0,this._pathToUuid=createMap(!0)}return _createClass(e,[{key:"getUuid",value:function(e,t){e=url.normalize(e);var i=this._pathToUuid[e];if(i)if(Array.isArray(i)){if(!t)return i[0].uuid;for(var r=0;r<i.length;r++){var n=i[r];if(isChildClassOf(n.type,t))return n.uuid}}else{if(!t||isChildClassOf(i.type,t))return i.uuid}return""}},{key:"getUuidArray",value:function(e,t,i){"/"===(e=url.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var r=this._pathToUuid,n=[];for(var s in r)if(s.startsWith(e)&&isMatchByWord(s,e)||!e){var a=r[s];if(Array.isArray(a))for(var o=0;o<a.length;o++){var c=a[o];(!t||isChildClassOf(c.type,t))&&(n.push(c.uuid),i&&i.push(s))}else(!t||isChildClassOf(a.type,t))&&(n.push(a.uuid),i&&i.push(s))}return n}},{key:"add",value:function(e,t,i,r){r&&(e=e.substring(0,e.length-extname(e).length));var n=new Entry(t,i);pushToMap(this._pathToUuid,e,n,r)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var i=this._pathToUuid,r=Object.keys(i),n=0;n<r.length;++n){var s=r[n],a=i[s];if(Array.isArray(a))for(var o=0;o<a.length;o++){var c=a[o];if(c.uuid===e)return t.path=s,t.type=c.type,!0}else if(a.uuid===e)return t.path=s,t.type=a.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=createMap(!0)}}]),e}();function parseDepends(e,t){var i=cc.loader.getItem(e);if(i){var r=i.dependKeys;if(r)for(var n=0;n<r.length;n++){var s=r[n];t[s]||(t[s]=!0,parseDepends(s,t))}}}function visitAsset(e,t){if(e._uuid){var i=cc.loader._getReferenceKey(e);t[i]||(t[i]=!0,parseDepends(i,t))}}function visitComponent(e,t){for(var i=Object.getOwnPropertyNames(e),r=0;r<i.length;r++){var n=e[i[r]];if("object"===_typeof(n)&&n)if(Array.isArray(n))for(var s=0;s<n.length;s++){var a=n[s];a instanceof RawAsset&&visitAsset(a,t)}else if(n.constructor&&n.constructor!==Object)n instanceof RawAsset&&visitAsset(n,t);else for(var o=Object.getOwnPropertyNames(n),c=0;c<o.length;c++){var l=n[o[c]];l instanceof RawAsset&&visitAsset(l,t)}}}function visitNode(e,t){for(var i=0;i<e._components.length;i++)visitComponent(e._components[i],t);for(var r=0;r<e._children.length;r++)visitNode(e._children[r],t)}function autoRelease(e,t,i){var r=cc.loader._autoReleaseSetting,n=createMap();if(t)for(var s=0;s<t.length;s++)n[t[s]]=!0;for(var a=0;a<i.length;a++)visitNode(i[a],n);if(e)for(var o=0;o<e.length;o++){var c=e[o];!1===r[c]||n[c]||cc.loader.release(c)}for(var l=Object.keys(r),u=0;u<l.length;u++){var h=l[u];!0!==r[h]||n[h]||cc.loader.release(h)}}function getDependsRecursively(e){var t={};return parseDepends(e,t),Object.keys(t)}var ItemState,_qid=0|998*Math.random(),_queues=createMap(!0),_pool=[],_POOL_MAX_LENGTH=10;!function(e){e[e.WORKING=0]="WORKING",e[e.COMPLETE=1]="COMPLETE",e[e.ERROR=2]="ERROR"}(ItemState=ItemState||{});var _queueDeps=createMap(!0);function isIdValid(e){return"string"==typeof(e.url||e)}function _parseUrlParam(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var i={};return t[1].split("&").forEach(function(e){var t=e.split("=");i[t[0]]=t[1]}),i}}}function createItem(t,e){var i="object"===_typeof(t)?t.url:t,r={queueId:e,id:i,url:i,rawUrl:void 0,urlParam:_parseUrlParam(i),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:t.uuid&&cc.game._sceneInfos.find(function(e){return e.uuid===t.uuid})};if("object"===_typeof(t)&&(mixin(r,t),t.skips))for(var n=0;n<t.skips.length;n++){var s=t.skips[n];r.states[s]=ItemState.COMPLETE}return r.rawUrl=r.url,i&&!r.type&&(r.type=extname(i).toLowerCase().substr(1)),r}var _checkedIds=[];function checkCircleReference(e,t,i){if(!e||!t)return!1;var r=!1;if(_checkedIds.push(t.id),t.deps){var n,s,a=t.deps;for(n=0;n<a.length;n++){if((s=a[n]).id===e.id){r=!0;break}if(!(0<=_checkedIds.indexOf(s.id))&&(s.deps&&checkCircleReference(e,s,!0))){r=!0;break}}}return i||(_checkedIds.length=0),r}var LoadingItems=function(){function c(e,t,i,r){var n;return _classCallCheck(this,c),(n=_possibleConstructorReturn(this,_getPrototypeOf(c).call(this))).onProgress=void 0,n.onComplete=void 0,n.map=createMap(!0),n.completed={},n.totalCount=0,n.completedCount=0,n.active=void 0,n._id=void 0,n._pipeline=void 0,n._errorUrls=[],n._appending=!1,n._ownerQueue=null,n._id=++_qid,_queues[n._id]=_assertThisInitialized(n),n._pipeline=e,n.onProgress=i,n.onComplete=r,n._pipeline?n.active=!0:n.active=!1,t&&(0<t.length?n.append(t):n.allComplete()),n}return _inherits(c,CallbacksInvoker),_createClass(c,[{key:"append",value:function(e,i){var r=this;if(!this.active)return[];i&&!i.deps&&(i.deps=[]),this._appending=!0;var t,n,s,a=[];for(t=0;t<e.length;++t){if((n=e[t]).queueId&&!this.map[n.id]){if(this.map[n.id]=n,i&&i.deps.push(n),n.complete||checkCircleReference(i,n)){this.totalCount++,this.itemComplete(n.id);continue}if("continue"===function(){var t=r,e=_queues[n.queueId];return e&&(r.totalCount++,c.registerQueueDep(i||r._id,n.id),e.addListener(n.id,function(e){t.itemComplete(e.id)})),"continue"}())continue}if(isIdValid(n)){var o=(s=createItem(n,this._id)).id;this.map[o]||(this.map[o]=s,this.totalCount++,i&&i.deps.push(s),c.registerQueueDep(i||this._id,o),a.push(s))}}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(a),a}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=_queueDeps[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],i=null;return t&&(t.content?i=t.content:t.alias&&(i=t.alias.content)),i}},{key:"getError",value:function(e){var t=this.map[e],i=null;return t&&(t.error?i=t.error:t.alias&&(i=t.alias.error)),i}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var t=this.map[e];if(t){var i=this._errorUrls.indexOf(e);if(t.error&&-1===i?this._errorUrls.push(e):t.error||-1===i||this._errorUrls.splice(i,1),this.completed[e]=t,this.completedCount++,c.finishDep(t.id),this.onProgress){var r=_queueDeps[this._id];this.onProgress(r?r.completed.length:this.completedCount,r?r.deps.length:this.totalCount,t)}this.emit(e,t),this.removeAll(e),!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=void 0,this.onComplete=void 0,this.map=createMap(!0),this.completed={},this.totalCount=0,this.completedCount=0,CallbacksInvoker.call(this),_queues[this._id]=null,_queueDeps[this._id]&&(_queueDeps[this._id].completed.length=0,_queueDeps[this._id].deps.length=0),-1===_pool.indexOf(this)&&_pool.length<_POOL_MAX_LENGTH&&_pool.push(this)}},{key:"addListener",value:function(e,t,i){return _get(_getPrototypeOf(c.prototype),"on",this).call(this,e,t,i)}},{key:"hasListener",value:function(e,t,i){return _get(_getPrototypeOf(c.prototype),"hasEventListener",this).call(this,e,t,i)}},{key:"removeListener",value:function(e,t,i){return _get(_getPrototypeOf(c.prototype),"off",this).call(this,e,t,i)}},{key:"removeAllListeners",value:function(e){_get(_getPrototypeOf(c.prototype),"removeAll",this).call(this,e)}}],[{key:"create",value:function(e,t,i,r){void 0===i?"function"==typeof t&&(r=t,t=i=null):void 0===r&&("function"==typeof t?(r=i,i=t,t=null):(r=i,i=null));var n=_pool.pop();return n?(n._pipeline=e,n.onProgress=i,n.onComplete=r,(_queues[n._id]=n)._pipeline&&(n.active=!0),t&&n.append(t)):n=new c(e,t,i,r),n}},{key:"getQueue",value:function(e){return e.queueId?_queues[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=_queues[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=_queueDeps[e._id];t?(t.completed.length=0,t.deps.length=0):t=_queueDeps[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var i=e.queueId||e;if(!i)return!1;var r=_queueDeps[i];if(r)-1===r.deps.indexOf(t)&&r.deps.push(t);else if(e.id)for(var n in _queueDeps){var s=_queueDeps[n];-1!==s.deps.indexOf(e.id)&&-1===s.deps.indexOf(t)&&s.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in _queueDeps){var i=_queueDeps[t];-1!==i.deps.indexOf(e)&&-1===i.completed.indexOf(e)&&i.completed.push(e)}}}]),c}();LoadingItems.ItemState=new cc.Enum(ItemState);var ItemState$1=(cc.LoadingItems=LoadingItems).ItemState;function flow(e,i){var r=e.id,t=i.states[r],n=e.next,s=e.pipeline;if(!i.error&&t!==ItemState$1.WORKING&&t!==ItemState$1.ERROR)if(t===ItemState$1.COMPLETE)n?flow(n,i):s.flowOut(i);else{i.states[r]=ItemState$1.WORKING;var a=e.handle(i,function(e,t){e?(i.error=e,i.states[r]=ItemState$1.ERROR,s.flowOut(i)):(t&&(i.content=t),i.states[r]=ItemState$1.COMPLETE,n?flow(n,i):s.flowOut(i))});a instanceof Error?(i.error=a,i.states[r]=ItemState$1.ERROR,s.flowOut(i)):void 0!==a&&(null!==a&&(i.content=a),i.states[r]=ItemState$1.COMPLETE,n?flow(n,i):s.flowOut(i))}}var Pipeline=function(){function r(e){_classCallCheck(this,r),this._pipes=void 0,this._cache=createMap(!0),this._pipes=e;for(var t=0;t<e.length;++t){var i=e[t];i.handle&&i.id&&(i.pipeline=this,i.next=t<e.length-1?e[t+1]:null)}}return _createClass(r,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)cc.warnID(4921);else if(0<this._pipes.indexOf(e))cc.warnID(4922);else{var i=null;t<(e.pipeline=this)._pipes.length&&(i=this._pipes[t]);var r=null;0<t&&(r=this._pipes[t-1]),r&&(r.next=e),e.next=i,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var i=this._pipes.indexOf(e);i<0||this.insertPipe(t,i+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,0<this._pipes.length&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,i,r=this._pipes[0];if(r){for(t=0;t<e.length;t++)(i=e[t]).isScene||(this._cache[i.id]=i);for(t=0;t<e.length;t++)flow(r,i=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,i){return LoadingItems.create(this,function(e,t){i(e,t),t.destroy()}).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,LoadingItems.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var i=0;i<t.length;++i)t[i].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t&&t.alias&&(t=t.alias),t}},{key:"removeItem",value:function(e){var t=this._cache[e];t&&t.complete&&delete this._cache[e];return t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),r}();Pipeline.ItemState=ItemState$1,cc.Pipeline=Pipeline;var ID="MD5Pipe",ExtnameRegex=/(\.[^.\n\\/]*)$/,UuidRegex=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function getUuidFromURL(e){var t=e.match(UuidRegex);return t?t[1]:""}var MD5Pipe=function(){function r(e,t,i){_classCallCheck(this,r),this.id=ID,this.async=!1,this.pipeline=null,this.md5AssetsMap=void 0,this.md5NativeAssetsMap=void 0,this.libraryBase=void 0,this.id=ID,this.async=!1,this.pipeline=null,this.md5AssetsMap=e,this.md5NativeAssetsMap=t,this.libraryBase=i}return _createClass(r,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var i=getUuidFromURL(e);if(i){var r=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[i];if(r)if(t){var n=cc.path.dirname(e),s=cc.path.basename(e);e="".concat(n,".").concat(r,"/").concat(s)}else{var a=!1;e=e.replace(ExtnameRegex,function(e,t){return a=!0,"."+r+t}),a||(e=e+"."+r)}}return e}}]),r}();MD5Pipe.ID=ID,Pipeline.MD5Pipe=MD5Pipe;var PackState,JsonUnpacker=function(){function e(){_classCallCheck(this,e),this.jsons={}}return _createClass(e,[{key:"load",value:function(e,t){t.length!==e.length&&cc.errorID(4915);for(var i=0;i<e.length;i++){var r=e[i],n=t[i];this.jsons[r]=n}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),TextureUnpacker=function(){function e(){_classCallCheck(this,e),this.contents={}}return _createClass(e,[{key:"load",value:function(e,t){var i=t.data;i.length!==e.length&&cc.errorID(4915);for(var r=0;r<e.length;r++)this.contents[e[r]]={base:i[r][0],mipmaps:i[r][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:cc.js._getClassId(cc.Texture2D),content:t}:null}}]),e}(),_noCacheRex=/\?/;function urlAppendTimestamp(e){return cc.game.config.noCache&&"string"==typeof e&&(_noCacheRex.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function decompressJson(e,t){if(Array.isArray(e))for(var i=0,r=e.length;i<r;i++)decompressJson(e[i],t);else if("object"===_typeof(e))for(var n in e)decompressJson(e[n],t),Number.isNaN(Number(n))||(e[t[n]]=e[n],delete e[n]);return null}!function(e){e[e.Invalid=0]="Invalid",e[e.Removed=1]="Removed",e[e.Downloading=2]="Downloading",e[e.Loaded=3]="Loaded"}(PackState=PackState||{});var UnpackerData=function e(){_classCallCheck(this,e),this.unpacker=void 0,this.state=void 0,this.unpacker=null,this.state=PackState.Invalid},uuidToPack={},packIndices={},globalUnpackers={};function error$1(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function initPacks(e){for(var t in packIndices=e)for(var i=e[t],r=0;r<i.length;r++){var n=i[r],s=1===i.length;pushToMap(uuidToPack,n,t,s)}}function _loadNewPack(r,n,s){var e=cc.AssetLibrary.getLibUrlNoExt(n)+".json";cc.loader.load({url:e,ignoreMaxConcurrency:!0},function(e,t){if(e)return errorID(4916,r),s(e);var i=_doLoadNewPack(r,n,t);i?s(null,i):s(error$1(r,n))})}function _doPreload(e,t){var i=globalUnpackers[e];i||((i=globalUnpackers[e]=new UnpackerData).state=PackState.Downloading),i.state!==PackState.Loaded&&(i.unpacker=new JsonUnpacker,i.unpacker.load(packIndices[e],t),i.state=PackState.Loaded)}function _doLoadNewPack(e,t,i){var r=globalUnpackers[t];if(r.state!==PackState.Loaded){if("string"==typeof i&&(i=JSON.parse(i)),i.keys&&i.data){var n=i.keys;decompressJson(i=i.data,n)}Array.isArray(i)?r.unpacker=new JsonUnpacker:i.type===_getClassId(Texture2D)&&(r.unpacker=new TextureUnpacker),r.unpacker.load(packIndices[t],i),r.state=PackState.Loaded}return r.unpacker.retrieve(e)}function _selectLoadedPack(e){for(var t=PackState.Invalid,i="",r=0;r<e.length;r++){var n=e[r],s=globalUnpackers[n];if(s){var a=s.state;if(a===PackState.Loaded)return n;t<a&&(t=a,i=n)}}return t!==PackState.Invalid?i:e[0]}function load(e,t){var i=e.uuid,r=uuidToPack[i];if(r){Array.isArray(r)&&(r=_selectLoadedPack(r));var n=globalUnpackers[r];if(n&&n.state===PackState.Loaded){var s=n.unpacker.retrieve(i);return s||error$1(i,r)}return n||(console.log("Create unpacker %s for %s",r,i),(n=globalUnpackers[r]=new UnpackerData).state=PackState.Downloading),_loadNewPack(i,r,t),null}}var PackDownloader=Object.freeze({initPacks:initPacks,_loadNewPack:_loadNewPack,_doPreload:_doPreload,_doLoadNewPack:_doLoadNewPack,_selectLoadedPack:_selectLoadedPack,load:load}),ID$1="SubPackPipe",UuidRegex$1=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function getUuidFromURL$1(e){var t=e.match(UuidRegex$1);return t?t[1]:""}var _uuidToSubPack=Object.create(null),SubPackPipe=function(){function r(t){_classCallCheck(this,r),this.id=ID$1,this.async=!1,this.pipeline=null;function e(e){var i=t[e];i.uuids&&i.uuids.forEach(function(e){var t=decodeUuid(e);t=t.split("@").map(function(e){return encodeURIComponent(e)}).join("@"),_uuidToSubPack[t]=i.path})}for(var i in t)e(i)}return _createClass(r,[{key:"handle",value:function(e){return e.url=this.transformURL(e.url),null}},{key:"transformURL",value:function(e){var t=getUuidFromURL$1(e);if(t){var i=_uuidToSubPack[t];if(i)return e.replace("res/raw-assets/",i+"raw-assets/")}return e}}]),r}();SubPackPipe.ID=ID$1,Pipeline.SubPackPipe=SubPackPipe;var _libraryBase="",_rawAssetsBase="",_uuidToRawAsset=createMap(!0);function isScene(e){return e&&(e.constructor===cc.SceneAsset||e instanceof cc.Scene)}function RawAssetEntry(e,t){this.url=e,this.type=t}var _dec$o,_class$o,AssetLibrary={_uuidToAsset:{},loadAsset:function(r,n,e){if("string"!=typeof r)return callInNextTick(n,new Error("[AssetLibrary] uuid must be string"),null);var t={uuid:r,type:"uuid"};e&&e.existingAsset&&(t.existingAsset=e.existingAsset),cc.loader.load(t,function(e,t){if(e||!t)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(e?e.message:"Unknown error"));else if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(r);t.scene.dependAssets=getDependsRecursively(i)}n&&n(e,t)})},getLibUrlNoExt:function(e,t){return e=(e=decodeUuid(e)).split("@").map(function(e){return encodeURIComponent(e)}).join("@"),(t?_rawAssetsBase+"assets/":_libraryBase)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){t(new Error("Unable to load resource: EditorExtends is not defined."))},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var i=_uuidToRawAsset[e];return i&&!isChildClassOf(i.type,cc.Asset)?(t.url=_rawAssetsBase+i.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in _uuidToRawAsset},queryAssetInfo:function(e,t){var i=this._getAssetInfoInRuntime(e);t(null,i.url,i.raw)},parseUuidInEditor:function(e){},loadJson:function(e,n){var s=""+((new Date).getTime()+Math.random()),t={uuid:s,type:"uuid",content:e,skips:[cc.loader.assetLoader.id,cc.loader.downloader.id]};cc.loader.load(t,function(e,t){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else{if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(s);t.scene.dependAssets=getDependsRecursively(i)}if(isScene(t)){var r=cc.loader._getReferenceKey(s);cc.loader.removeItem(r)}}t._uuid="",n&&n(e,t)})},getAssetByUuid:function(e){return AssetLibrary._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),_libraryBase=cc.path.stripSep(t)+"/",_rawAssetsBase=e.rawAssetsBase;var i=e.md5AssetsMap;if(i&&i.import){var r=0,n=createMap(!0),s=i.import;for(r=0;r<s.length;r+=2){n[decodeUuid(s[r]).split("@").map(function(e){return encodeURIComponent(e)}).join("@")]=s[r+1]}var a=createMap(!0);for(s=i["raw-assets"],r=0;r<s.length;r+=2){a[decodeUuid(s[r]).split("@").map(function(e){return encodeURIComponent(e)}).join("@")]=s[r+1]}var o=new MD5Pipe(n,a,_libraryBase);cc.loader.insertPipeAfter(cc.loader.assetLoader,o),cc.loader.md5Pipe=o}if(e.subpackages){var c=new SubPackPipe(e.subpackages);cc.loader.insertPipeAfter(cc.loader.assetLoader,c),cc.loader.subPackPipe=c}var l=cc.loader._assetTables;for(var u in l)l[u].reset();var h=e.rawAssets;if(h)for(var _ in h){var p=h[_];for(var d in p){var f=p[d],m=f[0],y=f[1],v=_getClassById(y);if(v){_uuidToRawAsset[d]=new RawAssetEntry(_+"/"+m,v);var g=1===f[2];l[_]||(l[_]=new AssetTable),l[_].add(m,d,v,!g)}else cc.error("Cannot get",y)}}e.packedAssets&&initPacks(e.packedAssets),cc.url._init(e.mountPaths&&e.mountPaths.assets||_rawAssetsBase+"assets")}};cc.AssetLibrary=AssetLibrary;var _dec$p,_dec2$8,_class$p,_class2$l,_descriptor$j,_temp$n,Font=(_dec$o=ccclass("cc.Font"))(_class$o=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,Asset),e}())||_class$o;cc.Font=Font;var _dec$q,_dec2$9,_class$q,_class2$m,_descriptor$k,_descriptor2$c,_descriptor3$8,_descriptor4$6,_temp$o,TTFFont=(_dec$p=ccclass("cc.TTFFont"),_dec2$8=property({override:!0}),_dec$p((_descriptor$j=_applyDecoratedDescriptor((_class2$l=_temp$n=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_fontFamily",_descriptor$j,_assertThisInitialized(t)),t}return _inherits(s,Font),_createClass(s,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),s}()).prototype,"_fontFamily",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_applyDecoratedDescriptor(_class2$l.prototype,"_nativeAsset",[_dec2$8,string],Object.getOwnPropertyDescriptor(_class2$l.prototype,"_nativeAsset"),_class2$l.prototype),_class$p=_class2$l))||_class$p);cc.TTFFont=TTFFont;var _dec$r,_class$r,BitmapFont=(_dec$q=ccclass("cc.BitmapFont"),_dec2$9=property({type:SpriteFrame}),_dec$q((_descriptor$k=_applyDecoratedDescriptor((_class2$m=_temp$o=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"fntDataStr",_descriptor$k,_assertThisInitialized(t)),_initializerDefineProperty(t,"spriteFrame",_descriptor2$c,_assertThisInitialized(t)),_initializerDefineProperty(t,"fontSize",_descriptor3$8,_assertThisInitialized(t)),_initializerDefineProperty(t,"fntConfig",_descriptor4$6,_assertThisInitialized(t)),t}return _inherits(s,Font),s}()).prototype,"fntDataStr",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor2$c=_applyDecoratedDescriptor(_class2$m.prototype,"spriteFrame",[_dec2$9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor3$8=_applyDecoratedDescriptor(_class2$m.prototype,"fontSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),_descriptor4$6=_applyDecoratedDescriptor(_class2$m.prototype,"fntConfig",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$q=_class2$m))||_class$q);cc.BitmapFont=BitmapFont;var LabelAtlas=(_dec$r=ccclass("cc.LabelAtlas"))(_class$r=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,BitmapFont),e}())||_class$r;cc.LabelAtlas=LabelAtlas;var ID$2="AssetLoader",reusedArray=[],AssetLoader=function(){function e(){_classCallCheck(this,e),this.id=ID$2,this.async=!0,this.pipeline=null}return _createClass(e,[{key:"handle",value:function(s,a){var o=s.uuid;if(!o)return s.content||null;cc.AssetLibrary.queryAssetInfo(o,function(e,t,i){if(e)a(e);else if(s.url=s.rawUrl=t,s.isRawAsset=i){var r=extname(t).toLowerCase();if(!r)return void a(new Error(getError(4931,o,t)));r=r.substr(1);var n=LoadingItems.getQueue(s);reusedArray[0]={queueId:s.queueId,id:t,url:t,type:r,error:null,alias:s,complete:!0},n.append(reusedArray),s.type=r,a(null,s.content)}else s.type="uuid",a(null,s.content)})}}]),e}();function downloadBinary(e,t){var i=e.url,r=cc.loader.getXMLHttpRequest(),n="Load binary data failed: "+i;r.open("GET",i,!0),r.responseType="arraybuffer",r.onload=function(){var e=r.response;e?t(null,e):t({status:r.status,errorMessage:n+"(no response)"})},r.onerror=function(){t({status:r.status,errorMessage:n+"(error)"})},r.ontimeout=function(){t({status:r.status,errorMessage:n+"(time out)"})},r.send(null)}function downloadText(e,t){var i=e.url;i=urlAppendTimestamp(i);var r=cc.loader.getXMLHttpRequest(),n="Load text file failed: "+i;r.open("GET",i,!0),r.overrideMimeType&&r.overrideMimeType("text/plain; charset=utf-8"),r.onload=function(){4===r.readyState?200===r.status||0===r.status?t(null,r.responseText):t({status:r.status,errorMessage:n+"(wrong status)"}):t({status:r.status,errorMessage:n+"(wrong readyState)"})},r.onerror=function(){t({status:r.status,errorMessage:n+"(error)"})},r.ontimeout=function(){t({status:r.status,errorMessage:n+"(time out)"})},r.send(null)}function skip(){return null}function downloadScript(e,t,i){var r=e.url,n=document,s=document.createElement("script");function a(){s.parentNode&&s.parentNode.removeChild(s),s.removeEventListener("load",a,!1),s.removeEventListener("error",o,!1),t(null,r)}function o(){s.parentNode&&s.parentNode.removeChild(s),s.removeEventListener("load",a,!1),s.removeEventListener("error",o,!1),t(new Error(getError(4928,r)))}s.async=!!i,s.src=urlAppendTimestamp(r),s.addEventListener("load",a,!1),s.addEventListener("error",o,!1),n.body.appendChild(s)}function downloadWebp(e,t,i,r){return cc.sys.capabilities.webp?downloadImage(e,t,i,r):new Error(getError(4929,e.url))}function downloadImage(e,t,i,r){void 0===i&&(i=!0);var n=urlAppendTimestamp(e.url);function s(){r.removeEventListener("load",s),r.removeEventListener("error",a),r.id=e.id,t(null,r)}function a(){r.removeEventListener("load",s),r.removeEventListener("error",a),"https:"!==window.location.protocol&&r.crossOrigin&&"anonymous"===r.crossOrigin.toLowerCase()?downloadImage(e,t,!1,r):t(new Error(getError(4930,n)))}if(r=r||new Image,i&&"file:"!==window.location.protocol?r.crossOrigin="anonymous":r.crossOrigin=null,r.complete&&0<r.naturalWidth&&r.src===n)return r;r.addEventListener("load",s),r.addEventListener("error",a),r.src=n}function downloadUuid(e,t){var i=load(e,t);return void 0===i?this.extMap.json(e,t):i||void 0}AssetLoader.ID=ID$2,Pipeline.AssetLoader=AssetLoader;var defaultMap={js:downloadScript,png:downloadImage,jpg:downloadImage,bmp:downloadImage,jpeg:downloadImage,gif:downloadImage,ico:downloadImage,tiff:downloadImage,webp:downloadWebp,image:downloadImage,pvr:downloadBinary,pkm:downloadBinary,txt:downloadText,xml:downloadText,vsh:downloadText,fsh:downloadText,atlas:downloadText,tmx:downloadText,tsx:downloadText,json:downloadText,ExportJson:downloadText,plist:downloadText,fnt:downloadText,font:skip,eot:skip,ttf:skip,woff:skip,svg:skip,ttc:skip,uuid:downloadUuid,binary:downloadBinary,bin:downloadBinary,default:downloadText},ID$3="Downloader",Downloader=function(){function t(e){_classCallCheck(this,t),this.id=ID$3,this.async=!0,this.pipeline=null,this.extMap=void 0,this._curConcurrent=0,this._loadQueue=[],this._subpackages={},this.extMap=mixin(e,defaultMap)}return _createClass(t,[{key:"addHandlers",value:function(e){mixin(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,i){var r=this,t=this.extMap[e.type]||this.extMap.default,n=void 0;if(this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(n=t.call(this,e,function(e,t){r._curConcurrent=Math.max(0,r._curConcurrent-1),r._handleLoadQueue(),i&&i(e,t)})))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),n}else if(e.ignoreMaxConcurrency){if(void 0!==(n=t.call(this,e,i)))return n}else this._loadQueue.push({item:e,callback:i})}},{key:"loadSubpackage",value:function(e,t){var i=this._subpackages[e];i?i.loaded?t&&t():downloadScript({url:i.path},function(e){e||(i.loaded=!0),t&&t(e)}):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),t}();Downloader.ID=ID$3,Downloader.PackDownloader=PackDownloader,Pipeline.Downloader=Downloader;var MissingClass,SAXParser=function(){function e(){_classCallCheck(this,e),this._isSupportDOMParser=void 0,this._parser=void 0,window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return _createClass(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}(),PlistParser=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,SAXParser),_createClass(e,[{key:"parse",value:function(e){var t=this._parseXML(e),i=t.documentElement;if("plist"!==i.tagName)return cc.warnID(5100),{};for(var r=null,n=0,s=i.childNodes.length;n<s&&1!==(r=i.childNodes[n]).nodeType;n++);return t=null,this._parseNode(r)}},{key:"_parseNode",value:function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var r=0;r<e.childNodes.length;r++)t+=e.childNodes[r].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],i=0,r=e.childNodes.length;i<r;i++){var n=e.childNodes[i];1===n.nodeType&&t.push(this._parseNode(n))}return t}},{key:"_parseDict",value:function(e){for(var t={},i=null,r=0,n=e.childNodes.length;r<n;r++){var s=e.childNodes[r];1===s.nodeType&&("key"===s.tagName?i=s.firstChild.nodeValue:t[i]=this._parseNode(s))}return t}}]),e}(),plistParser=new PlistParser;function isSceneObj(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function parseDepends$1(e,t,i,r){var n,s,a,o=i.uuidList,c=i.uuidObjList,l=i.uuidPropList,u=i._stillUseUrl,h=e.dependKeys=[];if(r)for(n=[],s=0;s<o.length;s++){a=o[s];var _=c[s],p=l[s],d=cc.AssetLibrary._getAssetInfoInRuntime(a);if(d.raw){var f=d.url;_[p]=f,h.push(f)}else n.push({type:"uuid",uuid:a,deferredLoadRaw:!0,_owner:_,_ownerProp:p,_stillUseUrl:u[s]})}else{for(n=new Array(o.length),s=0;s<o.length;s++)a=o[s],n[s]={type:"uuid",uuid:a,_owner:c[s],_ownerProp:l[s],_stillUseUrl:u[s]};t._native&&!t.constructor.preventPreloadNativeObject&&n.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return n}function loadDepends(e,t,p,d,f){t.content=p;var m=t.dependKeys;e.flowInDeps(t,d,function(e,t){var i,r=t.map;for(var n in r)(i=r[n]).uuid&&i.content&&(i.content._uuid=i.uuid);for(var s=0;s<d.length;s++){var a=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==p._uuid&&m.indexOf(e.id)<0&&m.push(e.id)},o=d[s],c=o.uuid,l=o.url;o._owner,o._ownerProp;if(i=r[l]){var u=o;if(i.complete||i.content){if(i.error)cc._throw(i.error);else a.call(u,i)}else{var h=LoadingItems.getQueue(i),_=h._callbackTable[c];_?_.unshift(a,u):h.addListener(c,a,u)}}}f(e,p)})}function canDeferredLoad(e,t,i){var r=t.deferredLoadRaw;return r?e instanceof cc.Asset&&e.constructor.preventDeferredLoadDependents&&(r=!1):i&&(e instanceof cc.SceneAsset||e instanceof cc.Prefab)&&(r=e.asyncLoadAssets),r}function loadUuid(t,i){var e,r;if("string"==typeof t.content)try{if((e=JSON.parse(t.content)).keys&&e.data){var n=e.keys;decompressJson(e=e.data,n)}}catch(e){return new Error(getError(4923,t.id,e.stack))}else{if("object"!==_typeof(t.content))return new Error(getError(4924));e=t.content}if(null==e)return new Error(getError(4923,t.id));var s=isSceneObj(e);r=s?cc._MissingScript.safeFindClass:function(e){var t=_getClassById(e);return t||(cc.warnID(4903,e),Object)};var a,o=cc.deserialize.Details.pool.get();try{a=cc.deserialize(e,o,{classFinder:r,target:t.existingAsset,customEnv:t})}catch(e){return cc.deserialize.Details.pool.put(o),console.error(e),new Error("Failed to load asset ".concat(t.id,", exception occurs during deserialization: ").concat(e.stack,"."))}a._uuid=t.uuid;var c=canDeferredLoad(a,t,s),l=parseDepends$1(t,a,o,c);cc.deserialize.Details.pool.put(o);function u(t,e){if(!t&&e.onLoaded)try{e.onLoaded()}catch(e){t=e}i(t,e)}if(0===l.length)return u(null,a);loadDepends(this.pipeline,t,a,l,u)}loadUuid.isSceneObj=isSceneObj;var _canvasContext=null,_testString="BES bswy:->@",_fontFaces={},_intervalId=-1,_loadingFonts=[],_timeout=6e4;function _checkFontLoaded(){for(var e=!0,t=Date.now(),i=_loadingFonts.length-1;0<=i;i--){var r=_loadingFonts[i],n=r.fontFamilyName;if(t-r.startTime>_timeout)cc.warnID(4933,n),r.callback(null,n),_loadingFonts.splice(i,1);else{var s=r.refWidth;_canvasContext.font="40px "+n,s!==safeMeasureText(_canvasContext,_testString)?(_loadingFonts.splice(i,1),r.callback(null,n)):e=!1}}e&&(clearInterval(_intervalId),_intervalId=-1)}function loadFont(e,t){var i=e.url,r=_getFontFamily(i);if(_fontFaces[r])return r;if(!_canvasContext){var n=document.createElement("canvas");n.width=100,n.height=100,_canvasContext=n.getContext("2d")}var s="40px "+r;_canvasContext.font=s;var a=safeMeasureText(_canvasContext,_testString),o=document.createElement("style");o.type="text/css";var c="";isNaN(r-0)?c+="@font-face { font-family:"+r+"; src:":c+="@font-face { font-family:'"+r+"'; src:",c+="url('"+i+"');",o.textContent=c+"}",document.body.appendChild(o);var l=document.createElement("div"),u=l.style;u.fontFamily=r,l.innerHTML=".",u.position="absolute",u.left="-100px",u.top="-100px",document.body.appendChild(l);var h={fontFamilyName:r,refWidth:a,callback:t,startTime:Date.now()};_loadingFonts.push(h),_fontFaces[r]=o,-1===_intervalId&&(_intervalId=setInterval(_checkFontLoaded,100))}function _getFontFamily(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i,r=e.lastIndexOf("/");return-1!==(i=-1===r?e.substring(0,t)+"_LABEL":e.substring(r+1,t)+"_LABEL").indexOf(" ")&&(i='"'+i+'"'),i}function loadNothing(){return null}function loadJSON(t){if("string"!=typeof t.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(t.content)}catch(e){return new Error("JSON Loader: Parse json ["+t.id+"] failed : "+e)}}function loadImage(e){if(e._owner instanceof cc.Asset)return null;var t=e.content;var i=e.rawUrl,r=e.imageAsset||new ImageAsset;return r._uuid=e.uuid,r._url=i,r._setRawAsset(i,!1),r._nativeAsset=t,r}function loadAudioAsAsset(e,t){if(e._owner instanceof cc.Asset)return null;var i=new cc.AudioClip;return i._setRawAsset(e.rawUrl,!1),i._nativeAsset=e.content,i}function loadPlist(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=plistParser.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")}function loadBinary(e){return e.load?e.load(e.content):e.content}var PVR_HEADER_LENGTH=13,PVR_MAGIC=55727696,PVR_HEADER_MAGIC=0,PVR_HEADER_HEIGHT=6,PVR_HEADER_WIDTH=7,PVR_HEADER_METADATA=12;function loadPVRTex(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Int32Array(t,0,PVR_HEADER_LENGTH);if(i[PVR_HEADER_MAGIC]===PVR_MAGIC){var r=i[PVR_HEADER_WIDTH],n=i[PVR_HEADER_HEIGHT],s=i[PVR_HEADER_METADATA]+52;return t=t.slice(s,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:n}}if(559044176!==i[11])return new Error("Invalid magic number in PVR header");var a=i[0],o=i[1],c=i[2];return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:c,height:o}}var ETC_PKM_HEADER_SIZE=16,ETC_PKM_FORMAT_OFFSET=6,ETC_PKM_ENCODED_WIDTH_OFFSET=8,ETC_PKM_ENCODED_HEIGHT_OFFSET=10,ETC_PKM_WIDTH_OFFSET=12,ETC_PKM_HEIGHT_OFFSET=14,ETC1_RGB_NO_MIPMAPS=0,ETC2_RGB_NO_MIPMAPS=1,ETC2_RGBA_NO_MIPMAPS=3;function readBEUint16(e,t){return e[t]<<8|e[t+1]}function loadPKMTex(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t),r=readBEUint16(i,ETC_PKM_FORMAT_OFFSET);if(r!==ETC1_RGB_NO_MIPMAPS&&r!==ETC2_RGB_NO_MIPMAPS&&r!==ETC2_RGBA_NO_MIPMAPS)return new Error("Invalid magic number in ETC header");var n=readBEUint16(i,ETC_PKM_WIDTH_OFFSET),s=readBEUint16(i,ETC_PKM_HEIGHT_OFFSET);readBEUint16(i,ETC_PKM_ENCODED_WIDTH_OFFSET),readBEUint16(i,ETC_PKM_ENCODED_HEIGHT_OFFSET);return t=t.slice(ETC_PKM_HEADER_SIZE,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:n,height:s}}var defaultMap$1={png:loadImage,jpg:loadImage,bmp:loadImage,jpeg:loadImage,gif:loadImage,ico:loadImage,tiff:loadImage,webp:loadImage,image:loadImage,pvr:loadPVRTex,pkm:loadPKMTex,mp3:loadAudioAsAsset,ogg:loadAudioAsAsset,wav:loadAudioAsAsset,m4a:loadAudioAsAsset,json:loadJSON,ExportJson:loadJSON,plist:loadPlist,uuid:loadUuid,prefab:loadUuid,fire:loadUuid,scene:loadUuid,binary:loadBinary,bin:loadBinary,font:loadFont,eot:loadFont,ttf:loadFont,woff:loadFont,svg:loadFont,ttc:loadFont,default:loadNothing},ID$4="Loader",Loader=function(){function t(e){_classCallCheck(this,t),this.id=ID$4,this.async=!0,this.pipeline=null,this.extMap=void 0,this.extMap=mixin(e,defaultMap$1)}return _createClass(t,[{key:"addHandlers",value:function(e){this.extMap=mixin(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),t}();Loader.ID=ID$4,Pipeline.Loader=Loader;var _tmpInfo=null;function getItemDesc(e){return e.uuid?(_tmpInfo=_tmpInfo||{path:"",type:null},cc.loader._assetTables.assets._getInfo_DEBUG(e.uuid,_tmpInfo)?(_tmpInfo.path="resources/"+_tmpInfo.path,'"'.concat(_tmpInfo.path,'" (type: ').concat(getClassName(_tmpInfo.type),", uuid: ").concat(e.uuid,")")):'"'.concat(e.rawUrl,'" (').concat(e.uuid,")")):'"'.concat(e.rawUrl,'"')}function doCheckCouldRelease(e,t,i){i[e]||cc.log('"'.concat(e,'" was released but maybe still referenced by ').concat(getItemDesc(t)))}var ReleasedAssetChecker=function(){function e(){_classCallCheck(this,e),this._releasedKeys=void 0,this._dirty=void 0,this._releasedKeys=createMap(!0),this._dirty=!1}return _createClass(e,[{key:"setReleased",value:function(e,t){this._releasedKeys[t]=!0,this._dirty=!0}},{key:"checkCouldRelease",value:function(e){if(this._dirty){this._dirty=!1;var t=this._releasedKeys;for(var i in e){var r=e[i];r.alias&&(r=r.alias);var n=r.dependKeys;if(n)for(var s=0;s<n.length;++s){var a=n[s];t[a]&&(doCheckCouldRelease(a,r,e),delete t[a])}}clear(t)}}}]),e}(),assetTables=Object.create(null);function getXMLHttpRequest(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}assetTables.assets=new AssetTable,assetTables.internal=new AssetTable;var _info={url:null,raw:!1};function getResWithUrl(e){var t,i,r;if("object"===_typeof(e)){if((i=e).url)return i;t=e.uuid}else i={},t=e;return r=i.type?"uuid"===i.type:cc.AssetLibrary._uuidInSettings(t),cc.AssetLibrary._getAssetInfoInRuntime(t,_info),i.url=r?_info.url:t,_info.url&&"uuid"===i.type&&_info.raw?(i.type=null,i.isRawAsset=!0):r||(i.isRawAsset=!0),i}var _sharedResources=[],_sharedList=[],CCLoader=function(){function n(){var e;_classCallCheck(this,n);var t=new AssetLoader,i=new Downloader,r=new Loader;return(e=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this,[t,i,r]))).getXMLHttpRequest=void 0,e.assetLoader=void 0,e.md5Pipe=void 0,e.downloader=void 0,e.loader=void 0,e.onProgress=void 0,e._assetTables=void 0,e._autoReleaseSetting=void 0,e._releasedAssetChecker_DEBUG=void 0,e.getXMLHttpRequest=getXMLHttpRequest,e.assetLoader=t,e.md5Pipe=null,e.downloader=i,e.loader=r,e.onProgress=null,e._assetTables=assetTables,e._autoReleaseSetting=createMap(!0),e}return _inherits(n,Pipeline),_createClass(n,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,r){void 0===r&&(r=t,t=this.onProgress||null);var n,s=this,a=!1;e instanceof Array||(e=e?(a=!0,[e]):[]);for(var i=_sharedResources.length=0;i<e.length;++i){var o=e[i];if(o&&o.id&&(cc.warnID(4920,o.id),o.uuid||o.url||(o.url=o.id)),(n=getResWithUrl(o)).url||n.uuid){var c=this._cache[n.url];_sharedResources.push(c||n)}}var l=LoadingItems.create(this,t,function(t,i){callInNextTick(function(){if(r){if(a){var e=n.url;r.call(s,i.getError(e),i.getContent(e))}else r.call(s,t,i);r=null}i.destroy()})});LoadingItems.initQueueDeps(l),l.append(_sharedResources),_sharedResources.length=0}},{key:"flowInDeps",value:function(i,e,r){for(var t=_sharedList.length=0;t<e.length;++t){var n=getResWithUrl(e[t]);if(n.url||n.uuid){var s=this._cache[n.url];s?_sharedList.push(s):_sharedList.push(n)}}var a=LoadingItems.create(this,i?function(e,t,i){a._ownerQueue&&a._ownerQueue.onProgress&&a._ownerQueue._childOnProgress(i)}:null,function(e,t){r(e,t),i&&i.deps&&(i.deps.length=0),t.destroy()});if(i){var o=LoadingItems.getQueue(i);a._ownerQueue=o._ownerQueue||o}var c=a.append(_sharedList,i);return _sharedList.length=0,c}},{key:"loadRes",value:function(e,t,i,r,n){5!==arguments.length&&(n=r,r=i,i="assets");var s=this._parseLoadResArgs(t,r,n);t=s.type,r=s.onProgress,n=s.onComplete;var a=this,o=a._getResUuid(e,t,i,!0);o?this.load({type:"uuid",uuid:o},r,function(e,t){t&&a.setAutoReleaseRecursively(o,!1),n&&n(e,t)}):a._urlNotFound(e,t,n)}},{key:"loadResDir",value:function(e,t,i,r,c){if(5!==arguments.length&&(c=r,r=i,i="assets"),assetTables[i]){var n=this._parseLoadResArgs(t,r,c);t=n.type,r=n.onProgress,c=n.onComplete;var s=[],a=assetTables[i].getUuidArray(e,t,s);this._loadResUuids(a,r,function(e,t,i){for(var r=t.length,n=0;n<r;++n)if(t[n]instanceof cc.SpriteAtlas){var s=t[n].getSpriteFrames();for(var a in s){var o=s[a];t.push(o),i&&i.push("".concat(i[n],"/").concat(o.name))}}c&&c(e,t,i)},s)}}},{key:"loadResArray",value:function(e,t,i,r,n){5!==arguments.length&&(n=r,r=i,i="assets");var s=this._parseLoadResArgs(t,r,n);t=s.type,r=s.onProgress,n=s.onComplete;for(var a=[],o=0;o<e.length;o++){var c=e[o],l=this._getResUuid(c,t,i,!0);if(!l)return void this._urlNotFound(c,t,n);a.push(l)}this._loadResUuids(a,r,n)}},{key:"getRes",value:function(e,t){var i=this._cache[e];if(!i){var r=this._getResUuid(e,t,null,!0);if(!r)return null;var n=this._getReferenceKey(r);i=this._cache[n]}return i&&i.alias&&(i=i.alias),i&&i.complete?i.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),i=getDependsRecursively(t);return i.push(t),i}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];this.release(i)}else if(e){var r=this._getReferenceKey(e),n=this.getItem(r);if(n){this.removeItem(r);if((e=n.content)instanceof cc.Asset){var s=e.nativeUrl;s&&this.release(s),e.destroy()}0}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,i){var r=this._getResUuid(e,t,i,!0);r?this.release(r):cc.errorID(4914,e)}},{key:"releaseResDir",value:function(e,t,i){if(assetTables[i=i||"assets"])for(var r=assetTables[i].getUuidArray(e,t),n=0;n<r.length;n++){var s=r[n];this.release(s)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=Pipeline.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var i=this._getReferenceKey(e);i&&(this._autoReleaseSetting[i]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var i=this._getReferenceKey(e);if(i){this._autoReleaseSetting[i]=t;for(var r=getDependsRecursively(i),n=0;n<r.length;n++){var s=r[n];this._autoReleaseSetting[s]=t}}else 0}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,i,r){var n="",s=assetTables[i=i||"assets"];if(e&&s){var a=e.indexOf("?");if(-1!==a&&(e=e.substr(0,a)),!(n=s.getUuid(e,t))){var o=cc.path.extname(e);o&&(e=e.slice(0,-o.length),(n=s.getUuid(e,t))&&!r&&cc.warnID(4901,e,o))}}return!n&&t&&(isChildClassOf(t,SpriteFrame)||isChildClassOf(t,Texture2D)||isChildClassOf(t,TextureCube))&&cc.warnID(4934),n}},{key:"_getReferenceKey",value:function(e){var t;return"object"===_typeof(e)?t=e._uuid||null:"string"==typeof e&&(t=this._getResUuid(e,null,null,!0)||e),t?(cc.AssetLibrary._getAssetInfoInRuntime(t,_info),this._cache[_info.url]?_info.url:t):(cc.warnID(4800,e),t)}},{key:"_urlNotFound",value:function(t,i,r){callInNextTick(function(){t=cc.url.normalize(t);var e="".concat(i?getClassName(i):"Asset",' in "resources/').concat(t,'" does not exist.');r&&r(new Error(e),[])})}},{key:"_parseLoadResArgs",value:function(e,t,i){if(void 0===i){var r=isChildClassOf(e,cc.RawAsset);t?(i=t,r&&(t=this.onProgress||null)):void 0!==t||r||(i=e,t=this.onProgress||null,e=null),void 0===t||r||(t=e,e=null)}return{type:e,onProgress:t,onComplete:i}}},{key:"_loadResUuids",value:function(e,t,c,l){if(0<e.length){var u=this,h=e.map(function(e){return{type:"uuid",uuid:e}});this.load(h,t,function(e,t){if(c){for(var i=[],r=l&&[],n=0;n<h.length;++n){var s=h[n].uuid,a=u._getReferenceKey(s),o=t.getContent(a);o&&(u.setAutoReleaseRecursively(s,!1),i.push(o),r&&r.push(l[n]))}l?c(e,i,r):c(e,i)}})}else c&&callInNextTick(function(){l?c(null,[],[]):c(null,[])})}}]),n}(),loader=cc.loader=new CCLoader;function loadImage$1(e,i,r){assertID(!!e,3103);var n=loader.getRes(e);return n?n.loaded?i&&i.call(r,null,n):n.once("load",function(){i&&i.call(r,null,n)},r):(n=new ImageAsset,loader.load({url:e,imageAsset:n},function(e,t){if(e)return i&&i.call(r,e||new Error("Unknown error")),n;i&&i.call(r,null,t)})),n}function cacheImage(e,t){if(e&&t){var i=new ImageAsset(t),r={id:e,url:e,error:null,content:i,complete:!1};return loader.flowOut(r),i}}function postLoadImage(i,r){i.loaded?r&&r():i.nativeUrl?loader.load({url:i.nativeUrl,skips:i.isCompressed?void 0:["Loader"]},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),r&&r(e)}):r&&r()}var _dec$s,_dec2$a,_dec3$2,_class$s,_class2$n,_descriptor$l,_descriptor2$d,_temp$p,textureUtil=Object.freeze({loadImage:loadImage$1,cacheImage:cacheImage,postLoadImage:postLoadImage}),Skeleton=(_dec$s=ccclass("cc.Skeleton"),_dec2$a=property([CCString]),_dec3$2=property([Mat4]),_dec$s((_descriptor$l=_applyDecoratedDescriptor((_class2$n=_temp$p=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_joints",_descriptor$l,_assertThisInitialized(t)),_initializerDefineProperty(t,"_bindposes",_descriptor2$d,_assertThisInitialized(t)),t._bindTRS=[],t._hash=0,t}return _inherits(s,Asset),_createClass(s,[{key:"onLoaded",value:function(){this.bindposes=this._bindposes}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e,this._bindTRS=e.map(function(e){var t=new Vec3,i=new Quat,r=new Vec3;return Mat4.toRTS(e,i,t,r),{position:t,rotation:i,scale:r}}),this._hash=murmurhash2_32_gc(this.bindposes.reduce(function(e,t){return e+t.m00.toPrecision(2)+" "+t.m01.toPrecision(2)+" "+t.m02.toPrecision(2)+" "+t.m03.toPrecision(2)+" "+t.m04.toPrecision(2)+" "+t.m05.toPrecision(2)+" "+t.m06.toPrecision(2)+" "+t.m07.toPrecision(2)+" "+t.m08.toPrecision(2)+" "+t.m09.toPrecision(2)+" "+t.m10.toPrecision(2)+" "+t.m11.toPrecision(2)+" "+t.m12.toPrecision(2)+" "+t.m13.toPrecision(2)+" "+t.m14.toPrecision(2)+" "+t.m15.toPrecision(2)+"\n"},""),666)}},{key:"bindTRS",get:function(){return this._bindTRS}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"hash",get:function(){return this._hash}}]),s}()).prototype,"_joints",[_dec2$a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor2$d=_applyDecoratedDescriptor(_class2$n.prototype,"_bindposes",[_dec3$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_class$s=_class2$n))||_class$s);cc.Skeleton=Skeleton,cc.textureUtil=textureUtil;var _dec$t,_dec2$b,_dec3$3,_dec4$1,_class$t,_class2$o,_descriptor$m,_descriptor2$e,_temp$q,LightType,BaseRenderData=function e(){_classCallCheck(this,e),this.material=null,this.vertexCount=0,this.indiceCount=0},RenderData=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r)))).vData=null,t.uvDirty=!0,t.vertDirty=!0,t._datas=[],t._indices=[],t._pivotX=0,t._pivotY=0,t._width=0,t._height=0,t}return _inherits(s,BaseRenderData),_createClass(s,[{key:"updateSizeNPivot",value:function(e,t,i,r){e===this._width&&t===this._height&&i===this._pivotX&&r===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=r,this.vertDirty=!0)}},{key:"clear",value:function(){this._datas.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indiceCount=0}},{key:"dataLength",get:function(){return this._datas.length},set:function(e){var t=this._datas;if(t.length!==e){var i=t.length,r=0;for(r=e;r<i;r++)_dataPool.free(t[r]);for(r=i;r<e;r++)t[r]=_dataPool.alloc();t.length=e}}},{key:"datas",get:function(){return this._datas}}],[{key:"add",value:function(){return _pool$1.add()}},{key:"remove",value:function(e){var t=_pool$1.data.indexOf(e);-1!==t&&(_pool$1.data[t].clear(),_pool$1.removeAt(t))}}]),s}(),IARenderData=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),t.iData=new Uint16Array(1536),t.vertexStart=0,t.indiceStart=0,t.byteStart=0,t.byteCount=0,t._formatByte=9*Float32Array.BYTES_PER_ELEMENT,t}return _inherits(s,BaseRenderData),_createClass(s,[{key:"request",value:function(e,t){var i=this.byteCount+e*this._formatByte,r=this.indiceCount+t;if(65535<e+this.vertexCount)return!1;var n=this.vData.byteLength,s=this.iData.length,a=this.vData.length,o=this.iData.length;if(n<i||s<r){for(;n<i||s<r;)n=4*(a*=2),s=o*=2;var c=new Float32Array(this.vData.buffer);this.vData=new Float32Array(a),this.vData.set(c,0);var l=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(o),this.iData.set(l,0)}return this.vertexCount+=e,this.indiceCount+=t,this.byteCount=i,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indiceCount=0,this.byteCount=0,this.vertexStart=0,this.indiceStart=0,this.byteStart=0}}]),s}(),_dataPool=new Pool$1(function(){return{x:0,y:0,z:0,u:0,v:0,color:Color.WHITE.clone()}},128),_pool$1=new RecyclePool(function(){return new RenderData},32),ccclass$1=ccclass,property$1=property,RenderableComponent=(_dec$t=ccclass$1("cc.RenderableComponent"),_dec2$b=property$1({type:[Material]}),_dec3$3=property$1({type:Material,displayName:"Materials"}),_dec4$1=property$1({visible:!1}),_dec$t((_descriptor$m=_applyDecoratedDescriptor((_class2$o=_temp$q=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"_materials",_descriptor$m,_assertThisInitialized(e)),_initializerDefineProperty(e,"_visFlags",_descriptor2$e,_assertThisInitialized(e)),e._models=[],e}return _inherits(t,Component),_createClass(t,[{key:"getMaterial",value:function(e,t,i){var r=1<arguments.length&&void 0!==t&&t,n=2<arguments.length&&void 0!==i&&i,s=this._materials[e];if(!s)return null;var a=Material.getInstantiatedMaterial(s,this,r);return a!==this._materials[e]&&this.setMaterial(a,e,n||!r),this._materials[e]}},{key:"getSharedMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t,i){var r=!(2<arguments.length&&void 0!==i)||i;this._materials[t]=e,r&&this._onMaterialModified(t,e)}},{key:"_collectModels",value:function(){return this._models}},{key:"_changeSceneInModel",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisiblityChange",value:function(e){}},{key:"sharedMaterials",get:function(){return this._materials.slice()},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materials[e]=this.getMaterial(e);return this._materials},set:function(e){var t=e.length-this._materials.length;if(0<t)this._materials=this._materials.concat(new Array(t).fill(null));else if(t<0){for(var i=-t;i<this._materials.length;++i)this.setMaterial(null,i);this._materials=this._materials.splice(-t)}}},{key:"material",get:function(){return this.getMaterial(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterial(e,0)}},{key:"sharedMaterial",get:function(){return this.getSharedMaterial(0)}},{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisiblityChange(e)}}]),t}()).prototype,"_materials",[_dec2$b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor2$e=_applyDecoratedDescriptor(_class2$o.prototype,"_visFlags",[property$1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Layers.Enum.NONE}}),_applyDecoratedDescriptor(_class2$o.prototype,"sharedMaterials",[_dec3$3],Object.getOwnPropertyDescriptor(_class2$o.prototype,"sharedMaterials"),_class2$o.prototype),_applyDecoratedDescriptor(_class2$o.prototype,"visibility",[_dec4$1],Object.getOwnPropertyDescriptor(_class2$o.prototype,"visibility"),_class2$o.prototype),_class$t=_class2$o))||_class$t),System=function(){function e(){_classCallCheck(this,e),this._id="",this._priority=0,this._executeInEditMode=!1}return _createClass(e,[{key:"init",value:function(){}},{key:"update",value:function(e){}},{key:"postUpdate",value:function(e){}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"id",set:function(e){this._id=e},get:function(){return this._id}}],[{key:"sortByPriority",value:function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}}]),e}();function ColorTemperatureToRGB(e,t){t<1e3?t=1e3:15e3<t&&(t=15e3);var i=t*t,r=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),n=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),s=2*r-8*n+4,a=3*r/s,o=2*n/s,c=1/o*a,l=1/o*(1-a-o);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}!function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(LightType=LightType||{});var nt2lm=function(e){return 4*Math.PI*Math.PI*e*e},Light=function(){function r(e,t,i){_classCallCheck(this,r),this._enabled=!0,this._color=new Vec3(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new Vec3(1,1,1),this._scene=void 0,this._node=void 0,this._type=void 0,this._name=void 0,this._scene=e,this._name=t,this._type=LightType.UNKNOWN,this._node=i}return _createClass(r,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"color",set:function(e){this._color.set(e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){this._useColorTemp=e},get:function(){return this._useColorTemp}},{key:"colorTemperature",set:function(e){this._colorTemp=e,ColorTemperatureToRGB(this._colorTempRGB,this._colorTemp)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name}}]),_createClass(r,[{key:"update",value:function(){}}]),r}();function cullLight(e,t){return!1}function cullDirectionalLight(e,t){return cullLight()}function cullSphereLight(e,t){return!(!t.worldBounds||intersect.aabb_aabb(t.worldBounds,e.aabb))}function cullSpotLight(e,t){return!(!t.worldBounds||intersect.aabb_aabb(t.worldBounds,e.aabb)&&intersect.aabb_frustum(t.worldBounds,e.frustum))}var CameraProjection,CameraAperture,CameraISO,CameraShutter,cullSceneWithDirectionalLight=function(){var _=new frustum;return _.accurate=!0,function(e,t,i,r,n,s,a){calcDirectionalLightCullFrustum(_,i,r,n,s,a);var o=t,c=Array.isArray(o),l=0;for(o=c?o:o[Symbol.iterator]();;){var u;if(c){if(l>=o.length)break;u=o[l++]}else{if((l=o.next()).done)break;u=l.value}var h=u;h.enabled&&h.worldBounds&&(h.updateTransform(),intersect.aabb_frustum(h.worldBounds,_)&&(h.updateUBOs(),e.push(h)))}}}(),calcDirectionalLightCullFrustum=function(){var o=new Vec3,c=new Vec3,l=new Quat,u=new frustum;u.accurate=!0;var h=new Mat4,_=new Mat4,p=new Vec3,d=new Vec3;return function(e,t,i,r,n,s){Mat4.fromRT(h,i.node.getWorldRotation(l),t.node.getWorldPosition(o)),Mat4.invert(_,h),t.getSplitFrustum(u,r,n),u.transform(_),Vec3.set(p,u.vertices[0].x,u.vertices[0].y,u.vertices[0].z),Vec3.copy(d,p);for(var a=1;a<u.vertices.length;a++)p.x=Math.min(p.x,u.vertices[a].x),p.y=Math.min(p.y,u.vertices[a].y),p.z=Math.min(p.z,u.vertices[a].z),d.x=Math.max(d.x,u.vertices[a].x),d.y=Math.max(d.y,u.vertices[a].y),d.z=Math.max(d.z,u.vertices[a].z);Vec3.set(c,(p.x+d.x)/2,(p.y+d.y)/2,d.z),c.z+=s,Vec3.transformMat4(o,c,h),Mat4.fromRT(h,i.node.getWorldRotation(l),o),frustum.createOrtho(e,d.x-p.x,d.y-p.y,0,p.z-s-d.z,h)}}(),RenderFlow=function(){function t(e){_classCallCheck(this,t),this._device=void 0,this._pipeline=void 0,this._name="",this._priority=0,this._stages=[],this._material=new Material,this._device=e.device,this._pipeline=e}return _createClass(t,[{key:"device",get:function(){return this._device}},{key:"pipeline",get:function(){return this._pipeline}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"stages",get:function(){return this._stages}},{key:"material",get:function(){return this._material}}]),_createClass(t,[{key:"resize",value:function(e,t){var i=this._stages,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}s.resize(e,t)}}},{key:"render",value:function(e){var t=this._stages,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.render(e)}}},{key:"createStage",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._stages.push(i),this._stages.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyStages",value:function(){var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy()}this._stages=[]}}]),t}(),RenderStage=function(){function t(e){if(_classCallCheck(this,t),this._flow=void 0,this._pipeline=void 0,this._device=void 0,this._name="",this._priority=0,this._framebuffer=null,this._cmdBuff=null,this._clearColors=void 0,this._clearDepth=1,this._clearStencil=0,this._renderArea=void 0,this._pass=null,this._pso=null,this._flow=e,this._pipeline=e.pipeline,this._device=e.device,!this._flow.pipeline.root.device)throw new Error("");this._device=this._flow.pipeline.root.device,this._clearColors=[{r:.3,g:.6,b:.9,a:1}],this._renderArea={x:0,y:0,width:0,height:0}}return _createClass(t,[{key:"flow",get:function(){return this._flow}},{key:"pipeline",get:function(){return this._pipeline}},{key:"priority",get:function(){return this._priority}},{key:"framebuffer",get:function(){return this._framebuffer}}]),_createClass(t,[{key:"setClearColor",value:function(e){0<this._clearColors.length?this._clearColors[0]=e:this._clearColors.push(e)}},{key:"setClearColors",value:function(e){this._clearColors=e}},{key:"setClearDepth",value:function(e){this._clearDepth=e}},{key:"setClearStencil",value:function(e){this._clearStencil=e}},{key:"setRenderArea",value:function(e,t){this._renderArea.width=e,this._renderArea.height=t}}]),t}(),ToneMapStage=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._hTexSampler=0,t._hBlendTexSampler=0,t._bindingLayout=null,t}return _inherits(i,RenderStage),_createClass(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:exports.GFXCommandBufferType.PRIMARY}),this.rebuild(),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){this._pass=this._flow.material.passes[0],this._hTexSampler=this._pass.getBinding("u_texSampler");var e=this._pipeline.globalBindings.get(UBOGlobal.BLOCK.name);this._pso=this._pass.createPipelineState(),this._bindingLayout=this._pso.pipelineLayout.layouts[0],this._pass.bindBuffer(UBOGlobal.BLOCK.binding,e.buffer),this._pass.bindTextureView(this._hTexSampler,this._pipeline.curShadingTexView),this._pipeline.useSMAA&&(this._hBlendTexSampler=this._pass.getBinding("u_blendTexSampler"),this._pass.bindTextureView(this._hBlendTexSampler,this._pipeline.smaaBlendTexView)),this._pass.update(),this._bindingLayout.update()}},{key:"render",value:function(e){var t=e.camera;if(this._cmdBuff){this._renderArea.width=t.width,this._renderArea.height=t.height;var i=e.window.framebuffer;this._cmdBuff.begin(),this._cmdBuff.beginRenderPass(i,this._renderArea,exports.GFXClearFlag.ALL,[{r:0,g:0,b:0,a:1}],1,0),this._cmdBuff.bindPipelineState(this._pso),this._cmdBuff.bindBindingLayout(this._pso.pipelineLayout.layouts[0]),this._cmdBuff.bindInputAssembler(this._pipeline.quadIA),this._cmdBuff.draw(this._pipeline.quadIA),this._cmdBuff.endRenderPass(),this._cmdBuff.end()}this._device.queue.submit([this._cmdBuff])}}]),i}(),ToneMapFlow=function(){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e))}return _inherits(t,RenderFlow),_createClass(t,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}});var t=this._pipeline.root.mainWindow.framebuffer;return this.createStage(ToneMapStage,{name:"ToneMapStage",priority:0,framebuffer:t}),!0}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this.destroyStages()}},{key:"rebuild",value:function(){this._material&&(this._material.destroy(),this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}}));var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.rebuild()}}}]),t}();!function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(CameraProjection=CameraProjection||{}),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(CameraAperture=CameraAperture||{}),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(CameraISO=CameraISO||{}),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(CameraShutter=CameraShutter||{});var _dec$u,_dec2$c,_dec3$4,_class$u,_class2$p,_descriptor$n,_descriptor2$f,_descriptor3$9,_temp$r,_dec4$2,_dec5$1,_dec6$1,_dec7$1,_dec8,_dec9,_class4$1,_class5$1,_descriptor4$7,_descriptor5$5,_descriptor6$1,_descriptor7$1,_temp2$1,_dec10,_dec11,_dec12,_dec13,_dec14,_class7,_class8,_descriptor8$1,_descriptor9$1,_descriptor10$1,_descriptor11,_temp3,_dec15,_dec16,_dec17,_dec18,_class10,_class11,_descriptor12,_descriptor13,_descriptor14,_temp4,FSTOPS=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],SHUTTERS=[1,.5,.25,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,25e-5],ISOS=[100,200,400,800],v_a=new Vec3,v_b=new Vec3,_tempMat1=new Mat4,_tempMat2=new Mat4,SKYBOX_FLAG=exports.GFXClearFlag.STENCIL<<1,Camera=function(){function i(e,t){_classCallCheck(this,i),this._scene=void 0,this._name=void 0,this._enabled=!1,this._proj=void 0,this._isWindowSize=!0,this._width=void 0,this._height=void 0,this._screenScale=void 0,this._aspect=void 0,this._orthoHeight=10,this._fov=toRadian(45),this._nearClip=1,this._farClip=1e3,this._clearStencil=0,this._clearDepth=1,this._clearFlag=exports.GFXClearFlag.NONE,this._clearColor={r:0,g:0,b:0,a:0},this._viewport=new Rect(0,0,1,1),this._isProjDirty=!0,this._matView=new Mat4,this._matProj=new Mat4,this._matProjInv=new Mat4,this._matViewProj=new Mat4,this._matViewProjInv=new Mat4,this._frustum=new frustum,this._forward=new Vec3,this._position=new Vec3,this._node=null,this._view=void 0,this._visibility=CameraDefaultMask,this._priority=0,this._aperture=CameraAperture.F16_0,this._apertureValue=void 0,this._shutter=CameraShutter.D125,this._shutterValue=0,this._iso=CameraISO.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._scene=e,this._name=t.name,this._node=t.node,this._proj=t.projection,this._priority=t.priority||0,this._apertureValue=FSTOPS[this._aperture],this._shutterValue=SHUTTERS[this._shutter],this._isoValue=ISOS[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this._screenScale=1,this._view=this._scene.root.createView({camera:this,name:this._name,priority:this._priority,flows:t.flows}),this.changeTargetWindow(t.window),console.log("Create Camera: "+this._name+" "+this._width+" x "+this._height)}return _createClass(i,[{key:"destroy",value:function(){this._scene.root.destroyView(this._view)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isWindowSize=!1}},{key:"update",value:function(e){var t=0<arguments.length&&void 0!==e&&e;if(this._node){if((this._node.hasChangedFlags||t)&&(Mat4.invert(this._matView,this.node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty){if(this._proj===CameraProjection.PERSPECTIVE)Mat4.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip);else{var i=this._orthoHeight*this._aspect,r=this._orthoHeight;Mat4.ortho(this._matProj,-i,i,-r,r,this._nearClip,this._farClip)}Mat4.invert(this._matProjInv,this._matProj)}(this._node.hasChangedFlags||this._isProjDirty||t)&&(Mat4.multiply(this._matViewProj,this._matProj,this._matView),Mat4.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,i){if(this._node){if(t=Math.max(t,this._nearClip),i=Math.min(i,this._farClip),Mat4.invert(this._matView,this.node.worldMatrix),this._proj===CameraProjection.PERSPECTIVE)Mat4.perspective(_tempMat1,this._fov,this._aspect,t,i);else{var r=this._orthoHeight*this._aspect,n=this._orthoHeight;Mat4.ortho(_tempMat1,-r,r,-n,n,t,i)}Mat4.multiply(_tempMat2,_tempMat1,this._matView),Mat4.invert(_tempMat1,_tempMat2),e.update(_tempMat2,_tempMat1)}}},{key:"changeTargetWindow",value:function(e){var t=0<arguments.length&&void 0!==e?e:null,i=this._scene,r=t||i.root.mainWindow;r&&(this._view.window=r,this.resize(r.width,r.height))}},{key:"screenPointToRay",value:function(e,t,i){var r=this._viewport.x*this._width,n=this._viewport.y*this._height,s=this._viewport.width*this._width,a=this._viewport.height*this._height;return Vec3.set(v_a,(t-r)/s*2-1,(i-n)/a*2-1,1),Vec3.transformMat4(v_a,v_a,this._matViewProjInv),this._proj===CameraProjection.PERSPECTIVE?this._node&&this._node.getWorldPosition(v_b):(Vec3.set(v_b,(t-r)/s*2-1,(i-n)/a*2-1,-1),Vec3.transformMat4(v_b,v_b,this._matViewProjInv)),ray.fromPoints(e,v_b,v_a)}},{key:"screenToWorld",value:function(e,t){var i=this._viewport.x*this._width,r=this._viewport.y*this._height,n=this._viewport.width*this._width,s=this._viewport.height*this._height;return this._proj===CameraProjection.PERSPECTIVE?(Vec3.set(e,(t.x-i)/n*2-1,(t.y-r)/s*2-1,1),Vec3.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(v_a),Vec3.lerp(e,v_a,e,lerp(this._nearClip/this._farClip,1,t.z))):(Vec3.set(e,(t.x-i)/n*2-1,(t.y-r)/s*2-1,2*t.z-1),Vec3.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var i=this._viewport.x*this._width,r=this._viewport.y*this._height,n=this._viewport.width*this._width,s=this._viewport.height*this._height;return Vec3.transformMat4(e,t,this.matViewProj),e.x=i+.5*(e.x+1)*n,e.y=r+.5*(e.y+1)*s,e.z=.5*e.z+.5,e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}},{key:"screenScale",set:function(e){this._screenScale=e},get:function(){return this._screenScale}},{key:"enabled",set:function(e){this._enabled=e,this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"isWindowSize",get:function(){return this._isWindowSize},set:function(e){this._isWindowSize=e}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"viewport",set:function(e){this._viewport=e},get:function(){return this._viewport}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.r=e.r,this._clearColor.g=e.g,this._clearColor.b=e.b,this._clearColor.a=e.a},get:function(){return this._clearColor}},{key:"clearDepth",set:function(e){this._clearDepth=e},get:function(){return this._clearDepth}},{key:"clearStencil",set:function(e){this._clearStencil=e},get:function(){return this._clearStencil}},{key:"clearFlag",set:function(e){this._clearFlag=e},get:function(){return this._clearFlag}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum}},{key:"forward",get:function(){return this._forward}},{key:"position",get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view.visibility=e},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view.priority},set:function(e){this._priority=e,this._view.priority=this._priority}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=FSTOPS[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=SHUTTERS[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=ISOS[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return this._exposure}},{key:"flows",set:function(e){this._view&&this._view.setExecuteFlows(e)}}]),i}(),Ambient=function(){function t(e){_classCallCheck(this,t),this._enabled=!0,this._skyColor=Float32Array.from([.2,.5,.8,1]),this._skyIllum=t.SKY_ILLUM,this._groundAlbedo=Float32Array.from([.2,.2,.2,1]),this._scene=void 0,this._scene=e}return _createClass(t,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e}},{key:"skyIllum",set:function(e){this._skyIllum=e},get:function(){return this._skyIllum}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e}}]),_createClass(t,[{key:"update",value:function(){}}]),t}();Ambient.SUN_ILLUM=65e3,Ambient.SKY_ILLUM=2e4;var _up=new Vec3(0,1,0),_v3=new Vec3,_qt=new Quat,AmbientInfo=(_dec$u=ccclass("cc.AmbientInfo"),_dec2$c=property({type:Color}),_dec3$4=property({type:Color}),_dec$u((_descriptor$n=_applyDecoratedDescriptor((_class2$p=_temp$r=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"_skyColor",_descriptor$n,this),_initializerDefineProperty(this,"_skyIllum",_descriptor2$f,this),_initializerDefineProperty(this,"_groundAlbedo",_descriptor3$9,this),this._resource=null}return _createClass(e,[{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&Color.toArray(this._resource.skyColor,this.skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&Vec3.toArray(this._resource.groundAlbedo,this.groundAlbedo)},get:function(){return this._groundAlbedo}},{key:"renderScene",set:function(e){this._resource=e.ambient,this.skyColor=this._skyColor,this.skyIllum=this._skyIllum,this.groundAlbedo=this._groundAlbedo}}]),e}()).prototype,"_skyColor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Color(51,128,204,1)}}),_descriptor2$f=_applyDecoratedDescriptor(_class2$p.prototype,"_skyIllum",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ambient.SKY_ILLUM}}),_descriptor3$9=_applyDecoratedDescriptor(_class2$p.prototype,"_groundAlbedo",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Color(51,51,51,255)}}),_applyDecoratedDescriptor(_class2$p.prototype,"skyColor",[_dec2$c],Object.getOwnPropertyDescriptor(_class2$p.prototype,"skyColor"),_class2$p.prototype),_applyDecoratedDescriptor(_class2$p.prototype,"skyIllum",[_float],Object.getOwnPropertyDescriptor(_class2$p.prototype,"skyIllum"),_class2$p.prototype),_applyDecoratedDescriptor(_class2$p.prototype,"groundAlbedo",[_dec3$4],Object.getOwnPropertyDescriptor(_class2$p.prototype,"groundAlbedo"),_class2$p.prototype),_class$u=_class2$p))||_class$u);cc.AmbientInfo=AmbientInfo;var SkyboxInfo=(_dec4$2=ccclass("cc.SkyboxInfo"),_dec5$1=property(TextureCube),_dec6$1=property({type:CCBoolean}),_dec7$1=property({type:CCBoolean}),_dec8=property({type:TextureCube}),_dec9=property({type:CCBoolean}),_dec4$2((_descriptor4$7=_applyDecoratedDescriptor((_class5$1=_temp2$1=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"_envmap",_descriptor4$7,this),_initializerDefineProperty(this,"_isRGBE",_descriptor5$5,this),_initializerDefineProperty(this,"_enabled",_descriptor6$1,this),_initializerDefineProperty(this,"_useIBL",_descriptor7$1,this),this._resource=null}return _createClass(e,[{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}},{key:"renderScene",set:function(e){this._resource=e.skybox,this.isRGBE=this._isRGBE,this.envmap=this._envmap,this.enabled=this._enabled,this.useIBL=this._useIBL}}]),e}()).prototype,"_envmap",[_dec5$1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor5$5=_applyDecoratedDescriptor(_class5$1.prototype,"_isRGBE",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor6$1=_applyDecoratedDescriptor(_class5$1.prototype,"_enabled",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor7$1=_applyDecoratedDescriptor(_class5$1.prototype,"_useIBL",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_applyDecoratedDescriptor(_class5$1.prototype,"enabled",[_dec6$1],Object.getOwnPropertyDescriptor(_class5$1.prototype,"enabled"),_class5$1.prototype),_applyDecoratedDescriptor(_class5$1.prototype,"useIBL",[_dec7$1],Object.getOwnPropertyDescriptor(_class5$1.prototype,"useIBL"),_class5$1.prototype),_applyDecoratedDescriptor(_class5$1.prototype,"envmap",[_dec8],Object.getOwnPropertyDescriptor(_class5$1.prototype,"envmap"),_class5$1.prototype),_applyDecoratedDescriptor(_class5$1.prototype,"isRGBE",[_dec9],Object.getOwnPropertyDescriptor(_class5$1.prototype,"isRGBE"),_class5$1.prototype),_class4$1=_class5$1))||_class4$1);cc.SkyboxInfo=SkyboxInfo;var PlanarShadowInfo=(_dec10=ccclass("cc.PlanarShadowInfo"),_dec11=property({type:CCBoolean}),_dec12=property({type:Vec3}),_dec13=property({type:CCFloat}),_dec14=property({type:Color}),_dec10((_descriptor8$1=_applyDecoratedDescriptor((_class8=_temp3=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"_enabled",_descriptor8$1,this),_initializerDefineProperty(this,"_normal",_descriptor9$1,this),_initializerDefineProperty(this,"_distance",_descriptor10$1,this),_initializerDefineProperty(this,"_shadowColor",_descriptor11,this),this._resource=null}return _createClass(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(_qt),this.normal=Vec3.transformQuat(_v3,_up,_qt),e.getWorldPosition(_v3),this.distance=Vec3.dot(this._normal,_v3)}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"normal",set:function(e){Vec3.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"renderScene",set:function(e){this._resource=e.planarShadows,this.normal=this._normal,this.distance=this._distance,this.shadowColor=this._shadowColor,this.enabled=this._enabled}}]),e}()).prototype,"_enabled",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor9$1=_applyDecoratedDescriptor(_class8.prototype,"_normal",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3(0,1,0)}}),_descriptor10$1=_applyDecoratedDescriptor(_class8.prototype,"_distance",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor11=_applyDecoratedDescriptor(_class8.prototype,"_shadowColor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Color(0,0,0,76)}}),_applyDecoratedDescriptor(_class8.prototype,"enabled",[_dec11],Object.getOwnPropertyDescriptor(_class8.prototype,"enabled"),_class8.prototype),_applyDecoratedDescriptor(_class8.prototype,"normal",[_dec12],Object.getOwnPropertyDescriptor(_class8.prototype,"normal"),_class8.prototype),_applyDecoratedDescriptor(_class8.prototype,"distance",[_dec13],Object.getOwnPropertyDescriptor(_class8.prototype,"distance"),_class8.prototype),_applyDecoratedDescriptor(_class8.prototype,"shadowColor",[_dec14],Object.getOwnPropertyDescriptor(_class8.prototype,"shadowColor"),_class8.prototype),_class7=_class8))||_class7);cc.PlanarShadowInfo=PlanarShadowInfo;var _dec$v,_class$v,_class2$q,_descriptor$o,_descriptor2$g,_temp$s,SceneGlobals=(_dec15=ccclass("cc.SceneGlobals"),_dec16=property({type:AmbientInfo}),_dec17=property({type:SkyboxInfo}),_dec18=property({type:PlanarShadowInfo}),_dec15((_descriptor12=_applyDecoratedDescriptor((_class11=_temp4=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"ambient",_descriptor12,this),_initializerDefineProperty(this,"skybox",_descriptor13,this),_initializerDefineProperty(this,"planarShadows",_descriptor14,this)}return _createClass(e,[{key:"renderScene",set:function(e){this.ambient.renderScene=e,this.skybox.renderScene=e,this.planarShadows.renderScene=e}}]),e}()).prototype,"ambient",[_dec16],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AmbientInfo}}),_descriptor13=_applyDecoratedDescriptor(_class11.prototype,"skybox",[_dec17],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SkyboxInfo}}),_descriptor14=_applyDecoratedDescriptor(_class11.prototype,"planarShadows",[_dec18],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new PlanarShadowInfo}}),_class10=_class11))||_class10);cc.SceneGlobals=SceneGlobals;var _dec$w,_class$w,Scene=(_dec$v=ccclass("cc.Scene"))((_descriptor$o=_applyDecoratedDescriptor((_class2$q=_temp$s=function(){function i(e){var t;return _classCallCheck(this,i),_initializerDefineProperty(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)),"autoReleaseAssets",_descriptor$o,_assertThisInitialized(t)),_initializerDefineProperty(t,"_globals",_descriptor2$g,_assertThisInitialized(t)),t._renderScene=null,t.dependAssets=null,t._inited=void 0,t._prefabSyncedInLiveReload=!1,t._pos=Vec3.ZERO,t._rot=Quat.IDENTITY,t._scale=Vec3.ONE,t._mat=Mat4.IDENTITY,t._dirtyFlags=0,t._activeInHierarchy=!1,cc.director&&cc.director.root&&(t._renderScene=cc.director.root.createScene({})),t._inited=!cc.game||!cc.game._isCloning,t}return _inherits(i,BaseNode),_createClass(i,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),_createClass(i,[{key:"destroy",value:function(){var e=_get(_getPrototypeOf(i.prototype),"destroy",this).call(this);return cc.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"addComponent",value:function(e){return warnID(3822),null}},{key:"_onHierarchyChanged",value:function(){}},{key:"_onBatchCreated",value:function(){_get(_getPrototypeOf(i.prototype),"_onBatchCreated",this).call(this);for(var e=this._children.length,t=0;t<e;++t)this._children[t]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"getPosition",value:function(e){return Vec3.copy(e||new Vec3,Vec3.ZERO)}},{key:"getRotation",value:function(e){return Quat.copy(e||new Quat,Quat.IDENTITY)}},{key:"getScale",value:function(e){return Vec3.copy(e||new Vec3,Vec3.ONE)}},{key:"getWorldPosition",value:function(e){return Vec3.copy(e||new Vec3,Vec3.ZERO)}},{key:"getWorldRotation",value:function(e){return Quat.copy(e||new Quat,Quat.IDENTITY)}},{key:"getWorldScale",value:function(e){return Vec3.copy(e||new Vec3,Vec3.ONE)}},{key:"getWorldMatrix",value:function(e){return Mat4.copy(e||new Mat4,Mat4.IDENTITY)}},{key:"getWorldRS",value:function(e){return Mat4.copy(e||new Mat4,Mat4.IDENTITY)}},{key:"getWorldRT",value:function(e){return Mat4.copy(e||new Mat4,Mat4.IDENTITY)}},{key:"updateWorldTransform",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(BaseNode._setScene)}},{key:"_activate",value:function(e){e=!1!==e,cc.director._nodeActivator.activateNode(this,e),this._globals.renderScene=this._renderScene}},{key:"position",get:function(){return Vec3.ZERO}},{key:"worldPosition",get:function(){return Vec3.ZERO}},{key:"rotation",get:function(){return Quat.IDENTITY}},{key:"worldRotation",get:function(){return Quat.IDENTITY}},{key:"scale",get:function(){return Vec3.ONE}},{key:"worldScale",get:function(){return Vec3.ONE}},{key:"eulerAngles",get:function(){return Vec3.ZERO}},{key:"worldMatrix",get:function(){return Mat4.IDENTITY}}]),i}()).prototype,"autoReleaseAssets",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2$g=_applyDecoratedDescriptor(_class2$q.prototype,"_globals",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SceneGlobals}}),_class$v=_class2$q))||_class$v;cc.Scene=Scene;var HideInHierarchy$1=CCObject.Flags.HideInHierarchy,PrivateNode=(_dec$w=ccclass("cc.PrivateNode"))(_class$w=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._objFlags|=HideInHierarchy$1,t}return _inherits(i,Node$1),i}())||_class$w;cc.PrivateNode=PrivateNode;var fastRemoveAt$2=array.fastRemoveAt,IsStartCalled$1=CCObject.Flags.IsStartCalled,IsOnEnableCalled$2=CCObject.Flags.IsOnEnableCalled,IsEditorOnEnableCalled$1=CCObject.Flags.IsEditorOnEnableCalled,callerFunctor=!1,callOnEnableInTryCatch=!1,callStartInTryCatch=!1,callUpdateInTryCatch=!1,callLateUpdateInTryCatch=!1,callOnDisableInTryCatch=!1,callStart=function(e){e.start(),e._objFlags|=IsStartCalled$1},callUpdate=function(e,t){e.update(t)},callLateUpdate=function(e,t){e.lateUpdate(t)};function sortedIndex(e,t){for(var i=t.constructor._executionOrder,r=t._id,n=0,s=e.length-1,a=s>>>1;n<=s;a=n+s>>>1){var o=e[a],c=o.constructor._executionOrder;if(i<c)s=a-1;else if(c<i)n=a+1;else{var l=o._id;if(r<l)s=a-1;else{if(!(l<r))return a;n=a+1}}}return~n}function stableRemoveInactive(e,t){for(var i=e.array,r=e.i+1;r<i.length;){var n=i[r];n._enabled&&n.node._activeInHierarchy?++r:(e.removeAt(r),t&&(n._objFlags&=~t))}}var LifeCycleInvoker=function e(t){_classCallCheck(this,e),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var i=MutableForwardIterator;this._zero=new i([]),this._neg=new i([]),this._pos=new i([]),this._invoke=t};function compareOrder(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}LifeCycleInvoker.stableRemoveInactive=stableRemoveInactive;var OneOffInvoker=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,LifeCycleInvoker),_createClass(e,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){stableRemoveInactive(this._zero,e),stableRemoveInactive(this._neg,e),stableRemoveInactive(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;0<e.array.length&&(e.array.sort(compareOrder),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;0<t.array.length&&(t.array.sort(compareOrder),this._invoke(t),t.array.length=0)}}]),e}(),ReusableInvoker=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,LifeCycleInvoker),_createClass(e,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,r=sortedIndex(i,e);r<0&&i.splice(~r,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,r=sortedIndex(i.array,e);0<=r&&i.removeAt(r)}}},{key:"invoke",value:function(e){0<this._neg.array.length&&this._invoke(this._neg,e),this._invoke(this._zero,e),0<this._pos.array.length&&this._invoke(this._pos,e)}}]),e}();function enableInEditor(e){e._objFlags&IsEditorOnEnableCalled$1||(cc.engine.emit("component-enabled",e.uuid),e._objFlags|=IsEditorOnEnableCalled$1)}function createInvokeImpl(n,e){if("function"==typeof n)return e?function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i){var r=i[e.i];n(r,t)}}:function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];n(i)}};var t="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+n+"}";return e?Function("it","dt",t):Function("it",t)}var ComponentScheduler=function(){function e(){_classCallCheck(this,e),this.startInvoker=void 0,this.updateInvoker=void 0,this.lateUpdateInvoker=void 0,this.scheduleInNextFrame=void 0,this._updating=void 0,this.unscheduleAll()}return _createClass(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new OneOffInvoker(createInvokeImpl(callStart)),this.updateInvoker=new ReusableInvoker(createInvokeImpl(callUpdate,!0)),this.lateUpdateInvoker=new ReusableInvoker(createInvokeImpl(callLateUpdate,!0)),this.scheduleInNextFrame=[],this._updating=!1}},{key:"_onEnabled",value:function(e){cc.director.getScheduler().resumeTarget(e),e._objFlags|=IsOnEnableCalled$2,this._updating?this.scheduleInNextFrame.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){cc.director.getScheduler().pauseTarget(e),e._objFlags&=~IsOnEnableCalled$2;var t=this.scheduleInNextFrame.indexOf(e);0<=t?fastRemoveAt$2(this.scheduleInNextFrame,t):(!e.start||e._objFlags&IsStartCalled$1||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&IsOnEnableCalled$2)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&IsOnEnableCalled$2&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,0<this.scheduleInNextFrame.length&&this._deferredSchedule(),this.startInvoker.invoke()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1}},{key:"_scheduleImmediate",value:function(e){!e.start||e._objFlags&IsStartCalled$1||this.startInvoker.add(e),e.update&&this.updateInvoker.add(e),e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this.scheduleInNextFrame,t=0,i=e.length;t<i;t++){var r=e[t];this._scheduleImmediate(r)}e.length=0}}]),e}();ComponentScheduler.LifeCycleInvoker=LifeCycleInvoker,ComponentScheduler.OneOffInvoker=OneOffInvoker,ComponentScheduler.createInvokeImpl=createInvokeImpl,ComponentScheduler.invokeOnEnable=function(e){var t=cc.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var r=i[e.i];if(r._enabled)r.onEnable(),r.node._activeInHierarchy&&t._onEnabled(r)}};var MAX_POOL_SIZE=4,IsPreloadStarted$1=CCObject.Flags.IsPreloadStarted,IsOnLoadStarted$1=CCObject.Flags.IsOnLoadStarted,IsOnLoadCalled$2=CCObject.Flags.IsOnLoadCalled,Deactivating$2=CCObject.Flags.Deactivating,callPreloadInTryCatch=!1,callOnLoadInTryCatch=!1,callOnDestroyInTryCatch=!1,callResetInTryCatch=!1,callOnFocusInTryCatch=!1,callOnLostFocusInTryCatch=!1,callPreload=function(e){e.__preload()},callOnLoad=function(e){e.onLoad(),e._objFlags|=IsOnLoadCalled$2},UnsortedInvoker=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,ComponentScheduler.LifeCycleInvoker),_createClass(e,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){ComponentScheduler.LifeCycleInvoker.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),e}(),invokePreload=ComponentScheduler.createInvokeImpl(callPreload),invokeOnLoad=ComponentScheduler.createInvokeImpl(callOnLoad),activateTasksPool=new Pool(MAX_POOL_SIZE);function _componentCorrupted(e,t,i){t?e._removeComponent(t):array.removeAt(e._components,i)}function _onLoadInEditor(e){e.onLoad&&!cc.engine._isPlaying&&(Editor.Selection.curActivate("node")===e.node.uuid?e.onFocusInEditor&&callOnFocusInTryCatch(e):e.onLostFocusInEditor&&callOnLostFocusInTryCatch(e));_Scene.AssetsWatcher.start(e)}activateTasksPool.get=function(){var e=this._get()||{preload:new UnsortedInvoker(invokePreload),onLoad:new ComponentScheduler.OneOffInvoker(invokeOnLoad),onEnable:new ComponentScheduler.OneOffInvoker(ComponentScheduler.invokeOnEnable)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var NodeActivator=function(){function e(){_classCallCheck(this,e),this.resetComp=void 0,this._activatingStack=void 0,this.reset()}return _createClass(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var i=activateTasksPool.get();this._activatingStack.push(i),this._activateNodeRecursively(e,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),activateTasksPool.put(i)}else{this._deactivateNodeRecursively(e);var r=this._activatingStack,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=a;o.preload.cancelInactive(IsPreloadStarted$1),o.onLoad.cancelInactive(IsOnLoadStarted$1),o.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,i,r){if(e._objFlags&IsPreloadStarted$1||(e._objFlags|=IsPreloadStarted$1,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&IsOnLoadStarted$1||(e._objFlags|=IsOnLoadStarted$1,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=IsOnLoadCalled$2):e._objFlags|=IsOnLoadCalled$2),e._enabled){if(!e.node._activeInHierarchy)return;cc.director._compScheduler.enableComp(e,r)}}},{key:"destroyComp",value:function(e){cc.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&IsOnLoadCalled$2&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,i,r){if(e._objFlags&Deactivating$2)cc.errorID(3816,e.name);else{e._activeInHierarchy=!0;for(var n=e._components.length,s=0;s<n;++s){var a=e._components[s];a instanceof cc.Component?this.activateComp(a,t,i,r):(_componentCorrupted(e,a,s),--s,--n)}e._childArrivalOrder=e._children.length;for(var o=0,c=e._children.length;o<c;++o){var l=e._children[o];l._active&&this._activateNodeRecursively(l,t,i,r)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=Deactivating$2,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var r=e._components[i];if(r._enabled&&(cc.director._compScheduler.disableComp(r),e._activeInHierarchy))return void(e._objFlags&=~Deactivating$2)}for(var n=0,s=e._children.length;n<s;++n){var a=e._children[n];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),e._activeInHierarchy))return void(e._objFlags&=~Deactivating$2)}e._onPostActivated(!1),e._objFlags&=~Deactivating$2}}]),e}();exports.replaceProperty(BaseNode.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),exports.removeProperty(Node$1.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),exports.removeProperty(Layers,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),exports.replaceProperty(Layers,"Layers",[{name:"Default",newName:"DEFAULT",target:Layers.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Layers.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Layers.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Layers.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Layers.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Layers.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Layers.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Layers.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Layers,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Layers,targetName:"Layers"}]),exports.removeProperty(Layers.Enum,"Layers.Enum",[{name:"ALWAYS"}]),exports.removeProperty(Layers.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var _vec4Array=new Float32Array(4),_v3tmp=new Vec3,_v4Zero=new Vec4(0,0,0,0),RenderPipeline=function(){function t(e){_classCallCheck(this,t),this._root=void 0,this._device=void 0,this._name="BasePipeline",this._renderObjects=[],this._renderPasses=new Map,this._flows=[],this._isHDRSupported=!1,this._isHDR=!1,this._lightMeterScale=1e4,this._shadingPass=null,this._fboCount=0,this._msaaShadingTex=null,this._msaaShadingTexView=null,this._msaaDepthStencilTex=null,this._msaaDepthStencilTexView=null,this._msaaShadingFBO=null,this._colorFmt=exports.GFXFormat.UNKNOWN,this._depthStencilFmt=exports.GFXFormat.UNKNOWN,this._shadingTextures=[],this._shadingTexViews=[],this._depthStencilTex=null,this._depthStencilTexView=null,this._shadingFBOs=[],this._shadingWidth=0,this._shadingHeight=0,this._shadingScale=1,this._curIdx=0,this._prevIdx=1,this._usePostProcess=!1,this._useMSAA=!1,this._useSMAA=!1,this._smaaPass=null,this._smaaEdgeFBO=null,this._smaaEdgeTex=null,this._smaaEdgeTexView=null,this._smaaBlendFBO=null,this._smaaBlendTex=null,this._smaaBlendTexView=null,this._quadVB=null,this._quadIB=null,this._quadIA=null,this._uboGlobal=new UBOGlobal,this._globalBindings=new Map,this._defaultTex=null,this._defaultTexView=null,this._fpScale=1/1024,this._fpScaleInv=1024,this._macros={},this._useDynamicBatching=!1,this._root=e,this._device=e.device}return _createClass(t,[{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"name",get:function(){return this._name}},{key:"renderObjects",get:function(){return this._renderObjects}},{key:"flows",get:function(){return this._flows}},{key:"usePostProcess",get:function(){return this._usePostProcess}},{key:"isHDRSupported",get:function(){return this._isHDRSupported}},{key:"isHDR",get:function(){return this._isHDR}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"lightMeterScale",set:function(e){this._lightMeterScale=e},get:function(){return this._lightMeterScale}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"curShadingTexView",get:function(){return this._shadingTexViews[this._curIdx]}},{key:"prevShadingTexView",get:function(){return this._shadingTexViews[this._prevIdx]}},{key:"curShadingFBO",get:function(){return this._shadingFBOs[this._curIdx]}},{key:"prevShadingFBO",get:function(){return this._shadingFBOs[this._prevIdx]}},{key:"msaaShadingFBO",get:function(){return this._msaaShadingFBO}},{key:"useMSAA",get:function(){return this._useMSAA}},{key:"useSMAA",get:function(){return this._useSMAA}},{key:"smaaEdgeTexView",get:function(){return this._smaaEdgeTexView}},{key:"smaaEdgeFBO",get:function(){return this._smaaEdgeFBO}},{key:"smaaBlendTexView",get:function(){return this._smaaBlendTexView}},{key:"smaaBlendFBO",get:function(){return this._smaaBlendFBO}},{key:"quadIA",get:function(){return this._quadIA}},{key:"globalBindings",get:function(){return this._globalBindings}},{key:"defaultTexture",get:function(){return this._defaultTex}},{key:"fpScale",get:function(){return this._fpScale}},{key:"fpScaleInv",get:function(){return this._fpScaleInv}},{key:"macros",get:function(){return this._macros}},{key:"defaultGlobalUBOData",get:function(){return this._uboGlobal.view}},{key:"useDynamicBatching",get:function(){return this._useDynamicBatching}}]),_createClass(t,[{key:"render",value:function(e){e.camera.update(),this.sceneCulling(e),this.updateUBOs(e);var t=e.flows,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.render(e)}}},{key:"rebuild",value:function(){this.updateMacros()}},{key:"resize",value:function(e,t){var i=Math.floor(e*this._shadingScale),r=Math.floor(t*this._shadingScale);(i>this._shadingWidth||r>this._shadingHeight)&&this.resizeFBOs(i,r);var n=this._flows,s=Array.isArray(n),a=0;for(n=s?n:n[Symbol.iterator]();;){var o;if(s){if(a>=n.length)break;o=n[a++]}else{if((a=n.next()).done)break;o=a.value}o.resize(e,t)}}},{key:"swapFBOs",value:function(){var e=this._curIdx;this._curIdx=this._prevIdx,this._prevIdx=e}},{key:"addRenderPass",value:function(e,t){t&&this._renderPasses.set(e,t)}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);return t||null}},{key:"removeRenderPass",value:function(e){this._renderPasses.delete(e)}},{key:"clearRenderPasses",value:function(){this._renderPasses.clear()}},{key:"createFlow",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._flows.push(i),this._flows.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyFlows",value:function(){var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy()}this._flows=[]}},{key:"getFlow",value:function(e){var t=this._flows,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n;if(s.name===e)return s}return null}},{key:"updateMacros",value:function(){programLib.destroyShaderByDefines(this._macros),this._macros.CC_USE_HDR=this._isHDR;var e=this._root.scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.onPipelineChange()}}},{key:"_initialize",value:function(e){if(void 0!==e.enablePostProcess?this._usePostProcess=e.enablePostProcess:this._usePostProcess=!1,this._usePostProcess&&((this._device.hasFeature(GFXFeature.FORMAT_R11G11B10F)||this._device.hasFeature(GFXFeature.TEXTURE_HALF_FLOAT)||this._device.hasFeature(GFXFeature.TEXTURE_FLOAT))&&(this._isHDRSupported=!0),this._fboCount=1,this._shadingTextures=new Array(this._fboCount),this._shadingTexViews=new Array(this._fboCount),this._shadingFBOs=new Array(this._fboCount),this._isHDR=void 0===e.enableHDR||e.enableHDR,this._useSMAA=void 0!==e.enableSMAA&&e.enableSMAA,this._useMSAA=void 0!==e.enableMSAA&&e.enableMSAA,this._useMSAA&&(this._useMSAA=this.device.hasFeature(GFXFeature.MSAA))),this._isHDR&&this._isHDRSupported&&(this._device.hasFeature(GFXFeature.COLOR_HALF_FLOAT)&&this._device.hasFeature(GFXFeature.TEXTURE_HALF_FLOAT_LINEAR)?this._device.hasFeature(GFXFeature.FORMAT_R11G11B10F)?(this._colorFmt=exports.GFXFormat.R11G11B10F,this._isHDR=!0):this._device.hasFeature(GFXFeature.TEXTURE_HALF_FLOAT)&&(this._colorFmt=exports.GFXFormat.RGBA16F,this._isHDR=!0):this._device.hasFeature(GFXFeature.COLOR_FLOAT)&&this._device.hasFeature(GFXFeature.TEXTURE_FLOAT_LINEAR)&&this._device.hasFeature(GFXFeature.TEXTURE_FLOAT)&&(this._colorFmt=exports.GFXFormat.RGBA32F,this._isHDR=!0),this._isHDR=!1),this._isHDR||(this._colorFmt=exports.GFXFormat.RGBA8),24===this._device.depthBits?8===this._device.stencilBits?this._depthStencilFmt=exports.GFXFormat.D24S8:this._depthStencilFmt=exports.GFXFormat.D24:this._depthStencilFmt=exports.GFXFormat.D16,this.updateMacros(),this._shadingScale=1,this._shadingWidth=Math.floor(this._device.nativeWidth),this._shadingHeight=Math.floor(this._device.nativeHeight),console.info("USE_POST_PROCESS: "+this._usePostProcess),this._usePostProcess&&(console.info("USE_MSAA: "+this._useMSAA),console.info("USE_SMAA: "+this._useSMAA),console.info("USE_HDR: "+this._isHDR)),console.info("SHADING_SIZE: "+this._shadingWidth+" x "+this._shadingHeight),console.info("SHADING_SCALE: "+this._shadingScale.toFixed(4)),console.info("SHADING_COLOR_FORMAT: "+GFXFormatInfos[this._colorFmt].name),console.info("SHADING_DEPTH_FORMAT: "+GFXFormatInfos[this._depthStencilFmt].name),this._shadingPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:exports.GFXLoadOp.CLEAR,storeOp:exports.GFXStoreOp.STORE,sampleCount:1,beginLayout:exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL,endLayout:exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:exports.GFXLoadOp.CLEAR,depthStoreOp:exports.GFXStoreOp.STORE,stencilLoadOp:exports.GFXLoadOp.CLEAR,stencilStoreOp:exports.GFXStoreOp.STORE,sampleCount:1,beginLayout:exports.GFXTextureLayout.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:exports.GFXTextureLayout.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),this._useMSAA&&(this._msaaShadingTex=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.COLOR_ATTACHMENT|exports.GFXTextureUsageBit.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaShadingTexView=this._device.createTextureView({texture:this._msaaShadingTex,type:exports.GFXTextureViewType.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.DEPTH_STENCIL_ATTACHMENT|exports.GFXTextureUsageBit.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaDepthStencilTexView=this._device.createTextureView({texture:this._msaaDepthStencilTex,type:exports.GFXTextureViewType.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),0<this._fboCount){this._depthStencilTex=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.DEPTH_STENCIL_ATTACHMENT|exports.GFXTextureUsageBit.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:exports.GFXTextureViewType.TV2D,format:this._depthStencilFmt});for(var t=0;t<this._fboCount;++t)this._shadingTextures[t]=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.COLOR_ATTACHMENT|exports.GFXTextureUsageBit.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._shadingTexViews[t]=this._device.createTextureView({texture:this._shadingTextures[t],type:exports.GFXTextureViewType.TV2D,format:this._colorFmt}),this._shadingFBOs[t]=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[t]],depthStencilView:this._depthStencilTexView})}if(this._useSMAA){var i=exports.GFXFormat.RGBA8;this._smaaPass=this._device.createRenderPass({colorAttachments:[{format:i,loadOp:exports.GFXLoadOp.CLEAR,storeOp:exports.GFXStoreOp.STORE,sampleCount:1,beginLayout:exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL,endLayout:exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL}]}),this._smaaEdgeTex=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.COLOR_ATTACHMENT|exports.GFXTextureUsageBit.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaEdgeTexView=this._device.createTextureView({texture:this._smaaEdgeTex,type:exports.GFXTextureViewType.TV2D,format:i}),this._smaaEdgeFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.COLOR_ATTACHMENT|exports.GFXTextureUsageBit.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaBlendTexView=this._device.createTextureView({texture:this._smaaBlendTex,type:exports.GFXTextureViewType.TV2D,format:i}),this._smaaBlendFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}return!!this.createQuadInputAssembler()&&!!this.createUBOs()}},{key:"_destroy",value:function(){this.destroyFlows(),this.clearRenderPasses(),this.destroyQuadInputAssembler(),this.destroyUBOs(),this._smaaEdgeTexView&&(this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView=null),this._smaaEdgeTex&&(this._smaaEdgeTex.destroy(),this._smaaEdgeTex=null),this._smaaEdgeFBO&&(this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO=null),this._smaaBlendTexView&&(this._smaaBlendTexView.destroy(),this._smaaBlendTexView=null),this._smaaBlendTex&&(this._smaaBlendTex.destroy(),this._smaaBlendTex=null),this._smaaBlendFBO&&(this._smaaBlendFBO.destroy(),this._smaaBlendFBO=null),this._msaaShadingTexView&&(this._msaaShadingTexView.destroy(),this._msaaShadingTexView=null),this._msaaShadingTex&&(this._msaaShadingTex.destroy(),this._msaaShadingTex=null),this._msaaDepthStencilTexView&&(this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView=null),this._msaaDepthStencilTex&&(this._msaaDepthStencilTex.destroy(),this._msaaDepthStencilTex=null),this._msaaShadingFBO&&(this._msaaShadingFBO.destroy(),this._msaaShadingFBO=null);for(var e=0;e<this._shadingTexViews.length;++e)this._shadingTexViews[e]&&this._shadingTexViews[e].destroy(),this._shadingTextures[e]&&this._shadingTextures[e].destroy(),this._shadingFBOs[e]&&this._shadingFBOs[e].destroy();this._shadingTexViews.splice(0),this._shadingTextures.splice(0),this._shadingFBOs.splice(0),this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._shadingPass&&(this._shadingPass.destroy(),this._shadingPass=null)}},{key:"resizeFBOs",value:function(e,t){this._shadingWidth=e,this._shadingHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:exports.GFXTextureViewType.TV2D,format:this._depthStencilFmt}));for(var i=0;i<this._fboCount;++i)this._shadingTextures[i].resize(e,t),this._shadingTexViews[i].destroy(),this._shadingTexViews[i].initialize({texture:this._shadingTextures[i],type:exports.GFXTextureViewType.TV2D,format:this._colorFmt}),this._shadingFBOs[i].destroy(),this._shadingFBOs[i].initialize({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[i]],depthStencilView:this._depthStencilTexView});if(this._useMSAA&&(this._msaaShadingTex.resize(e,t),this._msaaShadingTexView.destroy(),this._msaaShadingTexView.initialize({texture:this._msaaShadingTex,type:exports.GFXTextureViewType.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex.resize(e,t),this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView.initialize({texture:this._msaaDepthStencilTex,type:exports.GFXTextureViewType.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO.destroy(),this._msaaShadingFBO.initialize({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),this._useSMAA){var r=this._smaaEdgeTex.format;this._smaaEdgeTex.resize(e,t),this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView.initialize({texture:this._smaaEdgeTex,type:exports.GFXTextureViewType.TV2D,format:r}),this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex.resize(e,t),this._smaaBlendTexView.destroy(),this._smaaBlendTexView.initialize({texture:this._smaaBlendTex,type:exports.GFXTextureViewType.TV2D,format:r}),this._smaaBlendFBO.destroy(),this._smaaBlendFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}console.info("Resizing shading fbos: "+this._shadingWidth+"x"+this._shadingHeight)}},{key:"createQuadInputAssembler",value:function(){var e=4*Float32Array.BYTES_PER_ELEMENT,t=4*e;if(this._quadVB=this._device.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:t,stride:e}),!this._quadVB)return!1;var i=new Float32Array(16),r=0;i[r++]=-1,i[r++]=-1,i[r++]=0,i[r++]=0,i[r++]=1,i[r++]=-1,i[r++]=1,i[r++]=0,i[r++]=-1,i[r++]=1,i[r++]=0,i[r++]=1,i[r++]=1,i[r++]=1,i[r++]=1,i[r++]=1,this._quadVB.update(i);var n=Uint8Array.BYTES_PER_ELEMENT,s=6*n;if(this._quadIB=this._device.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:s,stride:n}),!this._quadIB)return!1;var a=new Uint8Array(6);a[0]=0,a[1]=1,a[2]=2,a[3]=1,a[4]=3,a[5]=2,this._quadIB.update(a);var o=[{name:"a_position",format:exports.GFXFormat.RG32F},{name:"a_texCoord",format:exports.GFXFormat.RG32F}];return this._quadIA=this._device.createInputAssembler({attributes:o,vertexBuffers:[this._quadVB],indexBuffer:this._quadIB}),!0}},{key:"destroyQuadInputAssembler",value:function(){this._quadVB&&(this._quadVB.destroy(),this._quadVB=null),this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadIA&&(this._quadIA.destroy(),this._quadIA=null)}},{key:"createUBOs",value:function(){if(!this._globalBindings.get(UBOGlobal.BLOCK.name)){var e=this._root.device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:UBOGlobal.SIZE});this._globalBindings.set(UBOGlobal.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:UBOGlobal.BLOCK,buffer:e})}if(!this._globalBindings.get(UBOShadow.BLOCK.name)){var t=this._root.device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:UBOShadow.SIZE});this._globalBindings.set(UBOShadow.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:UBOShadow.BLOCK,buffer:t})}return this._globalBindings.get(UNIFORM_ENVIRONMENT.name)||this._globalBindings.set(UNIFORM_ENVIRONMENT.name,{type:exports.GFXBindingType.SAMPLER,samplerInfo:UNIFORM_ENVIRONMENT}),!0}},{key:"destroyUBOs",value:function(){var e=this._globalBindings.get(UBOGlobal.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(UBOGlobal.BLOCK.name));var t=this._globalBindings.get(UBOShadow.BLOCK.name);t&&(t.buffer.destroy(),this._globalBindings.delete(UBOShadow.BLOCK.name))}},{key:"updateUBOs",value:function(e){var t=e.camera,i=t.scene,r=this._root.device,n=i.mainLight,s=i.ambient,a=this._uboGlobal.view;a[UBOGlobal.TIME_OFFSET]=this._root.cumulativeTime,a[UBOGlobal.SCREEN_SIZE_OFFSET]=r.width,a[UBOGlobal.SCREEN_SIZE_OFFSET+1]=r.height,a[UBOGlobal.SCREEN_SIZE_OFFSET+2]=1/a[UBOGlobal.SCREEN_SIZE_OFFSET],a[UBOGlobal.SCREEN_SIZE_OFFSET+3]=1/a[UBOGlobal.SCREEN_SIZE_OFFSET+1],a[UBOGlobal.SCREEN_SCALE_OFFSET]=t.width/this._shadingWidth*this._shadingScale,a[UBOGlobal.SCREEN_SCALE_OFFSET+1]=t.height/this._shadingHeight*this._shadingScale,a[UBOGlobal.SCREEN_SCALE_OFFSET+2]=1/a[UBOGlobal.SCREEN_SCALE_OFFSET],a[UBOGlobal.SCREEN_SCALE_OFFSET+3]=1/a[UBOGlobal.SCREEN_SCALE_OFFSET+1],a[UBOGlobal.NATIVE_SIZE_OFFSET]=this._shadingWidth,a[UBOGlobal.NATIVE_SIZE_OFFSET+1]=this._shadingHeight,a[UBOGlobal.NATIVE_SIZE_OFFSET+2]=1/a[UBOGlobal.NATIVE_SIZE_OFFSET],a[UBOGlobal.NATIVE_SIZE_OFFSET+3]=1/a[UBOGlobal.NATIVE_SIZE_OFFSET+1],Mat4.toArray(a,t.matView,UBOGlobal.MAT_VIEW_OFFSET),Mat4.toArray(a,t.node.worldMatrix,UBOGlobal.MAT_VIEW_INV_OFFSET),Mat4.toArray(a,t.matProj,UBOGlobal.MAT_PROJ_OFFSET),Mat4.toArray(a,t.matProjInv,UBOGlobal.MAT_PROJ_INV_OFFSET),Mat4.toArray(a,t.matViewProj,UBOGlobal.MAT_VIEW_PROJ_OFFSET),Mat4.toArray(a,t.matViewProjInv,UBOGlobal.MAT_VIEW_PROJ_INV_OFFSET),Vec3.toArray(a,t.position,UBOGlobal.CAMERA_POS_OFFSET);var o=t.exposure;if(a[UBOGlobal.EXPOSURE_OFFSET]=o,a[UBOGlobal.EXPOSURE_OFFSET+1]=1/o,a[UBOGlobal.EXPOSURE_OFFSET+2]=this._isHDR?1:0,a[UBOGlobal.EXPOSURE_OFFSET+3]=this._fpScale/o,Vec3.toArray(a,n.direction,UBOGlobal.MAIN_LIT_DIR_OFFSET),n.enabled){if(Vec3.toArray(a,n.color,UBOGlobal.MAIN_LIT_COLOR_OFFSET),n.useColorTemperature){var c=n.colorTemperatureRGB;a[UBOGlobal.MAIN_LIT_COLOR_OFFSET]*=c.x,a[UBOGlobal.MAIN_LIT_COLOR_OFFSET+1]*=c.y,a[UBOGlobal.MAIN_LIT_COLOR_OFFSET+2]*=c.z}this._isHDR?a[UBOGlobal.MAIN_LIT_COLOR_OFFSET+3]=n.illuminance*this._fpScale:a[UBOGlobal.MAIN_LIT_COLOR_OFFSET+3]=n.illuminance*o}else Vec4.toArray(a,_v4Zero,UBOGlobal.MAIN_LIT_COLOR_OFFSET);_vec4Array.set(s.skyColor),this._isHDR?_vec4Array[3]=s.skyIllum*this._fpScale:_vec4Array[3]=s.skyIllum*o,this._uboGlobal.view.set(_vec4Array,UBOGlobal.AMBIENT_SKY_OFFSET),this._uboGlobal.view.set(s.groundAlbedo,UBOGlobal.AMBIENT_GROUND_OFFSET),this._globalBindings.get(UBOGlobal.BLOCK.name).buffer.update(this._uboGlobal.view.buffer)}},{key:"sceneCulling",value:function(e){var t=e.camera,i=t.scene;this._renderObjects.splice(0);var r=i.mainLight;r&&r.enabled&&r.update();var n=i.planarShadows;n.enabled&&r.node.hasChangedFlags&&n.updateDirLight(r),i.skybox.enabled&&t.clearFlag&SKYBOX_FLAG&&this.addVisibleModel(i.skybox,t);var s=i.models,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if(a){if(o>=s.length)break;c=s[o++]}else{if((o=s.next()).done)break;c=o.value}var l=c;if(l._resetUBOUpdateFlag(),l.enabled)if(e.visibility&Layers.BitMask.UI_2D)(l.node&&e.visibility===l.node.layer||e.visibility===l.visFlags)&&(l.updateTransform(),l.updateUBOs(),this.addVisibleModel(l,t));else if(l.node&&(e.visibility&l.node.layer)===l.node.layer||e.visibility&l.visFlags){if(l.updateTransform(),l.worldBounds&&!intersect.aabb_frustum(l.worldBounds,t.frustum))continue;l.updateUBOs(),this.addVisibleModel(l,t)}}n.enabled&&n.updateCommandBuffers()}},{key:"addVisibleModel",value:function(e,t){var i=0;e.node&&(e.node.getWorldPosition(_v3tmp),Vec3.subtract(_v3tmp,_v3tmp,t.position),i=Vec3.dot(_v3tmp,t.forward)),this._renderObjects.push({model:e,depth:i})}}]),t}(),CachedArray=function(){function i(e,t){_classCallCheck(this,i),this.array=void 0,this.length=0,this.cache=void 0,this._compareFn=void 0,this.array=new Array(e),this.cache=this.array,this.length=0,this._compareFn=void 0!==t?t:function(e,t){return e-t}}return _createClass(i,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[this.length--]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.cache.fill(null),this.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e.array[t]}},{key:"append",value:function(e){var t=e,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n;this.array[this.length++]=s}}}]),i}();function opaqueCompareFn(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:e.depth-t.depth:e.hash-t.hash}function transparentCompareFn(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:t.depth-e.depth:e.hash-t.hash}var RenderQueue=function(){function t(e){_classCallCheck(this,t),this.queue=void 0,this.cmdBuffs=void 0,this.cmdBuffCount=0,this._passDesc=void 0,this._passDesc=e,this.cmdBuffs=new CachedArray(64),this.queue=new CachedArray(64,this._passDesc.sortFunc)}return _createClass(t,[{key:"clear",value:function(){this.queue.clear(),this.cmdBuffCount=0}},{key:"insertRenderPass",value:function(e,t,i){var r=e.model.getSubModel(t),n=r.passes[i],s=r.psos[i];if(s.blendState.targets[0].blend!==this._passDesc.isTransparent||!(n.phase&this._passDesc.phases))return!1;var a=0|n.priority<<16|r.priority<<8|i;return this.queue.push({hash:a,depth:e.depth,shaderId:s.shader.id,subModel:r,cmdBuff:r.commandBuffers[i]}),!0}},{key:"sort",value:function(){this.queue.sort(),this.cmdBuffCount=this.queue.length;for(var e=0;e<this.queue.length;++e)this.cmdBuffs.array[e]=this.queue.array[e].cmdBuff}}]),t}(),bufs=[],UIStage=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._uiQueue=void 0,t._uiQueue=new RenderQueue({isTransparent:!0,phases:getPhaseID("default"),sortFunc:transparentCompareFn}),t}return _inherits(i,RenderStage),_createClass(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:exports.GFXCommandBufferType.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._uiQueue.clear();var t=this._pipeline.renderObjects,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}for(var s=n,a=0;a<s.model.subModelNum;a++)for(var o=0;o<s.model.getSubModel(a).passes.length;o++)this._uiQueue.insertRenderPass(s,a,o)}this._uiQueue.sort();var c=e.window.framebuffer,l=this._cmdBuff,u=e.camera,h=u.viewport;this._renderArea.x=h.x*u.width,this._renderArea.y=h.y*u.height,this._renderArea.width=h.width*u.width,this._renderArea.height=h.height*u.height,l.begin(),l.beginRenderPass(c,this._renderArea,u.clearFlag,[u.clearColor],u.clearDepth,u.clearStencil),l.execute(this._uiQueue.cmdBuffs.array,this._uiQueue.cmdBuffCount),l.endRenderPass(),l.end(),bufs[0]=l,this._device.queue.submit(bufs)}}]),i}(),UIFlow=function(){function i(e){return _classCallCheck(this,i),_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e))}return _inherits(i,RenderFlow),_createClass(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority;var t=this._pipeline.root.mainWindow;return!(!t||!t.framebuffer)&&(this.createStage(UIStage,{name:"UIStage",priority:0,framebuffer:t.framebuffer}),!0)}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){var t=this.pipeline.defaultGlobalUBOData[UBOGlobal.EXPOSURE_OFFSET+2];this.pipeline.defaultGlobalUBOData[UBOGlobal.EXPOSURE_OFFSET+2]=0,this.pipeline.globalBindings.get(UBOGlobal.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer),_get(_getPrototypeOf(i.prototype),"render",this).call(this,e),this.pipeline.defaultGlobalUBOData[UBOGlobal.EXPOSURE_OFFSET+2]=t,this.pipeline.globalBindings.get(UBOGlobal.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer)}}]),i}();function SRGBToLinear(e){return{r:Math.pow(e.r,2.2),g:Math.pow(e.g,2.2),b:Math.pow(e.b,2.2),a:1}}var ForwardStagePriority,RenderBatchedQueue=function(){function e(){_classCallCheck(this,e),this.queue=new Set}return _createClass(e,[{key:"clear",value:function(){var e=this.queue.values(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.clear()}this.queue.clear()}},{key:"recordCommandBuffer",value:function(e){var t=this.queue.values(),i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}for(var s=n,a=!1,o=0;o<s.batches.length;++o){var c=s.batches[o];if(c.mergeCount){for(var l=0;l<c.vbs.length;++l)c.vbs[l].update(c.vbDatas[l]);c.vbIdx.update(c.vbIdxData.buffer),c.ubo.update(c.uboData.view),a||(e.bindPipelineState(c.pso),a=!0),e.bindBindingLayout(c.pso.pipelineLayout.layouts[0]),e.bindInputAssembler(c.ia),e.draw(c.ia)}}}}}]),e}(),colors=[],bufs$1=[],ForwardStage=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._opaqueQueue=void 0,t._transparentQueue=void 0,t._opaqueBatchedQueue=void 0,t._opaqueQueue=new RenderQueue({isTransparent:!1,phases:getPhaseID("default"),sortFunc:opaqueCompareFn}),t._transparentQueue=new RenderQueue({isTransparent:!0,phases:getPhaseID("default")|getPhaseID("planarShadow"),sortFunc:transparentCompareFn}),t._opaqueBatchedQueue=new RenderBatchedQueue,t}return _inherits(i,RenderStage),_createClass(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:exports.GFXCommandBufferType.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._opaqueBatchedQueue.clear(),this._opaqueQueue.clear(),this._transparentQueue.clear();for(var t=this._pipeline.renderObjects,i=0;i<t.length;++i){var r=t[i];if(r.model.isDynamicBatching)for(var n=0;n<r.model.subModels.length;++n)for(var s=r.model.subModels[n],a=s.passes,o=0;o<a.length;++o){var c=s.passes[o];if(c.batchedBuffer){var l=s.psos[o];if(l.blendState.targets[0].blend){var u=0|c.priority<<16|s.priority<<8|o;this._transparentQueue.queue.push({hash:u,depth:r.depth,shaderId:l.shader.id,subModel:s,cmdBuff:s.commandBuffers[o]})}else c.batchedBuffer.merge(s,r,l),this._opaqueBatchedQueue.queue.add(c.batchedBuffer)}}else for(var h=r.model.subModels,_=0;_<h.length;++_)for(var p=h[_],d=p.passes,f=0;f<d.length;++f){var m=p.passes[f],y=p.psos[f],v=y.blendState.targets[0].blend,g=0|m.priority<<16|p.priority<<8|f;v?this._transparentQueue.queue.push({hash:g,depth:r.depth,shaderId:y.shader.id,subModel:p,cmdBuff:p.commandBuffers[f]}):this._opaqueQueue.queue.push({hash:g,depth:r.depth,shaderId:y.shader.id,subModel:p,cmdBuff:p.commandBuffers[f]})}}this._opaqueQueue.sort(),this._transparentQueue.sort();var b=e.camera,x=this._cmdBuff,T=b.viewport;if(this._renderArea.x=T.x*b.width,this._renderArea.y=T.y*b.height,this._renderArea.width=T.width*b.width*this.pipeline.shadingScale,this._renderArea.height=T.height*b.height*this.pipeline.shadingScale,b.clearFlag&exports.GFXClearFlag.COLOR){if(colors[0]=b.clearColor,this._pipeline.isHDR){colors[0]=SRGBToLinear(colors[0]);var C=this._pipeline.fpScale/b.exposure;colors[0].r*=C,colors[0].g*=C,colors[0].b*=C}colors.length=1}this._pipeline.usePostProcess?this._pipeline.useMSAA?this._framebuffer=this._pipeline.msaaShadingFBO:this._framebuffer=this._pipeline.curShadingFBO:this._framebuffer=e.window.framebuffer;var S=b.scene.planarShadows;x.begin(),x.beginRenderPass(this._framebuffer,this._renderArea,b.clearFlag,colors,b.clearDepth,b.clearStencil),x.execute(this._opaqueQueue.cmdBuffs.array,this._opaqueQueue.cmdBuffCount),this._opaqueBatchedQueue.recordCommandBuffer(x),b.visibility&Layers.BitMask.DEFAULT&&x.execute(S.cmdBuffs.array,S.cmdBuffCount),x.execute(this._transparentQueue.cmdBuffs.array,this._transparentQueue.cmdBuffCount),x.endRenderPass(),x.end(),bufs$1[0]=x,this._device.queue.submit(bufs$1),this._pipeline.useMSAA&&this._device.blitFramebuffer(this._framebuffer,this._pipeline.curShadingFBO,this._renderArea,this._renderArea,exports.GFXFilter.POINT)}}]),i}();!function(e){e[e.FORWARD=0]="FORWARD"}(ForwardStagePriority=ForwardStagePriority||{});var ForwardFlowPriority,ForwardFlow=function(){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e))}return _inherits(t,RenderFlow),_createClass(t,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this.createStage(ForwardStage,{name:"ForwardStage",priority:ForwardStagePriority.FORWARD}),!0}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}}]),t}();!function(e){e[e.FORWARD=0]="FORWARD",e[e.UI=10]="UI"}(ForwardFlowPriority=ForwardFlowPriority||{});var RenderViewPriority,_vec4Array$1=new Float32Array(4),_sphere=sphere.create(0,0,0,1),_tempLightIndex=[],_tempLightDist=[],_tempVec3=new Vec3,ForwardPipeline=function(){function _(e){var t;return _classCallCheck(this,_),(t=_possibleConstructorReturn(this,_getPrototypeOf(_).call(this,e)))._uboLights=new UBOForwardLight,t._lightsUBO=null,t._validLights=void 0,t._lightIndexOffset=void 0,t._lightIndices=void 0,t._validLights=[],t._lightIndexOffset=[],t._lightIndices=[],t}return _inherits(_,RenderPipeline),_createClass(_,[{key:"lightsUBO",get:function(){return this._lightsUBO}}]),_createClass(_,[{key:"initialize",value:function(e){if(!this._initialize(e))return!1;if(this._name="ForwardPipeline",!this._globalBindings.get(UBOForwardLight.BLOCK.name)){var t=this._root.device.createBuffer({usage:exports.GFXBufferUsageBit.UNIFORM|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:UBOForwardLight.SIZE});if(!t)return!1;this._globalBindings.set(UBOForwardLight.BLOCK.name,{type:exports.GFXBindingType.UNIFORM_BUFFER,blockInfo:UBOForwardLight.BLOCK,buffer:t})}var i=this._root.mainWindow,r=null;return i&&(r=i.renderPass),r?(this.addRenderPass(exports.RenderPassStage.DEFAULT,r),this.createFlow(ForwardFlow,{name:PIPELINE_FLOW_FORWARD,priority:ForwardFlowPriority.FORWARD}),this._usePostProcess&&(this._useSMAA,this.createFlow(ToneMapFlow,{name:PIPELINE_FLOW_TONEMAP,priority:0})),this.createFlow(UIFlow,{name:"UIFlow",priority:ForwardFlowPriority.UI}),!0):(console.error("RenderPass of main window is null."),!1)}},{key:"destroy",value:function(){var e=this._globalBindings.get(UBOForwardLight.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(UBOForwardLight.BLOCK.name)),this._destroy()}},{key:"rebuild",value:function(){_get(_getPrototypeOf(_.prototype),"rebuild",this).call(this);var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.rebuild()}}},{key:"updateUBOs",value:function(e){_get(_getPrototypeOf(_.prototype),"updateUBOs",this).call(this,e);for(var t=e.camera.exposure,i=0;i<this._renderObjects.length;i++){this._uboLights.view.fill(0);var r=i+1<this._renderObjects.length?this._lightIndexOffset[i+1]:this._lightIndices.length;if(this._renderObjects[i].model.localBindings.get(UBOForwardLight.BLOCK.name)){for(var n=0,s=0,a=this._lightIndexOffset[i];a<r;a++){var o=this._validLights[this._lightIndices[a]];if(o&&o.enabled)switch(o.type){case LightType.SPHERE:if(n>=UBOForwardLight.MAX_SPHERE_LIGHTS)continue;var c=o;if(Vec3.toArray(_vec4Array$1,c.position),this._uboLights.view.set(_vec4Array$1,UBOForwardLight.SPHERE_LIGHT_POS_OFFSET+4*n),_vec4Array$1[0]=c.size,_vec4Array$1[1]=c.range,_vec4Array$1[2]=0,this._uboLights.view.set(_vec4Array$1,UBOForwardLight.SPHERE_LIGHT_SIZE_RANGE_OFFSET+4*n),Vec3.toArray(_vec4Array$1,o.color),o.useColorTemperature){var l=o.colorTemperatureRGB;_vec4Array$1[0]*=l.x,_vec4Array$1[1]*=l.y,_vec4Array$1[2]*=l.z}this._isHDR?_vec4Array$1[3]=c.luminance*this._fpScale*this._lightMeterScale:_vec4Array$1[3]=c.luminance*t*this._lightMeterScale,this._uboLights.view.set(_vec4Array$1,UBOForwardLight.SPHERE_LIGHT_COLOR_OFFSET+4*n),n++;break;case LightType.SPOT:if(s>=UBOForwardLight.MAX_SPOT_LIGHTS)continue;var u=o;if(Vec3.toArray(_vec4Array$1,u.position),_vec4Array$1[3]=u.size,this._uboLights.view.set(_vec4Array$1,UBOForwardLight.SPOT_LIGHT_POS_OFFSET+4*s),_vec4Array$1[0]=u.size,_vec4Array$1[1]=u.range,_vec4Array$1[2]=u.spotAngle,this._uboLights.view.set(_vec4Array$1,UBOForwardLight.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*s),Vec3.toArray(_vec4Array$1,u.direction),this._uboLights.view.set(_vec4Array$1,UBOForwardLight.SPOT_LIGHT_DIR_OFFSET+4*s),Vec3.toArray(_vec4Array$1,o.color),o.useColorTemperature){var h=o.colorTemperatureRGB;_vec4Array$1[0]*=h.x,_vec4Array$1[1]*=h.y,_vec4Array$1[2]*=h.z}this._isHDR?_vec4Array$1[3]=u.luminance*this._fpScale*this._lightMeterScale:_vec4Array$1[3]=u.luminance*t*this._lightMeterScale,this._uboLights.view.set(_vec4Array$1,UBOForwardLight.SPOT_LIGHT_COLOR_OFFSET+4*s),s++}}this._renderObjects[i].model.localBindings.get(UBOForwardLight.BLOCK.name).buffer.update(this._uboLights.view)}}}},{key:"sceneCulling",value:function(e){_get(_getPrototypeOf(_.prototype),"sceneCulling",this).call(this,e),this._validLights.splice(0);var t=e.camera.scene.sphereLights,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n;s.enabled&&(s.update(),sphere.set(_sphere,s.position.x,s.position.y,s.position.z,s.range),intersect.sphere_frustum(_sphere,e.camera.frustum)&&this._validLights.push(s))}var a=e.camera.scene.spotLights,o=Array.isArray(a),c=0;for(a=o?a:a[Symbol.iterator]();;){var l;if(o){if(c>=a.length)break;l=a[c++]}else{if((c=a.next()).done)break;l=c.value}var u=l;u.enabled&&(u.update(),sphere.set(_sphere,u.position.x,u.position.y,u.position.z,u.range),intersect.sphere_frustum(_sphere,e.camera.frustum)&&this._validLights.push(u))}this._lightIndexOffset.splice(0),this._lightIndices.splice(0);for(var h=0;h<this._renderObjects.length;h++)this._lightIndexOffset[h]=this._lightIndices.length,this._renderObjects[h].model.localBindings.get(UBOForwardLight.BLOCK.name)&&this.cullLightPerModel(this._renderObjects[h].model)}},{key:"cullLightPerModel",value:function(e){var t;_tempLightIndex.splice(0);for(var i=0;i<this._validLights.length;i++){var r=!1;switch(this._validLights[i].type){case LightType.DIRECTIONAL:r=cullDirectionalLight(this._validLights[i]);break;case LightType.SPHERE:r=cullSphereLight(this._validLights[i],e);break;case LightType.SPOT:r=cullSpotLight(this._validLights[i],e)}r||(_tempLightIndex.push(i),this._validLights[i].type===LightType.DIRECTIONAL?_tempLightDist[i]=0:_tempLightDist[i]=Vec3.distance(this._validLights[i].position,e.node.getWorldPosition(_tempVec3)))}_tempLightIndex.sort(this.sortLight),(t=this._lightIndices).push.apply(t,_tempLightIndex)}},{key:"sortLight",value:function(e,t){return _tempLightDist[e]-_tempLightDist[t]}}]),_}();!function(e){e[e.GENERAL=100]="GENERAL"}(RenderViewPriority=RenderViewPriority||{});var RenderView=function(){function i(e,t){_classCallCheck(this,i),this._root=void 0,this._name="",this._window=null,this._priority=0,this._visibility=CameraDefaultMask,this._camera=void 0,this._isEnable=!0,this._flows=[],this._root=e,this._camera=t}return _createClass(i,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"flows",get:function(){return this._flows}}],[{key:"registerCreateFunc",value:function(e){e._createViewFun=function(e,t){return new i(e,t)}}}]),_createClass(i,[{key:"initialize",value:function(e){return this._name=e.name,this.priority=e.priority,e.flows||(e.flows=["ForwardFlow","ToneMapFlow","SMAAFlow"]),this.setExecuteFlows(e.flows),!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}},{key:"setExecuteFlows",value:function(e){this.flows.length=0;var t=cc.director.root.pipeline.flows,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n;-1!==e.indexOf(s.name)&&this.flows.push(s)}}}]),i}(),_forward=new Vec3(0,0,-1),_v3$1=new Vec3,_qt$1=new Quat,DirectionalLight=function(){function n(e,t,i){var r;return _classCallCheck(this,n),(r=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this,e,t,i)))._dir=new Vec3(1,-1,-1),r._illum=65e3,r._type=LightType.DIRECTIONAL,r}return _inherits(n,Light),_createClass(n,[{key:"direction",set:function(e){this._dir=e,Vec3.normalize(this._dir,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){this._illum=e},get:function(){return this._illum}}]),_createClass(n,[{key:"update",value:function(){this._node&&(this._dir=Vec3.transformQuat(_v3$1,_forward,this._node.getWorldRotation(_qt$1)),Vec3.normalize(this._dir,this._dir))}}]),n}(),_forward$1=new Vec3(0,0,-1),_v3$2=new Vec3,_qt$2=new Quat,PlanarShadows=function(){function r(e){_classCallCheck(this,r),this._scene=void 0,this._enabled=!1,this._normal=new Vec3(0,1,0),this._distance=0,this._matLight=new Mat4,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._globalBindings=void 0,this._cmdBuffs=void 0,this._cmdBuffCount=0,this._psoRecord=new Map,this._cbRecord=new Map,this._passNormal=void 0,this._passSkinning=void 0,this._scene=e,this._globalBindings=e.root.pipeline.globalBindings.get(UBOShadow.BLOCK.name),this._cmdBuffs=new CachedArray(64);var t=EffectAsset.get("pipeline/planar-shadow"),i={CC_USE_SKINNING:selectJointsMediumType(e.root.device)};this._passNormal=Pass.createPasses(t,{techIdx:0,defines:[],states:[]})[0],this._passSkinning=Pass.createPasses(t,{techIdx:0,defines:[i],states:[]})[0]}return _createClass(r,[{key:"enabled",set:function(e){this._enabled=e,this.updateDirLight(),this._cmdBuffs.clear()},get:function(){return this._enabled}},{key:"normal",set:function(e){Vec3.copy(this._normal,e),this.updateDirLight()},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this.updateDirLight()},get:function(){return this._distance}},{key:"shadowColor",set:function(e){Color.toArray(this._data,e,UBOShadow.SHADOW_COLOR_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"matLight",get:function(){return this._matLight}},{key:"data",get:function(){return this._data}},{key:"cmdBuffs",get:function(){return this._cmdBuffs}},{key:"cmdBuffCount",get:function(){return this._cmdBuffs.length}}]),_createClass(r,[{key:"updateSphereLight",value:function(e){e.node.getWorldPosition(_v3$2);var t=this._normal,i=this._distance,r=Vec3.dot(t,_v3$2),n=_v3$2.x,s=_v3$2.y,a=_v3$2.z,o=t.x,c=t.y,l=t.z,u=this._matLight;u.m00=r-i-n*o,u.m01=-s*o,u.m02=-a*o,u.m03=-o,u.m04=-n*c,u.m05=r-i-s*c,u.m06=-a*c,u.m07=-c,u.m08=-n*l,u.m09=-s*l,u.m10=r-i-a*l,u.m11=-l,u.m12=n*i,u.m13=s*i,u.m14=a*i,u.m15=r,Mat4.toArray(this.data,this._matLight),this._globalBindings.buffer.update(this.data)}},{key:"updateDirLight",value:function(e){(0<arguments.length&&void 0!==e?e:this._scene.mainLight).node.getWorldRotation(_qt$2),Vec3.transformQuat(_v3$2,_forward$1,_qt$2);var t=this._normal,i=this._distance,r=1/Vec3.dot(t,_v3$2),n=_v3$2.x*r,s=_v3$2.y*r,a=_v3$2.z*r,o=t.x,c=t.y,l=t.z,u=this._matLight;u.m00=1-o*n,u.m01=-o*s,u.m02=-o*a,u.m03=0,u.m04=-c*n,u.m05=1-c*s,u.m06=-c*a,u.m07=0,u.m08=-l*n,u.m09=-l*s,u.m10=1-l*a,u.m11=0,u.m12=n*i,u.m13=s*i,u.m14=a*i,u.m15=1,Mat4.toArray(this.data,this._matLight,UBOShadow.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"updateCommandBuffers",value:function(){if(this._cmdBuffs.clear(),this._scene.mainLight.enabled){var e=this._scene.models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;if(n.enabled&&n.node&&n.castShadow){var s=this._psoRecord.get(n),a=!1;s||(s=this._createPSO(n),this._psoRecord.set(n,s),a=!0),n.UBOUpdated||n.updateUBOs();for(var o=0;o<n.subModelNum;o++){var c=n.getSubModel(o).inputAssembler;if(c){var l=this._cbRecord.get(c);!a&&l||((l=this._createOrReuseCommandBuffer(l)).begin(),l.bindPipelineState(s),l.bindBindingLayout(s.pipelineLayout.layouts[0]),l.bindInputAssembler(c),l.draw(c),l.end(),this._cbRecord.set(c,l)),this.cmdBuffs.push(l)}}}}}}},{key:"destroyShadowModel",value:function(e){var t=this._psoRecord.get(e);t&&(this._destroyPSO(e,t),this._psoRecord.delete(e));for(var i=0;i<e.subModelNum;i++){var r=e.getSubModel(i).inputAssembler,n=this._cbRecord.get(r);r&&n&&(n.destroy(),this._cbRecord.delete(r))}}},{key:"onPipelineChange",value:function(){for(var e=this._cbRecord.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._cbRecord.clear();for(var i=this._psoRecord.keys(),r=i.next();!r.done;)this._destroyPSO(r.value,this._psoRecord.get(r.value)),r=i.next();this._psoRecord.clear()}},{key:"destroy",value:function(){this.onPipelineChange(),this._passNormal.destroy(),this._passSkinning.destroy()}},{key:"_createPSO",value:function(e){for(var t=e instanceof SkinningModel?this._passSkinning:this._passNormal,i=e._doCreatePSO(t),r=0;r<e.subModelNum;r++)e.subModels[r].psos.push(i);return i.pipelineLayout.layouts[0].update(),i}},{key:"_destroyPSO",value:function(e,t){return(e instanceof SkinningModel?this._passSkinning:this._passNormal).destroyPipelineState(t)}},{key:"_createOrReuseCommandBuffer",value:function(e){var t=this._scene.root.device,i={allocator:t.commandAllocator,type:exports.GFXCommandBufferType.SECONDARY};return e?(e.status===exports.GFXStatus.SUCCESS&&e.destroy(),e.initialize(i)):e=t.createCommandBuffer(i),e}}]),r}();function wireframe(e){for(var t=[[0,1],[1,2],[2,0]],i=[],r={},n=0;n<e.length;n+=3)for(var s=0;s<3;++s){var a=e[n+t[s][0]],o=e[n+t[s][1]],c=o<a?o<<16|a:a<<16|o;void 0===r[c]&&(r[c]=0,i.push(a,o))}return i}function invWinding(e){for(var t=[],i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t}function toWavefrontOBJ(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==exports.GFXPrimitiveMode.TRIANGLE_LIST)return"";for(var i=e.positions,r=e.uvs,n=e.normals,s=e.indices,a=function(e){return"".concat(s[e]+1,"/").concat(s[e]+1,"/").concat(s[e]+1)},o="",c=0;c<i.length;c+=3)o+="v ".concat(i[c]*t," ").concat(i[c+1]*t," ").concat(i[c+2]*t,"\n");for(var l=0;l<r.length;l+=2)o+="vt ".concat(r[l]," ").concat(r[l+1],"\n");for(var u=0;u<n.length;u+=3)o+="vn ".concat(n[u]," ").concat(n[u+1]," ").concat(n[u+2],"\n");for(var h=0;h<s.length;h+=3)o+="f ".concat(a(h)," ").concat(a(h+1)," ").concat(a(h+2),"\n");return o}function normals(e,t){for(var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,r=new Array(2*e.length),n=0;n<e.length/3;++n){var s=3*n,a=6*n;r[0+a]=e[0+s],r[1+a]=e[1+s],r[2+a]=e[2+s],r[3+a]=e[0+s]+t[0+s]*i,r[4+a]=e[1+s]+t[1+s]*i,r[5+a]=e[2+s]+t[2+s]*i}return r}function applyDefaultGeometryOptions(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function box(e){var t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,s=(e.width||1)/2,a=(e.height||1)/2,o=(e.length||1)/2,m=[Vec3.set(c0,-s,-a,o),Vec3.set(c1,s,-a,o),Vec3.set(c2,s,a,o),Vec3.set(c3,-s,a,o),Vec3.set(c4,s,-a,-o),Vec3.set(c5,-s,-a,-o),Vec3.set(c6,-s,a,-o),Vec3.set(c7,s,a,-o)],y=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],v=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],g=[],b=[],x=[],T=[],c=new Vec3(-s,-a,-o),l=new Vec3(s,a,o),u=Math.sqrt(s*s+a*a+o*o);function h(e,t,i){var n,s,a,o,c=g.length/3,l=y[e],u=v[e];for(o=0;o<=i;o++)for(a=0;a<=t;a++)if(n=a/t,s=o/i,Vec3.lerp(temp1,m[l[0]],m[l[1]],n),Vec3.lerp(temp2,m[l[0]],m[l[2]],s),Vec3.subtract(temp3,temp2,m[l[0]]),Vec3.add(r,temp1,temp3),g.push(r.x,r.y,r.z),b.push(u[0],u[1],u[2]),x.push(n,s),a<t&&o<i){var h=t+1,_=a+o*h,p=a+(o+1)*h,d=a+1+(o+1)*h,f=a+1+o*h;T.push(c+_,c+f,c+p),T.push(c+p,c+f,c+d)}}return h(0,t,i),h(4,n,i),h(1,t,i),h(5,n,i),h(3,t,n),h(2,t,n),{positions:g,normals:b,uvs:x,indices:T,minPos:c,maxPos:l,boundingRadius:u}}var temp1=new Vec3,temp2=new Vec3,temp3=new Vec3,r=new Vec3,c0=new Vec3,c1=new Vec3,c2=new Vec3,c3=new Vec3,c4=new Vec3,c5=new Vec3,c6=new Vec3,c7=new Vec3,temp1$1=new Vec3(0,0,0),temp2$1=new Vec3(0,0,0);function cylinder(){var v=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},x=.5*b,T=e.radialSegments||32,C=e.heightSegments||1,t=void 0===e.capped||e.capped,S=e.arc||2*Math.PI,i=0;t||(0<v&&i++,0<g&&i++);var r=(T+1)*(C+1);t&&(r+=(T+1)*i+T*i);var n=T*C*2*3;t&&(n+=T*i*3);var E=new Array(n),w=new Array(3*r),A=new Array(3*r),$=new Array(2*r),s=Math.max(v,g),a=new Vec3(-s,-x,-s),o=new Vec3(s,x,s),c=Math.sqrt(s*s+x*x),O=0,D=0;return function(){for(var e=[],t=v-g,i=t*t/b*Math.sign(t),r=0;r<=C;r++){for(var n=[],s=r/C,a=s*t+g,o=0;o<=T;++o){var c=o/T,l=c*S,u=Math.sin(l),h=Math.cos(l);w[3*O]=a*u,w[3*O+1]=s*b-x,w[3*O+2]=a*h,Vec3.normalize(temp1$1,Vec3.set(temp2$1,u,-i,h)),A[3*O]=temp1$1.x,A[3*O+1]=temp1$1.y,A[3*O+2]=temp1$1.z,$[2*O]=2*(1-c)%1,$[2*O+1]=s,n.push(O),++O}e.push(n)}for(var _=0;_<C;++_)for(var p=0;p<T;++p){var d=e[_][p],f=e[_+1][p],m=e[_+1][p+1],y=e[_][p+1];E[D]=d,E[++D]=y,E[++D]=f,E[++D]=y,E[++D]=m,E[++D]=f,++D}}(),t&&(0<g&&l(!1),0<v&&l(!0)),{positions:w,normals:A,uvs:$,indices:E,minPos:a,maxPos:o,boundingRadius:c};function l(e){for(var t=e?v:g,i=e?1:-1,r=O,n=1;n<=T;++n)w[3*O]=0,w[3*O+1]=x*i,w[3*O+2]=0,A[3*O]=0,A[3*O+1]=i,A[3*O+2]=0,$[2*O]=.5,$[2*O+1]=.5,++O;for(var s=O,a=0;a<=T;++a){var o=a/T*S,c=Math.cos(o),l=Math.sin(o);w[3*O]=t*l,w[3*O+1]=x*i,w[3*O+2]=t*c,A[3*O]=0,A[3*O+1]=i,A[3*O+2]=0,$[2*O]=.5-.5*l*i,$[2*O+1]=.5+.5*c,++O}for(var u=0;u<T;++u){var h=r+u,_=s+u;e?(E[D]=_+1,E[++D]=h):(E[D]=h,E[++D]=_+1),E[++D]=_,++D}}}function cone(){return cylinder(0,0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,2<arguments.length&&void 0!==arguments[2]?arguments[2]:{})}function applyDefaultPlaneOptions(e){return(e=applyDefaultGeometryOptions(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}var temp1$2=new Vec3(0,0,0),temp2$2=new Vec3(0,0,0),temp3$1=new Vec3(0,0,0),r$1=new Vec3(0,0,0),c00=new Vec3(0,0,0),c10=new Vec3(0,0,0),c01=new Vec3(0,0,0);function plane$1(e){var t=applyDefaultPlaneOptions(e),i=t.width,r=t.length,n=t.widthSegments,s=t.lengthSegments,a=.5*i,o=.5*r,c=[],l=[],u=[],h=new Vec3(-a,0,-o),_=new Vec3(a,0,o),p=Math.sqrt(i*i+r*r);Vec3.set(c00,-a,0,o),Vec3.set(c10,a,0,o),Vec3.set(c01,-a,0,-o);for(var d=0;d<=s;d++)for(var f=0;f<=n;f++){var m=f/n,y=d/s;if(Vec3.lerp(temp1$2,c00,c10,m),Vec3.lerp(temp2$2,c00,c01,y),Vec3.subtract(temp3$1,temp2$2,c00),Vec3.add(r$1,temp1$2,temp3$1),c.push(r$1.x,r$1.y,r$1.z),t.includeUV&&l.push(m,y),f<n&&d<s){var v=n+1,g=f+d*v,b=f+(d+1)*v,x=f+1+(d+1)*v,T=f+1+d*v;u.push(g,T,b),u.push(T,x,b)}}var C={positions:c,indices:u,minPos:h,maxPos:_,boundingRadius:p};if(t.includeNormal){var S=(s+1)*(n+1),E=new Array(3*S);C.normals=E;for(var w=0;w<S;++w)E[3*w+0]=0,E[3*w+1]=1,E[3*w+2]=0}return t.includeUV&&(C.uvs=l),C}function quad(e){var t=applyDefaultGeometryOptions(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i}function sphere$1(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=void 0!==t.segments?t.segments:32,r=[],n=[],s=[],a=[],o=new Vec3(-e,-e,-e),c=new Vec3(e,e,e),l=e,u=0;u<=i;++u)for(var h=u*Math.PI/i,_=Math.sin(h),p=-Math.cos(h),d=0;d<=i;++d){var f=2*d*Math.PI/i-Math.PI/2,m=Math.sin(f)*_,y=p,v=Math.cos(f)*_,g=d/i,b=u/i;if(r.push(m*e,y*e,v*e),n.push(m,y,v),s.push(g,b),u<i&&d<i){var x=i+1,T=x*u+d,C=x*(u+1)+d,S=x*(u+1)+d+1,E=x*u+d+1;a.push(T,E,C),a.push(E,S,C)}}return{positions:r,indices:a,normals:n,uvs:s,minPos:o,maxPos:c,boundingRadius:l}}function torus(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.4,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},r=i.radialSegments||32,n=i.tubularSegments||32,s=i.arc||2*Math.PI,a=[],o=[],c=[],l=[],u=new Vec3(-e-t,-t,-e-t),h=new Vec3(e+t,t,e+t),_=e+t,p=0;p<=r;p++)for(var d=0;d<=n;d++){var f=d/n,m=p/r,y=f*s,v=m*Math.PI*2,g=(e+t*Math.cos(v))*Math.sin(y),b=t*Math.sin(v),x=(e+t*Math.cos(v))*Math.cos(y),T=Math.sin(y)*Math.cos(v),C=Math.sin(v),S=Math.cos(y)*Math.cos(v);if(a.push(g,b,x),o.push(T,C,S),c.push(f,m),d<n&&p<r){var E=n+1,w=E*p+d,A=E*(p+1)+d,$=E*(p+1)+d+1,O=E*p+d+1;l.push(w,O,A),l.push(O,$,A)}}return{positions:a,normals:o,uvs:c,indices:l,minPos:u,maxPos:h,boundingRadius:_}}var temp1$3=new Vec3(0,0,0),temp2$3=new Vec3(0,0,0);function capsule(){var v=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},y=e-v-g,b=t.sides||32,x=t.heightSegments||32,T=g/e,C=y/e,S=v/e,E=Math.floor(x*T),w=Math.floor(x*S),A=Math.floor(x*C),$=y+g-e/2,O=g-e/2,D=g-e/2,k=t.arc||2*Math.PI,R=[],I=[],F=[],P=[],i=Math.max(v,g),r=new Vec3(-i,-e/2,-i),n=new Vec3(i,e/2,i),s=e/2,M=0,L=[];return function(){for(var e=0;e<=E;++e)for(var t=e*Math.PI/E/2,i=Math.sin(t),r=-Math.cos(t),n=0;n<=b;++n){var s=2*n*Math.PI/b-Math.PI/2,a=Math.sin(s),o=Math.cos(s),c=a*i,l=r,u=o*i,h=n/b,_=e/x;if(R.push(c*g,l*g+D,u*g),I.push(c,l,u),F.push(h,_),e<E&&n<b){var p=b+1,d=p*e+n,f=p*(e+1)+n,m=p*(e+1)+n+1,y=p*e+n+1;P.push(d,y,f),P.push(y,m,f)}++M}}(),function(){for(var e=(v-g)/y,t=0;t<=A;t++){for(var i=[],r=t/A,n=r*(v-g)+g,s=0;s<=b;++s){var a=s/b,o=r*C+T,c=a*k-k/4,l=Math.sin(c),u=Math.cos(c);R.push(n*l),R.push(r*y+O),R.push(n*u),Vec3.normalize(temp1$3,Vec3.set(temp2$3,l,-e,u)),I.push(temp1$3.x),I.push(temp1$3.y),I.push(temp1$3.z),F.push(a,o),i.push(M),++M}L.push(i)}for(var h=0;h<A;++h)for(var _=0;_<b;++_){var p=L[h][_],d=L[h+1][_],f=L[h+1][_+1],m=L[h][_+1];P.push(p),P.push(m),P.push(d),P.push(m),P.push(f),P.push(d)}}(),function(){for(var e=0;e<=w;++e)for(var t=e*Math.PI/w/2+Math.PI/2,i=Math.sin(t),r=-Math.cos(t),n=0;n<=b;++n){var s=2*n*Math.PI/b-Math.PI/2,a=Math.sin(s),o=Math.cos(s),c=a*i,l=r,u=o*i,h=n/b,_=e/x+(1-S);if(R.push(c*v,l*v+$,u*v),I.push(c,l,u),F.push(h,_),e<w&&n<b){var p=b+1,d=p*e+n+L[A][b]+1,f=p*(e+1)+n+L[A][b]+1,m=p*(e+1)+n+1+L[A][b]+1,y=p*e+n+1+L[A][b]+1;P.push(d,y,f),P.push(y,m,f)}}}(),{positions:R,normals:I,uvs:F,indices:P,minPos:r,maxPos:n,boundingRadius:s}}function applyDefaultCircleOptions(e){return(e=applyDefaultGeometryOptions(e)).segments=64,e}function circle(e){var t=applyDefaultCircleOptions(e).segments,i=new Array(3*(t+1));i[0]=0,i[1]=0,i[2]=0;var r=new Array(1+2*t);r[0]=0;for(var n=2*Math.PI/t,s=0;s<t;++s){var a=n*s,o=Math.cos(a),c=Math.sin(a),l=3*(s+1);i[0+l]=o,i[1+l]=c,i[2+l]=0;var u=2*s;r[1+u]=s+1,r[1+u+1]=s+2}return 0<t&&(r[r.length-1]=1),{positions:i,indices:r,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:exports.GFXPrimitiveMode.TRIANGLE_FAN}}function translate(e,t){for(var i=t.x||0,r=t.y||0,n=t.z||0,s=Math.floor(e.positions.length/3),a=0;a<s;++a){var o=3*a,c=3*a+1,l=3*a+2;e.positions[o]=e.positions[o]+i,e.positions[c]=e.positions[c]+r,e.positions[l]=e.positions[l]+n}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=r,e.minPos.z+=n),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=r,e.maxPos.z+=n),e}function scale(e,t){for(var i=t.x||0,r=t.y||0,n=t.z||0,s=Math.floor(e.positions.length/3),a=0;a<s;++a){var o=3*a,c=3*a+1,l=3*a+2;e.positions[o]*=i,e.positions[c]*=r,e.positions[l]*=n}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=r,e.minPos.z*=n),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=r,e.maxPos.z*=n),e.boundingRadius=Math.max(Math.max(i,r),n),e}function wireframed(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==exports.GFXPrimitiveMode.TRIANGLE_LIST)return e;for(var i=[[0,1],[1,2],[2,0]],r=[],n={},s=0;s<t.length;s+=3)for(var a=0;a<3;++a){var o=t[s+i[a][0]],c=t[s+i[a][1]],l=c<o?c<<16|o:o<<16|c;void 0===n[l]&&(n[l]=0,r.push(o,c))}return e.indices=r,e.primitiveMode=exports.GFXPrimitiveMode.LINE_LIST,e}var Stage,primitives=Object.freeze({box:box,cone:cone,cylinder:cylinder,plane:plane$1,quad:quad,sphere:sphere$1,torus:torus,capsule:capsule,circle:circle,translate:translate,scale:scale,wireframed:wireframed,wireframe:wireframe,invWinding:invWinding,toWavefrontOBJ:toWavefrontOBJ,normals:normals,applyDefaultGeometryOptions:applyDefaultGeometryOptions}),skybox_mesh=null,skybox_material=null,Skybox=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e,null)))._default=builtinResMgr.get("default-cube-texture"),t._envmap=t._default,t._isRGBE=!1,t._useIBL=!1,t._globalBinding=void 0,t._scene=e,t._globalBinding=t._scene.root.pipeline.globalBindings.get(UNIFORM_ENVIRONMENT.name),skybox_material||(skybox_material=new Material).initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:t._isRGBE}}),skybox_mesh=skybox_mesh||createMesh(box({width:2,height:2,length:2})),t.initSubModel(0,skybox_mesh.renderingMesh.getSubmesh(0),skybox_material),t}return _inherits(i,Model),_createClass(i,[{key:"useIBL",set:function(e){this._useIBL=e,this._updatePipeline()},get:function(){return this._useIBL}},{key:"isRGBE",set:function(e){this._isRGBE=e,skybox_material.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this.setSubModelMaterial(0,skybox_material),this._updateGlobalBinding(),this._updatePipeline()},get:function(){return this._isRGBE}},{key:"envmap",set:function(e){var t=e||this._default;this._envmap=t,this._scene.ambient.groundAlbedo[3]=this._envmap.mipmapLevel,this._updateGlobalBinding()},get:function(){return this._envmap}}]),_createClass(i,[{key:"_updatePipeline",value:function(){var e=this._useIBL?this._isRGBE?2:1:0,t=this._scene.root.pipeline;t.macros.CC_USE_IBL!==e&&(t.macros.CC_USE_IBL=e,this._scene.onPipelineChange())}},{key:"_updateGlobalBinding",value:function(){var e=this._envmap.getGFXTextureView(),t=samplerLib.getSampler(this._device,this._envmap.getSamplerHash());this._globalBinding.sampler=t,this._globalBinding.textureView=e;var i=skybox_material;i.passes[0].bindSampler(UNIFORM_ENVIRONMENT.binding,t),i.passes[0].bindTextureView(UNIFORM_ENVIRONMENT.binding,e);var r=this._matPSORecord.get(i),n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}a.pipelineLayout.layouts[0].update()}}}]),i}(),SphereLight=function(){function n(e,t,i){var r;return _classCallCheck(this,n),(r=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this,e,t,i)))._size=.15,r._range=1,r._luminance=1700/nt2lm(r._size),r._pos=void 0,r._aabb=void 0,r._type=LightType.SPHERE,r._aabb=aabb.create(),r._pos=new Vec3,r}return _inherits(n,Light),_createClass(n,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"aabb",get:function(){return this._aabb}}]),_createClass(n,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),aabb.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range))}}]),n}(),_forward$2=new Vec3(0,0,-1),_v3$3=new Vec3,_qt$3=new Quat,_matView=new Mat4,_matProj=new Mat4,_matViewProj=new Mat4,_matViewProjInv=new Mat4,SpotLight=function(){function n(e,t,i){var r;return _classCallCheck(this,n),(r=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this,e,t,i)))._dir=new Vec3(1,-1,-1),r._size=.15,r._range=5,r._luminance=1700/nt2lm(r._size),r._spotAngle=Math.cos(Math.PI/6),r._pos=void 0,r._aabb=void 0,r._frustum=void 0,r._angle=0,r._type=LightType.SPOT,r._aabb=aabb.create(),r._frustum=frustum.create(),r._pos=new Vec3,r}return _inherits(n,Light),_createClass(n,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=.5*e,this._spotAngle=Math.cos(.5*e)}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),_createClass(n,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),this._dir=Vec3.transformQuat(_v3$3,_forward$2,this._node.getWorldRotation(_qt$3)),Vec3.normalize(this._dir,this._dir),aabb.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(_matView),Mat4.invert(_matView,_matView),Mat4.perspective(_matProj,this._angle,1,.001,this._range),Mat4.multiply(_matViewProj,_matProj,_matView),Mat4.invert(_matViewProjInv,_matViewProj),this._frustum.update(_matViewProj,_matViewProjInv))}}]),n}(),RenderScene=function(){function t(e){_classCallCheck(this,t),this._root=void 0,this._name="",this._cameras=[],this._ambient=void 0,this._skybox=void 0,this._planarShadows=void 0,this._mainLight=void 0,this._defaultMainLightNode=void 0,this._sphereLights=[],this._spotLights=[],this._models=[],this._modelId=0,this._texturePool=void 0,this._root=e,this._ambient=new Ambient(this),this._defaultMainLightNode=new Node$1("Main Light"),this._mainLight=new DirectionalLight(this,"Main Light",this._defaultMainLightNode),this._mainLight.illuminance=Ambient.SUN_ILLUM,this._mainLight.enabled=!1,this._ambient=new Ambient(this),this._skybox=new Skybox(this),this._planarShadows=new PlanarShadows(this),this._texturePool=new JointsTexturePool(e.device)}return _createClass(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"ambient",get:function(){return this._ambient}},{key:"skybox",get:function(){return this._skybox}},{key:"planarShadows",get:function(){return this._planarShadows}},{key:"defaultMainLightNode",get:function(){return this._defaultMainLightNode}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"texturePool",get:function(){return this._texturePool}},{key:"rayResultCanvas",get:function(){return resultCanvas}},{key:"rayResultModels",get:function(){return resultModels}},{key:"rayResultAll",get:function(){return resultAll}},{key:"rayResultSingleModel",get:function(){return this.rayResultSingleModel}}],[{key:"registerCreateFunc",value:function(e){e._createSceneFun=function(e){return new t(e)}}}]),_createClass(t,[{key:"initialize",value:function(e){return this._name=e.name,this._texturePool.initialize(),!0}},{key:"destroy",value:function(){this.destroyCameras(),this.destroyPointLights(),this.destroySpotLights(),this.destroyModels(),this._skybox.destroy(),this._planarShadows.destroy(),this._texturePool.destroy()}},{key:"createCamera",value:function(e){var t=new Camera(this,e);return this._cameras.push(t),t}},{key:"destroyCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return e.destroy(),void this._cameras.splice(t,1)}},{key:"destroyCameras",value:function(){var e=this._cameras,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy()}this._cameras.splice(0)}},{key:"createSphereLight",value:function(e,t){var i=new SphereLight(this,e,t);return this._sphereLights.push(i),i}},{key:"destroySphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return void this._sphereLights.splice(t,1)}},{key:"createSpotLight",value:function(e,t){var i=new SpotLight(this,e,t);return this._spotLights.push(i),i}},{key:"destroySpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return void this._spotLights.splice(t,1)}},{key:"destroyPointLights",value:function(){this._sphereLights=[]}},{key:"destroySpotLights",value:function(){this._spotLights=[]}},{key:"createModel",value:function(e,t){var i=new e(this,t);return this._models.push(i),i}},{key:"destroyModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return this._planarShadows.destroyShadowModel(e),void this._models.splice(t,1)[0].destroy()}},{key:"destroyModels",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;this._planarShadows.destroyShadowModel(n),n.destroy()}this._models=[]}},{key:"onPipelineChange",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.onPipelineChange()}this._skybox.onPipelineChange(),this._planarShadows.onPipelineChange()}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycastAll",value:function(e,t,i){var r=1<arguments.length&&void 0!==t?t:Layers.Enum.DEFAULT|Layers.Enum.UI_2D,n=2<arguments.length&&void 0!==i?i:1/0,s=this.raycastAllModels(e,r,n),a=this.raycastAllCanvas(e,r,n),o=s||a;return resultAll.length=0,o&&(Array.prototype.push.apply(resultAll,resultModels),Array.prototype.push.apply(resultAll,resultCanvas)),o}},{key:"raycastAllModels",value:function(e,t,i){var r=1<arguments.length&&void 0!==t?t:Layers.Enum.DEFAULT,n=2<arguments.length&&void 0!==i?i:1/0;pool.reset();var s=this._models,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if(a){if(o>=s.length)break;c=s[o++]}else{if((o=s.next()).done)break;c=o.value}var l=c,u=l.transform;if(u&&l.enabled&&!(l.node.layer&Layers.Enum.IGNORE_RAYCAST)&&l.node.layer&r&&l.modelBounds){Mat4.invert(m4,u.getWorldMatrix(m4)),Vec3.transformMat4(modelRay.o,e.o,m4),Vec3.normalize(modelRay.d,Vec3.transformMat4Normal(modelRay.d,e.d,m4));var h=intersect.ray_aabb(modelRay,l.modelBounds);if(!(h<=0||n<h))for(var _=0;_<l.subModelNum;++_){var p=l.getSubModel(_).subMeshData;if(p&&p.geometricInfo){var d=p.geometricInfo,f=d.positions,m=d.indices,y=d.doubleSided;narrowphase(f,m,p.primitiveMode,y,n)}if(narrowDis<n){var v=pool.add();v.node=l.node,v.distance=narrowDis*Vec3.multiply(v3$1,modelRay.d,u.worldScale).length(),resultModels[pool.length-1]=v}}}}return resultModels.length=pool.length,0<resultModels.length}},{key:"raycastSingleModel",value:function(e,t,i,r){var n=2<arguments.length&&void 0!==i?i:Layers.Enum.DEFAULT,s=3<arguments.length&&void 0!==r?r:1/0;pool.reset();var a=t,o=a.transform;if(!o||!a.enabled||a.node.layer&Layers.Enum.IGNORE_RAYCAST||!(a.node.layer&n)||!a.modelBounds)return!1;Mat4.invert(m4,o.getWorldMatrix(m4)),Vec3.transformMat4(modelRay.o,e.o,m4),Vec3.normalize(modelRay.d,Vec3.transformMat4Normal(modelRay.d,e.d,m4));var c=intersect.ray_aabb(modelRay,a.modelBounds);if(c<=0||s<c)return!1;for(var l=0;l<a.subModelNum;++l){var u=a.getSubModel(l).subMeshData;if(u&&u.geometricInfo){var h=u.geometricInfo,_=h.positions,p=h.indices,d=h.doubleSided;narrowphase(_,p,u.primitiveMode,d,s)}if(narrowDis<s){var f=pool.add();f.node=a.node,f.distance=narrowDis*Vec3.multiply(v3$1,modelRay.d,o.worldScale).length(),resultSingleModel[pool.length-1]=f}}return resultSingleModel.length=pool.length,0<resultSingleModel.length}},{key:"raycastAllCanvas",value:function(e,t,i){var r=1<arguments.length&&void 0!==t?t:Layers.Enum.UI_2D,n=2<arguments.length&&void 0!==i?i:1/0;poolUI.reset();var s=cc.director.getScene().getComponentsInChildren(cc.CanvasComponent);if(null!=s&&0<s.length)for(var a=0;a<s.length;a++){var o=s[a].node;null!=o&&o.active&&this._raycastUI2DNodeRecursiveChildren(e,o,r,n)}return resultCanvas.length=poolUI.length,0<resultCanvas.length}},{key:"_raycastUI2DNode",value:function(e,t,i,r){var n=2<arguments.length&&void 0!==i?i:Layers.Enum.UI_2D,s=3<arguments.length&&void 0!==r?r:1/0;var a=t.uiTransfromComp;if(!(null==a||t.layer&Layers.Enum.IGNORE_RAYCAST)&&t.layer&n){a.getComputeAABB(aabbUI);var o=intersect.ray_aabb(e,aabbUI);if(!(o<=0)&&o<s){var c=poolUI.add();return c.node=t,c.distance=o,c}}}},{key:"_raycastUI2DNodeRecursiveChildren",value:function(e,t,i,r){var n=2<arguments.length&&void 0!==i?i:Layers.Enum.UI_2D,s=3<arguments.length&&void 0!==r?r:1/0,a=this._raycastUI2DNode(e,t,n,s);null!=a&&(resultCanvas[poolUI.length-1]=a);var o=t.children,c=Array.isArray(o),l=0;for(o=c?o:o[Symbol.iterator]();;){var u;if(c){if(l>=o.length)break;u=o[l++]}else{if((l=o.next()).done)break;u=l.value}var h=u;null!=h&&h.active&&this._raycastUI2DNodeRecursiveChildren(e,h,n,s)}}}]),t}(),modelRay=ray.create(),v3$1=new Vec3,m4=new Mat4,narrowDis=1/0,tri=triangle.create(),pool=new RecyclePool(function(){return{node:null,distance:1/0}},8),resultModels=[],aabbUI=new aabb,poolUI=new RecyclePool(function(){return{node:null,distance:1/0}},8),resultCanvas=[],resultAll=[],resultSingleModel=[],narrowphase=function(e,t,i,r,n){if(narrowDis=4<arguments.length&&void 0!==n?n:1/0,i===exports.GFXPrimitiveMode.TRIANGLE_LIST)for(var s=t.length,a=0;a<s;a+=3){var o=3*t[a],c=3*t[a+1],l=3*t[a+2];Vec3.set(tri.a,e[o],e[1+o],e[2+o]),Vec3.set(tri.b,e[c],e[1+c],e[2+c]),Vec3.set(tri.c,e[l],e[1+l],e[2+l]);var u=intersect.ray_triangle(modelRay,tri,r);u<=0||narrowDis<u||(narrowDis=u)}else if(i===exports.GFXPrimitiveMode.TRIANGLE_STRIP)for(var h=t.length-2,_=0,p=0;p<h;p+=1){var d=3*t[p-_],f=3*t[p+_+1],m=3*t[p+2];Vec3.set(tri.a,e[d],e[1+d],e[2+d]),Vec3.set(tri.b,e[f],e[1+f],e[2+f]),Vec3.set(tri.c,e[m],e[1+m],e[2+m]),_=~_;var y=intersect.ray_triangle(modelRay,tri,r);y<=0||narrowDis<y||(narrowDis=y)}else if(i===exports.GFXPrimitiveMode.TRIANGLE_FAN){var v=t.length-1,g=3*t[0];Vec3.set(tri.a,e[g],e[1+g],e[2+g]);for(var b=1;b<v;b+=1){var x=3*t[b],T=3*t[b+1];Vec3.set(tri.b,e[x],e[1+x],e[2+x]),Vec3.set(tri.c,e[T],e[1+T],e[2+T]);var C=intersect.ray_triangle(modelRay,tri,r);C<=0||narrowDis<C||(narrowDis=C)}}},MeshBuffer=function(){function t(e){_classCallCheck(this,t),this.batcher=void 0,this.vData=null,this.iData=null,this.vb=null,this.ib=null,this.ia=null,this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1,this._vertexFormatBytes=9*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes,this._initIDataCount=1536,this._outofCallback=null,this.batcher=e}return _createClass(t,[{key:"initialize",value:function(e,t){this._outofCallback=t;var i=9*Float32Array.BYTES_PER_ELEMENT;this.vb=this.vb||this.batcher.device.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:0,stride:i});var r=Uint16Array.BYTES_PER_ELEMENT;this.ib=this.ib||this.batcher.device.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:0,stride:r}),this.ia=this.ia||this.batcher.device.createInputAssembler({attributes:e,vertexBuffers:[this.vb],indexBuffer:this.ib}),this._reallocBuffer()}},{key:"request",value:function(e,t){var i=0<arguments.length&&void 0!==e?e:4,r=1<arguments.length&&void 0!==t?t:6,n=this.byteOffset+i*this._vertexFormatBytes,s=this.indiceOffset+r;if(65535<i+this.vertexOffset)return this.batcher.autoMergeBatches(),this._outofCallback&&this._outofCallback.call(this.batcher,i,r),!1;var a=this.vData.byteLength,o=this.iData.length;if(a<n||o<s){for(;a<n||o<s;)this._initVDataCount*=2,this._initIDataCount*=2,a=4*this._initVDataCount,o=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=i,this.indiceOffset+=r,this.byteOffset=n,this.dirty=!0}},{key:"reset",value:function(){this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1}},{key:"destroy",value:function(){this.ib.destroy(),this.vb.destroy(),this.ia.destroy(),this.ib=null,this.vb=null,this.ia=null}},{key:"uploadData",value:function(){if(0!==this.byteOffset&&this.dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indiceOffset);this.byteOffset>this.vb.size&&this.vb.resize(this.byteOffset),this.vb.update(e),2*this.indiceOffset>this.ib.size&&this.ib.resize(2*this.indiceOffset),this.ib.update(t)}}},{key:"_reallocBuffer",value:function(){this._reallocVData(!0),this._reallocIData(!0)}},{key:"_reallocVData",value:function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var i=new Uint8Array(this.vData.buffer),r=0,n=t.length;r<n;r++)i[r]=t[r]}},{key:"_reallocIData",value:function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var i=this.iData,r=0,n=t.length;r<n;r++)i[r]=t[r]}}]),t}();!function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL"}(Stage=Stage||{});var StencilManager=function(){function e(){_classCallCheck(this,e),this.stage=Stage.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:exports.GFXComparisonFunc.ALWAYS,stencilMask:4294967295,writeMask:4294967295,failOp:exports.GFXStencilOp.KEEP,zFailOp:exports.GFXStencilOp.KEEP,passOp:exports.GFXStencilOp.KEEP,ref:1},this._defaultPipelineState={depthStencilState:{},rasterizerState:{},blendState:{}}}return _createClass(e,[{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(){this.stage=Stage.CLEAR}},{key:"enterLevel",value:function(){this.stage=Stage.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=Stage.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=Stage.DISABLED:this.stage=Stage.ENABLED)}},{key:"handleMaterial",value:function(e){var t=this._stencilPattern;this.stage===Stage.DISABLED?(t.stencilTest=!1,t.func=exports.GFXComparisonFunc.ALWAYS,t.failOp=exports.GFXStencilOp.KEEP,t.stencilMask=t.writeMask=4294967295,t.ref=1):(t.stencilTest=!0,this.stage===Stage.ENABLED?(t.func=exports.GFXComparisonFunc.EQUAL,t.failOp=exports.GFXStencilOp.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):this.stage===Stage.CLEAR?(t.func=exports.GFXComparisonFunc.NEVER,t.failOp=exports.GFXStencilOp.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):this.stage===Stage.ENTER_LEVEL&&(t.func=exports.GFXComparisonFunc.NEVER,t.failOp=exports.GFXStencilOp.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()));var i=e.passes[0];if(this._changed(i)){var r=this._stencilPattern;return this._defaultPipelineState.depthStencilState={stencilTestFront:r.stencilTest,stencilFuncFront:r.func,stencilReadMaskFront:r.stencilMask,stencilWriteMaskFront:r.writeMask,stencilFailOpFront:r.failOp,stencilZFailOpFront:r.zFailOp,stencilPassOpFront:r.passOp,stencilRefFront:r.ref,stencilTestBack:r.stencilTest,stencilFuncBack:r.func,stencilReadMaskBack:r.stencilMask,stencilWriteMaskBack:r.writeMask,stencilFailOpBack:r.failOp,stencilZFailOpBack:r.zFailOp,stencilPassOpBack:r.passOp,stencilRefBack:r.ref},this._defaultPipelineState.blendState=i.blendState,this._defaultPipelineState.rasterizerState=i.rasterizerState,e.overridePipelineStates(this._defaultPipelineState),!0}return!1}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"getInvertedRef",value:function(){for(var e=0,t=0;t<this._maskStack.length-1;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=Stage.DISABLED}},{key:"_changed",value:function(e){var t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}}]),e}();StencilManager.sharedManager=null,StencilManager.sharedManager=new StencilManager;var UIBatchModel=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e,null)))._subModel=void 0,t._subModel=new UISubModel,t}return _inherits(i,Model),_createClass(i,[{key:"updateTransform",value:function(){}},{key:"updateUBOs",value:function(){return!1}},{key:"initialize",value:function(e,t){this._subModel.directInitialize(e,t.material,t.pipelineState),this._subModels[0]=this._subModel}},{key:"destroy",value:function(){this._subModel.destroy()}}]),i}(),UISubModel=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this))).psos=[],e}return _inherits(t,SubModel),_createClass(t,[{key:"directInitialize",value:function(e,t,i){this._inputAssembler=e,this.psos[0]=i,this.material=t}},{key:"destroy",value:function(){0<this.commandBuffers.length&&this.commandBuffers[0].destroy()}}]),t}(),UIMaterial=function(){function e(){_classCallCheck(this,e),this._material=null,this._pass=null,this._psos=void 0,this._refCount=0,this._psos=null}return _createClass(e,[{key:"material",get:function(){return this._material}},{key:"pass",get:function(){return this._pass}}]),_createClass(e,[{key:"initialize",value:function(e){var t=this;return!!e.material&&(this._material=new Material,this._material.copy(e.material),this._pass=this._material.passes[0],this._pass.update(),this._psos=new Pool$1(function(){return t._pass.createPipelineState()},1),!0)}},{key:"increase",value:function(){return this._refCount++,this._refCount}},{key:"decrease",value:function(){return this._refCount--,0===this._refCount&&this.destroy(),this._refCount}},{key:"getPipelineState",value:function(){return this._psos.alloc()}},{key:"revertPipelineState",value:function(e){this._psos.free(e)}},{key:"destroy",value:function(){var t=this;this._psos&&this._psos.clear(function(e){t._pass.destroyPipelineState(e)}),this._material&&(this._material.destroy(),this._material=null),this._refCount=0}}]),e}(),vfmt=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RG32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA32F}],UIVertexFormat=Object.freeze({vfmt:vfmt}),UIDrawBatch=function(){function e(){_classCallCheck(this,e),this.camera=null,this.bufferBatch=null,this.model=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.pipelineState=null,this.bindingLayout=null,this.useLocalData=null}return _createClass(e,[{key:"destroy",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.bindingLayout&&(this.bindingLayout=null)}},{key:"clear",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.camera=null,this.bufferBatch=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.model=null}}]),e}(),UI=function(){function i(e){var t=this;_classCallCheck(this,i),this._root=e,this.device=void 0,this._screens=[],this._bufferBatchPool=new RecyclePool(function(){return new MeshBuffer(t)},128),this._drawBatchPool=new Pool$1(function(){return new UIDrawBatch},128),this._cmdBuff=null,this._scene=void 0,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._canvasMaterials=new Map,this._batches=void 0,this._uiModelPool=null,this._modelInUse=void 0,this._emptyMaterial=new Material,this._currMeshBuffer=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=-1,this.device=e.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new Pool$1(function(){var e=t._scene.createModel(UIBatchModel,null);return e.visFlags|=Layers.Enum.UI_3D,e},2),this._modelInUse=new CachedArray(10),this._batches=new CachedArray(64),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.update,this)}return _createClass(i,[{key:"renderScene",get:function(){return this._scene}},{key:"currBufferBatch",get:function(){return this._currMeshBuffer}}]),_createClass(i,[{key:"initialize",value:function(){return this._attributes=vfmt,this._requireBufferBatch(),this._cmdBuff=this.device.createCommandBuffer({allocator:this.device.commandAllocator,type:exports.GFXCommandBufferType.PRIMARY}),!0}},{key:"destroy",value:function(){this._destroyUIMaterials();var e=this._batches.array,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy(this)}var n=this._meshBuffers,s=Array.isArray(n),a=0;for(n=s?n:n[Symbol.iterator]();;){var o;if(s){if(a>=n.length)break;o=n[a++]}else{if((a=n.next()).done)break;o=a.value}o.destroy()}this._meshBuffers.splice(0);for(var c=this._uiMaterials.values(),l=c.next();!l.done;){l.value.destroy(),l=c.next()}this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"getRenderSceneGetter",value:function(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}},{key:"_getUIMaterial",value:function(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);var t=new UIMaterial;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}},{key:"_removeUIMaterial",value:function(e){this._uiMaterials.has(e)&&0===this._uiMaterials.get(e).decrease()&&this._uiMaterials.delete(e)}},{key:"addScreen",value:function(e){this._screens.push(e),e.camera&&(e.camera.view.visibility=Layers.BitMask.UI_2D|this._screens.length,this._canvasMaterials.set(e.camera.view.visibility,new Map)),this._screens.sort(this._screenSort)}},{key:"getScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;++i){var r=t[i];if(r.camera&&r.camera.view.visibility===e)return r}return null}},{key:"removeScreen",value:function(e){var t=this._screens.indexOf(e);if(-1!==t){if(this._screens.splice(t,1),e.camera)for(var i=this._canvasMaterials.get(e.camera.view.visibility).keys(),r=i.next();!r.done;)this._removeUIMaterial(r.value),r=i.next();for(var n,s=t;s<this._screens.length;s++)if(n=this._screens[s].camera){var a=this._canvasMaterials.get(n.view.visibility);n.view.visibility=Layers.BitMask.UI_2D|s+1,this._canvasMaterials.set(n.view.visibility,a)}}}},{key:"update",value:function(e){if(this._renderScreens(),0<this._batches.length)for(var t=this._meshBuffers,i=0;i<t.length;++i){var r=t[i];r.uploadData(),r.reset()}this.render(),this._reset()}},{key:"render",value:function(){for(var e=0,t=0;t<this._modelInUse.length;t++)this._modelInUse.get(t).enabled=!1,this._uiModelPool.free(this._modelInUse.get(t));if(this._modelInUse.clear(),this._batches.length)for(var i=0;i<this._batches.length;++i){var r=this._batches.array[i];if(r.model){if(r.camera){var n=r.camera.view.visibility;r.model.visFlags=n,r.model.node.layer=n}for(var s=0;s<r.model.subModelNum;s++)r.model.getSubModel(s).priority=e++}else{var a=r.bindingLayout;a.bindTextureView(UniformBinding.CUSTOM_SAMPLER_BINDING_START_POINT,r.texView),a.update();var o=r.bufferBatch.ia;o.firstIndex=r.firstIdx,o.indexCount=r.idxCount;var c=this._uiModelPool.alloc();c.initialize(o,r),c.enabled=!0,c.getSubModel(0).priority=e++,r.camera&&(c.visFlags=r.camera.view.visibility,null==this._canvasMaterials.get(r.camera.view.visibility).get(r.material.hash)&&(this._uiMaterials.get(r.material.hash).increase(),this._canvasMaterials.get(r.camera.view.visibility).set(r.material.hash,1))),this._modelInUse.push(c)}}}},{key:"commitComp",value:function(e,t,i){var r=2<arguments.length?i:void 0,n=e,s=1<arguments.length&&void 0!==t?t:null;this._currMaterial.hash===n.material.hash&&this._currTexView===s&&this._currCanvas===n.visibility||(this.autoMergeBatches(),this._currMaterial=n.material,this._currTexView=s,this._currCanvas=n.visibility),r&&r.fillBuffers(n,this)}},{key:"commitModel",value:function(e,t,i){if((this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i)&&(StencilManager.sharedManager.handleMaterial(i)&&t))for(var r=0;r<t.subModelNum;r++)t.setSubModelMaterial(r,i);var n=this.getScreen(e.visibility),s=this._drawBatchPool.alloc();s.camera=n&&n.camera,s.model=t,s.bufferBatch=null,s.material=i,s.texView=null,s.firstIdx=0,s.idxCount=0,s.pipelineState=null,s.bindingLayout=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=e.visibility,this._batches.push(s)}},{key:"autoMergeBatches",value:function(){var e=this._currMaterial,t=this._currMeshBuffer,i=t.indiceStart,r=t.indiceOffset-i;if(r&&e){var n=this.getScreen(this._currCanvas);StencilManager.sharedManager.handleMaterial(e);var s=this._drawBatchPool.alloc();s.camera=n&&n.camera,s.bufferBatch=this._currMeshBuffer,s.material=e,s.texView=this._currTexView,s.firstIdx=i,s.idxCount=r,s.pipelineState=this._getUIMaterial(e).getPipelineState(),s.bindingLayout=s.pipelineState.pipelineLayout.layouts[0],this._batches.push(s),t.vertexStart=t.vertexOffset,t.indiceStart=t.indiceOffset,t.byteStart=t.byteOffset}}},{key:"forceMergeBatches",value:function(e,t){this._currMaterial=e,this._currTexView=t,this.autoMergeBatches()}},{key:"_deleteUIMaterial",value:function(e){this._uiMaterials.has(e.hash)&&(this._uiMaterials.get(e.hash).destroy(),this._uiMaterials.delete(e.hash))}},{key:"_destroyUIMaterials",value:function(){for(var e=this._uiMaterials.values(),t=e.next();!t.done;){t.value.destroy(),t=e.next()}this._uiMaterials.clear()}},{key:"_walk",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0,r=e.children.length;if(this._preprocess(e),0<r)for(var n=e.children,s=0;s<n.length;++s){var a=n[s];this._walk(a,i)}this._postprocess(e),i+=1}},{key:"_renderScreens",value:function(){for(var e=this._screens,t=0;t<e.length;++t){var i=e[t];i.enabledInHierarchy&&this._recursiveScreenNode(i.node)}}},{key:"_preprocess",value:function(e){var t=e._uiComp;t&&t.enabledInHierarchy&&t.updateAssembler(this)}},{key:"_postprocess",value:function(e){var t=e._uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}},{key:"_recursiveScreenNode",value:function(e){this._walk(e),this.autoMergeBatches()}},{key:"_reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.clear(this),this._drawBatchPool.free(t)}this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=-1,this._currTexView=null,this._meshBufferUseCount=0,this._requireBufferBatch(),StencilManager.sharedManager.reset()}},{key:"_createMeshBuffer",value:function(){var e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}},{key:"_requireBufferBatch",value:function(e,t){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(e,t)}},{key:"_screenSort",value:function(e,t){return e.priority-t.priority}}]),i}(),Root=function(){function t(e){_classCallCheck(this,t),this._createSceneFun=void 0,this._createViewFun=void 0,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._ui=null,this._scenes=[],this._views=[],this._time=0,this._frameTime=0,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._device=e,RenderScene.registerCreateFunc(this),RenderView.registerCreateFunc(this)}return _createClass(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",set:function(e){this._curWindow=e},get:function(){return this._curWindow}},{key:"tempWindow",set:function(e){this._tempWindow=e},get:function(){return this._tempWindow}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"ui",get:function(){return this._ui}},{key:"scenes",get:function(){return this._scenes}},{key:"views",get:function(){return this._views}},{key:"cumulativeTime",get:function(){return this._time}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",set:function(e){0<e?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0},get:function(){return this._fixedFPS}}]),_createClass(t,[{key:"initialize",value:function(e){var i=this;return!!this._device.mainWindow&&(this._mainWindow=this._device.mainWindow,this._curWindow=this._mainWindow,builtinResMgr.initBuiltinRes(this._device),this._pipeline=new ForwardPipeline(this),this._pipeline.initialize(e)?(this._ui=new UI(this),this._ui.initialize()?(cc.view.on("design-resolution-changed",function(){var e=cc.game.canvas.width,t=cc.game.canvas.height;i.resize(e,t)},this),!0):(this.destroy(),!1)):(this.destroy(),!1))}},{key:"destroy",value:function(){this.destroyViews(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null}},{key:"resize",value:function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);var i=this._windows,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;a.isOffscreen||a.resize(e,t)}this._pipeline&&this._pipeline.resize(e,t);var o=this._views,c=Array.isArray(o),l=0;for(o=c?o:o[Symbol.iterator]();;){var u;if(c){if(l>=o.length)break;u=o[l++]}else{if((l=o.next()).done)break;u=l.value}var h=u;h.camera.isWindowSize&&h.camera.resize(e,t)}}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._time=0}},{key:"frameMove",value:function(e){this._frameTime=e,++this._frameCount,this._time+=this._frameTime,this._fpsTime+=this._frameTime,1<this._fpsTime&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),this._views.sort(function(e,t){return e.priority-t.priority});var t=this._views,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n;s.isEnable&&s.window&&(s.window.isOffscreen||!s.window.isOffscreen&&s.window===this._curWindow)&&this._pipeline.render(s)}}},{key:"createWindow",value:function(e){if(this._device){var t=this._device.createWindow(e);if(t)return this._windows.push(t),t}return null}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){var e=this._windows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy()}this._windows=[]}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){var e=this._scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy()}this._scenes=[]}},{key:"createView",value:function(e){var t=this._createViewFun(this,e.camera);return t.initialize(e),this._views.push(t),t}},{key:"destroyView",value:function(e){for(var t=0;t<this._views.length;++t)if(this._views[t]===e)return this._views.splice(t,1),void e.destroy()}},{key:"destroyViews",value:function(){var e=this._views,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy()}this._views=[]}}]),t}(),MAX_POOL_SIZE$1=20,idGenerator$3=new IDGenerator("Scheduler"),ListEntry=function e(t,i,r,n){_classCallCheck(this,e),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=i,this.paused=r,this.markedForDeletion=n};ListEntry.get=function(e,t,i,r){var n=ListEntry._listEntries.pop();return n?(n.target=e,n.priority=t,n.paused=i,n.markedForDeletion=r):n=new ListEntry(e,t,i,r),n},ListEntry.put=function(e){ListEntry._listEntries.length<MAX_POOL_SIZE$1&&(e.target=null,ListEntry._listEntries.push(e))},ListEntry._listEntries=[];var HashUpdateEntry=function e(t,i,r,n){_classCallCheck(this,e),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=i,this.target=r,this.callback=n};HashUpdateEntry.get=function(e,t,i,r){var n=HashUpdateEntry._hashUpdateEntries.pop();return n?(n.list=e,n.entry=t,n.target=i,n.callback=r):n=new HashUpdateEntry(e,t,i,r),n},HashUpdateEntry.put=function(e){HashUpdateEntry._hashUpdateEntries.length<MAX_POOL_SIZE$1&&(e.list=e.entry=e.target=e.callback=null,HashUpdateEntry._hashUpdateEntries.push(e))},HashUpdateEntry._hashUpdateEntries=[];var HashTimerEntry=function e(t,i,r,n,s,a){_classCallCheck(this,e),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=i,this.timerIndex=r,this.currentTimer=n,this.currentTimerSalvaged=s,this.paused=a};HashTimerEntry.get=function(e,t,i,r,n,s){var a=HashTimerEntry._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=i,a.currentTimer=r,a.currentTimerSalvaged=n,a.paused=s):a=new HashTimerEntry(e,t,i,r,n,s),a},HashTimerEntry.put=function(e){HashTimerEntry._hashTimerEntries.length<MAX_POOL_SIZE$1&&(e.timers=e.target=e.currentTimer=null,HashTimerEntry._hashTimerEntries.push(e))},HashTimerEntry._hashTimerEntries=[];var CallbackTimer=function(){function e(){_classCallCheck(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return _createClass(e,[{key:"initWithCallback",value:function(e,t,i,r,n,s){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=r,this._delay=s,this._useDelay=0<this._delay,this._repeat=n,this._runForever=this._repeat===cc.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();CallbackTimer._timers=[],CallbackTimer.get=function(){return CallbackTimer._timers.pop()||new CallbackTimer},CallbackTimer.put=function(e){CallbackTimer._timers.length<MAX_POOL_SIZE$1&&!e._lock&&(e._scheduler=e._target=e._callback=null,CallbackTimer._timers.push(e))};var Scheduler=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=createMap(!0),e._hashForTimers=createMap(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}return _inherits(t,System),_createClass(t,null,[{key:"enableForTarget",value:function(e){var t=!1;e.uuid?t=!0:e.id&&(t=!0),t||(e.__instanceId?cc.warnID(1513):e.id=idGenerator$3.getNewId())}}]),_createClass(t,[{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,r,n,s;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,r=(i=this._updatesNegList).length;t<r;t++)(n=i[t]).paused||n.markedForDeletion||n.target.update(e);for(t=0,r=(i=this._updates0List).length;t<r;t++)(n=i[t]).paused||n.markedForDeletion||n.target.update(e);for(t=0,r=(i=this._updatesPosList).length;t<r;t++)(n=i[t]).paused||n.markedForDeletion||n.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(s=a[t],this._currentTarget=s,this._currentTargetSalvaged=!1,!s.paused)for(s.timerIndex=0;s.timerIndex<s.timers.length;++s.timerIndex)s.currentTimer=s.timers[s.timerIndex],s.currentTimerSalvaged=!1,s.currentTimer.update(e),s.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(n=i[t]).markedForDeletion?this._removeUpdateFromHash(n):t++;for(t=0,i=this._updates0List;t<i.length;)(n=i[t]).markedForDeletion?this._removeUpdateFromHash(n):t++;for(t=0,i=this._updatesPosList;t<i.length;)(n=i[t]).markedForDeletion?this._removeUpdateFromHash(n):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,r,n,s){if("function"!=typeof e){var a=e;e=t,t=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(s=!!r,r=cc.macro.REPEAT_FOREVER,n=0),cc.assertID(t,1502);var o=t.uuid||t.id;if(o){var c,l,u=this._hashForTimers[o];if(u?u.paused!==s&&cc.warnID(1511):(u=HashTimerEntry.get(null,t,0,null,null,s),this._arrayForTimers.push(u),this._hashForTimers[o]=u),null==u.timers)u.timers=[];else for(l=0;l<u.timers.length;++l)if((c=u.timers[l])&&e===c._callback)return cc.logID(1507,c.getInterval(),i),void(c._interval=i);(c=CallbackTimer.get()).initWithCallback(this,e,t,i,r,n),u.timers.push(c),this._currentTarget===u&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else cc.errorID(1510)}},{key:"scheduleUpdate",value:function(e,t,i){var r=e.uuid||e.id;if(r){var n=this._hashForUpdates[r];if(n&&n.entry){if(n.entry.priority===t)return n.entry.markedForDeletion=!1,void(n.entry.paused=i);if(this._updateHashLocked)return cc.logID(1506),n.entry.markedForDeletion=!1,void(n.entry.paused=i);this.unscheduleUpdate(e)}var s,a=ListEntry.get(e,t,i,!1);0===t?(s=this._updates0List,this._appendIn(s,a)):(s=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(s,a,t)),this._hashForUpdates[r]=HashUpdateEntry.get(s,a,e,null)}else cc.errorID(1510)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t.uuid||t.id;if(i){var r=this._hashForTimers[i];if(r)for(var n=r.timers,s=0,a=n.length;s<a;s++){var o=n[s];if(e===o._callback)return o!==r.currentTimer||r.currentTimerSalvaged||(r.currentTimerSalvaged=!0),n.splice(s,1),CallbackTimer.put(o),r.timerIndex>=s&&r.timerIndex--,void(0===n.length&&(this._currentTarget===r?this._currentTargetSalvaged=!0:this._removeHashElement(r)))}}else cc.errorID(1510)}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else cc.errorID(1510)}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i){var r=i.timers;-1<r.indexOf(i.currentTimer)&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var n=0,s=r.length;n<s;n++)CallbackTimer.put(r[n]);r.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}else cc.errorID(1510)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,r,n=this._arrayForTimers;for(t=n.length-1;0<=t;t--)i=n[t],this.unscheduleAllForTarget(i.target);var s=0;if(e<0)for(t=0;t<this._updatesNegList.length;)s=this._updatesNegList.length,(r=this._updatesNegList[t])&&r.priority>=e&&this.unscheduleUpdate(r.target),s===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)s=this._updates0List.length,(r=this._updates0List[t])&&this.unscheduleUpdate(r.target),s===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)s=this._updatesPosList.length,(r=this._updatesPosList[t])&&r.priority>=e&&this.unscheduleUpdate(r.target),s===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){cc.assertID(e,1508),cc.assertID(t,1509);var i=t.uuid||t.id;if(i){var r=this._hashForTimers[i];if(!r)return!1;if(null==r.timers)return!1;for(var n=r.timers,s=0;s<n.length;++s){if(e===n[s]._callback)return!0}return!1}cc.errorID(1510)}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,r,n,s=[],a=this._arrayForTimers;for(i=0,r=a.length;i<r;i++)(t=a[i])&&(t.paused=!0,s.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(n=this._updatesNegList[i])&&n.priority>=e&&(n.paused=!0,s.push(n.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(n=this._updates0List[i])&&(n.paused=!0,s.push(n.target));for(i=0;i<this._updatesPosList.length;i++)(n=this._updatesPosList[i])&&n.priority>=e&&(n.paused=!0,s.push(n.target));return s}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){cc.assertID(e,1503);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!0);var r=this._hashForUpdates[t];r&&(r.entry.paused=!0)}else cc.errorID(1510)}},{key:"resumeTarget",value:function(e){cc.assertID(e,1504);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!1);var r=this._hashForUpdates[t];r&&(r.entry.paused=!1)}else cc.errorID(1510)}},{key:"isTargetPaused",value:function(e){cc.assertID(e,1505);var t=e.uuid||e.id;if(!t)return cc.errorID(1510),!1;var i=this._hashForTimers[t];if(i)return i.paused;var r=this._hashForUpdates[t];return!!r&&r.entry.paused}},{key:"_removeHashElement",value:function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,r=0,n=i.length;r<n;r++)if(i[r]===e){i.splice(r,1);break}HashTimerEntry.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){for(var r=i.list,n=i.entry,s=0,a=r.length;s<a;s++)if(r[s]===n){r.splice(s,1);break}delete this._hashForUpdates[t],ListEntry.put(n),HashUpdateEntry.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var r=0;r<e.length;r++)if(i<e[r].priority)return void e.splice(r,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}]),t}();Scheduler.PRIORITY_SYSTEM=1<<31,Scheduler.PRIORITY_NON_SYSTEM=Scheduler.PRIORITY_SYSTEM+1,Scheduler.ID="scheduler",cc.Scheduler=Scheduler;var Director=function(){function n(){var e;_classCallCheck(this,n),(e=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this)))._compScheduler=void 0,e._nodeActivator=void 0,e.invalid=void 0,e._paused=void 0,e._purgeDirectorInNextLoop=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._lastUpdate=void 0,e._deltaTime=void 0,e._scheduler=void 0,e._systems=void 0,e.invalid=!1,e._paused=!1,e._purgeDirectorInNextLoop=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._lastUpdate=0,e._deltaTime=0,e._scheduler=new Scheduler,e._compScheduler=new ComponentScheduler,e._nodeActivator=new NodeActivator,e._systems=[];var t=_assertThisInitialized(e);return cc.game.on(Game.EVENT_SHOW,function(){t._lastUpdate=performance.now()}),cc.game.once(Game.EVENT_RENDERER_INITED,e.initOnRenererInited,_assertThisInitialized(e)),cc.game.once(Game.EVENT_ENGINE_INITED,e.initOnEngineInited,_assertThisInitialized(e)),e}return _inherits(n,EventTarget),_createClass(n,[{key:"initOnRenererInited",value:function(){this._root=new Root(cc.game._gfxDevice);return!!this._root.initialize({})}},{key:"initOnEngineInited",value:function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._paused=!1,this._purgeDirectorInNextLoop=!1,cc.loader.init(this),eventManager&&eventManager.setEnabled(!0),this.registerSystem(Scheduler.ID,this._scheduler,200),this.emit(n.EVENT_INIT)}},{key:"calculateDeltaTime",value:function(){var e=performance.now();this._deltaTime=(e-this._lastUpdate)/1e3,this._lastUpdate=e}},{key:"convertToGL",value:function(e){var t=cc.game.container,i=cc.view,r=t.getBoundingClientRect(),n=r.left+window.pageXOffset-t.clientLeft,s=r.top+window.pageYOffset-t.clientTop,a=i._devicePixelRatio*(e.x-n),o=i._devicePixelRatio*(s+r.height-e.y);return i._isRotated?cc.v2(i._viewportRect.width-o,a):cc.v2(a,o)}},{key:"convertToUI",value:function(e){var t=cc.game.container,i=cc.view,r=t.getBoundingClientRect(),n=r.left+window.pageXOffset-t.clientLeft,s=r.top+window.pageYOffset-t.clientTop,a=cc.v2(0,0);return i._isRotated?(a.x=n+e.y/i._devicePixelRatio,a.y=s+r.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(a.x=n+e.x*i._devicePixelRatio,a.y=s+r.height-e.y*i._devicePixelRatio),a}},{key:"end",value:function(){this._purgeDirectorInNextLoop=!0}},{key:"getWinSize",value:function(){return cc.size(cc.winSize)}},{key:"getWinSizeInPixels",value:function(){return cc.size(cc.winSize)}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeCachedData",value:function(){cc.loader.releaseAll()}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),eventManager&&eventManager.setEnabled(!1),cc.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),null!=this._root&&this._root.destroy(),this._root=null,cc.loader.releaseAll()}},{key:"reset",value:function(){this.purgeDirector(),this.emit(n.EVENT_RESET),eventManager&&eventManager.setEnabled(!0),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,i){cc.assertID(e instanceof cc.Scene,1216);var r=cc.loader._getReferenceKey(e.uuid);cc.loader.removeItem(r),e._load();for(var n=Object.keys(cc.game._persistRootNodes).map(function(e){return cc.game._persistRootNodes[e]}),s=0;s<n.length;s++){var a=n[s];a.emit(cc.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var o=e.getChildByUuid(a.uuid);if(o){var c=o.getSiblingIndex();o._destroyImmediate(),e.insertChild(a,c)}else a.parent=e}var l=this._scene;autoRelease(l&&l.autoReleaseAssets&&l.dependAssets,e.dependAssets,n),cc.isValid(l)&&l.destroy(),this._scene=null,CCObject._deferredDestroy(),t&&t(),this.emit(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,e),(this._scene=e)._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(cc.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,i){var r=this;cc.assertID(e,1205),cc.assertID(e instanceof cc.Scene,1216),e._load(),this.once(cc.Director.EVENT_AFTER_UPDATE,function(){r.runSceneImmediate(e,t,i)})}},{key:"_getSceneUuid",value:function(e){var t=cc.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(var i=0;i<t.length;i++){var r=t[i];if(r.url.endsWith(e))return r}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];cc.errorID(1206,e)}else cc.errorID(1207,e);return null}},{key:"loadScene",value:function(e,t,i){if(this._loadingScene)return cc.errorID(1208,e,this._loadingScene),!1;var r=this._getSceneUuid(e);if(r){var n=r.uuid;return this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(n,t,i),!0}return cc.errorID(1209,e),!1}},{key:"preloadScene",value:function(i,e,r){void 0===r&&(r=e,e=null);var t=this._getSceneUuid(i);if(t)this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,i),cc.loader.load({uuid:t.uuid,type:"uuid"},e,function(e,t){e&&cc.errorID(1210,i,e.message),r&&r(e,t)});else{var n='Can not preload the scene "'+i+'" because it is not in the build settings.';r(new Error(n)),cc.error("preloadScene: "+n)}}},{key:"_loadSceneByUuid",value:function(n,e,t,i){var s=1<arguments.length&&void 0!==e?e:null,a=2<arguments.length&&void 0!==t?t:null;console.time("LoadScene "+n),cc.AssetLibrary.loadAsset(n,function(e,t){console.timeEnd("LoadScene "+n);var i=director;if(i._loadingScene="",e)e="Failed to load scene: "+e,cc.error(e);else{if(t instanceof cc.SceneAsset){var r=t.scene;return r._id=t._uuid,r._name=t._name,void i.runSceneImmediate(r,a,s)}e="The asset "+n+" is not a scene",cc.error(e)}s&&s(e)})}},{key:"resume",value:function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||cc.logID(1200),this._paused=!1,this._deltaTime=0)}},{key:"setDepthTest",value:function(e){cc.Camera.main&&(cc.Camera.main.depth=!!e)}},{key:"setClearColor",value:function(e){cc.Camera.main&&(cc.Camera.main.backgroundColor=e)}},{key:"getRunningScene",value:function(){return this._scene}},{key:"getScene",value:function(){return this._scene}},{key:"getAnimationInterval",value:function(){return 1e3/cc.game.getFrameRate()}},{key:"setAnimationInterval",value:function(e){cc.game.setFrameRate(Math.round(1e3/e))}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"getCurrentTime",value:function(){return this._lastUpdate}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(Scheduler.ID,e,200))}},{key:"registerSystem",value:function(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(System.sortByPriority)}},{key:"unregisterSystem",value:function(e){array.fastRemove(this._systems,e),this._systems.sort(System.sortByPriority)}},{key:"getSystem",value:function(t){return this._systems.find(function(e){return e.id===t})}},{key:"getAnimationManager",value:function(){return this.getSystem(cc.AnimationManager.ID)}},{key:"startAnimation",value:function(){this.invalid=!1,this._lastUpdate=performance.now()}},{key:"stopAnimation",value:function(){this.invalid=!0}},{key:"mainLoop",value:function(e){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this.invalid){this.calculateDeltaTime();var t=this._deltaTime;if(!this._paused){this.emit(n.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var i=0;i<this._systems.length;++i)this._systems[i].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(n.EVENT_AFTER_UPDATE),CCObject._deferredDestroy();for(var r=0;r<this._systems.length;++r)this._systems[r].postUpdate(t)}this.emit(n.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this._root.device.present(),this.emit(n.EVENT_AFTER_DRAW),eventManager.frameUpdateListeners(),Node$1.bookOfChange.clear(),this._totalFrames++}}},{key:"root",get:function(){return this._root}}]),n}();Director.EVENT_INIT="director_init",Director.EVENT_RESET="director_reset",Director.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",Director.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",Director.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",Director.EVENT_BEFORE_UPDATE="director_before_update",Director.EVENT_AFTER_UPDATE="director_after_update",Director.EVENT_BEFORE_DRAW="director_before_draw",Director.EVENT_AFTER_DRAW="director_after_draw",Director.EVENT_BEFORE_PHYSICS="director_before_physics",Director.EVENT_AFTER_PHYSICS="director_after_physics",Director.instance=void 0;var _dec$x,_dec2$d,_dec3$5,_dec4$3,_dec5$2,_class$x,_class2$r,_descriptor$p,_descriptor2$h,_class3$c,_temp$t,_dec$y,_dec2$e,_dec3$6,_dec4$4,_dec5$3,_dec6$2,_dec7$2,_class$y,_class2$s,_descriptor$q,_descriptor2$i,_descriptor3$a,_descriptor4$8,_descriptor5$6,_descriptor6$2,_descriptor7$2,_descriptor8$2,_descriptor9$2,_descriptor10$2,_descriptor11$1,_descriptor12$1,_descriptor13$1,_descriptor14$1,_class3$d,_temp$u,director=(cc.Director=Director).instance=cc.director=new Director,_vec2a=new Vec2,_vec2b=new Vec2,_mat4_temp=new Mat4,_matrix=new Mat4,_worldMatrix=new Mat4,_rect=new Rect,UITransformComponent=(_dec$x=ccclass("cc.UITransformComponent"),_dec2$d=executionOrder(110),_dec3$5=menu("UI/UITransform"),_dec4$3=property({displayOrder:0}),_dec5$2=property({displayOrder:1}),_dec$x(_class$x=_dec2$d(_class$x=_dec3$5(_class$x=executeInEditMode((_temp$t=_class3$c=function(){function h(){var e,t;_classCallCheck(this,h);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(h)).call.apply(e,[this].concat(r))),"_contentSize",_descriptor$p,_assertThisInitialized(t)),_initializerDefineProperty(t,"_anchorPoint",_descriptor2$h,_assertThisInitialized(t)),t}return _inherits(h,Component),_createClass(h,[{key:"__preload",value:function(){this.node.uiTransfromComp=this}},{key:"onDestroy",value:function(){this.node.uiTransfromComp=null}},{key:"setContentSize",value:function(e,t){var i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;0,i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;0,i.width=e,i.height=t}this.node.emit(exports.SystemEventType.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(exports.SystemEventType.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var i=this._contentSize.width,r=this._contentSize.height,n=_vec2a,s=_vec2b,a=-1,o=this.node.getComponent(cc.UIRenderComponent);a=o?o.visibility:this._getVisibility();var c=director.root.ui.getScreen(a);if(c){c.node.getWorldRT(_mat4_temp);var l=_mat4_temp.m12,u=_mat4_temp.m13,h=cc.visibleRect.center;if(_mat4_temp.m12=h.x-(_mat4_temp.m00*l+_mat4_temp.m04*u),_mat4_temp.m13=h.y-(_mat4_temp.m01*l+_mat4_temp.m05*u),Mat4.invert(_mat4_temp,_mat4_temp),Vec2.transformMat4(n,e,_mat4_temp),this.node.getWorldMatrix(_worldMatrix),Mat4.invert(_mat4_temp,_worldMatrix),Vec2.transformMat4(s,n,_mat4_temp),s.x+=this._anchorPoint.x*i,s.y+=this._anchorPoint.y*r,0<=s.x&&0<=s.y&&s.x<=i&&s.y<=r){if(t&&t.mask){for(var _=t.mask,p=this.node,d=0;p&&d<_.index;++d,p=p.parent);if(p!==_.node)return!(t.mask=null);var f=p.getComponent(cc.MaskComponent);return!f||!f.enabledInHierarchy||f.isHit(n)}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(_worldMatrix),Mat4.invert(_mat4_temp,_worldMatrix),t=t||new Vec3,Vec3.transformMat4(t,e,_mat4_temp)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(_worldMatrix),t=t||new Vec3,Vec3.transformMat4(t,e,_worldMatrix)}},{key:"getBoundingBox",value:function(){Mat4.fromRTS(_matrix,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new Rect(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(_matrix),i}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(_worldMatrix),this.getBoundingBoxTo(_worldMatrix)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){Mat4.fromRTS(_matrix,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,i=this._contentSize.height,r=new Rect(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i);if(Mat4.multiply(_worldMatrix,e,_matrix),r.transformMat4(_worldMatrix),!this.node.children)return r;var n=this.node.children,s=Array.isArray(n),a=0;for(n=s?n:n[Symbol.iterator]();;){var o;if(s){if(a>=n.length)break;o=n[a++]}else{if((a=n.next()).done)break;o=a.value}var c=o;if(c&&c.active){var l=c.getComponent(h);if(l){var u=l.getBoundingBoxTo(e);u&&Rect.union(r,r,u)}}}return r}},{key:"getComputeAABB",value:function(e){var t=this._contentSize.width,i=this._contentSize.height;_rect.set(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i),_rect.transformMat4(this.node.worldMatrix);var r=_rect.x+.5*_rect.width,n=_rect.y+.5*_rect.height,s=this.node.worldPosition.z,a=_rect.width/2,o=_rect.height/2;if(null==e)return new aabb(r,n,s,a,o,.001);aabb.set(e,r,n,s,a,o,.001)}},{key:"_getVisibility",value:function(){for(var e=-1,t=this.node;t;){if(t){var i=t.getComponent("cc.CanvasComponent");if(i){e=i.visibility;break}}t=t.parent}return e}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(exports.SystemEventType.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(exports.SystemEventType.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(exports.SystemEventType.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(exports.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(exports.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(exports.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}}]),h}(),_class3$c.EventType=exports.SystemEventType,_applyDecoratedDescriptor((_class2$r=_temp$t).prototype,"contentSize",[_dec4$3],Object.getOwnPropertyDescriptor(_class2$r.prototype,"contentSize"),_class2$r.prototype),_applyDecoratedDescriptor(_class2$r.prototype,"anchorPoint",[_dec5$2],Object.getOwnPropertyDescriptor(_class2$r.prototype,"anchorPoint"),_class2$r.prototype),_descriptor$p=_applyDecoratedDescriptor(_class2$r.prototype,"_contentSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Size(100,100)}}),_descriptor2$h=_applyDecoratedDescriptor(_class2$r.prototype,"_anchorPoint",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec2(.5,.5)}}),_class$x=_class2$r))||_class$x)||_class$x)||_class$x)||_class$x);cc.UITransformComponent=UITransformComponent;var _dec$z,_dec2$f,_dec3$7,_dec4$5,_dec5$4,_dec6$3,_dec7$3,_dec8$1,_dec9$1,_dec10$1,_class$z,_class2$t,_descriptor$r,_descriptor2$j,_descriptor3$b,_descriptor4$9,_descriptor5$7,_temp$v,_dec$A,_dec2$g,_class$A,_class2$u,_descriptor$s,_temp$w,ProjectionType=Enum({ORTHO:0,PERSPECTIVE:1}),CameraClearFlag=Enum({SKYBOX:SKYBOX_FLAG|exports.GFXClearFlag.DEPTH_STENCIL,SOLID_COLOR:exports.GFXClearFlag.ALL,DEPTH_ONLY:exports.GFXClearFlag.DEPTH_STENCIL,DONT_CLEAR:exports.GFXClearFlag.NONE}),CameraComponent=(_dec$y=ccclass("cc.CameraComponent"),_dec2$e=menu("Components/Camera"),_dec3$6=property({type:ProjectionType}),_dec4$4=property({type:CameraClearFlag}),_dec5$3=property({visible:!1}),_dec6$2=property({type:Layers.BitMask}),_dec7$2=property({type:RenderTexture}),_dec$y(_class$y=_dec2$e(_class$y=executeInEditMode((_temp$u=_class3$d=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_projection",_descriptor$q,_assertThisInitialized(t)),_initializerDefineProperty(t,"_priority",_descriptor2$i,_assertThisInitialized(t)),_initializerDefineProperty(t,"_fov",_descriptor3$a,_assertThisInitialized(t)),_initializerDefineProperty(t,"_orthoHeight",_descriptor4$8,_assertThisInitialized(t)),_initializerDefineProperty(t,"_near",_descriptor5$6,_assertThisInitialized(t)),_initializerDefineProperty(t,"_far",_descriptor6$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"_color",_descriptor7$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"_depth",_descriptor8$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"_stencil",_descriptor9$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"_clearFlags",_descriptor10$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"_rect",_descriptor11$1,_assertThisInitialized(t)),_initializerDefineProperty(t,"_screenScale",_descriptor12$1,_assertThisInitialized(t)),_initializerDefineProperty(t,"_visibility",_descriptor13$1,_assertThisInitialized(t)),_initializerDefineProperty(t,"_targetTexture",_descriptor14$1,_assertThisInitialized(t)),t._camera=null,t._inEditorMode=!1,t}return _inherits(s,Component),_createClass(s,[{key:"onLoad",value:function(){cc.director.on(cc.Director.EVENT_AFTER_SCENE_LAUNCH,this.onSceneChanged,this)}},{key:"onEnable",value:function(){this._camera||this._createCamera(),this._camera.enabled=!0}},{key:"onDisable",value:function(){this._camera&&(this._camera.enabled=!1)}},{key:"onDestroy",value:function(){this._camera&&(this._getRenderScene().destroyCamera(this._camera),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}},{key:"screenPointToRay",value:function(e,t,i){return i=i||ray.create(),this._camera&&this._camera.screenPointToRay(i,e,t),i}},{key:"worldToScreen",value:function(e,t){return t=t||new Vec3,this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t=t||this.node.getWorldPosition(),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"_createCamera",value:function(){var t=this;if(this.node.scene){var e=this._getRenderScene();if(!this._camera||!e.cameras.find(function(e){return e===t._camera})){if(this._camera=e.createCamera({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?cc.director.root&&cc.director.root.mainWindow:cc.director.root&&cc.director.root.tempWindow,priority:this._priority}),this._camera){this._camera.viewport=this._rect,this._camera.fov=toRadian(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far;var i=this._color.x,r=this._color.y,n=this._color.z,s=this._color.w;this._camera.clearColor={r:i,g:r,b:n,a:s},this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility}this._updateTargetTexture()}}}},{key:"onSceneChanged",value:function(e){this._camera&&this._camera.scene!==e.renderScene&&(this._createCamera(),this._camera.enabled=!0)}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)}},{key:"_updateTargetTexture",value:function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=toRadian(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor.r=e.x,this._camera.clearColor.g=e.y,this._camera.clearColor.b=e.z,this._camera.clearColor.a=e.w)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"stencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?cc.director.root&&cc.director.root.mainWindow:cc.director.root&&cc.director.root.tempWindow)}},{key:"flows",set:function(e){this._camera&&(this._camera.flows=e)}}]),s}(),_class3$d.ProjectionType=ProjectionType,_class3$d.CameraClearFlag=CameraClearFlag,_descriptor$q=_applyDecoratedDescriptor((_class2$s=_temp$u).prototype,"_projection",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ProjectionType.PERSPECTIVE}}),_descriptor2$i=_applyDecoratedDescriptor(_class2$s.prototype,"_priority",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor3$a=_applyDecoratedDescriptor(_class2$s.prototype,"_fov",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),_descriptor4$8=_applyDecoratedDescriptor(_class2$s.prototype,"_orthoHeight",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),_descriptor5$6=_applyDecoratedDescriptor(_class2$s.prototype,"_near",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor6$2=_applyDecoratedDescriptor(_class2$s.prototype,"_far",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),_descriptor7$2=_applyDecoratedDescriptor(_class2$s.prototype,"_color",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Color("#334C78")}}),_descriptor8$2=_applyDecoratedDescriptor(_class2$s.prototype,"_depth",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor9$2=_applyDecoratedDescriptor(_class2$s.prototype,"_stencil",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor10$2=_applyDecoratedDescriptor(_class2$s.prototype,"_clearFlags",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CameraClearFlag.SOLID_COLOR}}),_descriptor11$1=_applyDecoratedDescriptor(_class2$s.prototype,"_rect",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rect(0,0,1,1)}}),_descriptor12$1=_applyDecoratedDescriptor(_class2$s.prototype,"_screenScale",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor13$1=_applyDecoratedDescriptor(_class2$s.prototype,"_visibility",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CameraDefaultMask}}),_descriptor14$1=_applyDecoratedDescriptor(_class2$s.prototype,"_targetTexture",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_applyDecoratedDescriptor(_class2$s.prototype,"projection",[_dec3$6],Object.getOwnPropertyDescriptor(_class2$s.prototype,"projection"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"priority",[property],Object.getOwnPropertyDescriptor(_class2$s.prototype,"priority"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"fov",[property],Object.getOwnPropertyDescriptor(_class2$s.prototype,"fov"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"orthoHeight",[property],Object.getOwnPropertyDescriptor(_class2$s.prototype,"orthoHeight"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"near",[property],Object.getOwnPropertyDescriptor(_class2$s.prototype,"near"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"far",[property],Object.getOwnPropertyDescriptor(_class2$s.prototype,"far"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"color",[property],Object.getOwnPropertyDescriptor(_class2$s.prototype,"color"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"depth",[property],Object.getOwnPropertyDescriptor(_class2$s.prototype,"depth"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"stencil",[property],Object.getOwnPropertyDescriptor(_class2$s.prototype,"stencil"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"clearFlags",[_dec4$4],Object.getOwnPropertyDescriptor(_class2$s.prototype,"clearFlags"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"rect",[property],Object.getOwnPropertyDescriptor(_class2$s.prototype,"rect"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"screenScale",[_dec5$3],Object.getOwnPropertyDescriptor(_class2$s.prototype,"screenScale"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"visibility",[_dec6$2],Object.getOwnPropertyDescriptor(_class2$s.prototype,"visibility"),_class2$s.prototype),_applyDecoratedDescriptor(_class2$s.prototype,"targetTexture",[_dec7$2],Object.getOwnPropertyDescriptor(_class2$s.prototype,"targetTexture"),_class2$s.prototype),_class$y=_class2$s))||_class$y)||_class$y)||_class$y),_worldPos=new Vec3,CanvasClearFlag=Enum({SOLID_COLOR:exports.GFXClearFlag.ALL,DEPTH_STENCIL:exports.GFXClearFlag.DEPTH_STENCIL,NONE:exports.GFXClearFlag.NONE}),RenderMode=Enum({OVERLAY:0,INTERSPERSE:1}),CanvasComponent=(_dec$z=ccclass("cc.CanvasComponent"),_dec2$f=executionOrder(100),_dec3$7=requireComponent(UITransformComponent),_dec4$5=menu("UI/Canvas"),_dec5$4=property({type:CanvasClearFlag}),_dec6$3=property({type:RenderMode}),_dec7$3=property(),_dec8$1=property({type:RenderTexture}),_dec9$1=property({type:CanvasClearFlag}),_dec10$1=property({type:RenderMode}),_dec$z(_class$z=_dec2$f(_class$z=_dec3$7(_class$z=_dec4$5(_class$z=executeInEditMode(_class$z=disallowMultiple((_applyDecoratedDescriptor((_class2$t=_temp$v=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"_priority",_descriptor$r,_assertThisInitialized(e)),_initializerDefineProperty(e,"_targetTexture",_descriptor2$j,_assertThisInitialized(e)),_initializerDefineProperty(e,"_clearFlag",_descriptor3$b,_assertThisInitialized(e)),_initializerDefineProperty(e,"_color",_descriptor4$9,_assertThisInitialized(e)),_initializerDefineProperty(e,"_renderMode",_descriptor5$7,_assertThisInitialized(e)),e._thisOnResized=void 0,e._camera=null,e._pos=new Vec3,e._thisOnResized=e.alignWithScreen.bind(_assertThisInitialized(e)),e}return _inherits(t,Component),_createClass(t,[{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this._camera&&(this._camera.clearFlag=this._clearFlag)}},{key:"color",get:function(){return this._color},set:function(e){Color.copy(this._color,e),this._camera&&(this._camera.clearColor.r=e.r/255,this._camera.clearColor.g=e.g/255,this._camera.clearColor.b=e.b/255,this._camera.clearColor.a=e.a/255)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture()}}},{key:"visibility",get:function(){return this._camera?this._camera.view.visibility:-1}},{key:"camera",get:function(){return this._camera}}]),_createClass(t,[{key:"__preload",value:function(){var e=new Node$1("UICamera_"+this.node.name);e.setPosition(0,0,1e3),this._camera=director.root.ui.renderScene.createCamera({name:"ui_"+this.node.name,node:e,projection:CameraComponent.ProjectionType.ORTHO,priority:this._getViewPriority(),flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=this.clearFlag,this._camera.farClip=2e3,this.color=this._color;var t=director.root.device;if(this._camera.resize(t.width,t.height),this._targetTexture){var i=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(i),this._camera.setFixedSize(i.width,i.height)}view.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),director.root.ui.addScreen(this)}},{key:"onDestroy",value:function(){this._camera&&director.root.ui.renderScene.destroyCamera(this._camera),this._targetTexture&&this._targetTexture.off("resize"),view.off("design-resolution-changed",this._thisOnResized),director.root.ui.removeScreen(this)}},{key:"alignWithScreen",value:function(){var e,t;this.node.getPosition(this._pos);var i=visibleRect;e=i,t=view.getDesignResolutionSize();var r=0,n=0;if(view.getResolutionPolicy()===ResolutionPolicy.NO_BORDER&&(r=.5*(t.width-i.width),n=.5*(t.height-i.height)),Vec3.set(_worldPos,.5*i.width+r,.5*i.height+n,0),this._pos.equals(_worldPos)||this.node.setPosition(_worldPos),this.node.width!==e.width&&(this.node.width=e.width),this.node.height!==e.height&&(this.node.height=e.height),this.node.getWorldPosition(_worldPos),this._camera){var s=game.canvas;this._camera.resize(s.width,s.height),this._camera.orthoHeight=game.canvas.height/view.getScaleY()/2,this._camera.node.setPosition(_worldPos.x,_worldPos.y,1e3),this._camera.update()}}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)}},{key:"_updateTargetTexture",value:function(){if(this._camera)if(this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}else this._camera.changeTargetWindow(),this._camera.isWindowSize=!0}},{key:"_getViewPriority",value:function(){return this._renderMode===RenderMode.OVERLAY?this._priority|1<<30:this._priority}}]),t}()).prototype,"clearFlag",[_dec5$4],Object.getOwnPropertyDescriptor(_class2$t.prototype,"clearFlag"),_class2$t.prototype),_applyDecoratedDescriptor(_class2$t.prototype,"color",[property],Object.getOwnPropertyDescriptor(_class2$t.prototype,"color"),_class2$t.prototype),_applyDecoratedDescriptor(_class2$t.prototype,"renderMode",[_dec6$3],Object.getOwnPropertyDescriptor(_class2$t.prototype,"renderMode"),_class2$t.prototype),_applyDecoratedDescriptor(_class2$t.prototype,"priority",[_dec7$3],Object.getOwnPropertyDescriptor(_class2$t.prototype,"priority"),_class2$t.prototype),_applyDecoratedDescriptor(_class2$t.prototype,"targetTexture",[_dec8$1],Object.getOwnPropertyDescriptor(_class2$t.prototype,"targetTexture"),_class2$t.prototype),_descriptor$r=_applyDecoratedDescriptor(_class2$t.prototype,"_priority",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor2$j=_applyDecoratedDescriptor(_class2$t.prototype,"_targetTexture",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor3$b=_applyDecoratedDescriptor(_class2$t.prototype,"_clearFlag",[_dec9$1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CanvasClearFlag.NONE}}),_descriptor4$9=_applyDecoratedDescriptor(_class2$t.prototype,"_color",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Color(0,0,0,0)}}),_descriptor5$7=_applyDecoratedDescriptor(_class2$t.prototype,"_renderMode",[_dec10$1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RenderMode.OVERLAY}}),_class$z=_class2$t))||_class$z)||_class$z)||_class$z)||_class$z)||_class$z)||_class$z);cc.CanvasComponent=CanvasComponent;var _dec$B,_dec2$h,_dec3$8,_dec4$6,_dec5$5,_dec6$4,_dec7$4,_class$B,_class2$v,_descriptor$t,_descriptor2$k,_descriptor3$c,_descriptor4$a,_class3$e,_temp$x,UIComponent=(_dec$A=ccclass("cc.UIComponent"))(_class$A=(_dec2$g=executionOrder(110))(_class$A=disallowMultiple(_class$A=executeInEditMode((_applyDecoratedDescriptor((_class2$u=_temp$w=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_priority",_descriptor$s,_assertThisInitialized(t)),t._followScreen=null,t._lastParent=null,t}return _inherits(s,Component),_createClass(s,[{key:"__preload",value:function(){this.node._uiComp=this}},{key:"onEnable",value:function(){this._lastParent=this.node.parent,this._updateVisibility(),this._lastParent&&this.node.on(exports.SystemEventType.CHILD_REMOVED,this._parentChanged,this),this._sortSiblings()}},{key:"onDisable",value:function(){this._cancelEventFromParent()}},{key:"onDestroy",value:function(){this.node._uiComp===this&&(this.node._uiComp=null)}},{key:"updateAssembler",value:function(e){}},{key:"postUpdateAssembler",value:function(e){}},{key:"_setScreen",value:function(e){this._followScreen=e}},{key:"_parentChanged",value:function(e){return e===this.node&&(this._updateVisibility(),this._cancelEventFromParent(),this._lastParent=this.node.parent,this._sortSiblings(),!0)}},{key:"_sortSiblings",value:function(){var e=this.node.parent&&this.node.parent.children;e&&(e.sort(function(e,t){var i=e._uiComp,r=t._uiComp,n=(i?i.priority:0)-(r?r.priority:0);return 0==n?e.getSiblingIndex()-t.getSiblingIndex():n}),this.node.parent._updateSiblingIndex())}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent(CanvasComponent);if(t){this._followScreen=t;break}}e=e.parent}}},{key:"_cancelEventFromParent",value:function(){this._lastParent&&(this._lastParent.off(exports.SystemEventType.CHILD_REMOVED,this._parentChanged,this),this._lastParent=null),this._followScreen=null}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._priority=e,this._sortSiblings())}},{key:"visibility",get:function(){return this._screen?this._screen.visibility:-1}},{key:"_screen",get:function(){return this._followScreen}}]),s}()).prototype,"priority",[property],Object.getOwnPropertyDescriptor(_class2$u.prototype,"priority"),_class2$u.prototype),_descriptor$s=_applyDecoratedDescriptor(_class2$u.prototype,"_priority",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_class$A=_class2$u))||_class$A)||_class$A)||_class$A)||_class$A;ccenum(exports.GFXBlendFactor),function(e){e[e.ADDCOLOR=0]="ADDCOLOR",e[e.ADDCOLORANDTEXTURE=1]="ADDCOLORANDTEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE"}(exports.InstanceMaterialType||(exports.InstanceMaterialType={}));var _dec$C,_dec2$i,_dec3$9,_dec4$7,_dec5$6,_dec6$5,_dec7$5,_dec8$2,_dec9$2,_dec10$2,_dec11$1,_class$C,_class2$w,_descriptor$u,_descriptor2$l,_descriptor3$d,_descriptor4$b,_descriptor5$8,_descriptor6$3,_descriptor7$3,_descriptor8$3,_descriptor9$3,_descriptor10$3,_class3$f,_temp$y,SpriteType,FillType,SizeMode,UIRenderComponent=(_dec$B=ccclass("cc.UIRenderComponent"),_dec2$h=executionOrder(110),_dec3$8=requireComponent(UITransformComponent),_dec4$6=property({type:exports.GFXBlendFactor,displayOrder:0}),_dec5$5=property({type:exports.GFXBlendFactor,displayOrder:1}),_dec6$4=property({displayOrder:2}),_dec7$4=property({type:Material,displayOrder:3}),_dec$B(_class$B=_dec2$h(_class$B=_dec3$8(_class$B=executeInEditMode((_temp$x=_class3$e=function(){function a(){var e,t;_classCallCheck(this,a);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(a)).call.apply(e,[this].concat(r))),"_srcBlendFactor",_descriptor$t,_assertThisInitialized(t)),_initializerDefineProperty(t,"_dstBlendFactor",_descriptor2$k,_assertThisInitialized(t)),_initializerDefineProperty(t,"_color",_descriptor3$c,_assertThisInitialized(t)),_initializerDefineProperty(t,"_sharedMaterial",_descriptor4$a,_assertThisInitialized(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._material=null,t._instanceMaterialType=exports.InstanceMaterialType.ADDCOLORANDTEXTURE,t._blendTemplate={blendState:{targets:[{blendSrc:exports.GFXBlendFactor.SRC_ALPHA,blendDst:exports.GFXBlendFactor.ONE_MINUS_SRC_ALPHA}]},depthStencilState:{},rasterizerState:{}},t._simulate=!1,t}return _inherits(a,UIComponent),_createClass(a,[{key:"__preload",value:function(){_get(_getPrototypeOf(a.prototype),"__preload",this).call(this),this._instanceMaterial(),this._flushAssembler&&this._flushAssembler()}},{key:"onEnable",value:function(){_get(_getPrototypeOf(a.prototype),"onEnable",this).call(this),this.node.on(exports.SystemEventType.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(exports.SystemEventType.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=this._canRender()}},{key:"onDisable",value:function(){_get(_getPrototypeOf(a.prototype),"onDisable",this).call(this),this.node.off(exports.SystemEventType.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(exports.SystemEventType.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}},{key:"onDestroy",value:function(){_get(_getPrototypeOf(a.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._material&&this._material.destroy(),this._updateMaterial(null),this._renderData=null}},{key:"markForUpdateRenderData",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e;if(this._renderFlag=this._canRender(),t&&this._renderFlag){var i=this._renderData;i&&(i.vertDirty=!0),this._renderDataFlag=t}else t||(this._renderDataFlag=t)}},{key:"requestRenderData",value:function(){var e=RenderData.add();return this._renderData=e}},{key:"destroyRenderData",value:function(){this._renderData&&(RenderData.remove(this._renderData),this._renderData=null)}},{key:"updateAssembler",value:function(e){_get(_getPrototypeOf(a.prototype),"updateAssembler",this).call(this,e),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))}},{key:"postUpdateAssembler",value:function(e){_get(_getPrototypeOf(a.prototype),"postUpdateAssembler",this).call(this,e),this._renderFlag&&this._postRender(e)}},{key:"_render",value:function(e){}},{key:"_postRender",value:function(e){}},{key:"_checkAndUpdateRenderData",value:function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}},{key:"_canRender",value:function(){return null!==this.material&&this.enabled&&(!!this._simulate||this.enabledInHierarchy)}},{key:"_postCanRender",value:function(){}},{key:"_updateColor",value:function(){this._assembler&&this._assembler.updateColor&&this._assembler.updateColor(this)}},{key:"_updateMaterial",value:function(e){this._material=e,this._updateBlendFunc()}},{key:"_updateBlendFunc",value:function(){if(this._material){var e=this._blendTemplate.blendState.targets[0];e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this._blendTemplate.depthStencilState=this._material.passes[0].depthStencilState,this._blendTemplate.rasterizerState=this._material.passes[0].rasterizerState,this._material.overridePipelineStates(this._blendTemplate,0))}}},{key:"_nodeStateChange",value:function(e){this._renderData&&this.markForUpdateRenderData();var t=this.node.children,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n.getComponent(a);s&&s.markForUpdateRenderData()}}},{key:"_instanceMaterial",value:function(){var e=null;if(this._sharedMaterial)e=Material.getInstantiatedMaterial(this._sharedMaterial,new RenderableComponent,!1);else switch(this._instanceMaterialType){case exports.InstanceMaterialType.ADDCOLOR:e=Material.getInstantiatedMaterial(cc.builtinResMgr.get("ui-base-material"),new RenderableComponent,!1);break;case exports.InstanceMaterialType.ADDCOLORANDTEXTURE:e=Material.getInstantiatedMaterial(cc.builtinResMgr.get("ui-sprite-material"),new RenderableComponent,!1);break;case exports.InstanceMaterialType.GRAYSCALE:e=Material.getInstantiatedMaterial(cc.builtinResMgr.get("ui-sprite-gray-material"),new RenderableComponent,!1)}this._updateMaterial(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"sharedMaterial",get:function(){return this._sharedMaterial},set:function(e){this._sharedMaterial!==e&&(this._sharedMaterial=e,this._instanceMaterial&&this._instanceMaterial())}},{key:"material",get:function(){return this._material||this._instanceMaterial&&this._instanceMaterial(),this._material}},{key:"renderData",get:function(){return this._renderData}},{key:"simulate",set:function(e){this._simulate=e}}]),a}(),_class3$e.BlendState=exports.GFXBlendFactor,_class3$e.Assembler=null,_class3$e.PostAssembler=null,_applyDecoratedDescriptor((_class2$v=_temp$x).prototype,"srcBlendFactor",[_dec4$6],Object.getOwnPropertyDescriptor(_class2$v.prototype,"srcBlendFactor"),_class2$v.prototype),_applyDecoratedDescriptor(_class2$v.prototype,"dstBlendFactor",[_dec5$5],Object.getOwnPropertyDescriptor(_class2$v.prototype,"dstBlendFactor"),_class2$v.prototype),_applyDecoratedDescriptor(_class2$v.prototype,"color",[_dec6$4],Object.getOwnPropertyDescriptor(_class2$v.prototype,"color"),_class2$v.prototype),_applyDecoratedDescriptor(_class2$v.prototype,"sharedMaterial",[_dec7$4],Object.getOwnPropertyDescriptor(_class2$v.prototype,"sharedMaterial"),_class2$v.prototype),_descriptor$t=_applyDecoratedDescriptor(_class2$v.prototype,"_srcBlendFactor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXBlendFactor.SRC_ALPHA}}),_descriptor2$k=_applyDecoratedDescriptor(_class2$v.prototype,"_dstBlendFactor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.GFXBlendFactor.ONE_MINUS_SRC_ALPHA}}),_descriptor3$c=_applyDecoratedDescriptor(_class2$v.prototype,"_color",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.WHITE.clone()}}),_descriptor4$a=_applyDecoratedDescriptor(_class2$v.prototype,"_sharedMaterial",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$B=_class2$v))||_class$B)||_class$B)||_class$B)||_class$B);cc.UIRenderComponent=UIRenderComponent,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.FILLED=3]="FILLED"}(SpriteType=SpriteType||{}),ccenum(SpriteType),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(FillType=FillType||{}),ccenum(FillType),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(SizeMode=SizeMode||{}),ccenum(SizeMode);var _dec$D,_dec2$j,_dec3$a,_dec4$8,_class$D,_class2$x,_descriptor$v,_temp$z,SpriteComponent=(_dec$C=ccclass("cc.SpriteComponent"),_dec2$i=executionOrder(110),_dec3$9=menu("UI/Render/Sprite"),_dec4$7=property({type:SpriteAtlas,displayOrder:4}),_dec5$6=property({type:SpriteFrame,displayOrder:5}),_dec6$5=property({type:SpriteType,displayOrder:6}),_dec7$5=property({type:FillType}),_dec8$2=property({range:[0,1,.1]}),_dec9$2=property({range:[0,1,.1]}),_dec10$2=property({displayOrder:8}),_dec11$1=property({type:SizeMode,displayOrder:7}),_dec$C(_class$C=_dec2$i(_class$C=_dec3$9((_temp$y=_class3$f=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_spriteFrame",_descriptor$u,_assertThisInitialized(t)),_initializerDefineProperty(t,"_type",_descriptor2$l,_assertThisInitialized(t)),_initializerDefineProperty(t,"_fillType",_descriptor3$d,_assertThisInitialized(t)),_initializerDefineProperty(t,"_sizeMode",_descriptor4$b,_assertThisInitialized(t)),_initializerDefineProperty(t,"_fillCenter",_descriptor5$8,_assertThisInitialized(t)),_initializerDefineProperty(t,"_fillStart",_descriptor6$3,_assertThisInitialized(t)),_initializerDefineProperty(t,"_fillRange",_descriptor7$3,_assertThisInitialized(t)),_initializerDefineProperty(t,"_isTrimmedMode",_descriptor8$3,_assertThisInitialized(t)),_initializerDefineProperty(t,"_useGrayscale",_descriptor9$3,_assertThisInitialized(t)),_initializerDefineProperty(t,"_atlas",_descriptor10$3,_assertThisInitialized(t)),t}return _inherits(s,UIRenderComponent),_createClass(s,[{key:"__preload",value:function(){this._useGrayscale&&(this._instanceMaterialType=exports.InstanceMaterialType.GRAYSCALE),_get(_getPrototypeOf(s.prototype),"__preload",this)&&_get(_getPrototypeOf(s.prototype),"__preload",this).call(this),this._spriteFrame&&(this._spriteFrame.on("load",this._markForUpdateUvDirty,this),this._markForUpdateUvDirty())}},{key:"onEnable",value:function(){_get(_getPrototypeOf(s.prototype),"onEnable",this).call(this),this._activateMaterial()}},{key:"onDestroy",value:function(){_get(_getPrototypeOf(s.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._spriteFrame&&this._spriteFrame.off("load")}},{key:"_render",value:function(e){e.commitComp(this,this._spriteFrame.getGFXTextureView(),this._assembler)}},{key:"_canRender",value:function(){if(!_get(_getPrototypeOf(s.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.textureLoaded())}},{key:"_flushAssembler",value:function(){var e=s.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material,this.markForUpdateRenderData(),this._updateColor())}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame){if(SizeMode.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node.setContentSize(e)}else if(SizeMode.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node.setContentSize(t.width,t.height)}this._activateMaterial()}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this._material;cc.game.renderType!==cc.game.RENDER_TYPE_CANVAS?(e&&t&&(t.setProperty("mainTexture",e),this.markForUpdateRenderData()),this._renderData&&(this._renderData.material=t)):this.markForUpdateRenderData()}},{key:"_applyAtlas",value:function(e){}},{key:"_onTextureLoaded",value:function(){this.isValid&&this._applySpriteSize()}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;this._renderData&&(e&&e.off("load",this._markForUpdateUvDirty),t&&t.on("load",this._markForUpdateUvDirty,this),this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty),t&&(e&&t===e||(t.loaded?this._onTextureLoaded():t.once("load",this._onTextureLoaded,this)))}},{key:"_markForUpdateUvDirty",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e,this.spriteFrame=null)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===FillType.RADIAL||this._fillType===FillType.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===SpriteType.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=clamp(e,-1,1),this._type===SpriteType.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=clamp(e,0,1),this._type===SpriteType.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===SpriteType.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?exports.InstanceMaterialType.GRAYSCALE:exports.InstanceMaterialType.ADDCOLORANDTEXTURE,this._instanceMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e)!==SizeMode.CUSTOM&&this._applySpriteSize()}}]),s}(),_class3$f.FillType=FillType,_class3$f.Type=SpriteType,_class3$f.SizeMode=SizeMode,_applyDecoratedDescriptor((_class2$w=_temp$y).prototype,"spriteAtlas",[_dec4$7],Object.getOwnPropertyDescriptor(_class2$w.prototype,"spriteAtlas"),_class2$w.prototype),_applyDecoratedDescriptor(_class2$w.prototype,"spriteFrame",[_dec5$6],Object.getOwnPropertyDescriptor(_class2$w.prototype,"spriteFrame"),_class2$w.prototype),_applyDecoratedDescriptor(_class2$w.prototype,"type",[_dec6$5],Object.getOwnPropertyDescriptor(_class2$w.prototype,"type"),_class2$w.prototype),_applyDecoratedDescriptor(_class2$w.prototype,"fillType",[_dec7$5],Object.getOwnPropertyDescriptor(_class2$w.prototype,"fillType"),_class2$w.prototype),_applyDecoratedDescriptor(_class2$w.prototype,"fillCenter",[property],Object.getOwnPropertyDescriptor(_class2$w.prototype,"fillCenter"),_class2$w.prototype),_applyDecoratedDescriptor(_class2$w.prototype,"fillStart",[_dec8$2],Object.getOwnPropertyDescriptor(_class2$w.prototype,"fillStart"),_class2$w.prototype),_applyDecoratedDescriptor(_class2$w.prototype,"fillRange",[_dec9$2],Object.getOwnPropertyDescriptor(_class2$w.prototype,"fillRange"),_class2$w.prototype),_applyDecoratedDescriptor(_class2$w.prototype,"trim",[_dec10$2],Object.getOwnPropertyDescriptor(_class2$w.prototype,"trim"),_class2$w.prototype),_applyDecoratedDescriptor(_class2$w.prototype,"grayscale",[property],Object.getOwnPropertyDescriptor(_class2$w.prototype,"grayscale"),_class2$w.prototype),_applyDecoratedDescriptor(_class2$w.prototype,"sizeMode",[_dec11$1],Object.getOwnPropertyDescriptor(_class2$w.prototype,"sizeMode"),_class2$w.prototype),_descriptor$u=_applyDecoratedDescriptor(_class2$w.prototype,"_spriteFrame",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$l=_applyDecoratedDescriptor(_class2$w.prototype,"_type",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SpriteType.SIMPLE}}),_descriptor3$d=_applyDecoratedDescriptor(_class2$w.prototype,"_fillType",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FillType.HORIZONTAL}}),_descriptor4$b=_applyDecoratedDescriptor(_class2$w.prototype,"_sizeMode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SizeMode.TRIMMED}}),_descriptor5$8=_applyDecoratedDescriptor(_class2$w.prototype,"_fillCenter",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec2(0,0)}}),_descriptor6$3=_applyDecoratedDescriptor(_class2$w.prototype,"_fillStart",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor7$3=_applyDecoratedDescriptor(_class2$w.prototype,"_fillRange",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor8$3=_applyDecoratedDescriptor(_class2$w.prototype,"_isTrimmedMode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor9$3=_applyDecoratedDescriptor(_class2$w.prototype,"_useGrayscale",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor10$3=_applyDecoratedDescriptor(_class2$w.prototype,"_atlas",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$C=_class2$w))||_class$C)||_class$C)||_class$C);cc.SpriteComponent=SpriteComponent;var _dec$E,_dec2$k,_class$E,_class2$y,_descriptor$w,_descriptor2$m,_descriptor3$e,_descriptor4$c,_descriptor5$9,_temp$A,SubContextView=(_dec$D=ccclass("cc.SubContextView"),_dec2$j=executionOrder(110),_dec3$a=menu("Components/SubContextView"),_dec4$8=property({type:Number}),_dec$D(_class$D=_dec2$j(_class$D=_dec3$a((_applyDecoratedDescriptor((_class2$x=_temp$z=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"_fps",_descriptor$v,_assertThisInitialized(e)),e._sprite=void 0,e._imageAsset=void 0,e._context=void 0,e._updatedTime=0,e._updateInterval=0,e._sprite=null,e._imageAsset=new ImageAsset,e._context=null,e._updatedTime=performance.now(),e}return _inherits(t,Component),_createClass(t,[{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1/e,this._updateSubContextFrameRate())}}]),_createClass(t,[{key:"onLoad",value:function(){if(wx.getOpenDataContext){this._updateInterval=1e3/this._fps,this._context=wx.getOpenDataContext(),this.reset();var e=this._imageAsset,t=this._context.canvas;if(e.reset(t),e._texture.create(t.width,t.height),this._sprite=this.node.getComponent(SpriteComponent),this._sprite||(this._sprite=this.node.addComponent(SpriteComponent)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._imageAsset._texture;else{var i=new SpriteFrame;i.texture=this._imageAsset._texture,this._sprite.spriteFrame=i}}else this.enabled=!1}},{key:"onEnable",value:function(){this._runSubContextMainLoop(),this._registerNodeEvent(),this._updateSubContextFrameRate(),this.updateSubContextViewport()}},{key:"onDisable",value:function(){this._unregisterNodeEvent(),this._stopSubContextMainLoop()}},{key:"update",value:function(e){if(void 0===e)return this._context&&this._context.postMessage({fromEngine:!0,event:"step"}),void this._updateSubContextTexture();performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())}},{key:"reset",value:function(){if(this._context){this.updateSubContextViewport();var e=this._context.canvas;e&&(e.width=this.node.getComponent(UITransformComponent).width,e.height=this.node.getComponent(UITransformComponent).height)}}},{key:"updateSubContextViewport",value:function(){if(this._context){var e=this.node.getComponent(UITransformComponent).getBoundingBoxToWorld(),t=view.getScaleX(),i=view.getScaleY(),r=view.getViewportRect();this._context.postMessage({fromEngine:!0,event:"viewport",x:e.x*t+r.x,y:e.y*i+r.y,width:e.width*t,height:e.height*i})}}},{key:"_updateSubContextTexture",value:function(){var e=this._imageAsset;if(e&&this._context&&!(e.width<=0||e.height<=0)){var t=this._context.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._imageAsset._texture.create(t.width,t.height),this._imageAsset._texture.uploadData(t)}}},{key:"_registerNodeEvent",value:function(){this.node.on(Node$1.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.on(Node$1.EventType.SCALE_PART,this.updateSubContextViewport,this),this.node.on(Node$1.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}},{key:"_unregisterNodeEvent",value:function(){this.node.off(Node$1.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.off(Node$1.EventType.SCALE_PART,this.updateSubContextViewport,this),this.node.off(Node$1.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}},{key:"_runSubContextMainLoop",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!0})}},{key:"_stopSubContextMainLoop",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!1})}},{key:"_updateSubContextFrameRate",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"frameRate",value:this._fps})}}]),t}()).prototype,"fps",[property],Object.getOwnPropertyDescriptor(_class2$x.prototype,"fps"),_class2$x.prototype),_descriptor$v=_applyDecoratedDescriptor(_class2$x.prototype,"_fps",[_dec4$8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),_class$D=_class2$x))||_class$D)||_class$D)||_class$D);cc.SubContextView=SubContextView,cc.RenderPassStage=exports.RenderPassStage;var _dec$F,_dec2$l,_class$F,_class2$z,_descriptor$x,_temp$B,_dec3$b,_dec4$9,_dec5$7,_dec6$6,_class4$2,_class5$2,_descriptor2$n,_descriptor3$f,_temp2$2,EventHandler=(_dec$E=ccclass("cc.ClickEvent"),_dec2$k=property(cc.Node),_dec$E((_applyDecoratedDescriptor((_class2$y=_temp$A=function(){function o(){_classCallCheck(this,o),_initializerDefineProperty(this,"target",_descriptor$w,this),_initializerDefineProperty(this,"component",_descriptor2$m,this),_initializerDefineProperty(this,"_componentId",_descriptor3$e,this),_initializerDefineProperty(this,"handler",_descriptor4$c,this),_initializerDefineProperty(this,"customEventData",_descriptor5$9,this)}return _createClass(o,[{key:"emit",value:function(e){var t=this.target;if(cc.isValid(t)){this._genCompIdIfNeeded();var i=cc.js._getClassById(this._componentId),r=t.getComponent(i);if(cc.isValid(r)){var n=r[this.handler];"function"==typeof n&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),n.apply(r,e))}}}},{key:"_compName2Id",value:function(e){var t=cc.js.getClassByName(e);return cc.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=cc.js._getClassById(e);return cc.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}},{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}],[{key:"emitEvents",value:function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];for(var n=0,s=e.length;n<s;n++){var a=e[n];a instanceof o&&a.emit(i)}}}]),o}()).prototype,"_componentName",[property],Object.getOwnPropertyDescriptor(_class2$y.prototype,"_componentName"),_class2$y.prototype),_descriptor$w=_applyDecoratedDescriptor(_class2$y.prototype,"target",[_dec2$k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$m=_applyDecoratedDescriptor(_class2$y.prototype,"component",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor3$e=_applyDecoratedDescriptor(_class2$y.prototype,"_componentId",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor4$c=_applyDecoratedDescriptor(_class2$y.prototype,"handler",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor5$9=_applyDecoratedDescriptor(_class2$y.prototype,"customEventData",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_class$E=_class2$y))||_class$E);cc.Component.EventHandler=EventHandler;var _dec$G,_dec2$m,_class$G,MissingClass$1=(_dec$F=ccclass("cc.MissingClass"),_dec2$l=property({visible:!1,editorOnly:!0}),_dec$F((_descriptor$x=_applyDecoratedDescriptor((_class2$z=_temp$B=function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"_$erialized",_descriptor$x,this)}).prototype,"_$erialized",[_dec2$l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$F=_class2$z))||_class$F),MissingScript=(_dec3$b=ccclass("cc.MissingScript"),_dec4$9=inspector("packages://inspector/inspectors/comps/missing-script.js"),_dec5$7=property({serializable:!1}),_dec6$6=property({visible:!1,editorOnly:!0}),_dec3$b(_class4$2=_dec4$9((_descriptor2$n=_applyDecoratedDescriptor((_class5$2=_temp2$2=function(){function r(){var e;return _classCallCheck(this,r),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this)),"compiled",_descriptor2$n,_assertThisInitialized(e)),_initializerDefineProperty(e,"_$erialized",_descriptor3$f,_assertThisInitialized(e)),e}return _inherits(r,Component),_createClass(r,null,[{key:"safeFindClass",value:function(e,t){var i=_getClassById(e);return i||(e?(cc.deserialize.reportMissingClass(e),r.getMissingWrapper(e,t)):null)}},{key:"getMissingWrapper",value:function(e,t){return t.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||BUILTIN_CLASSID_RE.test(e))?r:MissingClass$1}}]),_createClass(r,[{key:"onLoad",value:function(){cc.warnID(4600,this.node.name)}}]),r}()).prototype,"compiled",[_dec5$7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor3$f=_applyDecoratedDescriptor(_class5$2.prototype,"_$erialized",[_dec6$6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class4$2=_class5$2))||_class4$2)||_class4$2);cc._MissingScript=MissingScript;var BlockEvents=[exports.SystemEventType.TOUCH_START,exports.SystemEventType.TOUCH_END,exports.SystemEventType.TOUCH_MOVE,exports.SystemEventType.MOUSE_DOWN,exports.SystemEventType.MOUSE_MOVE,exports.SystemEventType.MOUSE_UP,exports.SystemEventType.MOUSE_ENTER,exports.SystemEventType.MOUSE_LEAVE,exports.SystemEventType.MOUSE_WHEEL];function stopPropagation(e){e.propagationStopped=!0}var _dec$H,_dec2$n,_dec3$c,_dec4$a,_dec5$8,_class$H,_class2$A,_descriptor$y,_descriptor2$o,_descriptor3$g,_descriptor4$d,_class3$g,_temp$C,BlockInputEventsComponent=(_dec$G=ccclass("cc.BlockInputEventsComponent"))(_class$G=(_dec2$m=menu("Components/BlockInputEvents"))(_class$G=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,Component),_createClass(e,[{key:"onEnable",value:function(){for(var e=0;e<BlockEvents.length;e++)this.node.on(BlockEvents[e],stopPropagation,this)}},{key:"onDisable",value:function(){for(var e=0;e<BlockEvents.length;e++)this.node.off(BlockEvents[e],stopPropagation,this)}}]),e}())||_class$G)||_class$G;cc.BlockInputEventsComponent=BlockInputEventsComponent,exports.removeProperty(UIComponent.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]);var _dec$I,_dec2$o,_dec3$d,_dec4$b,_dec5$9,_dec6$7,_dec7$6,_class$I,_class2$B,_descriptor$z,_descriptor2$p,_temp$D,_dec$J,_dec2$p,_dec3$e,_dec4$c,_dec5$a,_class$J,_class2$C,_descriptor$A,_descriptor2$q,_descriptor3$h,_descriptor4$e,_descriptor5$a,_temp$E,_dec6$8,_dec7$7,_dec8$3,_dec9$3,_dec10$3,_dec11$2,_dec12$1,_class4$3,_class5$3,_descriptor6$4,_descriptor7$4,_descriptor8$4,_temp2$3,_dec$K,_dec2$q,_class$K,_class2$D,_descriptor$B,_descriptor2$r,_descriptor3$i,_class3$h,_temp$F,_dec$L,_dec2$r,_dec3$f,_class$L,_class2$E,_descriptor$C,_temp$G,_dec$M,_class$M,_temp$H,_dec$N,_dec2$s,_dec3$g,_dec4$d,_dec5$b,_class$N,_class2$F,_descriptor$D,_descriptor2$s,_descriptor3$j,_descriptor4$f,_temp$I,_dec$O,_dec2$t,_dec3$h,_dec4$e,_dec5$c,_dec6$9,_class$O,_class2$G,_descriptor$E,_descriptor2$t,_descriptor3$k,_descriptor4$g,_descriptor5$b,_temp$J,ModelShadowCastingMode=Enum({OFF:0,ON:1}),ModelComponent=(_dec$H=ccclass("cc.ModelComponent"),_dec2$n=executionOrder(100),_dec3$c=menu("Components/Model"),_dec4$a=property({type:Mesh}),_dec5$8=property({type:ModelShadowCastingMode}),_dec$H(_class$H=_dec2$n(_class$H=_dec3$c(_class$H=executeInEditMode((_temp$C=_class3$g=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._model=null,_initializerDefineProperty(t,"_enableDynamicBatching",_descriptor$y,_assertThisInitialized(t)),_initializerDefineProperty(t,"_mesh",_descriptor2$o,_assertThisInitialized(t)),_initializerDefineProperty(t,"_shadowCastingMode",_descriptor3$g,_assertThisInitialized(t)),_initializerDefineProperty(t,"_receiveShadows",_descriptor4$d,_assertThisInitialized(t)),t}return _inherits(s,RenderableComponent),_createClass(s,[{key:"onLoad",value:function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onEnable",value:function(){this._model&&(this._model.inited||this._updateModels(),this._model.enabled=!0)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"onDestroy",value:function(){this._model&&(this._model.scene.destroyModel(this._model),this._model=null,this._models.length=0)}},{key:"_changeSceneInModel",value:function(){this.isValid&&(this._model&&(this._model.destroy(),this._model.scene.destroyModel(this._model),this._model=null),this._updateModels())}},{key:"_updateModels",value:function(){if(this.enabledInHierarchy&&this._mesh&&(this._createModel(),this._updateModelParams(),this._model&&(this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._model.enabled=!0,this._enableDynamicBatching))){this._mesh.hasFlatBuffers||this._mesh.createFlatBuffers();for(var e=0;e<this._model.subModels.length;++e)for(var t=this._model.subModels[e],i=0;i<t.passes.length;++i){var r=t.passes[i];r.batchedBuffer||r.createBatchedBuffer()}}}},{key:"_createModel",value:function(){if(this.node.scene){var e=this._getRenderScene();this._model&&e.destroyModel(this._model),this._model=e.createModel(this._getModelConstructor(),this.node),this._model.visFlags=this.visibility,this._models.length=0,this._models.push(this._model)}}},{key:"_getModelConstructor",value:function(){return Model}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags=this._model.transform.hasChangedFlags=TransformDirtyBit.POSITION,this._model.isDynamicBatching=this._enableDynamicBatching;for(var e=this._mesh?this._mesh.subMeshCount:0,t=0;t<e;++t){var i=this.getSharedMaterial(t),r=this._mesh.renderingMesh;if(r){var n=r.getSubmesh(t);n&&this._model.initSubModel(t,n,i||this._getBuiltinMaterial())}}}}},{key:"_onMaterialModified",value:function(e,t){if(null!=this._model&&(this._onRebuildPSO(e,t||this._getBuiltinMaterial()),this._enableDynamicBatching&&t))for(var i=0;i<t.passes.length;++i){var r=t.passes[i];r.batchedBuffer||r.createBatchedBuffer()}}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(null!=this._model)for(var e=0;e<this._model.subModelNum;++e)this._onMaterialModified(e,null)}},{key:"_getBuiltinMaterial",value:function(){return builtinResMgr.get("missing-material")}},{key:"_onVisiblityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===ModelShadowCastingMode.OFF?this._model.castShadow=!1:this._shadowCastingMode===ModelShadowCastingMode.ON?this._model.castShadow=!0:console.warn("ShadowCastingMode ".concat(this._shadowCastingMode," is not supported.")))}},{key:"_updateReceiveShadow",value:function(){this.enabledInHierarchy&&this._model}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh;this._mesh=e,this._onMeshChanged(t),this._updateModels()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){this._receiveShadows=e,this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableDynamicBatching",set:function(e){if(this._enableDynamicBatching!==e&&(this._enableDynamicBatching=e,this._mesh&&(e?this._mesh.createFlatBuffers():this._mesh.destroyFlatBuffers()),this._model)){this._model.isDynamicBatching=e,this._model.onPipelineChange();for(var t=0;t<this._model.subModels.length;++t)for(var i=this._model.subModels[t],r=0;r<i.passes.length;++r){var n=i.passes[r];e?n.createBatchedBuffer():n.clearBatchedBuffer()}}},get:function(){return this._enableDynamicBatching}}]),s}(),_class3$g.ShadowCastingMode=ModelShadowCastingMode,_applyDecoratedDescriptor((_class2$A=_temp$C).prototype,"mesh",[_dec4$a],Object.getOwnPropertyDescriptor(_class2$A.prototype,"mesh"),_class2$A.prototype),_applyDecoratedDescriptor(_class2$A.prototype,"shadowCastingMode",[_dec5$8],Object.getOwnPropertyDescriptor(_class2$A.prototype,"shadowCastingMode"),_class2$A.prototype),_applyDecoratedDescriptor(_class2$A.prototype,"enableDynamicBatching",[property],Object.getOwnPropertyDescriptor(_class2$A.prototype,"enableDynamicBatching"),_class2$A.prototype),_descriptor$y=_applyDecoratedDescriptor(_class2$A.prototype,"_enableDynamicBatching",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2$o=_applyDecoratedDescriptor(_class2$A.prototype,"_mesh",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor3$g=_applyDecoratedDescriptor(_class2$A.prototype,"_shadowCastingMode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ModelShadowCastingMode.OFF}}),_descriptor4$d=_applyDecoratedDescriptor(_class2$A.prototype,"_receiveShadows",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_class$H=_class2$A))||_class$H)||_class$H)||_class$H)||_class$H),SkinningModelComponent=(_dec$I=ccclass("cc.SkinningModelComponent"),_dec2$o=executionOrder(100),_dec3$d=menu("Components/SkinningModel"),_dec4$b=property(Skeleton),_dec5$9=property(Node$1),_dec6$7=property({type:Skeleton}),_dec7$6=property({type:Node$1}),_dec$I(_class$I=_dec2$o(_class$I=executeInEditMode(_class$I=_dec3$d((_descriptor$z=_applyDecoratedDescriptor((_class2$B=_temp$D=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_skeleton",_descriptor$z,_assertThisInitialized(t)),_initializerDefineProperty(t,"_skinningRoot",_descriptor2$p,_assertThisInitialized(t)),t._clip=null,t}return _inherits(s,ModelComponent),_createClass(s,[{key:"uploadAnimation",value:function(e){this._clip=e,this._model&&this._model.uploadAnimation(e)}},{key:"_updateModelParams",value:function(){this._update(),_get(_getPrototypeOf(s.prototype),"_updateModelParams",this).call(this)}},{key:"_getModelConstructor",value:function(){return SkinningModel}},{key:"_getBuiltinMaterial",value:function(){return builtinResMgr.get("missing-skinning-material")}},{key:"_update",value:function(){if(this._model){var e=this._model;e.bindSkeleton(this._skeleton,this._skinningRoot),e.uploadAnimation(this._clip)}}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){this._skeleton=e,this._update()}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._update()}},{key:"model",get:function(){return this._model}}]),s}()).prototype,"_skeleton",[_dec4$b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$p=_applyDecoratedDescriptor(_class2$B.prototype,"_skinningRoot",[_dec5$9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_applyDecoratedDescriptor(_class2$B.prototype,"skeleton",[_dec6$7],Object.getOwnPropertyDescriptor(_class2$B.prototype,"skeleton"),_class2$B.prototype),_applyDecoratedDescriptor(_class2$B.prototype,"skinningRoot",[_dec7$6],Object.getOwnPropertyDescriptor(_class2$B.prototype,"skinningRoot"),_class2$B.prototype),_class$I=_class2$B))||_class$I)||_class$I)||_class$I)||_class$I),repeat$1=function(e){return e-Math.floor(e)},batch_id={name:exports.GFXAttributeName.ATTR_BATCH_ID,format:exports.GFXFormat.R32F,isNormalized:!1},batch_uv={name:exports.GFXAttributeName.ATTR_BATCH_UV,format:exports.GFXFormat.RG32F,isNormalized:!1},batch_extras_size=GFXFormatInfos[batch_id.format].size+GFXFormatInfos[batch_uv.format].size,SkinningModelUnit=(_dec$J=ccclass("cc.SkinningModelUnit"),_dec2$p=property(Mesh),_dec3$e=property(Skeleton),_dec4$c=property(Material),_dec5$a=property({type:SkinningModelComponent}),_dec$J((_descriptor$A=_applyDecoratedDescriptor((_class2$C=_temp$E=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"mesh",_descriptor$A,this),_initializerDefineProperty(this,"skeleton",_descriptor2$q,this),_initializerDefineProperty(this,"material",_descriptor3$h,this),_initializerDefineProperty(this,"_offset",_descriptor4$e,this),_initializerDefineProperty(this,"_size",_descriptor5$a,this)}return _createClass(e,[{key:"offset",set:function(e){Vec2.copy(this._offset,e)},get:function(){return this._offset}},{key:"size",set:function(e){Vec2.copy(this._size,e)},get:function(){return this._size}},{key:"copyFrom",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getSharedMaterial(0))},get:function(){return null}}]),e}()).prototype,"mesh",[_dec2$p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$q=_applyDecoratedDescriptor(_class2$C.prototype,"skeleton",[_dec3$e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor3$h=_applyDecoratedDescriptor(_class2$C.prototype,"material",[_dec4$c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor4$e=_applyDecoratedDescriptor(_class2$C.prototype,"_offset",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec2(0,0)}}),_descriptor5$a=_applyDecoratedDescriptor(_class2$C.prototype,"_size",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec2(1,1)}}),_applyDecoratedDescriptor(_class2$C.prototype,"offset",[property],Object.getOwnPropertyDescriptor(_class2$C.prototype,"offset"),_class2$C.prototype),_applyDecoratedDescriptor(_class2$C.prototype,"size",[property],Object.getOwnPropertyDescriptor(_class2$C.prototype,"size"),_class2$C.prototype),_applyDecoratedDescriptor(_class2$C.prototype,"copyFrom",[_dec5$a],Object.getOwnPropertyDescriptor(_class2$C.prototype,"copyFrom"),_class2$C.prototype),_class$J=_class2$C))||_class$J),BatchedSkinningModelComponent=(_dec6$8=ccclass("cc.BatchedSkinningModelComponent"),_dec7$7=executionOrder(100),_dec8$3=menu("Components/BatchedSkinningModel"),_dec9$3=property({type:[CCString]}),_dec10$3=property({type:[SkinningModelUnit]}),_dec11$2=property({override:!0,visible:!1}),_dec12$1=property({override:!0,visible:!1}),_dec6$8(_class4$3=_dec7$7(_class4$3=executeInEditMode(_class4$3=_dec8$3((_descriptor6$4=_applyDecoratedDescriptor((_class5$3=_temp2$3=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"atlasSize",_descriptor6$4,_assertThisInitialized(t)),_initializerDefineProperty(t,"batchableTextureNames",_descriptor7$4,_assertThisInitialized(t)),_initializerDefineProperty(t,"units",_descriptor8$4,_assertThisInitialized(t)),t._textures={},t._batchMaterial=null,t}return _inherits(s,SkinningModelComponent),_createClass(s,[{key:"onLoad",value:function(){_get(_getPrototypeOf(s.prototype),"onLoad",this).call(this),this.cook()}},{key:"onDestroy",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].destroy()}this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),_get(_getPrototypeOf(s.prototype),"onDestroy",this).call(this)}},{key:"cook",value:function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}},{key:"cookMaterials",value:function(){var _=this;this._batchMaterial||(this._batchMaterial=this.getSharedMaterial(0));var p=this.getMaterial(0);if(p&&this._batchMaterial&&this._batchMaterial.effectAsset){p.copy(this._batchMaterial),this.resizeAtlases();for(var t=p.effectAsset.techniques[p.technique],e=function(c){var l=t.passes[c];if(!l.properties)return"continue";for(var e=function(){var t=h[u];if(l.properties[t].type>=exports.GFXType.SAMPLER1D){var i=null;_.batchableTextureNames.find(function(e){return e===t})?(i=(i=_._textures[t])||_.createTexture(t),_.cookTextures(i,t,c)):_.units.some(function(e){return i=e.material&&e.material.getProperty(t,c)}),i&&p.setProperty(t,i,c)}else{var e=[],r=_.units,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=a;o.material&&e.push(o.material.getProperty(t.slice(0,-3),c))}p.setProperty(t,e,c)}},u=0,h=Object.keys(l.properties);u<h.length;u++)e()},i=0;i<t.passes.length;i++)e(i)}else console.warn("incomplete batch material!")}},{key:"cookSkeletons",value:function(){if(this._skinningRoot){var i=new Skeleton,r=[],e=this.units,t=Array.isArray(e),n=0;for(e=t?e:e[Symbol.iterator]();;){var s;if(t){if(n>=e.length)break;s=e[n++]}else{if((n=e.next()).done)break;s=n.value}var a=s;if(a&&a.skeleton)for(var o=a.skeleton,c=function(e){var t=o.joints[e];if(0<=i.joints.findIndex(function(e){return e===t}))return"continue";i.joints.push(t),r.push(o.bindposes[e]||new Mat4)},l=0;l<o.joints.length;l++)c(l)}var u=Array.from(Array(i.joints.length).keys()).sort(function(e,t){return i.joints[e]>i.joints[t]?1:i.joints[e]<i.joints[t]?-1:0});i.joints=i.joints.map(function(e,t,i){return i[u[t]]}),i.bindposes=r.map(function(e,t,i){return i[u[t]]}),this._skeleton&&this._skeleton.destroy(),this.skeleton=i}else console.warn("no skinning root specified!")}},{key:"cookMeshes",value:function(){var X=this,e=!1,t=this.units,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}if(n.mesh){e=!0;break}}if(this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new Mesh,e&&this._skinningRoot){for(var W,H=0,q=exports.GFXFormat.UNKNOWN,j=0,Y=exports.GFXFormat.UNKNOWN,Q=new Array(this.units.length),s=this.units.length,a=0;a<s;a++){var o=this.units[a];o&&o.skeleton&&(Q[a]=o.skeleton.joints.map(function(t){return X._skeleton.joints.findIndex(function(e){return t===e})}))}for(var c=function(_){var e=X.units[_];if(!e||!e.mesh||!e.mesh.data)return"continue";var t=JSON.parse(JSON.stringify(e.mesh.struct)),i=0,r=t.vertexBundles,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=a;o.attributes.push(batch_id),o.attributes.push(batch_uv),o.view.offset=i,o.view.length+=o.view.count*batch_extras_size,o.view.stride+=batch_extras_size,i+=o.view.length}var c=t.primitives,l=Array.isArray(c),u=0;for(c=l?c:c[Symbol.iterator]();;){var h;if(l){if(u>=c.length)break;h=c[u++]}else{if((u=c.next()).done)break;h=u.value}var p=h;p.indexView&&(p.indexView.offset=i,i+=p.indexView.length),p.geometricInfo&&(i=4*Math.ceil(i/4),p.geometricInfo.view.offset=i,i+=p.geometricInfo.view.length)}var d=e.mesh.data,f=0,m=new Uint8Array(i);W=new DataView(m.buffer);for(var y=0;y<t.vertexBundles.length;y++){var v=e.mesh.readAttribute(y,exports.GFXAttributeName.ATTR_TEX_COORD),g=e.mesh.struct.vertexBundles[y].view,b=t.vertexBundles[y].view,x=g.stride,T=b.stride;f=g.offset,i=b.offset;for(var C=0;C<b.count;C++){var S=d.subarray(f,f+x);m.set(S,i),W.setFloat32(i+x,_,cc.sys.isLittleEndian),W.setFloat32(i+x+4,v[2*C],cc.sys.isLittleEndian),W.setFloat32(i+x+8,v[2*C+1],cc.sys.isLittleEndian),i+=T,f+=x}}for(var E=0;E<t.primitives.length;E++){var w=e.mesh.struct.primitives[E],A=t.primitives[E];if(w.indexView&&A.indexView){var $=w.indexView.stride,O=A.indexView.stride;f=w.indexView.offset,i=A.indexView.offset;for(var D=0;D<A.indexView.count;D++){var k=d.subarray(f,f+$);m.set(k,i),i+=O,f+=$}}if(w.geometricInfo&&A.geometricInfo){var R=w.geometricInfo.view.stride,I=A.geometricInfo.view.stride;f=w.geometricInfo.view.offset,i=A.geometricInfo.view.offset;for(var F=0;F<A.geometricInfo.view.count;F++){var P=d.subarray(f,f+R);m.set(P,i),i+=I,f+=R}}}var M=new Mesh;M.reset({struct:t,data:m});function L(){if(G){if(V>=N.length)return"break";U=N[V++]}else{if((V=N.next()).done)return"break";U=V.value}var e=U;H=e.view.offset,q=exports.GFXFormat.UNKNOWN;var t=e.attributes,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n;if(s.name===exports.GFXAttributeName.ATTR_BATCH_UV){q=s.format;break}H+=GFXFormatInfos[s.format].size}q&&mapBuffer(W,function(e,t){var i=0===t?"x":"y";return(e=repeat$1(e))*B[i]+z[i]},q,H,e.view.length,e.view.stride,W);var a=Q[_];if(!a)return"continue";j=e.view.offset,Y=exports.GFXFormat.UNKNOWN;var o=e.attributes,c=Array.isArray(o),l=0;for(o=c?o:o[Symbol.iterator]();;){var u;if(c){if(l>=o.length)break;u=o[l++]}else{if((l=o.next()).done)break;u=l.value}var h=u;if(h.name===exports.GFXAttributeName.ATTR_JOINTS){Y=h.format;break}j+=GFXFormatInfos[h.format].size}Y&&mapBuffer(W,function(e){return a[e]},Y,j,e.view.length,e.view.stride,W)}var z=e.offset,B=e.size;var N=t.vertexBundles,G=Array.isArray(N),V=0;e:for(N=G?N:N[Symbol.iterator]();;){var U;switch(L()){case"break":break e;case"continue":continue}}X._mesh.merge(M)},l=0;l<s;l++)c(l);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"cookTextures",value:function(e,t,i){var r=[],n=[],s=[],a=[],o=this.units,c=Array.isArray(o),l=0;for(o=c?o:o[Symbol.iterator]();;){var u;if(c){if(l>=o.length)break;u=o[l++]}else{if((l=o.next()).done)break;u=l.value}var h=u;if(h.material){var _=h.material.getProperty(t,i);if(_&&_.image&&_.image.data){var p=new GFXBufferTextureCopy;p.texOffset.x=h.offset.x*this.atlasSize,p.texOffset.y=h.offset.y*this.atlasSize,p.texExtent.width=h.size.x*this.atlasSize,p.texExtent.height=h.size.y*this.atlasSize;var d=_.image.data;d instanceof HTMLCanvasElement||d instanceof HTMLImageElement?(r.push(d),n.push(p)):(s.push(d.buffer),a.push(p))}}}var f=e.getGFXTexture(),m=cc.director.root.device;0<s.length&&m.copyBuffersToTexture(s,f,a),0<r.length&&m.copyTexImagesToTexture(r,f,n)}},{key:"createTexture",value:function(e){var t=new Texture2D;return t.setFilters(Filter.LINEAR,Filter.LINEAR),t.reset({width:this.atlasSize,height:this.atlasSize,format:PixelFormat.RGBA8888}),t.loaded=!0,this._textures[e]=t}},{key:"resizeAtlases",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].reset({width:this.atlasSize,height:this.atlasSize,format:PixelFormat.RGBA8888})}}},{key:"mesh",get:function(){return this._mesh},set:function(e){_set(_getPrototypeOf(s.prototype),"mesh",e,this,!0)}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){_set(_getPrototypeOf(s.prototype),"skeleton",e,this,!0)}}]),s}()).prototype,"atlasSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),_descriptor7$4=_applyDecoratedDescriptor(_class5$3.prototype,"batchableTextureNames",[_dec9$3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor8$4=_applyDecoratedDescriptor(_class5$3.prototype,"units",[_dec10$3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_applyDecoratedDescriptor(_class5$3.prototype,"mesh",[_dec11$2],Object.getOwnPropertyDescriptor(_class5$3.prototype,"mesh"),_class5$3.prototype),_applyDecoratedDescriptor(_class5$3.prototype,"skeleton",[_dec12$1],Object.getOwnPropertyDescriptor(_class5$3.prototype,"skeleton"),_class5$3.prototype),_class4$3=_class5$3))||_class4$3)||_class4$3)||_class4$3)||_class4$3),PhotometricTerm=Enum({LUMINOUS_POWER:0,LUMINANCE:1}),LightComponent=(_dec$K=ccclass("cc.LightComponent"),_dec2$q=property({slide:!0,range:[1e3,15e3,1]}),_dec$K((_temp$F=_class3$h=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_color",_descriptor$B,_assertThisInitialized(t)),_initializerDefineProperty(t,"_useColorTemperature",_descriptor2$r,_assertThisInitialized(t)),_initializerDefineProperty(t,"_colorTemperature",_descriptor3$i,_assertThisInitialized(t)),t._type=LightType.UNKNOWN,t._light=null,t}return _inherits(s,Component),_createClass(s,[{key:"onEnable",value:function(){this._light?this._light.enabled=!0:this._createLight()}},{key:"onDisable",value:function(){this._light&&(this._light.enabled=!1)}},{key:"onDestroy",value:function(){this._destroyLight()}},{key:"_createLight",value:function(e){this._light&&(this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.enabled=this.enabledInHierarchy)}},{key:"_destroyLight",value:function(e){this._light=null}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(this._light.color.x=e.r/255,this._light.color.y=e.g/255,this._light.color.z=e.b/255)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"type",get:function(){return this._type}}]),s}(),_class3$h.Type=LightType,_class3$h.PhotometricTerm=PhotometricTerm,_descriptor$B=_applyDecoratedDescriptor((_class2$D=_temp$F).prototype,"_color",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.WHITE.clone()}}),_descriptor2$r=_applyDecoratedDescriptor(_class2$D.prototype,"_useColorTemperature",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor3$i=_applyDecoratedDescriptor(_class2$D.prototype,"_colorTemperature",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),_applyDecoratedDescriptor(_class2$D.prototype,"color",[property],Object.getOwnPropertyDescriptor(_class2$D.prototype,"color"),_class2$D.prototype),_applyDecoratedDescriptor(_class2$D.prototype,"useColorTemperature",[property],Object.getOwnPropertyDescriptor(_class2$D.prototype,"useColorTemperature"),_class2$D.prototype),_applyDecoratedDescriptor(_class2$D.prototype,"colorTemperature",[_dec2$q],Object.getOwnPropertyDescriptor(_class2$D.prototype,"colorTemperature"),_class2$D.prototype),_class$K=_class2$D))||_class$K),DirectionalLightComponent=(_dec$L=ccclass("cc.DirectionalLightComponent"),_dec2$r=menu("Light/DirectionalLight"),_dec3$f=property({unit:"lx"}),_dec$L(_class$L=_dec2$r(_class$L=executeInEditMode((_descriptor$C=_applyDecoratedDescriptor((_class2$E=_temp$G=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_illuminance",_descriptor$C,_assertThisInitialized(t)),t._type=LightType.DIRECTIONAL,t._light=null,t}return _inherits(s,LightComponent),_createClass(s,[{key:"_createLight",value:function(e){this.node.scene&&((e=e||this._getRenderScene()).mainLight.node.activeInHierarchy?console.warn("there can be only one directional(main) light."):(this._light=e.mainLight,this.illuminance=this._illuminance,_get(_getPrototypeOf(s.prototype),"_createLight",this).call(this,e)))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&(this._light.enabled=!1,e=e||this._getRenderScene(),this._light.node=e.defaultMainLightNode,_get(_getPrototypeOf(s.prototype),"_destroyLight",this).call(this,e))}},{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}}]),s}()).prototype,"_illuminance",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),_applyDecoratedDescriptor(_class2$E.prototype,"illuminance",[_dec3$f],Object.getOwnPropertyDescriptor(_class2$E.prototype,"illuminance"),_class2$E.prototype),_class$L=_class2$E))||_class$L)||_class$L)||_class$L),EditorCameraComponent=(_dec$M=ccclass("cc.EditorCameraComponent"))(_class$M=_temp$H=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._uiEditorCamera=null,t}return _inherits(s,CameraComponent),_createClass(s,[{key:"onLoad",value:function(){_get(_getPrototypeOf(s.prototype),"onLoad",this).call(this),this._inEditorMode=!0}},{key:"onEnable",value:function(){_get(_getPrototypeOf(s.prototype),"onEnable",this).call(this)}},{key:"onDisable",value:function(){_get(_getPrototypeOf(s.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){_get(_getPrototypeOf(s.prototype),"onDestroy",this).call(this),this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null)}},{key:"_createCamera",value:function(){var e=this._camera;_get(_getPrototypeOf(s.prototype),"_createCamera",this).call(this),this._camera!==e&&this._camera&&(this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null),this._uiEditorCamera=cc.director.root.ui.renderScene.createCamera({name:"Editor UICamera",node:this._camera.node,projection:this._projection,window:cc.director.root.mainWindow,priority:this._priority+1,flows:["UIFlow"]}),this._uiEditorCamera.visibility=CameraEditorMask,this._uiEditorCamera.viewport=this._camera.viewport,this._uiEditorCamera.fov=this._camera.fov,this._uiEditorCamera.nearClip=this._camera.nearClip,this._uiEditorCamera.farClip=this._camera.farClip,this._uiEditorCamera.clearColor=this._camera.clearColor,this._uiEditorCamera.clearDepth=this._camera.clearDepth,this._uiEditorCamera.clearStencil=this._camera.clearStencil,this._uiEditorCamera.clearFlag=exports.GFXClearFlag.DEPTH_STENCIL)}},{key:"projection",set:function(e){_set(_getPrototypeOf(s.prototype),"projection",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.projectionType=e)}},{key:"fov",set:function(e){_set(_getPrototypeOf(s.prototype),"fov",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.fov=toRadian(e))}},{key:"orthoHeight",set:function(e){_set(_getPrototypeOf(s.prototype),"orthoHeight",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.orthoHeight=e)}},{key:"near",set:function(e){_set(_getPrototypeOf(s.prototype),"near",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.nearClip=e)}},{key:"far",set:function(e){_set(_getPrototypeOf(s.prototype),"far",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.farClip=e)}},{key:"color",set:function(e){_set(_getPrototypeOf(s.prototype),"color",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearColor=e)}},{key:"depth",set:function(e){_set(_getPrototypeOf(s.prototype),"depth",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearDepth=e)}},{key:"stencil",set:function(e){_set(_getPrototypeOf(s.prototype),"stencil",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearStencil=e)}},{key:"clearFlags",set:function(e){_set(_getPrototypeOf(s.prototype),"clearFlags",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearFlag=e)}},{key:"rect",set:function(e){_set(_getPrototypeOf(s.prototype),"rect",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.viewport=e)}},{key:"screenScale",set:function(e){_set(_getPrototypeOf(s.prototype),"screenScale",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.screenScale=e)}}]),s}())||_class$M,SphereLightComponent=(_dec$N=ccclass("cc.SphereLightComponent"),_dec2$s=menu("Light/SphereLight"),_dec3$g=property({unit:"lm"}),_dec4$d=property({unit:"cd/m²"}),_dec5$b=property({type:PhotometricTerm}),_dec$N(_class$N=_dec2$s(_class$N=executeInEditMode((_descriptor$D=_applyDecoratedDescriptor((_class2$F=_temp$I=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_size",_descriptor$D,_assertThisInitialized(t)),_initializerDefineProperty(t,"_luminance",_descriptor2$s,_assertThisInitialized(t)),_initializerDefineProperty(t,"_term",_descriptor3$j,_assertThisInitialized(t)),_initializerDefineProperty(t,"_range",_descriptor4$f,_assertThisInitialized(t)),t._type=LightType.SPHERE,t._light=null,t}return _inherits(s,LightComponent),_createClass(s,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e=e||this._getRenderScene(),this._light&&e.sphereLights.find(function(e){return e===t._light})||(this._light=e.createSphereLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,_get(_getPrototypeOf(s.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&((e=e||this._getRenderScene()).destroySphereLight(this._light),_get(_getPrototypeOf(s.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*nt2lm(this._size)},set:function(e){this._luminance=e/nt2lm(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),s}()).prototype,"_size",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),_descriptor2$s=_applyDecoratedDescriptor(_class2$F.prototype,"_luminance",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/nt2lm(.15)}}),_descriptor3$j=_applyDecoratedDescriptor(_class2$F.prototype,"_term",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PhotometricTerm.LUMINOUS_POWER}}),_descriptor4$f=_applyDecoratedDescriptor(_class2$F.prototype,"_range",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_applyDecoratedDescriptor(_class2$F.prototype,"luminousPower",[_dec3$g],Object.getOwnPropertyDescriptor(_class2$F.prototype,"luminousPower"),_class2$F.prototype),_applyDecoratedDescriptor(_class2$F.prototype,"luminance",[_dec4$d],Object.getOwnPropertyDescriptor(_class2$F.prototype,"luminance"),_class2$F.prototype),_applyDecoratedDescriptor(_class2$F.prototype,"term",[_dec5$b],Object.getOwnPropertyDescriptor(_class2$F.prototype,"term"),_class2$F.prototype),_applyDecoratedDescriptor(_class2$F.prototype,"size",[property],Object.getOwnPropertyDescriptor(_class2$F.prototype,"size"),_class2$F.prototype),_applyDecoratedDescriptor(_class2$F.prototype,"range",[property],Object.getOwnPropertyDescriptor(_class2$F.prototype,"range"),_class2$F.prototype),_class$N=_class2$F))||_class$N)||_class$N)||_class$N),SpotLightComponent=(_dec$O=ccclass("cc.SpotLightComponent"),_dec2$t=menu("Light/SpotLight"),_dec3$h=property({unit:"lm"}),_dec4$e=property({unit:"cd/m²"}),_dec5$c=property({type:PhotometricTerm}),_dec6$9=property({slide:!0,range:[2,180,1]}),_dec$O(_class$O=_dec2$t(_class$O=executeInEditMode((_descriptor$E=_applyDecoratedDescriptor((_class2$G=_temp$J=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_size",_descriptor$E,_assertThisInitialized(t)),_initializerDefineProperty(t,"_luminance",_descriptor2$t,_assertThisInitialized(t)),_initializerDefineProperty(t,"_term",_descriptor3$k,_assertThisInitialized(t)),_initializerDefineProperty(t,"_range",_descriptor4$g,_assertThisInitialized(t)),_initializerDefineProperty(t,"_spotAngle",_descriptor5$b,_assertThisInitialized(t)),t._type=LightType.SPOT,t._light=null,t}return _inherits(s,LightComponent),_createClass(s,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e=e||this._getRenderScene(),this._light&&e.spotLights.find(function(e){return e===t._light})||(this._light=e.createSpotLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,_get(_getPrototypeOf(s.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&((e=e||this._getRenderScene()).destroySpotLight(this._light),_get(_getPrototypeOf(s.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*nt2lm(this._size)},set:function(e){this._luminance=e/nt2lm(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=toRadian(e))}}]),s}()).prototype,"_size",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),_descriptor2$t=_applyDecoratedDescriptor(_class2$G.prototype,"_luminance",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/nt2lm(.15)}}),_descriptor3$k=_applyDecoratedDescriptor(_class2$G.prototype,"_term",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PhotometricTerm.LUMINOUS_POWER}}),_descriptor4$g=_applyDecoratedDescriptor(_class2$G.prototype,"_range",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor5$b=_applyDecoratedDescriptor(_class2$G.prototype,"_spotAngle",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),_applyDecoratedDescriptor(_class2$G.prototype,"luminousPower",[_dec3$h],Object.getOwnPropertyDescriptor(_class2$G.prototype,"luminousPower"),_class2$G.prototype),_applyDecoratedDescriptor(_class2$G.prototype,"luminance",[_dec4$e],Object.getOwnPropertyDescriptor(_class2$G.prototype,"luminance"),_class2$G.prototype),_applyDecoratedDescriptor(_class2$G.prototype,"term",[_dec5$c],Object.getOwnPropertyDescriptor(_class2$G.prototype,"term"),_class2$G.prototype),_applyDecoratedDescriptor(_class2$G.prototype,"size",[property],Object.getOwnPropertyDescriptor(_class2$G.prototype,"size"),_class2$G.prototype),_applyDecoratedDescriptor(_class2$G.prototype,"range",[property],Object.getOwnPropertyDescriptor(_class2$G.prototype,"range"),_class2$G.prototype),_applyDecoratedDescriptor(_class2$G.prototype,"spotAngle",[_dec6$9],Object.getOwnPropertyDescriptor(_class2$G.prototype,"spotAngle"),_class2$G.prototype),_class$O=_class2$G))||_class$O)||_class$O)||_class$O);function bezier(e,t,i,r,n){var s=1-n;return e*s*s*s+3*t*s*s*n+3*i*s*n*n+r*n*n*n}cc.CameraComponent=CameraComponent,cc.EditorComponent=EditorCameraComponent,cc.RenderableComponent=RenderableComponent,cc.ModelComponent=ModelComponent,cc.SkinningModelComponent=SkinningModelComponent,cc.BatchedSkinningModelComponent=BatchedSkinningModelComponent,cc.SkinningModelUnit=SkinningModelUnit,cc.LightComponent=LightComponent,cc.DirectionalLightComponent=DirectionalLightComponent,cc.SphereLightComponent=SphereLightComponent,cc.SpotLightComponent=SpotLightComponent,cc.utils=utils,cc.bezier=bezier;var cos=Math.cos,acos=Math.acos,max$2=Math.max,pi=Math.PI,tau=2*pi,sqrt=Math.sqrt;function crt(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function cardano(e,t){var i,r,n,s,a=t-0,o=t-e[0],c=3*a,l=3*o,u=3*(t-e[2]),h=1/(l-a-u+(t-1)),_=(c-6*o+u)*h,p=1/3*_,d=(l-c)*h,f=1/3*(3*d-_*_),m=1/3*f,y=(2*_*_*_-9*_*d+27*(a*h))/27,v=y/2,g=v*v+m*m*m;if(g<0){var b=1/3*-f,x=sqrt(b*b*b),T=-y/(2*x),C=acos(T<-1?-1:1<T?1:T),S=2*crt(x);return r=S*cos(C*(1/3))-p,n=S*cos((C+tau)*(1/3))-p,s=S*cos((C+2*tau)*(1/3))-p,0<=r&&r<=1?0<=n&&n<=1?0<=s&&s<=1?max$2(r,n,s):max$2(r,n):0<=s&&s<=1?max$2(r,s):r:0<=n&&n<=1?0<=s&&s<=1?max$2(n,s):n:s}if(0==g)return n=-(i=v<0?crt(-v):-crt(v))-p,0<=(r=2*i-p)&&r<=1?0<=n&&n<=1?max$2(r,n):r:n;var E=sqrt(g);return r=(i=crt(-v+E))-crt(v+E)-p}function bezierByTime(e,t){var i=cardano(e,t),r=1-i;return 0*r*r*r+3*e[1]*i*r*r+3*e[3]*i*i*r+1*i*i*i}cc.bezierByTime=bezierByTime;var WrapModeMask,WrapMode$2,EPSILON$1=1e-6;function binarySearchEpsilon(e,t){for(var i=0,r=e.length-1,n=r>>>1;i<=r;n=i+r>>>1){var s=e[n];if(t+EPSILON$1<s)r=n-1;else{if(!(s<t-EPSILON$1))return n;i=n+1}}return~i}!function(e){e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(WrapModeMask=WrapModeMask||{}),function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Reverse=WrapModeMask.Reverse]="Reverse",e[e.Loop=WrapModeMask.Loop]="Loop",e[e.LoopReverse=WrapModeMask.Loop|WrapModeMask.Reverse]="LoopReverse",e[e.PingPong=WrapModeMask.PingPong]="PingPong",e[e.PingPongReverse=WrapModeMask.PingPong|WrapModeMask.Reverse]="PingPongReverse"}(WrapMode$2=WrapMode$2||{}),ccenum(WrapMode$2);var _dec$P,_class$P,WrappedInfo=function(){function t(e){_classCallCheck(this,t),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return _createClass(t,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),t}();function isLerpable(e){return"function"==typeof e.lerp}var RatioSampler=function(){function a(e){var t,i;_classCallCheck(this,a),this.ratios=void 0;for(var r=!(this._findRatio=void 0),n=1,s=(this.ratios=e).length;n<s;n++)if(t=e[n]-e[n-1],1===n)i=t;else if(1e-6<Math.abs(t-i)){r=!1;break}this._findRatio=r?quickFindIndex:binarySearchEpsilon}return _createClass(a,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),a}();cc.RatioSampler=RatioSampler;var AnimCurve=function(){function n(e,t){_classCallCheck(this,n),this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._stepfiedValues=void 0,this._duration=void 0,this._duration=t,this._values=e.values;function i(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?n.Linear:n.Bezier(e):n.Linear}void 0!==e.easingMethod?this.type=i(e.easingMethod):void 0!==e.easingMethods?this.types=e.easingMethods.map(i):this.type=null;var r=e.values[0];void 0!==e.interpolate&&!e.interpolate||(this._lerp=selectLerpFx(r))}return _createClass(n,null,[{key:"Bezier",value:function(e){return e}}]),_createClass(n,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}},{key:"valueBetween",value:function(e,t,i,r,n){if(this._lerp){var s=this.types?this.types[t]:this.type,a=n-i,o=(e-i)/a;s&&(o=computeRatioByType(o,s));var c=this._values[t],l=this._values[r];return this._lerp(c,l,o,a*this._duration)}return this.valueAt(t)}},{key:"empty",value:function(){return 0===this._values.length}}]),n}();AnimCurve.Linear=null,cc.AnimCurve=AnimCurve;var EventInfo=function(){function e(){_classCallCheck(this,e),this.events=[]}return _createClass(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}(),CurveValueAdapter=(_dec$P=ccclass("cc.CurveValueAdapter"))(_class$P=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"forTarget",value:function(e){return{set:function(e){}}}}]),e}())||_class$P;function sampleAnimationCurve(e,t,i){var r=t.sample(i);if(r<0)if((r=~r)<=0)r=0;else{if(!(r>=t.ratios.length))return e.valueBetween(i,r-1,t.ratios[r-1],r,t.ratios[r]);r=t.ratios.length-1}return e.valueAt(r)}function computeRatioByType(e,t){if("string"==typeof t){var i=easing[t];i?e=i(e):errorID(3906,t)}else Array.isArray(t)&&(e=bezierByTime(t,e));return e}function quickFindIndex(e,t){var i=e.length-1;if(0==i)return 0;var r=e[0];if(t<r)return 0;var n=e[i];if(n<t)return i;var s=(t=(t-r)/(n-r))/(1/i),a=0|s;return s-a<1e-6?a:1+a-s<1e-6?1+a:~(1+a)}cc.CurveValueAdapter=CurveValueAdapter,cc.sampleAnimationCurve=sampleAnimationCurve;var _dec$Q,_dec2$u,_class$Q,_class2$H,_descriptor$F,_descriptor2$u,_descriptor3$l,_descriptor4$h,_descriptor5$c,_descriptor6$5,_descriptor7$5,_descriptor8$5,_descriptor9$4,_class3$i,_temp$K,selectLerpFx=function(){function t(e,t,i,r){return e.lerp(t,i,r)}return function(e){if(null!==e){if("number"==typeof e)return lerp;if("object"===_typeof(e)&&e.constructor){if(e instanceof Quat)return function(){var n=new Quat;return function(e,t,i,r){return Quat.slerp(n,e,t,i)}}();if(e instanceof ValueType)return function(r){var n=new r;return function(e,t,i){return r.lerp(n,e,t,i),n}}(e.constructor);if(e.constructor===Number)return lerp;if(isLerpable(e))return t}}}}(),EPSILON$2=1e-6;function binarySearchEpsilon$1(e,t){for(var i=0,r=e.length-1,n=r>>>1;i<=r;n=i+r>>>1){var s=e[n];if(t+EPSILON$2<s)r=n-1;else{if(!(s<t-EPSILON$2))return n;i=n+1}}return~i}var AnimationClip=(_dec$Q=ccclass("cc.AnimationClip"),_dec2$u=property({visible:!1}),_dec$Q((_temp$K=_class3$i=function(){function o(){var e,t;_classCallCheck(this,o);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(o)).call.apply(e,[this].concat(r))),"sample",_descriptor$F,_assertThisInitialized(t)),_initializerDefineProperty(t,"speed",_descriptor2$u,_assertThisInitialized(t)),_initializerDefineProperty(t,"wrapMode",_descriptor3$l,_assertThisInitialized(t)),_initializerDefineProperty(t,"events",_descriptor4$h,_assertThisInitialized(t)),_initializerDefineProperty(t,"_duration",_descriptor5$c,_assertThisInitialized(t)),_initializerDefineProperty(t,"_keys",_descriptor6$5,_assertThisInitialized(t)),_initializerDefineProperty(t,"_stepness",_descriptor7$5,_assertThisInitialized(t)),_initializerDefineProperty(t,"curveDatas",_descriptor8$5,_assertThisInitialized(t)),_initializerDefineProperty(t,"_curves",_descriptor9$4,_assertThisInitialized(t)),t._hash=0,t.frameRate=0,t._ratioSamplers=[],t._runtimeCurves=void 0,t._runtimeEvents=void 0,t._data=null,t}return _inherits(o,Asset),_createClass(o,[{key:"onLoaded",value:function(){this.frameRate=this.sample,this._migrateCurveDatas(),this._decodeCVTAs()}},{key:"getPropertyCurves",value:function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}},{key:"updateCurveDatas",value:function(){this._migrateCurveDatas(),delete this._runtimeCurves}},{key:"updateEventDatas",value:function(){delete this._runtimeEvents}},{key:"getEventGroupIndexAtRatio",value:function(e){return this._runtimeEvents||this._createRuntimeEvents(),binarySearchEpsilon$1(this._runtimeEvents.ratios,e)}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"_createPropertyCurves",value:function(){var t=this;this._ratioSamplers=this._keys.map(function(e){return new RatioSampler(e.map(function(e){return e/t._duration}))}),this._runtimeCurves=this._curves.map(function(e){return{curve:new AnimCurve(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys]}}),this._applyStepness()}},{key:"_createRuntimeEvents",value:function(){var r=this;var n=[],s=[],e=function(){if(o){if(c>=a.length)return"break";l=a[c++]}else{if((c=a.next()).done)return"break";l=c.value}var e=l,t=e.frame/r._duration,i=n.findIndex(function(e){return e===t});i<0&&(i=n.length,n.push(t),s.push({events:[]})),s[i].events.push({functionName:e.func,parameters:e.params})},a=this.events.sort(function(e,t){return e.frame-t.frame}),o=Array.isArray(a),c=0;for(a=o?a:a[Symbol.iterator]();;){var l;if("break"===e())break}this._runtimeEvents={ratios:n,eventGroups:s}}},{key:"_applyStepness",value:function(){this._runtimeCurves}},{key:"_migrateCurveDatas",value:function(){if(this.curveDatas){for(var e=0,t=Object.keys(this.curveDatas);e<t.length;e++){var i=t[e],r=new HierachyModifier;r.path=i;var n=this.curveDatas[i];if(n.props)for(var s=0,a=Object.keys(n.props);s<a.length;s++){var o=a[s],c=n.props[o];this._curves.push({modifiers:[r,o],data:c})}if(n.comps)for(var l=0,u=Object.keys(n.comps);l<u.length;l++){var h=u[l],_=new ComponentModifier;_.component=h;for(var p=n.comps[h],d=0,f=Object.keys(p);d<f.length;d++){var m=f[d],y=p[m];this._curves.push({modifiers:[r,_,m],data:y})}}}delete this.curveDatas}}},{key:"_decodeCVTAs",value:function(){var e=this._nativeAsset;if(e){for(var t=this._keys,i=0;i<t.length;++i){var r=t[i];r instanceof CompactValueTypeArray&&(t[i]=r.decompress(e))}for(var n=0;n<this._curves.length;++n){var s=this._curves[n];s.data.values instanceof CompactValueTypeArray&&(s.data.values=s.data.values.decompress(e))}}}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"eventGroups",get:function(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}},{key:"stepness",get:function(){return this._stepness},set:function(e){this._stepness=e,this._applyStepness()}},{key:"hash",get:function(){return this._hash||(this._hash=murmurhash2_32_gc(JSON.stringify(this._curves),666)),this._hash}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"data",get:function(){return this._data}}],[{key:"createWithSpriteFrames",value:function(e,t){if(!Array.isArray(e))return errorID(3905),null;var i=new o;i.sample=t||i.sample,i.duration=e.length/i.sample;for(var r=1/i.sample,n=new Array(e.length),s=new Array(n.length),a=0;a<e.length;a++)n[a]=a*r,s[a]=e[a];return i.keys=[n],i.curves=[{modifiers:[new ComponentModifier("cc.SpriteComponent"),"spriteFrame"],data:{keys:0,values:s}}],i}}]),o}(),_class3$i.preventDeferredLoadDependents=!0,_class3$i.WrapMode=WrapMode$2,_descriptor$F=_applyDecoratedDescriptor((_class2$H=_temp$K).prototype,"sample",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),_descriptor2$u=_applyDecoratedDescriptor(_class2$H.prototype,"speed",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor3$l=_applyDecoratedDescriptor(_class2$H.prototype,"wrapMode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WrapMode$2.Normal}}),_descriptor4$h=_applyDecoratedDescriptor(_class2$H.prototype,"events",[_dec2$u],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor5$c=_applyDecoratedDescriptor(_class2$H.prototype,"_duration",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor6$5=_applyDecoratedDescriptor(_class2$H.prototype,"_keys",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor7$5=_applyDecoratedDescriptor(_class2$H.prototype,"_stepness",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor8$5=_applyDecoratedDescriptor(_class2$H.prototype,"curveDatas",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),_descriptor9$4=_applyDecoratedDescriptor(_class2$H.prototype,"_curves",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_class$Q=_class2$H))||_class$Q);cc.AnimationClip=AnimationClip;var _class$R,_class2$I,_temp$L,AnimationBlendState=function(){function e(){_classCallCheck(this,e),this._blendTargets=[]}return _createClass(e,[{key:"refPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.find(function(e){return e.target===t});e||(e={target:t,properties:[]},this._blendTargets.push(e));var r=e.properties,n=r.find(function(e){return e.name===i});return n||(n={name:i,weight:0,value:void 0,refCount:0},r.push(n)),++n.refCount,n}},{key:"derefPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.findIndex(function(e){return e.target===t});if(!(e<0)){var r=this._blendTargets[e].properties,n=r.findIndex(function(e){return e.name===i});if(!(n<0)){var s=r[n];--s.refCount,0<s.refCount||(2<=r.length?r.splice(n,1):this._blendTargets.splice(e,1))}}}},{key:"apply",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r,s=n.target,a=n.properties,o=Array.isArray(a),c=0;for(a=o?a:a[Symbol.iterator]();;){var l;if(o){if(c>=a.length)break;l=a[c++]}else{if((c=a.next()).done)break;l=c.value}var u=l;0!==u.weight&&(s instanceof Node$1?"position"===u.name?s.setPosition(u.value):"rotation"===u.name?s.setRotation(u.value):s.setScale(u.value):s[u.name]=u.value)}}}},{key:"clear",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r.properties,s=Array.isArray(n),a=0;for(n=s?n:n[Symbol.iterator]();;){var o;if(s){if(a>=n.length)break;o=n[a++]}else{if((a=n.next()).done)break;o=a.value}o.weight=0}}}}]),e}(),AnimationManager=ccclass((_temp$L=_class2$I=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._anims=new MutableForwardIterator([]),t._delayEvents=[],t._blendState=new AnimationBlendState,t._crossFades=[],t}return _inherits(s,System),_createClass(s,[{key:"addCrossFade",value:function(e){this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){remove(this._crossFades,e)}},{key:"update",value:function(e){var t=this._crossFades,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.update(e)}this._blendState.clear();var s=this._anims,a=s.array;for(s.i=0;s.i<a.length;++s.i){var o=a[s.i];o.isPlaying&&!o.isPaused&&o.update(e)}this._blendState.apply();for(var c=this._delayEvents,l=0,u=c.length;l<u;l++){var h=c[l];h.target[h.func].apply(h.target,h.args)}c.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&(e.attachToBlendState(this._blendState),this._anims.push(e))}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);0<=t?(e.detachFromBlendState(this._blendState),this._anims.fastRemoveAt(t)):errorID(3907)}},{key:"pushDelayEvent",value:function(e,t,i){this._delayEvents.push({target:e,func:t,args:i})}},{key:"blendState",get:function(){return this._blendState}}]),s}(),_class2$I.ID="animation",_class$R=_temp$L))||_class$R;function additive3D(e,t,i){return i.value||(i.value=new Vec3),0===i.weight&&Vec3.zero(i.value),0===t?i.value:1===t?Vec3.copy(i.value,e):Vec3.scaleAndAdd(i.value,i.value,e,t)}function additiveQuat(e,t,i){if(i.value||(i.value=new Quat),0===i.weight&&Quat.identity(i.value),0===t)return i.value;if(1===t)return Quat.copy(i.value,e);var r=t/(i.weight+t);return Quat.slerp(i.value,i.value,e,r)}director.on(Director.EVENT_INIT,function(){var e=new AnimationManager;director.registerSystem(AnimationManager.ID,e,Scheduler.PRIORITY_SYSTEM)}),cc.AnimationManager=AnimationManager;var PropertySpecialization,Playable=function(){function e(){_classCallCheck(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return _createClass(e,[{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(getError(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(e){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(e){}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}}]),e}();!function(e){e[e.NodePosition=0]="NodePosition",e[e.NodeScale=1]="NodeScale",e[e.NodeRotation=2]="NodeRotation",e[e.None=3]="None"}(PropertySpecialization=PropertySpecialization||{});var ICurveInstance=function(){function r(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(_classCallCheck(this,r),this._curve=void 0,this._boundTarget=void 0,this._curveValueProxy=void 0,this._rootTarget=void 0,this._rootTargetProperty=void 0,this._isNodeTarget=void 0,this._propertySpecialization=void 0,this._blendTarget=void 0,this._blendFunction=void 0,this._cached=void 0,this._curveDetail=void 0,this._curve=e.curve,this._curveDetail=e,this._boundTarget=new BoundTarget(t,e.modifiers,e.valueAdapter),this._rootTarget=t,this._isNodeTarget=t instanceof Node$1,this._propertySpecialization=PropertySpecialization.None,this._blendFunction=null,this._isNodeTarget&&1===e.modifiers.length)switch(e.modifiers[0]){case"position":this._propertySpecialization=PropertySpecialization.NodePosition,this._blendFunction=additive3D;break;case"rotation":this._propertySpecialization=PropertySpecialization.NodeRotation,this._blendFunction=additiveQuat;break;case"scale":this._propertySpecialization=PropertySpecialization.NodeScale,this._blendFunction=additive3D}this._blendTarget=i}return _createClass(r,[{key:"attachToBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=e.refPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"dettachFromBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=null,e.derefPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"applySample",value:function(e,t,i,r,n){var s;this._curve.empty()||(s=i?this._curve.valueBetween(e,r.from,r.fromRatio,r.to,r.toRatio):this._curve.valueAt(t),this._setValue(s,n))}},{key:"_setValue",value:function(e,t){if(!this._blendFunction||!this._blendTarget||this._blendTarget.refCount<=1)switch(this._propertySpecialization){case PropertySpecialization.NodePosition:this._rootTarget.setPosition(e);break;case PropertySpecialization.NodeRotation:this._rootTarget.setRotation(e);break;case PropertySpecialization.NodeScale:this._rootTarget.setScale(e);break;default:this._boundTarget.setValue(e)}else this._blendTarget.value=this._blendFunction(e,t,this._blendTarget),this._blendTarget.weight+=t}},{key:"propertyName",get:function(){return this._rootTargetProperty||""}},{key:"curveDetail",get:function(){return this._curveDetail}}]),r}();function makeSamplerSharedGroup(e){return{sampler:e,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}}}var _dec2$v,_class4$4,_class5$4,_descriptor4$i,_descriptor5$d,_descriptor6$6,_temp2$4,InvalidIndex=-1,AnimationState=function(){function r(e,t){var i;return _classCallCheck(this,r),(i=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this))).duration=1,i.speed=1,i.time=0,i.weight=0,i.frameRate=0,i._lastframeEventOn=!1,i._wrapMode=WrapMode$2.Normal,i._repeatCount=1,i._currentFramePlayed=!1,i._delay=0,i._delayTime=0,i._wrappedInfo=new WrappedInfo,i._lastWrapInfo=null,i._lastWrapInfoEvent=null,i._process=i.process,i._target=null,i._targetNode=null,i._clip=void 0,i._name=void 0,i._lastIterations=void 0,i._samplerSharedGroups=[],i._curveLoaded=!1,i._ignoreIndex=InvalidIndex,i._clip=e,i._name=t||e&&e.name,i}return _inherits(r,Playable),_createClass(r,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){this._wrapMode=e,this.time=0,e&WrapModeMask.Loop?this.repeatCount=1/0:this.repeatCount=1}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&WrapModeMask.ShouldWrap,i=(this.wrapMode&WrapModeMask.Reverse)===WrapModeMask.Reverse;this._process=e!==1/0||t||i?this.process:this.simpleProcess}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}}]),_createClass(r,[{key:"initialize",value:function(r){var n=this;if(!this._curveLoaded){this._curveLoaded=!0,this._samplerSharedGroups.length=0,this._targetNode=r;var e=this._clip;this.duration=e.duration,this.speed=e.speed,this.wrapMode=e.wrapMode,this.frameRate=e.sample,(this.wrapMode&WrapModeMask.Loop)===WrapModeMask.Loop?this.repeatCount=1/0:this.repeatCount=1;for(var s=e.getPropertyCurves(),t=function(e){var t=s[e],i=n._samplerSharedGroups.find(function(e){return e.sampler===t.sampler});i||(i=makeSamplerSharedGroup(t.sampler),n._samplerSharedGroups.push(i));try{i.curves.push(new ICurveInstance(t,r))}catch(e){}},i=0;i<s.length;++i)t(i)}}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"emit",value:function(){for(var e=new Array(arguments.length),t=0,i=e.length;t<i;t++)e[t]=t<0||arguments.length<=t?void 0:arguments[t];cc.director.getAnimationManager().pushDelayEvent(this,"_emit",e)}},{key:"on",value:function(e,t,i){return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.on(e,t,i)):null}},{key:"once",value:function(e,t,i){var r=this;return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.once(e,function(e){t.call(i,e),r._lastframeEventOn=!1})):null}},{key:"off",value:function(e,t,i){this._target&&this._target.isValid&&("lastframe"===e&&(this._target.hasEventListener(e)||(this._lastframeEventOn=!1)),this._target.off(e,t,i))}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0,this._lastWrapInfoEvent=null,this._ignoreIndex=InvalidIndex;var t=this.getWrappedInfo(e,this._wrappedInfo),i=t.direction,r=this._clip.getEventGroupIndexAtRatio(t.ratio);r<0&&(r=~r-1,i<0&&(r+=1),this._ignoreIndex=r)}},{key:"update",value:function(e){0<this._delayTime&&(this._delayTime-=e,0<this._delayTime)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}},{key:"_needReverse",value:function(e){var t=this.wrapMode,i=!1;(t&WrapModeMask.PingPong)===WrapModeMask.PingPong&&(e-(0|e)==0&&0<e&&(e-=1),1&e&&(i=!i));return(t&WrapModeMask.Reverse)===WrapModeMask.Reverse&&(i=!i),i}},{key:"getWrappedInfo",value:function(e,t){t=t||new WrappedInfo;var i=!1,r=this.duration,n=this.repeatCount,s=0<e?e/r:-e/r;if(n<=s){i=!0;var a=(s=n)-(0|n);0===a&&(a=1),e=a*r*(0<e?1:-1)}if(r<e){var o=e%r;e=0==o?r:o}else e<0&&0!==(e%=r)&&(e+=r);var c=!1,l=this._wrapMode&WrapModeMask.ShouldWrap;l&&(c=this._needReverse(s));var u=c?-1:1;return this.speed<0&&(u*=-1),l&&c&&(e=r-e),t.ratio=e/r,t.time=e,t.direction=u,t.stopped=i,t.iterations=s,t}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e}},{key:"process",value:function(){var e,t=this.sample();this._lastframeEventOn&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new WrappedInfo(t),1<this.repeatCount&&(0|t.iterations)>(0|e.iterations)&&this.emit("lastframe",this),e.set(t));t.stopped&&(this.stop(),this.emit("finished",this))}},{key:"simpleProcess",value:function(){var e=this.time,t=this.duration;t<e?0===(e%=t)&&(e=t):e<0&&0!==(e%=t)&&(e+=t);var i=e/t;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._lastframeEventOn&&(void 0===this._lastIterations&&(this._lastIterations=i),(0<this.time&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit("lastframe",this),this._lastIterations=i)}},{key:"attachToBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n.curves,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if(a){if(o>=s.length)break;c=s[o++]}else{if((o=s.next()).done)break;c=o.value}c.attachToBlendState(e)}}}},{key:"detachFromBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n.curves,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if(a){if(o>=s.length)break;c=s[o++]}else{if((o=s.next()).done)break;c=o.value}c.dettachFromBlendState(e)}}}},{key:"cache",value:function(e){}},{key:"onPlay",value:function(){this.setTime(0),this._delayTime=this._delay,cc.director.getAnimationManager().addAnimation(this),this.emit("play",this)}},{key:"onStop",value:function(){this.isPaused||cc.director.getAnimationManager().removeAnimation(this),this.emit("stop",this)}},{key:"onResume",value:function(){cc.director.getAnimationManager().addAnimation(this),this.emit("resume",this)}},{key:"onPause",value:function(){cc.director.getAnimationManager().removeAnimation(this),this.emit("pause",this)}},{key:"_sampleCurves",value:function(e){for(var t=0,i=this._samplerSharedGroups.length;t<i;++t){var r=this._samplerSharedGroups[t],n=r.sampler,s=r.samplerResultCache,a=0,o=!1;n?(a=n.sample(e))<0&&((a=~a)<=0?a=0:a>=n.ratios.length?a=n.ratios.length-1:(o=!0,s.from=a-1,s.fromRatio=n.ratios[s.from],s.to=a,s.toRatio=n.ratios[s.to])):a=0;for(var c=0,l=r.curves.length;c<l;++c){r.curves[c].applySample(e,a,o,s,this.weight)}}}},{key:"_sampleEvents",value:function(e){var t=this._clip.eventGroups.length,i=e.direction,r=this._clip.getEventGroupIndexAtRatio(e.ratio);if(r<0&&(r=~r-1,i<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=InvalidIndex),e.frameIndex=r,!this._lastWrapInfoEvent)return this._fireEvent(r),void(this._lastWrapInfoEvent=new WrappedInfo(e));var n=this.wrapMode,s=wrapIterations(e.iterations),a=this._lastWrapInfoEvent,o=wrapIterations(a.iterations),c=a.frameIndex,l=a.direction,u=-1!==o&&s!==o;if(c===r&&u&&1===t)this._fireEvent(0);else if(c!==r||u){i=l;do{if(c!==r){if(-1===i&&0===c&&0<r?((n&WrapModeMask.PingPong)===WrapModeMask.PingPong?i*=-1:c=t,o++):1===i&&c===t-1&&r<t-1&&((n&WrapModeMask.PingPong)===WrapModeMask.PingPong?i*=-1:c=-1,o++),c===r)break;if(s<o)break}c+=i,cc.director.getAnimationManager().pushDelayEvent(this,"_fireEvent",[c])}while(c!==r&&-1<c&&c<t)}this._lastWrapInfoEvent.set(e)}},{key:"_fireEvent",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._clip.eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e)){var i=t[e],r=this._targetNode.components,n=i.events,s=Array.isArray(n),a=0;for(n=s?n:n[Symbol.iterator]();;){var o;if(s){if(a>=n.length)break;o=n[a++]}else{if((a=n.next()).done)break;o=a.value}var c=o,l=c.functionName,u=r,h=Array.isArray(u),_=0;for(u=h?u:u[Symbol.iterator]();;){var p;if(h){if(_>=u.length)break;p=u[_++]}else{if((_=u.next()).done)break;p=_.value}var d=p,f=d[l];"function"==typeof f&&f.apply(d,c.parameters)}}}}}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),r}();function wrapIterations(e){return e-(0|e)==0&&(e-=1),0|e}function makeCubicSplineValueConstructor(e,n,u,h){var t,i,s,a,o,_=new n,p=new n,d=new n,r=ccclass(e)((s=_applyDecoratedDescriptor((i=function(){function r(e,t,i){_classCallCheck(this,r),_initializerDefineProperty(this,"dataPoint",s,this),_initializerDefineProperty(this,"inTangent",a,this),_initializerDefineProperty(this,"outTangent",o,this),this.dataPoint=e||new n,this.inTangent=t||new n,this.outTangent=i||new n}return _createClass(r,[{key:"lerp",value:function(e,t,i){var r=this.dataPoint,n=e.dataPoint;p=u(p,this.inTangent,i),d=u(d,e.outTangent,i);var s=t*t*t,a=t*t,o=s-2*a+t,c=-2*s+3*a,l=s-a;return _=u(_,r,2*s-3*a+1),_=h(_,_,p,o),_=h(_,_,n,c),_=h(_,_,d,l)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),r}()).prototype,"dataPoint",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new n}}),a=_applyDecoratedDescriptor(i.prototype,"inTangent",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new n}}),o=_applyDecoratedDescriptor(i.prototype,"outTangent",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new n}}),t=i))||t;if(n===Quat){var c=r.prototype.lerp;r.prototype.lerp=function(e,t,i){var r=c.call(this,e,t,i);return Quat.normalize(r,r),r}}return r}cc.AnimationState=AnimationState;var CubicSplineVec2Value=makeCubicSplineValueConstructor("cc.CubicSplineVec2Value",Vec2,Vec2.multiplyScalar,Vec2.scaleAndAdd);cc.CubicSplineVec2Value=CubicSplineVec2Value;var CubicSplineVec3Value=makeCubicSplineValueConstructor("cc.CubicSplineVec3Value",Vec3,Vec3.multiplyScalar,Vec3.scaleAndAdd);cc.CubicSplineVec3Value=CubicSplineVec3Value;var CubicSplineVec4Value=makeCubicSplineValueConstructor("cc.CubicSplineVec4Value",Vec4,Vec4.multiplyScalar,Vec4.scaleAndAdd);cc.CubicSplineVec4Value=CubicSplineVec4Value;var CubicSplineQuatValue=makeCubicSplineValueConstructor("cc.CubicSplineQuatValue",Quat,Quat.multiplyScalar,Quat.scaleAndAdd);cc.CubicSplineQuatValue=CubicSplineQuatValue;var CubicSplineNumberValue=(_dec2$v=ccclass("cc.CubicSplineNumberValue"))((_descriptor4$i=_applyDecoratedDescriptor((_class5$4=_temp2$4=function(){function r(e,t,i){_classCallCheck(this,r),_initializerDefineProperty(this,"dataPoint",_descriptor4$i,this),_initializerDefineProperty(this,"inTangent",_descriptor5$d,this),_initializerDefineProperty(this,"outTangent",_descriptor6$6,this),this.dataPoint=e,this.inTangent=t,this.outTangent=i}return _createClass(r,[{key:"lerp",value:function(e,t,i){var r=this.dataPoint,n=e.dataPoint,s=t*t*t,a=t*t;return r*(2*s-3*a+1)+this.outTangent*i*(s-2*a+t)+n*(-2*s+3*a)+e.inTangent*i*(s-a)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),r}()).prototype,"dataPoint",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor5$d=_applyDecoratedDescriptor(_class5$4.prototype,"inTangent",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor6$6=_applyDecoratedDescriptor(_class5$4.prototype,"outTangent",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_class4$4=_class5$4))||_class4$4;cc.CubicSplineNumberValue=CubicSplineNumberValue;var _dec$R,_dec2$w,_dec3$i,_dec4$f,_dec5$d,_dec6$a,_class$S,_class2$J,_descriptor$G,_descriptor2$v,_descriptor3$m,_class3$j,_temp$M,CrossFade=function(){function i(){var e;return _classCallCheck(this,i),(e=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this)))._managedStates=[],e._fadings=[],e}return _inherits(i,Playable),_createClass(i,[{key:"update",value:function(e){if(this.isPlaying&&!this.isPaused){for(var t=0;t<this._managedStates.length;++t){var i=this._managedStates[t].state;i&&(i.weight=0)}for(var r=1,n=this._fadings.length,s=0;s<this._fadings.length;++s){if(0===r){n=s;break}var a=this._fadings[s];a.easeTime+=e;var o=clamp01(a.easeTime/a.easeDuration),c=o*r;r*=1-o,a.target.state&&(a.target.state.weight+=c)}if(n!==this._fadings.length){for(var l=n;l<this._fadings.length;++l){var u=this._fadings[l];--u.target.reference,u.target.reference<=0&&(u.target.state&&u.target.state.stop(),remove(this._managedStates,u.target))}this._fadings.splice(n)}}}},{key:"crossFade",value:function(t,e){0===e&&this.clear();var i=this._managedStates.find(function(e){return e.state===t});i||(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i})}},{key:"clear",value:function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}},{key:"onPlay",value:function(){_get(_getPrototypeOf(i.prototype),"onPlay",this).call(this),cc.director.getAnimationManager().addCrossFade(this)}},{key:"onPause",value:function(){_get(_getPrototypeOf(i.prototype),"onPause",this).call(this),cc.director.getAnimationManager().removeCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.pause()}}},{key:"onResume",value:function(){_get(_getPrototypeOf(i.prototype),"onResume",this).call(this),cc.director.getAnimationManager().addCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.resume()}}},{key:"onStop",value:function(){_get(_getPrototypeOf(i.prototype),"onStop",this).call(this),cc.director.getAnimationManager().removeCrossFade(this),this.clear()}}]),i}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(exports.EventType||(exports.EventType={})),ccenum(exports.EventType);var AnimationComponent=(_dec$R=ccclass("cc.AnimationComponent"),_dec2$w=executionOrder(99),_dec3$i=menu("Components/Animation"),_dec4$f=property({type:[AnimationClip]}),_dec5$d=property({type:AnimationClip}),_dec6$a=property({type:[AnimationClip]}),_dec$R(_class$S=_dec2$w(_class$S=executeInEditMode(_class$S=_dec3$i((_temp$M=_class3$j=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"playOnLoad",_descriptor$G,_assertThisInitialized(t)),t._callbackTable=createMap(!0),t._crossFade=new CrossFade,t._nameToState=createMap(!0),_initializerDefineProperty(t,"_clips",_descriptor2$v,_assertThisInitialized(t)),_initializerDefineProperty(t,"_defaultClip",_descriptor3$m,_assertThisInitialized(t)),t}return _inherits(s,Component),_createClass(s,[{key:"onLoad",value:function(){this.clips=this._clips;for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].initialize(this.node)}}},{key:"start",value:function(){this.playOnLoad&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade.pause()}},{key:"onDestroy",value:function(){this._crossFade.stop();for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].stop()}this._nameToState=createMap(!0)}},{key:"play",value:function(e){if(!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:.3,r=this._nameToState[e];r&&(this._crossFade.play(),this._crossFade.crossFade(r,i))}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getAnimationState",value:function(e){return this.getState(e)}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return contains(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(t,e){for(var i,r=0,n=Object.keys(this._nameToState);r<n.length;r++){var s=n[r];if((i=this._nameToState[s]).clip===t)break}if(t===this._defaultClip){if(!e)return void warnID(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void warnID(3903);i.stop()}this._clips=this._clips.filter(function(e){return e!==t}),i&&delete this._nameToState[i.name]}},{key:"on",value:function(e,t,i){var r=EventTarget.prototype.on.call(this,e,t,i);if("lastframe"===e)for(var n=0,s=Object.keys(this._nameToState);n<s.length;n++){var a=s[n];this._nameToState[a]._lastframeEventOn=!0}return r}},{key:"off",value:function(e,t,i){if("lastframe"===e)for(var r=this._nameToState,n=0,s=Object.keys(r);n<s.length;n++){r[s[n]]._lastframeEventOn=!1}EventTarget.prototype.off.call(this,e,t,i)}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"_createState",value:function(e,t){return new AnimationState(e,t)}},{key:"_doCreateState",value:function(e,t){var i=this._createState(e,t);return i._setEventTarget(this),this.node&&i.initialize(this.node),this._nameToState[i.name]=i}},{key:"_getStateByNameOrDefaultClip",value:function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}var t=this._nameToState[e];return t||null}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var i=this._nameToState[t];equalClips(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}},{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();var i=this._clips,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;a&&this._removeStateOfAutomaticClip(a)}var o=e,c=Array.isArray(o),l=0;for(o=c?o:o[Symbol.iterator]();;){var u;if(c){if(l>=o.length)break;u=o[l++]}else{if((l=o.next()).done)break;u=l.value}var h=u;h&&this.createState(h)}var _=e.find(function(e){return equalClips(e,t._defaultClip)});this._defaultClip=_||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){(this._defaultClip=t)&&(0<=this._clips.findIndex(function(e){return equalClips(e,t)})||(this._clips.push(t),this.createState(t)))}}]),s}(),_class3$j.EventType=exports.EventType,_applyDecoratedDescriptor((_class2$J=_temp$M).prototype,"clips",[_dec4$f],Object.getOwnPropertyDescriptor(_class2$J.prototype,"clips"),_class2$J.prototype),_applyDecoratedDescriptor(_class2$J.prototype,"defaultClip",[_dec5$d],Object.getOwnPropertyDescriptor(_class2$J.prototype,"defaultClip"),_class2$J.prototype),_descriptor$G=_applyDecoratedDescriptor(_class2$J.prototype,"playOnLoad",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2$v=_applyDecoratedDescriptor(_class2$J.prototype,"_clips",[_dec6$a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor3$m=_applyDecoratedDescriptor(_class2$J.prototype,"_defaultClip",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$S=_class2$J))||_class$S)||_class$S)||_class$S)||_class$S),_AnimationComponent$p=AnimationComponent.prototype,on=_AnimationComponent$p.on,off=_AnimationComponent$p.off;function equalClips(e,t){return e===t||!(!e||!t||e.name!==t.name&&e._uuid!==t._uuid)}applyMixins(AnimationComponent,[CallbacksInvoker,EventTarget]),AnimationComponent.prototype.on=on,AnimationComponent.prototype.off=off,cc.AnimationComponent=AnimationComponent;var m4_1$4=new Mat4;function getPathFromRoot(e,t){for(var i=e,r="";null!==i&&i!==t;)r="".concat(i.name,"/").concat(r),i=i.parent;return r.slice(0,-1)}function getWorldTransformUntilRoot(e,t,i){for(Mat4.identity(i);e!==t;)Mat4.fromRTS(m4_1$4,e.rotation,e.position,e.scale),Mat4.multiply(i,m4_1$4,i),e=e.parent}var m4_1$5=new Mat4;function isFrameIDCurve(e){return 3===e.length&&e[0]instanceof HierachyModifier&&e[1]instanceof ComponentModifier&&"frameID"===e[2]}var _dec$S,_dec2$x,_class$T,_class2$K,_descriptor$H,_descriptor2$w,_temp$N,_dec3$j,_dec4$g,_dec5$e,_dec6$b,_dec7$8,_class4$5,_class5$5,_descriptor3$n,_class6,_temp2$5,SkeletalAnimationState=function(){function r(){return _classCallCheck(this,r),_possibleConstructorReturn(this,_getPrototypeOf(r).apply(this,arguments))}return _inherits(r,AnimationState),_createClass(r,[{key:"initialize",value:function(e){SkelAnimDataHub.getOrExtract(this.clip),_get(_getPrototypeOf(r.prototype),"initialize",this).call(this,e)}},{key:"onPlay",value:function(){_get(_getPrototypeOf(r.prototype),"onPlay",this).call(this);for(var e=this._targetNode.getComponentsInChildren(SkinningModelComponent),t=0;t<e.length;++t){var i=e[t];i.skinningRoot===this._targetNode&&i.uploadAnimation(this.clip)}}},{key:"rebuildSocketCurves",value:function(e){if(this._samplerSharedGroups.length){for(var t=this._samplerSharedGroups[0].curves,i=0;i<t.length;i++){isFrameIDCurve(t[i].curveDetail.modifiers)||t.splice(i--,1)}for(var r=0;r<e.length;++r){var n=this._buildSocketData(e[r]);n&&t.push(n)}}}},{key:"_buildSocketData",value:function(e){if(!this._targetNode)return null;var t=this._targetNode,i=t.getChildByPath(e.path);if(!i||!e.target)return null;for(var r=e.path,n=SkelAnimDataHub.getOrExtract(this.clip),s=r,a=n[s],o=i;!a||!a.props;){var c=s.lastIndexOf("/");if(a=n[s=s.substring(0,c)],o=o.parent,c<0)return null}var l={matrix:{keys:0,interpolate:!1,values:a.props.worldMatrix.values.map(function(e){return e.clone()})}},u=l.matrix.values;getWorldTransformUntilRoot(i,o,m4_1$5);for(var h=0;h<u.length;h++){var _=u[h];Mat4.multiply(_,_,m4_1$5)}var p=this.clip.duration,d=new HierachyModifier;return new ICurveInstance({curve:new AnimCurve(l.matrix,p),modifiers:[d,"matrix"]},e.target)}}]),r}();cc.SkeletalAnimationState=SkeletalAnimationState;var Socket=(_dec$S=ccclass("cc.SkeletalAnimationComponent.Socket"),_dec2$x=property(Node$1),_dec$S((_descriptor$H=_applyDecoratedDescriptor((_class2$K=_temp$N=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;_classCallCheck(this,e),_initializerDefineProperty(this,"path",_descriptor$H,this),_initializerDefineProperty(this,"target",_descriptor2$w,this),this.path=t,this.target=i}).prototype,"path",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor2$w=_applyDecoratedDescriptor(_class2$K.prototype,"target",[_dec2$x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$T=_class2$K))||_class$T),m4_1$6=new Mat4,m4_2$1=new Mat4;function collectRecursively(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],r=0;r<e.children.length;r++){var n=e.children[r];if(n){var s=t?"".concat(t,"/").concat(n.name):n.name;i.push(s),collectRecursively(n,s,i)}}return i}var _dec$T,_class$U,_class2$L,_descriptor$I,_descriptor2$x,_temp$O,SkeletalAnimationComponent=(_dec3$j=ccclass("cc.SkeletalAnimationComponent"),_dec4$g=executionOrder(99),_dec5$e=menu("Components/SkeletalAnimation"),_dec6$b=property({type:[Socket]}),_dec7$8=property({type:[Socket]}),_dec3$j(_class4$5=_dec4$g(_class4$5=executeInEditMode(_class4$5=_dec5$e((_temp2$5=_class6=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_sockets",_descriptor3$n,_assertThisInitialized(t)),t._animInfo=null,t}return _inherits(s,AnimationComponent),_createClass(s,[{key:"onLoad",value:function(){_get(_getPrototypeOf(s.prototype),"onLoad",this).call(this),this._animInfo=JointsAnimationInfo.create(this.node.uuid)}},{key:"onDestroy",value:function(){this._animInfo&&(JointsAnimationInfo.destroy(this.node.uuid),this._animInfo=null),_get(_getPrototypeOf(s.prototype),"onDestroy",this).call(this)}},{key:"start",value:function(){_get(_getPrototypeOf(s.prototype),"start",this).call(this),this.sockets=this._sockets}},{key:"querySockets",value:function(){var e=this._defaultClip&&Object.keys(SkelAnimDataHub.getOrExtract(this._defaultClip)).sort().reduce(function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e},[])||[];if(!e.length)return["default animation clip missing/invalid"];for(var t=[],i=0;i<e.length;i++){var r=e[i],n=this.node.getChildByPath(r);n&&(t.push(r),collectRecursively(n,r,t))}return t}},{key:"rebuildSocketAnimations",value:function(){var e=this._sockets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r,s=this.node.getChildByPath(n.path),a=n.target;s&&a&&(a.name="".concat(n.path.substring(n.path.lastIndexOf("/")+1)," Socket"),a.parent=this.node,getWorldTransformUntilRoot(s,this.node,m4_1$6),Mat4.fromRTS(m4_2$1,a.rotation,a.position,a.scale),Mat4.equals(m4_2$1,m4_1$6)||(a.matrix=m4_1$6))}for(var o=0,c=Object.keys(this._nameToState);o<c.length;o++){var l=c[o];this._nameToState[l].rebuildSocketCurves(this._sockets)}}},{key:"createSocket",value:function(t){var e=this._sockets.find(function(e){return e.path===t});if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var i=new Node$1;return i.parent=this.node,this._sockets.push(new Socket(t,i)),this.rebuildSocketAnimations(),i}},{key:"_createState",value:function(e,t){return new SkeletalAnimationState(e,t)}},{key:"_doCreateState",value:function(e,t){var i=_get(_getPrototypeOf(s.prototype),"_doCreateState",this).call(this,e,t);return i.rebuildSocketCurves(this._sockets),i}},{key:"sockets",get:function(){return this._sockets},set:function(e){this._sockets=e,this.rebuildSocketAnimations()}},{key:"frameID",set:function(e){if(this._animInfo){var t=this._animInfo,i=t.data,r=t.buffer;i[1]=e,r.update(i)}},get:function(){return this._animInfo&&this._animInfo.data[1]||0}}]),s}(),_class6.Socket=Socket,_descriptor3$n=_applyDecoratedDescriptor((_class5$5=_temp2$5).prototype,"_sockets",[_dec6$b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_applyDecoratedDescriptor(_class5$5.prototype,"sockets",[_dec7$8],Object.getOwnPropertyDescriptor(_class5$5.prototype,"sockets"),_class5$5.prototype),_class4$5=_class5$5))||_class4$5)||_class4$5)||_class4$5)||_class4$5);cc.SkeletalAnimationComponent=SkeletalAnimationComponent;var _dec$U,_class$V,_temp$P,UniformCurveValueAdapter=(_dec$T=ccclass("cc.UniformCurveValueAdapter"))((_descriptor$I=_applyDecoratedDescriptor((_class2$L=_temp$O=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"passIndex",_descriptor$I,_assertThisInitialized(t)),_initializerDefineProperty(t,"uniformName",_descriptor2$x,_assertThisInitialized(t)),t}return _inherits(s,CurveValueAdapter),_createClass(s,[{key:"forTarget",value:function(e){var i=e.passes[this.passIndex],t=i.getHandle(this.uniformName);if(void 0===t)throw new Error('Material "'.concat(e.name,'" has no uniform "').concat(this.uniformName,'"'));var r=Pass.getBindingTypeFromHandle(t);if(r===exports.GFXBindingType.UNIFORM_BUFFER)return isUniformArray(i,this.uniformName)?{set:function(e){i.setUniformArray(t,e)}}:{set:function(e){i.setUniform(t,e)}};if(r!==exports.GFXBindingType.SAMPLER)throw new Error("Animations are not avaiable for uniforms with binding type ".concat(r,"."));var n=Pass.getBindingFromHandle(t),s=i.properties[this.uniformName],a=s&&s.value?s.value+"-texture":type2default[s.type],o=builtinResMgr.get(a);return o||(console.warn("illegal texture default value: "+a),o=builtinResMgr.get("default-texture")),{set:function(e){var t=(e=e||o).getGFXTextureView();t&&t.texture.width&&t.texture.height&&(i.bindTextureView(n,t),e instanceof TextureBase&&i.bindSampler(n,samplerLib.getSampler(cc.game._gfxDevice,e.getSamplerHash())))}}}}]),s}()).prototype,"passIndex",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor2$x=_applyDecoratedDescriptor(_class2$L.prototype,"uniformName",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_class$U=_class2$L))||_class$U;function isUniformArray(e,t){var i=e.shaderInfo.blocks,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s.members,o=Array.isArray(a),c=0;for(a=o?a:a[Symbol.iterator]();;){var l;if(o){if(c>=a.length)break;l=a[c++]}else{if((c=a.next()).done)break;l=c.value}var u=l;if(u.name===t)return 1<u.count}}return!1}cc.UniformCurveValueAdapter=UniformCurveValueAdapter,exports.replaceProperty(AnimationComponent.prototype,"AnimationComponent",[{name:"getAnimationState",newName:"getState"},{name:"removeClip",newName:"removeState",customFunction:function(e){var t=arguments.length<=0?void 0:e;return AnimationComponent.prototype.removeState.call(this,t.name)}}]),cc.easing=easing;var _dec$V,_class$W,_temp$Q,Counter=(_dec$U=ccclass("cc.Counter"))(_class$V=_temp$P=function(){function r(e,t,i){_classCallCheck(this,r),this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=i}return _createClass(r,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),_createClass(r,[{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e,i=this._opts.average?this._averageValue:this._value;return t?Math.round(100*i)/100:Math.round(i)}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var r=i;r-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=r,this._accumSamples=0)}}}]),r}())||_class$V,PerfCounter=(_dec$V=ccclass("cc.PerfCounter"))(_class$W=_temp$Q=function(){function n(e,t,i){var r;return _classCallCheck(this,n),(r=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this,e,t,i)))._time=void 0,r._time=i,r}return _inherits(n,Counter),_createClass(n,[{key:"start",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;this._time=t}},{key:"end",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;this._value=t-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,i=t-this._time;this._total++,(this._opts.average||1e3)<i&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}}]),n}())||_class$W,characters="0123456789. ",Profiler=function(){function e(){_classCallCheck(this,e),this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._fontSize=24,this._lineHeight=this._fontSize+2,this._wordHeight=0,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._textureView=null,this._region=new GFXBufferTextureCopy,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._rowNumber=9,this._columnNumber=8,this._posWordWidth=.18,this._posBaseHeight=.18,this._posNumWidth=.09,this._eachNumWidth=0,this.lastTime=0,this._string2offset={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},this._uvOffset=[],this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._region=new GFXBufferTextureCopy,this._canvasArr.push(this._canvas)}return _createClass(e,[{key:"isShowingStats",value:function(){return this._showFPS}},{key:"hideStats",value:function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),director.off(Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),director.off(Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),director.off(Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),director.off(Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),director.off(Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),director.off(Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)}},{key:"showStats",value:function(){this._showFPS||(this.initDevice(),this.generateCanvas(),this.generateStats(),this._rootNode&&(this._rootNode.active=!0),director.on(Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),director.on(Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),director.on(Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),director.on(Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),director.on(Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),director.on(Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)}},{key:"initDevice",value:function(){this._device||(this._device=director.root.device)}},{key:"generateCanvas",value:function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width="".concat(this._canvas.width),this._canvas.style.height="".concat(this._canvas.height),this._ctx.font="".concat(this._fontSize,"px Arial"),this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.SAMPLED,format:exports.GFXFormat.RGBA8,width:256,height:256,mipLevel:1}),this._textureView=this._device.createTextureView({texture:this._texture,type:exports.GFXTextureViewType.TV2D,format:exports.GFXFormat.RGBA8}),this._region.texExtent.width=256,this._region.texExtent.height=256)}}},{key:"generateStats",value:function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null,this._inited=!1;var e=performance.now(),t={frame:{desc:"Frame time (ms)",min:0,max:50,average:500},fps:{desc:"Framerate (FPS)",below:30,average:500},draws:{desc:"Draw call"},tricount:{desc:"Triangle"},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}};this._ctx.textAlign="left";var i=0;for(var r in t){var n=t[r];this._ctx.fillText(n.desc,0,i*this._lineHeight),n.counter=new PerfCounter(r,n,e),i++}this._wordHeight=i*this._lineHeight/this._canvas.height,this._eachNumWidth=this._ctx.measureText("0").width/this._canvas.width;for(var s=this._eachNumWidth*this._canvas.width,a=new Array,o=0,c=a[0]=0;c<characters.length;++c)this._ctx.fillText(characters[c],c*s,i*this._lineHeight),o+=this._eachNumWidth,a[c+1]=o;for(var l=Math.ceil(a.length/4),u=0;u<l;u++)this._uvOffset.push(new Vec4(a[4*u],a[4*u+1],a[4*u+2],a[4*u+3]));this._stats=t,this._canvasArr[0]=this._canvas,this.updateTexture(),this._inited=!0}}},{key:"generateNode",value:function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new Node$1("PROFILER_NODE"),cc.game.addPersistRootNode(this._rootNode);var e=new Node$1("Profiler_Camera");e.setPosition(0,0,1),e.parent=this._rootNode;var t=e.addComponent("cc.CameraComponent");t.projection=CameraComponent.ProjectionType.ORTHO,t.near=0,t.far=0,t.orthoHeight=this._device.height,t.visibility=Layers.BitMask.PROFILER,t.clearFlags=exports.GFXClearFlag.NONE,t.priority=4294967295;var i=new Node$1("Profiler_Root");i.parent=this._rootNode;for(var r,n=this._posNumWidth/this._columnNumber,s=this._posBaseHeight/this._rowNumber,a=[0,this._posBaseHeight,0,this._posBaseHeight,this._posBaseHeight,0,this._posWordWidth,0,0,0,0,0],o=[0,2,1,0,3,2],c=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],l=0;l<this._rowNumber;l++)for(var u=0;u<this._columnNumber;u++){a.push(this._posWordWidth+u*n,this._posBaseHeight-l*s,0),a.push(this._posWordWidth+(u+1)*n,this._posBaseHeight-l*s,0),a.push(this._posWordWidth+(u+1)*n,this._posBaseHeight-(l+1)*s,0),a.push(this._posWordWidth+u*n,this._posBaseHeight-(l+1)*s,0),r=4*(l*this._columnNumber+u+1),o.push(0+r,2+r,1+r,0+r,3+r,2+r);var h=l*this._columnNumber+u,_=Math.floor(h/4),p=h-4*_;c.push(0,this._wordHeight,_,p),c.push(this._eachNumWidth,this._wordHeight,_,p),c.push(this._eachNumWidth,1,_,p),c.push(0,1,_,p)}var d=i.addComponent("cc.ModelComponent");d.mesh=createMesh({positions:a,indices:o,colors:c});var f=new Material;f.initialize({effectName:"util/profiler"}),f.setProperty("offset",new Vec4(-.9,-.9,0,0)),f.setProperty("symbols",this._uvOffset);var m=f.passes[0],y=m.getBinding("mainTexture");m.bindTextureView(y,this._textureView);var v=m.getBinding("digits");this.digitsData=m.blocks[v],d.material=f,d.node.layer=Layers.Enum.PROFILER}}},{key:"beforeUpdate",value:function(){if(this._stats){this.generateNode();var e=performance.now();this.getCounter("frame").end(e),this.getCounter("frame").start(e),this.getCounter("logic").start(e)}}},{key:"afterUpdate",value:function(){if(this._stats){var e=performance.now();director.isPaused()?this.getCounter("frame").start(e):this.getCounter("logic").end(e)}}},{key:"beforePhysics",value:function(){if(this._stats){var e=performance.now();this.getCounter("physics").start(e)}}},{key:"afterPhysics",value:function(){if(this._stats){var e=performance.now();this.getCounter("physics").end(e)}}},{key:"beforeDraw",value:function(){if(this._stats){var e=performance.now();this.getCounter("render").start(e)}}},{key:"afterDraw",value:function(){if(this._stats&&this._inited){var e=performance.now();if(this.getCounter("fps").frame(e),this.getCounter("render").end(e),!(e-this.lastTime<500)){this.lastTime=e;var t=this._device;this.getCounter("draws").value=t.numDrawCalls,this.getCounter("bufferMemory").value=t.memoryStatus.bufferSize/1048576,this.getCounter("textureMemory").value=t.memoryStatus.textureSize/1048576,this.getCounter("tricount").value=t.numTris;var i=0,r=this.digitsData.view;for(var n in this._stats){var s=this._stats[n];s.counter.sample(e);for(var a=s.counter.human(!("Framerate (FPS)"===s.desc)).toString(),o=this._columnNumber-1;0<=o;o--){var c=i*this._columnNumber+o,l=a[a.length-(this._columnNumber-o)],u=this._string2offset[l];void 0===u&&(u=11),r[c]=u}i++}this.digitsData.dirty=!0}}}},{key:"getCounter",value:function(e){return this._stats[e].counter}},{key:"updateTexture",value:function(){director.root.device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}}]),e}(),profiler=new Profiler;cc.profiler=profiler;var vmath={};function createIA(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],r=t.positions.length/3,n=0;n<r;++n)i.push(t.positions[3*n],t.positions[3*n+1],t.positions[3*n+2]),t.normals&&i.push(t.normals[3*n],t.normals[3*n+1],t.normals[3*n+2]),t.uvs&&i.push(t.uvs[2*n],t.uvs[2*n+1]),t.colors&&i.push(t.colors[3*n],t.uvs[3*n+1],t.colors[3*n+2]);var s=[];s.push({name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F}),t.normals&&s.push({name:exports.GFXAttributeName.ATTR_NORMAL,format:exports.GFXFormat.RGB32F}),t.uvs&&s.push({name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RG32F}),t.colors&&s.push({name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGB32F});var a=e.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:4*i.length,stride:4*i.length/r});a.update(new Float32Array(i));var o=e.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:2*t.indices.length,stride:2});return o.update(new Uint16Array(t.indices)),e.createInputAssembler({attributes:s,vertexBuffers:[a],indexBuffer:o})}exports.replaceProperty(vmath,"vmath",[{name:"vec2",newName:"Vec2",target:math,targetName:"math"},{name:"vec3",newName:"Vec3",target:math,targetName:"math"},{name:"vec4",newName:"Vec4",target:math,targetName:"math"},{name:"quat",newName:"Quat",target:math,targetName:"math"},{name:"mat3",newName:"Mat3",target:math,targetName:"math"},{name:"mat4",newName:"Mat4",target:math,targetName:"math"},{name:"color4",newName:"Color",target:math,targetName:"math"},{name:"rect",newName:"Rect",target:math,targetName:"math"},{name:"approx",newName:"approx",target:math,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:math,targetName:"math"},{name:"equals",newName:"equals",target:math,targetName:"math"},{name:"clamp",newName:"clamp",target:math,targetName:"math"},{name:"clamp01",newName:"clamp01",target:math,targetName:"math"},{name:"lerp",newName:"lerp",target:math,targetName:"math"},{name:"toRadian",newName:"toRadian",target:math,targetName:"math"},{name:"toDegree",newName:"toDegree",target:math,targetName:"math"},{name:"random",newName:"random",target:math,targetName:"math"},{name:"randomRange",newName:"randomRange",target:math,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:math,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:math,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:math,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:math,targetName:"math"},{name:"repeat",newName:"repeat",target:math,targetName:"math"},{name:"pingPong",newName:"pingPong",target:math,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:math,targetName:"math"}]),cc.vmath=vmath,exports.replaceProperty(Scheduler.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:Scheduler,targetName:"Scheduler"}]),cc.math=math,cc.geometry=geometry;var RenderQueue$1,PassStage,_stageOffset=0,_name2stageID={},config={addStage:function(e){if(void 0===_name2stageID[e]){var t=1<<_stageOffset;_name2stageID[e]=t,_stageOffset+=1}},stageID:function(e){var t=_name2stageID[e];return void 0===t?-1:t},stageIDs:function(e){var t=0,i=e,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=_name2stageID[s];void 0!==a&&(t|=a)}return t}};!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(RenderQueue$1=RenderQueue$1||{}),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(PassStage=PassStage||{}),exports.replaceProperty(RenderScene.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastAllCanvas"},{name:"raycastUI2D",newName:"raycastAllCanvas"},{name:"raycast",newName:"raycastAllModels"},{name:"raycastModels",newName:"raycastAllModels"},{name:"raycastModel",newName:"raycastSingleModel"}]),exports.removeProperty(RenderScene.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]);var CameraVisFlags={};exports.removeProperty(CameraVisFlags,"CameraVisFlags",[{name:"GENERAL"}]),exports.replaceProperty(CameraVisFlags,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Layers.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Layers.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Layers.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Layers.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Layers.BitMask,targetName:"UI_2D"}]),cc.CameraVisFlags=CameraVisFlags;var VisibilityFlags={};exports.removeProperty(VisibilityFlags,"VisibilityFlags",[{name:"GENERAL"}]),exports.replaceProperty(VisibilityFlags,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Layers.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Layers.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Layers.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Layers.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Layers.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Layers.Enum,targetName:"UI_2D"}]),cc.VisibilityFlags=VisibilityFlags;var addStage=config.addStage;cc.samplerLib=samplerLib;var _dec$W,_dec2$y,_class$X,_class2$M,_descriptor$J,_descriptor2$y,_temp$R,PrimitiveType$1,renderer=Object.freeze({addStage:addStage,samplerLib:samplerLib,createIA:createIA,get RenderQueue(){return RenderQueue$1},get PassStage(){return PassStage},Pass:Pass,programLib:programLib,Light:Light,Camera:Camera,Model:Model,SkinningModel:SkinningModel,TextureBufferPool:TextureBufferPool,get JointsMediumType(){return JointsMediumType},selectJointsMediumType:selectJointsMediumType,JointsTexturePool:JointsTexturePool}),NodePool=function(){function t(e){_classCallCheck(this,t),this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}return _createClass(t,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){var e=this._pool.length-1;if(e<0)return null;var t=this._pool[e];this._pool.length=e;var i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;if(i&&i.reuse){for(var r,n=arguments.length,s=new Array(n),a=0;a<n;a++)s[a]=arguments[a];(r=i.reuse).apply.apply(r,[i].concat(s))}return t}}]),t}();cc.NodePool=NodePool,function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(PrimitiveType$1=PrimitiveType$1||{}),ccenum(PrimitiveType$1);var Primitive=(_dec$W=ccclass("cc.Primitive"),_dec2$y=property({type:PrimitiveType$1}),_dec$W((_descriptor$J=_applyDecoratedDescriptor((_class2$M=_temp$R=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"type",_descriptor$J,_assertThisInitialized(t)),_initializerDefineProperty(t,"info",_descriptor2$y,_assertThisInitialized(t)),t}return _inherits(s,Mesh),_createClass(s,[{key:"onLoaded",value:function(){createMesh(primitives[PrimitiveType$1[this.type]](this.info),this)}}]),s}()).prototype,"type",[_dec2$y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PrimitiveType$1.BOX}}),_descriptor2$y=_applyDecoratedDescriptor(_class2$M.prototype,"info",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),_class$X=_class2$M))||_class$X);cc.Primitive=Primitive,cc.renderer=renderer;var cclegacy=cc;cc.primitives=primitives;var WebGLEXT,GFXBindingLayout=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.BINDING_LAYOUT)))._device=void 0,t._bindingUnits=[],t._isDirty=!1,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"bindBuffer",value:function(e,t){var i=this._bindingUnits,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;if(a.binding===e)return void(a.type===exports.GFXBindingType.UNIFORM_BUFFER?a.buffer!==t&&(a.buffer=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.UNIFORM_BUFFER."))}}},{key:"bindSampler",value:function(e,t){var i=this._bindingUnits,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;if(a.binding===e)return void(a.type===exports.GFXBindingType.SAMPLER?a.sampler!==t&&(a.sampler=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"bindTextureView",value:function(e,t){var i=this._bindingUnits,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;if(a.binding===e)return void(a.type===exports.GFXBindingType.SAMPLER?a.texView!==t&&(a.texView=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"getBindingUnit",value:function(e){var t=this._bindingUnits,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n;if(s.binding===e)return s}return null}}]),i}(),WebGLGFXBindingLayout=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuBindingLayout=null,t}return _inherits(i,GFXBindingLayout),_createClass(i,[{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),_createClass(i,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.bindingType,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var r=0;r<e.bindings.length;++r){var n=e.bindings[r];this._gpuBindingLayout.gpuBindings[r]={binding:n.binding,type:n.bindingType,name:n.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=exports.GFXStatus.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case exports.GFXBindingType.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case exports.GFXBindingType.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}}]),i}();function GFXFormatToWebGLType(e,t){switch(e){case exports.GFXFormat.R8:return t.UNSIGNED_BYTE;case exports.GFXFormat.R8SN:return t.BYTE;case exports.GFXFormat.R8UI:return t.UNSIGNED_BYTE;case exports.GFXFormat.R8I:return t.BYTE;case exports.GFXFormat.R16F:return WebGLEXT.HALF_FLOAT_OES;case exports.GFXFormat.R16UI:return t.UNSIGNED_SHORT;case exports.GFXFormat.R16I:return t.SHORT;case exports.GFXFormat.R32F:return t.FLOAT;case exports.GFXFormat.R32UI:return t.UNSIGNED_INT;case exports.GFXFormat.R32I:return t.INT;case exports.GFXFormat.RG8:return t.UNSIGNED_BYTE;case exports.GFXFormat.RG8SN:return t.BYTE;case exports.GFXFormat.RG8UI:return t.UNSIGNED_BYTE;case exports.GFXFormat.RG8I:return t.BYTE;case exports.GFXFormat.RG16F:return WebGLEXT.HALF_FLOAT_OES;case exports.GFXFormat.RG16UI:return t.UNSIGNED_SHORT;case exports.GFXFormat.RG16I:return t.SHORT;case exports.GFXFormat.RG32F:return t.FLOAT;case exports.GFXFormat.RG32UI:return t.UNSIGNED_INT;case exports.GFXFormat.RG32I:return t.INT;case exports.GFXFormat.RGB8:case exports.GFXFormat.SRGB8:return t.UNSIGNED_BYTE;case exports.GFXFormat.RGB8SN:return t.BYTE;case exports.GFXFormat.RGB8UI:return t.UNSIGNED_BYTE;case exports.GFXFormat.RGB8I:return t.BYTE;case exports.GFXFormat.RGB16F:return WebGLEXT.HALF_FLOAT_OES;case exports.GFXFormat.RGB16UI:return t.UNSIGNED_SHORT;case exports.GFXFormat.RGB16I:return t.SHORT;case exports.GFXFormat.RGB32F:return t.FLOAT;case exports.GFXFormat.RGB32UI:return t.UNSIGNED_INT;case exports.GFXFormat.RGB32I:return t.INT;case exports.GFXFormat.RGBA8:case exports.GFXFormat.SRGB8_A8:return t.UNSIGNED_BYTE;case exports.GFXFormat.RGBA8SN:return t.BYTE;case exports.GFXFormat.RGBA8UI:return t.UNSIGNED_BYTE;case exports.GFXFormat.RGBA8I:return t.BYTE;case exports.GFXFormat.RGBA16F:return WebGLEXT.HALF_FLOAT_OES;case exports.GFXFormat.RGBA16UI:return t.UNSIGNED_SHORT;case exports.GFXFormat.RGBA16I:return t.SHORT;case exports.GFXFormat.RGBA32F:return t.FLOAT;case exports.GFXFormat.RGBA32UI:return t.UNSIGNED_INT;case exports.GFXFormat.RGBA32I:return t.INT;case exports.GFXFormat.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case exports.GFXFormat.R11G11B10F:return t.FLOAT;case exports.GFXFormat.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case exports.GFXFormat.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case exports.GFXFormat.RGB10A2:return t.UNSIGNED_BYTE;case exports.GFXFormat.RGB10A2UI:return t.UNSIGNED_INT;case exports.GFXFormat.RGB9E5:return t.UNSIGNED_BYTE;case exports.GFXFormat.D16:case exports.GFXFormat.D16S8:return t.UNSIGNED_SHORT;case exports.GFXFormat.D24:return t.UNSIGNED_INT;case exports.GFXFormat.D24S8:return WebGLEXT.UNSIGNED_INT_24_8_WEBGL;case exports.GFXFormat.D32F:case exports.GFXFormat.D32F_S8:return t.FLOAT;case exports.GFXFormat.BC1:case exports.GFXFormat.BC1_SRGB:case exports.GFXFormat.BC2:case exports.GFXFormat.BC2_SRGB:case exports.GFXFormat.BC3:case exports.GFXFormat.BC3_SRGB:case exports.GFXFormat.BC4:return t.UNSIGNED_BYTE;case exports.GFXFormat.BC4_SNORM:return t.BYTE;case exports.GFXFormat.BC5:return t.UNSIGNED_BYTE;case exports.GFXFormat.BC5_SNORM:return t.BYTE;case exports.GFXFormat.BC6H_SF16:case exports.GFXFormat.BC6H_UF16:return t.FLOAT;case exports.GFXFormat.BC7:case exports.GFXFormat.BC7_SRGB:case exports.GFXFormat.ETC_RGB8:case exports.GFXFormat.ETC2_RGB8:case exports.GFXFormat.ETC2_SRGB8:case exports.GFXFormat.ETC2_RGB8_A1:case exports.GFXFormat.ETC2_SRGB8_A1:case exports.GFXFormat.ETC2_RGB8:case exports.GFXFormat.ETC2_SRGB8:case exports.GFXFormat.EAC_R11:return t.UNSIGNED_BYTE;case exports.GFXFormat.EAC_R11SN:return t.BYTE;case exports.GFXFormat.EAC_RG11:return t.UNSIGNED_BYTE;case exports.GFXFormat.EAC_RG11SN:return t.BYTE;case exports.GFXFormat.PVRTC_RGB2:case exports.GFXFormat.PVRTC_RGBA2:case exports.GFXFormat.PVRTC_RGB4:case exports.GFXFormat.PVRTC_RGBA4:case exports.GFXFormat.PVRTC2_2BPP:case exports.GFXFormat.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function GFXFormatToWebGLInternalFormat(e,t){switch(e){case exports.GFXFormat.A8:return t.ALPHA;case exports.GFXFormat.L8:return t.LUMINANCE;case exports.GFXFormat.LA8:return t.LUMINANCE_ALPHA;case exports.GFXFormat.RGB8:case exports.GFXFormat.RGB16F:case exports.GFXFormat.RGB32F:return t.RGB;case exports.GFXFormat.RGBA8:case exports.GFXFormat.RGBA16F:case exports.GFXFormat.RGBA32F:return t.RGBA;case exports.GFXFormat.R5G6B5:return t.RGB565;case exports.GFXFormat.RGB5A1:return t.RGB5_A1;case exports.GFXFormat.RGBA4:return t.RGBA4;case exports.GFXFormat.D16:return t.DEPTH_COMPONENT;case exports.GFXFormat.D16S8:return t.DEPTH_STENCIL;case exports.GFXFormat.D24:return t.DEPTH_COMPONENT;case exports.GFXFormat.D24S8:return t.DEPTH_STENCIL;case exports.GFXFormat.D32F:return t.DEPTH_COMPONENT;case exports.GFXFormat.D32F_S8:return t.DEPTH_STENCIL;case exports.GFXFormat.BC1:return WebGLEXT.COMPRESSED_RGB_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_ALPHA:return WebGLEXT.COMPRESSED_RGBA_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_SRGB:return WebGLEXT.COMPRESSED_SRGB_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_SRGB_ALPHA:return WebGLEXT.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case exports.GFXFormat.BC2:return WebGLEXT.COMPRESSED_RGBA_S3TC_DXT3_EXT;case exports.GFXFormat.BC2_SRGB:return WebGLEXT.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case exports.GFXFormat.BC3:return WebGLEXT.COMPRESSED_RGBA_S3TC_DXT5_EXT;case exports.GFXFormat.BC3_SRGB:return WebGLEXT.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case exports.GFXFormat.ETC_RGB8:return WebGLEXT.COMPRESSED_RGB_ETC1_WEBGL;case exports.GFXFormat.PVRTC_RGB2:return WebGLEXT.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case exports.GFXFormat.PVRTC_RGBA2:return WebGLEXT.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case exports.GFXFormat.PVRTC_RGB4:return WebGLEXT.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case exports.GFXFormat.PVRTC_RGBA4:return WebGLEXT.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function GFXFormatToWebGLFormat(e,t){switch(e){case exports.GFXFormat.A8:return t.ALPHA;case exports.GFXFormat.L8:return t.LUMINANCE;case exports.GFXFormat.LA8:return t.LUMINANCE_ALPHA;case exports.GFXFormat.RGB8:case exports.GFXFormat.RGB16F:case exports.GFXFormat.RGB32F:return t.RGB;case exports.GFXFormat.RGBA8:case exports.GFXFormat.RGBA16F:case exports.GFXFormat.RGBA32F:return t.RGBA;case exports.GFXFormat.R5G6B5:return t.RGB;case exports.GFXFormat.RGB5A1:case exports.GFXFormat.RGBA4:return t.RGBA;case exports.GFXFormat.D16:return t.DEPTH_COMPONENT;case exports.GFXFormat.D16S8:return t.DEPTH_STENCIL;case exports.GFXFormat.D24:return t.DEPTH_COMPONENT;case exports.GFXFormat.D24S8:return t.DEPTH_STENCIL;case exports.GFXFormat.D32F:return t.DEPTH_COMPONENT;case exports.GFXFormat.D32F_S8:return t.DEPTH_STENCIL;case exports.GFXFormat.BC1:return WebGLEXT.COMPRESSED_RGB_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_ALPHA:return WebGLEXT.COMPRESSED_RGBA_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_SRGB:return WebGLEXT.COMPRESSED_SRGB_S3TC_DXT1_EXT;case exports.GFXFormat.BC1_SRGB_ALPHA:return WebGLEXT.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case exports.GFXFormat.BC2:return WebGLEXT.COMPRESSED_RGBA_S3TC_DXT3_EXT;case exports.GFXFormat.BC2_SRGB:return WebGLEXT.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case exports.GFXFormat.BC3:return WebGLEXT.COMPRESSED_RGBA_S3TC_DXT5_EXT;case exports.GFXFormat.BC3_SRGB:return WebGLEXT.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case exports.GFXFormat.ETC_RGB8:return WebGLEXT.COMPRESSED_RGB_ETC1_WEBGL;case exports.GFXFormat.ETC2_RGB8:return WebGLEXT.COMPRESSED_RGB8_ETC2;case exports.GFXFormat.ETC2_SRGB8:return WebGLEXT.COMPRESSED_SRGB8_ETC2;case exports.GFXFormat.ETC2_RGB8_A1:return WebGLEXT.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case exports.GFXFormat.ETC2_SRGB8_A1:return WebGLEXT.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case exports.GFXFormat.ETC2_RGBA8:return WebGLEXT.COMPRESSED_RGBA8_ETC2_EAC;case exports.GFXFormat.ETC2_SRGB8_A8:return WebGLEXT.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case exports.GFXFormat.EAC_R11:return WebGLEXT.COMPRESSED_R11_EAC;case exports.GFXFormat.EAC_R11SN:return WebGLEXT.COMPRESSED_SIGNED_R11_EAC;case exports.GFXFormat.EAC_RG11:return WebGLEXT.COMPRESSED_RG11_EAC;case exports.GFXFormat.EAC_RG11SN:return WebGLEXT.COMPRESSED_SIGNED_RG11_EAC;case exports.GFXFormat.PVRTC_RGB2:return WebGLEXT.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case exports.GFXFormat.PVRTC_RGBA2:return WebGLEXT.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case exports.GFXFormat.PVRTC_RGB4:return WebGLEXT.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case exports.GFXFormat.PVRTC_RGBA4:return WebGLEXT.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function GFXTypeToWebGLType(e,t){switch(e){case exports.GFXType.BOOL:return t.BOOL;case exports.GFXType.BOOL2:return t.BOOL_VEC2;case exports.GFXType.BOOL3:return t.BOOL_VEC3;case exports.GFXType.BOOL4:return t.BOOL_VEC4;case exports.GFXType.INT:return t.INT;case exports.GFXType.INT2:return t.INT_VEC2;case exports.GFXType.INT3:return t.INT_VEC3;case exports.GFXType.INT4:return t.INT_VEC4;case exports.GFXType.UINT:return t.UNSIGNED_INT;case exports.GFXType.FLOAT:return t.FLOAT;case exports.GFXType.FLOAT2:return t.FLOAT_VEC2;case exports.GFXType.FLOAT3:return t.FLOAT_VEC3;case exports.GFXType.FLOAT4:return t.FLOAT_VEC4;case exports.GFXType.MAT2:return t.FLOAT_MAT2;case exports.GFXType.MAT3:return t.FLOAT_MAT3;case exports.GFXType.MAT4:return t.FLOAT_MAT4;case exports.GFXType.SAMPLER2D:return t.SAMPLER_2D;case exports.GFXType.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),exports.GFXType.UNKNOWN}}function WebGLTypeToGFXType(e,t){switch(e){case t.BOOL:return exports.GFXType.BOOL;case t.BOOL_VEC2:return exports.GFXType.BOOL2;case t.BOOL_VEC3:return exports.GFXType.BOOL3;case t.BOOL_VEC4:return exports.GFXType.BOOL4;case t.INT:return exports.GFXType.INT;case t.INT_VEC2:return exports.GFXType.INT2;case t.INT_VEC3:return exports.GFXType.INT3;case t.INT_VEC4:return exports.GFXType.INT4;case t.UNSIGNED_INT:return exports.GFXType.UINT;case t.FLOAT:return exports.GFXType.FLOAT;case t.FLOAT_VEC2:return exports.GFXType.FLOAT2;case t.FLOAT_VEC3:return exports.GFXType.FLOAT3;case t.FLOAT_VEC4:return exports.GFXType.FLOAT4;case t.FLOAT_MAT2:return exports.GFXType.MAT2;case t.FLOAT_MAT3:return exports.GFXType.MAT3;case t.FLOAT_MAT4:return exports.GFXType.MAT4;case t.SAMPLER_2D:return exports.GFXType.SAMPLER2D;case t.SAMPLER_CUBE:return exports.GFXType.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),exports.GFXType.UNKNOWN}}function WebGLGetTypeSize(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function WebGLGetComponentCount(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC"}(WebGLEXT=WebGLEXT||{});var WebGLCmd,WebGLCmpFuncs=[512,513,514,515,516,517,518,519],WebGLStencilOps=[0,7680,7681,7682,7683,5386,34055,34056],WebGLBlendOps=[32774,32778,32779,32774,32774],WebGLBlendFactors=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(WebGLCmd=WebGLCmd||{});var WebGLCmdObject=function e(t){_classCallCheck(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},WebGLCmdBeginRenderPass=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,WebGLCmd.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=exports.GFXClearFlag.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return _inherits(t,WebGLCmdObject),_createClass(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors=[]}}]),t}(),WebGLCmdBindStates=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,WebGLCmd.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return _inherits(t,WebGLCmdObject),_createClass(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(),WebGLCmdDraw=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,WebGLCmd.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return _inherits(t,WebGLCmdObject),_createClass(t,[{key:"clear",value:function(){}}]),t}(),WebGLCmdUpdateBuffer=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,WebGLCmd.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return _inherits(t,WebGLCmdObject),_createClass(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(),WebGLCmdCopyBufferToTexture=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,WebGLCmd.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return _inherits(t,WebGLCmdObject),_createClass(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions=[]}}]),t}(),WebGLCmdPackage=function(){function e(){_classCallCheck(this,e),this.cmds=new CachedArray(1),this.beginRenderPassCmds=new CachedArray(1),this.bindStatesCmds=new CachedArray(1),this.drawCmds=new CachedArray(1),this.updateBufferCmds=new CachedArray(1),this.copyBufferToTextureCmds=new CachedArray(1)}return _createClass(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function WebGLCmdFuncCreateBuffer(e,t){var i=e.gl,r=e.stateCache,n=t.memUsage&exports.GFXMemoryUsageBit.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&exports.GFXBufferUsageBit.VERTEX){t.glTarget=i.ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,0<t.size&&(e.useVAO&&r.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),r.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,n),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&exports.GFXBufferUsageBit.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,0<t.size&&(e.useVAO&&r.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),r.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,n),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&exports.GFXBufferUsageBit.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer))):(t.usage&exports.GFXBufferUsageBit.INDIRECT||t.usage&exports.GFXBufferUsageBit.TRANSFER_DST||t.usage&exports.GFXBufferUsageBit.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}function WebGLCmdFuncDestroyBuffer(e,t){t.glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null)}function WebGLCmdFuncResizeBuffer(e,t){var i=e.gl,r=e.stateCache,n=t.memUsage&exports.GFXMemoryUsageBit.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&exports.GFXBufferUsageBit.VERTEX?(e.useVAO&&r.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),r.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,n):i.bufferData(i.ARRAY_BUFFER,t.size,n),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&exports.GFXBufferUsageBit.INDEX?(e.useVAO&&r.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),r.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,n):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,n),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&exports.GFXBufferUsageBit.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer)):(t.usage&exports.GFXBufferUsageBit.INDIRECT||t.usage&exports.GFXBufferUsageBit.TRANSFER_DST||t.usage&exports.GFXBufferUsageBit.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}function WebGLCmdFuncUpdateBuffer(e,t,i,r,n){if(t.usage&exports.GFXBufferUsageBit.UNIFORM)i instanceof Float32Array?t.vf32.set(i,r/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),r/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&exports.GFXBufferUsageBit.INDIRECT)t.indirects=i.drawInfos;else{var s=i,a=e.gl,o=e.stateCache;switch(t.glTarget){case a.ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case a.ELEMENT_ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}n===s.byteLength?a.bufferSubData(t.glTarget,r,s):a.bufferSubData(t.glTarget,r,s.slice(0,n))}}function WebGLCmdFuncCreateTexture(e,t){var i=e.gl;t.glInternelFmt=GFXFormatToWebGLInternalFormat(t.format,i),t.glFormat=GFXFormatToWebGLFormat(t.format,i),t.glType=GFXFormatToWebGLType(t.format,i);var r=t.width,n=t.height;switch(t.viewType){case exports.GFXTextureViewType.TV2D:t.viewType=exports.GFXTextureViewType.TV2D,t.glTarget=i.TEXTURE_2D;var s=Math.max(r,n);if(s>e.maxTextureSize&&errorID(9100,s,e.maxTextureSize),t.samples===exports.GFXSampleCount.X1){var a=i.createTexture();if(a&&0<t.size){t.glTexture=a;var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),GFXFormatInfos[t.format].isCompressed)if(t.glInternelFmt!==WebGLEXT.COMPRESSED_RGB_ETC1_WEBGL)for(var c=0;c<t.mipLevel;++c){var l=GFXFormatSize(t.format,r,n,1),u=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,c,t.glInternelFmt,r,n,0,u),r=Math.max(1,r>>1),n=Math.max(1,n>>1)}else{var h=GFXFormatSize(t.format,2,2,1),_=new Uint8Array(h);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternelFmt,2,2,0,_)}else for(var p=0;p<t.mipLevel;++p)i.texImage2D(i.TEXTURE_2D,p,t.glInternelFmt,r,n,0,t.glFormat,t.glType,null),r=Math.max(1,r>>1),n=Math.max(1,n>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}}break;case exports.GFXTextureViewType.CUBE:t.viewType=exports.GFXTextureViewType.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var d=Math.max(r,n);d>e.maxCubeMapTextureSize&&errorID(9100,d,e.maxTextureSize);var f=i.createTexture();if(f&&0<t.size){t.glTexture=f;var m=e.stateCache.glTexUnits[e.stateCache.texUnit];if(m.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),m.glTexture=t.glTexture),GFXFormatInfos[t.format].isCompressed)if(t.glInternelFmt!==WebGLEXT.COMPRESSED_RGB_ETC1_WEBGL)for(var y=0;y<6;++y){r=t.width,n=t.height;for(var v=0;v<t.mipLevel;++v){var g=GFXFormatSize(t.format,r,n,1),b=new Uint8Array(g);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+y,v,t.glInternelFmt,r,n,0,b),r=Math.max(1,r>>1),n=Math.max(1,n>>1)}}else for(var x=0;x<6;++x){var T=GFXFormatSize(t.format,2,2,1),C=new Uint8Array(T);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+x,0,t.glInternelFmt,2,2,0,C)}else for(var S=0;S<6;++S){r=t.width,n=t.height;for(var E=0;E<t.mipLevel;++E)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+S,E,t.glInternelFmt,r,n,0,t.glFormat,t.glType,null),r=Math.max(1,r>>1),n=Math.max(1,n>>1)}t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=exports.GFXTextureViewType.TV2D,t.glTarget=i.TEXTURE_2D}}function WebGLCmdFuncDestroyTexture(e,t){t.glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null)}function WebGLCmdFuncResizeTexture(e,t){var i=e.gl;t.glInternelFmt=GFXFormatToWebGLInternalFormat(t.format,i),t.glFormat=GFXFormatToWebGLFormat(t.format,i),t.glType=GFXFormatToWebGLType(t.format,i);var r=t.width,n=t.height;switch(t.viewType){case exports.GFXTextureViewType.TV2D:t.viewType=exports.GFXTextureViewType.TV2D,t.glTarget=i.TEXTURE_2D;var s=Math.max(r,n);if(s>e.maxTextureSize&&errorID(9100,s,e.maxTextureSize),t.samples===exports.GFXSampleCount.X1){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),GFXFormatInfos[t.format].isCompressed){if(t.glInternelFmt!==WebGLEXT.COMPRESSED_RGB_ETC1_WEBGL)for(var o=0;o<t.mipLevel;++o){var c=GFXFormatSize(t.format,r,n,1),l=new Uint8Array(c);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternelFmt,r,n,0,l),r=Math.max(1,r>>1),n=Math.max(1,n>>1)}}else for(var u=0;u<t.mipLevel;++u)i.texImage2D(i.TEXTURE_2D,u,t.glInternelFmt,r,n,0,t.glFormat,t.glType,null),r=Math.max(1,r>>1),n=Math.max(1,n>>1)}break;case exports.GFXTextureViewType.CUBE:t.viewType=exports.GFXTextureViewType.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var h=Math.max(r,n);h>e.maxCubeMapTextureSize&&errorID(9100,h,e.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),GFXFormatInfos[t.format].isCompressed){if(t.glInternelFmt!==WebGLEXT.COMPRESSED_RGB_ETC1_WEBGL)for(var p=0;p<6;++p){r=t.width,n=t.height;for(var d=0;d<t.mipLevel;++d){var f=GFXFormatSize(t.format,r,n,1),m=new Uint8Array(f);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+p,d,t.glInternelFmt,r,n,0,m),r=Math.max(1,r>>1),n=Math.max(1,n>>1)}}}else for(var y=0;y<6;++y){r=t.width,n=t.height;for(var v=0;v<t.mipLevel;++v)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+y,v,t.glInternelFmt,r,n,0,t.glFormat,t.glType,null),r=Math.max(1,r>>1),n=Math.max(1,n>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=exports.GFXTextureViewType.TV2D,t.glTarget=i.TEXTURE_2D}}function WebGLCmdFuncCreateFramebuffer(e,t){if(t.isOffscreen){var i=e.gl,r=[],n=i.createFramebuffer();if(n){t.glFramebuffer=n,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var s=0;s<t.gpuColorViews.length;++s){var a=t.gpuColorViews[s];a&&(a.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+s,a.gpuTexture.glTarget,a.gpuTexture.glTexture,a.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+s,i.RENDERBUFFER,a.gpuTexture.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+s))}var o=t.gpuDepthStencilView;if(o){var c=GFXFormatInfos[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,c,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,c,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(r);var l=i.checkFramebufferStatus(i.FRAMEBUFFER);if(l!==i.FRAMEBUFFER_COMPLETE)switch(l){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}function WebGLCmdFuncDestroyFramebuffer(e,t){t.glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)}function WebGLCmdFuncCreateShader(e,s){function t(){if(c){if(l>=o.length)return"break";u=o[l++]}else{if((l=o.next()).done)return"break";u=l.value}var e=u,t=0,i="",r=1;switch(e.type){case exports.GFXShaderType.VERTEX:i="VertexShader",t=a.VERTEX_SHADER;break;case exports.GFXShaderType.FRAGMENT:i="FragmentShader",t=a.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var n=a.createShader(t);if(n&&(e.glShader=n,a.shaderSource(e.glShader,e.source),a.compileShader(e.glShader),!a.getShaderParameter(e.glShader,a.COMPILE_STATUS)))return console.error(i+" in '"+s.name+"' compilation failed."),console.error("Shader source dump:",e.source.replace(/^|\n/g,function(){return"\n".concat(r++," ")})),console.error(a.getShaderInfoLog(e.glShader)),a.deleteShader(e.glShader),e.glShader=null,{v:void 0}}var a=e.gl;var o=s.gpuStages,c=Array.isArray(o),l=0;e:for(o=c?o:o[Symbol.iterator]();;){var u,i=t();switch(i){case"break":break e;default:if("object"===_typeof(i))return i.v}}var r=a.createProgram();if(r){s.glProgram=r;var n=s.gpuStages,h=Array.isArray(n),_=0;for(n=h?n:n[Symbol.iterator]();;){var p;if(h){if(_>=n.length)break;p=n[_++]}else{if((_=n.next()).done)break;p=_.value}var d=p;a.attachShader(s.glProgram,d.glShader)}if(a.linkProgram(s.glProgram),a.getProgramParameter(s.glProgram,a.LINK_STATUS)){console.info("Shader '"+s.name+"' compilation successed.");var f=a.getProgramParameter(s.glProgram,a.ACTIVE_ATTRIBUTES);s.glInputs=new Array(f);for(var m=0;m<f;++m){var y=a.getActiveAttrib(s.glProgram,m);if(y){var v=void 0,g=y.name.indexOf("[");v=-1!==g?y.name.substr(0,g):y.name;var b=a.getAttribLocation(s.glProgram,v),x=WebGLTypeToGFXType(y.type,a),T=WebGLGetTypeSize(y.type,a);s.glInputs[m]={binding:b,name:v,type:x,stride:T,count:y.size,size:T*y.size,glType:y.type,glLoc:b}}}if(0<s.blocks.length){s.glBlocks=new Array(s.blocks.length);for(var C=0;C<s.blocks.length;++C){var S=s.blocks[C],E={binding:S.binding,name:S.name,size:0,glUniforms:new Array(S.members.length),glActiveUniforms:[],isUniformPackage:!0};s.glBlocks[C]=E;for(var w=0;w<S.members.length;++w){var A=S.members[w],$=GFXTypeToWebGLType(A.type,a),O=WebGLGetTypeSize($,a),D=O*A.count,k=E.size/4,R=new Array(D/4);R.fill(0),E.glUniforms[w]={binding:-1,name:A.name,type:A.type,stride:O,count:A.count,size:D,offset:E.size,glType:$,glLoc:-1,array:R,begin:k},E.size+=D}}}if(0<s.samplers.length){s.glSamplers=new Array(s.samplers.length);for(var I=0;I<s.samplers.length;++I){var F=s.samplers[I];s.glSamplers[I]={binding:F.binding,name:F.name,type:F.type,units:[],glType:GFXTypeToWebGLType(F.type,a),glLoc:-1}}}for(var P=a.getProgramParameter(s.glProgram,a.ACTIVE_UNIFORMS),M=0,L=[],z=0;z<P;++z){var B=a.getActiveUniform(s.glProgram,z);if(B){var N=a.getUniformLocation(s.glProgram,B.name);if(N){var G=void 0,V=B.name.indexOf("[");if(G=-1!==V?B.name.substr(0,V):B.name,B.type===a.SAMPLER_2D||B.type===a.SAMPLER_CUBE){var U=s.glSamplers,X=Array.isArray(U),W=0;for(U=X?U:U[Symbol.iterator]();;){var H;if(X){if(W>=U.length)break;H=U[W++]}else{if((W=U.next()).done)break;H=W.value}var q=H;if(q.name===G){for(var j=0;j<B.size;++j)q.units.push(M+j);q.glLoc=N,M+=B.size,L.push(q);break}}}else{var Y=s.glBlocks,Q=Array.isArray(Y),K=0;for(Y=Q?Y:Y[Symbol.iterator]();;){var Z;if(Q){if(K>=Y.length)break;Z=Y[K++]}else{if((K=Y.next()).done)break;Z=K.value}var J=Z,ee=J.glUniforms,te=Array.isArray(ee),ie=0;for(ee=te?ee:ee[Symbol.iterator]();;){var re;if(te){if(ie>=ee.length)break;re=ee[ie++]}else{if((ie=ee.next()).done)break;re=ie.value}var ne=re;if(ne.name===G){ne.glLoc=N,J.glActiveUniforms.push(ne);break}}}}}}}if(L.length){e.stateCache.glProgram!==s.glProgram&&(a.useProgram(s.glProgram),e.stateCache.glProgram=s.glProgram);var se=L,ae=Array.isArray(se),oe=0;for(se=ae?se:se[Symbol.iterator]();;){var ce;if(ae){if(oe>=se.length)break;ce=se[oe++]}else{if((oe=se.next()).done)break;ce=oe.value}var le=ce;a.uniform1iv(le.glLoc,le.units)}}}else{console.error("Failed to link shader '"+s.name+"'."),console.error(a.getProgramInfoLog(s.glProgram));var ue=s.gpuStages,he=Array.isArray(ue),_e=0;for(ue=he?ue:ue[Symbol.iterator]();;){var pe;if(he){if(_e>=ue.length)break;pe=ue[_e++]}else{if((_e=ue.next()).done)break;pe=_e.value}var de=pe;de.glShader&&(a.deleteShader(de.glShader),de.glShader=null)}}}}function WebGLCmdFuncDestroyShader(e,t){var i=t.gpuStages,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;a.glShader&&(e.gl.deleteShader(a.glShader),a.glShader=null)}t.glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null)}function WebGLCmdFuncCreateInputAssember(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var r=[0,0,0,0,0,0,0,0],n=0;n<t.attributes.length;++n){var s=t.attributes[n],a=void 0!==s.stream?s.stream:0,o=t.gpuVertexBuffers[a],c=GFXFormatToWebGLType(s.format,i),l=GFXFormatInfos[s.format].size;t.glAttribs[n]={name:s.name,glBuffer:o.glBuffer,glType:c,size:l,count:GFXFormatInfos[s.format].count,stride:o.stride,componentCount:WebGLGetComponentCount(c,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:r[a]},r[a]+=l}}function WebGLCmdFuncDestroyInputAssembler(e,t){var i=t.glVAOs,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;e.OES_vertex_array_object.deleteVertexArrayOES(a[1])}t.glVAOs.clear()}var cmdIds=new Array(WebGLCmd.COUNT);function WebGLCmdFuncExecuteCmds(e,t){for(var i=e.gl,r=e.stateCache,n=0;n<WebGLCmd.COUNT;++n)cmdIds[n]=0;for(var s,a,o,c=null,l=null,u=!1,h=null,_=i.TRIANGLES,p=0;p<t.cmds.length;++p){var d=t.cmds.array[p],f=cmdIds[d]++;switch(d){case WebGLCmd.BEGIN_RENDER_PASS:var m=t.beginRenderPassCmds.array[f],y=0;if(m.gpuFramebuffer){r.glFramebuffer!==m.gpuFramebuffer.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,m.gpuFramebuffer.glFramebuffer),r.glFramebuffer=m.gpuFramebuffer.glFramebuffer),r.viewport.left===m.renderArea.x&&r.viewport.top===m.renderArea.y&&r.viewport.width===m.renderArea.width&&r.viewport.height===m.renderArea.height||(i.viewport(m.renderArea.x,m.renderArea.y,m.renderArea.width,m.renderArea.height),r.viewport.left=m.renderArea.x,r.viewport.top=m.renderArea.y,r.viewport.width=m.renderArea.width,r.viewport.height=m.renderArea.height),r.scissorRect.x===m.renderArea.x&&r.scissorRect.y===m.renderArea.y&&r.scissorRect.width===m.renderArea.width&&r.scissorRect.height===m.renderArea.height||(i.scissor(m.renderArea.x,m.renderArea.y,m.renderArea.width,m.renderArea.height),r.scissorRect.x=m.renderArea.x,r.scissorRect.y=m.renderArea.y,r.scissorRect.width=m.renderArea.width,r.scissorRect.height=m.renderArea.height);var v=m.gpuFramebuffer.gpuRenderPass,g=m.clearColors.length;e.WEBGL_draw_buffers||(g=1);for(var b=0;b<g;++b){var x=v.colorAttachments[b];if(x.format!==exports.GFXFormat.UNKNOWN)switch(x.loadOp){case exports.GFXLoadOp.LOAD:break;case exports.GFXLoadOp.CLEAR:if(m.clearFlag&exports.GFXClearFlag.COLOR){r.bs.targets[0].blendColorMask!==exports.GFXColorMask.ALL&&i.colorMask(!0,!0,!0,!0);var T=m.clearColors[0];i.clearColor(T.r,T.g,T.b,T.a),y|=i.COLOR_BUFFER_BIT}break;case exports.GFXLoadOp.DISCARD:}}if(v.depthStencilAttachment&&v.depthStencilAttachment.format!==exports.GFXFormat.UNKNOWN){switch(v.depthStencilAttachment.depthLoadOp){case exports.GFXLoadOp.LOAD:break;case exports.GFXLoadOp.CLEAR:m.clearFlag&exports.GFXClearFlag.DEPTH&&(r.dss.depthWrite||i.depthMask(!0),i.clearDepth(m.clearDepth),y|=i.DEPTH_BUFFER_BIT);break;case exports.GFXLoadOp.DISCARD:}if(GFXFormatInfos[v.depthStencilAttachment.format].hasStencil)switch(v.depthStencilAttachment.stencilLoadOp){case exports.GFXLoadOp.LOAD:break;case exports.GFXLoadOp.CLEAR:m.clearFlag&exports.GFXClearFlag.STENCIL&&(r.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,4294967295),r.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,4294967295),i.clearStencil(m.clearStencil),y|=i.STENCIL_BUFFER_BIT);break;case exports.GFXLoadOp.DISCARD:}}if(y&&i.clear(y),y&i.COLOR_BUFFER_BIT){var C=r.bs.targets[0].blendColorMask;if(C!==exports.GFXColorMask.ALL){var S=(C&exports.GFXColorMask.R)!==exports.GFXColorMask.NONE,E=(C&exports.GFXColorMask.G)!==exports.GFXColorMask.NONE,w=(C&exports.GFXColorMask.B)!==exports.GFXColorMask.NONE,A=(C&exports.GFXColorMask.A)!==exports.GFXColorMask.NONE;i.colorMask(S,E,w,A)}}y&i.DEPTH_BUFFER_BIT&&!r.dss.depthWrite&&i.depthMask(!1),y&i.STENCIL_BUFFER_BIT&&(r.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,0),r.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,0))}break;case WebGLCmd.BIND_STATES:var $=t.bindStatesCmds.array[f];if(u=!1,$.gpuPipelineState){if(c=$.gpuPipelineState,_=$.gpuPipelineState.glPrimitive,$.gpuPipelineState.gpuShader){var O=$.gpuPipelineState.gpuShader.glProgram;r.glProgram!==O&&(i.useProgram(O),r.glProgram=O,u=!0),l=$.gpuPipelineState.gpuShader}var D=$.gpuPipelineState.rs;if(D){if(r.rs.cullMode!==D.cullMode){switch(D.cullMode){case exports.GFXCullMode.NONE:i.disable(i.CULL_FACE);break;case exports.GFXCullMode.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case exports.GFXCullMode.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}r.rs.cullMode=D.cullMode}r.rs.isFrontFaceCCW!==D.isFrontFaceCCW&&(i.frontFace(D.isFrontFaceCCW?i.CCW:i.CW),r.rs.isFrontFaceCCW=D.isFrontFaceCCW),r.rs.depthBias===D.depthBias&&r.rs.depthBiasSlop===D.depthBiasSlop||(i.polygonOffset(D.depthBias,D.depthBiasSlop),r.rs.depthBias=D.depthBias,r.rs.depthBiasSlop=D.depthBiasSlop),r.rs.lineWidth!==D.lineWidth&&(i.lineWidth(D.lineWidth),r.rs.lineWidth=D.lineWidth)}var k=$.gpuPipelineState.dss;k&&(r.dss.depthTest!==k.depthTest&&(k.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),r.dss.depthTest=k.depthTest),r.dss.depthWrite!==k.depthWrite&&(i.depthMask(k.depthWrite),r.dss.depthWrite=k.depthWrite),r.dss.depthFunc!==k.depthFunc&&(i.depthFunc(WebGLCmpFuncs[k.depthFunc]),r.dss.depthFunc=k.depthFunc),r.dss.stencilTestFront===k.stencilTestFront&&r.dss.stencilTestBack===k.stencilTestBack||(k.stencilTestFront||k.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),r.dss.stencilTestFront=k.stencilTestFront,r.dss.stencilTestBack=k.stencilTestBack),r.dss.stencilFuncFront===k.stencilFuncFront&&r.dss.stencilRefFront===k.stencilRefFront&&r.dss.stencilReadMaskFront===k.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,WebGLCmpFuncs[k.stencilFuncFront],k.stencilRefFront,k.stencilReadMaskFront),r.dss.stencilFuncFront=k.stencilFuncFront,r.dss.stencilRefFront=k.stencilRefFront,r.dss.stencilReadMaskFront=k.stencilReadMaskFront),r.dss.stencilFailOpFront===k.stencilFailOpFront&&r.dss.stencilZFailOpFront===k.stencilZFailOpFront&&r.dss.stencilPassOpFront===k.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,WebGLStencilOps[k.stencilFailOpFront],WebGLStencilOps[k.stencilZFailOpFront],WebGLStencilOps[k.stencilPassOpFront]),r.dss.stencilFailOpFront=k.stencilFailOpFront,r.dss.stencilZFailOpFront=k.stencilZFailOpFront,r.dss.stencilPassOpFront=k.stencilPassOpFront),r.dss.stencilWriteMaskFront!==k.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,k.stencilWriteMaskFront),r.dss.stencilWriteMaskFront=k.stencilWriteMaskFront),r.dss.stencilFuncBack===k.stencilFuncBack&&r.dss.stencilRefBack===k.stencilRefBack&&r.dss.stencilReadMaskBack===k.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,WebGLCmpFuncs[k.stencilFuncBack],k.stencilRefBack,k.stencilReadMaskBack),r.dss.stencilFuncBack=k.stencilFuncBack,r.dss.stencilRefBack=k.stencilRefBack,r.dss.stencilReadMaskBack=k.stencilReadMaskBack),r.dss.stencilFailOpBack===k.stencilFailOpBack&&r.dss.stencilZFailOpBack===k.stencilZFailOpBack&&r.dss.stencilPassOpBack===k.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,WebGLStencilOps[k.stencilFailOpBack],WebGLStencilOps[k.stencilZFailOpBack],WebGLStencilOps[k.stencilPassOpBack]),r.dss.stencilFailOpBack=k.stencilFailOpBack,r.dss.stencilZFailOpBack=k.stencilZFailOpBack,r.dss.stencilPassOpBack=k.stencilPassOpBack),r.dss.stencilWriteMaskBack!==k.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,k.stencilWriteMaskBack),r.dss.stencilWriteMaskBack=k.stencilWriteMaskBack));var R=$.gpuPipelineState.bs;if(R){r.bs.isA2C!==R.isA2C&&(R.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),r.bs.isA2C=R.isA2C),r.bs.blendColor[0]===R.blendColor[0]&&r.bs.blendColor[1]===R.blendColor[1]&&r.bs.blendColor[2]===R.blendColor[2]&&r.bs.blendColor[3]===R.blendColor[3]||(i.blendColor(R.blendColor[0],R.blendColor[1],R.blendColor[2],R.blendColor[3]),r.bs.blendColor[0]=R.blendColor[0],r.bs.blendColor[1]=R.blendColor[1],r.bs.blendColor[2]=R.blendColor[2],r.bs.blendColor[3]=R.blendColor[3]);var I=R.targets[0],F=r.bs.targets[0];F.blend!==I.blend&&(I.blend?i.enable(i.BLEND):i.disable(i.BLEND),F.blend=I.blend),F.blendEq===I.blendEq&&F.blendAlphaEq===I.blendAlphaEq||(i.blendEquationSeparate(WebGLBlendOps[I.blendEq],WebGLBlendOps[I.blendAlphaEq]),F.blendEq=I.blendEq,F.blendAlphaEq=I.blendAlphaEq),F.blendSrc===I.blendSrc&&F.blendDst===I.blendDst&&F.blendSrcAlpha===I.blendSrcAlpha&&F.blendDstAlpha===I.blendDstAlpha||(i.blendFuncSeparate(WebGLBlendFactors[I.blendSrc],WebGLBlendFactors[I.blendDst],WebGLBlendFactors[I.blendSrcAlpha],WebGLBlendFactors[I.blendDstAlpha]),F.blendSrc=I.blendSrc,F.blendDst=I.blendDst,F.blendSrcAlpha=I.blendSrcAlpha,F.blendDstAlpha=I.blendDstAlpha),F.blendColorMask!==I.blendColorMask&&(i.colorMask((I.blendColorMask&exports.GFXColorMask.R)!==exports.GFXColorMask.NONE,(I.blendColorMask&exports.GFXColorMask.G)!==exports.GFXColorMask.NONE,(I.blendColorMask&exports.GFXColorMask.B)!==exports.GFXColorMask.NONE,(I.blendColorMask&exports.GFXColorMask.A)!==exports.GFXColorMask.NONE),F.blendColorMask=I.blendColorMask)}}if($.gpuBindingLayout&&l)for(var P=$.gpuBindingLayout.gpuBindings.length,M=0;M<P;M++){var L=$.gpuBindingLayout.gpuBindings[M];switch(L.type){case exports.GFXBindingType.UNIFORM_BUFFER:if(L.gpuBuffer&&L.gpuBuffer.buffer){for(var z=null,B=l.glBlocks.length,N=0;N<B;N++){var G=l.glBlocks[N];if(G.binding===L.binding){z=G;break}}if(z&&L.gpuBuffer.vf32)for(var V=z.glActiveUniforms.length,U=0;U<V;U++){var X=z.glActiveUniforms[U];switch(X.glType){case i.BOOL:case i.INT:for(var W=0;W<X.array.length;++W){var H=X.begin+W;if(L.gpuBuffer.vf32[H]!==X.array[W]){for(var q=W,j=X.begin+W;q<X.array.length;++q,++j)X.array[q]=L.gpuBuffer.vf32[j];i.uniform1iv(X.glLoc,X.array);break}}break;case i.BOOL_VEC2:case i.INT_VEC2:for(var Y=0;Y<X.array.length;++Y){var Q=X.begin+Y;if(L.gpuBuffer.vf32[Q]!==X.array[Y]){for(var K=Y,Z=X.begin+Y;K<X.array.length;++K,++Z)X.array[K]=L.gpuBuffer.vf32[Z];i.uniform2iv(X.glLoc,X.array);break}}break;case i.BOOL_VEC3:case i.INT_VEC3:for(var J=0;J<X.array.length;++J){var ee=X.begin+J;if(L.gpuBuffer.vf32[ee]!==X.array[J]){for(var te=J,ie=X.begin+J;te<X.array.length;++te,++ie)X.array[te]=L.gpuBuffer.vf32[ie];i.uniform3iv(X.glLoc,X.array);break}}break;case i.BOOL_VEC4:case i.INT_VEC4:for(var re=0;re<X.array.length;++re){var ne=X.begin+re;if(L.gpuBuffer.vf32[ne]!==X.array[re]){for(var se=re,ae=X.begin+re;se<X.array.length;++se,++ae)X.array[se]=L.gpuBuffer.vf32[ae];i.uniform4iv(X.glLoc,X.array);break}}break;case i.FLOAT:for(var oe=0;oe<X.array.length;++oe){var ce=X.begin+oe;if(L.gpuBuffer.vf32[ce]!==X.array[oe]){for(var le=oe,ue=X.begin+oe;le<X.array.length;++le,++ue)X.array[le]=L.gpuBuffer.vf32[ue];i.uniform1fv(X.glLoc,X.array);break}}break;case i.FLOAT_VEC2:for(var he=0;he<X.array.length;++he){var _e=X.begin+he;if(L.gpuBuffer.vf32[_e]!==X.array[he]){for(var pe=he,de=X.begin+he;pe<X.array.length;++pe,++de)X.array[pe]=L.gpuBuffer.vf32[de];i.uniform2fv(X.glLoc,X.array);break}}break;case i.FLOAT_VEC3:for(var fe=0;fe<X.array.length;++fe){var me=X.begin+fe;if(L.gpuBuffer.vf32[me]!==X.array[fe]){for(var ye=fe,ve=X.begin+fe;ye<X.array.length;++ye,++ve)X.array[ye]=L.gpuBuffer.vf32[ve];i.uniform3fv(X.glLoc,X.array);break}}break;case i.FLOAT_VEC4:for(var ge=0;ge<X.array.length;++ge){var be=X.begin+ge;if(L.gpuBuffer.vf32[be]!==X.array[ge]){for(var xe=ge,Te=X.begin+ge;xe<X.array.length;++xe,++Te)X.array[xe]=L.gpuBuffer.vf32[Te];i.uniform4fv(X.glLoc,X.array);break}}break;case i.FLOAT_MAT2:for(var Ce=0;Ce<X.array.length;++Ce){var Se=X.begin+Ce;if(L.gpuBuffer.vf32[Se]!==X.array[Ce]){for(var Ee=Ce,we=X.begin+Ce;Ee<X.array.length;++Ee,++we)X.array[Ee]=L.gpuBuffer.vf32[we];i.uniformMatrix2fv(X.glLoc,!1,X.array);break}}break;case i.FLOAT_MAT3:for(var Ae=0;Ae<X.array.length;++Ae){var $e=X.begin+Ae;if(L.gpuBuffer.vf32[$e]!==X.array[Ae]){for(var Oe=Ae,De=X.begin+Ae;Oe<X.array.length;++Oe,++De)X.array[Oe]=L.gpuBuffer.vf32[De];i.uniformMatrix3fv(X.glLoc,!1,X.array);break}}break;case i.FLOAT_MAT4:for(var ke=0;ke<X.array.length;++ke){var Re=X.begin+ke;if(L.gpuBuffer.vf32[Re]!==X.array[ke]){for(var Ie=ke,Fe=X.begin+ke;Ie<X.array.length;++Ie,++Fe)X.array[Ie]=L.gpuBuffer.vf32[Fe];i.uniformMatrix4fv(X.glLoc,!1,X.array);break}}}}}break;case exports.GFXBindingType.SAMPLER:if(L.gpuSampler){for(var Pe=null,Me=l.glSamplers.length,Le=0;Le<Me;Le++){var ze=l.glSamplers[Le];if(ze.binding===L.binding){Pe=ze;break}}if(Pe)for(var Be=Pe.units.length,Ne=0;Ne<Be;Ne++){var Ge=Pe.units[Ne];if(L.gpuTexView&&0<L.gpuTexView.gpuTexture.size){var Ve=L.gpuTexView.gpuTexture,Ue=r.glTexUnits[Ge];Ue.glTexture!==Ve.glTexture&&(r.texUnit!==Ge&&(i.activeTexture(i.TEXTURE0+Ge),r.texUnit=Ge),Ve.glTexture?i.bindTexture(Ve.glTarget,Ve.glTexture):i.bindTexture(Ve.glTarget,e.nullTex2D.gpuTexture.glTexture),Ue.glTexture=Ve.glTexture);var Xe=L.gpuSampler;a=Ve.isPowerOf2?(s=Xe.glWrapS,Xe.glWrapT):(s=i.CLAMP_TO_EDGE,i.CLAMP_TO_EDGE),o=Ve.isPowerOf2?Ve.mipLevel<=1&&(Xe.glMinFilter===i.LINEAR_MIPMAP_NEAREST||Xe.glMinFilter===i.LINEAR_MIPMAP_LINEAR)?i.LINEAR:Xe.glMinFilter:Xe.glMinFilter===i.LINEAR||Xe.glMinFilter===i.LINEAR_MIPMAP_NEAREST||Xe.glMinFilter===i.LINEAR_MIPMAP_LINEAR?i.LINEAR:i.NEAREST,Ve.glWrapS!==s&&(r.texUnit!==Ge&&(i.activeTexture(i.TEXTURE0+Ge),r.texUnit=Ge),i.texParameteri(Ve.glTarget,i.TEXTURE_WRAP_S,s),Ve.glWrapS=s),Ve.glWrapT!==a&&(r.texUnit!==Ge&&(i.activeTexture(i.TEXTURE0+Ge),r.texUnit=Ge),i.texParameteri(Ve.glTarget,i.TEXTURE_WRAP_T,a),Ve.glWrapT=a),Ve.glMinFilter!==o&&(r.texUnit!==Ge&&(i.activeTexture(i.TEXTURE0+Ge),r.texUnit=Ge),i.texParameteri(Ve.glTarget,i.TEXTURE_MIN_FILTER,o),Ve.glMinFilter=o),Ve.glMagFilter!==Xe.glMagFilter&&(r.texUnit!==Ge&&(i.activeTexture(i.TEXTURE0+Ge),r.texUnit=Ge),i.texParameteri(Ve.glTarget,i.TEXTURE_MAG_FILTER,Xe.glMagFilter),Ve.glMagFilter=Xe.glMagFilter)}}}else console.error("Not found sampler on binding unit "+L.binding)}}if($.gpuInputAssembler&&l&&(u||h!==$.gpuInputAssembler))if(h=$.gpuInputAssembler,e.useVAO){var We=e.OES_vertex_array_object,He=e.ANGLE_instanced_arrays,qe=h.glVAOs.get(l.glProgram);if(!qe){qe=We.createVertexArrayOES(),h.glVAOs.set(l.glProgram,qe),We.bindVertexArrayOES(qe),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);for(var je=void 0,Ye=l.glInputs.length,Qe=0;Qe<Ye;Qe++){var Ke=l.glInputs[Qe];je=null;for(var Ze=h.glAttribs.length,Je=0;Je<Ze;Je++){var et=h.glAttribs[Je];if(et.name===Ke.name){je=et;break}}if(je){i.bindBuffer(i.ARRAY_BUFFER,je.glBuffer);for(var tt=0;tt<je.componentCount;++tt){var it=Ke.glLoc+tt,rt=je.offset+je.size*tt;i.enableVertexAttribArray(it),r.glCurrentAttribLocs[it]=!0,i.vertexAttribPointer(it,je.count,je.glType,je.isNormalized,je.stride,rt),He&&He.vertexAttribDivisorANGLE(it,je.isInstanced?1:0)}}}var nt=h.gpuIndexBuffer;nt&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,nt.glBuffer),We.bindVertexArrayOES(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),r.glArrayBuffer=null,r.glElementArrayBuffer=null}r.glVAO!==qe&&(We.bindVertexArrayOES(qe),r.glVAO=qe)}else{for(var st=0;st<e.maxVertexAttributes;++st)r.glCurrentAttribLocs[st]=!1;for(var at=l.glInputs.length,ot=0;ot<at;ot++){for(var ct=l.glInputs[ot],lt=null,ut=h.glAttribs.length,ht=0;ht<ut;ht++){var _t=h.glAttribs[ht];if(_t.name===ct.name){lt=_t;break}}if(lt){r.glArrayBuffer!==lt.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,lt.glBuffer),r.glArrayBuffer=lt.glBuffer);for(var pt=0;pt<lt.componentCount;++pt){var dt=ct.glLoc+pt,ft=lt.offset+lt.size*pt;!r.glEnabledAttribLocs[dt]&&0<=dt&&(i.enableVertexAttribArray(dt),r.glEnabledAttribLocs[dt]=!0),r.glCurrentAttribLocs[dt]=!0,i.vertexAttribPointer(dt,lt.count,lt.glType,lt.isNormalized,lt.stride,ft)}}}var mt=h.gpuIndexBuffer;mt&&r.glElementArrayBuffer!==mt.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,mt.glBuffer),r.glElementArrayBuffer=mt.glBuffer);for(var yt=0;yt<e.maxVertexAttributes;++yt)r.glEnabledAttribLocs[yt]!==r.glCurrentAttribLocs[yt]&&(i.disableVertexAttribArray(yt),r.glEnabledAttribLocs[yt]=!1)}if(c)for(var vt=c.dynamicStates.length,gt=0;gt<vt;gt++){switch(c.dynamicStates[gt]){case exports.GFXDynamicState.VIEWPORT:$.viewport&&(r.viewport.left===$.viewport.left&&r.viewport.top===$.viewport.top&&r.viewport.width===$.viewport.width&&r.viewport.height===$.viewport.height||(i.viewport($.viewport.left,$.viewport.top,$.viewport.width,$.viewport.height),r.viewport.left=$.viewport.left,r.viewport.top=$.viewport.top,r.viewport.width=$.viewport.width,r.viewport.height=$.viewport.height));break;case exports.GFXDynamicState.SCISSOR:$.scissor&&(r.scissorRect.x===$.scissor.x&&r.scissorRect.y===$.scissor.y&&r.scissorRect.width===$.scissor.width&&r.scissorRect.height===$.scissor.height||(i.scissor($.scissor.x,$.scissor.y,$.scissor.width,$.scissor.height),r.scissorRect.x=$.scissor.x,r.scissorRect.y=$.scissor.y,r.scissorRect.width=$.scissor.width,r.scissorRect.height=$.scissor.height));break;case exports.GFXDynamicState.LINE_WIDTH:$.lineWidth&&r.rs.lineWidth!==$.lineWidth&&(i.lineWidth($.lineWidth),r.rs.lineWidth=$.lineWidth);break;case exports.GFXDynamicState.DEPTH_BIAS:$.depthBias&&(r.rs.depthBias===$.depthBias.constantFactor&&r.rs.depthBiasSlop===$.depthBias.slopeFactor||(i.polygonOffset($.depthBias.constantFactor,$.depthBias.slopeFactor),r.rs.depthBias=$.depthBias.constantFactor,r.rs.depthBiasSlop=$.depthBias.slopeFactor));break;case exports.GFXDynamicState.BLEND_CONSTANTS:$.blendConstants&&(r.bs.blendColor[0]===$.blendConstants[0]&&r.bs.blendColor[1]===$.blendConstants[1]&&r.bs.blendColor[2]===$.blendConstants[2]&&r.bs.blendColor[3]===$.blendConstants[3]||(i.blendColor($.blendConstants[0],$.blendConstants[1],$.blendConstants[2],$.blendConstants[3]),r.bs.blendColor[0]=$.blendConstants[0],r.bs.blendColor[1]=$.blendConstants[1],r.bs.blendColor[2]=$.blendConstants[2],r.bs.blendColor[3]=$.blendConstants[3]));break;case exports.GFXDynamicState.STENCIL_WRITE_MASK:if($.stencilWriteMask)switch($.stencilWriteMask.face){case exports.GFXStencilFace.FRONT:r.dss.stencilWriteMaskFront!==$.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.FRONT,$.stencilWriteMask.writeMask),r.dss.stencilWriteMaskFront=$.stencilWriteMask.writeMask);break;case exports.GFXStencilFace.BACK:r.dss.stencilWriteMaskBack!==$.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.BACK,$.stencilWriteMask.writeMask),r.dss.stencilWriteMaskBack=$.stencilWriteMask.writeMask);break;case exports.GFXStencilFace.ALL:r.dss.stencilWriteMaskFront===$.stencilWriteMask.writeMask&&r.dss.stencilWriteMaskBack===$.stencilWriteMask.writeMask||(i.stencilMask($.stencilWriteMask.writeMask),r.dss.stencilWriteMaskFront=$.stencilWriteMask.writeMask,r.dss.stencilWriteMaskBack=$.stencilWriteMask.writeMask)}break;case exports.GFXDynamicState.STENCIL_COMPARE_MASK:if($.stencilCompareMask)switch($.stencilCompareMask.face){case exports.GFXStencilFace.FRONT:r.dss.stencilRefFront===$.stencilCompareMask.reference&&r.dss.stencilReadMaskFront===$.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.FRONT,WebGLCmpFuncs[r.dss.stencilFuncFront],$.stencilCompareMask.reference,$.stencilCompareMask.compareMask),r.dss.stencilRefFront=$.stencilCompareMask.reference,r.dss.stencilReadMaskFront=$.stencilCompareMask.compareMask);break;case exports.GFXStencilFace.BACK:r.dss.stencilRefBack===$.stencilCompareMask.reference&&r.dss.stencilReadMaskBack===$.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.BACK,WebGLCmpFuncs[r.dss.stencilFuncBack],$.stencilCompareMask.reference,$.stencilCompareMask.compareMask),r.dss.stencilRefBack=$.stencilCompareMask.reference,r.dss.stencilReadMaskBack=$.stencilCompareMask.compareMask);break;case exports.GFXStencilFace.ALL:r.dss.stencilRefFront===$.stencilCompareMask.reference&&r.dss.stencilReadMaskFront===$.stencilCompareMask.compareMask&&r.dss.stencilRefBack===$.stencilCompareMask.reference&&r.dss.stencilReadMaskBack===$.stencilCompareMask.compareMask||(i.stencilFunc(WebGLCmpFuncs[r.dss.stencilFuncBack],$.stencilCompareMask.reference,$.stencilCompareMask.compareMask),r.dss.stencilRefFront=$.stencilCompareMask.reference,r.dss.stencilReadMaskFront=$.stencilCompareMask.compareMask,r.dss.stencilRefBack=$.stencilCompareMask.reference,r.dss.stencilReadMaskBack=$.stencilCompareMask.compareMask)}}}break;case WebGLCmd.DRAW:var bt=t.drawCmds.array[f];if(h&&l)if(h.gpuIndirectBuffer){if(h.gpuIndirectBuffer)for(var xt=h.gpuIndirectBuffer.indirects.length,Tt=0;Tt<xt;Tt++){var Ct=h.gpuIndirectBuffer.indirects[Tt],St=h.gpuIndexBuffer;if(St&&-1<Ct.indexCount){var Et=Ct.firstIndex*St.stride;i.drawElements(_,Ct.indexCount,h.glIndexType,Et)}else i.drawArrays(_,Ct.firstVertex,Ct.vertexCount)}}else{var wt=h.gpuIndexBuffer;if(wt&&-1<bt.drawInfo.indexCount){var At=bt.drawInfo.firstIndex*wt.stride;i.drawElements(_,bt.drawInfo.indexCount,h.glIndexType,At)}else i.drawArrays(_,bt.drawInfo.firstVertex,bt.drawInfo.vertexCount)}break;case WebGLCmd.UPDATE_BUFFER:var $t=t.updateBufferCmds.array[f];WebGLCmdFuncUpdateBuffer(e,$t.gpuBuffer,$t.buffer,$t.offset,$t.size);break;case WebGLCmd.COPY_BUFFER_TO_TEXTURE:var Ot=t.copyBufferToTextureCmds.array[f];WebGLCmdFuncCopyBuffersToTexture(e,[Ot.gpuBuffer.buffer],Ot.gpuTexture,Ot.regions)}}}function WebGLCmdFuncCopyTexImagesToTexture(e,t,i,r){var n=e.gl,s=e.stateCache.glTexUnits[e.stateCache.texUnit];s.glTexture!==i.glTexture&&(n.bindTexture(i.glTarget,i.glTexture),s.glTexture=i.glTexture);var a=0,o=0,c=0;switch(i.glTarget){case n.TEXTURE_2D:var l=r,u=Array.isArray(l),h=0;for(l=u?l:l[Symbol.iterator]();;){var _;if(u){if(h>=l.length)break;_=l[h++]}else{if((h=l.next()).done)break;_=h.value}var p=_;for(a=p.texSubres.baseMipLevel;a<p.texSubres.levelCount;++a)n.texSubImage2D(n.TEXTURE_2D,a,p.texOffset.x,p.texOffset.y,i.glFormat,i.glType,t[o++])}break;case n.TEXTURE_CUBE_MAP:var d=r,f=Array.isArray(d),m=0;for(d=f?d:d[Symbol.iterator]();;){var y;if(f){if(m>=d.length)break;y=d[m++]}else{if((m=d.next()).done)break;y=m.value}var v=y,g=v.texSubres.baseArrayLayer+v.texSubres.layerCount;for(c=v.texSubres.baseArrayLayer;c<g;++c){var b=v.texSubres.baseMipLevel+v.texSubres.levelCount;for(a=v.texSubres.baseMipLevel;a<b;++a)n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,v.texOffset.x,v.texOffset.y,i.glFormat,i.glType,t[o++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&exports.GFXTextureFlagBit.GEN_MIPMAP&&i.isPowerOf2&&n.generateMipmap(i.glTarget)}function WebGLCmdFuncCopyBuffersToTexture(e,t,i,r){var n=e.gl,s=e.stateCache.glTexUnits[e.stateCache.texUnit];s.glTexture!==i.glTexture&&(n.bindTexture(i.glTarget,i.glTexture),s.glTexture=i.glTexture);var a=0,o=0,c=1,l=1,u=0,h=GFXFormatInfos[i.format],_=h.isCompressed;switch(i.glTarget){case n.TEXTURE_2D:var p=r,d=Array.isArray(p),f=0;for(p=d?p:p[Symbol.iterator]();;){var m;if(d){if(f>=p.length)break;m=p[f++]}else{if((f=p.next()).done)break;m=f.value}var y=m;for(c=y.texExtent.width,l=y.texExtent.height,a=y.texSubres.baseMipLevel;a<y.texSubres.levelCount;++a){var v=h.type!==exports.GFXFormatType.FLOAT||_?new Uint8Array(t[o++]):new Float32Array(t[o++]);_?i.glInternelFmt!==WebGLEXT.COMPRESSED_RGB_ETC1_WEBGL?n.compressedTexSubImage2D(n.TEXTURE_2D,a,y.texOffset.x,y.texOffset.y,c,l,i.glFormat,v):n.compressedTexImage2D(n.TEXTURE_2D,a,i.glInternelFmt,c,l,0,v):n.texSubImage2D(n.TEXTURE_2D,a,y.texOffset.x,y.texOffset.y,c,l,i.glFormat,i.glType,v),c=Math.max(1,c>>1),l=Math.max(1,c>>1)}}break;case n.TEXTURE_CUBE_MAP:var g=r,b=Array.isArray(g),x=0;for(g=b?g:g[Symbol.iterator]();;){var T;if(b){if(x>=g.length)break;T=g[x++]}else{if((x=g.next()).done)break;T=x.value}var C=T;o=0;var S=C.texSubres.baseArrayLayer+C.texSubres.layerCount;for(u=C.texSubres.baseArrayLayer;u<S;++u){c=C.texExtent.width,l=C.texExtent.height;var E=C.texSubres.baseMipLevel+C.texSubres.levelCount;for(a=C.texSubres.baseMipLevel;a<E;++a){var w=h.type!==exports.GFXFormatType.FLOAT||_?new Uint8Array(t[o++]):new Float32Array(t[o++]);_?i.glInternelFmt!==WebGLEXT.COMPRESSED_RGB_ETC1_WEBGL?n.compressedTexSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+u,a,C.texOffset.x,C.texOffset.y,c,l,i.glFormat,w):n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+u,a,i.glInternelFmt,c,l,0,w):n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+u,a,C.texOffset.x,C.texOffset.y,c,l,i.glFormat,i.glType,w),c=Math.max(1,c>>1),l=Math.max(1,c>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&exports.GFXTextureFlagBit.GEN_MIPMAP&&n.generateMipmap(i.glTarget)}var WebGLGFXBuffer=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuBuffer=null,t._uniformBuffer=null,t._indirectBuffer=null,t}return _inherits(i,GFXBuffer),_createClass(i,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),_createClass(i,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:exports.GFXBufferFlagBit.NONE,this._usage&exports.GFXBufferUsageBit.INDIRECT?this._indirectBuffer={drawInfos:[]}:this._usage&exports.GFXBufferUsageBit.UNIFORM&&0<this._size&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._flags&exports.GFXBufferFlagBit.BAKUP_BUFFER&&(this._bufferView=new Uint8Array(this._size)),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&exports.GFXBufferUsageBit.INDIRECT?this._gpuBuffer.indirects=this._indirectBuffer.drawInfos:this._usage&exports.GFXBufferUsageBit.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),WebGLCmdFuncCreateBuffer(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size,this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBuffer&&(WebGLCmdFuncDestroyBuffer(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._bufferView=null,this._status=exports.GFXStatus.UNREADY}},{key:"resize",value:function(e){var t=this._size;if(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._bufferView&&t!==e){var i=this._bufferView;this._bufferView=new Uint8Array(this._size),this._bufferView.set(i),this._gpuBuffer&&(this._gpuBuffer.buffer=this._bufferView.buffer)}this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=this._size,0<this._size&&(WebGLCmdFuncResizeBuffer(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size,this._bufferView&&(this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size)))}},{key:"update",value:function(e,t,i){var r;if(r=void 0!==i?i:this._usage&exports.GFXBufferUsageBit.INDIRECT?0:e.byteLength,this._bufferView&&e!==this._bufferView.buffer){var n=new Uint8Array(e,0,i);this._bufferView.set(n,t)}WebGLCmdFuncUpdateBuffer(this._device,this._gpuBuffer,e,t||0,r)}}]),i}(),GFXCommandAllocator=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.COMMAND_ALLOCATOR)))._device=void 0,t._device=e,t}return _inherits(i,GFXObject),i}(),WebGLGFXCommandPool=function(){function r(e,t){_classCallCheck(this,r),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new CachedArray(t);for(var i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}return _createClass(r,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var r=t-i.length,n=0;n<r;++n)this._frees[n]=new e;for(var s=r,a=0;s<t;++s,++a)this._frees[s]=i[a];this._freeIdx+=r}var o=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++o.refCount,o}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),r}(),WebGLGFXCommandAllocator=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e))).beginRenderPassCmdPool=void 0,t.bindStatesCmdPool=void 0,t.drawCmdPool=void 0,t.updateBufferCmdPool=void 0,t.copyBufferToTextureCmdPool=void 0,t.beginRenderPassCmdPool=new WebGLGFXCommandPool(WebGLCmdBeginRenderPass,1),t.bindStatesCmdPool=new WebGLGFXCommandPool(WebGLCmdBindStates,1),t.drawCmdPool=new WebGLGFXCommandPool(WebGLCmdDraw,1),t.updateBufferCmdPool=new WebGLGFXCommandPool(WebGLCmdUpdateBuffer,1),t.copyBufferToTextureCmdPool=new WebGLGFXCommandPool(WebGLCmdCopyBufferToTexture,1),t}return _inherits(i,GFXCommandAllocator),_createClass(i,[{key:"initialize",value:function(e){return this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._status=exports.GFXStatus.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),i}(),WebGLGFXCommandBuffer=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e))).cmdPackage=new WebGLCmdPackage,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUBindingLayout=null,t._curGPUInputAssembler=null,t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}return _inherits(i,GFXCommandBuffer),_createClass(i,[{key:"initialize",value:function(e){return!!e.allocator&&(this._allocator=e.allocator,this._webGLAllocator=this._allocator,this._type=e.type,this._status=exports.GFXStatus.SUCCESS,!0)}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._allocator=null,this._webGLAllocator=null),this._status=exports.GFXStatus.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,r,n,s){var a=this._webGLAllocator.beginRenderPassCmdPool.alloc(WebGLCmdBeginRenderPass);a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=t,a.clearFlag=i,a.clearColors.length=r.length;for(var o=0;o<r.length;++o)a.clearColors[o]=r[o];a.clearDepth=n,a.clearStencil=s,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(WebGLCmd.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth},this._curViewport!==e&&(this._curViewport=e,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===exports.GFXCommandBufferType.PRIMARY&&this._isInRenderPass||this._type===exports.GFXCommandBufferType.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(WebGLCmdDraw);e.extractCmdDraw(t),this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(WebGLCmd.DRAW),++this._numDrawCalls;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,r){if(this._type===exports.GFXCommandBufferType.PRIMARY&&!this._isInRenderPass||this._type===exports.GFXCommandBufferType.SECONDARY){var n=e.gpuBuffer;if(n){var s=this._webGLAllocator.updateBufferCmdPool.alloc(WebGLCmdUpdateBuffer);if(s){var a;a=void 0!==r?r:e.usage&exports.GFXBufferUsageBit.INDIRECT?0:t.byteLength;var o=t;s.gpuBuffer=n,s.buffer=o,s.offset=void 0!==i?i:0,s.size=a,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(WebGLCmd.UPDATE_BUFFER)}}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,r){if(this._type===exports.GFXCommandBufferType.PRIMARY&&!this._isInRenderPass||this._type===exports.GFXCommandBufferType.SECONDARY){var n=e.gpuBuffer,s=t.gpuTexture;if(n&&s){var a=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(WebGLCmdCopyBufferToTexture);a&&(a.gpuBuffer=n,a.gpuTexture=s,a.dstLayout=i,a.regions=r,this.cmdPackage.copyBufferToTextureCmds.push(a),this.cmdPackage.cmds.push(WebGLCmd.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var r=e[i],n=0;n<r.cmdPackage.beginRenderPassCmds.length;++n){var s=r.cmdPackage.beginRenderPassCmds.array[n];++s.refCount,this.cmdPackage.beginRenderPassCmds.push(s)}for(var a=0;a<r.cmdPackage.bindStatesCmds.length;++a){var o=r.cmdPackage.bindStatesCmds.array[a];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var c=0;c<r.cmdPackage.drawCmds.length;++c){var l=r.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<r.cmdPackage.updateBufferCmds.length;++u){var h=r.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<r.cmdPackage.copyBufferToTextureCmds.length;++_){var p=r.cmdPackage.copyBufferToTextureCmds.array[_];++p.refCount,this.cmdPackage.copyBufferToTextureCmds.push(p)}this.cmdPackage.cmds.concat(r.cmdPackage.cmds),this._numDrawCalls+=r._numDrawCalls,this._numTris+=r._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(WebGLCmdBindStates);e&&(e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(WebGLCmd.BIND_STATES),this._isStateInvalied=!1)}},{key:"webGLDevice",get:function(){return this._device}}]),i}(),WebGLGFXFramebuffer=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuFramebuffer=null,t}return _inherits(i,GFXFramebuffer),_createClass(i,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),_createClass(i,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews){var i=e.colorViews,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;t.push(a.gpuTextureView)}}var o=null;e.depthStencilView&&(o=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:o,isOffscreen:this._isOffscreen,glFramebuffer:null},WebGLCmdFuncCreateFramebuffer(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:!1,glFramebuffer:null};return this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._isOffscreen&&this._gpuFramebuffer&&WebGLCmdFuncDestroyFramebuffer(this._device,this._gpuFramebuffer),this._gpuFramebuffer=null,this._status=exports.GFXStatus.UNREADY}}]),i}(),WebGLGFXInputAssembler=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuInputAssembler=null,t}return _inherits(i,GFXInputAssembler),_createClass(i,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),_createClass(i,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),r=0;r<e.vertexBuffers.length;++r){var n=e.vertexBuffers[r];n.gpuBuffer&&(i[r]=n.gpuBuffer)}var s=null,a=0;if(e.indexBuffer&&(s=e.indexBuffer.gpuBuffer))switch(s.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var o=null;return void 0!==e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:s,gpuIndirectBuffer:o,glAttribs:[],glIndexType:a,glVAOs:new Map},WebGLCmdFuncCreateInputAssember(this._device,this._gpuInputAssembler),this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&WebGLCmdFuncDestroyInputAssembler(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=exports.GFXStatus.UNREADY}},{key:"extractCmdDraw",value:function(e){e.drawInfo.vertexCount=this._vertexCount,e.drawInfo.firstVertex=this._firstVertex,e.drawInfo.indexCount=this._indexCount,e.drawInfo.firstIndex=this._firstIndex,e.drawInfo.vertexOffset=this._vertexOffset,e.drawInfo.instanceCount=this._instanceCount,e.drawInfo.firstInstance=this._firstInstance}}]),i}(),WebGLGFXPipelineLayout=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuPipelineLayout=null,t}return _inherits(i,GFXPipelineLayout),_createClass(i,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),_createClass(i,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._status=exports.GFXStatus.UNREADY}}]),i}(),WebGLPrimitives=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],WebGLGFXPipelineState=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuPipelineState=null,t}return _inherits(i,GFXPipelineState),_createClass(i,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),_createClass(i,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.inputState,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._dynamicStates=e.dynamicStates||[],this._hash=e.hash,this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:WebGLPrimitives[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=exports.GFXStatus.UNREADY}}]),i}(),WebGLGFXQueue=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e))).numDrawCalls=0,t.numTris=0,t._isAsync=!1,t}return _inherits(i,GFXQueue),_createClass(i,[{key:"initialize",value:function(e){return this._type=e.type,this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._status=exports.GFXStatus.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync)for(var i=e.length,r=0;r<i;r++){var n=e[r];WebGLCmdFuncExecuteCmds(this._device,n.cmdPackage),this.numDrawCalls+=n.numDrawCalls,this.numTris+=n.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numTris=0}}]),i}(),WebGLGFXRenderPass=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuRenderPass=null,t}return _inherits(i,GFXRenderPass),_createClass(i,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),_createClass(i,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=exports.GFXStatus.UNREADY}}]),i}(),WebGLWraps=[10497,33648,33071,33071],WebGLGFXSampler=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuSampler=null,t._state=new GFXSamplerState,t}return _inherits(i,GFXSampler),_createClass(i,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),_createClass(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias);var t=0,i=0,r=this._state.minFilter,n=this._state.magFilter,s=this._state.mipFilter;t=r===exports.GFXFilter.LINEAR||r===exports.GFXFilter.ANISOTROPIC?s===exports.GFXFilter.LINEAR||s===exports.GFXFilter.ANISOTROPIC?9987:s===exports.GFXFilter.POINT?9985:9729:s===exports.GFXFilter.LINEAR||s===exports.GFXFilter.ANISOTROPIC?9986:s===exports.GFXFilter.POINT?9984:9728,i=n===exports.GFXFilter.LINEAR||n===exports.GFXFilter.ANISOTROPIC?9729:9728;var a=WebGLWraps[this._state.addressU],o=WebGLWraps[this._state.addressV],c=WebGLWraps[this._state.addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:a,glWrapT:o,glWrapR:c},this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuSampler=null,this._status=exports.GFXStatus.UNREADY}}]),i}(),WebGLGFXShader=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuShader=null,t}return _inherits(i,GFXShader),_createClass(i,[{key:"gpuShader",get:function(){return this._gpuShader}}]),_createClass(i,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.type,source:i.source,macros:i.macros?i.macros:[],glShader:null}}return WebGLCmdFuncCreateShader(this._device,this._gpuShader),this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuShader&&(WebGLCmdFuncDestroyShader(this._device,this._gpuShader),this._gpuShader=null),this._status=exports.GFXStatus.UNREADY}}]),i}(),WebGLStateCache=function e(){_classCallCheck(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glTexUnits=new Array(GFX_MAX_TEXTURE_UNITS),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new GFXRasterizerState,this.dss=new GFXDepthStencilState,this.bs=new GFXBlendState,this.glEnabledAttribLocs=new Array(GFX_MAX_VERTEX_ATTRIBUTES),this.glCurrentAttribLocs=new Array(GFX_MAX_VERTEX_ATTRIBUTES),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var t=0;t<GFX_MAX_TEXTURE_UNITS;++t)this.glTexUnits[t]={glTexture:null}};function IsPowerOf2(e){return 0<e&&0==(e&e-1)}var WebGLGFXTexture=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuTexture=null,t}return _inherits(i,GFXTexture),_createClass(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),_createClass(i,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=IsPowerOf2(this._width)&&IsPowerOf2(this._height),this._size=GFXFormatSurfaceSize(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&exports.GFXTextureFlagBit.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case exports.GFXTextureType.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?exports.GFXTextureViewType.TV1D:exports.GFXTextureViewType.TV1D_ARRAY:exports.GFXTextureViewType.TV1D;break;case exports.GFXTextureType.TEX2D:var i=exports.GFXTextureFlagBit.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?exports.GFXTextureViewType.TV2D:i&exports.GFXTextureFlagBit.CUBEMAP?exports.GFXTextureViewType.CUBE:exports.GFXTextureViewType.TV2D_ARRAY:exports.GFXTextureViewType.TV2D;break;case exports.GFXTextureType.TEX3D:t=exports.GFXTextureViewType.TV3D;break;default:t=exports.GFXTextureViewType.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternelFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},WebGLCmdFuncCreateTexture(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTexture&&(WebGLCmdFuncDestroyTexture(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._status=exports.GFXStatus.UNREADY,this._buffer=null}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=GFXFormatSurfaceSize(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=this._width,this._gpuTexture.height=this._height,this._gpuTexture.size=this._size,WebGLCmdFuncResizeTexture(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size),this._status=exports.GFXStatus.UNREADY}}]),i}(),WebGLGFXTextureView=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._gpuTextureView=null,t}return _inherits(i,GFXTextureView),_createClass(i,[{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),_createClass(i,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=exports.GFXStatus.UNREADY}}]),i}(),GFXWindow=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,exports.GFXObjectType.WINDOW)))._device=void 0,t._title="",t._left=0,t._top=0,t._width=0,t._height=0,t._nativeWidth=0,t._nativeHeight=0,t._colorFmt=exports.GFXFormat.UNKNOWN,t._depthStencilFmt=exports.GFXFormat.UNKNOWN,t._isOffscreen=!1,t._renderPass=null,t._colorTex=null,t._colorTexView=null,t._depthStencilTex=null,t._depthStencilTexView=null,t._framebuffer=null,t._device=e,t}return _inherits(i,GFXObject),_createClass(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"detphStencilFormat",get:function(){return this._depthStencilFmt}},{key:"isOffscreen",get:function(){return this._isOffscreen}},{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTexView",get:function(){return this._colorTexView}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"framebuffer",get:function(){return this._framebuffer}}]),i}(),WebGLGFXWindow=function(){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e))}return _inherits(t,GFXWindow),_createClass(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:exports.GFXLoadOp.CLEAR,storeOp:exports.GFXStoreOp.STORE,sampleCount:1,beginLayout:exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL,endLayout:exports.GFXTextureLayout.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:exports.GFXLoadOp.CLEAR,depthStoreOp:exports.GFXStoreOp.STORE,stencilLoadOp:exports.GFXLoadOp.CLEAR,stencilStoreOp:exports.GFXStoreOp.STORE,sampleCount:1,beginLayout:exports.GFXTextureLayout.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:exports.GFXTextureLayout.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}});var t=[];return this._isOffscreen&&(this._colorFmt!==exports.GFXFormat.UNKNOWN&&(this._colorTex=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.COLOR_ATTACHMENT|exports.GFXTextureUsageBit.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:exports.GFXTextureFlagBit.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:exports.GFXTextureViewType.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==exports.GFXFormat.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:exports.GFXTextureFlagBit.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:exports.GFXTextureViewType.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=exports.GFXStatus.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=exports.GFXStatus.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:exports.GFXTextureViewType.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:exports.GFXTextureViewType.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(),WebGLGFXDevice=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this))).stateCache=new WebGLStateCache,e.nullTex2D=null,e.nullTexCube=null,e._webGLRC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!1,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._EXT_frag_depth=null,e._EXT_shader_texture_lod=null,e._EXT_sRGB=null,e._OES_vertex_array_object=null,e._EXT_color_buffer_half_float=null,e._WEBGL_color_buffer_float=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_astc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_shaders=null,e._WEBGL_draw_buffers=null,e._WEBGL_lose_context=null,e._WEBGL_depth_texture=null,e._WEBGL_debug_renderer_info=null,e._OES_texture_half_float=null,e._OES_texture_half_float_linear=null,e._OES_texture_float=null,e._OES_texture_float_linear=null,e._OES_standard_derivatives=null,e._OES_element_index_uint=null,e._ANGLE_instanced_arrays=null,e}return _inherits(t,GFXDevice),_createClass(t,[{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),_createClass(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:!1,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=GFXAPI.WEBGL,this._deviceName="WebGL";var i=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=exports.GFXFormat.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=exports.GFXFormat.D24S8:this._depthStencilFmt=exports.GFXFormat.D24:8===this._stencilBits?this._depthStencilFmt=exports.GFXFormat.D16S8:this._depthStencilFmt=exports.GFXFormat.D16,this._extensions=i.getSupportedExtensions();var r="";if(this._extensions){var n=this._extensions,s=Array.isArray(n),a=0;for(n=s?n:n[Symbol.iterator]();;){var o;if(s){if(a>=n.length)break;o=n[a++]}else{if((a=n.next()).done)break;o=a.value}r+=o+" "}console.debug("EXTENSIONS: "+r)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[GFXFeature.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[GFXFeature.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[GFXFeature.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[GFXFeature.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[GFXFeature.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[GFXFeature.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._WEBGL_depth_texture&&(this._features[GFXFeature.FORMAT_D24S8]=!0);var c="";this._WEBGL_compressed_texture_etc1&&(this._features[GFXFeature.FORMAT_ETC1]=!0,c+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[GFXFeature.FORMAT_ETC2]=!0,c+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[GFXFeature.FORMAT_DXT]=!0,c+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[GFXFeature.FORMAT_PVRTC]=!0,c+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[GFXFeature.FORMAT_ASTC]=!0,c+="astc "),this._features[GFXFeature.MSAA]=!1,this._OES_vertex_array_object&&(sys.platform===sys.WECHAT_GAME&&sys.os===sys.OS_IOS||(this._useVAO=!0)),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+c),this.initStates(i),this._queue=this.createQueue({type:exports.GFXQueueType.GRAPHICS});var l=this._webGLRC.canvas;this._mainWindow=this.createWindow({title:l.title||"",left:l.offsetLeft||0,top:l.offsetTop||0,width:this._webGLRC.drawingBufferWidth,height:this._webGLRC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new WebGLGFXTexture(this),this.nullTex2D.initialize({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.SAMPLED,format:exports.GFXFormat.RGBA8,width:2,height:2,flags:exports.GFXTextureFlagBit.GEN_MIPMAP}),this.nullTexCube=new WebGLGFXTexture(this),this.nullTexCube.initialize({type:exports.GFXTextureType.TEX2D,usage:exports.GFXTextureUsageBit.SAMPLED,format:exports.GFXFormat.RGBA8,width:2,height:2,arrayLayer:6,flags:exports.GFXTextureFlagBit.CUBEMAP|exports.GFXTextureFlagBit.GEN_MIPMAP});var u={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},h=new Uint8Array(this.nullTex2D.size);return h.fill(0),this.copyBuffersToTexture([h],this.nullTex2D,[u]),u.texSubres.layerCount=6,this.copyBuffersToTexture([h,h,h,h,h,h],this.nullTexCube,[u]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGLRC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new WebGLGFXBuffer(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new WebGLGFXTexture(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new WebGLGFXTextureView(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new WebGLGFXSampler(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new WebGLGFXBindingLayout(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new WebGLGFXShader(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new WebGLGFXInputAssembler(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new WebGLGFXRenderPass(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new WebGLGFXFramebuffer(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new WebGLGFXPipelineLayout(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new WebGLGFXPipelineState(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new WebGLGFXCommandAllocator(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new WebGLGFXCommandBuffer(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new WebGLGFXQueue(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new WebGLGFXWindow(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){WebGLCmdFuncCopyBuffersToTexture(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){WebGLCmdFuncCopyTexImagesToTexture(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var r=this._webGLRC,n=e.gpuFramebuffer,s=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==n.glFramebuffer&&(r.bindFramebuffer(r.FRAMEBUFFER,n.glFramebuffer),this.stateCache.glFramebuffer=n.glFramebuffer);var a=new Uint8Array(t),o=i,c=Array.isArray(o),l=0;for(o=c?o:o[Symbol.iterator]();;){var u;if(c){if(l>=o.length)break;u=o[l++]}else{if((l=o.next()).done)break;u=l.value}var h=u,_=h.buffOffset+h.buffTexHeight*h.buffStride,p=h.texExtent.width,d=h.texExtent.height,f=GFXFormatSize(exports.GFXFormat.RGBA8,p,d,1),m=a.subarray(_,_+f);r.readPixels(h.texOffset.x,h.texOffset.y,p,d,r.RGBA,r.UNSIGNED_BYTE,m)}this.stateCache.glFramebuffer!==s&&(r.bindFramebuffer(r.FRAMEBUFFER,s),this.stateCache.glFramebuffer=s)}},{key:"blitFramebuffer",value:function(e,t,i,r,n){}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var r=this._webGLRC.getExtension(t[i]+e);if(r)return r}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,4294967295),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,4294967295),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}();cc.WebGLGFXDevice=WebGLGFXDevice;var _dec$X,_dec2$z,_dec3$k,_dec4$h,_dec5$f,_dec6$c,_dec7$9,_dec8$4,_dec9$4,_dec10$4,_dec11$3,_dec12$2,_class$Y,_class2$N,_descriptor$K,_descriptor2$z,_descriptor3$o,_descriptor4$j,_descriptor5$e,_descriptor6$7,_descriptor7$6,_descriptor8$6,_descriptor9$5,_descriptor10$4,_descriptor11$2,_descriptor12$2,_descriptor13$2,_descriptor14$2,_class3$k,_temp$S,Transition,State,vec3_temp=new Vec3,_worldMatrix$1=new Mat4;function fillVertices3D(e,t,i,r){var n=i.datas,s=t.currBufferBatch,a=s.byteOffset>>2,o=i.vertexCount,c=s.indiceOffset,l=s.vertexOffset;s.request(o,i.indiceCount)||(s=t.currBufferBatch,l=c=o=0);var u=s.vData;e.getWorldMatrix(_worldMatrix$1);for(var h=0;h<o;h++){var _=n[h];Vec3.set(vec3_temp,_.x,_.y,0),Vec3.transformMat4(vec3_temp,vec3_temp,_worldMatrix$1),u[a++]=vec3_temp.x,u[a++]=vec3_temp.y,u[a++]=vec3_temp.z,u[a++]=_.u,u[a++]=_.v,Color.toArray(u,r,a),a+=4}for(var p=s.iData,d=0;d<i.dataLength;d++)p[c+d]=l+d}function fillMeshVertices3D(e,t,i,r){var n=i.datas,s=t.currBufferBatch,a=s.byteOffset>>2,o=i.vertexCount,c=s.indiceOffset,l=s.vertexOffset;s.request(o,i.indiceCount)||(s=t.currBufferBatch,l=c=o=0);var u=s.vData,h=s.iData;e.getWorldMatrix(_worldMatrix$1);for(var _=0;_<o;_++){var p=n[_];Vec3.set(vec3_temp,p.x,p.y,0),Vec3.transformMat4(vec3_temp,vec3_temp,_worldMatrix$1),u[a++]=vec3_temp.x,u[a++]=vec3_temp.y,u[a++]=vec3_temp.z,u[a++]=p.u,u[a++]=p.v,Color.toArray(u,r,a),a+=4}for(var d=0,f=o/4;d<f;d++){var m=l+4*d;h[c++]=m,h[c++]=m+1,h[c++]=m+2,h[c++]=m+1,h[c++]=m+3,h[c++]=m+2}}function fillVerticesWithoutCalc3D(e,t,i,r){var n=i.datas,s=t.currBufferBatch,a=s.byteOffset>>2,o=i.vertexCount,c=s.indiceOffset,l=s.vertexOffset;s.request(o,i.indiceCount)||(s=t.currBufferBatch,l=c=o=0);for(var u=s.vData,h=0;h<o;h++){var _=n[h];u[a++]=_.x,u[a++]=_.y,u[a++]=_.z,u[a++]=_.u,u[a++]=_.v,Color.toArray(u,r,a),a+=4}var p=s.iData;p[c++]=l,p[c++]=l+1,p[c++]=l+2,p[c++]=l+1,p[c++]=l+3,p[c++]=l+2}!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(Transition=Transition||{}),ccenum(Transition),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(State=State||{});var ButtonComponent=(_dec$X=ccclass("cc.ButtonComponent"),_dec2$z=executionOrder(110),_dec3$k=menu("UI/Button"),_dec4$h=property({displayOrder:1}),_dec5$f=property({type:Transition,displayOrder:2}),_dec6$c=property({min:0,max:10}),_dec7$9=property({type:SpriteFrame}),_dec8$4=property({type:SpriteFrame}),_dec9$4=property({type:SpriteFrame}),_dec10$4=property({type:SpriteFrame}),_dec11$3=property({type:Node$1,displayOrder:0}),_dec12$2=property({type:[EventHandler],displayOrder:3}),_dec$X(_class$Y=_dec2$z(_class$Y=_dec3$k((_temp$S=_class3$k=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"clickEvents",_descriptor$K,_assertThisInitialized(t)),_initializerDefineProperty(t,"_interactable",_descriptor2$z,_assertThisInitialized(t)),_initializerDefineProperty(t,"_transition",_descriptor3$o,_assertThisInitialized(t)),_initializerDefineProperty(t,"_normalColor",_descriptor4$j,_assertThisInitialized(t)),_initializerDefineProperty(t,"_hoverColor",_descriptor5$e,_assertThisInitialized(t)),_initializerDefineProperty(t,"_pressColor",_descriptor6$7,_assertThisInitialized(t)),_initializerDefineProperty(t,"_disabledColor",_descriptor7$6,_assertThisInitialized(t)),_initializerDefineProperty(t,"_normalSprite",_descriptor8$6,_assertThisInitialized(t)),_initializerDefineProperty(t,"_hoverSprite",_descriptor9$5,_assertThisInitialized(t)),_initializerDefineProperty(t,"_pressedSprite",_descriptor10$4,_assertThisInitialized(t)),_initializerDefineProperty(t,"_disabledSprite",_descriptor11$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"_duration",_descriptor12$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"_zoomScale",_descriptor13$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"_target",_descriptor14$2,_assertThisInitialized(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new Color,t._toColor=new Color,t._time=0,t._transitionFinished=!0,t._fromScale=new Vec3,t._toScale=new Vec3,t._originalScale=new Vec3,t._sprite=null,t._targetScale=new Vec3,t}return _inherits(s,Component),_createClass(s,[{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(SpriteComponent);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._updateState()}},{key:"onEnable",value:function(){this._registerEvent()}},{key:"onDisable",value:function(){this._resetState(),this.node.off(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.off(exports.SystemEventType.TOUCH_MOVE,this._onTouchMove,this),this.node.off(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.off(exports.SystemEventType.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(exports.SystemEventType.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(exports.SystemEventType.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"update",value:function(e){var t=this._target?this._target:this.node;if(!this._transitionFinished&&(this._transition===Transition.COLOR||this._transition===Transition.SCALE)){this._time+=e;var i=1;0<this._duration&&(i=this._time/this._duration),1<=i&&(i=1,this._transitionFinished=!0);var r=t.getComponent(UIRenderComponent);r&&(this._transition===Transition.COLOR?Color.lerp(r.color,this._fromColor,this._toColor,i):this.transition===Transition.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=lerp(this._fromScale.x,this._toScale.x,i),this._targetScale.y=lerp(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale)))}}},{key:"_resizeNodeToTargetNode",value:function(){0}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this._target;if(e){var t=e.getComponent(UIRenderComponent);if(t){var i=this._transition;i===Transition.COLOR&&this._interactable?t.color=this._normalColor:i===Transition.SCALE&&e.setScale(this._originalScale),this._transitionFinished=!0}}}},{key:"_registerEvent",value:function(){this.node.on(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(exports.SystemEventType.TOUCH_MOVE,this._onTouchMove,this),this.node.on(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.on(exports.SystemEventType.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(exports.SystemEventType.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(exports.SystemEventType.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(SpriteComponent)),t}},{key:"_applyTarget",value:function(){this._sprite=this._getTargetSprite(this._target),this._target&&Vec3.copy(this._originalScale,this._target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed){if(!e)return!1;var t=e.touch;if(!t)return!1;var i,r=this.node.uiTransfromComp.isHit(t.getUILocation());if(this._transition===Transition.SCALE&&this._target)r?(Vec3.copy(this._fromScale,this._originalScale),Vec3.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this._target&&this._target.setScale(this._originalScale));else i=r?State.PRESSED:State.NORMAL,this._applyTransition(i);e&&(e.propagationStopped=!0)}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(EventHandler.emitEvents(this.clickEvents,e),this.node.emit("click",this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition===Transition.SPRITE&&!this._hoverSprite||this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(e){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=State.NORMAL;return this._interactable?this._pressed?e=State.PRESSED:this._hovered&&(e=State.HOVER):e=State.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t=this[e+"Color"],i=this._target;if(i){var r=i.getComponent(UIRenderComponent);r&&(e===State.DISABLED?r.color=t:(this._fromColor=r.color.clone(),this._toColor=t,this._time=0,this._transitionFinished=!1))}}},{key:"_updateSpriteTransition",value:function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===State.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){Vec3.copy(this._fromScale,this._originalScale),Vec3.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1}},{key:"_zoomBack",value:function(){this._target&&(Vec3.copy(this._fromScale,this._target.getScale()),Vec3.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===Transition.COLOR?this._updateColorTransition(e):t===Transition.SPRITE?this._updateSpriteTransition(e):t===Transition.SCALE&&this._updateScaleTransition(e)}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition=e)}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressColor},set:function(e){this._pressColor!==e&&this._pressColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(SpriteComponent);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._applyTarget())}}]),s}(),_class3$k.Transition=Transition,_applyDecoratedDescriptor((_class2$N=_temp$S).prototype,"interactable",[_dec4$h],Object.getOwnPropertyDescriptor(_class2$N.prototype,"interactable"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"transition",[_dec5$f],Object.getOwnPropertyDescriptor(_class2$N.prototype,"transition"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"normalColor",[property],Object.getOwnPropertyDescriptor(_class2$N.prototype,"normalColor"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"pressedColor",[property],Object.getOwnPropertyDescriptor(_class2$N.prototype,"pressedColor"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"hoverColor",[property],Object.getOwnPropertyDescriptor(_class2$N.prototype,"hoverColor"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"disabledColor",[property],Object.getOwnPropertyDescriptor(_class2$N.prototype,"disabledColor"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"duration",[_dec6$c],Object.getOwnPropertyDescriptor(_class2$N.prototype,"duration"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"zoomScale",[property],Object.getOwnPropertyDescriptor(_class2$N.prototype,"zoomScale"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"normalSprite",[_dec7$9],Object.getOwnPropertyDescriptor(_class2$N.prototype,"normalSprite"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"pressedSprite",[_dec8$4],Object.getOwnPropertyDescriptor(_class2$N.prototype,"pressedSprite"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"hoverSprite",[_dec9$4],Object.getOwnPropertyDescriptor(_class2$N.prototype,"hoverSprite"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"disabledSprite",[_dec10$4],Object.getOwnPropertyDescriptor(_class2$N.prototype,"disabledSprite"),_class2$N.prototype),_applyDecoratedDescriptor(_class2$N.prototype,"target",[_dec11$3],Object.getOwnPropertyDescriptor(_class2$N.prototype,"target"),_class2$N.prototype),_descriptor$K=_applyDecoratedDescriptor(_class2$N.prototype,"clickEvents",[_dec12$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor2$z=_applyDecoratedDescriptor(_class2$N.prototype,"_interactable",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor3$o=_applyDecoratedDescriptor(_class2$N.prototype,"_transition",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Transition.NONE}}),_descriptor4$j=_applyDecoratedDescriptor(_class2$N.prototype,"_normalColor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Color(214,214,214,255)}}),_descriptor5$e=_applyDecoratedDescriptor(_class2$N.prototype,"_hoverColor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Color(211,211,211,255)}}),_descriptor6$7=_applyDecoratedDescriptor(_class2$N.prototype,"_pressColor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.WHITE.clone()}}),_descriptor7$6=_applyDecoratedDescriptor(_class2$N.prototype,"_disabledColor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Color(124,124,124,255)}}),_descriptor8$6=_applyDecoratedDescriptor(_class2$N.prototype,"_normalSprite",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor9$5=_applyDecoratedDescriptor(_class2$N.prototype,"_hoverSprite",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor10$4=_applyDecoratedDescriptor(_class2$N.prototype,"_pressedSprite",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor11$2=_applyDecoratedDescriptor(_class2$N.prototype,"_disabledSprite",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor12$2=_applyDecoratedDescriptor(_class2$N.prototype,"_duration",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_descriptor13$2=_applyDecoratedDescriptor(_class2$N.prototype,"_zoomScale",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),_descriptor14$2=_applyDecoratedDescriptor(_class2$N.prototype,"_target",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$Y=_class2$N))||_class$Y)||_class$Y)||_class$Y);cc.ButtonComponent=ButtonComponent;var _dec$Y,_dec2$A,_dec3$l,_dec4$i,_dec5$g,_dec6$d,_dec7$a,_dec8$5,_dec9$5,_dec10$5,_dec11$4,_dec12$3,_dec13$1,_dec14$1,_dec15$1,_dec16$1,_dec17$1,_dec18$1,_class$Z,_class2$O,_descriptor$L,_descriptor2$A,_descriptor3$p,_descriptor4$k,_descriptor5$f,_descriptor6$8,_descriptor7$7,_descriptor8$7,_descriptor9$6,_descriptor10$5,_descriptor11$3,_descriptor12$3,_descriptor13$3,_descriptor14$3,_descriptor15,_descriptor16,_class3$l,_temp$T,CacheMode,CanvasPool=function(){function e(){_classCallCheck(this,e),this.pool=[]}return _createClass(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}},{key:"put",value:function(e){32<=this.pool.length||this.pool.push(e)}}]),e}();!function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(exports.HorizontalTextAlignment||(exports.HorizontalTextAlignment={})),ccenum(exports.HorizontalTextAlignment),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(exports.VerticalTextAlignment||(exports.VerticalTextAlignment={})),ccenum(exports.VerticalTextAlignment),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(exports.Overflow||(exports.Overflow={})),ccenum(exports.Overflow),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(CacheMode=CacheMode||{}),ccenum(CacheMode);var KeyboardReturnType,InputMode,InputFlag,_class$_,_temp$U,LabelComponent=(_dec$Y=ccclass("cc.LabelComponent"),_dec2$A=executionOrder(110),_dec3$l=menu("UI/Render/Label"),_dec4$i=property({displayOrder:4,multiline:!0}),_dec5$g=property({type:exports.HorizontalTextAlignment,displayOrder:5}),_dec6$d=property({type:exports.VerticalTextAlignment,displayOrder:6}),_dec7$a=property({readonly:!0,displayName:"Actual Font Size",visible:!1}),_dec8$5=property({displayOrder:7}),_dec9$5=property({displayOrder:8}),_dec10$5=property({displayOrder:8}),_dec11$4=property({type:exports.Overflow,displayOrder:9}),_dec12$3=property({displayOrder:10}),_dec13$1=property({type:Font,displayOrder:11}),_dec14$1=property({displayOrder:12}),_dec15$1=property({type:CacheMode,displayOrder:13}),_dec16$1=property({displayOrder:15}),_dec17$1=property({displayOrder:16}),_dec18$1=property({displayOrder:17}),_dec$Y(_class$Z=_dec2$A(_class$Z=_dec3$l((_temp$T=_class3$l=function(){function i(){var e;return _classCallCheck(this,i),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this)),"_useOriginalSize",_descriptor$L,_assertThisInitialized(e)),_initializerDefineProperty(e,"_string",_descriptor2$A,_assertThisInitialized(e)),_initializerDefineProperty(e,"_horizontalAlign",_descriptor3$p,_assertThisInitialized(e)),_initializerDefineProperty(e,"_verticalAlign",_descriptor4$k,_assertThisInitialized(e)),_initializerDefineProperty(e,"_actualFontSize",_descriptor5$f,_assertThisInitialized(e)),_initializerDefineProperty(e,"_fontSize",_descriptor6$8,_assertThisInitialized(e)),_initializerDefineProperty(e,"_fontFamily",_descriptor7$7,_assertThisInitialized(e)),_initializerDefineProperty(e,"_lineHeight",_descriptor8$7,_assertThisInitialized(e)),_initializerDefineProperty(e,"_overflow",_descriptor9$6,_assertThisInitialized(e)),_initializerDefineProperty(e,"_enableWrapText",_descriptor10$5,_assertThisInitialized(e)),_initializerDefineProperty(e,"_font",_descriptor11$3,_assertThisInitialized(e)),_initializerDefineProperty(e,"_isSystemFontUsed",_descriptor12$3,_assertThisInitialized(e)),e._spacingX=0,_initializerDefineProperty(e,"_isItalic",_descriptor13$3,_assertThisInitialized(e)),_initializerDefineProperty(e,"_isBold",_descriptor14$3,_assertThisInitialized(e)),_initializerDefineProperty(e,"_isUnderline",_descriptor15,_assertThisInitialized(e)),_initializerDefineProperty(e,"_cacheMode",_descriptor16,_assertThisInitialized(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}return _inherits(i,UIRenderComponent),_createClass(i,[{key:"string",get:function(){return this._string},set:function(e){e=e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,"string"==typeof(this._font=e)&&warnID(4e3),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null,this._flushAssembler(),this.updateRenderData()))}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode===CacheMode.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof BitmapFont?this._font.fontSize:-1}}]),_createClass(i,[{key:"onEnable",value:function(){_get(_getPrototypeOf(i.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}},{key:"onDisable",value:function(){_get(_getPrototypeOf(i.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){var e=this._ttfSpriteFrame.texture;if(e){var t=e;t.image&&t.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture&&(this._letterTexture.destroy(),this._letterTexture=null),_get(_getPrototypeOf(i.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.markForUpdateRenderData(),t&&(this._flushAssembler(),this._applyFontTexture(t))}},{key:"_render",value:function(e){e.commitComp(this,this._texture.getGFXTextureView(),this._assembler)}},{key:"_updateColor",value:function(){this._font instanceof BitmapFont?_get(_getPrototypeOf(i.prototype),"_updateColor",this).call(this):this.updateRenderData(!1)}},{key:"_canRender",value:function(){if(!_get(_getPrototypeOf(i.prototype),"_canRender",this).call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof BitmapFont){var t=e.spriteFrame;if(!t||!t.textureLoaded())return!1}return!0}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material)}},{key:"_flushMaterial",value:function(){var e=this._material;e&&e.setProperty("mainTexture",this._texture),this._updateMaterial(e)}},{key:"_applyFontTexture",value:function(e){var t=this,i=this._font;if(i instanceof BitmapFont){var r=i.spriteFrame,n=this;r&&r.loaded&&(n._texture=r,n._flushMaterial(),e&&t._renderFlag&&t._assembler&&t._renderData&&t._assembler.updateRenderData(t))}else{if(this.cacheMode===CacheMode.CHAR&&sys.browserType!==sys.BROWSER_TYPE_WECHAT_GAME_SUB)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new SpriteFrame,this._assemblerData=this._assembler.getAssemblerData();var s=new ImageAsset(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=s}this.cacheMode!==CacheMode.CHAR&&(this._texture=this._ttfSpriteFrame),this._flushMaterial()}e&&this._renderFlag&&this._assembler&&this._renderData&&this._assembler.updateRenderData(this)}}]),i}(),_class3$l.HorizontalAlign=exports.HorizontalTextAlignment,_class3$l.VerticalAlign=exports.VerticalTextAlignment,_class3$l.Overflow=exports.Overflow,_class3$l.CacheMode=CacheMode,_class3$l.CanvasPool=new CanvasPool,_applyDecoratedDescriptor((_class2$O=_temp$T).prototype,"string",[_dec4$i],Object.getOwnPropertyDescriptor(_class2$O.prototype,"string"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"horizontalAlign",[_dec5$g],Object.getOwnPropertyDescriptor(_class2$O.prototype,"horizontalAlign"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"verticalAlign",[_dec6$d],Object.getOwnPropertyDescriptor(_class2$O.prototype,"verticalAlign"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"actualFontSize",[_dec7$a],Object.getOwnPropertyDescriptor(_class2$O.prototype,"actualFontSize"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"fontSize",[_dec8$5],Object.getOwnPropertyDescriptor(_class2$O.prototype,"fontSize"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"fontFamily",[_dec9$5],Object.getOwnPropertyDescriptor(_class2$O.prototype,"fontFamily"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"lineHeight",[_dec10$5],Object.getOwnPropertyDescriptor(_class2$O.prototype,"lineHeight"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"overflow",[_dec11$4],Object.getOwnPropertyDescriptor(_class2$O.prototype,"overflow"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"enableWrapText",[_dec12$3],Object.getOwnPropertyDescriptor(_class2$O.prototype,"enableWrapText"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"font",[_dec13$1],Object.getOwnPropertyDescriptor(_class2$O.prototype,"font"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"useSystemFont",[_dec14$1],Object.getOwnPropertyDescriptor(_class2$O.prototype,"useSystemFont"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"cacheMode",[_dec15$1],Object.getOwnPropertyDescriptor(_class2$O.prototype,"cacheMode"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"isBold",[_dec16$1],Object.getOwnPropertyDescriptor(_class2$O.prototype,"isBold"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"isItalic",[_dec17$1],Object.getOwnPropertyDescriptor(_class2$O.prototype,"isItalic"),_class2$O.prototype),_applyDecoratedDescriptor(_class2$O.prototype,"isUnderline",[_dec18$1],Object.getOwnPropertyDescriptor(_class2$O.prototype,"isUnderline"),_class2$O.prototype),_descriptor$L=_applyDecoratedDescriptor(_class2$O.prototype,"_useOriginalSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor2$A=_applyDecoratedDescriptor(_class2$O.prototype,"_string",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),_descriptor3$p=_applyDecoratedDescriptor(_class2$O.prototype,"_horizontalAlign",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.HorizontalTextAlignment.CENTER}}),_descriptor4$k=_applyDecoratedDescriptor(_class2$O.prototype,"_verticalAlign",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.VerticalTextAlignment.CENTER}}),_descriptor5$f=_applyDecoratedDescriptor(_class2$O.prototype,"_actualFontSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor6$8=_applyDecoratedDescriptor(_class2$O.prototype,"_fontSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),_descriptor7$7=_applyDecoratedDescriptor(_class2$O.prototype,"_fontFamily",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),_descriptor8$7=_applyDecoratedDescriptor(_class2$O.prototype,"_lineHeight",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),_descriptor9$6=_applyDecoratedDescriptor(_class2$O.prototype,"_overflow",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.Overflow.NONE}}),_descriptor10$5=_applyDecoratedDescriptor(_class2$O.prototype,"_enableWrapText",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor11$3=_applyDecoratedDescriptor(_class2$O.prototype,"_font",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor12$3=_applyDecoratedDescriptor(_class2$O.prototype,"_isSystemFontUsed",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor13$3=_applyDecoratedDescriptor(_class2$O.prototype,"_isItalic",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor14$3=_applyDecoratedDescriptor(_class2$O.prototype,"_isBold",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor15=_applyDecoratedDescriptor(_class2$O.prototype,"_isUnderline",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor16=_applyDecoratedDescriptor(_class2$O.prototype,"_cacheMode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CacheMode.NONE}}),_class$Z=_class2$O))||_class$Z)||_class$Z)||_class$Z);cc.LabelComponent=LabelComponent,function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(KeyboardReturnType=KeyboardReturnType||{}),Enum(KeyboardReturnType),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(InputMode=InputMode||{}),Enum(InputMode),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(InputFlag=InputFlag||{}),Enum(InputFlag);var SCROLLY=40,LEFT_PADDING=2,DELAY_TIME=400,FOCUS_DELAY_UC=400,FOCUS_DELAY_FIREFOX=0,_matrix$1=new Mat4,_matrix_temp=new Mat4,_vec3=new Vec3,_currentEditBoxImpl=null,polyfill={zoomInvalid:!1};sys.OS_ANDROID!==sys.os||sys.browserType!==sys.BROWSER_TYPE_SOUGOU&&sys.browserType!==sys.BROWSER_TYPE_360||(polyfill.zoomInvalid=!0);var _dec$Z,_dec2$B,_dec3$m,_dec4$j,_dec5$h,_dec6$e,_dec7$b,_dec8$6,_dec9$6,_dec10$6,_dec11$5,_dec12$4,_class$$,_class2$P,_descriptor$M,_descriptor2$B,_descriptor3$q,_descriptor4$l,_descriptor5$g,_descriptor6$9,_descriptor7$8,_descriptor8$8,_descriptor9$7,_descriptor10$6,_descriptor11$4,_descriptor12$4,_descriptor13$4,_descriptor14$4,_descriptor15$1,_descriptor16$1,_descriptor17,_descriptor18,_descriptor19,_class3$m,_temp$V,EditBoxImpl=ccclass(_class$_=_temp$U=function(){function e(){_classCallCheck(this,e),this._delegate=null,this._inputMode=-1,this._inputFlag=-1,this._returnType=KeyboardReturnType.DEFAULT,this._maxLength=50,this._text="",this._placeholderText="",this._alwaysOnTop=!1,this._size=new Size,this._node=null,this._editing=!1,this.__eventListeners={},this.__fullscreen=!1,this.__autoResize=!1,this.__rotateScreen=!1,this.__orientationChanged=void 0,this._edTxt=null,this._textColor=Color.WHITE.clone(),this._edFontSize=14,this._isTextArea=!1}return _createClass(e,[{key:"onEnable",value:function(){this._edTxt&&(this._alwaysOnTop?this._edTxt.style.display="":this._edTxt.style.display="none")}},{key:"onDisable",value:function(){this._edTxt&&(this._edTxt.style.display="none")}},{key:"setTabIndex",value:function(e){this._edTxt&&(this._edTxt.tabIndex=e)}},{key:"setFocus",value:function(){this._beginEditing()}},{key:"isFocused",value:function(){return this._edTxt?document.activeElement===this._edTxt:(warnID(4700),!1)}},{key:"stayOnTop",value:function(e){this._alwaysOnTop!==e&&this._edTxt&&(this._alwaysOnTop=e,this._edTxt.style.display=e?"":"none")}},{key:"setMaxLength",value:function(e){isNaN(e)||(e<0&&(e=65535),this._maxLength=e,this._edTxt&&(this._edTxt.maxLength=e))}},{key:"setString",value:function(e){this._text=e,this._edTxt&&(this._edTxt.value=e)}},{key:"getString",value:function(){return this._text}},{key:"setPlaceholderText",value:function(e){this._placeholderText=e}},{key:"getPlaceholderText",value:function(){return this._placeholderText}},{key:"setDelegate",value:function(e){this._delegate=e}},{key:"setInputMode",value:function(e){this._inputMode!==e&&(this._inputMode=e,this.createInput(),this._updateDomInputType(),this._updateSize(this._size.width,this._size.height))}},{key:"setInputFlag",value:function(e){if(this._inputFlag!==e){this._inputFlag=e,this._updateDomInputType();var t="none";e===InputFlag.INITIAL_CAPS_ALL_CHARACTERS?t="uppercase":e===InputFlag.INITIAL_CAPS_WORD&&(t="capitalize"),this._edTxt&&(this._edTxt.style.textTransform=t,this._edTxt.value=this._text)}}},{key:"setReturnType",value:function(e){this._returnType=e,this._updateDomInputType()}},{key:"setFontSize",value:function(e){this._edFontSize=e||this._edFontSize,this._edTxt&&(this._edTxt.style.fontSize=this._edFontSize+"px")}},{key:"setFontColor",value:function(e){this._textColor=e,this._edTxt&&(this._edTxt.style.color=e.toCSS("rgba"))}},{key:"setSize",value:function(e,t){this._size.width=e,this._size.height=t,this._updateSize(e,t)}},{key:"setNode",value:function(e){this._node=e}},{key:"update",value:function(){this._updateMatrix()}},{key:"clear",value:function(){this._node=null,this.setDelegate(null),this.removeDom()}},{key:"_onTouchBegan",value:function(e){}},{key:"_onTouchEnded",value:function(){this._beginEditing()}},{key:"_beginEditing",value:function(){sys.isMobile&&!this._editing&&this._beginEditingOnMobile();var e=this;function t(){e._edTxt&&e._edTxt.focus()}this._edTxt&&(this._edTxt.style.display="",sys.browserType===sys.BROWSER_TYPE_UC?setTimeout(t,FOCUS_DELAY_UC):sys.browserType===sys.BROWSER_TYPE_FIREFOX?setTimeout(t,FOCUS_DELAY_FIREFOX):t()),this._editing=!0}},{key:"_endEditing",value:function(){function e(){!t._alwaysOnTop&&t._edTxt&&(t._edTxt.style.display="none"),t._delegate&&t._delegate.editBoxEditingDidEnded&&t._delegate.editBoxEditingDidEnded()}var t=this;this._editing&&(sys.isMobile?setTimeout(function(){t._endEditingOnMobile(),e()},DELAY_TIME):e()),this._editing=!1}},{key:"_updateDomInputType",value:function(){var e=this._inputMode,t=this._edTxt;if(t){if(this._isTextArea){t=t;var i="none";return this._inputFlag===InputFlag.INITIAL_CAPS_ALL_CHARACTERS?i="uppercase":this._inputFlag===InputFlag.INITIAL_CAPS_WORD&&(i="capitalize"),void(t.style.textTransform=i)}if(t=t,this._inputFlag!==InputFlag.PASSWORD){var r=t.type;e===InputMode.EMAIL_ADDR?r="email":e===InputMode.NUMERIC||e===InputMode.DECIMAL?r="number":e===InputMode.PHONE_NUMBER?(r="number",t.pattern="[0-9]*"):e===InputMode.URL?r="url":(r="text",this._returnType===KeyboardReturnType.SEARCH&&(r="search")),t.type=r}else t.type="password"}}},{key:"_updateSize",value:function(e,t){var i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._node,t=view.getScaleX(),i=view.getScaleY(),r=view.getViewportRect(),n=view.getDevicePixelRatio();e.getWorldMatrix(_matrix$1);var s=e.uiTransfromComp;s&&Vec3.set(_vec3,-s.anchorX*s.width,-s.anchorY*s.height,_vec3.z),Mat4.transform(_matrix$1,_matrix$1,_vec3);var a=e.getComponent(UIRenderComponent);if(!a)return!1;var o=director.root.ui.getScreen(a.visibility);if(o){o.node.getWorldRT(_matrix_temp);var c=_matrix_temp.m12,l=_matrix_temp.m13,u=visibleRect.center;_matrix_temp.m12=u.x-(_matrix_temp.m00*c+_matrix_temp.m04*l),_matrix_temp.m13=u.y-(_matrix_temp.m01*c+_matrix_temp.m05*l),Mat4.multiply(_matrix_temp,_matrix_temp,_matrix$1),t/=n,i/=n;var h=game.container,_=_matrix_temp.m00*t,p=_matrix$1.m01,d=_matrix$1.m04,f=_matrix_temp.m05*i,m=parseInt(h&&h.style.paddingLeft||"0");m+=r.x/n;var y=parseInt(h&&h.style.paddingBottom||"0");y+=r.y/n;var v=_matrix_temp.m12*t+m,g=_matrix_temp.m13*i+y;polyfill.zoomInvalid&&(this._updateSize(this._size.width*_,this._size.height*f),f=_=1);var b="matrix("+_+","+-p+","+-d+","+f+","+v+","+-g+")";this._edTxt.style.transform=b,this._edTxt.style["-webkit-transform"]=b,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},{key:"_adjustEditBoxPosition",value:function(){this._node.getWorldMatrix(_matrix$1);var t=_matrix$1.m13,i=visibleRect.height,e=visibleRect.width,r=.5;i<e&&(r=.7),setTimeout(function(){if(window.scrollY<SCROLLY&&t<i*r){var e=i*r-t-window.scrollY;e<35&&(e=35),320<e&&(e=320),window.scrollTo(0,e)}},DELAY_TIME)}},{key:"createInput",value:function(){this._isTextArea=!1,this._inputMode===InputMode.ANY?(this._isTextArea=!0,this._createDomTextArea()):this._createDomInput()}},{key:"_beginEditingOnMobile",value:function(){var e=this;this.__orientationChanged=function(){e._adjustEditBoxPosition()},window.addEventListener("orientationchange",this.__orientationChanged),view.isAutoFullScreenEnabled()?(this.__fullscreen=!0,view.enableAutoFullScreen(!1),screen$1.exitFullScreen()):this.__fullscreen=!1,this.__autoResize=view._resizeWithBrowserSize,view.resizeWithBrowserSize(!1),_currentEditBoxImpl=this}},{key:"_endEditingOnMobile",value:function(){if(this.__rotateScreen){game.container&&(game.container.style["-webkit-transform"]="rotate(90deg)",game.container.style.transform="rotate(90deg)");var e=view._originalDesignResolutionSize.width,t=view._originalDesignResolutionSize.height;0<e&&view.setDesignResolutionSize(e,t,view.getResolutionPolicy()),this.__rotateScreen=!1}this.__orientationChanged&&window.removeEventListener("orientationchange",this.__orientationChanged),this.__fullscreen&&view.enableAutoFullScreen(!0),this.__autoResize&&_currentEditBoxImpl===this&&view.resizeWithBrowserSize(!0)}},{key:"_createDomInput",value:function(){this.removeDom();var e=this._edTxt=document.createElement("input");return e.type="text",e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="uppercase",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left=LEFT_PADDING+"px",e.style["-moz-appearance"]="textfield",e.className="cocosEditBox",e.style.fontFamily="Arial",registerInputEventListener(e,this),e}},{key:"_createDomTextArea",value:function(){this.removeDom();var e=this._edTxt=document.createElement("textarea");return e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.resize="none",e.style.textTransform="uppercase",e.style.overflowY="scroll",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left=LEFT_PADDING+"px",e.className="cocosEditBox",e.style.fontFamily="Arial",registerInputEventListener(e,this,!0),e}},{key:"_addDomToGameContainer",value:function(){game.container&&this._edTxt&&game.container.appendChild(this._edTxt)}},{key:"removeDom",value:function(){var e=this._edTxt;if(e){var t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionstart),e.removeEventListener("compositionend",t.compositionend),e.removeEventListener("input",t.input),e.removeEventListener("focus",t.focus),e.removeEventListener("keypress",t.keypress),e.removeEventListener("blur",t.blur),t.compositionstart=null,t.compositionend=null,t.input=null,t.focus=null,t.keypress=null,t.blur=null,contains$1(game.container,e)&&game.container&&game.container.removeChild(e)}this._edTxt=null}},{key:"text",get:function(){return this._text},set:function(e){this._text=e}},{key:"textColor",get:function(){return this._textColor}},{key:"fontSize",get:function(){return this._edFontSize}},{key:"returnType",set:function(e){this._returnType=e}},{key:"alwayOnTop",get:function(){return this._alwaysOnTop}},{key:"editing",get:function(){return this._editing},set:function(e){this._editing=e}},{key:"delegate",get:function(){return this._delegate}},{key:"eventListeners",get:function(){return this.__eventListeners}}]),e}())||_class$_;function _inputValueHandle(e,t){e.value.length>t._maxLength&&(e.value=e.value.slice(0,t._maxLength)),t._delegate&&t._delegate.editBoxTextChanged&&t._text!==e.value&&(t._text=e.value,t._delegate.editBoxTextChanged(t._text))}function registerInputEventListener(e,t){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],r=!1,n=t.eventListeners;n.compositionstart=function(){r=!0},e.addEventListener("compositionstart",n.compositionstart),n.compositionend=function(){r=!1,_inputValueHandle(this,t)},e.addEventListener("compositionend",n.compositionend),n.input=function(){r||_inputValueHandle(this,t)},e.addEventListener("input",n.input),n.focus=function(){this.style.fontSize=t.fontSize+"px",this.style.color=t.textColor.toCSS("rgba"),t.alwayOnTop&&(t.editing=!0),sys.isMobile&&t._beginEditingOnMobile(),t.delegate&&t.delegate.editBoxEditingDidBegan&&t.delegate.editBoxEditingDidBegan()},e.addEventListener("focus",n.focus),n.keypress=function(e){e.keyCode===macro.KEY.enter&&(e.propagationStopped=!0,t.delegate&&t.delegate.editBoxEditingReturn&&t.delegate.editBoxEditingReturn(),i||(t.text=this.value,t._endEditing(),game.canvas&&game.canvas.focus()))},e.addEventListener("keypress",n.keypress),n.blur=function(){t.text=this.value,t._endEditing()},e.addEventListener("blur",n.blur),t._addDomToGameContainer()}var LEFT_PADDING$1=2;function capitalize(e){return e.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}var _dec$_,_dec2$C,_dec3$n,_dec4$k,_dec5$i,_dec6$f,_dec7$c,_dec8$7,_class$10,_class2$Q,_descriptor$N,_descriptor2$C,_descriptor3$r,_descriptor4$m,_descriptor5$h,_descriptor6$a,_descriptor7$9,_descriptor8$9,_descriptor9$8,_descriptor10$7,_descriptor11$5,_descriptor12$5,_descriptor13$5,_descriptor14$5,_class3$n,_temp$W,EditBoxComponent=(_dec$Z=ccclass("cc.EditBoxComponent"),_dec2$B=executionOrder(100),_dec3$m=menu("UI/EditBox"),_dec4$j=property({type:SpriteFrame}),_dec5$h=property({type:KeyboardReturnType}),_dec6$e=property({type:InputFlag}),_dec7$b=property({type:InputMode}),_dec8$6=property({type:Color}),_dec9$6=property({type:[EventHandler]}),_dec10$6=property({type:[EventHandler]}),_dec11$5=property({type:[EventHandler]}),_dec12$4=property({type:[EventHandler]}),_dec$Z(_class$$=_dec2$B(_class$$=_dec3$m(_class$$=executeInEditMode((_temp$V=_class3$m=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"editingDidBegan",_descriptor$M,_assertThisInitialized(t)),_initializerDefineProperty(t,"textChanged",_descriptor2$B,_assertThisInitialized(t)),_initializerDefineProperty(t,"editingDidEnded",_descriptor3$q,_assertThisInitialized(t)),_initializerDefineProperty(t,"editingReturn",_descriptor4$l,_assertThisInitialized(t)),t._impl=null,t._textLabel=null,t._placeholderLabel=null,t._background=null,_initializerDefineProperty(t,"_returnType",_descriptor5$g,_assertThisInitialized(t)),_initializerDefineProperty(t,"_useOriginalSize",_descriptor6$9,_assertThisInitialized(t)),_initializerDefineProperty(t,"_string",_descriptor7$8,_assertThisInitialized(t)),_initializerDefineProperty(t,"_tabIndex",_descriptor8$8,_assertThisInitialized(t)),_initializerDefineProperty(t,"_backgroundImage",_descriptor9$7,_assertThisInitialized(t)),_initializerDefineProperty(t,"_inputFlag",_descriptor10$6,_assertThisInitialized(t)),_initializerDefineProperty(t,"_inputMode",_descriptor11$4,_assertThisInitialized(t)),_initializerDefineProperty(t,"_fontSize",_descriptor12$4,_assertThisInitialized(t)),_initializerDefineProperty(t,"_lineHeight",_descriptor13$4,_assertThisInitialized(t)),_initializerDefineProperty(t,"_maxLength",_descriptor14$4,_assertThisInitialized(t)),_initializerDefineProperty(t,"_fontColor",_descriptor15$1,_assertThisInitialized(t)),_initializerDefineProperty(t,"_placeholder",_descriptor16$1,_assertThisInitialized(t)),_initializerDefineProperty(t,"_placeholderFontSize",_descriptor17,_assertThisInitialized(t)),_initializerDefineProperty(t,"_placeholderFontColor",_descriptor18,_assertThisInitialized(t)),_initializerDefineProperty(t,"_stayOnTop",_descriptor19,_assertThisInitialized(t)),t}return _inherits(s,Component),_createClass(s,[{key:"onEnable",value:function(){this._impl&&this._impl.onEnable()}},{key:"onDisable",value:function(){this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"_init",value:function(){this._createBackgroundSprite(),this._createLabels(),this.node.on(exports.SystemEventType.SIZE_CHANGED,this._resizeChildNodes,this);var e=this._impl=new EditBoxImpl;e.setDelegate(this),e.setNode(this.node),e.setInputMode(this._inputMode),e.setMaxLength(this._maxLength),e.setInputFlag(this._inputFlag),e.setReturnType(this._returnType),e.setTabIndex(this._tabIndex),e.setFontColor(this._fontColor),e.setFontSize(this._fontSize),e.setPlaceholderText(this._placeholder),this._updateStayOnTop(),this._updateString(this._string),this._syncSize()}},{key:"__preload",value:function(){this._registerEvent(),this._init()}},{key:"_registerEvent",value:function(){this.node.on(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateStayOnTop",value:function(){this.stayOnTop?this._hideLabels():this._showLabels(),this._impl&&this._impl.stayOnTop(this.stayOnTop)}},{key:"_syncSize",value:function(){var e=this.node.getContentSize();this._background&&(this._background.node.setAnchorPoint(this.node.getAnchorPoint()),this._background.node.setContentSize(e)),this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}},{key:"_updateLabelPosition",value:function(e){var t=this.node,i=-t.anchorX*t.width,r=-t.anchorY*t.height,n=this._placeholderLabel,s=this._textLabel;s&&(s.node.setContentSize(e.width-LEFT_PADDING$1,e.height),s.node.setPosition(i+LEFT_PADDING$1,r+e.height,s.node.getPosition().z),s.verticalAlign=this._inputMode===InputMode.ANY?exports.VerticalTextAlignment.TOP:exports.VerticalTextAlignment.CENTER,s.enableWrapText=this._inputMode===InputMode.ANY),n&&(n.node.setContentSize(e.width-LEFT_PADDING$1,e.height),n.lineHeight=e.height,n.node.setPosition(i+LEFT_PADDING$1,r+e.height,n.node.getPosition().z),n.verticalAlign=this._inputMode===InputMode.ANY?exports.VerticalTextAlignment.TOP:exports.VerticalTextAlignment.CENTER,n.enableWrapText=this._inputMode===InputMode.ANY)}},{key:"_createBackgroundSprite",value:function(){this._background||(this._background=this.node.getComponent(SpriteComponent),this._background||(this._background=this.node.addComponent(SpriteComponent))),this._background.type=SpriteComponent.Type.SLICED,this._background.spriteFrame=this._backgroundImage}},{key:"_createLabels",value:function(){if(!this._textLabel){var e=this.node.getChildByName("TEXT_LABEL"),t=(e=e||new Node$1("TEXT_LABEL")).getComponent(LabelComponent);e.parent=this.node,t=t||e.addComponent(LabelComponent),e.getComponent(UITransformComponent).setAnchorPoint(0,1),t.color=this._fontColor,t.overflow=LabelComponent.Overflow.CLAMP,t.fontSize=this._fontSize,t.lineHeight=this.lineHeight,this._textLabel=t}if(!this._placeholderLabel){var i=this.node.getChildByName("PLACEHOLDER_LABEL"),r=(i=i||new Node$1("PLACEHOLDER_LABEL")).getComponent(LabelComponent);r=r||i.addComponent(LabelComponent);var n=i.getComponent(UITransformComponent);i.parent=this.node,r.color=this._placeholderFontColor,n.setAnchorPoint(0,1),r.overflow=LabelComponent.Overflow.CLAMP,r.fontSize=this._placeholderFontSize,r.string=this._placeholder,this._placeholderLabel=r}}},{key:"_resizeChildNodes",value:function(){var e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-this.node.width/2,this.node.height/2,e.getPosition().z),e.width=this.node.width,e.height=this.node.height);var t=this._placeholderLabel&&this._placeholderLabel.node;t&&(t.setPosition(-this.node.width/2,this.node.height/2,t.getPosition().z),t.width=this.node.width,t.height=this.node.height);var i=this._background&&this._background.node;i&&(i.width=this.node.width,i.height=this.node.height)}},{key:"_showLabels",value:function(){if(this._textLabel){var e=this._textLabel.string;this._textLabel.node.active=""!==e,this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_hideLabels",value:function(){this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var i=e;i=i&&this._updateLabelStringStyle(i),t.string=i,this._impl&&(this._impl.setString(e),this._impl.editing||this.stayOnTop||this._showLabels())}}},{key:"_updateLabelStringStyle",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t,r=this._inputFlag;if(i||r!==InputFlag.PASSWORD)r===InputFlag.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():r===InputFlag.INITIAL_CAPS_WORD?e=capitalize(e):r===InputFlag.INITIAL_CAPS_SENTENCE&&(e=capitalizeFirstLetter(e));else{for(var n="",s=e.length,a=0;a<s;++a)n+="●";e=n}return e}},{key:"editBoxEditingDidBegan",value:function(){this._hideLabels(),EventHandler.emitEvents(this.editingDidBegan,this),this.node.emit("editing-did-began",this)}},{key:"editBoxEditingDidEnded",value:function(){this.stayOnTop||this._showLabels(),EventHandler.emitEvents(this.editingDidEnded,this),this.node.emit("editing-did-ended",this)}},{key:"editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,EventHandler.emitEvents(this.textChanged,e,this),this.node.emit("text-changed",this)}},{key:"editBoxEditingReturn",value:function(){EventHandler.emitEvents(this.editingReturn,this),this.node.emit("editing-return",this)}},{key:"_onTouchBegan",value:function(e){this._impl&&this._impl._onTouchBegan(e.touch),e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl._onTouchEnded(),e.propagationStopped=!0}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus()}},{key:"isFocused",value:function(){var e=!1;return this._impl&&(e=this._impl.isFocused()),e}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"string",get:function(){return this._string},set:function(e){0<=this._maxLength&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._impl&&this._updateString(e)}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._createBackgroundSprite())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e,this._impl&&(this._impl.returnType=this._returnType)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._impl&&(this._impl.setInputFlag(this._inputFlag),this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode=e,this._impl&&this._impl.setInputMode(this._inputMode)}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._textLabel&&(this._textLabel.fontSize=this._fontSize),this._impl&&this._impl.setFontSize(this._fontSize))}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._textLabel&&(this._textLabel.lineHeight=this._lineHeight))}},{key:"fontColor",get:function(){return this._fontColor},set:function(e){if(this._fontColor!==e){if(this._fontColor.set(e),this._textLabel){var t=this._textLabel.node.getComponent(UIRenderComponent);t&&(t.color=this._fontColor)}this._impl&&this._impl.setFontColor(this._fontColor)}}},{key:"placeholder",get:function(){return this._placeholder},set:function(e){this._placeholder!==e&&(this._placeholder=e,this._placeholderLabel&&(this._placeholderLabel.string=this._placeholder),this._impl&&this._impl.setPlaceholderText(this._placeholder))}},{key:"placeholderFontSize",get:function(){return this._placeholderFontSize},set:function(e){this._placeholderFontSize!==e&&(this._placeholderFontSize=e,this._placeholderLabel&&(this._placeholderLabel.fontSize=this._placeholderFontSize))}},{key:"placeholderFontColor",get:function(){return this._placeholderFontColor},set:function(e){if(this._placeholderFontColor!==e&&(this._placeholderFontColor=e,this._placeholderLabel)){var t=this._placeholderLabel.node.getComponent(UIRenderComponent);t&&(t.color=this._placeholderFontColor)}}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength!==e&&(this._maxLength=e,this._impl&&this._impl.setMaxLength(this._maxLength))}},{key:"stayOnTop",get:function(){return this._stayOnTop},set:function(e){this._stayOnTop=e,this._impl&&this._updateStayOnTop()}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex=e,this._impl&&this._impl.setTabIndex(e)}}]),s}(),_class3$m._EditBoxImpl=EditBoxImpl,_class3$m.KeyboardReturnType=KeyboardReturnType,_class3$m.InputFlag=InputFlag,_class3$m.InputMode=InputMode,_applyDecoratedDescriptor((_class2$P=_temp$V).prototype,"string",[property],Object.getOwnPropertyDescriptor(_class2$P.prototype,"string"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"backgroundImage",[_dec4$j],Object.getOwnPropertyDescriptor(_class2$P.prototype,"backgroundImage"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"returnType",[_dec5$h],Object.getOwnPropertyDescriptor(_class2$P.prototype,"returnType"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"inputFlag",[_dec6$e],Object.getOwnPropertyDescriptor(_class2$P.prototype,"inputFlag"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"inputMode",[_dec7$b],Object.getOwnPropertyDescriptor(_class2$P.prototype,"inputMode"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"fontSize",[property],Object.getOwnPropertyDescriptor(_class2$P.prototype,"fontSize"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"lineHeight",[property],Object.getOwnPropertyDescriptor(_class2$P.prototype,"lineHeight"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"fontColor",[_dec8$6],Object.getOwnPropertyDescriptor(_class2$P.prototype,"fontColor"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"placeholder",[property],Object.getOwnPropertyDescriptor(_class2$P.prototype,"placeholder"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"placeholderFontSize",[property],Object.getOwnPropertyDescriptor(_class2$P.prototype,"placeholderFontSize"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"placeholderFontColor",[property],Object.getOwnPropertyDescriptor(_class2$P.prototype,"placeholderFontColor"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"maxLength",[property],Object.getOwnPropertyDescriptor(_class2$P.prototype,"maxLength"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"stayOnTop",[property],Object.getOwnPropertyDescriptor(_class2$P.prototype,"stayOnTop"),_class2$P.prototype),_applyDecoratedDescriptor(_class2$P.prototype,"tabIndex",[property],Object.getOwnPropertyDescriptor(_class2$P.prototype,"tabIndex"),_class2$P.prototype),_descriptor$M=_applyDecoratedDescriptor(_class2$P.prototype,"editingDidBegan",[_dec9$6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor2$B=_applyDecoratedDescriptor(_class2$P.prototype,"textChanged",[_dec10$6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor3$q=_applyDecoratedDescriptor(_class2$P.prototype,"editingDidEnded",[_dec11$5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor4$l=_applyDecoratedDescriptor(_class2$P.prototype,"editingReturn",[_dec12$4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor5$g=_applyDecoratedDescriptor(_class2$P.prototype,"_returnType",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KeyboardReturnType.DEFAULT}}),_descriptor6$9=_applyDecoratedDescriptor(_class2$P.prototype,"_useOriginalSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor7$8=_applyDecoratedDescriptor(_class2$P.prototype,"_string",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor8$8=_applyDecoratedDescriptor(_class2$P.prototype,"_tabIndex",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor9$7=_applyDecoratedDescriptor(_class2$P.prototype,"_backgroundImage",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor10$6=_applyDecoratedDescriptor(_class2$P.prototype,"_inputFlag",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return InputFlag.DEFAULT}}),_descriptor11$4=_applyDecoratedDescriptor(_class2$P.prototype,"_inputMode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return InputMode.ANY}}),_descriptor12$4=_applyDecoratedDescriptor(_class2$P.prototype,"_fontSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),_descriptor13$4=_applyDecoratedDescriptor(_class2$P.prototype,"_lineHeight",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),_descriptor14$4=_applyDecoratedDescriptor(_class2$P.prototype,"_maxLength",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),_descriptor15$1=_applyDecoratedDescriptor(_class2$P.prototype,"_fontColor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.WHITE.clone()}}),_descriptor16$1=_applyDecoratedDescriptor(_class2$P.prototype,"_placeholder",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Enter text here..."}}),_descriptor17=_applyDecoratedDescriptor(_class2$P.prototype,"_placeholderFontSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),_descriptor18=_applyDecoratedDescriptor(_class2$P.prototype,"_placeholderFontColor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.GRAY.clone()}}),_descriptor19=_applyDecoratedDescriptor(_class2$P.prototype,"_stayOnTop",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_class$$=_class2$P))||_class$$)||_class$$)||_class$$)||_class$$);cc.EditBoxComponent=EditBoxComponent;var Type,ResizeMode,AxisDirection,VerticalDirection,HorizontalDirection,NodeEvent=exports.SystemEventType;!function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(Type=Type||{}),ccenum(Type),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(ResizeMode=ResizeMode||{}),ccenum(ResizeMode),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(AxisDirection=AxisDirection||{}),ccenum(AxisDirection),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(VerticalDirection=VerticalDirection||{}),ccenum(VerticalDirection),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(HorizontalDirection=HorizontalDirection||{}),ccenum(HorizontalDirection);var LineCap,LineJoin,PointFlags,_dec$$,_dec2$D,_dec3$o,_dec4$l,_dec5$j,_dec6$g,_class$11,_class2$R,_descriptor$O,_descriptor2$D,_descriptor3$s,_descriptor4$n,_descriptor5$i,_descriptor6$b,_class3$o,_temp$X,_tempPos=new Vec3,_tempScale=new Vec3,LayoutComponent=(_dec$_=ccclass("cc.LayoutComponent"),_dec2$C=executionOrder(110),_dec3$n=menu("UI/Layout"),_dec4$k=property({type:Type}),_dec5$i=property({type:ResizeMode}),_dec6$f=property({type:AxisDirection}),_dec7$c=property({type:VerticalDirection}),_dec8$7=property({type:HorizontalDirection}),_dec$_(_class$10=_dec2$C(_class$10=_dec3$n(_class$10=executeInEditMode((_temp$W=_class3$n=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._layoutDirty=!0,_initializerDefineProperty(t,"_resizeMode",_descriptor$N,_assertThisInitialized(t)),_initializerDefineProperty(t,"_N$layoutType",_descriptor2$C,_assertThisInitialized(t)),_initializerDefineProperty(t,"_N$padding",_descriptor3$r,_assertThisInitialized(t)),_initializerDefineProperty(t,"_cellSize",_descriptor4$m,_assertThisInitialized(t)),_initializerDefineProperty(t,"_startAxis",_descriptor5$h,_assertThisInitialized(t)),_initializerDefineProperty(t,"_paddingLeft",_descriptor6$a,_assertThisInitialized(t)),_initializerDefineProperty(t,"_paddingRight",_descriptor7$9,_assertThisInitialized(t)),_initializerDefineProperty(t,"_paddingTop",_descriptor8$9,_assertThisInitialized(t)),_initializerDefineProperty(t,"_paddingBottom",_descriptor9$8,_assertThisInitialized(t)),_initializerDefineProperty(t,"_spacingX",_descriptor10$7,_assertThisInitialized(t)),_initializerDefineProperty(t,"_spacingY",_descriptor11$5,_assertThisInitialized(t)),t._layoutSize=new Size(300,200),_initializerDefineProperty(t,"_verticalDirection",_descriptor12$5,_assertThisInitialized(t)),_initializerDefineProperty(t,"_horizontalDirection",_descriptor13$5,_assertThisInitialized(t)),_initializerDefineProperty(t,"_affectedByScale",_descriptor14$5,_assertThisInitialized(t)),t}return _inherits(s,Component),_createClass(s,[{key:"updateLayout",value:function(){this._layoutDirty&&0<this.node.children.length&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners(),this.node.getContentSize().equals(new Size)&&this.node.setContentSize(this._layoutSize),0!==this._N$padding&&this._migratePaddingData(),this._doLayoutDirty()}},{key:"onDisable",value:function(){this._removeEventListeners()}},{key:"_migratePaddingData",value:function(){this._paddingLeft=this._N$padding,this._paddingRight=this._N$padding,this._paddingTop=this._N$padding,this._paddingBottom=this._N$padding,this._N$padding=0}},{key:"_addEventListeners",value:function(){director.on(Director.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(NodeEvent.SIZE_CHANGED,this._resized,this),this.node.on(NodeEvent.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(NodeEvent.CHILD_ADDED,this._childAdded,this),this.node.on(NodeEvent.CHILD_REMOVED,this._childRemoved,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){director.off(Director.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(NodeEvent.SIZE_CHANGED,this._resized,this),this.node.off(NodeEvent.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(NodeEvent.CHILD_ADDED,this._childAdded,this),this.node.off(NodeEvent.CHILD_REMOVED,this._childRemoved,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;n.on(NodeEvent.SCALE_PART,this._doScaleDirty,this),n.on(NodeEvent.SIZE_CHANGED,this._doLayoutDirty,this),n.on(NodeEvent.TRANSFORM_CHANGED,this._transformDirty,this),n.on(NodeEvent.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_removeChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;n.off(NodeEvent.SCALE_PART,this._doScaleDirty,this),n.off(NodeEvent.SIZE_CHANGED,this._doLayoutDirty,this),n.off(NodeEvent.TRANSFORM_CHANGED,this._transformDirty,this),n.off(NodeEvent.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_childAdded",value:function(e){e.on(NodeEvent.SCALE_PART,this._doScaleDirty,this),e.on(NodeEvent.SIZE_CHANGED,this._doLayoutDirty,this),e.on(NodeEvent.TRANSFORM_CHANGED,this._transformDirty,this),e.on(NodeEvent.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_childRemoved",value:function(e){e.off(NodeEvent.SCALE_PART,this._doScaleDirty,this),e.off(NodeEvent.SIZE_CHANGED,this._doLayoutDirty,this),e.off(NodeEvent.TRANSFORM_CHANGED,this._transformDirty,this),e.off(NodeEvent.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_resized",value:function(){this._layoutSize=this.node.getContentSize(),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,i,r){var n=this.node.getAnchorPoint(),s=this.node.children,a=1,o=this._paddingLeft,c=-n.x*e;this._horizontalDirection===HorizontalDirection.RIGHT_TO_LEFT&&(a=-1,c=(1-n.x)*e,o=this._paddingRight);var l=c+a*o-a*this._spacingX,u=0,h=0,_=0,p=0,d=0,f=0,m=0,y=s,v=Array.isArray(y),g=0;for(y=v?y:y[Symbol.iterator]();;){var b;if(v){if(g>=y.length)break;b=y[g++]}else{if((g=y.next()).done)break;b=g.value}b.activeInHierarchy&&m++}var x=this._cellSize.width;this._N$layoutType!==Type.GRID&&this._resizeMode===ResizeMode.CHILDREN&&(x=(e-(this._paddingLeft+this._paddingRight)-(m-1)*this._spacingX)/m);var T=s,C=Array.isArray(T),S=0;for(T=C?T:T[Symbol.iterator]();;){var E;if(C){if(S>=T.length)break;E=T[S++]}else{if((S=T.next()).done)break;E=S.value}var w=E;if(w.activeInHierarchy){w.getScale(_tempScale);var A=this._getUsedScaleValue(_tempScale.x),$=this._getUsedScaleValue(_tempScale.y);this._resizeMode===ResizeMode.CHILDREN&&(w.width=x/A,this._N$layoutType===Type.GRID&&(w.height=this._cellSize.height/$));var O=w.anchorX,D=w.width*A,k=w.height*$;h<_&&(h=_),h<=k&&(_=h,h=k,f=w.getAnchorPoint().y),this._horizontalDirection===HorizontalDirection.RIGHT_TO_LEFT&&(O=1-w.anchorX),l=l+a*O*D+a*this._spacingX;var R=a*(1-O)*D;if(t){var I=l+R+a*(0<a?this._paddingRight:this._paddingLeft),F=!1;this._horizontalDirection===HorizontalDirection.LEFT_TO_RIGHT&&I>(1-n.x)*e&&(F=!0);var P=!1;this._horizontalDirection===HorizontalDirection.RIGHT_TO_LEFT&&I<-n.x*e&&(P=!0),(F||P)&&(h<=k?(0===_&&(_=h),u+=_,_=h):(u+=h,_=k,h=0),l=c+a*(o+O*D),p++)}var M=i(w,u,p);e>=D+this._paddingLeft+this._paddingRight&&r&&(w.getPosition(_tempPos),w.setPosition(l,M,_tempPos.z));var L=1,z=void 0,B=0===h?k:h;this._verticalDirection===VerticalDirection.TOP_TO_BOTTOM?(d=d||this.node.getContentSize().height,(z=M+(L=-1)*(B*f+this._paddingBottom))<d&&(d=z)):(d=d||-this.node.getContentSize().height)<(z=M+L*(B*f+this._paddingTop))&&(d=z),l+=R}}return d}},{key:"_doLayoutVertically",value:function(e,t,i,r){var n=this.node.getAnchorPoint(),s=this.node.children,a=1,o=this._paddingBottom,c=-n.y*e;this._verticalDirection===VerticalDirection.TOP_TO_BOTTOM&&(a=-1,c=(1-n.y)*e,o=this._paddingTop);var l=c+a*o-a*this._spacingY,u=0,h=0,_=0,p=0,d=0,f=0,m=0,y=s,v=Array.isArray(y),g=0;for(y=v?y:y[Symbol.iterator]();;){var b;if(v){if(g>=y.length)break;b=y[g++]}else{if((g=y.next()).done)break;b=g.value}b.activeInHierarchy&&m++}var x=this._cellSize.height;this._N$layoutType!==Type.GRID&&this._resizeMode===ResizeMode.CHILDREN&&(x=(e-(this._paddingTop+this._paddingBottom)-(m-1)*this._spacingY)/m);var T=s,C=Array.isArray(T),S=0;for(T=C?T:T[Symbol.iterator]();;){var E;if(C){if(S>=T.length)break;E=T[S++]}else{if((S=T.next()).done)break;E=S.value}var w=E;if(w){var A=w.getScale(),$=this._getUsedScaleValue(A.x),O=this._getUsedScaleValue(A.y);if(w.activeInHierarchy){this._resizeMode===ResizeMode.CHILDREN&&(w.height=x/O,this._N$layoutType===Type.GRID&&(w.width=this._cellSize.width/$));var D=w.anchorY,k=w.width*$,R=w.height*O;h<_&&(h=_),h<=k&&(_=h,h=k,f=w.getAnchorPoint().x),this._verticalDirection===VerticalDirection.TOP_TO_BOTTOM&&(D=1-w.anchorY),l=l+a*D*R+a*this._spacingY;var I=a*(1-D)*R;if(t){var F=l+I+a*(0<a?this._paddingTop:this._paddingBottom),P=!1;this._verticalDirection===VerticalDirection.BOTTOM_TO_TOP&&F>(1-n.y)*e&&(P=!0);var M=!1;this._verticalDirection===VerticalDirection.TOP_TO_BOTTOM&&F<-n.y*e&&(M=!0),(P||M)&&(h<=k?(0===_&&(_=h),u+=_,_=h):(u+=h,_=k,h=0),l=c+a*(o+D*R),p++)}var L=i(w,u,p);e>=R+(this._paddingTop+this._paddingBottom)&&r&&(w.getPosition(_tempPos),w.setPosition(L,l,_tempPos.z));var z=1,B=void 0,N=0===h?k:h;this._horizontalDirection===HorizontalDirection.RIGHT_TO_LEFT?(z=-1,d=d||this.node.getContentSize().width,(B=L+z*(N*f+this._paddingLeft))<d&&(d=B)):(d=d||-this.node.getContentSize().width)<(B=L+z*(N*f+this._paddingRight))&&(d=B),l+=I}}}return d}},{key:"_doLayoutBasic",value:function(){var e=null,t=this.node.children,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n,a=s.getComponent(UITransformComponent);a&&s.activeInHierarchy&&(e?Rect.union(e,e,a.getBoundingBoxToWorld()):e=a.getBoundingBoxToWorld())}if(e){var o=this.node.parent.getComponent(UITransformComponent);if(!o)return;Vec3.set(_tempPos,e.x,e.y,0);var c=new Vec3;o.convertToNodeSpaceAR(_tempPos,c),Vec3.set(c,c.x-this._paddingLeft,c.y-this._paddingBottom,c.z),Vec3.set(_tempPos,e.x+e.width,e.y+e.height,0);var l=new Vec3;o.convertToNodeSpaceAR(_tempPos,l),Vec3.set(l,l.x+this._paddingRight,l.y+this._paddingTop,l.z);var u=cc.size(parseFloat((l.x-c.x).toFixed(2)),parseFloat((l.y-c.y).toFixed(2)));if(this.node.getPosition(_tempPos),0!==u.width){var h=(_tempPos.x-c.x)/u.width;this.node.anchorX=parseFloat(h.toFixed(2))}if(0!==u.height){var _=(_tempPos.y-c.y)/u.height;this.node.anchorY=parseFloat(_.toFixed(2))}this.node.setContentSize(u)}}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var r=this,i=t.width,n=1,s=-e.y*t.height,a=this._paddingBottom;this._verticalDirection===VerticalDirection.TOP_TO_BOTTOM&&(n=-1,s=(1-e.y)*t.height,a=this._paddingTop);function o(e,t,i){return s+n*(t+e.anchorY*e.height*c._getUsedScaleValue(e.getScale().y)+a+i*r._spacingY)}var c=this,l=0;if(this._resizeMode===ResizeMode.CONTAINER){var u=this._doLayoutHorizontally(i,!0,o,!1);(l=s-u)<0&&(l*=-1),s=-e.y*l,this._verticalDirection===VerticalDirection.TOP_TO_BOTTOM&&(n=-1,s=(1-e.y)*l)}this._doLayoutHorizontally(i,!0,o,!0),this._resizeMode===ResizeMode.CONTAINER&&this.node.setContentSize(i,l)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var r=this,i=t.height,n=1,s=-e.x*t.width,a=this._paddingLeft;this._horizontalDirection===HorizontalDirection.RIGHT_TO_LEFT&&(n=-1,s=(1-e.x)*t.width,a=this._paddingRight);function o(e,t,i){return s+n*(t+e.anchorX*e.width*c._getUsedScaleValue(e.getScale().x)+a+i*r._spacingX)}var c=this,l=0;if(this._resizeMode===ResizeMode.CONTAINER){var u=this._doLayoutVertically(i,!0,o,!1);(l=s-u)<0&&(l*=-1),s=-e.x*l,this._horizontalDirection===HorizontalDirection.RIGHT_TO_LEFT&&(n=-1,s=(1-e.x)*l)}this._doLayoutVertically(i,!0,o,!0),this._resizeMode===ResizeMode.CONTAINER&&this.node.setContentSize(l,i)}},{key:"_doLayoutGrid",value:function(){var e=this.node.getAnchorPoint(),t=this.node.getContentSize();this.startAxis===AxisDirection.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,t):this.startAxis===AxisDirection.VERTICAL&&this._doLayoutGridAxisVertical(e,t)}},{key:"_getHorizontalBaseWidth",value:function(e){var t=0,i=0;if(this._resizeMode===ResizeMode.CONTAINER){var r=e,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=a;o.getScale(_tempScale),o.activeInHierarchy&&(i++,t+=o.width*this._getUsedScaleValue(_tempScale.x))}t+=(i-1)*this._spacingX+this._paddingLeft+this._paddingRight}else t=this.node.getContentSize().width;return t}},{key:"_getVerticalBaseHeight",value:function(e){var t=0,i=0;if(this._resizeMode===ResizeMode.CONTAINER){var r=e,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=a;o.getScale(_tempScale),o.activeInHierarchy&&(i++,t+=o.height*this._getUsedScaleValue(_tempScale.y))}t+=(i-1)*this._spacingY+this._paddingBottom+this._paddingTop}else t=this.node.getContentSize().height;return t}},{key:"_doLayout",value:function(){if(this._N$layoutType===Type.HORIZONTAL){var e=this._getHorizontalBaseWidth(this.node.children);this._doLayoutHorizontally(e,!1,function(e){return e.getPosition(_tempPos),_tempPos.y},!0),this.node.width=e}else if(this._N$layoutType===Type.VERTICAL){var t=this._getVerticalBaseHeight(this.node.children);this._doLayoutVertically(t,!1,function(e){return e.getPosition(_tempPos),_tempPos.x},!0),this.node.height=t}else this._N$layoutType===Type.NONE?this._resizeMode===ResizeMode.CONTAINER&&this._doLayoutBasic():this._N$layoutType===Type.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_transformDirty",value:function(e){e===exports.SystemEventType.POSITION_PART&&this._doLayoutDirty()}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_doScaleDirty",value:function(){this._layoutDirty=this._layoutDirty||this._affectedByScale}},{key:"type",get:function(){return this._N$layoutType},set:function(e){this._N$layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._N$layoutType===Type.NONE&&e===ResizeMode.CHILDREN||(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this._N$padding=e,this._migratePaddingData(),this._doLayoutDirty()}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),s}(),_class3$n.Type=Type,_class3$n.VerticalDirection=VerticalDirection,_class3$n.HorizontalDirection=HorizontalDirection,_class3$n.ResizeMode=ResizeMode,_class3$n.AxisDirection=AxisDirection,_applyDecoratedDescriptor((_class2$Q=_temp$W).prototype,"type",[_dec4$k],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"type"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"resizeMode",[_dec5$i],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"resizeMode"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"cellSize",[property],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"cellSize"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"startAxis",[_dec6$f],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"startAxis"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"paddingLeft",[property],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"paddingLeft"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"paddingRight",[property],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"paddingRight"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"paddingTop",[property],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"paddingTop"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"paddingBottom",[property],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"paddingBottom"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"spacingX",[property],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"spacingX"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"spacingY",[property],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"spacingY"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"verticalDirection",[_dec7$c],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"verticalDirection"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"horizontalDirection",[_dec8$7],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"horizontalDirection"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"padding",[property],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"padding"),_class2$Q.prototype),_applyDecoratedDescriptor(_class2$Q.prototype,"affectedByScale",[property],Object.getOwnPropertyDescriptor(_class2$Q.prototype,"affectedByScale"),_class2$Q.prototype),_descriptor$N=_applyDecoratedDescriptor(_class2$Q.prototype,"_resizeMode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ResizeMode.NONE}}),_descriptor2$C=_applyDecoratedDescriptor(_class2$Q.prototype,"_N$layoutType",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Type.NONE}}),_descriptor3$r=_applyDecoratedDescriptor(_class2$Q.prototype,"_N$padding",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor4$m=_applyDecoratedDescriptor(_class2$Q.prototype,"_cellSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Size(40,40)}}),_descriptor5$h=_applyDecoratedDescriptor(_class2$Q.prototype,"_startAxis",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AxisDirection.HORIZONTAL}}),_descriptor6$a=_applyDecoratedDescriptor(_class2$Q.prototype,"_paddingLeft",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor7$9=_applyDecoratedDescriptor(_class2$Q.prototype,"_paddingRight",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor8$9=_applyDecoratedDescriptor(_class2$Q.prototype,"_paddingTop",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor9$8=_applyDecoratedDescriptor(_class2$Q.prototype,"_paddingBottom",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor10$7=_applyDecoratedDescriptor(_class2$Q.prototype,"_spacingX",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor11$5=_applyDecoratedDescriptor(_class2$Q.prototype,"_spacingY",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor12$5=_applyDecoratedDescriptor(_class2$Q.prototype,"_verticalDirection",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VerticalDirection.TOP_TO_BOTTOM}}),_descriptor13$5=_applyDecoratedDescriptor(_class2$Q.prototype,"_horizontalDirection",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HorizontalDirection.LEFT_TO_RIGHT}}),_descriptor14$5=_applyDecoratedDescriptor(_class2$Q.prototype,"_affectedByScale",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_class$10=_class2$Q))||_class$10)||_class$10)||_class$10)||_class$10);cc.LayoutComponent=LayoutComponent,function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(LineCap=LineCap||{}),ccenum(LineCap),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(LineJoin=LineJoin||{}),ccenum(LineJoin),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(PointFlags=PointFlags||{}),ccenum(PointFlags);var _dec$10,_dec2$E,_dec3$p,_dec4$m,_dec5$k,_dec6$h,_dec7$d,_class$12,_class2$S,_descriptor$P,_descriptor2$E,_class3$p,_temp$Y,GraphicsComponent=(_dec$$=ccclass("cc.GraphicsComponent"),_dec2$D=executionOrder(110),_dec3$o=menu("UI/Render/Graphics"),_dec4$l=property({type:LineJoin}),_dec5$j=property({type:LineCap}),_dec6$g=property({override:!0,visible:!1}),_dec$$(_class$11=_dec2$D(_class$11=_dec3$o((_temp$X=_class3$o=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this))).impl=null,e.model=null,_initializerDefineProperty(e,"_lineWidth",_descriptor$O,_assertThisInitialized(e)),_initializerDefineProperty(e,"_strokeColor",_descriptor2$D,_assertThisInitialized(e)),_initializerDefineProperty(e,"_lineJoin",_descriptor3$s,_assertThisInitialized(e)),_initializerDefineProperty(e,"_lineCap",_descriptor4$n,_assertThisInitialized(e)),_initializerDefineProperty(e,"_fillColor",_descriptor5$i,_assertThisInitialized(e)),_initializerDefineProperty(e,"_miterLimit",_descriptor6$b,_assertThisInitialized(e)),e._instanceMaterialType=exports.InstanceMaterialType.ADDCOLOR,e}return _inherits(t,UIRenderComponent),_createClass(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color}}]),_createClass(t,[{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"__preload",value:function(){_get(_getPrototypeOf(t.prototype),"__preload",this)&&_get(_getPrototypeOf(t.prototype),"__preload",this).call(this),this.impl=this._assembler&&this._assembler.createImpl(this)}},{key:"onLoad",value:function(){this._sceneGetter=director.root.ui.getRenderSceneGetter()}},{key:"onEnable",value:function(){_get(_getPrototypeOf(t.prototype),"onEnable",this).call(this),this.model&&(this.model.enabled=!0),this._activateMaterial()}},{key:"onDisable",value:function(){this.model&&(this.model.enabled=!1)}},{key:"onDestroy",value:function(){_get(_getPrototypeOf(t.prototype),"onDestroy",this).call(this),this._sceneGetter=null,this.model&&(this._getRenderScene().destroyModel(this.model),this.model=null),this.impl&&(this.impl.clear(),this.impl=null)}},{key:"_activateMaterial",value:function(){this._material&&this._updateMaterial(this._material)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,i,r,n,s){this.impl&&this.impl.bezierCurveTo(e,t,i,r,n,s)}},{key:"quadraticCurveTo",value:function(e,t,i,r){this.impl&&this.impl.quadraticCurveTo(e,t,i,r)}},{key:"arc",value:function(e,t,i,r,n,s){this.impl&&this.impl.arc(e,t,i,r,n,s)}},{key:"ellipse",value:function(e,t,i,r){this.impl&&this.impl.ellipse(e,t,i,r)}},{key:"circle",value:function(e,t,i){this.impl&&this.impl.circle(e,t,i)}},{key:"rect",value:function(e,t,i,r){this.impl&&this.impl.rect(e,t,i,r)}},{key:"roundRect",value:function(e,t,i,r,n){this.impl&&this.impl.roundRect(e,t,i,r,n)}},{key:"fillRect",value:function(e,t,i,r){this.rect(e,t,i,r),this.fill()}},{key:"clear",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.impl&&(this.impl.clear(t),this.model&&(this.model.scene.destroyModel(this.model),this.model=null),this.markForUpdateRenderData())}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler.stroke(this)}},{key:"fill",value:function(){this._assembler.fill(this)}},{key:"helpInstanceMaterial",value:function(){var e=null;this._sharedMaterial?e=Material.getInstantiatedMaterial(this._sharedMaterial,new RenderableComponent,!1):((e=Material.getInstantiatedMaterial(builtinResMgr.get("ui-base-material"),new RenderableComponent,!1)).recompileShaders({USE_LOCAL:!0}),e.onLoaded()),this._updateMaterial(e),this.impl||(this._flushAssembler(),this.impl=this._assembler&&this._assembler.createImpl(this))}},{key:"_render",value:function(e){e.commitModel(this,this.model,this._material)}},{key:"_instanceMaterial",value:function(){this.helpInstanceMaterial()}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!_get(_getPrototypeOf(t.prototype),"_canRender",this).call(this)&&!!this.model}}]),t}(),_class3$o.LineJoin=LineJoin,_class3$o.LineCap=LineCap,_applyDecoratedDescriptor((_class2$R=_temp$X).prototype,"lineJoin",[_dec4$l],Object.getOwnPropertyDescriptor(_class2$R.prototype,"lineJoin"),_class2$R.prototype),_applyDecoratedDescriptor(_class2$R.prototype,"lineCap",[_dec5$j],Object.getOwnPropertyDescriptor(_class2$R.prototype,"lineCap"),_class2$R.prototype),_applyDecoratedDescriptor(_class2$R.prototype,"strokeColor",[property],Object.getOwnPropertyDescriptor(_class2$R.prototype,"strokeColor"),_class2$R.prototype),_applyDecoratedDescriptor(_class2$R.prototype,"fillColor",[property],Object.getOwnPropertyDescriptor(_class2$R.prototype,"fillColor"),_class2$R.prototype),_applyDecoratedDescriptor(_class2$R.prototype,"miterLimit",[property],Object.getOwnPropertyDescriptor(_class2$R.prototype,"miterLimit"),_class2$R.prototype),_applyDecoratedDescriptor(_class2$R.prototype,"color",[_dec6$g],Object.getOwnPropertyDescriptor(_class2$R.prototype,"color"),_class2$R.prototype),_descriptor$O=_applyDecoratedDescriptor(_class2$R.prototype,"_lineWidth",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor2$D=_applyDecoratedDescriptor(_class2$R.prototype,"_strokeColor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.BLACK.clone()}}),_descriptor3$s=_applyDecoratedDescriptor(_class2$R.prototype,"_lineJoin",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LineJoin.MITER}}),_descriptor4$n=_applyDecoratedDescriptor(_class2$R.prototype,"_lineCap",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LineCap.BUTT}}),_descriptor5$i=_applyDecoratedDescriptor(_class2$R.prototype,"_fillColor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.WHITE.clone()}}),_descriptor6$b=_applyDecoratedDescriptor(_class2$R.prototype,"_miterLimit",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),_class$11=_class2$R))||_class$11)||_class$11)||_class$11);cc.GraphicsComponent=GraphicsComponent;var MaskType,_worldMatrix$2=new Mat4,_vec2_temp=new Vec2,_mat4_temp$1=new Mat4,_circlepoints=[];function _calculateCircle(e,t,i){_circlepoints.length=0;for(var r=2*Math.PI/i,n=0;n<i;++n)_circlepoints.push(new Vec3(t.x*Math.cos(r*n)+e.x,t.y*Math.sin(r*n)+e.y,0));return _circlepoints}!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE"}(MaskType=MaskType||{}),ccenum(MaskType);var _dec$11,_dec2$F,_dec3$q,_dec4$n,_dec5$l,_dec6$i,_class$13,_class2$T,_descriptor$Q,_descriptor2$F,_descriptor3$t,_descriptor4$o,_descriptor5$j,_class3$q,_temp$Z,Mode,SEGEMENTS_MIN=3,SEGEMENTS_MAX=1e4,MaskComponent=(_dec$10=ccclass("cc.MaskComponent"),_dec2$E=executionOrder(110),_dec3$p=menu("UI/Render/Mask"),_dec4$m=property({type:MaskType,displayOrder:4}),_dec5$k=property({visible:!1,override:!0}),_dec6$h=property({visible:!1,override:!0}),_dec7$d=property({visible:!1,override:!0}),_dec$10(_class$12=_dec2$E(_class$12=_dec3$p((_temp$Y=_class3$p=function(){function i(){var e;return _classCallCheck(this,i),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this)),"_type",_descriptor$P,_assertThisInitialized(e)),_initializerDefineProperty(e,"_segments",_descriptor2$E,_assertThisInitialized(e)),e._graphics=null,e._clearGraphics=null,e._instanceMaterialType=exports.InstanceMaterialType.ADDCOLOR,e}return _inherits(i,UIRenderComponent),_createClass(i,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._activateMaterial())}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments=clamp(e,SEGEMENTS_MIN,SEGEMENTS_MAX),this._updateGraphics()}},{key:"graphics",get:function(){return this._graphics}},{key:"clearGraphics",get:function(){return this._clearGraphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}}]),_createClass(i,[{key:"onLoad",value:function(){this._createGraphics()}},{key:"onRestore",value:function(){this._createGraphics(),this._updateGraphics()}},{key:"onEnable",value:function(){_get(_getPrototypeOf(i.prototype),"onEnable",this).call(this),this._flushVisibility(),this._clearGraphics&&this._clearGraphics.onEnable(),this._updateGraphics(),this._activateMaterial(),this.node.on(exports.SystemEventType.TRANSFORM_CHANGED,this._nodeStateChange,this),view.on("design-resolution-changed",this._updateClearGraphics,this)}},{key:"onDisable",value:function(){_get(_getPrototypeOf(i.prototype),"onDisable",this).call(this),this._disableGraphics(),this.node.off(exports.SystemEventType.TRANSFORM_CHANGED,this._nodeStateChange),view.off("design-resolution-changed",this._updateClearGraphics)}},{key:"onDestroy",value:function(){_get(_getPrototypeOf(i.prototype),"onDestroy",this).call(this),this._removeGraphics()}},{key:"isHit",value:function(e){var t=this.node,i=t.getContentSize(),r=i.width,n=i.height,s=_vec2_temp;this.node.getWorldMatrix(_worldMatrix$2),Mat4.invert(_mat4_temp$1,_worldMatrix$2),Vec2.transformMat4(s,e,_mat4_temp$1);var a=t.getAnchorPoint();s.x+=a.x*r,s.y+=a.y*n;var o=!1;if(this.type===MaskType.RECT)o=0<=s.x&&0<=s.y&&s.x<=r&&s.y<=n;else if(this.type===MaskType.ELLIPSE){var c=r/2,l=n/2,u=s.x-.5*r,h=s.y-.5*n;o=u*u/(c*c)+h*h/(l*l)<1}return o}},{key:"_resizeNodeToTargetNode",value:function(){}},{key:"_render",value:function(e){e.commitComp(this,null,this._assembler)}},{key:"_postRender",value:function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler)}},{key:"_nodeStateChange",value:function(e){e!==exports.SystemEventType.POSITION_PART&&(_get(_getPrototypeOf(i.prototype),"_nodeStateChange",this).call(this,e),this._updateGraphics())}},{key:"_resolutionChanged",value:function(){this._updateClearGraphics()}},{key:"_canRender",value:function(){return!!_get(_getPrototypeOf(i.prototype),"_canRender",this).call(this)&&(null!==this._clearGraphics&&null!==this._graphics)}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this),t=i.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==t&&(this._postAssembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.sharedMaterial,this.markForUpdateRenderData())}},{key:"_parentChanged",value:function(e){return!!_get(_getPrototypeOf(i.prototype),"_parentChanged",this).call(this,e)&&(this._flushVisibility(),!0)}},{key:"_onTextureLoaded",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderData.vertDirty=!0),this.enabledInHierarchy&&this._activateMaterial()}},{key:"_applySpriteFrame",value:function(e){}},{key:"_createGraphics",value:function(){if(!this._clearGraphics){var e=this._clearGraphics=new GraphicsComponent;e.node=new Node$1("clear-graphics"),e.helpInstanceMaterial(),e._activateMaterial(),e.lineWidth=0;var t=Color.WHITE.clone();t.a=0,e.fillColor=t,e.simulate=!0,this._updateClearGraphics()}if(!this._graphics){var i=this._graphics=new GraphicsComponent;i.node=this.node,i.node.getWorldMatrix(),i.helpInstanceMaterial(),i.lineWidth=0;var r=Color.WHITE.clone();r.a=0,i.fillColor=r}}},{key:"_updateClearGraphics",value:function(){if(this._clearGraphics){var e=visibleRect;this._clearGraphics.node.setWorldPosition(e.width/2,e.height/2,0),this._clearGraphics.clear(),this._clearGraphics.rect(-e.width/2,-e.height/2,e.width,e.height),this._clearGraphics.fill()}}},{key:"_updateGraphics",value:function(){if(this._graphics){var e=this.node,t=this._graphics;t.clear();var i=e.getContentSize(),r=i.width,n=i.height,s=e.getAnchorPoint(),a=-r*s.x,o=-n*s.y;if(this._type===MaskType.RECT)t.rect(a,o,r,n);else if(this._type===MaskType.ELLIPSE){for(var c=_calculateCircle(new Vec3(a+r/2,o+n/2,0),new Vec3(r/2,n/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}}},{key:"_disableGraphics",value:function(){this._graphics&&this._graphics.onDisable(),this._clearGraphics&&this._clearGraphics.onDisable()}},{key:"_removeGraphics",value:function(){this._graphics&&this._graphics.destroy(),this._clearGraphics&&this._clearGraphics.destroy()}},{key:"_flushVisibility",value:function(){this._clearGraphics&&this._clearGraphics._setScreen(this._screen),this._graphics&&this._graphics._setScreen(this._screen)}},{key:"_activateMaterial",value:function(){}}]),i}(),_class3$p.Type=MaskType,_applyDecoratedDescriptor((_class2$S=_temp$Y).prototype,"type",[_dec4$m],Object.getOwnPropertyDescriptor(_class2$S.prototype,"type"),_class2$S.prototype),_applyDecoratedDescriptor(_class2$S.prototype,"segments",[property],Object.getOwnPropertyDescriptor(_class2$S.prototype,"segments"),_class2$S.prototype),_applyDecoratedDescriptor(_class2$S.prototype,"dstBlendFactor",[_dec5$k],Object.getOwnPropertyDescriptor(_class2$S.prototype,"dstBlendFactor"),_class2$S.prototype),_applyDecoratedDescriptor(_class2$S.prototype,"srcBlendFactor",[_dec6$h],Object.getOwnPropertyDescriptor(_class2$S.prototype,"srcBlendFactor"),_class2$S.prototype),_applyDecoratedDescriptor(_class2$S.prototype,"color",[_dec7$d],Object.getOwnPropertyDescriptor(_class2$S.prototype,"color"),_class2$S.prototype),_descriptor$P=_applyDecoratedDescriptor(_class2$S.prototype,"_type",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MaskType.RECT}}),_descriptor2$E=_applyDecoratedDescriptor(_class2$S.prototype,"_segments",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),_class$12=_class2$S))||_class$12)||_class$12)||_class$12);cc.MaskComponent=MaskComponent,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(Mode=Mode||{}),Enum(Mode);var _dec$12,_dec2$G,_dec3$r,_class$14,_class2$U,_descriptor$R,_descriptor2$G,_temp$_,ProgressBarComponent=(_dec$11=ccclass("cc.ProgressBarComponent"),_dec2$F=executionOrder(110),_dec3$q=menu("UI/ProgressBar"),_dec4$n=property({type:SpriteComponent}),_dec5$l=property({type:Mode}),_dec6$i=property({range:[0,1,.1],slide:!0}),_dec$11(_class$13=_dec2$F(_class$13=_dec3$q((_temp$Z=_class3$q=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_barSprite",_descriptor$Q,_assertThisInitialized(t)),_initializerDefineProperty(t,"_mode",_descriptor2$F,_assertThisInitialized(t)),_initializerDefineProperty(t,"_totalLength",_descriptor3$t,_assertThisInitialized(t)),_initializerDefineProperty(t,"_progress",_descriptor4$o,_assertThisInitialized(t)),_initializerDefineProperty(t,"_reverse",_descriptor5$j,_assertThisInitialized(t)),t}return _inherits(s,Component),_createClass(s,[{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node.getContentSize(),i=this.node.getAnchorPoint(),r=e.getContentSize();if(this._barSprite.fillType===SpriteComponent.FillType.RADIAL&&(this._mode=Mode.FILLED),this._mode===Mode.HORIZONTAL?this.totalLength=r.width:this._mode===Mode.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var n=-t.width*i.x;e.setPosition(n,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e.getAnchorPoint(),i=e.getContentSize(),r=e.getPosition(),n=new Vec2(0,.5),s=clamp01(this._progress),a=this._totalLength*s,o=i,c=0,l=0;switch(this._mode){case Mode.HORIZONTAL:this._reverse&&(n=new Vec2(1,.5)),o=new Size(a,i.height),c=this._totalLength,l=i.height;break;case Mode.VERTICAL:n=this._reverse?new Vec2(.5,1):new Vec2(.5,0),o=new Size(i.width,a),c=i.width,l=this._totalLength}if(this._mode===Mode.FILLED)this._barSprite.type!==SpriteComponent.Type.FILLED?warn("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(a*=-1),this._barSprite.fillRange=a);else if(this._barSprite.type!==SpriteComponent.Type.FILLED){var u=n.x-t.x,h=n.y-t.y,_=new Vec3(c*u,l*h,0);e.setPosition(r.x+_.x,r.y+_.y,r.z),e.setAnchorPoint(n),e.setContentSize(o)}else warn("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var i=t.getContentSize();this._mode===Mode.HORIZONTAL?this.totalLength=i.width:this._mode===Mode.VERTICAL?this.totalLength=i.height:this._mode===Mode.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===Mode.FILLED&&(e=clamp01(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),s}(),_class3$q.Mode=Mode,_applyDecoratedDescriptor((_class2$T=_temp$Z).prototype,"barSprite",[_dec4$n],Object.getOwnPropertyDescriptor(_class2$T.prototype,"barSprite"),_class2$T.prototype),_applyDecoratedDescriptor(_class2$T.prototype,"mode",[_dec5$l],Object.getOwnPropertyDescriptor(_class2$T.prototype,"mode"),_class2$T.prototype),_applyDecoratedDescriptor(_class2$T.prototype,"totalLength",[property],Object.getOwnPropertyDescriptor(_class2$T.prototype,"totalLength"),_class2$T.prototype),_applyDecoratedDescriptor(_class2$T.prototype,"progress",[_dec6$i],Object.getOwnPropertyDescriptor(_class2$T.prototype,"progress"),_class2$T.prototype),_applyDecoratedDescriptor(_class2$T.prototype,"reverse",[property],Object.getOwnPropertyDescriptor(_class2$T.prototype,"reverse"),_class2$T.prototype),_descriptor$Q=_applyDecoratedDescriptor(_class2$T.prototype,"_barSprite",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$F=_applyDecoratedDescriptor(_class2$T.prototype,"_mode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mode.HORIZONTAL}}),_descriptor3$t=_applyDecoratedDescriptor(_class2$T.prototype,"_totalLength",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor4$o=_applyDecoratedDescriptor(_class2$T.prototype,"_progress",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_descriptor5$j=_applyDecoratedDescriptor(_class2$T.prototype,"_reverse",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_class$13=_class2$T))||_class$13)||_class$13)||_class$13);cc.ProgressBarComponent=ProgressBarComponent;var _dec$13,_dec2$H,_dec3$s,_dec4$o,_dec5$m,_dec6$j,_dec7$e,_class$15,_class2$V,_descriptor$S,_descriptor2$H,_descriptor3$u,_descriptor4$p,_descriptor5$k,_descriptor6$c,_descriptor7$a,_descriptor8$a,_class3$r,_temp$$,LabelOutlineComponent=(_dec$12=ccclass("cc.LabelOutlineComponent"))(_class$14=(_dec2$G=executionOrder(110))(_class$14=(_dec3$r=menu("UI/Render/LabelOutline"))((_descriptor$R=_applyDecoratedDescriptor((_class2$U=_temp$_=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_color",_descriptor$R,_assertThisInitialized(t)),_initializerDefineProperty(t,"_width",_descriptor2$G,_assertThisInitialized(t)),t}return _inherits(s,Component),_createClass(s,[{key:"_updateRenderData",value:function(){var e=this.node.getComponent(LabelComponent);e&&e.updateRenderData(!0)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),s}()).prototype,"_color",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Color(255,255,255,255)}}),_descriptor2$G=_applyDecoratedDescriptor(_class2$U.prototype,"_width",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_applyDecoratedDescriptor(_class2$U.prototype,"color",[property],Object.getOwnPropertyDescriptor(_class2$U.prototype,"color"),_class2$U.prototype),_applyDecoratedDescriptor(_class2$U.prototype,"width",[property],Object.getOwnPropertyDescriptor(_class2$U.prototype,"width"),_class2$U.prototype),_class$14=_class2$U))||_class$14)||_class$14)||_class$14;cc.LabelOutlineComponent=LabelOutlineComponent;var _htmlTextParser=new HtmlTextParser,RichTextChildName="RICHTEXT_CHILD",RichTextChildImageName="RICHTEXT_Image_CHILD";function debounce(s,a,o){var c;return function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var r=this,n=o&&!c;clearTimeout(c),c=setTimeout(function(){c=null,o||s.apply(r,t)},a),n&&s.apply(r,t)}}var pool$1=new Pool(function(e){return!!cc.isValid(e.node)&&!e.node.getComponent(LabelOutlineComponent)},20);pool$1.get=function(e,t){var i=this._get(),r=(i=i||{node:new PrivateNode(RichTextChildName),comp:null,lineCount:0,styleIndex:0,clickHandler:""}).node,n=(r=r||new PrivateNode(RichTextChildName)).getComponent(LabelComponent);return n=n=n||r.addComponent(LabelComponent),r.setPosition(0,0,0),r.setAnchorPoint(.5,.5),r.setContentSize(128,128),"string"!=typeof e&&(e=""+e),t.font instanceof Font?n.font=t.font:n.fontFamily="Arial",n.string=e,n.horizontalAlign=exports.HorizontalTextAlignment.LEFT,n.verticalAlign=exports.VerticalTextAlignment.TOP,n.fontSize=t.fontSize||40,n.overflow=0,n.enableWrapText=!0,n.lineHeight=40,n.isBold=!1,n.isItalic=!1,n.isUnderline=!1,{node:r,comp:n,lineCount:0,clickHandler:"",styleIndex:0}};var _dec$14,_dec2$I,_dec3$t,_dec4$p,_dec5$n,_class$16,_class2$W,_descriptor$T,_descriptor2$I,_descriptor3$v,_descriptor4$q,_descriptor5$l,_class3$s,_temp$10,RichTextComponent=(_dec$13=ccclass("cc.RichTextComponent"),_dec2$H=executionOrder(110),_dec3$s=menu("UI/Render/RichText"),_dec4$o=property({multiline:!0}),_dec5$m=property({type:exports.HorizontalTextAlignment}),_dec6$j=property({type:TTFFont}),_dec7$e=property({type:SpriteAtlas}),_dec$13(_class$15=_dec2$H(_class$15=_dec3$s(_class$15=executeInEditMode((_temp$$=_class3$r=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"_lineHeight",_descriptor$S,_assertThisInitialized(e)),_initializerDefineProperty(e,"_string",_descriptor2$H,_assertThisInitialized(e)),_initializerDefineProperty(e,"_horizontalAlign",_descriptor3$u,_assertThisInitialized(e)),_initializerDefineProperty(e,"_fontSize",_descriptor4$p,_assertThisInitialized(e)),_initializerDefineProperty(e,"_maxWidth",_descriptor5$k,_assertThisInitialized(e)),_initializerDefineProperty(e,"_font",_descriptor6$c,_assertThisInitialized(e)),_initializerDefineProperty(e,"_imageAtlas",_descriptor7$a,_assertThisInitialized(e)),_initializerDefineProperty(e,"_handleTouchEvent",_descriptor8$a,_assertThisInitialized(e)),e._textArray=[],e._labelSegments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}return _inherits(t,UIComponent),_createClass(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font&&this._onTTFLoaded(),this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),_createClass(t,[{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"start",value:function(){this._onTTFLoaded()}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){var e=this._labelSegments,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;n.node.removeFromParent(),pool$1.put(n)}}},{key:"_addEventListeners",value:function(){this.node.on(Node$1.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off(Node$1.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var t=this;this._labelSegments.forEach(function(e){t._applyTextAttribute(e)})}},{key:"_createFontLabel",value:function(e){return pool$1.get(e,this)}},{key:"_onTTFLoaded",value:function(){if(this._font instanceof TTFFont)if(this._font._nativeAsset)this._layoutDirty=!0,this._updateRichText();else{var i=this;loader.load(this._font.nativeUrl,function(e,t){i._layoutDirty=!0,i._updateRichText()})}else this._layoutDirty=!0,this._updateRichText()}},{key:"_measureText",value:function(i,e){function t(e){var t;return 0===r._labelSegmentsCache.length?(t=r._createFontLabel(e),r._labelSegmentsCache.push(t)):(t=r._labelSegmentsCache[0]).node.getComponent(LabelComponent).string=e,t.styleIndex=i,r._applyTextAttribute(t),t.node.getContentSize().width}var r=this;return e?t(e):t}},{key:"_onTouchEnded",value:function(r){var t=this,n=this.node.getComponents(UIComponent),s=this,e=function(){if(o){if(c>=a.length)return"break";l=a[c++]}else{if((c=a.next()).done)return"break";l=c.value}var e=l,i=e.clickHandler;i&&t._containsTouchLocation(e,r.touch.getUILocation())&&(n.forEach(function(e){var t=e[i];e.enabledInHierarchy&&t&&t.call(s,r)}),r.propagationStopped=!0)},a=this._labelSegments,o=Array.isArray(a),c=0;for(a=o?a:a[Symbol.iterator]();;){var l;if("break"===e())break}}},{key:"_containsTouchLocation",value:function(e,t){var i=e.node.getComponent(UITransformComponent);return!!i&&i.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var r=this,n=this.node.children,e=function(e){var t=n[e];if((t.name===RichTextChildName||t.name===RichTextChildImageName)&&(t.parent===r.node?t.parent=null:n.splice(e,1),t.name===RichTextChildName)){var i=r._labelSegments.findIndex(function(e){return e.node===t});-1!==i&&pool$1.put(r._labelSegments[i])}},t=n.length-1;0<=t;t--)e(t);this._labelSegments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;0<=t;t--){var i=this.node.children[t];i.name!==RichTextChildName&&i.name!==RichTextChildImageName||(i.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{var r=(i=this._labelSegmentsCache.pop()).node.getComponent(LabelComponent);r&&(r.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node.setAnchorPoint(0,0),this._applyTextAttribute(i),this.node.addChild(i.node),this._labelSegments.push(i),i}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,i){var r=t;if(0<this._lineOffsetX&&r+this._lineOffsetX>this.maxWidth)for(var n=0;this._lineOffsetX<=this.maxWidth;){var s=this._getFirstWordLen(e,n,e.length),a=e.substr(n,s),o=this._measureText(i,a);if(!(this._lineOffsetX+o<=this.maxWidth)){if(0<n){var c=e.substr(0,n);this._addLabelSegment(c,i),e=e.substr(n,e.length),r=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=o,n+=s}if(r>this.maxWidth)for(var l=fragmentText(e,r,this.maxWidth,this._measureText(i)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,i).node.getContentSize();this._lineOffsetX+=_.width,1<l.length&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=r,this._addLabelSegment(e,i)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],r=e[t];if(i.text!==r.text)return!0;if(i.style){if(r.style){if(!!r.style.outline!=!!i.style.outline)return!0;if(i.style.size!==r.style.size||i.style.italic!==r.style.italic||i.style.isImage!==r.style.isImage)return!0;if(i.style.isImage===r.style.isImage&&i.style.src!==r.style.src)return!0}else if(i.style.size||i.style.italic||i.style.isImage||i.style.outline)return!0}else if(r.style&&(r.style.size||r.style.italic||r.style.isImage||r.style.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style.src,i=this._imageAtlas&&t&&this._imageAtlas.getSpriteFrame(t);if(i){var r=new PrivateNode(RichTextChildImageName),n=r.addComponent(SpriteComponent);r.setAnchorPoint(0,0),n.type=SpriteComponent.Type.SLICED,n.sizeMode=SpriteComponent.SizeMode.CUSTOM,this.node.addChild(r);var s={node:r,comp:n,lineCount:0,clickHandler:"",styleIndex:0};this._labelSegments.push(s);var a=i.getRect(),o=1,c=a.width,l=a.height,u=e.style.imageWidth,h=e.style.imageHeight;if(void 0!==h&&0<h&&h<this.lineHeight?c*=o=h/l:c*=o=this.lineHeight/l,l*=o,void 0!==u&&0<u&&(c=u),0<this.maxWidth?(this._lineOffsetX+c>this.maxWidth&&this._updateLineInfo(),this._lineOffsetX+=c):(this._lineOffsetX+=c,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),n.spriteFrame=i,r.setContentSize(c,l),s.lineCount=this._lineCount,e.style.event){e.style.event.click&&(s.clickHandler=e.style.event.click)}}else warnID(4400)}}},{key:"_updateRichText",value:function(){if(this.enabled){var e=_htmlTextParser.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,i=!1,r=0;r<this._textArray.length;++r){var n=this._textArray[r],s=n.text;if(void 0!==s){if(""===s){if(n.style&&n.style.isNewLine){this._updateLineInfo();continue}if(n.style&&n.style.isImage&&this.imageAtlas){this._addRichTextImageElement(n);continue}}for(var a=s.split("\n"),o=0;o<a.length;++o){var c=a[o];if(""!==c)if(i=!1,0<this.maxWidth){var l=this._measureText(r,c);this._updateRichTextWithMaxWidth(c,l,r),1<a.length&&o<a.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,r).node.getContentSize(),this._lineOffsetX+=t.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),1<a.length&&o<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(s)&&o===a.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),0<this.maxWidth&&(this._labelWidth=this.maxWidth),this._labelHeight=this._lineCount*this.lineHeight,this.node.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,i){var r=e.charAt(t);if(isUnicodeCJK(r)||isUnicodeSpace(r))return 1;for(var n=1,s=t+1;s<i&&(!isUnicodeSpace(r=e.charAt(s))&&!isUnicodeCJK(r));++s)n++;return n}},{key:"_updateRichTextPosition",value:function(){var e=0,t=1,i=this._lineCount,r=this._labelSegments,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=a,c=o.lineCount;t<c&&(e=0,t=c);var l=0;switch(this.horizontalAlign){case exports.HorizontalTextAlignment.LEFT:l=-this._labelWidth/2;break;case exports.HorizontalTextAlignment.CENTER:l=-this._linesWidth[c-1]/2;break;case exports.HorizontalTextAlignment.RIGHT:l=this._labelWidth/2-this._linesWidth[c-1]}var u=o.node.getContentSize(),h=o.node.getPosition();o.node.setPosition(e+l,this.lineHeight*(i-c)-this._labelHeight/2,h.z),c===t&&(e+=u.width)}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return Color[t]?Color[t]:(new Color).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(LabelComponent);if(t){var i,r=e.styleIndex;t.lineHeight=this.lineHeight,t.horizontalAlign=exports.HorizontalTextAlignment.LEFT,t.verticalAlign=exports.VerticalTextAlignment.CENTER,this._textArray[r]&&(i=this._textArray[r].style);var n=e.node.getComponent(LabelComponent);if(n&&(i&&i.color?n.color=this._convertLiteralColorValue(i.color):n.color=this._convertLiteralColorValue("white")),t.isBold=!(!i||!i.bold),t.isItalic=!(!i||!i.italic),t.isUnderline=!(!i||!i.underline),i&&i.outline){var s=e.node.getComponent(LabelOutlineComponent);(s=s||e.node.addComponent(LabelOutlineComponent)).color=this._convertLiteralColorValue(i.outline.color),s.width=i.outline.width}if(i&&i.size?t.fontSize=i.size:t.fontSize=this._fontSize,t.updateRenderData(!0),i&&i.event){i.event.click&&(e.clickHandler=i.event.click)}}}}]),t}(),_class3$r.HorizontalAlign=exports.HorizontalTextAlignment,_class3$r.VerticalAlign=exports.VerticalTextAlignment,_applyDecoratedDescriptor((_class2$V=_temp$$).prototype,"string",[_dec4$o],Object.getOwnPropertyDescriptor(_class2$V.prototype,"string"),_class2$V.prototype),_applyDecoratedDescriptor(_class2$V.prototype,"horizontalAlign",[_dec5$m],Object.getOwnPropertyDescriptor(_class2$V.prototype,"horizontalAlign"),_class2$V.prototype),_applyDecoratedDescriptor(_class2$V.prototype,"fontSize",[property],Object.getOwnPropertyDescriptor(_class2$V.prototype,"fontSize"),_class2$V.prototype),_applyDecoratedDescriptor(_class2$V.prototype,"font",[_dec6$j],Object.getOwnPropertyDescriptor(_class2$V.prototype,"font"),_class2$V.prototype),_applyDecoratedDescriptor(_class2$V.prototype,"maxWidth",[property],Object.getOwnPropertyDescriptor(_class2$V.prototype,"maxWidth"),_class2$V.prototype),_applyDecoratedDescriptor(_class2$V.prototype,"lineHeight",[property],Object.getOwnPropertyDescriptor(_class2$V.prototype,"lineHeight"),_class2$V.prototype),_applyDecoratedDescriptor(_class2$V.prototype,"imageAtlas",[_dec7$e],Object.getOwnPropertyDescriptor(_class2$V.prototype,"imageAtlas"),_class2$V.prototype),_applyDecoratedDescriptor(_class2$V.prototype,"handleTouchEvent",[property],Object.getOwnPropertyDescriptor(_class2$V.prototype,"handleTouchEvent"),_class2$V.prototype),_descriptor$S=_applyDecoratedDescriptor(_class2$V.prototype,"_lineHeight",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),_descriptor2$H=_applyDecoratedDescriptor(_class2$V.prototype,"_string",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</c><color=#0fffff>Text</color>"}}),_descriptor3$u=_applyDecoratedDescriptor(_class2$V.prototype,"_horizontalAlign",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exports.HorizontalTextAlignment.LEFT}}),_descriptor4$p=_applyDecoratedDescriptor(_class2$V.prototype,"_fontSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),_descriptor5$k=_applyDecoratedDescriptor(_class2$V.prototype,"_maxWidth",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor6$c=_applyDecoratedDescriptor(_class2$V.prototype,"_font",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor7$a=_applyDecoratedDescriptor(_class2$V.prototype,"_imageAtlas",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor8$a=_applyDecoratedDescriptor(_class2$V.prototype,"_handleTouchEvent",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_class$15=_class2$V))||_class$15)||_class$15)||_class$15)||_class$15);cc.RichTextComponent=RichTextComponent;var Direction,GETTINGSHORTERFACTOR=20,ZERO=new Vec3,_tempPos_1=new Vec3,_tempPos_2=new Vec3,defaultAnchor=new Vec2,_tempColor=new Color;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Direction=Direction||{}),ccenum(Direction);var _dec$15,_dec2$J,_class$17,ScrollBarComponent=(_dec$14=ccclass("cc.ScrollBarComponent"),_dec2$I=executionOrder(110),_dec3$t=menu("UI/ScrollBar"),_dec4$p=property({type:SpriteComponent}),_dec5$n=property({type:Direction}),_dec$14(_class$16=_dec2$I(_class$16=_dec3$t((_temp$10=_class3$s=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_scrollView",_descriptor$T,_assertThisInitialized(t)),_initializerDefineProperty(t,"_handle",_descriptor2$I,_assertThisInitialized(t)),_initializerDefineProperty(t,"_direction",_descriptor3$v,_assertThisInitialized(t)),_initializerDefineProperty(t,"_enableAutoHide",_descriptor4$q,_assertThisInitialized(t)),_initializerDefineProperty(t,"_autoHideTime",_descriptor5$l,_assertThisInitialized(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}return _inherits(s,Component),_createClass(s,[{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var i=t.getContentSize(),r=this._scrollView.node.getContentSize(),n=this.node.getContentSize();if(!this._conditionalDisableScrollBar(i,r)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var s=0,a=0,o=0,c=0,l=0;this._direction===Direction.HORIZONTAL?(s=i.width,a=r.width,l=n.width,o=e.x,c=-this._convertToScrollViewSpace(t).x):this._direction===Direction.VERTICAL&&(s=i.height,a=r.height,l=n.height,o=e.y,c=-this._convertToScrollViewSpace(t).y);var u=this._calculateLength(s,a,l,o),h=this._calculatePosition(s,a,l,c,o,u);this._updateLength(u),this._updateHanlderPosition(h)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e.getContentSize(),i=this._scrollView.node.getContentSize();if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(SpriteComponent);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e){if(!this._scrollView)return ZERO;var t=e.getAnchorPoint(),i=e.getContentSize(),r=new Vec3(-t.x*i.width,-t.y*i.height,0);return e.uiTransfromComp.convertToWorldSpaceAR(r,r),t=this._scrollView.node.getAnchorPoint(),i=this._scrollView.node.getContentSize(),r.x+=t.x*i.width,r.y+=t.y*i.height,this._scrollView.node.uiTransfromComp.convertToNodeSpaceAR(r,r),r}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(SpriteComponent);t&&(_tempColor.set(t.color),_tempColor.a=e,t.color=_tempColor),(t=this._handle.getComponent(SpriteComponent))&&(_tempColor.set(t.color),_tempColor.a=e,t.color=_tempColor)}}},{key:"_updateHanlderPosition",value:function(e){if(this._handle){var t=this._fixupHandlerPosition();this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(){var e=this.node.getContentSize(),t=this.node.getAnchorPoint(),i=this.handle.node.getContentSize(),r=this.handle.node.parent;Vec3.set(_tempPos_1,-e.width*t.x,-e.height*t.y,0);var n=this.node.uiTransfromComp.convertToWorldSpaceAR(_tempPos_1,_tempPos_2),s=new Vec3;return r.uiTransfromComp.convertToNodeSpaceAR(n,s),this.direction===Direction.HORIZONTAL?s=new Vec3(s.x,s.y+(e.height-i.height)/2,0):this.direction===Direction.VERTICAL&&(s=new Vec3(s.x+(e.width-i.width)/2,s.y,0)),this.handle.node.setPosition(s),s}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===Direction.HORIZONTAL||e.height<=t.height&&this._direction===Direction.VERTICAL}},{key:"_calculateLength",value:function(e,t,i,r){var n=e;return r&&(n+=(0<r?r:-r)*GETTINGSHORTERFACTOR),i*(t/n)}},{key:"_calculatePosition",value:function(e,t,i,r,n,s){var a=e-t;n&&(a+=Math.abs(n));var o=0;a&&(o=clamp01(o=r/a));var c=(i-s)*o;return this._direction===Direction.VERTICAL?new Vec3(0,c,0):new Vec3(c,0,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node,i=t.getContentSize(),r=t.getAnchorPoint();r.x===defaultAnchor.x&&r.y===defaultAnchor.y||t.setAnchorPoint(defaultAnchor),this._direction===Direction.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(new Vec3(0,0,0)))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(new Vec3))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),s}(),_class3$s.Direction=Direction,_applyDecoratedDescriptor((_class2$W=_temp$10).prototype,"handle",[_dec4$p],Object.getOwnPropertyDescriptor(_class2$W.prototype,"handle"),_class2$W.prototype),_applyDecoratedDescriptor(_class2$W.prototype,"direction",[_dec5$n],Object.getOwnPropertyDescriptor(_class2$W.prototype,"direction"),_class2$W.prototype),_applyDecoratedDescriptor(_class2$W.prototype,"enableAutoHide",[property],Object.getOwnPropertyDescriptor(_class2$W.prototype,"enableAutoHide"),_class2$W.prototype),_applyDecoratedDescriptor(_class2$W.prototype,"autoHideTime",[property],Object.getOwnPropertyDescriptor(_class2$W.prototype,"autoHideTime"),_class2$W.prototype),_descriptor$T=_applyDecoratedDescriptor(_class2$W.prototype,"_scrollView",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$I=_applyDecoratedDescriptor(_class2$W.prototype,"_handle",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor3$v=_applyDecoratedDescriptor(_class2$W.prototype,"_direction",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Direction.HORIZONTAL}}),_descriptor4$q=_applyDecoratedDescriptor(_class2$W.prototype,"_enableAutoHide",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor5$l=_applyDecoratedDescriptor(_class2$W.prototype,"_autoHideTime",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_class$16=_class2$W))||_class$16)||_class$16)||_class$16);cc.ScrollBarComponent=ScrollBarComponent;var _dec$16,_dec2$K,_dec3$u,_dec4$q,_dec5$o,_dec6$k,_dec7$f,_dec8$8,_dec9$7,_class$18,_class2$X,_descriptor$U,_descriptor2$J,_descriptor3$w,_descriptor4$r,_descriptor5$m,_descriptor6$d,_descriptor7$b,_descriptor8$b,_descriptor9$9,_descriptor10$8,_descriptor11$6,_class3$t,_temp$11,ViewGroupComponent=(_dec$15=ccclass("cc.ViewGroupComponent"))(_class$17=(_dec2$J=executionOrder(110))(_class$17=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,Component),e}())||_class$17)||_class$17;cc.ViewGroupComponent=ViewGroupComponent;var ScrollViewEventType,NUMBER_OF_GATHERED_TOUCHES_FOR_MOVE_SPEED=5,OUT_OF_BOUNDARY_BREAKING_FACTOR=.05,EPSILON$3=1e-4,MOVEMENT_FACTOR=.7,ZERO$1=new Vec3,_tempPos$1=new Vec3,_tempVec2=new Vec2,_tempVec2_1=new Vec2,quintEaseOut=function(e){return(e-=1)*e*e*e*e+1},getTimeInMilliseconds=function(){return(new Date).getMilliseconds()};!function(e){e[e.SCROLL_TO_TOP=0]="SCROLL_TO_TOP",e[e.SCROLL_TO_BOTTOM=1]="SCROLL_TO_BOTTOM",e[e.SCROLL_TO_LEFT=2]="SCROLL_TO_LEFT",e[e.SCROLL_TO_RIGHT=3]="SCROLL_TO_RIGHT",e[e.SCROLLING=4]="SCROLLING",e[e.BOUNCE_TOP=5]="BOUNCE_TOP",e[e.BOUNCE_BOTTOM=6]="BOUNCE_BOTTOM",e[e.BOUNCE_LEFT=7]="BOUNCE_LEFT",e[e.BOUNCE_RIGHT=8]="BOUNCE_RIGHT",e[e.SCROLL_ENDED=9]="SCROLL_ENDED",e[e.TOUCH_UP=10]="TOUCH_UP",e[e.AUTOSCROLL_ENDED_WITH_THRESHOLD=11]="AUTOSCROLL_ENDED_WITH_THRESHOLD",e[e.SCROLL_BEGAN=12]="SCROLL_BEGAN"}(ScrollViewEventType=ScrollViewEventType||{}),ccenum(ScrollViewEventType);var _dec$17,_dec2$L,_dec3$v,_dec4$r,_dec5$p,_dec6$l,_dec7$g,_class$19,_class2$Y,_descriptor$V,_descriptor2$K,_descriptor3$x,_descriptor4$s,_class3$u,_temp$12,eventMap={"scroll-to-top":ScrollViewEventType.SCROLL_TO_TOP,"scroll-to-bottom":ScrollViewEventType.SCROLL_TO_BOTTOM,"scroll-to-left":ScrollViewEventType.SCROLL_TO_LEFT,"scroll-to-right":ScrollViewEventType.SCROLL_TO_RIGHT,scrolling:ScrollViewEventType.SCROLLING,"bounce-bottom":ScrollViewEventType.BOUNCE_BOTTOM,"bounce-left":ScrollViewEventType.BOUNCE_LEFT,"bounce-right":ScrollViewEventType.BOUNCE_RIGHT,"bounce-top":ScrollViewEventType.BOUNCE_TOP,"scroll-ended":ScrollViewEventType.SCROLL_ENDED,"touch-up":ScrollViewEventType.TOUCH_UP,"scroll-ended-with-threshold":ScrollViewEventType.AUTOSCROLL_ENDED_WITH_THRESHOLD,"scroll-began":ScrollViewEventType.SCROLL_BEGAN},ScrollViewComponent=(_dec$16=ccclass("cc.ScrollViewComponent"),_dec2$K=executionOrder(110),_dec3$u=menu("UI/ScrollView"),_dec4$q=property({type:Node$1}),_dec5$o=property({type:ScrollBarComponent}),_dec6$k=property({type:ScrollBarComponent}),_dec7$f=property({range:[0,1,.1]}),_dec8$8=property({range:[0,10]}),_dec9$7=property({type:[EventHandler]}),_dec$16(_class$18=_dec2$K(_class$18=_dec3$u((_temp$11=_class3$t=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"horizontal",_descriptor$U,_assertThisInitialized(t)),_initializerDefineProperty(t,"vertical",_descriptor2$J,_assertThisInitialized(t)),_initializerDefineProperty(t,"inertia",_descriptor3$w,_assertThisInitialized(t)),_initializerDefineProperty(t,"brake",_descriptor4$r,_assertThisInitialized(t)),_initializerDefineProperty(t,"elastic",_descriptor5$m,_assertThisInitialized(t)),_initializerDefineProperty(t,"bounceDuration",_descriptor6$d,_assertThisInitialized(t)),_initializerDefineProperty(t,"scrollEvents",_descriptor7$b,_assertThisInitialized(t)),_initializerDefineProperty(t,"cancelInnerEvents",_descriptor8$b,_assertThisInitialized(t)),t._autoScrolling=!1,t._scrolling=!1,_initializerDefineProperty(t,"_content",_descriptor9$9,_assertThisInitialized(t)),_initializerDefineProperty(t,"_horizontalScrollBar",_descriptor10$8,_assertThisInitialized(t)),_initializerDefineProperty(t,"_verticalScrollBar",_descriptor11$6,_assertThisInitialized(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new Vec3,t._autoScrollTargetDelta=new Vec3,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new Vec3,t._outOfBoundaryAmount=new Vec3,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new Vec3,t._deltaPos=new Vec3,t}return _inherits(s,ViewGroupComponent),_createClass(s,[{key:"scrollToBottom",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Vec2(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}},{key:"scrollToTop",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Vec2(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Vec2(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Vec2(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Vec2(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Vec2(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Vec2(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Vec2(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToOffset",value:function(e,t,i){var r=this.getMaxScrollOffset(),n=new Vec2(0,0);0===r.x?n.x=0:n.x=e.x/r.x,0===r.y?n.y=1:n.y=(r.y-e.y)/r.y,this.scrollTo(n,t,i)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Vec3(t,e,0)}},{key:"getMaxScrollOffset",value:function(){var e=this.node.getContentSize(),t=this._content.getContentSize(),i=t.width-e.width,r=t.height-e.height;return new Vec3(i=0<=i?i:0,r=0<=r?r:0,0)}},{key:"scrollToPercentHorizontal",value:function(e,t,i){var r=this._calculateMovePercentDelta({anchor:new Vec2(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(r,t,!1!==i):this._moveContent(r)}},{key:"scrollTo",value:function(e,t,i){var r=this._calculateMovePercentDelta({anchor:new Vec2(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(r,t,i):this._moveContent(r)}},{key:"scrollToPercentVertical",value:function(e,t,i){var r=this._calculateMovePercentDelta({anchor:new Vec2(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(r,t,i):this._moveContent(r)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){e.equals(this.getContentPosition(),EPSILON$3)||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},{key:"getContentPosition",value:function(){return this._content?(this._content.getPosition(this._contentPos),this._contentPos):ZERO$1}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return EPSILON$3}},{key:"start",value:function(){this._calculateBoundary(),this._content&&director.once(Director.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this.content&&(this.content.on(Node$1.EventType.SIZE_CHANGED,this._calculateBoundary,this),this.content.on(Node$1.EventType.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.on(Node$1.EventType.POSITION_PART,this._calculateBoundary,this),this.view.on(Node$1.EventType.SCALE_PART,this._calculateBoundary,this),this.view.on(Node$1.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._showScrollbar()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this.content&&(this.content.off(Node$1.EventType.SIZE_CHANGED,this._calculateBoundary,this),this.content.off(Node$1.EventType.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.off(Node$1.EventType.POSITION_PART,this._calculateBoundary,this),this.view.off(Node$1.EventType.SCALE_PART,this._calculateBoundary,this),this.view.off(Node$1.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollbar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on(Node$1.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(Node$1.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(Node$1.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(Node$1.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(Node$1.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_unregisterEvent",value:function(){this.node.off(Node$1.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(Node$1.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(Node$1.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(Node$1.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(Node$1.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var i=new Vec3;this.vertical?i=new Vec3(0,-.1*e.getScrollY(),0):this.horizontal&&(i=new Vec3(-.1*e.getScrollY(),0,0)),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._content&&this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var i=e.touch;if(this._content&&this._handleMoveLogic(i),this.cancelInnerEvents){var r=i.getUILocation(_tempVec2);if(r.subtract(i.getUIStartLocation(_tempVec2_1)),7<r.length()&&!this._touchMoved&&e.target!==this.node){var n=new EventTouch(e.getTouches(),e.bubbles);n.type=Node$1.EventType.TOUCH_CANCEL,n.touch=e.touch,n.simulate=!0,e.target.dispatchEvent(n),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent("touch-up");var i=e.touch;this._content&&this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var i=e.touch;this._content&&this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this.content){var e=this.content.getComponent(LayoutComponent);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view.getContentSize(),i=t.width*this.view.anchorX,r=t.height*this.view.anchorY;this._leftBoundary=-i,this._bottomBoundary=-r,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(e&&e.eventPhase===Event.CAPTURING_PHASE){if(t){var i=t,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;if(this.node===a)return!(!e.target||!e.target.getComponent(ViewGroupComponent));if(a.getComponent(ViewGroupComponent))return!0}}return!1}}},{key:"_handleReleaseLogic",value:function(e){var t=e.getUIDelta();Vec3.set(this._deltaPos,t.x,t.y,0),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_startInertiaScroll",value:function(e){var t=new Vec3(e);t.multiplyScalar(MOVEMENT_FACTOR),this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var i=this._calculateAutoScrollTimeByInitalSpeed(t.length()),r=new Vec3(e);r.normalize();var n=this._content.getContentSize(),s=this.node.getContentSize(),a=n.width-s.width,o=n.height-s.height,c=this._calculateAttenuatedFactor(a),l=this._calculateAttenuatedFactor(o);r.x=r.x*a*(1-this.brake)*c,r.y=r.y*o*l*(1-this.brake),r.z=0;var u=e.length(),h=r.length()/u;if(r.add(e),0<this.brake&&7<h){h=Math.sqrt(h);var _=new Vec3(e);_.multiplyScalar(h),r.set(_),r.add(e)}0<this.brake&&3<h&&(i*=h=3),0===this.brake&&1<h&&(i*=h),this._startAutoScroll(r,i,!0)}},{key:"_calculateAutoScrollTimeByInitalSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t,i){var r=2<arguments.length&&void 0!==i&&i,n=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=r,Vec3.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new Vec3,this._getHowMuchOutOfBoundary().equals(ZERO$1,EPSILON$3)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=0;if((e=this._touchMoveTimeDeltas.reduce(function(e,t){return e+t},e))<=0||.5<=e)return new Vec3;var t=new Vec3;return t=this._touchMoveDisplacements.reduce(function(e,t){return e.add(t),e},t),new Vec3(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,0)}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var i=this._flattenVectorByDirection(e);_tempPos$1.set(this.getContentPosition()),_tempPos$1.add(i),this.setContentPosition(_tempPos$1);var r=this._getHowMuchOutOfBoundary();this._updateScrollBar(r),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){return this.getContentPosition().x-this._content.getAnchorPoint().x*this._content.getContentSize().width}},{key:"_getContentRightBoundary",value:function(){var e=this._content.getContentSize();return this._getContentLeftBoundary()+e.width}},{key:"_getContentTopBoundary",value:function(){var e=this._content.getContentSize();return this._getContentBottomBoundary()+e.height}},{key:"_getContentBottomBoundary",value:function(){return this.getContentPosition().y-this._content.getAnchorPoint().y*this._content.getContentSize().height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new Vec3).equals(ZERO$1,EPSILON$3)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Vec3;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals(ZERO$1,EPSILON$3)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),t=this._clampDelta(t)}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if("scroll-ended"===e)this._scrollEventEmitMask=0;else if("scroll-to-top"===e||"scroll-to-bottom"===e||"scroll-to-left"===e||"scroll-to-right"===e){var t=1<<eventMap[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}EventHandler.emitEvents(this.scrollEvents,this,eventMap[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();_tempPos$1.set(this.getContentPosition()),_tempPos$1.add(e),this._content&&(this._content.setPosition(_tempPos$1),this._updateScrollBar(ZERO$1))}}},{key:"_hideScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this.verticalScrollBar&&this.verticalScrollBar.hide()}},{key:"_showScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.show(),this.verticalScrollBar&&this.verticalScrollBar.show()}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e.eventPhase===Event.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){var t=e.getUIDelta();Vec3.set(this._deltaPos,t.x,t.y,0),this._processDeltaMove(this._deltaPos)}},{key:"_scrollChildren",value:function(e){var t,i=e=this._clampDelta(e);this.elastic&&(t=this._getHowMuchOutOfBoundary(),i.x*=0===t.x?1:.5,i.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(i),i.add(t));var r="",n=new Vec3;if(this._content.getPosition(n),0<i.y)n.y-this._content.anchorY*this._content.height+i.y>this._bottomBoundary&&(r="scroll-to-bottom");else if(i.y<0){n.y-this._content.anchorY*this._content.height+this._content.height+i.y<=this._topBoundary&&(r="scroll-to-top")}else if(i.x<0){n.x-this._content.anchorX*this._content.width+this._content.width+i.x<=this._rightBoundary&&(r="scroll-to-right")}else if(0<i.x){n.x-this._content.anchorX*this._content.width+i.x>=this._leftBoundary&&(r="scroll-to-left")}this._moveContent(i,!1),0===i.x&&0===i.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent("scroll-began")),this._dispatchEvent("scrolling")),0<r.length&&this._dispatchEvent(r)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent("scroll-ended"),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=getTimeInMilliseconds(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){var t=this._content.getContentSize(),i=this.node.getContentSize();return t.width<i.width&&(e.x=0),t.height<i.height&&(e.y=0),e}},{key:"_gatherTouchMove",value:function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=NUMBER_OF_GATHERED_TOUCHES_FOR_MOVE_SPEED;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var i=getTimeInMilliseconds();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if((e=this._clampDelta(e)).equals(ZERO$1,EPSILON$3))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(0<e.y&&this._dispatchEvent("bounce-top"),e.y<0&&this._dispatchEvent("bounce-bottom"),0<e.x&&this._dispatchEvent("bounce-right"),e.x<0&&this._dispatchEvent("bounce-left"),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(_tempPos$1,EPSILON$3)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().equals(ZERO$1,EPSILON$3)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?OUT_OF_BOUNDARY_BREAKING_FACTOR:1;this._autoScrollAccumulatedTime+=e*(1/i);var r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(r=quintEaseOut(r));var n=new Vec3(this._autoScrollTargetDelta);n.multiplyScalar(r);var s=new Vec3(this._autoScrollStartPosition);s.add(n);var a=Math.abs(r-1)<=EPSILON$3;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent("scroll-ended-with-threshold"),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var o=new Vec3(s);o.subtract(this._autoScrollBrakingStartPosition),t&&o.multiplyScalar(i),s.set(this._autoScrollBrakingStartPosition),s.add(o)}else{var c=new Vec3(s);c.subtract(this.getContentPosition());var l=this._getHowMuchOutOfBoundary(c);l.equals(ZERO$1,EPSILON$3)||(s.add(l),a=!0)}a&&(this._autoScrolling=!1);var u=new Vec3(s);u.subtract(this.getContentPosition()),this._moveContent(this._clampDelta(u),a),this._dispatchEvent("scrolling"),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent("scroll-ended"))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().equals(ZERO$1,EPSILON$3))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,.1<this._mouseWheelEventElapsedTime&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,i=e.applyToHorizontal,r=e.applyToVertical;this._calculateBoundary(),t.clampf(new Vec2(0,0),new Vec2(1,1));var n=this.node.getContentSize(),s=this._content.getContentSize(),a=this._getContentBottomBoundary()-this._bottomBoundary;a=-a;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var c=new Vec3,l=0;return i&&(l=s.width-n.width,c.x=o-l*t.x),r&&(l=s.height-n.height,c.y=a-l*t.y),c}},{key:"_moveContentToTopLeft",value:function(e){var t=this._content.getContentSize(),i=this._getContentBottomBoundary()-this._bottomBoundary;i=-i;var r=new Vec3,n=0,s=this._getContentLeftBoundary()-this._leftBoundary;s=-s,t.height<e.height?(n=t.height-e.height,r.y=i-n,this.verticalScrollBar&&this.verticalScrollBar.hide()):this.verticalScrollBar&&this.verticalScrollBar.show(),t.width<e.width?(n=t.width-e.width,r.x=s,this._horizontalScrollBar&&this._horizontalScrollBar.hide()):this._horizontalScrollBar&&this._horizontalScrollBar.show(),this._moveContent(r),this._adjustContentOutOfBoundary()}},{key:"content",get:function(){return this._content},set:function(e){this._content!==e&&(this._content=e,this._calculateBoundary())}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(ZERO$1)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(ZERO$1)))}},{key:"view",get:function(){return this._content?this._content.parent:null}}]),s}(),_class3$t.EventType=ScrollViewEventType,_applyDecoratedDescriptor((_class2$X=_temp$11).prototype,"content",[_dec4$q],Object.getOwnPropertyDescriptor(_class2$X.prototype,"content"),_class2$X.prototype),_applyDecoratedDescriptor(_class2$X.prototype,"horizontalScrollBar",[_dec5$o],Object.getOwnPropertyDescriptor(_class2$X.prototype,"horizontalScrollBar"),_class2$X.prototype),_applyDecoratedDescriptor(_class2$X.prototype,"verticalScrollBar",[_dec6$k],Object.getOwnPropertyDescriptor(_class2$X.prototype,"verticalScrollBar"),_class2$X.prototype),_descriptor$U=_applyDecoratedDescriptor(_class2$X.prototype,"horizontal",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor2$J=_applyDecoratedDescriptor(_class2$X.prototype,"vertical",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor3$w=_applyDecoratedDescriptor(_class2$X.prototype,"inertia",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor4$r=_applyDecoratedDescriptor(_class2$X.prototype,"brake",[_dec7$f],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),_descriptor5$m=_applyDecoratedDescriptor(_class2$X.prototype,"elastic",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor6$d=_applyDecoratedDescriptor(_class2$X.prototype,"bounceDuration",[_dec8$8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor7$b=_applyDecoratedDescriptor(_class2$X.prototype,"scrollEvents",[_dec9$7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor8$b=_applyDecoratedDescriptor(_class2$X.prototype,"cancelInnerEvents",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor9$9=_applyDecoratedDescriptor(_class2$X.prototype,"_content",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor10$8=_applyDecoratedDescriptor(_class2$X.prototype,"_horizontalScrollBar",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor11$6=_applyDecoratedDescriptor(_class2$X.prototype,"_verticalScrollBar",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$18=_class2$X))||_class$18)||_class$18)||_class$18);cc.ScrollViewComponent=ScrollViewComponent;var Direction$1,_tempPos$2=new Vec3;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Direction$1=Direction$1||{}),ccenum(Direction$1);var _dec$18,_dec2$M,_dec3$w,_dec4$s,_class$1a,_class2$Z,_descriptor$W,_descriptor2$L,_temp$13,SliderComponent=(_dec$17=ccclass("cc.SliderComponent"),_dec2$L=executionOrder(110),_dec3$v=menu("UI/Slider"),_dec4$r=property({type:SpriteComponent}),_dec5$p=property({type:Direction$1}),_dec6$l=property({slide:!0,range:[0,1,.01]}),_dec7$g=property({type:EventHandler}),_dec$17(_class$19=_dec2$L(_class$19=_dec3$v((_temp$12=_class3$u=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"slideEvents",_descriptor$V,_assertThisInitialized(t)),_initializerDefineProperty(t,"_handle",_descriptor2$K,_assertThisInitialized(t)),_initializerDefineProperty(t,"_direction",_descriptor3$x,_assertThisInitialized(t)),_initializerDefineProperty(t,"_progress",_descriptor4$s,_assertThisInitialized(t)),t._offset=new Vec3,t._dragging=!1,t._touchHandle=!1,t._handlelocalPos=new Vec3,t._touchPos=new Vec3,t}return _inherits(s,Component),_createClass(s,[{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(exports.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.on(exports.SystemEventType.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(exports.SystemEventType.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(exports.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off(exports.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.off(exports.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.off(exports.SystemEventType.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(exports.SystemEventType.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(exports.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(exports.SystemEventType.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node.uiTransfromComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Vec3.set(this._touchPos,t.x,t.y,0),this._handle.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new Vec3,e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){EventHandler.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();Vec3.set(this._touchPos,t.x,t.y,0);var i=this.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,_tempPos$2);this.direction===Direction$1.Horizontal?this.progress=clamp01(.5+(i.x-this._offset.x)/this.node.width):this.progress=clamp01(.5+(i.y-this._offset.y)/this.node.height)}}},{key:"_updateHandlePosition",value:function(){this._handle&&(this._handlelocalPos.set(this._handle.node.getPosition()),this._direction===Direction$1.Horizontal?this._handlelocalPos.x=-this.node.width*this.node.anchorX+this.progress*this.node.width:this._handlelocalPos.y=-this.node.height*this.node.anchorY+this.progress*this.node.height,this._handle.node.setPosition(this._handlelocalPos))}},{key:"_changeLayout",value:function(){var e=this.node.getContentSize();if(this.node.setContentSize(e.height,e.width),this._handle){var t=this._handle.node.position;this._direction===Direction$1.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),s}(),_class3$u.Direction=Direction$1,_applyDecoratedDescriptor((_class2$Y=_temp$12).prototype,"handle",[_dec4$r],Object.getOwnPropertyDescriptor(_class2$Y.prototype,"handle"),_class2$Y.prototype),_applyDecoratedDescriptor(_class2$Y.prototype,"direction",[_dec5$p],Object.getOwnPropertyDescriptor(_class2$Y.prototype,"direction"),_class2$Y.prototype),_applyDecoratedDescriptor(_class2$Y.prototype,"progress",[_dec6$l],Object.getOwnPropertyDescriptor(_class2$Y.prototype,"progress"),_class2$Y.prototype),_descriptor$V=_applyDecoratedDescriptor(_class2$Y.prototype,"slideEvents",[_dec7$g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor2$K=_applyDecoratedDescriptor(_class2$Y.prototype,"_handle",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor3$x=_applyDecoratedDescriptor(_class2$Y.prototype,"_direction",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Direction$1.Horizontal}}),_descriptor4$s=_applyDecoratedDescriptor(_class2$Y.prototype,"_progress",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_class$19=_class2$Y))||_class$19)||_class$19)||_class$19);cc.SliderComponent=SliderComponent;var _dec$19,_dec2$N,_dec3$x,_dec4$t,_dec5$q,_dec6$m,_class$1b,_class2$_,_descriptor$X,_descriptor2$M,_descriptor3$y,_descriptor4$t,_temp$14,ToggleContainerComponent=(_dec$18=ccclass("cc.ToggleContainerComponent"),_dec2$M=executionOrder(110),_dec3$w=menu("UI/ToggleContainer"),_dec4$s=property({type:[EventHandler]}),_dec$18(_class$1a=_dec2$M(_class$1a=_dec3$w(_class$1a=executeInEditMode((_descriptor$W=_applyDecoratedDescriptor((_class2$Z=_temp$13=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"checkEvents",_descriptor$W,_assertThisInitialized(t)),_initializerDefineProperty(t,"_allowSwitchOff",_descriptor2$L,_assertThisInitialized(t)),t._toggleItems=[],t}return _inherits(s,Component),_createClass(s,[{key:"start",value:function(){this._makeAtLeastOneToggleChecked()}},{key:"updateToggles",value:function(t){this.enabledInHierarchy&&t.isChecked&&(this.toggleItems.forEach(function(e){e!==t&&e.isChecked&&e.enabled&&(e.isChecked=!1)}),this.checkEvents&&EventHandler.emitEvents(this.checkEvents,t))}},{key:"addToggle",value:function(e){-1===this._toggleItems.indexOf(e)&&this._toggleItems.push(e),this._allowOnlyOneToggleChecked()}},{key:"removeToggle",value:function(e){var t=this._toggleItems.indexOf(e);-1<t&&this._toggleItems.splice(t,1),this._makeAtLeastOneToggleChecked()}},{key:"_allowOnlyOneToggleChecked",value:function(){var t=!1;return this._toggleItems.forEach(function(e){t&&e.enabled&&(e.isChecked=!1),e.isChecked&&e.enabled&&(t=!0)}),t}},{key:"_makeAtLeastOneToggleChecked",value:function(){this._allowOnlyOneToggleChecked()||this._allowSwitchOff||0<this._toggleItems.length&&(this._toggleItems[0].isChecked=!0)}},{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this._toggleItems}}]),s}()).prototype,"checkEvents",[_dec4$s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor2$L=_applyDecoratedDescriptor(_class2$Z.prototype,"_allowSwitchOff",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_applyDecoratedDescriptor(_class2$Z.prototype,"allowSwitchOff",[property],Object.getOwnPropertyDescriptor(_class2$Z.prototype,"allowSwitchOff"),_class2$Z.prototype),_class$1a=_class2$Z))||_class$1a)||_class$1a)||_class$1a)||_class$1a);cc.ToggleContainerComponent=ToggleContainerComponent;var _dec$1a,_dec2$O,_dec3$y,_class$1c,_temp$15,ToggleComponent=(_dec$19=ccclass("cc.ToggleComponent"),_dec2$N=executionOrder(110),_dec3$x=menu("UI/Toggle"),_dec4$t=property({type:ToggleContainerComponent}),_dec5$q=property({type:SpriteComponent}),_dec6$m=property({type:[EventHandler]}),_dec$19(_class$1b=_dec2$N(_class$1b=_dec3$x((_applyDecoratedDescriptor((_class2$_=_temp$14=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"checkEvents",_descriptor$X,_assertThisInitialized(t)),_initializerDefineProperty(t,"_isChecked",_descriptor2$M,_assertThisInitialized(t)),_initializerDefineProperty(t,"_toggleGroup",_descriptor3$y,_assertThisInitialized(t)),_initializerDefineProperty(t,"_checkMark",_descriptor4$t,_assertThisInitialized(t)),t}return _inherits(s,ButtonComponent),_createClass(s,[{key:"onEnable",value:function(){_get(_getPrototypeOf(s.prototype),"onEnable",this).call(this),this._registerToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this)}},{key:"onDisable",value:function(){_get(_getPrototypeOf(s.prototype),"onDisable",this).call(this),this._unregisterToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.removeToggle(this)}},{key:"toggle",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!this.isChecked,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"check",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!0,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"uncheck",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!1,this._emitToggleEvents())}},{key:"_updateCheckMark",value:function(){this._checkMark&&(this._checkMark.node.active=!!this.isChecked)}},{key:"_registerToggleEvent",value:function(){this.node.on("click",this.toggle,this)}},{key:"_unregisterToggleEvent",value:function(){this.node.off("click",this.toggle,this)}},{key:"_emitToggleEvents",value:function(){this.node.emit("toggle",this),this.checkEvents&&EventHandler.emitEvents(this.checkEvents,this)}},{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._isChecked!==e&&(this._isChecked=e,this._updateCheckMark())}},{key:"toggleGroup",get:function(){return this._toggleGroup},set:function(e){this._toggleGroup!==e&&(this._toggleGroup&&this._toggleGroup.removeToggle(this),this._toggleGroup=e,this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this))}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){this.node.parent;return null}}]),s}()).prototype,"isChecked",[property],Object.getOwnPropertyDescriptor(_class2$_.prototype,"isChecked"),_class2$_.prototype),_applyDecoratedDescriptor(_class2$_.prototype,"toggleGroup",[_dec4$t],Object.getOwnPropertyDescriptor(_class2$_.prototype,"toggleGroup"),_class2$_.prototype),_applyDecoratedDescriptor(_class2$_.prototype,"checkMark",[_dec5$q],Object.getOwnPropertyDescriptor(_class2$_.prototype,"checkMark"),_class2$_.prototype),_descriptor$X=_applyDecoratedDescriptor(_class2$_.prototype,"checkEvents",[_dec6$m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor2$M=_applyDecoratedDescriptor(_class2$_.prototype,"_isChecked",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor3$y=_applyDecoratedDescriptor(_class2$_.prototype,"_toggleGroup",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor4$t=_applyDecoratedDescriptor(_class2$_.prototype,"_checkMark",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$1b=_class2$_))||_class$1b)||_class$1b)||_class$1b);cc.ToggleComponent=ToggleComponent;var _dec$1b,_class$1d,_class2$$,_temp$16,UIModelComponent=(_dec$1a=ccclass("cc.UIModelComponent"))(_class$1c=(_dec2$O=executionOrder(110))(_class$1c=(_dec3$y=menu("UI/Model"))(_class$1c=_temp$15=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._models=null,t._modelComponent=null,t}return _inherits(s,UIComponent),_createClass(s,[{key:"onLoad",value:function(){this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?(this._modelComponent._sceneGetter=director.root.ui.getRenderSceneGetter(),this._modelComponent._changeSceneInModel(),this._models=this._modelComponent._collectModels()):console.warn("node '".concat(this.node&&this.node.name,"' doesn't have any renderable component"))}},{key:"onDestroy",value:function(){this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,cc.isValid(this.node,!0)&&this._modelComponent._changeSceneInModel(),this._models=null)}},{key:"updateAssembler",value:function(e){if(this._models){var t=this._models,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n;e.commitModel.call(e,this,s,this._modelComponent.material)}return!0}return!1}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent){for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterial(t);if(null!=i){for(var r=i.passes,n=i.effectAsset,s=i.technique,a=r.length,o=!1,c=0;c<a;c++){if(!r[c].blendState.targets[0].blend)o=!0,r[c].blendState.targets[0].blend=!0,r[c].overridePipelineStates(n.techniques[s].passes[c],{blendState:r[c].blendState})}o&&i._onPassesChange()}}for(var l=0;l<e;l++){var u=this._modelComponent.getMaterial(l);if(null!=u){var h=u.passes,_=Array.isArray(h),p=0;for(h=_?h:h[Symbol.iterator]();;){var d;if(_){if(p>=h.length)break;d=h[p++]}else{if((p=h.next()).done)break;d=p.value}d._priority=RenderPriority.MAX-11}}}}}},{key:"modelComponent",get:function(){return this._modelComponent}}]),s}())||_class$1c)||_class$1c)||_class$1c;cc.UIModelComponent=UIModelComponent;var WebViewEventType,_mat4_temp$2=new Mat4;!function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.ERROR=2]="ERROR",e[e.JS_EVALUATED=3]="JS_EVALUATED"}(WebViewEventType=WebViewEventType||{});var polyfill$1={devicePixelRatio:!1,enableDiv:!1};sys.os===sys.OS_IOS&&(polyfill$1.enableDiv=!0),sys.isMobile?sys.browserType===sys.BROWSER_TYPE_FIREFOX&&(polyfill$1.enableBG=!0):sys.browserType===sys.BROWSER_TYPE_IE&&(polyfill$1.closeHistory=!0);var _dec$1c,_dec2$P,_dec3$z,_dec4$u,_class$1e,_class2$10,_descriptor$Y,_descriptor2$N,_class3$v,_temp$17,WebViewImpl=(_dec$1b=ccclass("cc.WebviewImpl"))((_temp$16=_class2$$=function(){function r(){_classCallCheck(this,r),this._EventList=new Map,this._visible=!1,this._div=null,this._iframe=null,this._forceUpdate=!0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._w=0,this._h=0,this._eventListeners={load:function(){},error:function(){}}}return _createClass(r,[{key:"createDomElementIfNeeded",value:function(e,t){this._div?this._updateSize(e,t):this._createNativeControl(e,t)}},{key:"removeDom",value:function(){var e=this._div;e&&(contains$1(cc.game.container,e)&&cc.game.container.removeChild(e),this._div=null);var t=this._iframe;if(t){var i=this._eventListeners;t.removeEventListener("load",i.load),t.removeEventListener("error",i.error),i.load=null,i.error=null,this._iframe=null}}},{key:"loadURL",value:function(e){var t=this._iframe;if(t){t.src=e;var i=this;t.addEventListener("load",function e(){i._updateVisibility(),t.removeEventListener("load",e)}),this._dispatchEvent(r.EventType.LOADING)}}},{key:"stopLoading",value:function(){logID(7800)}},{key:"reload",value:function(){var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.location.reload()}}},{key:"canGoBack",value:function(){return logID(7801),!0}},{key:"canGoForward",value:function(){return logID(7802),!0}},{key:"goBack",value:function(){try{if(r.Polyfill.closeHistory)return logID(7803);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.back.call(t)}}catch(e){log(e)}}},{key:"goForward",value:function(){try{if(r.Polyfill.closeHistory)return logID(7804);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.forward.call(t)}}catch(e){log(e)}}},{key:"evaluateJS",value:function(e){var t=this._iframe;if(t)t.contentWindow}},{key:"setScalesPageToFit",value:function(){logID(7805)}},{key:"setEventListener",value:function(e,t){this._EventList[e]=t}},{key:"removeEventListener",value:function(e){this._EventList[e]=null}},{key:"_dispatchEvent",value:function(e){var t=this._EventList[e];t&&this._iframe&&t.call(this,this,this._iframe.src)}},{key:"destroy",value:function(){this.removeDom()}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"updateMatrix",value:function(e){if(this._div&&this._visible){e.getWorldMatrix(_mat4_temp$2);var t=e.getContentSize();if(this._forceUpdate||this._m00!==_mat4_temp$2.m00||this._m01!==_mat4_temp$2.m01||this._m04!==_mat4_temp$2.m04||this._m05!==_mat4_temp$2.m05||this._m12!==_mat4_temp$2.m12||this._m13!==_mat4_temp$2.m13||this._w!==t.width||this._h!==t.height){this._m00=_mat4_temp$2.m00,this._m01=_mat4_temp$2.m01,this._m04=_mat4_temp$2.m04,this._m05=_mat4_temp$2.m05,this._m12=_mat4_temp$2.m12,this._m13=_mat4_temp$2.m13,this._w=t.width,this._h=t.height;var i=view.getScaleX(),r=view.getScaleY(),n=view.getDevicePixelRatio();i/=n,r/=n;var s=cc.game.container,a=_mat4_temp$2.m00*i,o=_mat4_temp$2.m01,c=_mat4_temp$2.m04,l=_mat4_temp$2.m05*r,u=s&&s.style.paddingLeft?parseInt(s.style.paddingLeft):0,h=s&&s.style.paddingBottom?parseInt(s.style.paddingBottom):0;this._updateSize(this._w,this._h);var _=this._div.clientWidth*i,p=this._div.clientHeight*r,d=e.getAnchorPoint(),f=_*_mat4_temp$2.m00*d.x,m=p*_mat4_temp$2.m05*d.y,y="matrix("+a+","+-o+","+-c+","+l+","+(_mat4_temp$2.m12*i-f+u)+","+-(_mat4_temp$2.m13*r-m+h)+")";this._div.style.transform=y,this._div.style["-webkit-transform"]=y,this._div.style["transform-origin"]="0px 100% 0px",this._div.style["-webkit-transform-origin"]="0px 100% 0px";var v=e.getComponent(UIRenderComponent);v&&this._setOpacity(v.color.a)}}}},{key:"setOnJSCallback",value:function(e){}},{key:"setJavascriptInterfaceScheme",value:function(e){}},{key:"loadData",value:function(e,t,i,r){}},{key:"loadHTMLString",value:function(e,t){}},{key:"_updateVisibility",value:function(){if(this._div){var e=this._div;this._visible?e.style.visibility="visible":e.style.visibility="hidden",this._forceUpdate=!0}}},{key:"_updateSize",value:function(e,t){var i=this._div;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_initEvent",value:function(){var e=this._iframe;if(e){var t=this._eventListeners,i=this;t.load=function(){i._dispatchEvent(r.EventType.LOADED)},t.error=function(){i._dispatchEvent(r.EventType.ERROR)},e.addEventListener("load",t.load),e.addEventListener("error",t.error)}}},{key:"_initStyle",value:function(){if(this._div){var e=this._div;e.style.position="absolute",e.style.bottom="0px",e.style.left="0px"}}},{key:"_setOpacity",value:function(e){var t=this._iframe;t&&t.style&&(t.style.opacity=(e/255).toString())}},{key:"_createDom",value:function(e,t){r.Polyfill.enableDiv?(this._div=document.createElement("div"),this._div.style["-webkit-overflow"]="auto",this._div.style["-webkit-overflow-scrolling"]="touch",this._iframe=document.createElement("iframe"),this._div.appendChild(this._iframe),this._iframe.style.width="100%",this._iframe.style.height="100%"):this._div=this._iframe=document.createElement("iframe"),r.Polyfill.enableBG&&(this._div.style.background="#FFF"),this._div.style.background="#FFF",this._div.style.height=t+"px",this._div.style.width=e+"px",this._div.style.overflow="scroll",this._iframe.style.border="none",cc.game.container.appendChild(this._div),this._updateVisibility()}},{key:"_createNativeControl",value:function(e,t){this._createDom(e,t),this._initStyle(),this._initEvent()}}]),r}(),_class2$$.Polyfill=polyfill$1,_class2$$.EventType=WebViewEventType,_class$1d=_temp$16))||_class$1d,EventType=WebViewEventType;function emptyCallback(){}var _dec$1d,_dec2$Q,_dec3$A,_dec4$v,_dec5$r,_dec6$n,_dec7$h,_dec8$9,_class$1f,_class2$11,_descriptor$Z,_descriptor2$O,_descriptor3$z,_descriptor4$u,_descriptor5$n,_descriptor6$e,_descriptor7$c,_descriptor8$c,_descriptor9$a,_descriptor10$9,_descriptor11$7,_descriptor12$6,_descriptor13$6,_descriptor14$6,_descriptor15$2,_descriptor16$2,_descriptor17$1,_class3$w,_temp$18,WebviewComponent=(_dec$1c=ccclass("cc.WebviewComponent"),_dec2$P=menu("UI/WebView"),_dec3$z=executionOrder(100),_dec4$u=property({type:EventHandler}),_dec$1c(_class$1e=_dec2$P(_class$1e=_dec3$z((_temp$17=_class3$v=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"webviewEvents",_descriptor$Y,_assertThisInitialized(e)),_initializerDefineProperty(e,"_url",_descriptor2$N,_assertThisInitialized(e)),e._impl=null,e._impl=new WebViewImpl,e}return _inherits(t,UIComponent),_createClass(t,[{key:"url",get:function(){return this._url},set:function(e){this._url=e;var t=this._impl;t&&t.loadURL(e)}}]),_createClass(t,[{key:"onRestore",value:function(){this._impl||(this._impl=new WebViewImpl)}},{key:"onEnable",value:function(){if(this._impl){var e=this._impl;e.createDomElementIfNeeded(this.node.width,this.node.height),e.loadURL(this._url),e.setVisible(!0),e.setEventListener(EventType.LOADED,this._onWebViewLoaded.bind(this)),e.setEventListener(EventType.LOADING,this._onWebViewLoading.bind(this)),e.setEventListener(EventType.ERROR,this._onWebViewLoadError.bind(this))}}},{key:"onDisable",value:function(){if(this._impl){var e=this._impl;e.setVisible(!1),e.setEventListener(EventType.LOADED,emptyCallback),e.setEventListener(EventType.LOADING,emptyCallback),e.setEventListener(EventType.ERROR,emptyCallback)}}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(e){this._impl&&this._impl.updateMatrix(this.node)}},{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"_onWebViewLoaded",value:function(){EventHandler.emitEvents(this.webviewEvents,this,EventType.LOADED),this.node.emit("loaded",this)}},{key:"_onWebViewLoading",value:function(){return EventHandler.emitEvents(this.webviewEvents,this,EventType.LOADING),this.node.emit("loading",this),!0}},{key:"_onWebViewLoadError",value:function(){EventHandler.emitEvents(this.webviewEvents,this,EventType.ERROR),this.node.emit("error",this)}}]),t}(),_class3$v.EventType=EventType,_applyDecoratedDescriptor((_class2$10=_temp$17).prototype,"url",[property],Object.getOwnPropertyDescriptor(_class2$10.prototype,"url"),_class2$10.prototype),_descriptor$Y=_applyDecoratedDescriptor(_class2$10.prototype,"webviewEvents",[_dec4$u],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor2$N=_applyDecoratedDescriptor(_class2$10.prototype,"_url",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_class$1e=_class2$10))||_class$1e)||_class$1e)||_class$1e);cc.WebviewComponent=WebviewComponent;var AlignMode,AlignFlags,_zeroVec3=new Vec3;function getReadonlyNodeSize(e){return e instanceof Scene?visibleRect:e.getContentSize()}function computeInverseTransForTarget(e,t,i,r){for(var n=e.parent?e.parent.getScale():_zeroVec3,s=n.x,a=n.y,o=0,c=0,l=e.parent;;){if(!l)return i.x=i.y=0,void(r.x=r.y=1);var u=l.getPosition();if(o+=u.x,c+=u.y,(l=l.parent)===t)break;var h=(n=l?l.getScale():_zeroVec3).x,_=n.y;o*=h,c*=_,s*=h,a*=_}r.x=0!==s?1/s:1,r.y=0!==a?1/a:1,i.x=-o,i.y=-c}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS"}(AlignMode=AlignMode||{}),ccenum(AlignMode),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(AlignFlags=AlignFlags||{});var _dec$1e,_dec2$R,_dec3$B,_class$1g,TOP_BOT=AlignFlags.TOP|AlignFlags.BOT,LEFT_RIGHT=AlignFlags.LEFT|AlignFlags.RIGHT,WidgetComponent=(_dec$1d=ccclass("cc.WidgetComponent"),_dec2$Q=executionOrder(110),_dec3$A=menu("UI/Widget"),_dec4$v=requireComponent(UITransformComponent),_dec5$r=property({type:Node$1}),_dec6$n=property({visible:!1}),_dec7$h=property({visible:!1}),_dec8$9=property({type:AlignMode}),_dec$1d(_class$1f=_dec2$Q(_class$1f=_dec3$A(_class$1f=_dec4$v(_class$1f=executeInEditMode((_temp$18=_class3$w=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._lastPos=new Vec3,t._lastSize=new Size,t._dirty=!0,_initializerDefineProperty(t,"_alignFlags",_descriptor$Z,_assertThisInitialized(t)),_initializerDefineProperty(t,"_target",_descriptor2$O,_assertThisInitialized(t)),_initializerDefineProperty(t,"_left",_descriptor3$z,_assertThisInitialized(t)),_initializerDefineProperty(t,"_right",_descriptor4$u,_assertThisInitialized(t)),_initializerDefineProperty(t,"_top",_descriptor5$n,_assertThisInitialized(t)),_initializerDefineProperty(t,"_bottom",_descriptor6$e,_assertThisInitialized(t)),_initializerDefineProperty(t,"_horizontalCenter",_descriptor7$c,_assertThisInitialized(t)),_initializerDefineProperty(t,"_verticalCenter",_descriptor8$c,_assertThisInitialized(t)),_initializerDefineProperty(t,"_isAbsLeft",_descriptor9$a,_assertThisInitialized(t)),_initializerDefineProperty(t,"_isAbsRight",_descriptor10$9,_assertThisInitialized(t)),_initializerDefineProperty(t,"_isAbsTop",_descriptor11$7,_assertThisInitialized(t)),_initializerDefineProperty(t,"_isAbsBottom",_descriptor12$6,_assertThisInitialized(t)),_initializerDefineProperty(t,"_isAbsHorizontalCenter",_descriptor13$6,_assertThisInitialized(t)),_initializerDefineProperty(t,"_isAbsVerticalCenter",_descriptor14$6,_assertThisInitialized(t)),_initializerDefineProperty(t,"_originalWidth",_descriptor15$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"_originalHeight",_descriptor16$2,_assertThisInitialized(t)),_initializerDefineProperty(t,"_alignMode",_descriptor17$1,_assertThisInitialized(t)),t}return _inherits(s,Component),_createClass(s,[{key:"updateAlignment",value:function(){cc._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this.node.getContentSize(this._lastSize),cc._widgetManager.add(this),this._registerEvent(),this._registerTargetEvents()}},{key:"onDisable",value:function(){cc._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}},{key:"onDestroy",value:function(){this._removeParentEvent()}},{key:"_adjustWidgetToAllowMovingInEditor",value:function(e){if(e===exports.SystemEventType.POSITION_PART&&!cc._widgetManager.isAligning){var t=this,i=t.node.getPosition(),r=this._lastPos,n=new Vec3(i);n.subtract(r);var s=t.node.parent,a=new Vec3(1,1,1);if(t.target&&(s=t.target,computeInverseTransForTarget(t.node,s,new Vec3,a)),s){var o=getReadonlyNodeSize(s),c=new Vec3;0!==o.width&&0!==o.height&&Vec3.set(c,n.x/o.width,n.y/o.height,c.z),t.isAlignTop&&(t._top-=(t._isAbsTop?n.y:c.y)*a.y),t.isAlignBottom&&(t._bottom+=(t._isAbsBottom?n.y:c.y)*a.y),t.isAlignLeft&&(t._left+=(t._isAbsLeft?n.x:c.x)*a.x),t.isAlignRight&&(t._right-=(t._isAbsRight?n.x:c.x)*a.x),t.isAlignHorizontalCenter&&(t._horizontalCenter+=(t._isAbsHorizontalCenter?n.x:c.x)*a.x),t.isAlignVerticalCenter&&(t._verticalCenter+=(t._isAbsVerticalCenter?n.y:c.y)*a.y),this._recursiveDirty()}}}},{key:"_adjustWidgetToAllowResizingInEditor",value:function(){if(!cc._widgetManager.isAligning){this.setDirty();var e=this,t=e.node.getContentSize(),i=this._lastSize,r=new Vec3(t.width-i.width,t.height-i.height,0),n=e.node.parent,s=new Vec3(1,1,1);if(e.target&&(n=e.target,computeInverseTransForTarget(e.node,n,new Vec3,s)),n){var a=getReadonlyNodeSize(n),o=new Vec3;0!==a.width&&0!==a.height&&Vec3.set(o,r.x/a.width,r.y/a.height,o.z);var c=e.node.getAnchorPoint();e.isAlignTop&&(e._top-=(e._isAbsTop?r.y:o.y)*(1-c.y)*s.y),e.isAlignBottom&&(e._bottom-=(e._isAbsBottom?r.y:o.y)*c.y*s.y),e.isAlignLeft&&(e._left-=(e._isAbsLeft?r.x:o.x)*c.x*s.x),e.isAlignRight&&(e._right-=(e._isAbsRight?r.x:o.x)*(1-c.x)*s.x),this._recursiveDirty()}}}},{key:"_adjustWidgetToAnchorChanged",value:function(){this.setDirty()}},{key:"_adjustTargetToParentChanged",value:function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents()}},{key:"_registerEvent",value:function(){this.node.on(exports.SystemEventType.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.on(exports.SystemEventType.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.on(exports.SystemEventType.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(exports.SystemEventType.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_unregisterEvent",value:function(){this.node.off(exports.SystemEventType.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.off(exports.SystemEventType.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.off(exports.SystemEventType.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}},{key:"_removeParentEvent",value:function(){this.node.off(exports.SystemEventType.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_autoChangedValue",value:function(e,t){if(0<(this._alignFlags&e)&&this.node.parent&&this.node.parent.uiTransfromComp){var i=this.node.parent.getContentSize();this.isAlignLeft&&e===AlignFlags.LEFT?this._left=t?this._left*i.width:this._left/i.width:this.isAlignRight&&e===AlignFlags.RIGHT?this._right=t?this._right*i.width:this._right/i.width:this.isAlignHorizontalCenter&&e===AlignFlags.CENTER?this._horizontalCenter=t?this._horizontalCenter*i.width:this._horizontalCenter/i.width:this.isAlignTop&&e===AlignFlags.TOP?this._top=t?this._top*i.height:this._top/i.height:this.isAlignBottom&&e===AlignFlags.BOT?this._bottom=t?this._bottom*i.height:this._bottom/i.height:this.isAbsoluteVerticalCenter&&e===AlignFlags.MID&&(this._verticalCenter=this._verticalCenter/i.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.getComponent(UITransformComponent)?(e.on(exports.SystemEventType.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.on(exports.SystemEventType.SIZE_CHANGED,this._targetChangedOperation,this)):cc.warnID(6501,this.node.name))}},{key:"_unregisterTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.off(exports.SystemEventType.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.off(exports.SystemEventType.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_unregisterOldParentEvents",value:function(e){var t=this._target||e;t&&(t.off(exports.SystemEventType.TRANSFORM_CHANGED,this._targetChangedOperation,this),t.off(exports.SystemEventType.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_targetChangedOperation",value:function(){this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==0<(this._alignFlags&e)){var i=0<(e&LEFT_RIGHT);t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=this.node.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=this.node.height))):(i?this.isStretchWidth&&(this.node.width=this._originalWidth):this.isStretchHeight&&(this.node.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||(this._dirty=!0)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return 0<(this._alignFlags&AlignFlags.TOP)},set:function(e){this._setAlign(AlignFlags.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return 0<(this._alignFlags&AlignFlags.BOT)},set:function(e){this._setAlign(AlignFlags.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return 0<(this._alignFlags&AlignFlags.LEFT)},set:function(e){this._setAlign(AlignFlags.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return 0<(this._alignFlags&AlignFlags.RIGHT)},set:function(e){this._setAlign(AlignFlags.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return 0<(this._alignFlags&AlignFlags.MID)},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=AlignFlags.MID):this._alignFlags&=~AlignFlags.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return 0<(this._alignFlags&AlignFlags.CENTER)},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=AlignFlags.CENTER):this._alignFlags&=~AlignFlags.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&LEFT_RIGHT)===LEFT_RIGHT}},{key:"isStretchHeight",get:function(){return(this._alignFlags&TOP_BOT)===TOP_BOT}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(AlignFlags.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(AlignFlags.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(AlignFlags.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(AlignFlags.RIGHT,this._isAbsRight))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(AlignFlags.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(AlignFlags.MID,this._isAbsVerticalCenter))}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),s}(),_class3$w.AlignMode=AlignMode,_applyDecoratedDescriptor((_class2$11=_temp$18).prototype,"target",[_dec5$r],Object.getOwnPropertyDescriptor(_class2$11.prototype,"target"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAlignTop",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAlignTop"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAlignBottom",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAlignBottom"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAlignLeft",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAlignLeft"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAlignRight",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAlignRight"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAlignVerticalCenter",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAlignVerticalCenter"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAlignHorizontalCenter",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAlignHorizontalCenter"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isStretchWidth",[_dec6$n],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isStretchWidth"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isStretchHeight",[_dec7$h],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isStretchHeight"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"editorTop",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"editorTop"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"editorBottom",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"editorBottom"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"editorLeft",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"editorLeft"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"editorRight",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"editorRight"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"editorHorizontalCenter",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"editorHorizontalCenter"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"editorVerticalCenter",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"editorVerticalCenter"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAbsoluteTop",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAbsoluteTop"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAbsoluteBottom",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAbsoluteBottom"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAbsoluteLeft",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAbsoluteLeft"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAbsoluteRight",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAbsoluteRight"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"alignMode",[_dec8$9],Object.getOwnPropertyDescriptor(_class2$11.prototype,"alignMode"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAbsoluteHorizontalCenter",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAbsoluteHorizontalCenter"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"isAbsoluteVerticalCenter",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"isAbsoluteVerticalCenter"),_class2$11.prototype),_applyDecoratedDescriptor(_class2$11.prototype,"alignFlags",[property],Object.getOwnPropertyDescriptor(_class2$11.prototype,"alignFlags"),_class2$11.prototype),_descriptor$Z=_applyDecoratedDescriptor(_class2$11.prototype,"_alignFlags",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor2$O=_applyDecoratedDescriptor(_class2$11.prototype,"_target",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor3$z=_applyDecoratedDescriptor(_class2$11.prototype,"_left",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor4$u=_applyDecoratedDescriptor(_class2$11.prototype,"_right",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor5$n=_applyDecoratedDescriptor(_class2$11.prototype,"_top",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor6$e=_applyDecoratedDescriptor(_class2$11.prototype,"_bottom",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor7$c=_applyDecoratedDescriptor(_class2$11.prototype,"_horizontalCenter",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor8$c=_applyDecoratedDescriptor(_class2$11.prototype,"_verticalCenter",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor9$a=_applyDecoratedDescriptor(_class2$11.prototype,"_isAbsLeft",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor10$9=_applyDecoratedDescriptor(_class2$11.prototype,"_isAbsRight",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor11$7=_applyDecoratedDescriptor(_class2$11.prototype,"_isAbsTop",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor12$6=_applyDecoratedDescriptor(_class2$11.prototype,"_isAbsBottom",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor13$6=_applyDecoratedDescriptor(_class2$11.prototype,"_isAbsHorizontalCenter",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor14$6=_applyDecoratedDescriptor(_class2$11.prototype,"_isAbsVerticalCenter",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor15$2=_applyDecoratedDescriptor(_class2$11.prototype,"_originalWidth",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor16$2=_applyDecoratedDescriptor(_class2$11.prototype,"_originalHeight",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor17$1=_applyDecoratedDescriptor(_class2$11.prototype,"_alignMode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AlignMode.ALWAYS}}),_class$1f=_class2$11))||_class$1f)||_class$1f)||_class$1f)||_class$1f)||_class$1f);cc.WidgetComponent=WidgetComponent;var _dec$1f,_dec2$S,_dec3$C,_dec4$w,_dec5$s,_dec6$o,_class$1h,_class2$12,_descriptor$_,_descriptor2$P,_descriptor3$A,_descriptor4$v,_class3$x,_temp$19,UIReorderComponent=(_dec$1e=ccclass("cc.UIReorderComponent"))(_class$1g=(_dec2$R=menu("UI/Reorder"))(_class$1g=(_dec3$B=executionOrder(110))(_class$1g=disallowMultiple(_class$1g=executeInEditMode(_class$1g=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,UIComponent),e}())||_class$1g)||_class$1g)||_class$1g)||_class$1g)||_class$1g;cc.UIReorderComponent=UIReorderComponent;var Direction$2,_color=new Color;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Direction$2=Direction$2||{}),ccenum(Direction$2);var _dec$1g,_dec2$T,_dec3$D,_dec4$x,_dec5$t,_dec6$p,_dec7$i,_dec8$a,_dec9$8,_dec10$7,_dec11$6,_dec12$5,_dec13$2,_dec14$2,_dec15$2,_class$1i,_class2$13,_descriptor$$,_descriptor2$Q,_descriptor3$B,_descriptor4$w,_descriptor5$o,_descriptor6$f,_descriptor7$d,_descriptor8$d,_descriptor9$b,_descriptor10$a,_descriptor11$8,_descriptor12$7,_class3$y,_temp$1a,PageViewIndicatorComponent=(_dec$1f=ccclass("cc.PageViewIndicatorComponent"),_dec2$S=executionOrder(110),_dec3$C=menu("UI/PageViewIndicator"),_dec4$w=property({type:SpriteFrame}),_dec5$s=property({type:Direction$2}),_dec6$o=property({type:Size}),_dec$1f(_class$1h=_dec2$S(_class$1h=_dec3$C((_temp$19=_class3$x=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"spacing",_descriptor$_,_assertThisInitialized(t)),_initializerDefineProperty(t,"_spriteFrame",_descriptor2$P,_assertThisInitialized(t)),_initializerDefineProperty(t,"_direction",_descriptor3$A,_assertThisInitialized(t)),_initializerDefineProperty(t,"_cellSize",_descriptor4$v,_assertThisInitialized(t)),t._layout=null,t._pageView=null,t._indicators=[],t}return _inherits(s,Component),_createClass(s,[{key:"onLoad",value:function(){this._updateLayout()}},{key:"setPageView",value:function(e){this._pageView=e,this._refresh()}},{key:"_updateLayout",value:function(){this._layout=this.getComponent(LayoutComponent),this._layout||(this._layout=this.addComponent(LayoutComponent));var e=this._layout;this.direction===Direction$2.HORIZONTAL?(e.type=LayoutComponent.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===Direction$2.VERTICAL&&(e.type=LayoutComponent.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=LayoutComponent.ResizeMode.CONTAINER}},{key:"_createIndicator",value:function(){var e=new Node$1;return e.addComponent(SpriteComponent).spriteFrame=this.spriteFrame,e.parent=this.node,e.width=this.cellSize.width,e.height=this.cellSize.height,e}},{key:"_changedState",value:function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var i=0;i<e.length;++i){var r=e[i];if(r._uiComp){var n=r._uiComp;_color.set(n.color),_color.a=127.5,n.color=_color}}if(e[t]._uiComp){var s=e[t]._uiComp;_color.set(s.color),_color.a=255,s.color=_color}}}}},{key:"_refresh",value:function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;0<i;--i){var r=e[i-1];this.node.removeChild(r),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),s}(),_class3$x.Direction=Direction$2,_applyDecoratedDescriptor((_class2$12=_temp$19).prototype,"spriteFrame",[_dec4$w],Object.getOwnPropertyDescriptor(_class2$12.prototype,"spriteFrame"),_class2$12.prototype),_applyDecoratedDescriptor(_class2$12.prototype,"direction",[_dec5$s],Object.getOwnPropertyDescriptor(_class2$12.prototype,"direction"),_class2$12.prototype),_applyDecoratedDescriptor(_class2$12.prototype,"cellSize",[_dec6$o],Object.getOwnPropertyDescriptor(_class2$12.prototype,"cellSize"),_class2$12.prototype),_descriptor$_=_applyDecoratedDescriptor(_class2$12.prototype,"spacing",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor2$P=_applyDecoratedDescriptor(_class2$12.prototype,"_spriteFrame",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor3$A=_applyDecoratedDescriptor(_class2$12.prototype,"_direction",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Direction$2.HORIZONTAL}}),_descriptor4$v=_applyDecoratedDescriptor(_class2$12.prototype,"_cellSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Size(20,20)}}),_class$1h=_class2$12))||_class$1h)||_class$1h)||_class$1h);cc.PageViewIndicatorComponent=PageViewIndicatorComponent;var SizeMode$1,Direction$3,PageViewEventType,_temp_vec2=new Vec2;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(SizeMode$1=SizeMode$1||{}),ccenum(SizeMode$1),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Direction$3=Direction$3||{}),ccenum(Direction$3),function(e){e[e.PAGE_TURNING=0]="PAGE_TURNING"}(PageViewEventType=PageViewEventType||{}),ccenum(PageViewEventType);var PageViewComponent=(_dec$1g=ccclass("cc.PageViewComponent"),_dec2$T=executionOrder(110),_dec3$D=menu("UI/PageView"),_dec4$x=property({type:SizeMode$1}),_dec5$t=property({type:Direction$3}),_dec6$p=property({slide:!0,range:[0,1,.01]}),_dec7$i=property({slide:!0,range:[0,1,.01]}),_dec8$a=property({type:PageViewIndicatorComponent}),_dec9$8=property({type:ScrollBarComponent,visible:!1,override:!0}),_dec10$7=property({type:ScrollBarComponent,visible:!1,override:!0}),_dec11$6=property({visible:!1,override:!0}),_dec12$5=property({visible:!1,override:!0}),_dec13$2=property({visible:!1,override:!0}),_dec14$2=property({visible:!1,override:!0,type:[EventHandler]}),_dec15$2=property({type:[EventHandler]}),_dec$1g(_class$1i=_dec2$T(_class$1i=_dec3$D((_temp$1a=_class3$y=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"autoPageTurningThreshold",_descriptor$$,_assertThisInitialized(t)),_initializerDefineProperty(t,"horizontal",_descriptor2$Q,_assertThisInitialized(t)),_initializerDefineProperty(t,"vertical",_descriptor3$B,_assertThisInitialized(t)),_initializerDefineProperty(t,"cancelInnerEvents",_descriptor4$w,_assertThisInitialized(t)),_initializerDefineProperty(t,"scrollEvents",_descriptor5$o,_assertThisInitialized(t)),_initializerDefineProperty(t,"pageTurningSpeed",_descriptor6$f,_assertThisInitialized(t)),_initializerDefineProperty(t,"pageEvents",_descriptor7$d,_assertThisInitialized(t)),_initializerDefineProperty(t,"_sizeMode",_descriptor8$d,_assertThisInitialized(t)),_initializerDefineProperty(t,"_direction",_descriptor9$b,_assertThisInitialized(t)),_initializerDefineProperty(t,"_scrollThreshold",_descriptor10$a,_assertThisInitialized(t)),_initializerDefineProperty(t,"_pageTurningEventTiming",_descriptor11$8,_assertThisInitialized(t)),_initializerDefineProperty(t,"_indicator",_descriptor12$7,_assertThisInitialized(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new Vec3,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Vec3,t._touchEndPosition=new Vec3,t}return _inherits(s,ScrollViewComponent),_createClass(s,[{key:"__preload",value:function(){this.node.on(exports.SystemEventType.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"onEnable",value:function(){_get(_getPrototypeOf(s.prototype),"onEnable",this).call(this),this.node.on("scroll-ended-with-threshold",this._dispatchPageTurningEvent,this)}},{key:"onDisable",value:function(){_get(_getPrototypeOf(s.prototype),"onDisable",this).call(this),this.node.off("scroll-ended-with-threshold",this._dispatchPageTurningEvent,this)}},{key:"onLoad",value:function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}},{key:"onDestroy",value:function(){this.node.off(exports.SystemEventType.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"getCurrentPageIndex",value:function(){return this._curPageIdx}},{key:"setCurrentPageIndex",value:function(e){this.scrollToPage(e,1)}},{key:"getPages",value:function(){return this._pages}},{key:"addPage",value:function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(this.content.addChild(e),this._pages.push(e),this._updatePageView())}},{key:"insertPage",value:function(e,t){t<0||!e||-1!==this._pages.indexOf(e)||!this.content||(this._pages.length<=t?this.addPage(e):(this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()))}},{key:"removePage",value:function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):warnID(4300,e.name)}}},{key:"removePageAtIndex",value:function(e){var t=this._pages;if(!(e<0||e>=t.length)){var i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}}},{key:"removeAllPages",value:function(){if(this.content){for(var e=this._pages,t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}}},{key:"scrollToPage",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;e<0||e>=this._pages.length||(i=void 0!==i?i:.3,this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),i,!0),this.indicator&&this.indicator._changedState())}},{key:"getScrollEndedEventTiming",value:function(){return this.pageTurningEventTiming}},{key:"_updatePageView",value:function(){var e=this.content.getComponent(LayoutComponent);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,r=0;r<t;++r){var n=this._pages[r].position;this.direction===Direction$3.Horizontal?this._scrollCenterOffsetX[r]=Math.abs(i.x+n.x):this._scrollCenterOffsetY[r]=Math.abs(i.y+n.y)}this.indicator&&this.indicator._refresh()}},{key:"_updateAllPagesSize",value:function(){if(this.content&&this.view&&this._sizeMode===SizeMode$1.Unified)for(var e=this._pages,t=this.view.getContentSize(),i=0,r=e.length;i<r;i++)e[i].setContentSize(t)}},{key:"_handleReleaseLogic",value:function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_onTouchBegan",value:function(e,t){e.touch.getUILocation(_temp_vec2),Vec3.set(this._touchBeganPosition,_temp_vec2.x,_temp_vec2.y,0),_get(_getPrototypeOf(s.prototype),"_onTouchBegan",this).call(this,e,t)}},{key:"_onTouchMoved",value:function(e,t){_get(_getPrototypeOf(s.prototype),"_onTouchMoved",this).call(this,e,t)}},{key:"_onTouchEnded",value:function(e,t){e.touch.getUILocation(_temp_vec2),Vec3.set(this._touchEndPosition,_temp_vec2.x,_temp_vec2.y,0),_get(_getPrototypeOf(s.prototype),"_onTouchEnded",this).call(this,e,t)}},{key:"_onTouchCancelled",value:function(e,t){e.touch.getUILocation(_temp_vec2),Vec3.set(this._touchEndPosition,_temp_vec2.x,_temp_vec2.y,0),_get(_getPrototypeOf(s.prototype),"_onTouchCancelled",this).call(this,e,t)}},{key:"_onMouseWheel",value:function(){}},{key:"_syncScrollDirection",value:function(){this.horizontal=this.direction===Direction$3.Horizontal,this.vertical=this.direction===Direction$3.Vertical}},{key:"_syncSizeMode",value:function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(LayoutComponent);if(t){if(this._sizeMode===SizeMode$1.Free&&0<this._pages.length){var i=this._pages[this._pages.length-1];this.direction===Direction$3.Horizontal?(t.paddingLeft=(e.width-this._pages[0].width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===Direction$3.Vertical&&(t.paddingTop=(e.height-this._pages[0].height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}}},{key:"_initPages",value:function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var i=e[t];0<=this._pages.indexOf(i)||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}}},{key:"_dispatchPageTurningEvent",value:function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,EventHandler.emitEvents(this.pageEvents,this,PageViewEventType.PAGE_TURNING),this.node.emit("page-turning",this))}},{key:"_isQuicklyScrollable",value:function(e){if(this.direction===Direction$3.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===Direction$3.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}},{key:"_moveOffsetValue",value:function(e){var t=new Vec3;if(this._sizeMode===SizeMode$1.Free)this.direction===Direction$3.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===Direction$3.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var i=this.view;if(!i)return t;this.direction===Direction$3.Horizontal?t.x=e*i.width:this.direction===Direction$3.Vertical&&(t.y=e*i.height)}return t}},{key:"_getDragDirection",value:function(e){return this._direction===Direction$3.Horizontal?0===e.x?0:0<e.x?1:-1:0===e.y?0:e.y<0?1:-1}},{key:"_isScrollable",value:function(e,t,i){if(this._sizeMode===SizeMode$1.Free){var r=0,n=0;if(this.direction===Direction$3.Horizontal)return r=this._scrollCenterOffsetX[t],n=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(r-n)*this.scrollThreshold;if(this.direction===Direction$3.Vertical)return r=this._scrollCenterOffsetY[t],n=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(r-n)*this.scrollThreshold}else{var s=this.view;if(!s)return;if(this.direction===Direction$3.Horizontal)return Math.abs(e.x)>=s.width*this.scrollThreshold;if(this.direction===Direction$3.Vertical)return Math.abs(e.y)>=s.height*this.scrollThreshold}}},{key:"_autoScrollToPage",value:function(){var e=this._startBounceBackIfNeeded(),t=new Vec3;if(Vec3.subtract(t,this._touchBeganPosition,this._touchEndPosition),e){var i=this._getDragDirection(t);if(0===i)return;this._curPageIdx=0<i?this._pages.length-1:0,this.indicator&&this.indicator._changedState()}else{var r=this._curPageIdx,n=r+this._getDragDirection(t),s=this.pageTurningSpeed*Math.abs(r-n);if(n<this._pages.length){if(this._isScrollable(t,r,n))return void this.scrollToPage(n,s);var a=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(a))return void this.scrollToPage(n,s)}this.scrollToPage(r,s)}}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar}}]),s}(),_class3$y.SizeMode=SizeMode$1,_class3$y.Direction=Direction$3,_class3$y.EventType=PageViewEventType,_applyDecoratedDescriptor((_class2$13=_temp$1a).prototype,"sizeMode",[_dec4$x],Object.getOwnPropertyDescriptor(_class2$13.prototype,"sizeMode"),_class2$13.prototype),_applyDecoratedDescriptor(_class2$13.prototype,"direction",[_dec5$t],Object.getOwnPropertyDescriptor(_class2$13.prototype,"direction"),_class2$13.prototype),_applyDecoratedDescriptor(_class2$13.prototype,"scrollThreshold",[_dec6$p],Object.getOwnPropertyDescriptor(_class2$13.prototype,"scrollThreshold"),_class2$13.prototype),_applyDecoratedDescriptor(_class2$13.prototype,"pageTurningEventTiming",[_dec7$i],Object.getOwnPropertyDescriptor(_class2$13.prototype,"pageTurningEventTiming"),_class2$13.prototype),_applyDecoratedDescriptor(_class2$13.prototype,"indicator",[_dec8$a],Object.getOwnPropertyDescriptor(_class2$13.prototype,"indicator"),_class2$13.prototype),_descriptor$$=_applyDecoratedDescriptor(_class2$13.prototype,"autoPageTurningThreshold",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),_applyDecoratedDescriptor(_class2$13.prototype,"verticalScrollBar",[_dec9$8],Object.getOwnPropertyDescriptor(_class2$13.prototype,"verticalScrollBar"),_class2$13.prototype),_applyDecoratedDescriptor(_class2$13.prototype,"horizontalScrollBar",[_dec10$7],Object.getOwnPropertyDescriptor(_class2$13.prototype,"horizontalScrollBar"),_class2$13.prototype),_descriptor2$Q=_applyDecoratedDescriptor(_class2$13.prototype,"horizontal",[_dec11$6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor3$B=_applyDecoratedDescriptor(_class2$13.prototype,"vertical",[_dec12$5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor4$w=_applyDecoratedDescriptor(_class2$13.prototype,"cancelInnerEvents",[_dec13$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor5$o=_applyDecoratedDescriptor(_class2$13.prototype,"scrollEvents",[_dec14$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor6$f=_applyDecoratedDescriptor(_class2$13.prototype,"pageTurningSpeed",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),_descriptor7$d=_applyDecoratedDescriptor(_class2$13.prototype,"pageEvents",[_dec15$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor8$d=_applyDecoratedDescriptor(_class2$13.prototype,"_sizeMode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SizeMode$1.Unified}}),_descriptor9$b=_applyDecoratedDescriptor(_class2$13.prototype,"_direction",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Direction$3.Horizontal}}),_descriptor10$a=_applyDecoratedDescriptor(_class2$13.prototype,"_scrollThreshold",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),_descriptor11$8=_applyDecoratedDescriptor(_class2$13.prototype,"_pageTurningEventTiming",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_descriptor12$7=_applyDecoratedDescriptor(_class2$13.prototype,"_indicator",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$1i=_class2$13))||_class$1i)||_class$1i)||_class$1i);cc.PageViewComponent=PageViewComponent;var _tempPos$3=new Vec3,_defaultAnchor=new Vec2,tInverseTranslate=new Vec3,tInverseScale=new Vec3(1,1,1);function align(e,t){var i,r=t.target,n=tInverseTranslate,s=tInverseScale;if(r?computeInverseTransForTarget(e,i=r,n,s):i=e.parent,i.getComponent(UITransformComponent)){var a=getReadonlyNodeSize(i),o=i instanceof Scene,c=o?_defaultAnchor:i.getAnchorPoint(),l=o;e.getPosition(_tempPos$3);var u=_tempPos$3.x,h=_tempPos$3.y,_=e.getAnchorPoint(),p=e.getScale();if(t.alignFlags&AlignFlags.HORIZONTAL){var d=0,f=0,m=a.width;f=l?(d=visibleRect.left.x,visibleRect.right.x):(d=-c.x*m)+m,d+=t.isAbsoluteLeft?t.left:t.left*m,f-=t.isAbsoluteRight?t.right:t.right*m,r&&(d+=n.x,d*=s.x,f+=n.x,f*=s.x);var y=0,v=_.x,g=p.x;if(g<0&&(v=1-v,g=-g),t.isStretchWidth)y=f-d,0!==g&&(e.width=y/g),u=d+v*y;else if(y=e.width*g,t.isAlignHorizontalCenter){var b=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*m,x=(.5-c.x)*a.width;r&&(b*=s.x,x+=n.x,x*=s.x),u=x+(v-.5)*y+b}else u=t.isAlignLeft?d+v*y:f+(v-1)*y;t._lastSize.width=y}if(t.alignFlags&AlignFlags.VERTICAL){var T=0,C=0,S=a.height;T=l?(C=visibleRect.bottom.y,visibleRect.top.y):(C=-c.y*S)+S,C+=t.isAbsoluteBottom?t.bottom:t.bottom*S,T-=t.isAbsoluteTop?t.top:t.top*S,r&&(C+=n.y,C*=s.y,T+=n.y,T*=s.y);var E=0,w=_.y,A=p.y;if(A<0&&(w=1-w,A=-A),t.isStretchHeight)E=T-C,0!==A&&(e.height=E/A),h=C+w*E;else if(E=e.height*A,t.isAlignVerticalCenter){var $=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*S,O=(.5-c.y)*a.height;r&&($*=s.y,O+=n.y,O*=s.y),h=O+(w-.5)*E+$}else h=t.isAlignBottom?C+w*E:T+(w-1)*E;t._lastSize.height=E}e.setPosition(u,h,_tempPos$3.z),Vec3.set(t._lastPos,u,h,_tempPos$3.z)}}function visitNode$1(e){var t=e.getComponent(WidgetComponent);t&&(align(e,t),t.alignMode!==AlignMode.ALWAYS?t.enabled=!1:activeWidgets.push(t));var i=e.children,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;a.active&&visitNode$1(a)}}function refreshScene(){var e=director.getScene();if(e){if(widgetManager.isAligning=!0,widgetManager._nodesOrderDirty)activeWidgets.length=0,visitNode$1(e),widgetManager._nodesOrderDirty=!1;else{var t=null,i=widgetManager._activeWidgetsIterator;for(i.i=0;i.i<activeWidgets.length;++i.i)(t=activeWidgets[i.i])._dirty&&(align(t.node,t),t._dirty=!1)}widgetManager.isAligning=!1}}var activeWidgets=[];function updateAlignment(e){var t=e.parent;t&&Node$1.isNode(t)&&updateAlignment(t);var i=e.getComponent(WidgetComponent);i&&t&&align(e,i)}var canvasList=[],widgetManager=cc._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new array.MutableForwardIterator(activeWidgets),animationState:null,init:function(e){e.on(Director.EVENT_AFTER_UPDATE,refreshScene),sys.isMobile?window.addEventListener("resize",this.onResized.bind(this)):View.instance.on("design-resolution-changed",this.onResized,this)},add:function(e){this._nodesOrderDirty=!0;var t=e.node.getComponent(UIRenderComponent);if(t){var i=director.root.ui.getScreen(t.visibility);i&&-1===canvasList.indexOf(i)&&(canvasList.push(i),i.node.on("design-resolution-changed",this.onResized,this))}},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=director.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){if(Node$1.isNode(e)){var t=e.getComponent(WidgetComponent);if(t&&t.alignFlags===AlignMode.ALWAYS)return}var i=e.children,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;this.refreshWidgetOnResized(a)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return 1e-10<Math.abs(e-t)?t:e}var r=e.node,n=r.parent;if(n){var s=new Vec3,a=new Vec3(1,1,1);if(e.target&&computeInverseTransForTarget(r,n=e.target,s,a),!t)return;if(!n.getComponent(UITransformComponent))return void cc.warnID(6501,e.node.name);var o=n.getAnchorPoint(),c=getReadonlyNodeSize(n),l=r.getAnchorPoint(),u=r.getPosition(),h=AlignFlags,_=r.getScale(),p=0;if(t&h.LEFT){var d=-o.x*c.width;d+=s.x,d*=a.x,p=u.x-l.x*r.width*_.x-d,e.isAbsoluteLeft||(p/=c.width),p/=a.x,e.left=i(e.left,p)}if(t&h.RIGHT){var f=(1-o.x)*c.width;f+=s.x,p=(f*=a.x)-(u.x+(1-l.x)*r.width*_.x),e.isAbsoluteRight||(p/=c.width),p/=a.x,e.right=i(e.right,p)}if(t&h.TOP){var m=(1-o.y)*c.height;m+=s.y,p=(m*=a.y)-(u.y+(1-l.y)*r.height*_.y),e.isAbsoluteTop||(p/=c.height),p/=a.y,e.top=i(e.top,p)}if(t&h.BOT){var y=-o.y*c.height;y+=s.y,y*=a.y,p=u.y-l.y*r.height*_.y-y,e.isAbsoluteBottom||(p/=c.height),p/=a.y,e.bottom=i(e.bottom,p)}}},updateAlignment:updateAlignment,AlignMode:AlignMode,AlignFlags:AlignFlags};director.on(Director.EVENT_INIT,function(){widgetManager.init(director)});var Aim=function e(t,i,r){_classCallCheck(this,e),this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=i,this.y=r};function linkedList(e,t,i,r,n){var s=0,a=null;if(n===0<signedArea(e,t,i,r))for(s=t;s<i;s+=r)a=insertNode(s,e[s],e[s+1],a);else for(s=i-r;t<=s;s-=r)a=insertNode(s,e[s],e[s+1],a);return a&&equals$1(a,a.next)&&(removeNode(a),a=a.next),a}function filterPoints(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(!e)return e;t=t||e;var i=e,r=!1;do{if(r=!1,i.steiner||!equals$1(i,i.next)&&0!==area(i.prev,i,i.next))i=i.next;else{if(removeNode(i),(i=t=i.prev)===i.next)return null;r=!0}}while(r||i!==t);return t}function earcutLinked(e,t,i,r,n,s){var a=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0;if(e){!a&&s&&indexCurve(e,r,n,s);for(var o=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,s?isEarHashed(e,r,n,s):isEar(e))t.push(c.i/i),t.push(e.i/i),t.push(l.i/i),removeNode(e),e=l.next,o=l.next;else if((e=l)===o){a?1===a?earcutLinked(e=cureLocalIntersections(e,t,i),t,i,r,n,s,2):2===a&&splitEarcut(e,t,i,r,n,s):earcutLinked(filterPoints(e),t,i,r,n,s,1);break}}}function isEar(e){var t=e.prev,i=e,r=e.next;if(0<=area(t,i,r))return!1;for(var n=e.next.next;n!==e.prev;){if(pointInTriangle(t.x,t.y,i.x,i.y,r.x,r.y,n.x,n.y)&&0<=area(n.prev,n,n.next))return!1;n=n.next}return!0}function isEarHashed(e,t,i,r){var n=e.prev,s=e,a=e.next;if(0<=area(n,s,a))return!1;for(var o=n.x<s.x?n.x<a.x?n.x:a.x:s.x<a.x?s.x:a.x,c=n.y<s.y?n.y<a.y?n.y:a.y:s.y<a.y?s.y:a.y,l=n.x>s.x?n.x>a.x?n.x:a.x:s.x>a.x?s.x:a.x,u=n.y>s.y?n.y>a.y?n.y:a.y:s.y>a.y?s.y:a.y,h=zOrder(o,c,t,i,r),_=zOrder(l,u,t,i,r),p=e.nextZ;p&&p.z<=_;){if(p!==e.prev&&p!==e.next&&pointInTriangle(n.x,n.y,s.x,s.y,a.x,a.y,p.x,p.y)&&0<=area(p.prev,p,p.next))return!1;p=p.nextZ}for(p=e.prevZ;p&&p.z>=h;){if(p!==e.prev&&p!==e.next&&pointInTriangle(n.x,n.y,s.x,s.y,a.x,a.y,p.x,p.y)&&0<=area(p.prev,p,p.next))return!1;p=p.prevZ}return!0}function cureLocalIntersections(e,t,i){var r=e;do{var n=r.prev,s=r.next.next;!equals$1(n,s)&&intersects(n,r,r.next,s)&&locallyInside(n,s)&&locallyInside(s,n)&&(t.push(n.i/i),t.push(r.i/i),t.push(s.i/i),removeNode(r),removeNode(r.next),r=e=s),r=r.next}while(r!==e);return r}function splitEarcut(e,t,i,r,n,s){var a=e;do{for(var o=a.next.next;o!==a.prev;){if(a.i!==o.i&&isValidDiagonal(a,o)){var c=splitPolygon(a,o);return a=filterPoints(a,a.next),c=filterPoints(c,c.next),earcutLinked(a,t,i,r,n,s),void earcutLinked(c,t,i,r,n,s)}o=o.next}a=a.next}while(a!==e)}function eliminateHoles(e,t,i,r){var n,s=[],a=0,o=null;for(a=0,n=t.length;a<n;a++)(o=linkedList(e,t[a]*r,a<n-1?t[a+1]*r:e.length,r,!1))&&(o===o.next&&(o.steiner=!0),s.push(getLeftmost(o)));if(s.sort(compareX),!i)return i;for(a=0;a<s.length;a++)eliminateHole(s[a],i),i=filterPoints(i,i.next);return i}function compareX(e,t){return e.x-t.x}function eliminateHole(e,t){if(t=findHoleBridge(e,t)){var i=splitPolygon(t,e);filterPoints(i,i.next)}}function findHoleBridge(e,t){var i=t,r=e.x,n=e.y,s=-1/0,a=null;do{if(n<=i.y&&n>=i.next.y){var o=i.x+(n-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=r&&s<o){if((s=o)===r){if(n===i.y)return i;if(n===i.next.y)return i.next}a=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!a)return null;if(r===s)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(i=a.next;i!==l;)r>=i.x&&i.x>=u&&pointInTriangle(n<h?r:s,n,u,h,n<h?s:r,n,i.x,i.y)&&((c=Math.abs(n-i.y)/(r-i.x))<_||c===_&&i.x>a.x)&&locallyInside(i,e)&&(a=i,_=c),i=i.next;return a}function indexCurve(e,t,i,r){for(var n=e;null===n.z&&(n.z=zOrder(n.x,n.y,t,i,r)),n.prevZ=n.prev,n.nextZ=n.next,(n=n.next)!==e;);n.prevZ.nextZ=null,n.prevZ=null,sortLinked(n)}function sortLinked(e){var t=0,i=null,r=null,n=null,s=null,a=0,o=0,c=0,l=1;do{for(i=e,s=e=null,a=0;i;){for(a++,r=i,t=o=0;t<l&&(o++,r=r.nextZ);t++);for(c=l;0<o||0<c&&r;)0===o?(r=(n=r).nextZ,c--):0!==c&&r?i.z<=r.z?(i=(n=i).nextZ,o--):(r=(n=r).nextZ,c--):(i=(n=i).nextZ,o--),s?s.nextZ=n:e=n,n.prevZ=s,s=n;i=r}s.nextZ=null,l*=2}while(1<a);return e}function zOrder(e,t,i,r,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/n)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)/n)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function getLeftmost(e){for(var t=e,i=e;t.x<i.x&&(i=t),(t=t.next)!==e;);return i}function pointInTriangle(e,t,i,r,n,s,a,o){return 0<=(n-a)*(t-o)-(e-a)*(s-o)&&0<=(e-a)*(r-o)-(i-a)*(t-o)&&0<=(i-a)*(s-o)-(n-a)*(r-o)}function isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!intersectsPolygon(e,t)&&locallyInside(e,t)&&locallyInside(t,e)&&middleInside(e,t)}function area(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function equals$1(e,t){return e.x===t.x&&e.y===t.y}function intersects(e,t,i,r){return!!(equals$1(e,t)&&equals$1(i,r)||equals$1(e,r)&&equals$1(i,t))||0<area(e,t,i)!=0<area(e,t,r)&&0<area(i,r,e)!=0<area(i,r,t)}function intersectsPolygon(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&intersects(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}function locallyInside(e,t){return area(e.prev,e,e.next)<0?0<=area(e,t,e.next)&&0<=area(e,e.prev,t):area(e,t,e.prev)<0||area(e,e.next,t)<0}function middleInside(e,t){for(var i=e,r=!1,n=(e.x+t.x)/2,s=(e.y+t.y)/2;i.y>s!=i.next.y>s&&n<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(r=!r),(i=i.next)!==e;);return r}function splitPolygon(e,t){var i=new Aim(e.i,e.x,e.y),r=new Aim(t.i,t.x,t.y),n=e.next,s=t.prev;return(e.next=t).prev=e,(i.next=n).prev=i,(r.next=i).prev=r,(s.next=r).prev=s,r}function insertNode(e,t,i,r){var n=new Aim(e,t,i);return r?(n.next=r.next,(n.prev=r).next.prev=n,r.next=n):(n.prev=n).next=n,n}function removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function signedArea(e,t,i,r){for(var n=0,s=t,a=i-r;s<i;s+=r)n+=(e[a]-e[s])*(e[s+1]+e[a+1]),a=s;return n}function earcut(e,t,i){i=i||3;var r=t?t.length:0,n=r?t[0]*i:e.length,s=linkedList(e,0,n,i,!0),a=[];if(!s)return a;var o=0,c=0,l=0,u=0,h=0,_=0,p=0;if(r&&(s=eliminateHoles(e,t,s,i)),e.length>80*i){o=l=e[0],c=u=e[1];for(var d=i;d<n;d+=i)(h=e[d])<o&&(o=h),(_=e[d+1])<c&&(c=_),l<h&&(l=h),u<_&&(u=_);p=Math.max(l-o,u-c)}return earcutLinked(s,a,i,o,c,p),a}var PI=Math.PI,min$2=Math.min,max$3=Math.max,cos$1=Math.cos,sin=Math.sin,abs$1=Math.abs,sign$1=Math.sign,KAPPA90=.5522847493;function arc(e,t,i,r,n,s,a){var o,c,l=0,u=0,h=0,_=0,p=0,d=0,f=0,m=0,y=0,v=0,g=0,b=0,x=0,T=0;if(u=s-n,a=a||!1)if(abs$1(u)>=2*PI)u=2*PI;else for(;u<0;)u+=2*PI;else if(abs$1(u)>=2*PI)u=2*-PI;else for(;0<u;)u-=2*PI;for(c=0|max$3(1,min$2(abs$1(u)/(.5*PI)+.5,5)),h=abs$1(4/3*(1-cos$1(o=u/c/2))/sin(o)),a||(h=-h),T=0;T<=c;T++)d=t+(_=cos$1(l=n+u*(T/c)))*r,f=i+(p=sin(l))*r,m=-p*r*h,y=_*r*h,0===T?e.moveTo(d,f):e.bezierCurveTo(v+b,g+x,d-m,f-y,d,f),v=d,g=f,b=m,x=y}function ellipse(e,t,i,r,n){e.moveTo(t-r,i),e.bezierCurveTo(t-r,i+n*KAPPA90,t-r*KAPPA90,i+n,t,i+n),e.bezierCurveTo(t+r*KAPPA90,i+n,t+r,i+n*KAPPA90,t+r,i),e.bezierCurveTo(t+r,i-n*KAPPA90,t+r*KAPPA90,i-n,t,i-n),e.bezierCurveTo(t-r*KAPPA90,i-n,t-r,i-n*KAPPA90,t-r,i),e.close()}function roundRect(e,t,i,r,n,s){if(s<.1)e.rect(t,i,r,n);else{var a=min$2(s,.5*abs$1(r))*sign$1(r),o=min$2(s,.5*abs$1(n))*sign$1(n);e.moveTo(t,i+o),e.lineTo(t,i+n-o),e.bezierCurveTo(t,i+n-o*(1-KAPPA90),t+a*(1-KAPPA90),i+n,t+a,i+n),e.lineTo(t+r-a,i+n),e.bezierCurveTo(t+r-a*(1-KAPPA90),i+n,t+r,i+n-o*(1-KAPPA90),t+r,i+n-o),e.lineTo(t+r,i+o),e.bezierCurveTo(t+r,i+o*(1-KAPPA90),t+r-a*(1-KAPPA90),i,t+r-a,i),e.lineTo(t+a,i),e.bezierCurveTo(t+a*(1-KAPPA90),i,t,i+o*(1-KAPPA90),t,i+o),e.close()}}function tesselateBezier(e,t,i,r,n,s,a,o,c,l,u){var h,_,p,d,f,m,y,v,g,b,x,T,C,S,E,w;10<l||(f=.5*(s+o),m=.5*(a+c),y=.5*((h=.5*(t+r))+(p=.5*(r+s))),v=.5*((_=.5*(i+n))+(d=.5*(n+a))),((E=abs$1((r-o)*(S=c-i)-(n-c)*(C=o-t)))+(w=abs$1((s-o)*S-(a-c)*C)))*(E+w)<e.tessTol*(C*C+S*S)?e.addPoint(o,c,0===u?u|PointFlags.PT_BEVEL:u):(tesselateBezier(e,t,i,h,_,y,v,x=.5*(y+(g=.5*(p+f))),T=.5*(v+(b=.5*(d+m))),l+1,0),tesselateBezier(e,x,T,g,b,f,m,o,c,l+1,u)))}for(var Point=function(){function r(e,t){var i;return _classCallCheck(this,r),(i=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this,e,t))).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return _inherits(r,Vec2),_createClass(r,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),r}(),Path=function(){function e(){_classCallCheck(this,e),this.closed=!1,this.nbevel=0,this.complex=!0,this.points=[],this.reset()}return _createClass(e,[{key:"reset",value:function(){this.closed=!1,this.nbevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),Impl=function(){function e(){_classCallCheck(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Color.WHITE.clone(),this.lineCap=LineCap.BUTT,this.strokeColor=Color.BLACK.clone(),this.lineJoin=LineJoin.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandx=0,this._commandy=0,this._points=[],this._renderDatasPool=new RecyclePool(function(){return new IARenderData},16),this._renderDatas=[],this._curPath=null}return _createClass(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,PointFlags.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,PointFlags.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"bezierCurveTo",value:function(e,t,i,r,n,s){var a=this._curPath,o=a.points[a.points.length-1];o&&(o.x!==e||o.y!==t||i!==n||r!==s?(tesselateBezier(this,o.x,o.y,e,t,i,r,n,s,0,PointFlags.PT_CORNER),this._commandx=n,this._commandy=s):this.lineTo(n,s))}},{key:"quadraticCurveTo",value:function(e,t,i,r){var n=this._commandx,s=this._commandy;this.bezierCurveTo(n+2/3*(e-n),s+2/3*(t-s),i+2/3*(e-i),r+2/3*(t-r),i,r)}},{key:"arc",value:function(e,t,i,r,n,s){arc(this,e,t,i,r,n,s)}},{key:"ellipse",value:function(e,t,i,r){ellipse(this,e,t,i,r),this._curPath.complex=!1}},{key:"circle",value:function(e,t,i){ellipse(this,e,t,i,i),this._curPath.complex=!1}},{key:"rect",value:function(e,t,i,r){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+r),this.lineTo(e,t+r),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,i,r,n){roundRect(this,e,t,i,r,n),this._curPath.complex=!1}},{key:"clear",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var i=this._renderDatas,r=0,n=i.length;r<n;r++){var s=i[r];s&&s.reset()}this._renderDatas.length=0,t&&this._renderDatasPool.reset()}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=this._renderDatasPool.add();return this._renderDatas.push(e),e}},{key:"getRenderDatas",value:function(){return 0===this._renderDatas.length&&this.requestRenderData(),this._renderDatas}},{key:"addPoint",value:function(e,t,i){var r=this._curPath;if(r){var n=this._points,s=r.points,a=n[this.pointsOffset++];a?(a.x=e,a.y=t):(a=new Point(e,t),n.push(a)),a.flags=i,s.push(a)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new Path,this.paths.push(t)),this.pathLength++,this._curPath=t}}]),e}(),MAX_VERTEX=65535,MAX_INDICE=2*MAX_VERTEX,PI$1=Math.PI,min$3=Math.min,max$4=Math.max,ceil=Math.ceil,acos$1=Math.acos,cos$2=Math.cos,sin$1=Math.sin,atan2=Math.atan2,attrBytes=9,attrs=vfmt,positions=[],uvs=[],colors$1=[],indices=[],_renderData=null,_impl=null,_curColor=new Color,vec3_temps=[],i$2=0;i$2<4;i$2++)vec3_temps.push(new Vec3);function curveDivs(e,t,i){var r=2*acos$1(e/(e+i));return max$4(2,ceil(t/r))}function clamp$1(e,t,i){return e<t?t:i<e?i:e}var graphicsAssembler={useModel:!0,createImpl:function(e){return new Impl},updateRenderData:function(e){for(var t=e.impl?e.impl.getRenderDatas():[],i=0,r=t.length;i<r;i++)t[i].material=e.material},fillBuffers:function(e,t){},renderIA:function(e,t){},getRenderData:function(e,t){if(!_impl)return null;var i=_impl.getRenderDatas(),r=i[_impl.dataOffset];if(!r)return null;var n=r,s=n?n.vertexCount+t:0;return(MAX_VERTEX<s||MAX_INDICE<3*s)&&(++_impl.dataOffset,_impl.dataOffset<i.length?r=i[_impl.dataOffset]:(r=_impl.requestRenderData(),i[_impl.dataOffset]=r),r.material=e.material,n=r),n&&n.vertexCount<s&&n.request(t,3*t),r},stroke:function(e){Color.copy(_curColor,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){Color.copy(_curColor,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){var t=director.root.ui.renderScene;e.model&&(e.model.destroy(),t.destroyModel(e.model),e.model=null);var i=e.impl,r=exports.GFXPrimitiveMode.TRIANGLE_LIST,n=i&&i.getRenderDatas();if(n){var s=0;positions.length=0,uvs.length=0,colors$1.length=0,indices.length=0;var a=n,o=Array.isArray(a),c=0;for(a=o?a:a[Symbol.iterator]();;){var l;if(o){if(c>=a.length)break;l=a[c++]}else{if((c=a.next()).done)break;l=c.value}var u=l,h=u.byteCount>>2,_=u.vData;for(s=0;s<h;)positions.push(_[s++]),positions.push(_[s++]),positions.push(_[s++]),uvs.push(_[s++]),uvs.push(_[s++]),colors$1.push(_[s++]),colors$1.push(_[s++]),colors$1.push(_[s++]),colors$1.push(_[s++]);h=u.indiceCount;var p=u.iData;for(s=0;s<h;)indices.push(p[s++])}var d=createMesh({primitiveMode:r,positions:positions,uvs:uvs,colors:colors$1,attributes:attrs,indices:indices},void 0,{calculateBounds:!1});e.model=t.createModel(Model,e.node),e.model.initSubModel(0,d.getSubMesh(0),e.material),e.model.enabled=!0,e.markForUpdateRenderData()}},_expandStroke:function(e){var t=.5*e.lineWidth,i=e.lineCap,r=e.lineJoin,n=e.miterLimit;if(_impl=e.impl){var s=curveDivs(t,PI$1,_impl.tessTol);this._calculateJoins(_impl,t,r,n);for(var a=_impl.paths,o=0,c=_impl.pathOffset,l=_impl.pathLength;c<l;c++){var u=a[c],h=u.points.length;r===LineJoin.ROUND?o+=2*(h+u.nbevel*(s+2)+1):o+=2*(h+5*u.nbevel+1),u.closed||(i===LineCap.ROUND?o+=2*(2*s+2):o+=12)}var _=_renderData=this.getRenderData(e,o);if(_){for(var p=_.vData,d=_.iData,f=_impl.pathOffset,m=_impl.pathLength;f<m;f++){var y=a[f],v=y.points,g=v.length,b=_.vertexStart,x=void 0,T=void 0,C=0,S=0,E=y.closed;if(S=E?(x=v[g-1],T=v[0],C=0,g):(x=v[0],T=v[1],g-(C=1)),!E){var w=new Point(T.x,T.y);w.subtract(x),w.normalize();var A=w.x,$=w.y;i===LineCap.BUTT?this._buttCap(x,A,$,t,0):i===LineCap.SQUARE?this._buttCap(x,A,$,t,t):i===LineCap.ROUND&&this._roundCapStart(x,A,$,t,s)}for(var O=C;O<S;++O)r===LineJoin.ROUND?this._roundJoin(x,T,t,t,s):0!=(T.flags&(PointFlags.PT_BEVEL|PointFlags.PT_INNERBEVEL))?this._bevelJoin(x,T,t,t):(this._vset(T.x+T.dmx*t,T.y+T.dmy*t),this._vset(T.x-T.dmx*t,T.y-T.dmy*t)),x=T,T=v[O+1];if(E){var D=b*attrBytes,k=p.slice(D,D+attrBytes);p.set(k,_.vertexStart*attrBytes),D+=attrBytes,_.vertexStart++,k=p.slice(D,D+attrBytes),p.set(k,_.vertexStart*attrBytes),_.vertexStart++}else{var R=new Point(T.x,T.y);R.subtract(x),R.normalize();var I=R.x,F=R.y;i===LineCap.BUTT?this._buttCap(T,I,F,t,0):i===LineCap.SQUARE?this._buttCap(T,I,F,t,t):i===LineCap.ROUND&&this._roundCapEnd(T,I,F,t,s)}for(var P=_.indiceStart,M=b+2,L=_.vertexStart;M<L;M++)d[P++]=M-2,d[P++]=M-1,d[P++]=M;if((_.indiceStart=P)!==_.indiceCount){var z=new Array(_.indiceCount-P);_.iData.set(z,P)}}_impl=_renderData=null}}},_expandFill:function(e){if(_impl=e.impl){for(var t=_impl.paths,i=0,r=_impl.pathOffset,n=_impl.pathLength;r<n;r++){i+=t[r].points.length}var s=_renderData=this.getRenderData(e,i);if(s){for(var a=s,o=a.vData,c=a.iData,l=_impl.pathOffset,u=_impl.pathLength;l<u;l++){var h=t[l],_=h.points,p=_.length;if(0!==p){for(var d=s.vertexStart,f=0;f<p;++f)this._vset(_[f].x,_[f].y);var m=s.indiceStart;if(h.complex){for(var y=[],v=d,g=s.vertexStart;v<g;v++){var b=v*attrBytes;y.push(o[b++]),y.push(o[b++]),y.push(o[b++])}var x=earcut(y,null,3);if(!x||0===x.length)continue;for(var T=0,C=x.length;T<C;T++)c[m++]=x[T]+d}else for(var S=d,E=d+2,w=a.vertexStart;E<w;E++)c[m++]=S,c[m++]=E-1,c[m++]=E;if((a.indiceStart=m)!==a.indiceCount){var A=new Array(a.indiceCount-m);a.iData.set(A,m)}}}_impl=_renderData=null}}},_calculateJoins:function(e,t,i,r){var n=0;0<t&&(n=1/t);for(var s=e.paths,a=e.pathOffset,o=e.pathLength;a<o;a++)for(var c=s[a],l=c.points,u=l.length,h=l[u-1],_=l[0],p=c.nbevel=0;p<u;p++){var d,f,m=h.dy,y=-h.dx,v=_.dy,g=-_.dx;if(_.dmx=.5*(m+v),_.dmy=.5*(y+g),1e-6<(d=_.dmx*_.dmx+_.dmy*_.dmy)){var b=1/d;600<b&&(b=600),_.dmx*=b,_.dmy*=b}0<_.dx*h.dy-h.dx*_.dy&&(_.flags|=PointFlags.PT_LEFT),d*(f=max$4(11,min$3(h.len,_.len)*n))*f<1&&(_.flags|=PointFlags.PT_INNERBEVEL),_.flags&PointFlags.PT_CORNER&&(d*r*r<1||i===LineJoin.BEVEL||i===LineJoin.ROUND)&&(_.flags|=PointFlags.PT_BEVEL),0!=(_.flags&(PointFlags.PT_BEVEL|PointFlags.PT_INNERBEVEL))&&c.nbevel++,h=_,_=l[p+1]}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,r=e.pathLength;i<r;i++){var n=t[i],s=n.points,a=s[s.length-1],o=s[0];a.equals(o)&&(n.closed=!0,s.pop(),a=s[s.length-1]);for(var c=0,l=s.length;c<l;c++){var u=new Point(o.x,o.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=o,o=s[c+1]}}},_chooseBevel:function(e,t,i,r){var n=i.x,s=i.y,a=0,o=0,c=0,l=0;return 0!==e?(a=n+t.dy*r,o=s-t.dx*r,c=n+i.dy*r,l=s-i.dx*r):(a=c=n+i.dmx*r,o=l=s+i.dmy*r),[a,o,c,l]},_buttCap:function(e,t,i,r,n){var s=e.x-t*n,a=e.y-i*n,o=i,c=-t;this._vset(s+o*r,a+c*r),this._vset(s-o*r,a-c*r)},_roundCapStart:function(e,t,i,r,n){for(var s=e.x,a=e.y,o=i,c=-t,l=0;l<n;l++){var u=l/(n-1)*PI$1,h=cos$2(u)*r,_=sin$1(u)*r;this._vset(s-o*h-t*_,a-c*h-i*_),this._vset(s,a)}this._vset(s+o*r,a+c*r),this._vset(s-o*r,a-c*r)},_roundCapEnd:function(e,t,i,r,n){var s=e.x,a=e.y,o=i,c=-t;this._vset(s+o*r,a+c*r),this._vset(s-o*r,a-c*r);for(var l=0;l<n;l++){var u=l/(n-1)*PI$1,h=cos$2(u)*r,_=sin$1(u)*r;this._vset(s,a),this._vset(s-o*h+t*_,a-c*h+i*_)}},_roundJoin:function(e,t,i,r,n){var s=e.dy,a=-e.dx,o=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&PointFlags.PT_LEFT)){var h=this._chooseBevel(t.flags&PointFlags.PT_INNERBEVEL,e,t,i),_=h[0],p=h[1],d=h[2],f=h[3],m=atan2(-a,-s),y=atan2(-c,-o);m<y&&(y-=2*PI$1),this._vset(_,p),this._vset(l-s*r,t.y-a*r);for(var v=clamp$1(ceil((m-y)/PI$1)*n,2,n),g=0;g<v;g++){var b=m+g/(v-1)*(y-m),x=l+cos$2(b)*r,T=u+sin$1(b)*r;this._vset(l,u),this._vset(x,T)}this._vset(d,f),this._vset(l-o*r,u-c*r)}else{var C=this._chooseBevel(t.flags&PointFlags.PT_INNERBEVEL,e,t,-r),S=C[0],E=C[1],w=C[2],A=C[3],$=atan2(a,s),O=atan2(c,o);O<$&&(O+=2*PI$1),this._vset(l+s*r,u+a*r,0),this._vset(S,E,0);for(var D=clamp$1(ceil((O-$)/PI$1)*n,2,n),k=0;k<D;k++){var R=$+k/(D-1)*(O-$),I=l+cos$2(R)*i,F=u+sin$1(R)*i;this._vset(I,F,0),this._vset(l,u,0)}this._vset(l+o*r,u+c*r),this._vset(w,A)}},_bevelJoin:function(e,t,i,r){var n=0,s=0,a=0,o=0,c=0,l=0,u=0,h=0,_=e.dy,p=-e.dx,d=t.dy,f=-t.dx;if(t.flags&PointFlags.PT_LEFT){var m=this._chooseBevel(t.flags&PointFlags.PT_INNERBEVEL,e,t,i);c=m[0],l=m[1],u=m[2],h=m[3],this._vset(c,l,0),this._vset(t.x-_*r,t.y-p*r,0),this._vset(u,h,0),this._vset(t.x-d*r,t.y-f*r,0)}else{var y=this._chooseBevel(t.flags&PointFlags.PT_INNERBEVEL,e,t,-r);n=y[0],s=y[1],a=y[2],o=y[3],this._vset(t.x+_*i,t.y+p*i,0),this._vset(n,s),this._vset(t.x+d*i,t.y+f*i,0),this._vset(a,o)}},_vset:function(e,t){if(_renderData){var i=_renderData,r=i.vertexStart*attrBytes,n=i.vData;n[r++]=e,n[r++]=t,n[r++]=0,n[r++]=1,n[r++]=1,Color.toArray(n,_curColor,r),i.vertexStart++}}},graphicsAssemblerManager={getAssembler:function(e){return graphicsAssembler}};GraphicsComponent.Assembler=graphicsAssemblerManager;var FontLetterDefinition=function e(){_classCallCheck(this,e),this.u=0,this.v=0,this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.validDefinition=!1,this.xAdvance=0},FontAtlas=function(){function e(){_classCallCheck(this,e),this._letterDefinitions={}}return _createClass(e,[{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var r=i[t],n=new FontLetterDefinition;mixin(n,this._letterDefinitions[r]),e[r]=n}return e}},{key:"assignLetterDefinitions",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var r=i[t],n=e[r];mixin(this._letterDefinitions[r],n)}}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var r=i[t],n=this._letterDefinitions[r];n.width*=e,n.height*=e,n.offsetX*=e,n.offsetY*=e,n.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e){return this._letterDefinitions.hasOwnProperty(e.charCodeAt(0))?this._letterDefinitions[e.charCodeAt(0)]:null}},{key:"letterDefinitions",get:function(){return this._letterDefinitions}}]),e}();cc.FontAtlas=FontAtlas;var LetterInfo=function e(){_classCallCheck(this,e),this.char="",this.valid=!0,this.positionX=0,this.positionY=0,this.lineIndex=0},_tmpRect=new Rect,_comp=null,_horizontalKernings=[],_lettersInfo=[],_linesWidth=[],_linesOffsetX=[],_labelDimensions=new Size,_fontAtlas=null,_fntConfig=null,_numberOfLines=0,_textDesiredHeight=0,_letterOffsetY=0,_tailoredTopY=0,_tailoredBottomY=0,_bmfontScale=1,_spriteFrame=null,_lineSpacing=0,_string="",_fontSize=0,_originFontSize=0,_contentSize=new Size,_hAlign=0,_vAlign=0,_spacingX=0,_lineHeight=0,_overflow=0,_isWrapText=!1,_labelWidth=0,_labelHeight=0,_maxLineWidth=0,bmfontUtils={updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&_comp!==e&&(_comp=e,this._updateProperties(),this._updateContent(),_comp.actualFontSize=_fontSize,_comp.node.setContentSize(_contentSize),_comp.renderData.vertDirty=_comp.renderData.uvDirty=!1,_comp=null,this._resetProperties())},_updateFontScale:function(){_bmfontScale=_fontSize/_originFontSize},_updateProperties:function(){if(_comp){var e=_comp.font;if(e){if(_spriteFrame=e.spriteFrame,_fntConfig=e.fntConfig,!(_fontAtlas=_comp.fontAtlas)){_fontAtlas=new FontAtlas;for(var t=_fntConfig.fontDefDictionary,i=0,r=Object.keys(t);i<r.length;i++){var n=r[i],s=new FontLetterDefinition,a=t[n].rect;s.offsetX=t[n].xOffset,s.offsetY=t[n].yOffset,s.width=a.width,s.height=a.height,s.u=a.x,s.v=a.y,s.textureID=0,s.validDefinition=!0,s.xAdvance=t[n].xAdvance,_fontAtlas.addLetterDefinitions(n,s)}_comp.fontAtlas=_fontAtlas}_string=_comp.string.toString(),_fontSize=_comp.fontSize,_originFontSize=_fntConfig.fontSize;var o=_comp.node.getContentSize();_contentSize.width=o.width,_contentSize.height=o.height,_hAlign=_comp.horizontalAlign,_vAlign=_comp.verticalAlign,_spacingX=_comp.spacingX,_overflow=_comp.overflow,_lineHeight=_comp.lineHeight,_isWrapText=_overflow!==exports.Overflow.NONE&&(_overflow===exports.Overflow.RESIZE_HEIGHT||_comp.enableWrapText),this._setupBMFontOverflowMetrics()}}},_resetProperties:function(){_spriteFrame=_fntConfig=_fontAtlas=null},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=_string,t=e.length,i=_fntConfig.kerningDict,r=_horizontalKernings,n=-1,s=0;s<t;++s){var a=e.charCodeAt(s),o=i[n<<16|65535&a]||0;r[s]=s<t-1?o:0,n=a}},_multilineTextWrap:function(e){var t=_string.length,i=0,r=0,n=0,s=0,a=0,o=0,c=0,l=null,u=new Vec2;this._updateFontScale();for(var h=_fontAtlas.letterDefinitions,_=0;_<t;){var p=_string.charAt(_);if("\n"!==p){for(var d=e(_string,_,t),f=o,m=c,y=a,v=r,g=!1,b=0;b<d;++b){var x=_+b;if("\r"!==(p=_string.charAt(x)))if(l=_fontAtlas&&_fontAtlas.getLetterDefinitionForChar(p)){var T=v+l.offsetX*_bmfontScale;if(_isWrapText&&0<_maxLineWidth&&0<r&&T+l.width*_bmfontScale>_maxLineWidth&&!isUnicodeSpace(p)){_linesWidth.push(a),i++,n-=_lineHeight*_bmfontScale+_lineSpacing,g=!(r=a=0);break}u.x=T,u.y=n-l.offsetY*_bmfontScale,this._recordLetterInfo(h,u,p,x,i),x+1<_horizontalKernings.length&&x<t-1&&(v+=_horizontalKernings[x+1]),v+=l.xAdvance*_bmfontScale+_spacingX,y=u.x+l.width*_bmfontScale,f<u.y&&(f=u.y),m>u.y-l.height*_bmfontScale&&(m=u.y-l.height*_bmfontScale)}else this._recordPlaceholderInfo(x,p),console.log("Can't find letter definition in texture atlas "+_fntConfig.atlasName+" for letter:"+p);else this._recordPlaceholderInfo(x,p)}g||(r=v,o<f&&(o=f),m<c&&(c=m),s<(a=y)&&(s=a),_+=d)}else _linesWidth.push(a),i++,r=a=0,n-=_lineHeight*_bmfontScale+_lineSpacing,this._recordPlaceholderInfo(_,p),_++}return _linesWidth.push(a),_textDesiredHeight=(_numberOfLines=i+1)*_lineHeight*_bmfontScale,1<_numberOfLines&&(_textDesiredHeight+=(_numberOfLines-1)*_lineSpacing),_contentSize.width=_labelWidth,_contentSize.height=_labelHeight,_labelWidth<=0&&(_contentSize.width=parseFloat(s.toFixed(2))),_labelHeight<=0&&(_contentSize.height=parseFloat(_textDesiredHeight.toFixed(2))),_tailoredTopY=_contentSize.height,(_tailoredBottomY=0)<o&&(_tailoredTopY=_contentSize.height+o),c<-_textDesiredHeight&&(_tailoredBottomY=_textDesiredHeight+c),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var r=e.charAt(t);if(isUnicodeCJK(r)||"\n"===r||isUnicodeSpace(r))return 1;var n=1,s=_fontAtlas&&_fontAtlas.getLetterDefinitionForChar(r);if(!s)return n;for(var a=s._xAdvance*_bmfontScale+_spacingX,o=t+1;o<i&&(r=e.charAt(o),s=_fontAtlas&&_fontAtlas.getLetterDefinitionForChar(r));++o){if(a+s._offsetX*_bmfontScale+s._width*_bmfontScale>_maxLineWidth&&!isUnicodeSpace(r)&&0<_maxLineWidth)return n;if(a+=s._xAdvance*_bmfontScale+_spacingX,"\n"===r||isUnicodeSpace(r)||isUnicodeCJK(r))break;n++}return n},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=_lettersInfo.length){var i=new LetterInfo;_lettersInfo.push(i)}_lettersInfo[e].char=t,_lettersInfo[e].valid=!1},_recordLetterInfo:function(e,t,i,r,n){if(r>=_lettersInfo.length){var s=new LetterInfo;_lettersInfo.push(s)}var a=i.charCodeAt(0);_lettersInfo[r].lineIndex=n,_lettersInfo[r].char=i,_lettersInfo[r].valid=e[a].validDefinition,_lettersInfo[r].positionX=t.x,_lettersInfo[r].positionY=t.y},_alignText:function(){_textDesiredHeight=0,_linesWidth.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),_overflow===exports.Overflow.SHRINK&&0<_fontSize&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||_overflow===exports.Overflow.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),_fontSize=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=_fontSize,i=_lineHeight,r=_fontAtlas,n=0,s=r?r.cloneLetterDefinition():{},a=!0;e();){var o=t-++n;if(a=!1,o<=0)break;var c=o/t;r&&(r.assignLetterDefinitions(s),r.scaleFontLetterDefinition(c)),_lineHeight=i*c,this._multilineTextWrapByWord(),this._computeAlignmentOffset()}_lineHeight=i,r&&r.assignLetterDefinitions(s),a||0<=t-n&&this._scaleFontSizeDown(t-n)},_isVerticalClamp:function(){return _textDesiredHeight>_contentSize.height},_isHorizontalClamp:function(){if(_fontAtlas){for(var e=_fontAtlas.letterDefinitions,t=!1,i=0,r=_string.length;i<r;++i){var n=_lettersInfo[i];if(n.valid){var s=e[n.char],a=n.positionX+s.width/2*_bmfontScale,o=n.lineIndex;if(0<_labelWidth)if(_isWrapText){if(_linesWidth[o]>_contentSize.width&&(a>_contentSize.width||a<0)){t=!0;break}}else if(a>_contentSize.width){t=!0;break}}}return t}},_isHorizontalClamped:function(e,t){var i=_linesWidth[t],r=e>_contentSize.width||e<0;return _isWrapText?i>_contentSize.width&&r:r},_updateQuads:function(){if(!_comp)return!1;var e=_fontAtlas?_fontAtlas.letterDefinitions:{},t=_spriteFrame,i=_comp.node,r=_comp.renderData;r.dataLength=r.vertexCount=r.indiceCount=0;for(var n=i.getAnchorPoint(),s=_contentSize,a=n.x*s.width,o=n.y*s.height,c=!0,l=0,u=_string.length;l<u;++l){var h=_lettersInfo[l];if(h.valid){var _=e[h.char.charCodeAt(0)];if(_){_tmpRect.height=_.height,_tmpRect.width=_.width,_tmpRect.x=_.u,_tmpRect.y=_.v;var p=h.positionY+_letterOffsetY;if(0<_labelHeight){if(_tailoredTopY<p){var d=p-_tailoredTopY;_tmpRect.y+=d,_tmpRect.height-=d,p-=d}p-_.height*_bmfontScale<_tailoredBottomY&&(_tmpRect.height=p<_tailoredBottomY?0:p-_tailoredBottomY)}var f=h.lineIndex,m=h.positionX+_.width/2*_bmfontScale+_linesOffsetX[f];if(0<_labelWidth&&this._isHorizontalClamped(m,f))if(_overflow===exports.Overflow.CLAMP)_tmpRect.width=0;else if(_overflow===exports.Overflow.SHRINK){if(_contentSize.width>_.width){c=!1;break}_tmpRect.width=0}if(_spriteFrame&&0<_tmpRect.height&&0<_tmpRect.width){var y=_spriteFrame.isRotated(),v=_spriteFrame.getOriginalSize(),g=_spriteFrame.getRect(),b=_spriteFrame.getOffset(),x=b.x+(v.width-g.width)/2,T=b.y-(v.height-g.height)/2;if(y){var C=_tmpRect.x;_tmpRect.x=g.x+g.height-_tmpRect.y-_tmpRect.height-T,_tmpRect.y=C+g.y-x,_tmpRect.y<0&&(_tmpRect.height=_tmpRect.height+T)}else _tmpRect.x+=g.x-x,_tmpRect.y+=g.y+T;var S=h.positionX+_linesOffsetX[h.lineIndex];this.appendQuad(_comp,t,_tmpRect,y,S-a,p-o,_bmfontScale)}}else console.warn("Can't find letter in this bitmap-font")}}return c},appendQuad:function(e,t,i,r,n,s,a){},_computeAlignmentOffset:function(){switch(_linesOffsetX.length=0,_hAlign){case exports.HorizontalTextAlignment.LEFT:for(var e=0;e<_numberOfLines;++e)_linesOffsetX.push(0);break;case exports.HorizontalTextAlignment.CENTER:for(var t=0,i=_linesWidth.length;t<i;t++)_linesOffsetX.push((_contentSize.width-_linesWidth[t])/2);break;case exports.HorizontalTextAlignment.RIGHT:for(var r=0,n=_linesWidth.length;r<n;r++)_linesOffsetX.push(_contentSize.width-_linesWidth[r])}switch(_vAlign){case exports.VerticalTextAlignment.TOP:_letterOffsetY=_contentSize.height;break;case exports.VerticalTextAlignment.CENTER:_letterOffsetY=(_contentSize.height+_textDesiredHeight)/2;break;case exports.VerticalTextAlignment.BOTTOM:_letterOffsetY=_textDesiredHeight}},_setupBMFontOverflowMetrics:function(){var e=_contentSize.width,t=_contentSize.height;_overflow===exports.Overflow.RESIZE_HEIGHT&&(t=0),_overflow===exports.Overflow.NONE&&(t=e=0),_labelWidth=e,_labelHeight=t,_labelDimensions.width=e,_labelDimensions.height=t,_maxLineWidth=e}},bmfont={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){fillMeshVertices3D(e.node,t,e.renderData,e.color)},appendQuad:function(e,t,i,r,n,s,a){var o=e.renderData;if(o){var c=o.dataLength;o.dataLength+=4,o.vertexCount=o.dataLength,o.indiceCount=o.dataLength/2*3;var l=o.datas,u=t.width,h=t.height,_=i.width,p=i.height,d=0,f=0,m=0,y=0;r?(d=i.x/u,y=(i.x+p)/u,f=(i.y+_)/h,m=i.y/h,l[c].u=d,l[c].v=m,l[c+1].u=d,l[c+1].v=f,l[c+2].u=y,l[c+2].v=m,l[c+3].u=y,l[c+3].v=f):(d=i.x/u,y=(i.x+_)/u,f=(i.y+p)/h,m=i.y/h,l[c].u=d,l[c].v=f,l[c+1].u=y,l[c+1].v=f,l[c+2].u=d,l[c+2].v=m,l[c+3].u=y,l[c+3].v=m),l[c].x=n,l[c].y=s-p*a,l[c+1].x=n+_*a,l[c+1].y=s-p*a,l[c+2].x=n,l[c+2].y=s,l[c+3].x=n+_*a,l[c+3].y=s}}};addon(bmfont,bmfontUtils);var Overflow=LabelComponent.Overflow,WHITE=Color.WHITE.clone(),space=2,TextAlignment=LabelComponent.HorizontalAlign,VerticalTextAlignment=LabelComponent.VerticalAlign,LetterInfo$1=function e(){_classCallCheck(this,e),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},FontLetterDefinition$1=function e(){_classCallCheck(this,e),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},_backgroundStyle="rgba(255, 255, 255, 0.005)",LetterTexture=function(){function i(e,t){_classCallCheck(this,i),this.spriteframe=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.hash=void 0,this._lastImage=null,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}return _createClass(i,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.spriteframe&&(this.spriteframe.texture.destroy(),this.spriteframe.destroy(),this.spriteframe=null)}},{key:"_updateProperties",value:function(){if(this.spriteframe=new SpriteFrame,this.data=LabelComponent.CanvasPool.get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=safeMeasureText(this.context,this.char);this.width=parseFloat(e.toFixed(2)),this.height=this.labelInfo.fontSize}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this._lastImage&&(this._lastImage._texture.destroy(),this._lastImage.destroy());var t=new ImageAsset(this.canvas),i=(this._lastImage=t)._texture;this.spriteframe.texture=i}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,i=this.canvas.width,r=this.canvas.height;e.textAlign="center",e.textBaseline="middle",e.clearRect(0,0,i,r),e.fillStyle=_backgroundStyle,e.fillRect(0,0,i,r),e.font=t.fontDesc;var n=i/2,s=r/2,a=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(a.r,", ").concat(a.g,", ").concat(a.b,", ",1,")"),t.isOutlined){var o=t.out||WHITE;e.strokeStyle="rgba(".concat(o.r,", ").concat(o.g,", ").concat(o.b,", ").concat(o.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,n,s)}e.fillText(this.char,n,s),this.spriteframe.texture.updateImage()}}}]),i}(),LetterRenderTexture=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,Texture2D),_createClass(e,[{key:"initWithSize",value:function(e,t,i){var r=2<arguments.length&&void 0!==i?i:PixelFormat.RGBA8888;this.destroy(),this.reset({width:e,height:t,format:r}),this.loaded=!0,this.emit("load")}},{key:"drawTextureAt",value:function(e,t,i){var r=this.getGFXTexture();if(e._image&&r){var n=this._getGFXDevice();if(n){var s={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:t,y:i,z:0},texExtent:{width:e._image.width,height:e._image.height,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}};n.copyTexImagesToTexture([e._image.data],r,[s])}else console.warn("Unable to get device")}}}]),e}(),LetterAtlas=function(){function i(e,t){_classCallCheck(this,i),this.texture=void 0,this._x=space,this._y=space,this._nexty=space,this._width=0,this._height=0,this._letterDefinitions=new Map,this._imageAssets=[],this._dirty=!1,this.texture=new LetterRenderTexture,this.texture.initWithSize(e,t),this._width=e,this._height=t,director.on(Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return _createClass(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),_createClass(i,[{key:"insertLetterTexture",value:function(e){var t=e.spriteframe,i=director.root.device;if(!(t&&this.texture&&i&&t._image))return null;var r=t.width,n=t.height;if(this._x+r+space>this._width&&(this._x=space,this._y=this._nexty),this._y+n>this._nexty&&(this._nexty=this._y+n+space),this._nexty>this._height)return null;this.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var s=new FontLetterDefinition$1;return s.u=this._x,s.v=this._y,s.texture=this.texture,s.valid=!0,s.w=e.width,s.h=e.height,s.xAdvance=e.width,this._x+=r+space,this._letterDefinitions.set(e.hash,s),s}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=space,this._y=space,this._nexty=space,this._letterDefinitions.clear()}},{key:"destroy",value:function(){this.reset(),this.texture&&this.texture.destroy()}},{key:"beforeSceneLoad",value:function(){this.destroy();var e=new LetterRenderTexture;e.initWithSize(this._width,this._height),this.texture=e}},{key:"getLetter",value:function(e){return this._letterDefinitions.get(e)}},{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var r=i[t],n=new FontLetterDefinition$1;mixin(n,this._letterDefinitions[r]),e[r]=n}return e}},{key:"assignLetterDefinitions",value:function(e){var i=this;e.forEach(function(e,t){mixin(i._letterDefinitions[t],e)})}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var r=i[t],n=this._letterDefinitions[r];n.w*=e,n.h*=e,n.offsetX*=e,n.offsetY*=e,n.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e,t){var i=e.charCodeAt(0)+t.hash,r=this._letterDefinitions.get(i);if(!r){var n=new LetterTexture(e,t);n.updateRenderData(),r=this.insertLetterTexture(n),n.destroy()}return r}}]),i}(),_tmpRect$1=new Rect,_comp$1=null,_horizontalKernings$1=[],_lettersInfo$1=[],_linesWidth$1=[],_linesOffsetX$1=[],_labelDimensions$1=new Size,_fontAtlas$1=null,_numberOfLines$1=0,_textDesiredHeight$1=0,_letterOffsetY$1=0,_tailoredTopY$1=0,_tailoredBottomY$1=0,_bmfontScale$1=1,_lineSpacing$1=0,_string$1="",_fontSize$1=0,_originFontSize$1=0,_contentSize$1=new Size,_hAlign$1=0,_vAlign$1=0,_spacingX$1=0,_lineHeight$1=0,_overflow$1=0,_isWrapText$1=!1,_labelWidth$1=0,_labelHeight$1=0,_maxLineWidth$1=0,_atlasWidth=1024,_atlasHeight=1024,_fontFamily="",_isBold=!1,_labelInfo={fontSize:0,lineHeight:0,hash:"",fontFamily:"",fontDesc:"Arial",hAlign:0,vAlign:0,color:WHITE,isOutlined:!1,out:WHITE,margin:0},letterFont={getAssemblerData:function(){return(_fontAtlas$1=_fontAtlas$1||new LetterAtlas(_atlasWidth,_atlasHeight)).texture},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&_comp$1!==e&&(_comp$1=e,this._updateFontFamily(e),_labelInfo.fontFamily=_fontFamily,this._updateProperties(),_labelInfo.fontDesc=this._getFontDesc(),this._updateContent(),_comp$1.actualFontSize=_fontSize$1,_comp$1.node.setContentSize(_contentSize$1),_comp$1.renderData.vertDirty=_comp$1.renderData.uvDirty=!1,_comp$1=null,this._resetProperties())},_updateFontScale:function(){_bmfontScale$1=_fontSize$1/_originFontSize$1},_updateProperties:function(){if(_comp$1){_string$1=_comp$1.string.toString(),_fontSize$1=_comp$1.fontSize,_originFontSize$1=_fontSize$1;var e=_comp$1.node.getContentSize();_contentSize$1.width=e.width,_contentSize$1.height=e.height,_hAlign$1=_comp$1.horizontalAlign,_vAlign$1=_comp$1.verticalAlign,_spacingX$1=_comp$1.spacingX,_overflow$1=_comp$1.overflow,_lineHeight$1=_comp$1.lineHeight,_isBold=_comp$1.isBold,_isWrapText$1=_overflow$1!==Overflow.NONE&&(_overflow$1===Overflow.RESIZE_HEIGHT||_comp$1.enableWrapText);var t=_comp$1.getComponent(LabelOutlineComponent);t&&t.enabled?(_labelInfo.isOutlined=!0,_labelInfo.margin=t.width,_labelInfo.out=t.color,_labelInfo.out.a=t.color.a*_comp$1.color.a/255):(_labelInfo.isOutlined=!1,_labelInfo.margin=0),_labelInfo.lineHeight=_lineHeight$1,_labelInfo.fontSize=_fontSize$1,_labelInfo.fontFamily=_fontFamily,_labelInfo.color=_comp$1.color,_labelInfo.hash=this._computeHash(_labelInfo),this._setupBMFontOverflowMetrics()}},_updateFontFamily:function(i){i.useSystemFont?_fontFamily=i.fontFamily:i.font?i.font._nativeAsset?_fontFamily=i.font._nativeAsset:(_fontFamily=loader.getRes(i.font.nativeUrl)||"")||loader.load(i.font.nativeUrl,function(e,t){_fontFamily=t||"Arial",i.font&&(i.font._nativeAsset=t),i.updateRenderData(!0)}):_fontFamily="Arial"},_computeHash:function(e){var t=e.color.toHEX("#rrggbb"),i="";return e.isOutlined&&(i=e.out.toHEX("#rrggbb")),""+e.fontSize+e.fontFamily+t+i},_getFontDesc:function(){var e=_fontSize$1.toString()+"px ";return e+=_fontFamily,_isBold&&(e="bold "+e),e},_resetProperties:function(){},_updateContent:function(){this._updateFontScale(),this._alignText()},_computeHorizontalKerningForText:function(){},_multilineTextWrap:function(e){var t=_string$1.length,i=0,r=0,n=0,s=0,a=0,o=0,c=0,l=null,u=new Vec2(0,0);this._updateFontScale();for(var h=0;h<t;){var _=_string$1.charAt(h);if("\n"!==_){for(var p=e(_string$1,h,t),d=o,f=c,m=a,y=r,v=!1,g=0;g<p;++g){var b=h+g;if("\r"!==(_=_string$1.charAt(b)))if(l=_fontAtlas$1&&_fontAtlas$1.getLetterDefinitionForChar(_,_labelInfo)){var x=y+l.offsetX*_bmfontScale$1;if(_isWrapText$1&&0<_maxLineWidth$1&&0<r&&x+l.w*_bmfontScale$1>_maxLineWidth$1&&!isUnicodeSpace(_)){_linesWidth$1.push(a),i++,n-=_lineHeight$1*_bmfontScale$1+_lineSpacing$1,v=!(r=a=0);break}u.x=x,u.y=n-l.offsetY*_bmfontScale$1,this._recordLetterInfo(u,_,b,i),b+1<_horizontalKernings$1.length&&b<t-1&&(y+=_horizontalKernings$1[b+1]),y+=l.xAdvance*_bmfontScale$1+_spacingX$1,m=u.x+l.w*_bmfontScale$1,d<u.y&&(d=u.y),f>u.y-l.h*_bmfontScale$1&&(f=u.y-l.h*_bmfontScale$1)}else this._recordPlaceholderInfo(b,_);else this._recordPlaceholderInfo(b,_)}v||(r=y,o<d&&(o=d),f<c&&(c=f),s<(a=m)&&(s=a),h+=p)}else _linesWidth$1.push(a),i++,r=a=0,n-=_lineHeight$1*_bmfontScale$1+_lineSpacing$1,this._recordPlaceholderInfo(h,_),h++}return _linesWidth$1.push(a),_textDesiredHeight$1=(_numberOfLines$1=i+1)*_lineHeight$1*_bmfontScale$1,1<_numberOfLines$1&&(_textDesiredHeight$1+=(_numberOfLines$1-1)*_lineSpacing$1),_contentSize$1.width=_labelWidth$1,_contentSize$1.height=_labelHeight$1,_labelWidth$1<=0&&(_contentSize$1.width=parseFloat(s.toFixed(2))),_labelHeight$1<=0&&(_contentSize$1.height=parseFloat(_textDesiredHeight$1.toFixed(2))),_tailoredTopY$1=_contentSize$1.height,(_tailoredBottomY$1=0)<o&&(_tailoredTopY$1=_contentSize$1.height+o),c<-_textDesiredHeight$1&&(_tailoredBottomY$1=_textDesiredHeight$1+c),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var r=e.charAt(t);if(isUnicodeCJK(r)||"\n"===r||isUnicodeSpace(r))return 1;if(_fontAtlas$1){var n=1,s=_fontAtlas$1.getLetterDefinitionForChar(r,_labelInfo);if(!s)return n;for(var a=s.xAdvance*_bmfontScale$1+_spacingX$1,o=t+1;o<i&&(r=e.charAt(o),s=_fontAtlas$1.getLetterDefinitionForChar(r,_labelInfo));++o){if(a+s.offsetX*_bmfontScale$1+s.w*_bmfontScale$1>_maxLineWidth$1&&!isUnicodeSpace(r)&&0<_maxLineWidth$1)return n;if(a+=s.xAdvance*_bmfontScale$1+_spacingX$1,"\n"===r||isUnicodeSpace(r)||isUnicodeCJK(r))break;n++}return n}},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=_lettersInfo$1.length){var i=new LetterInfo$1;_lettersInfo$1.push(i)}_lettersInfo$1[e].char=t,_lettersInfo$1[e].hash=t.charCodeAt(0)+_labelInfo.hash,_lettersInfo$1[e].valid=!1},_recordLetterInfo:function(e,t,i,r){if(i>=_lettersInfo$1.length){var n=new LetterInfo$1;_lettersInfo$1.push(n)}var s=t.charCodeAt(0)+_labelInfo.hash;_lettersInfo$1[i].line=r,_lettersInfo$1[i].char=t,_lettersInfo$1[i].hash=s;var a=_fontAtlas$1&&_fontAtlas$1.getLetter(s);_lettersInfo$1[i].valid=!!a&&!!a.valid,_lettersInfo$1[i].x=e.x,_lettersInfo$1[i].y=e.y},_alignText:function(){_textDesiredHeight$1=0,_linesWidth$1.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),this._updateQuads()},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),_fontSize$1=e,t&&this._updateContent()},_isVerticalClamp:function(){return _textDesiredHeight$1>_contentSize$1.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=_string$1.length;t<i;++t){var r=_lettersInfo$1[t];if(r.valid){var n=_fontAtlas$1.getLetter(r.hash);if(!n)continue;var s=r.x+n.w*_bmfontScale$1,a=r.line;if(0<_labelWidth$1)if(_isWrapText$1){if(_linesWidth$1[a]>_contentSize$1.width&&(s>_contentSize$1.width||s<0)){e=!0;break}}else if(s>_contentSize$1.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var i=_linesWidth$1[t],r=e>_contentSize$1.width||e<0;return _isWrapText$1?i>_contentSize$1.width&&r:r},_updateQuads:function(){if(_comp$1&&_fontAtlas$1){var e=_fontAtlas$1.texture,t=_comp$1.node,i=_comp$1.renderData;i.dataLength=i.vertexCount=i.indiceCount=0;for(var r=_contentSize$1,n=t.getAnchorPoint(),s=n.x*r.width,a=n.y*r.height,o=!0,c=0,l=_string$1.length;c<l;++c){var u=_lettersInfo$1[c];if(u.valid){var h=_fontAtlas$1.getLetter(u.hash);if(h){_tmpRect$1.height=h.h,_tmpRect$1.width=h.w,_tmpRect$1.x=h.u,_tmpRect$1.y=h.v;var _=u.y+_letterOffsetY$1;if(0<_labelHeight$1){if(_tailoredTopY$1<_){var p=_-_tailoredTopY$1;_tmpRect$1.y+=p,_tmpRect$1.height-=p,_-=p}_-h.h*_bmfontScale$1<_tailoredBottomY$1&&(_tmpRect$1.height=_<_tailoredBottomY$1?0:_-_tailoredBottomY$1)}var d=u.line,f=u.x+h.w/2*_bmfontScale$1+_linesOffsetX$1[d];if(0<_labelWidth$1&&this._isHorizontalClamped(f,d))if(_overflow$1===Overflow.CLAMP)_tmpRect$1.width=0;else if(_overflow$1===Overflow.SHRINK){if(_contentSize$1.width>h.w){o=!1;break}_tmpRect$1.width=0}if(0<_tmpRect$1.height&&0<_tmpRect$1.width){var m=u.x+_linesOffsetX$1[u.line];this.appendQuad(i,e,_tmpRect$1,!1,m-s,_-a,_bmfontScale$1)}}}}return o}},appendQuad:function(e,t,i,r,n,s,a){},_computeAlignmentOffset:function(){switch(_linesOffsetX$1.length=0,_hAlign$1){case TextAlignment.LEFT:for(var e=0;e<_numberOfLines$1;++e)_linesOffsetX$1.push(0);break;case TextAlignment.CENTER:for(var t=0,i=_linesWidth$1.length;t<i;t++)_linesOffsetX$1.push((_contentSize$1.width-_linesWidth$1[t])/2);break;case TextAlignment.RIGHT:for(var r=0,n=_linesWidth$1.length;r<n;r++)_linesOffsetX$1.push(_contentSize$1.width-_linesWidth$1[r])}switch(_vAlign$1){case VerticalTextAlignment.TOP:_letterOffsetY$1=_contentSize$1.height;break;case VerticalTextAlignment.CENTER:_letterOffsetY$1=(_contentSize$1.height+_textDesiredHeight$1)/2-(_lineHeight$1-_fontSize$1)/2;break;case VerticalTextAlignment.BOTTOM:_letterOffsetY$1=(_contentSize$1.height+_textDesiredHeight$1)/2-(_lineHeight$1-_fontSize$1)}},_setupBMFontOverflowMetrics:function(){var e=_contentSize$1.width,t=_contentSize$1.height;_overflow$1===Overflow.RESIZE_HEIGHT&&(t=0),_overflow$1===Overflow.NONE&&(t=e=0),_labelWidth$1=e,_labelHeight$1=t,_labelDimensions$1.width=e,_labelDimensions$1.height=t,_maxLineWidth$1=e}},WHITE$1=new Color(255,255,255,255),letter={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var i=e.node;WHITE$1.a=e.color.a,fillMeshVertices3D(i,t,e.renderData,WHITE$1)}},appendQuad:bmfont.appendQuad};addon(letter,letterFont);var Overflow$1=LabelComponent.Overflow,WHITE$2=Color.WHITE.clone(),OUTLINE_SUPPORTED=isChildClassOf(LabelOutlineComponent,Component),_context=null,_canvas=null,_texture=null,_fontDesc="",_string$2="",_fontSize$2=0,_drawFontsize=0,_splitedStrings=[],_canvasSize=new Size,_lineHeight$2=0,_hAlign$2=0,_vAlign$2=0,_color$1=new Color,_fontFamily$1="",_overflow$2=Overflow$1.NONE,_isWrapText$2=!1,_isOutlined=!1,_outlineColor=new Color,_outlineWidth=0,_margin=0,_isBold$1=!1,_isItalic=!1,_isUnderline=!1,_canvasPool=new CanvasPool,ttfUtils={getAssemblerData:function(){var e=document.createElement("canvas"),t={canvas:e,context:e.getContext("2d")};return t.canvas.width=t.canvas.height=1,t},resetAssemblerData:function(e){cc.game.renderType===cc.game.RENDER_TYPE_CANVAS&&e&&_canvasPool.put(e)},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&(this._updateFontFamly(e),this._updateProperties(e),this._calculateLabelFont(),this._calculateSplitedStrings(),this._updateLabelDimensions(),this._calculateTextBaseline(),this._updateTexture(),e.actualFontSize=_fontSize$2,e.node.setContentSize(_canvasSize),this.updateVerts(e),e.markForUpdateRenderData(!1),_texture=_canvas=_context=null)},updateVerts:function(e){},_updateFontFamly:function(i){i.useSystemFont?_fontFamily$1=i.fontFamily:i.font?i.font._nativeAsset?_fontFamily$1=i.font._nativeAsset:loader.load(i.font.nativeUrl,function(e,t){_fontFamily$1=t||"Arial",i.updateRenderData(!0)}):_fontFamily$1="Arial"},_updateProperties:function(e){var t=e.assemblerData;if(t){_context=t.context,_canvas=t.canvas,_texture=e.spriteFrame,_string$2=e.string.toString(),_fontSize$2=e.fontSize,_drawFontsize=_fontSize$2,_overflow$2=e.overflow,_canvasSize.width=e.node.width,_canvasSize.height=e.node.height,_lineHeight$2=e.lineHeight,_hAlign$2=e.horizontalAlign,_vAlign$2=e.verticalAlign,_color$1=e.color,_isBold$1=e.isBold,_isItalic=e.isItalic,_isUnderline=e.isUnderline,_isWrapText$2=_overflow$2!==Overflow$1.NONE&&(_overflow$2===Overflow$1.RESIZE_HEIGHT||e.enableWrapText);var i=OUTLINE_SUPPORTED&&e.getComponent(LabelOutlineComponent);i&&i.enabled?(_isOutlined=!0,_margin=_outlineWidth=i.width,(_outlineColor=i.color.clone()).a=_outlineColor.a*e.color.a/255):(_isOutlined=!1,_margin=0)}},_calculateFillTextStartPosition:function(){var e,t,i=this._getLineHeight(),r=_splitedStrings.length;return e=_hAlign$2===exports.HorizontalTextAlignment.RIGHT?_canvasSize.width-_margin:_hAlign$2===exports.HorizontalTextAlignment.CENTER?_canvasSize.width/2:0+_margin,t=_vAlign$2===exports.VerticalTextAlignment.TOP?0:_vAlign$2===exports.VerticalTextAlignment.CENTER?_canvasSize.height/2-i*(r-1)/2:_canvasSize.height-i*(r-1),new Vec2(e,t)},_updateTexture:function(){if(_context&&_canvas){_context.clearRect(0,0,_canvas.width,_canvas.height),_context.font=_fontDesc;var e,t=this._calculateFillTextStartPosition(),i=this._getLineHeight();_context.lineJoin="round",_context.fillStyle="rgba(".concat(_color$1.r,", ").concat(_color$1.g,", ").concat(_color$1.b,", ").concat(_color$1.a/255,")");for(var r=0;r<_splitedStrings.length;++r){if(_isOutlined){var n=_outlineColor||WHITE$2;_context.strokeStyle="rgba(".concat(n.r,", ").concat(n.g,", ").concat(n.b,", ").concat(n.a/255,")"),_context.lineWidth=2*_outlineWidth,_context.strokeText(_splitedStrings[r],t.x,t.y+r*i)}_context.fillText(_splitedStrings[r],t.x,t.y+r*i),_isUnderline&&(e=this._calculateUnderlineStartPosition(),_context.save(),_context.beginPath(),_context.lineWidth=_fontSize$2/8,_context.strokeStyle="rgba(".concat(_color$1.r,", ").concat(_color$1.g,", ").concat(_color$1.b,", ").concat(_color$1.a/255,")"),_context.moveTo(e.x,e.y+r*i-1),_context.lineTo(e.x+_canvas.width,e.y+r*i-1),_context.stroke(),_context.restore())}if(_texture){var s;s=_texture instanceof SpriteFrame?_texture.texture:_texture;var a=0===_canvas.width||0===_canvas.height;s.reset({width:_canvas.width,height:_canvas.height,mipmapLevel:a?0:1}),a||s.uploadData(_canvas)}}},_calculateUnderlineStartPosition:function(){var e,t,i=this._getLineHeight(),r=_splitedStrings.length;return e=0+_margin,t=_vAlign$2===exports.VerticalTextAlignment.TOP?_fontSize$2:_vAlign$2===exports.VerticalTextAlignment.CENTER?_canvasSize.height/2-i*(r-1)/2+_fontSize$2/2:_canvasSize.height-i*(r-1),new Vec2(e,t)},_updateLabelDimensions:function(){if(_context){var e=_string$2.split("\n");if(_overflow$2===Overflow$1.RESIZE_HEIGHT)_canvasSize.height=_splitedStrings.length*this._getLineHeight();else if(_overflow$2===Overflow$1.NONE){var t=0,i=0,r=_splitedStrings=e,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=safeMeasureText(_context,a);t=o<t?t:o}i=_splitedStrings.length*this._getLineHeight(),_canvasSize.width=parseFloat(t.toFixed(2))+2*_margin,_canvasSize.height=parseFloat(i.toFixed(2)),_isItalic&&(_canvasSize.width+=_drawFontsize*Math.tan(.20943951))}_canvas&&(_canvas.width=_canvasSize.width,_canvas.height=_canvasSize.height)}},_calculateTextBaseline:function(){var e,t;e=_hAlign$2===exports.HorizontalTextAlignment.RIGHT?"right":_hAlign$2===exports.HorizontalTextAlignment.CENTER?"center":"left",t=_vAlign$2===exports.VerticalTextAlignment.TOP?"top":_vAlign$2===exports.VerticalTextAlignment.CENTER?"middle":"bottom",_context&&(_context.textAlign=e,_context.textBaseline=t)},_calculateSplitedStrings:function(){if(_context){var e=_string$2.split("\n");if(_isWrapText$2){_splitedStrings=[];var t=_canvasSize.width-2*_margin,i=e,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=fragmentText(s,safeMeasureText(_context,s),t,this._measureText(_context));_splitedStrings=_splitedStrings.concat(a)}}else _splitedStrings=e}},_getFontDesc:function(){var e=_fontSize$2.toString()+"px ";return e+=_fontFamily$1,_isBold$1&&(e="bold "+e),_isItalic&&(e="italic "+e),e},_getLineHeight:function(){var e=_lineHeight$2;return 0|(e=0===e?_fontSize$2:e*_fontSize$2/_drawFontsize)},_calculateParagraphLength:function(e,t){var i=[],r=e,n=Array.isArray(r),s=0;for(r=n?r:r[Symbol.iterator]();;){var a;if(n){if(s>=r.length)break;a=r[s++]}else{if((s=r.next()).done)break;a=s.value}var o=safeMeasureText(t,a);i.push(o)}return i},_measureText:function(t){return function(e){return safeMeasureText(t,e)}},_calculateLabelFont:function(){if(_context&&(_fontDesc=this._getFontDesc(),_context.font=_fontDesc,_overflow$2===Overflow$1.SHRINK)){var e=_string$2.split("\n"),t=this._calculateParagraphLength(e,_context);_splitedStrings=e;var i=0,r=0,n=0;if(_isWrapText$2){var s=_canvasSize.width-2*_margin,a=_canvasSize.height-2*_margin;if(s<0||a<0)return _fontDesc=this._getFontDesc(),void(_context.font=_fontDesc);r=1+a,n=1+s;for(var o=_fontSize$2+1,c=[],l=!0,u=0|o;a<r||s<n;){if(l?o=u/2|0:u=o=u-1,o<=0){logID(4003);break}for(_fontSize$2=o,_fontDesc=this._getFontDesc(),_context.font=_fontDesc,_splitedStrings=[],i=r=0;i<e.length;++i){var h=0,_=safeMeasureText(_context,e[i]);for(c=fragmentText(e[i],_,s,this._measureText(_context));h<c.length;){n=safeMeasureText(_context,c[h]),r+=this._getLineHeight(),++h}_splitedStrings=_splitedStrings.concat(c)}l&&(a<r?u=0|o:(l=!1,r=1+a))}}else{for(r=e.length*this._getLineHeight(),i=0;i<e.length;++i)n<t[i]&&(n=t[i]);var p=(_canvasSize.width-2*_margin)/n,d=_canvasSize.height/r;_fontSize$2=_drawFontsize*Math.min(1,p,d)|0,_fontDesc=this._getFontDesc(),_context.font=_fontDesc}}}},WHITE$3=Color.WHITE.clone(),ttf={createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indiceCount=6;var i=t.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;for(var r=5,n=0;n<4;n++)Color.toArray(i,WHITE$3,r),r+=9;return t},fillBuffers:function(e,t){var i=e.renderData,r=i.datas,n=e.node,s=t.currBufferBatch,a=s.byteOffset>>2,o=s.indiceOffset,c=s.vertexOffset;s.request()||(s=t.currBufferBatch,c=o=0);var l=s.vData,u=s.iData,h=i.vData,_=r[0],p=r[3];n.updateWorldTransform();var d=n._pos,f=n._rot,m=n._scale,y=_.x*m.x,v=p.x*m.x,g=_.y*m.y,b=p.y*m.y,x=f.x,T=f.y,C=f.z,S=f.w,E=x*T,w=C*S,A=x*x-T*T,$=S*S-C*C,O=$+A,D=2*(E-w),k=$-A,R=2*(E+w),I=d.x,F=d.y;h[0]=O*y+D*g+I,h[1]=k*g+R*y+F,h[9]=O*v+D*g+I,h[10]=k*g+R*v+F,h[18]=O*y+D*b+I,h[19]=k*b+R*y+F,h[27]=O*v+D*b+I,h[28]=k*b+R*v+F,l.set(h,a),u[o++]=c,u[o++]=c+1,u[o++]=c+2,u[o++]=c+2,u[o++]=c+1,u[o++]=c+3},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,r=i.width,n=i.height,s=i.anchorX*r,a=i.anchorY*n,o=t.datas;o[0].x=-s,o[0].y=-a,o[3].x=r-s,o[3].y=n-a}}};addon(ttf,ttfUtils);var labelAssembler={getAssembler:function(e){var t=ttf;return e.font instanceof BitmapFont?t=bmfont:e.cacheMode===LabelComponent.CacheMode.CHAR&&(sys.browserType===sys.BROWSER_TYPE_WECHAT_GAME_SUB?warn("sorry, subdomain does not support CHAR mode currently!"):t=letter),t}};LabelComponent.Assembler=labelAssembler;var _stencilManager=StencilManager.sharedManager,maskAssembler={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t},updateRenderData:function(e){var t=e.renderData;t&&t.vertDirty&&this.updateVerts&&this.updateVerts(e)},updateVerts:function(e){var t=e.renderData;if(t){var i,r,n,s,a=e.node,o=t.datas,c=a.width,l=a.height,u=a.anchorX*c,h=a.anchorY*l;i=-u,r=-h,n=c-u,s=l-h,o[0].x=i,o[0].y=r,o[3].x=n,o[3].y=s,t.vertDirty=!1}},fillBuffers:function(e,t){_stencilManager.pushMask(e),_stencilManager.clear(),e.clearGraphics.updateAssembler(t),_stencilManager.enterLevel(),e.graphics.updateAssembler(t),_stencilManager.enableMask()}},maskEndAssembler={fillBuffers:function(e,t){_stencilManager.exitMask()}},StartAssembler={getAssembler:function(){return maskAssembler}},PostAssembler={getAssembler:function(){return maskEndAssembler}};MaskComponent.Assembler=StartAssembler,MaskComponent.PostAssembler=PostAssembler;var FillType$1=SpriteComponent.FillType,matrix=new Mat4,barFilled={useModel:!1,updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t){var r=i.uvDirty,n=i.vertDirty;if(!r&&!n)return;var s=e.fillStart,a=e.fillRange;a<0&&(s+=a,a=-a),a=(a=1<(a=s+a)?1:a)<0?0:a;var o=(s=(s=1<s?1:s)<0?0:s)+(a=(a-=s)<0?0:a);o=1<o?1:o,r&&this.updateUVs(e,s,o),n&&(this.updateVerts&&this.updateVerts(e,s,o),this.updateWorldVerts(e))}},updateUVs:function(e,t,i){var r=e.spriteFrame,n=e.renderData,s=n.datas,a=r.width,o=r.height,c=r.getRect(),l=0,u=0,h=0,_=0,p=0,d=0,f=0,m=0,y=0,v=0;switch(r.isRotated()?(l=c.x/a,u=(c.y+c.width)/o,h=p=l,f=y=(c.x+c.height)/a,d=v=u,_=m=c.y/o):(l=c.x/a,u=(c.y+c.height)/o,h=f=l,p=y=(c.x+c.width)/a,_=d=u,m=v=c.y/o),e.fillType){case FillType$1.HORIZONTAL:s[0].u=h+(p-h)*t,s[0].v=_+(d-_)*t,s[1].u=h+(p-h)*i,s[1].v=_+(d-_)*i,s[2].u=f+(y-f)*t,s[2].v=m+(v-m)*t,s[3].u=f+(y-f)*i,s[3].v=m+(v-m)*i;break;case FillType$1.VERTICAL:s[0].u=h+(f-h)*t,s[0].v=_+(m-_)*t,s[1].u=p+(y-p)*t,s[1].v=d+(v-d)*t,s[2].u=h+(f-h)*i,s[2].v=_+(m-_)*i,s[3].u=p+(y-p)*i,s[3].v=d+(v-d)*i;break;default:errorID(2626)}n.uvDirty=!1},updateVerts:function(e,t,i){var r=e.renderData,n=r.datas,s=e.node,a=s.width,o=s.height,c=s.anchorX*a,l=s.anchorY*o,u=-c,h=-l,_=a-c,p=o-l,d=0;switch(e.fillType){case FillType$1.HORIZONTAL:d=u+(_-u)*i,u=u+(_-u)*t,_=d;break;case FillType$1.VERTICAL:d=h+(p-h)*i,h=h+(p-h)*t,p=d;break;default:errorID(2626)}n[4].x=u,n[4].y=h,n[5].x=_,n[5].y=h,n[6].x=u,n[6].y=p,n[7].x=_,n[7].y=p,r.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indiceCount=6;var i=t.datas,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}s.z=0}return t},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(matrix);for(var r=0;r<4;r++){var n=i[r+4],s=i[r];Vec3.transformMat4(s,n,matrix)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e),fillVerticesWithoutCalc3D(e.node,t,e.renderData,e.color)}},PI_2=2*Math.PI,EPSILON$4=1e-6,_vertPos=[new Vec2,new Vec2,new Vec2,new Vec2],_vertices=new Array(4),_uvs=new Array(8),_intersectPoint_1=[new Vec2,new Vec2,new Vec2,new Vec2],_intersectPoint_2=[new Vec2,new Vec2,new Vec2,new Vec2],_center=new Vec2,_triangles=[new Vec2,new Vec2,new Vec2,new Vec2];function _calcInsectedPoints(e,t,i,r,n,s,a){var o=Math.sin(s);o=Math.abs(o)>EPSILON$4?o:0;var c=Math.cos(s),l=0,u=0;if(0!==(c=Math.abs(c)>EPSILON$4?c:0)){if(l=o/c,0<(e-n.x)*c){var h=n.y+l*(e-n.x);a[0].x=e,a[0].y=h}if(0<(t-n.x)*c){var _=n.y+l*(t-n.x);a[2].x=t,a[2].y=_}}if(0!==o){if(u=c/o,0<(r-n.y)*o){var p=n.x+u*(r-n.y);a[3].x=p,a[3].y=r}if(0<(i-n.y)*o){var d=n.x+u*(i-n.y);a[1].x=d,a[1].y=i}}}function _calculateVertices(e){var t=e.node,i=t.width,r=t.height,n=t.anchorX*i,s=t.anchorY*r,a=-n,o=-s,c=i-n,l=r-s,u=_vertices;u[0]=a,u[1]=o,u[2]=c,u[3]=l;var h=e.fillCenter,_=_center.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,p=_center.y=Math.min(Math.max(0,h.y),1)*(l-o)+o;_vertPos[0].x=_vertPos[3].x=a,_vertPos[1].x=_vertPos[2].x=c,_vertPos[0].y=_vertPos[1].y=o,_vertPos[2].y=_vertPos[3].y=l;var d=_triangles,f=Array.isArray(d),m=0;for(d=f?d:d[Symbol.iterator]();;){var y;if(f){if(m>=d.length)break;y=d[m++]}else{if((m=d.next()).done)break;y=m.value}var v=y;Vec2.set(v,0,0)}_!==u[0]&&Vec2.set(_triangles[0],3,0),_!==u[2]&&Vec2.set(_triangles[2],1,2),p!==u[1]&&Vec2.set(_triangles[1],0,1),p!==u[3]&&Vec2.set(_triangles[3],2,3)}function _calculateUVs(e){var t=e.width,i=e.height,r=e.getRect(),n=0,s=0,a=0,o=0,c=_uvs;e.isRotated()?(n=r.x/t,s=(r.x+r.height)/t,a=r.y/i,o=(r.y+r.width)/i,c[0]=c[2]=n,c[4]=c[6]=s,c[3]=c[7]=o,c[1]=c[5]=a):(n=r.x/t,s=(r.x+r.width)/t,a=r.y/i,o=(r.y+r.height)/i,c[0]=c[4]=n,c[2]=c[6]=s,c[1]=c[3]=o,c[5]=c[7]=a)}function _getVertAngle(e,t){var i=t.x-e.x,r=t.y-e.y;if(0==i&&0==r)return 0;if(0==i)return 0<r?.5*Math.PI:1.5*Math.PI;var n=Math.atan(r/i);return i<0&&(n+=Math.PI),n}function _generateTriangle(e,t,i,r,n){var s=_vertices,a=s[0],o=s[1],c=s[2],l=s[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=r.x,e[t+1].y=r.y,e[t+2].x=n.x,e[t+2].y=n.y;_generateUV((i.x-a)/(c-a),(i.y-o)/(l-o),e,t),_generateUV((r.x-a)/(c-a),(r.y-o)/(l-o),e,t+1),_generateUV((n.x-a)/(c-a),(n.y-o)/(l-o),e,t+2)}function _generateUV(e,t,i,r){var n=_uvs,s=n[0]+(n[2]-n[0])*e,a=n[4]+(n[6]-n[4])*e,o=n[1]+(n[3]-n[1])*e,c=n[5]+(n[7]-n[5])*e,l=i[r];l.u=s+(a-s)*t,l.v=o+(c-o)*t}for(var radialFilled={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t&&(i.vertDirty||i.uvDirty)){var r=i.datas,n=e.fillStart,s=e.fillRange;for(s<0&&(n+=s,s=-s);1<=n;)n-=1;for(;n<0;)n+=1;var a=(n*=PI_2)+(s*=PI_2);_calculateVertices(e),_calculateUVs(t),_calcInsectedPoints(_vertices[0],_vertices[2],_vertices[1],_vertices[3],_center,n,_intersectPoint_1),_calcInsectedPoints(_vertices[0],_vertices[2],_vertices[1],_vertices[3],_center,n+s,_intersectPoint_2);for(var o=0,c=0;c<4;++c){var l=_triangles[c];if(l)if(PI_2<=s)i.dataLength=o+3,_generateTriangle(r,o,_center,_vertPos[l.x],_vertPos[l.y]),o+=3;else{var u=_getVertAngle(_center,_vertPos[l.x]),h=_getVertAngle(_center,_vertPos[l.y]);h<u&&(h+=PI_2),u-=PI_2,h-=PI_2;for(var _=0;_<3;++_)a<=u||(n<=u?(i.dataLength=o+3,_generateTriangle(r,o,_center,_vertPos[l.x],a<=h?_intersectPoint_2[c]:_vertPos[l.y]),o+=3):h<=n||(h<=a?(i.dataLength=o+3,_generateTriangle(r,o,_center,_intersectPoint_1[c],_vertPos[l.y])):(i.dataLength=o+3,_generateTriangle(r,o,_center,_intersectPoint_1[c],_intersectPoint_2[c])),o+=3)),u+=PI_2,h+=PI_2}}i.indiceCount=i.vertexCount=o,i.vertDirty=i.uvDirty=!1}},fillBuffers:function(e,t){fillVertices3D(e.node,t,e.renderData,e.color)}},vec3_temps$1=[],i$3=0;i$3<4;i$3++)vec3_temps$1.push(new Vec3);var _dec$1h,_dec2$U,_dec3$E,_dec4$y,_class$1j,_class2$14,_descriptor$10,_descriptor2$R,_descriptor3$C,_descriptor4$x,_temp$1b,simple={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&this.updateVerts(e),i.uvDirty&&this.updateUvs(e))},fillBuffers:function(e,t){if(null!==e){var i=e.renderData.datas,r=e.node,n=t.currBufferBatch,s=n.byteOffset>>2,a=n.indiceOffset,o=n.vertexOffset;n.request()||(n=t.currBufferBatch,o=a=s=0);var c=n.vData,l=n.iData,u=e.renderData.vData,h=i[0],_=i[3],p=r.worldMatrix,d=p.m00,f=p.m01,m=p.m04,y=p.m05,v=p.m12,g=p.m13,b=h.x,x=_.x,T=h.y,C=_.y,S=d*b,E=d*x,w=f*b,A=f*x,$=m*T,O=m*C,D=y*T,k=y*C;u[0]=S+$+v,u[1]=w+D+g,u[9]=E+$+v,u[10]=A+D+g,u[18]=S+O+v,u[19]=w+k+g,u[27]=E+O+v,u[28]=A+k+g,c.set(u,s),l[a++]=o,l[a++]=o+1,l[a++]=o+2,l[a++]=o+2,l[a++]=o+1,l[a++]=o+3}},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,r=t.datas,n=i.width,s=i.height,a=i.anchorX*n,o=i.anchorY*s,c=0,l=0,u=0,h=0;if(e.trim)c=-a,l=-o,u=n-a,h=s-o;else{var _=e.spriteFrame,p=_.getOriginalSize(),d=_.getRect(),f=p.width,m=p.height,y=d.width,v=d.height,g=_.getOffset(),b=n/f,x=s/m,T=g.x+(f-y)/2,C=g.x-(f-y)/2;c=T*b-a,l=(g.y+(m-v)/2)*x-o,u=n+C*b-a,h=s+(g.y-(m-v)/2)*x-o}r[0].x=c,r[0].y=l,r[0].z=0,r[3].x=u,r[3].y=h,r[3].z=0,t.vertDirty=!1}},updateUvs:function(e){var t=e.renderData,i=t.vData,r=e.spriteFrame.uv;i[3]=r[0],i[4]=r[1],i[12]=r[2],i[13]=r[3],i[21]=r[4],i[22]=r[5],i[30]=r[6],i[31]=r[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,i=5,r=e.color,n=r.r/255,s=r.g/255,a=r.b/255,o=r.a/255,c=0;c<4;c++)t[i]=n,t[i+1]=s,t[i+2]=a,t[i+3]=o,i+=9}},vec3_temp$1=new Vec3,matrix$1=new Mat4,sliced={useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indiceCount=54,t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&i.vertDirty&&(this.updateVerts(e),this.updateWorldVerts(e))},updateVerts:function(e){var t=e.renderData,i=t.datas,r=e.node,n=r.width,s=r.height,a=r.anchorX*n,o=r.anchorY*s,c=e.spriteFrame,l=c.insetLeft,u=c.insetRight,h=c.insetTop,_=c.insetBottom,p=n-l-u,d=s-h-_,f=n/(l+u),m=s/(h+_);f=isNaN(f)||1<f?1:f,m=isNaN(m)||1<m?1:m,p=p<0?0:p,d=d<0?0:d,i[0].x=-a,i[0].y=-o,i[1].x=l*f-a,i[1].y=_*m-o,i[2].x=i[1].x+p,i[2].y=i[1].y+d,i[3].x=n-a,i[3].y=s-o,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);var i=t.currBufferBatch,r=e.renderData,n=r.datas,s=i.byteOffset>>2,a=r.vertexCount,o=i.indiceOffset,c=i.vertexOffset,l=e.spriteFrame.uvSliced;i.request(a,r.indiceCount)||(i=t.currBufferBatch,c=o=s=0);for(var u=i.vData,h=i.iData,_=4;_<20;++_){var p=n[_],d=l[_-4];u[s++]=p.x,u[s++]=p.y,u[s++]=p.z,u[s++]=d.u,u[s++]=d.v,Color.toArray(u,e.color,s),s+=4}for(var f=0;f<3;++f)for(var m=0;m<3;++m){var y=c+4*f+m;h[o++]=y,h[o++]=y+1,h[o++]=y+4,h[o++]=y+1,h[o++]=y+5,h[o++]=y+4}},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(matrix$1);for(var r=0;r<4;++r)for(var n=i[r],s=0;s<4;++s){var a=i[s],o=i[4+4*r+s];Vec3.set(vec3_temp$1,a.x,n.y,0),Vec3.transformMat4(o,vec3_temp$1,matrix$1)}}},SpriteType$1=SpriteComponent.Type,FillType$2=SpriteComponent.FillType,spriteAssembler={getAssembler:function(e){var t=simple,i=e;switch(i.type){case SpriteType$1.SLICED:t=sliced;break;case SpriteType$1.FILLED:t=i.fillType===FillType$2.RADIAL?radialFilled:barFilled}return t}};SpriteComponent.Assembler=spriteAssembler,cc.UI={MeshBuffer:MeshBuffer,UIVertexFormat:UIVertexFormat,barFilled:barFilled,radialFilled:radialFilled,simple:simple,sliced:sliced,ttf:ttf,bmfont:bmfont,letter:letter,mask:maskAssembler,maskEnd:maskEndAssembler,graphics:graphicsAssembler,spriteAssembler:spriteAssembler,graphicsAssembler:graphicsAssemblerManager,labelAssembler:labelAssembler};var _dec$1i,_dec2$V,_dec3$F,_dec4$z,_dec5$u,_class$1k,_class2$15,_descriptor$11,_descriptor2$S,_descriptor3$D,_descriptor4$y,_descriptor5$p,_descriptor6$g,_descriptor7$e,_descriptor8$e,_class3$z,_temp$1c,_dec$1j,_class$1l,_class2$16,_descriptor$12,_descriptor2$T,_temp$1d,_dec2$W,_class4$6,_class5$6,_descriptor3$E,_descriptor4$z,_temp2$6,_dec3$G,_class7$1,_class8$1,_descriptor5$q,_descriptor6$h,_descriptor7$f,_class9,_temp3$1,_dec$1k,_dec2$X,_dec3$H,_dec4$A,_dec5$v,_dec6$q,_class$1m,_class2$17,_descriptor$13,_descriptor2$U,_descriptor3$F,_descriptor4$A,_descriptor5$r,_descriptor6$i,_descriptor7$g,_class3$A,_temp$1e,_dec$1l,_dec2$Y,_dec3$I,_dec4$B,_dec5$w,_dec6$r,_dec7$j,_dec8$b,_dec9$9,_dec10$8,_dec11$7,_dec12$6,_dec13$3,_class$1n,_class2$18,_descriptor$14,_descriptor2$V,_descriptor3$G,_descriptor4$B,_descriptor5$s,_descriptor6$j,_descriptor7$h,_temp$1f,_dec$1m,_dec2$Z,_dec3$J,_class$1o,_class2$19,_descriptor$15,_descriptor2$W,_temp$1g,_dec$1n,_dec2$_,_dec3$K,_dec4$C,_dec5$x,_dec6$s,_class$1p,_class2$1a,_descriptor$16,_descriptor2$X,_descriptor3$H,_descriptor4$C,_descriptor5$t,_temp$1h,BillboardComponent=(_dec$1h=ccclass("cc.BillboardComponent"),_dec2$U=menu("Components/Billboard"),_dec3$E=property({type:Texture2D}),_dec4$y=property({type:Texture2D}),_dec$1h(_class$1j=_dec2$U(_class$1j=executeInEditMode((_descriptor$10=_applyDecoratedDescriptor((_class2$14=_temp$1b=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"_texture",_descriptor$10,_assertThisInitialized(e)),_initializerDefineProperty(e,"_height",_descriptor2$R,_assertThisInitialized(e)),_initializerDefineProperty(e,"_width",_descriptor3$C,_assertThisInitialized(e)),_initializerDefineProperty(e,"_rotation",_descriptor4$x,_assertThisInitialized(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new Vec4(1,1,0,0),e}return _inherits(t,Component),_createClass(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*toDegree(this._rotation))/100},set:function(e){this._rotation=toRadian(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),_createClass(t,[{key:"onEnable",value:function(){this._model||this.createModel(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"createModel",value:function(){this._mesh=createMesh({primitiveMode:exports.GFXPrimitiveMode.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[Color.WHITE.r,Color.WHITE.g,Color.WHITE.b,Color.WHITE.a,Color.WHITE.r,Color.WHITE.g,Color.WHITE.b,Color.WHITE.a,Color.WHITE.r,Color.WHITE.g,Color.WHITE.b,Color.WHITE.a,Color.WHITE.r,Color.WHITE.g,Color.WHITE.b,Color.WHITE.a],attributes:[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RG32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8UI,isNormalized:!0}],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1}),this._model=this._getRenderScene().createModel(Model,this.node),null==this._material&&(this._material=new Material,this._material.copy(builtinResMgr.get("default-billboard-material"))),this._model.initSubModel(0,this._mesh.getSubMesh(0),this._material)}}]),t}()).prototype,"_texture",[_dec3$E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_applyDecoratedDescriptor(_class2$14.prototype,"texture",[_dec4$y],Object.getOwnPropertyDescriptor(_class2$14.prototype,"texture"),_class2$14.prototype),_descriptor2$R=_applyDecoratedDescriptor(_class2$14.prototype,"_height",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_applyDecoratedDescriptor(_class2$14.prototype,"height",[property],Object.getOwnPropertyDescriptor(_class2$14.prototype,"height"),_class2$14.prototype),_descriptor3$C=_applyDecoratedDescriptor(_class2$14.prototype,"_width",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_applyDecoratedDescriptor(_class2$14.prototype,"width",[property],Object.getOwnPropertyDescriptor(_class2$14.prototype,"width"),_class2$14.prototype),_descriptor4$x=_applyDecoratedDescriptor(_class2$14.prototype,"_rotation",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_applyDecoratedDescriptor(_class2$14.prototype,"rotation",[property],Object.getOwnPropertyDescriptor(_class2$14.prototype,"rotation"),_class2$14.prototype),_class$1j=_class2$14))||_class$1j)||_class$1j)||_class$1j),_vertex_attrs=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGBA32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD1,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8,isNormalized:!0}],_temp_v1=new Vec3,_temp_v2=new Vec3,LineModel=function(){function r(e,t){var i;return _classCallCheck(this,r),(i=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this,e,t)))._capacity=void 0,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=null,i._vertCount=0,i._indexCount=0,i._capacity=100,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:exports.GFXBufferUsageBit.INDIRECT,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:GFX_DRAW_INFO_SIZE,stride:1}),i}return _inherits(r,Model),_createClass(r,[{key:"setCapacity",value:function(e){this._capacity=e,this.createBuffer()}},{key:"createBuffer",value:function(){this._vertSize=0;var e=_vertex_attrs,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;n.offset=this._vertSize,this._vertSize+=GFXFormatInfos[n.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),r=0,n=0;n<this._capacity-1;++n){var s=2*n;i[r++]=s,i[r++]=1+s,i[r++]=2+s,i[r++]=3+s,i[r++]=2+s,i[r++]=1+s}var a=this._device.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return a.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:a,indirectBuffer:this._iaInfoBuffer,attributes:_vertex_attrs,primitiveMode:exports.GFXPrimitiveMode.TRIANGLE_LIST,flatBuffers:[]},this.setSubModelMesh(0,this._subMeshData),t}},{key:"addLineVertexData",value:function(e,t,i){if(1<e.length){var r=0;Vec3.subtract(_temp_v1,e[1],e[0]),this._vdataF32[r++]=e[0].x,this._vdataF32[r++]=e[0].y,this._vdataF32[r++]=e[0].z,this._vdataF32[r++]=0,this._vdataF32[r++]=t.evaluate(0,1),this._vdataF32[r++]=0,this._vdataF32[r++]=0,this._vdataF32[r++]=_temp_v1.x,this._vdataF32[r++]=_temp_v1.y,this._vdataF32[r++]=_temp_v1.z,this._vdataUint32[r++]=i.evaluate(0,1)._val,this._vdataF32[r++]=e[0].x,this._vdataF32[r++]=e[0].y,this._vdataF32[r++]=e[0].z,this._vdataF32[r++]=1,this._vdataF32[r++]=t.evaluate(0,1),this._vdataF32[r++]=0,this._vdataF32[r++]=1,this._vdataF32[r++]=_temp_v1.x,this._vdataF32[r++]=_temp_v1.y,this._vdataF32[r++]=_temp_v1.z,this._vdataUint32[r++]=i.evaluate(0,1)._val;for(var n=1;n<e.length-1;n++){Vec3.subtract(_temp_v1,e[n-1],e[n]),Vec3.subtract(_temp_v2,e[n+1],e[n]),Vec3.subtract(_temp_v2,_temp_v2,_temp_v1);var s=n/e.length;this._vdataF32[r++]=e[n].x,this._vdataF32[r++]=e[n].y,this._vdataF32[r++]=e[n].z,this._vdataF32[r++]=0,this._vdataF32[r++]=t.evaluate(s,1),this._vdataF32[r++]=s,this._vdataF32[r++]=0,this._vdataF32[r++]=_temp_v2.x,this._vdataF32[r++]=_temp_v2.y,this._vdataF32[r++]=_temp_v2.z,this._vdataUint32[r++]=i.evaluate(s,1)._val,this._vdataF32[r++]=e[n].x,this._vdataF32[r++]=e[n].y,this._vdataF32[r++]=e[n].z,this._vdataF32[r++]=1,this._vdataF32[r++]=t.evaluate(s,1),this._vdataF32[r++]=s,this._vdataF32[r++]=1,this._vdataF32[r++]=_temp_v2.x,this._vdataF32[r++]=_temp_v2.y,this._vdataF32[r++]=_temp_v2.z,this._vdataUint32[r++]=i.evaluate(s,1)._val}Vec3.subtract(_temp_v1,e[e.length-1],e[e.length-2]),this._vdataF32[r++]=e[e.length-1].x,this._vdataF32[r++]=e[e.length-1].y,this._vdataF32[r++]=e[e.length-1].z,this._vdataF32[r++]=0,this._vdataF32[r++]=t.evaluate(1,1),this._vdataF32[r++]=1,this._vdataF32[r++]=0,this._vdataF32[r++]=_temp_v1.x,this._vdataF32[r++]=_temp_v1.y,this._vdataF32[r++]=_temp_v1.z,this._vdataUint32[r++]=i.evaluate(1,1)._val,this._vdataF32[r++]=e[e.length-1].x,this._vdataF32[r++]=e[e.length-1].y,this._vdataF32[r++]=e[e.length-1].z,this._vdataF32[r++]=1,this._vdataF32[r++]=t.evaluate(1,1),this._vdataF32[r++]=1,this._vdataF32[r++]=1,this._vdataF32[r++]=_temp_v1.x,this._vdataF32[r++]=_temp_v1.y,this._vdataF32[r++]=_temp_v1.z,this._vdataUint32[r++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy()}this._subMeshData.indexBuffer.destroy()}}]),r}(),Mode$1=Enum({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),CurveRange=(_dec$1i=ccclass("cc.CurveRange"),_dec2$V=property({type:Mode$1}),_dec3$F=property({type:AnimationCurve}),_dec4$z=property({type:AnimationCurve}),_dec5$u=property({type:AnimationCurve}),_dec$1i((_temp$1c=_class3$z=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"mode",_descriptor$11,this),_initializerDefineProperty(this,"curve",_descriptor2$S,this),_initializerDefineProperty(this,"curveMin",_descriptor3$D,this),_initializerDefineProperty(this,"curveMax",_descriptor4$y,this),_initializerDefineProperty(this,"constant",_descriptor5$p,this),_initializerDefineProperty(this,"constantMin",_descriptor6$g,this),_initializerDefineProperty(this,"constantMax",_descriptor7$e,this),_initializerDefineProperty(this,"multiplier",_descriptor8$e,this)}return _createClass(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case Mode$1.Constant:return this.constant;case Mode$1.Curve:return this.curve.evaluate(e)*this.multiplier;case Mode$1.TwoCurves:return lerp(this.curveMin.evaluate(e),this.curveMax.evaluate(e),t)*this.multiplier;case Mode$1.TwoConstants:return lerp(this.constantMin,this.constantMax,t)}}},{key:"getMax",value:function(){switch(this.mode){case Mode$1.Constant:return this.constant;case Mode$1.Curve:return this.multiplier;case Mode$1.TwoConstants:return this.constantMax;case Mode$1.TwoCurves:return this.multiplier}return 0}}]),e}(),_class3$z.Mode=Mode$1,_descriptor$11=_applyDecoratedDescriptor((_class2$15=_temp$1c).prototype,"mode",[_dec2$V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mode$1.Constant}}),_descriptor2$S=_applyDecoratedDescriptor(_class2$15.prototype,"curve",[_dec3$F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AnimationCurve}}),_descriptor3$D=_applyDecoratedDescriptor(_class2$15.prototype,"curveMin",[_dec4$z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AnimationCurve}}),_descriptor4$y=_applyDecoratedDescriptor(_class2$15.prototype,"curveMax",[_dec5$u],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AnimationCurve}}),_descriptor5$p=_applyDecoratedDescriptor(_class2$15.prototype,"constant",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor6$g=_applyDecoratedDescriptor(_class2$15.prototype,"constantMin",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor7$e=_applyDecoratedDescriptor(_class2$15.prototype,"constantMax",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor8$e=_applyDecoratedDescriptor(_class2$15.prototype,"multiplier",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_class$1k=_class2$15))||_class$1k),Mode$2=Enum({Blend:0,Fixed:1}),ColorKey=(_dec$1j=ccclass("cc.ColorKey"))((_descriptor$12=_applyDecoratedDescriptor((_class2$16=_temp$1d=function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"color",_descriptor$12,this),_initializerDefineProperty(this,"time",_descriptor2$T,this)}).prototype,"color",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.WHITE.clone()}}),_descriptor2$T=_applyDecoratedDescriptor(_class2$16.prototype,"time",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_class$1l=_class2$16))||_class$1l,AlphaKey=(_dec2$W=ccclass("cc.AlphaKey"))((_descriptor3$E=_applyDecoratedDescriptor((_class5$6=_temp2$6=function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"alpha",_descriptor3$E,this),_initializerDefineProperty(this,"time",_descriptor4$z,this)}).prototype,"alpha",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor4$z=_applyDecoratedDescriptor(_class5$6.prototype,"time",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_class4$6=_class5$6))||_class4$6,Gradient=(_dec3$G=ccclass("cc.Gradient"))((_temp3$1=_class9=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"colorKeys",_descriptor5$q,this),_initializerDefineProperty(this,"alphaKeys",_descriptor6$h,this),_initializerDefineProperty(this,"mode",_descriptor7$f,this),this._color=void 0,this._color=Color.WHITE.clone()}return _createClass(e,[{key:"setKeys",value:function(e,t){this.colorKeys=e,this.alphaKeys=t}},{key:"sortKeys",value:function(){1<this.colorKeys.length&&this.colorKeys.sort(function(e,t){return e.time-t.time}),1<this.alphaKeys.length&&this.alphaKeys.sort(function(e,t){return e.time-t.time})}},{key:"evaluate",value:function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color}},{key:"randomColor",value:function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color}},{key:"getRGB",value:function(e){if(!(1<this.colorKeys.length))return 1===this.colorKeys.length?this._color.set(this.colorKeys[0].color):this._color.set(Color.WHITE),this._color;e=repeat(e,1);for(var t=1;t<this.colorKeys.length;++t){var i=this.colorKeys[t-1].time,r=this.colorKeys[t].time;if(i<=e&&e<r){if(this.mode===Mode$2.Fixed)return this.colorKeys[t].color;var n=(e-i)/(r-i);return Color.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,n),this._color}}var s=this.colorKeys.length-1;e<this.colorKeys[0].time?Color.lerp(this._color,Color.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[s].time&&Color.lerp(this._color,this.colorKeys[s].color,Color.BLACK,(e-this.colorKeys[s].time)/(1-this.colorKeys[s].time))}},{key:"getAlpha",value:function(e){if(!(1<this.alphaKeys.length))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=repeat(e,1);for(var t=1;t<this.alphaKeys.length;++t){var i=this.alphaKeys[t-1].time,r=this.alphaKeys[t].time;if(i<=e&&e<r){if(this.mode===Mode$2.Fixed)return this.alphaKeys[t].alpha;var n=(e-i)/(r-i);return lerp(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,n)}}var s=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?lerp(255,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[s].time?lerp(this.alphaKeys[s].alpha,255,(e-this.alphaKeys[s].time)/(1-this.alphaKeys[s].time)):void 0}}]),e}(),_class9.Mode=Mode$2,_descriptor5$q=_applyDecoratedDescriptor((_class8$1=_temp3$1).prototype,"colorKeys",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),_descriptor6$h=_applyDecoratedDescriptor(_class8$1.prototype,"alphaKeys",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),_descriptor7$f=_applyDecoratedDescriptor(_class8$1.prototype,"mode",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mode$2.Blend}}),_class7$1=_class8$1))||_class7$1,Mode$3=Enum({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),GradientRange=(_dec$1k=ccclass("cc.GradientRange"),_dec2$X=property({type:Mode$3}),_dec3$H=property({type:Gradient}),_dec4$A=property({type:Gradient}),_dec5$v=property({type:Gradient}),_dec6$q=property({type:Mode$3}),_dec$1k((_temp$1e=_class3$A=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"color",_descriptor$13,this),_initializerDefineProperty(this,"colorMin",_descriptor2$U,this),_initializerDefineProperty(this,"colorMax",_descriptor3$F,this),_initializerDefineProperty(this,"gradient",_descriptor4$A,this),_initializerDefineProperty(this,"gradientMin",_descriptor5$r,this),_initializerDefineProperty(this,"gradientMax",_descriptor6$i,this),_initializerDefineProperty(this,"_mode",_descriptor7$g,this),this._color=Color.WHITE.clone()}return _createClass(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case Mode$3.Color:return this.color;case Mode$3.TwoColors:return Color.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case Mode$3.RandomColor:return this.gradient.randomColor();case Mode$3.Gradient:return this.gradient.evaluate(e);case Mode$3.TwoGradients:return Color.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),_class3$A.Mode=Mode$3,_applyDecoratedDescriptor((_class2$17=_temp$1e).prototype,"mode",[_dec2$X],Object.getOwnPropertyDescriptor(_class2$17.prototype,"mode"),_class2$17.prototype),_descriptor$13=_applyDecoratedDescriptor(_class2$17.prototype,"color",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.WHITE.clone()}}),_descriptor2$U=_applyDecoratedDescriptor(_class2$17.prototype,"colorMin",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.WHITE.clone()}}),_descriptor3$F=_applyDecoratedDescriptor(_class2$17.prototype,"colorMax",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Color.WHITE.clone()}}),_descriptor4$A=_applyDecoratedDescriptor(_class2$17.prototype,"gradient",[_dec3$H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gradient}}),_descriptor5$r=_applyDecoratedDescriptor(_class2$17.prototype,"gradientMin",[_dec4$A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gradient}}),_descriptor6$i=_applyDecoratedDescriptor(_class2$17.prototype,"gradientMax",[_dec5$v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gradient}}),_descriptor7$g=_applyDecoratedDescriptor(_class2$17.prototype,"_mode",[_dec6$q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mode$3.Color}}),_class$1m=_class2$17))||_class$1m),CC_USE_WORLD_SPACE="CC_USE_WORLD_SPACE",define$1={CC_USE_WORLD_SPACE:!1},LineComponent=(_dec$1l=ccclass("cc.LineComponent"),_dec2$Y=menu("Components/Line"),_dec3$I=property({type:Texture2D}),_dec4$B=property({type:Texture2D,displayOrder:0}),_dec5$w=property({displayOrder:1}),_dec6$r=property({type:[Vec3]}),_dec7$j=property({type:[Vec3],displayOrder:2}),_dec8$b=property({type:CurveRange}),_dec9$9=property({type:CurveRange,displayOrder:3}),_dec10$8=property({type:Vec2,displayOrder:4}),_dec11$7=property({type:Vec2,displayOrder:5}),_dec12$6=property({type:GradientRange}),_dec13$3=property({type:GradientRange,displayOrder:6}),_dec$1l(_class$1n=_dec2$Y(_class$1n=executeInEditMode((_descriptor$14=_applyDecoratedDescriptor((_class2$18=_temp$1f=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"_texture",_descriptor$14,_assertThisInitialized(e)),e._material=null,_initializerDefineProperty(e,"_worldSpace",_descriptor2$V,_assertThisInitialized(e)),_initializerDefineProperty(e,"_positions",_descriptor3$G,_assertThisInitialized(e)),_initializerDefineProperty(e,"_width",_descriptor4$B,_assertThisInitialized(e)),_initializerDefineProperty(e,"_tile",_descriptor5$s,_assertThisInitialized(e)),_initializerDefineProperty(e,"_offset",_descriptor6$j,_assertThisInitialized(e)),_initializerDefineProperty(e,"_color",_descriptor7$h,_assertThisInitialized(e)),e._model=null,e._tile_offset=new Vec4,e}return _inherits(t,Component),_createClass(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._material&&(define$1[CC_USE_WORLD_SPACE]=this.worldSpace,this._material.recompileShaders(define$1),this._model&&this._model.setSubModelMaterial(0,this._material))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),_createClass(t,[{key:"onEnable",value:function(){this._model||(this._model=this._getRenderScene().createModel(LineModel,this.node),this._model.setCapacity(100),null==this._material&&(this._material=new Material,this._material.copy(builtinResMgr.get("default-trail-material")),define$1[CC_USE_WORLD_SPACE]=this.worldSpace,this._material.recompileShaders(define$1)),this._model.setSubModelMaterial(0,this._material)),this._model.enabled=!0,this.texture=this.texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}}]),t}()).prototype,"_texture",[_dec3$I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_applyDecoratedDescriptor(_class2$18.prototype,"texture",[_dec4$B],Object.getOwnPropertyDescriptor(_class2$18.prototype,"texture"),_class2$18.prototype),_descriptor2$V=_applyDecoratedDescriptor(_class2$18.prototype,"_worldSpace",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_applyDecoratedDescriptor(_class2$18.prototype,"worldSpace",[_dec5$w],Object.getOwnPropertyDescriptor(_class2$18.prototype,"worldSpace"),_class2$18.prototype),_descriptor3$G=_applyDecoratedDescriptor(_class2$18.prototype,"_positions",[_dec6$r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_applyDecoratedDescriptor(_class2$18.prototype,"positions",[_dec7$j],Object.getOwnPropertyDescriptor(_class2$18.prototype,"positions"),_class2$18.prototype),_descriptor4$B=_applyDecoratedDescriptor(_class2$18.prototype,"_width",[_dec8$b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_applyDecoratedDescriptor(_class2$18.prototype,"width",[_dec9$9],Object.getOwnPropertyDescriptor(_class2$18.prototype,"width"),_class2$18.prototype),_descriptor5$s=_applyDecoratedDescriptor(_class2$18.prototype,"_tile",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec2(1,1)}}),_applyDecoratedDescriptor(_class2$18.prototype,"tile",[_dec10$8],Object.getOwnPropertyDescriptor(_class2$18.prototype,"tile"),_class2$18.prototype),_descriptor6$j=_applyDecoratedDescriptor(_class2$18.prototype,"_offset",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec2(0,0)}}),_applyDecoratedDescriptor(_class2$18.prototype,"offset",[_dec11$7],Object.getOwnPropertyDescriptor(_class2$18.prototype,"offset"),_class2$18.prototype),_descriptor7$h=_applyDecoratedDescriptor(_class2$18.prototype,"_color",[_dec12$6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new GradientRange}}),_applyDecoratedDescriptor(_class2$18.prototype,"color",[_dec13$3],Object.getOwnPropertyDescriptor(_class2$18.prototype,"color"),_class2$18.prototype),_class$1n=_class2$18))||_class$1n)||_class$1n)||_class$1n),COLOR_OVERTIME_RAND_OFFSET=91041,ColorOvertimeModule=(_dec$1m=ccclass("cc.ColorOvertimeModule"),_dec2$Z=property({displayOrder:0}),_dec3$J=property({type:GradientRange,displayOrder:1}),_dec$1m((_descriptor$15=_applyDecoratedDescriptor((_class2$19=_temp$1g=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"enable",_descriptor$15,this),_initializerDefineProperty(this,"color",_descriptor2$W,this)}return _createClass(e,[{key:"animate",value:function(e){this.enable&&(e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,pseudoRandom(e.randomSeed+COLOR_OVERTIME_RAND_OFFSET))))}}]),e}()).prototype,"enable",[_dec2$Z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2$W=_applyDecoratedDescriptor(_class2$19.prototype,"color",[_dec3$J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new GradientRange}}),_class$1o=_class2$19))||_class$1o),Space=Enum({World:0,Local:1,Custom:2}),RenderMode$1=Enum({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),ShapeType=Enum({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),EmitLocation=Enum({Base:0,Edge:1,Shell:2,Volume:3}),ArcMode=Enum({Random:0,Loop:1,PingPong:2}),TrailMode=Enum({Particles:0,Ribbon:1}),TextureMode=Enum({Stretch:0,Repeat:1}),particleEmitZAxis=new Vec3(0,0,-1);function calculateTransform(e,t,i,r){return t!==e?(e===Space.World||Mat4.invert(i,i),Mat4.getRotation(r,i),!0):(Quat.set(r,0,0,0,1),!1)}function fixedAngleUnitVector2(e,t){Vec2.set(e,Math.cos(t),Math.sin(t))}function randomUnitVector(e){var t=randomRange(-1,1),i=randomRange(0,2*Math.PI),r=Math.sqrt(1-t*t),n=r*Math.cos(i),s=r*Math.sin(i);Vec3.set(e,n,s,t)}function randomPointBetweenSphere(e,t,i){randomUnitVector(e),Vec3.multiplyScalar(e,e,t+(i-t)*random())}function randomPointBetweenCircleAtFixedAngle(e,t,i,r){fixedAngleUnitVector2(e,r),e.z=0,Vec3.multiplyScalar(e,e,t+(i-t)*random())}function randomPointInCube(e,t){Vec3.set(e,randomRange(-t.x,t.x),randomRange(-t.y,t.y),randomRange(-t.z,t.z))}function randomSortArray(e){for(var t=0;t<e.length;t++){var i=t+randomRangeInt(0,e.length-t),r=e[i];e[i]=e[t],e[t]=r}}function randomSign(){var e=randomRange(-1,1);return 0===e&&e++,sign(e)}var _dec$1o,_dec2$$,_dec3$L,_dec4$D,_dec5$y,_dec6$t,_dec7$k,_dec8$c,_dec9$a,_class$1q,_class2$1b,_descriptor$17,_descriptor2$Y,_descriptor3$I,_descriptor4$D,_descriptor5$u,_descriptor6$k,_descriptor7$i,_descriptor8$f,_temp$1i,_dec$1p,_dec2$10,_dec3$M,_dec4$E,_dec5$z,_dec6$u,_class$1r,_class2$1c,_descriptor$18,_descriptor2$Z,_descriptor3$J,_descriptor4$E,_descriptor5$v,_temp$1j,FORCE_OVERTIME_RAND_OFFSET=212165,_temp_v3=new Vec3,ForceOvertimeModule=(_dec$1n=ccclass("cc.ForceOvertimeModule"),_dec2$_=property({displayOrder:0}),_dec3$K=property({type:CurveRange,range:[-1,1],displayOrder:2}),_dec4$C=property({type:CurveRange,range:[-1,1],displayOrder:3}),_dec5$x=property({type:CurveRange,range:[-1,1],displayOrder:4}),_dec6$s=property({type:Space,displayOrder:1}),_dec$1n((_descriptor$16=_applyDecoratedDescriptor((_class2$1a=_temp$1h=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"enable",_descriptor$16,this),_initializerDefineProperty(this,"x",_descriptor2$X,this),_initializerDefineProperty(this,"y",_descriptor3$H,this),_initializerDefineProperty(this,"z",_descriptor4$C,this),_initializerDefineProperty(this,"space",_descriptor5$t,this),this.randomized=!1,this.rotation=void 0,this.needTransform=void 0,this.rotation=new Quat,this.needTransform=!1}return _createClass(e,[{key:"update",value:function(e,t){this.needTransform=calculateTransform(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,r=Vec3.set(_temp_v3,this.x.evaluate(i,pseudoRandom(e.randomSeed+FORCE_OVERTIME_RAND_OFFSET)),this.y.evaluate(i,pseudoRandom(e.randomSeed+FORCE_OVERTIME_RAND_OFFSET)),this.z.evaluate(i,pseudoRandom(e.randomSeed+FORCE_OVERTIME_RAND_OFFSET)));this.needTransform&&Vec3.transformQuat(r,r,this.rotation),Vec3.scaleAndAdd(e.velocity,e.velocity,r,t)}}]),e}()).prototype,"enable",[_dec2$_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2$X=_applyDecoratedDescriptor(_class2$1a.prototype,"x",[_dec3$K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor3$H=_applyDecoratedDescriptor(_class2$1a.prototype,"y",[_dec4$C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor4$C=_applyDecoratedDescriptor(_class2$1a.prototype,"z",[_dec5$x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor5$t=_applyDecoratedDescriptor(_class2$1a.prototype,"space",[_dec6$s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Space.Local}}),_class$1p=_class2$1a))||_class$1p),LIMIT_VELOCITY_RAND_OFFSET=23541,_temp_v3$1=new Vec3,_temp_v3_1=new Vec3,LimitVelocityOvertimeModule=(_dec$1o=ccclass("cc.LimitVelocityOvertimeModule"),_dec2$$=property({displayOrder:0}),_dec3$L=property({type:CurveRange,range:[-1,1],displayOrder:4}),_dec4$D=property({type:CurveRange,range:[-1,1],displayOrder:5}),_dec5$y=property({type:CurveRange,range:[-1,1],displayOrder:6}),_dec6$t=property({type:CurveRange,range:[-1,1],displayOrder:3}),_dec7$k=property({displayOrder:7}),_dec8$c=property({displayOrder:2}),_dec9$a=property({type:Space,displayOrder:1}),_dec$1o((_descriptor$17=_applyDecoratedDescriptor((_class2$1b=_temp$1i=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"enable",_descriptor$17,this),_initializerDefineProperty(this,"limitX",_descriptor2$Y,this),_initializerDefineProperty(this,"limitY",_descriptor3$I,this),_initializerDefineProperty(this,"limitZ",_descriptor4$D,this),_initializerDefineProperty(this,"limit",_descriptor5$u,this),_initializerDefineProperty(this,"dampen",_descriptor6$k,this),_initializerDefineProperty(this,"separateAxes",_descriptor7$i,this),_initializerDefineProperty(this,"space",_descriptor8$f,this),this.drag=null,this.multiplyDragByParticleSize=!1,this.multiplyDragByParticleVelocity=!1,this.rotation=void 0,this.needTransform=void 0,this.rotation=new Quat,this.needTransform=!1}return _createClass(e,[{key:"update",value:function(e,t){this.needTransform=calculateTransform(e,this.space,t,this.rotation)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=_temp_v3$1;this.separateAxes?(Vec3.set(_temp_v3_1,this.limitX.evaluate(t,pseudoRandom(e.randomSeed+LIMIT_VELOCITY_RAND_OFFSET)),this.limitY.evaluate(t,pseudoRandom(e.randomSeed+LIMIT_VELOCITY_RAND_OFFSET)),this.limitZ.evaluate(t,pseudoRandom(e.randomSeed+LIMIT_VELOCITY_RAND_OFFSET))),this.needTransform&&Vec3.transformQuat(_temp_v3_1,_temp_v3_1,this.rotation),Vec3.set(i,dampenBeyondLimit(e.ultimateVelocity.x,_temp_v3_1.x,this.dampen),dampenBeyondLimit(e.ultimateVelocity.y,_temp_v3_1.y,this.dampen),dampenBeyondLimit(e.ultimateVelocity.z,_temp_v3_1.z,this.dampen))):(Vec3.normalize(i,e.ultimateVelocity),Vec3.multiplyScalar(i,i,dampenBeyondLimit(e.ultimateVelocity.length(),this.limit.evaluate(t,pseudoRandom(e.randomSeed+LIMIT_VELOCITY_RAND_OFFSET)),this.dampen))),Vec3.copy(e.ultimateVelocity,i)}}]),e}()).prototype,"enable",[_dec2$$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2$Y=_applyDecoratedDescriptor(_class2$1b.prototype,"limitX",[_dec3$L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor3$I=_applyDecoratedDescriptor(_class2$1b.prototype,"limitY",[_dec4$D],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor4$D=_applyDecoratedDescriptor(_class2$1b.prototype,"limitZ",[_dec5$y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor5$u=_applyDecoratedDescriptor(_class2$1b.prototype,"limit",[_dec6$t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor6$k=_applyDecoratedDescriptor(_class2$1b.prototype,"dampen",[_dec7$k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),_descriptor7$i=_applyDecoratedDescriptor(_class2$1b.prototype,"separateAxes",[_dec8$c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor8$f=_applyDecoratedDescriptor(_class2$1b.prototype,"space",[_dec9$a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Space.Local}}),_class$1q=_class2$1b))||_class$1q);function dampenBeyondLimit(e,t,i){var r=Math.sign(e),n=Math.abs(e);return t<n&&(n=lerp(n,t,i)),n*r}var _dec$1q,_dec2$11,_dec3$N,_dec4$F,_dec5$A,_dec6$v,_dec7$l,_class$1s,_class2$1d,_descriptor$19,_descriptor2$_,_descriptor3$K,_descriptor4$F,_descriptor5$w,_descriptor6$l,_temp$1k,_dec$1r,_dec2$12,_dec3$O,_dec4$G,_dec5$B,_dec6$w,_dec7$m,_dec8$d,_dec9$b,_dec10$9,_dec11$8,_dec12$7,_class$1t,_class2$1e,_descriptor$1a,_descriptor2$$,_descriptor3$L,_descriptor4$G,_descriptor5$x,_descriptor6$m,_descriptor7$j,_descriptor8$g,_descriptor9$c,_descriptor10$b,_descriptor11$9,_descriptor12$8,_descriptor13$7,_temp$1l,_dec$1s,_dec2$13,_dec3$P,_dec4$H,_dec5$C,_dec6$x,_dec7$n,_class$1u,_class2$1f,_descriptor$1b,_descriptor2$10,_descriptor3$M,_descriptor4$H,_descriptor5$y,_descriptor6$n,_temp$1m,_dec$1t,_dec2$14,_class$1v,_class2$1g,_descriptor$1c,_descriptor2$11,_descriptor3$N,_descriptor4$I,_descriptor5$z,_descriptor6$o,_temp$1n,_dec$1u,_dec2$15,_dec3$Q,_dec4$I,_dec5$D,_dec6$y,_dec7$o,_dec8$e,_dec9$c,_dec10$a,_dec11$9,_dec12$8,_dec13$4,_dec14$3,_dec15$3,_dec16$2,_dec17$2,_dec18$2,_dec19,_dec20,_dec21,_class$1w,_class2$1h,_descriptor$1d,_descriptor2$12,_descriptor3$O,_descriptor4$J,_descriptor5$A,_descriptor6$p,_descriptor7$k,_descriptor8$h,_descriptor9$d,_descriptor10$c,_descriptor11$a,_descriptor12$9,_descriptor13$8,_descriptor14$7,_descriptor15$3,_descriptor16$3,_descriptor17$2,_descriptor18$1,_descriptor19$1,_temp$1o,ROTATION_OVERTIME_RAND_OFFSET=125292,RotationOvertimeModule=(_dec$1p=ccclass("cc.RotationOvertimeModule"),_dec2$10=property({displayOrder:0}),_dec3$M=property({displayOrder:1}),_dec4$E=property({type:CurveRange,range:[-1,1],radian:!0,displayOrder:2}),_dec5$z=property({type:CurveRange,range:[-1,1],radian:!0,displayOrder:3}),_dec6$u=property({type:CurveRange,range:[-1,1],radian:!0,displayOrder:4}),_dec$1p((_descriptor$18=_applyDecoratedDescriptor((_class2$1c=_temp$1j=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"enable",_descriptor$18,this),_initializerDefineProperty(this,"_separateAxes",_descriptor2$Z,this),_initializerDefineProperty(this,"x",_descriptor3$J,this),_initializerDefineProperty(this,"y",_descriptor4$E,this),_initializerDefineProperty(this,"z",_descriptor5$v,this)}return _createClass(e,[{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),_createClass(e,[{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime;if(this._separateAxes){var r=pseudoRandom(e.randomSeed+ROTATION_OVERTIME_RAND_OFFSET);e.rotation.x+=this.x.evaluate(i,r)*t,e.rotation.y+=this.y.evaluate(i,r)*t,e.rotation.z+=this.z.evaluate(i,r)*t}else e.rotation.z+=this.z.evaluate(i,pseudoRandom(e.randomSeed+ROTATION_OVERTIME_RAND_OFFSET))*t}}]),e}()).prototype,"enable",[_dec2$10],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2$Z=_applyDecoratedDescriptor(_class2$1c.prototype,"_separateAxes",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_applyDecoratedDescriptor(_class2$1c.prototype,"separateAxes",[_dec3$M],Object.getOwnPropertyDescriptor(_class2$1c.prototype,"separateAxes"),_class2$1c.prototype),_descriptor3$J=_applyDecoratedDescriptor(_class2$1c.prototype,"x",[_dec4$E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor4$E=_applyDecoratedDescriptor(_class2$1c.prototype,"y",[_dec5$z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor5$v=_applyDecoratedDescriptor(_class2$1c.prototype,"z",[_dec6$u],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_class$1r=_class2$1c))||_class$1r),SIZE_OVERTIME_RAND_OFFSET=39825,SizeOvertimeModule=(_dec$1q=ccclass("cc.SizeOvertimeModule"),_dec2$11=property({displayOrder:0}),_dec3$N=property({displayOrder:1}),_dec4$F=property({type:CurveRange,displayOrder:2}),_dec5$A=property({type:CurveRange,displayOrder:3}),_dec6$v=property({type:CurveRange,displayOrder:4}),_dec7$l=property({type:CurveRange,displayOrder:5}),_dec$1q((_descriptor$19=_applyDecoratedDescriptor((_class2$1d=_temp$1k=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"enable",_descriptor$19,this),_initializerDefineProperty(this,"separateAxes",_descriptor2$_,this),_initializerDefineProperty(this,"size",_descriptor3$K,this),_initializerDefineProperty(this,"x",_descriptor4$F,this),_initializerDefineProperty(this,"y",_descriptor5$w,this),_initializerDefineProperty(this,"z",_descriptor6$l,this)}return _createClass(e,[{key:"animate",value:function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,i=pseudoRandom(e.randomSeed+SIZE_OVERTIME_RAND_OFFSET);e.size.x=e.startSize.x*this.x.evaluate(t,i),e.size.y=e.startSize.y*this.y.evaluate(t,i),e.size.z=e.startSize.z*this.z.evaluate(t,i)}else Vec3.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,pseudoRandom(e.randomSeed+SIZE_OVERTIME_RAND_OFFSET)))}}]),e}()).prototype,"enable",[_dec2$11],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2$_=_applyDecoratedDescriptor(_class2$1d.prototype,"separateAxes",[_dec3$N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor3$K=_applyDecoratedDescriptor(_class2$1d.prototype,"size",[_dec4$F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor4$F=_applyDecoratedDescriptor(_class2$1d.prototype,"x",[_dec5$A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor5$w=_applyDecoratedDescriptor(_class2$1d.prototype,"y",[_dec6$v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor6$l=_applyDecoratedDescriptor(_class2$1d.prototype,"z",[_dec7$l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_class$1s=_class2$1d))||_class$1s),TEXTURE_ANIMATION_RAND_OFFSET=90794,Mode$4=Enum({Grid:0}),Animation=Enum({WholeSheet:0,SingleRow:1}),TextureAnimationModule=(_dec$1r=ccclass("cc.TextureAnimationModule"),_dec2$12=property({displayOrder:0}),_dec3$O=property({type:Mode$4}),_dec4$G=property({type:Mode$4,displayOrder:1}),_dec5$B=property({displayOrder:2}),_dec6$w=property({displayOrder:3}),_dec7$m=property({type:Animation,displayOrder:4}),_dec8$d=property({type:CurveRange,displayOrder:7}),_dec9$b=property({type:CurveRange,displayOrder:8}),_dec10$9=property({displayOrder:9}),_dec11$8=property({displayOrder:5}),_dec12$7=property({displayOrder:6}),_dec$1r((_descriptor$1a=_applyDecoratedDescriptor((_class2$1e=_temp$1l=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"_enable",_descriptor$1a,this),_initializerDefineProperty(this,"_mode",_descriptor2$$,this),_initializerDefineProperty(this,"numTilesX",_descriptor3$L,this),_initializerDefineProperty(this,"numTilesY",_descriptor4$G,this),_initializerDefineProperty(this,"animation",_descriptor5$x,this),_initializerDefineProperty(this,"frameOverTime",_descriptor6$m,this),_initializerDefineProperty(this,"startFrame",_descriptor7$j,this),_initializerDefineProperty(this,"cycleCount",_descriptor8$g,this),_initializerDefineProperty(this,"_flipU",_descriptor9$c,this),_initializerDefineProperty(this,"_flipV",_descriptor10$b,this),_initializerDefineProperty(this,"_uvChannelMask",_descriptor11$9,this),_initializerDefineProperty(this,"randomRow",_descriptor12$8,this),_initializerDefineProperty(this,"rowIndex",_descriptor13$7,this),this.ps=null}return _createClass(e,[{key:"onInit",value:function(e){this.ps=e}},{key:"init",value:function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=this.startFrame.evaluate(t,pseudoRandom(e.randomSeed+TEXTURE_ANIMATION_RAND_OFFSET))/(this.numTilesX*this.numTilesY);if(this.animation===Animation.WholeSheet)e.frameIndex=repeat(this.cycleCount*(this.frameOverTime.evaluate(t,pseudoRandom(e.randomSeed+TEXTURE_ANIMATION_RAND_OFFSET))+i),1);else if(this.animation===Animation.SingleRow){var r=1/this.numTilesY;if(this.randomRow){var n=repeat(this.cycleCount*(this.frameOverTime.evaluate(t,pseudoRandom(e.randomSeed+TEXTURE_ANIMATION_RAND_OFFSET))+i),1),s=e.startRow*r,a=s+r;e.frameIndex=lerp(s,a,n)}else{var o=this.rowIndex*r,c=o+r;e.frameIndex=lerp(o,c,repeat(this.cycleCount*(this.frameOverTime.evaluate(t,pseudoRandom(e.randomSeed+TEXTURE_ANIMATION_RAND_OFFSET))+i),1))}}}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e,this.ps&&this.ps.renderer._updateMaterialParams()}},{key:"mode",get:function(){return this._mode},set:function(e){e===Mode$4.Grid||console.error("particle texture animation's sprites is not supported!")}},{key:"flipU",get:function(){return this._flipU},set:function(e){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(e){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(e){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}()).prototype,"_enable",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_applyDecoratedDescriptor(_class2$1e.prototype,"enable",[_dec2$12],Object.getOwnPropertyDescriptor(_class2$1e.prototype,"enable"),_class2$1e.prototype),_descriptor2$$=_applyDecoratedDescriptor(_class2$1e.prototype,"_mode",[_dec3$O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mode$4.Grid}}),_applyDecoratedDescriptor(_class2$1e.prototype,"mode",[_dec4$G],Object.getOwnPropertyDescriptor(_class2$1e.prototype,"mode"),_class2$1e.prototype),_descriptor3$L=_applyDecoratedDescriptor(_class2$1e.prototype,"numTilesX",[_dec5$B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor4$G=_applyDecoratedDescriptor(_class2$1e.prototype,"numTilesY",[_dec6$w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor5$x=_applyDecoratedDescriptor(_class2$1e.prototype,"animation",[_dec7$m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Animation.WholeSheet}}),_descriptor6$m=_applyDecoratedDescriptor(_class2$1e.prototype,"frameOverTime",[_dec8$d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor7$j=_applyDecoratedDescriptor(_class2$1e.prototype,"startFrame",[_dec9$b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor8$g=_applyDecoratedDescriptor(_class2$1e.prototype,"cycleCount",[_dec10$9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor9$c=_applyDecoratedDescriptor(_class2$1e.prototype,"_flipU",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor10$b=_applyDecoratedDescriptor(_class2$1e.prototype,"_flipV",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor11$9=_applyDecoratedDescriptor(_class2$1e.prototype,"_uvChannelMask",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),_descriptor12$8=_applyDecoratedDescriptor(_class2$1e.prototype,"randomRow",[_dec11$8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor13$7=_applyDecoratedDescriptor(_class2$1e.prototype,"rowIndex",[_dec12$7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_class$1t=_class2$1e))||_class$1t),VELOCITY_X_OVERTIME_RAND_OFFSET=197866,VELOCITY_Y_OVERTIME_RAND_OFFSET=156497,VELOCITY_Z_OVERTIME_RAND_OFFSET=984136,_temp_v3$2=new Vec3,VelocityOvertimeModule=(_dec$1s=ccclass("cc.VelocityOvertimeModule"),_dec2$13=property({displayOrder:0}),_dec3$P=property({type:CurveRange,range:[-1,1],displayOrder:2}),_dec4$H=property({type:CurveRange,range:[-1,1],displayOrder:3}),_dec5$C=property({type:CurveRange,range:[-1,1],displayOrder:4}),_dec6$x=property({type:CurveRange,range:[-1,1],displayOrder:5}),_dec7$n=property({type:Space,displayOrder:1}),_dec$1s((_descriptor$1b=_applyDecoratedDescriptor((_class2$1f=_temp$1m=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"enable",_descriptor$1b,this),_initializerDefineProperty(this,"x",_descriptor2$10,this),_initializerDefineProperty(this,"y",_descriptor3$M,this),_initializerDefineProperty(this,"z",_descriptor4$H,this),_initializerDefineProperty(this,"speedModifier",_descriptor5$y,this),_initializerDefineProperty(this,"space",_descriptor6$n,this),this.rotation=void 0,this.needTransform=void 0,this.rotation=new Quat,this.speedModifier.constant=1,this.needTransform=!1}return _createClass(e,[{key:"update",value:function(e,t){this.needTransform=calculateTransform(e,this.space,t,this.rotation)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=Vec3.set(_temp_v3$2,this.x.evaluate(t,pseudoRandom(e.randomSeed^VELOCITY_X_OVERTIME_RAND_OFFSET)),this.y.evaluate(t,pseudoRandom(e.randomSeed^VELOCITY_Y_OVERTIME_RAND_OFFSET)),this.z.evaluate(t,pseudoRandom(e.randomSeed^VELOCITY_Z_OVERTIME_RAND_OFFSET)));this.needTransform&&Vec3.transformQuat(i,i,this.rotation),Vec3.add(e.animatedVelocity,e.animatedVelocity,i),Vec3.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),Vec3.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,pseudoRandom(e.randomSeed+VELOCITY_X_OVERTIME_RAND_OFFSET)))}}]),e}()).prototype,"enable",[_dec2$13],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2$10=_applyDecoratedDescriptor(_class2$1f.prototype,"x",[_dec3$P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor3$M=_applyDecoratedDescriptor(_class2$1f.prototype,"y",[_dec4$H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor4$H=_applyDecoratedDescriptor(_class2$1f.prototype,"z",[_dec5$C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor5$y=_applyDecoratedDescriptor(_class2$1f.prototype,"speedModifier",[_dec6$x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor6$n=_applyDecoratedDescriptor(_class2$1f.prototype,"space",[_dec7$n],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Space.Local}}),_class$1u=_class2$1f))||_class$1u),Burst=(_dec$1t=ccclass("cc.Burst"),_dec2$14=property({type:CurveRange}),_dec$1t((_descriptor$1c=_applyDecoratedDescriptor((_class2$1g=_temp$1n=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"_time",_descriptor$1c,this),_initializerDefineProperty(this,"minCount",_descriptor2$11,this),_initializerDefineProperty(this,"maxCount",_descriptor3$N,this),_initializerDefineProperty(this,"_repeatCount",_descriptor4$I,this),_initializerDefineProperty(this,"repeatInterval",_descriptor5$z,this),_initializerDefineProperty(this,"count",_descriptor6$o,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=1,this._curTime=0}return _createClass(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),_createClass(e,[{key:"update",value:function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),0<this._remainingCount){var i=repeat(e._time-e.startDelay.evaluate(0,1),e.duration)-t;i=0<i?i:0;var r=repeat(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=i&&this._curTime<r&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(r-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},{key:"getMaxCount",value:function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)}}]),e}()).prototype,"_time",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_applyDecoratedDescriptor(_class2$1g.prototype,"time",[property],Object.getOwnPropertyDescriptor(_class2$1g.prototype,"time"),_class2$1g.prototype),_descriptor2$11=_applyDecoratedDescriptor(_class2$1g.prototype,"minCount",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),_descriptor3$N=_applyDecoratedDescriptor(_class2$1g.prototype,"maxCount",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),_descriptor4$I=_applyDecoratedDescriptor(_class2$1g.prototype,"_repeatCount",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_applyDecoratedDescriptor(_class2$1g.prototype,"repeatCount",[property],Object.getOwnPropertyDescriptor(_class2$1g.prototype,"repeatCount"),_class2$1g.prototype),_descriptor5$z=_applyDecoratedDescriptor(_class2$1g.prototype,"repeatInterval",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor6$o=_applyDecoratedDescriptor(_class2$1g.prototype,"count",[_dec2$14],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_class$1v=_class2$1g))||_class$1v),_intermediVec=new Vec3(0,0,0),_intermediArr=new Array,_unitBoxExtent=new Vec3(.5,.5,.5),ShapeModule=(_dec$1u=ccclass("cc.ShapeModule"),_dec2$15=property({displayOrder:13}),_dec3$Q=property({displayOrder:14}),_dec4$I=property({displayOrder:15}),_dec5$D=property({displayOrder:6}),_dec6$y=property({displayOrder:5}),_dec7$o=property({displayOrder:0}),_dec8$e=property({type:ShapeType,displayOrder:1,formerlySerializedAs:"shapeType"}),_dec9$c=property({type:ShapeType}),_dec10$a=property({type:EmitLocation,displayOrder:2}),_dec11$9=property({displayOrder:16}),_dec12$8=property({displayOrder:17}),_dec13$4=property({displayOrder:18}),_dec14$3=property({displayOrder:19}),_dec15$3=property({displayOrder:3}),_dec16$2=property({displayOrder:4}),_dec17$2=property({type:ArcMode,displayOrder:7}),_dec18$2=property({displayOrder:9}),_dec19=property({type:CurveRange,displayOrder:10}),_dec20=property({displayOrder:11}),_dec21=property({displayOrder:12}),_dec$1u((_applyDecoratedDescriptor((_class2$1h=_temp$1o=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"enable",_descriptor$1d,this),_initializerDefineProperty(this,"_shapeType",_descriptor2$12,this),_initializerDefineProperty(this,"emitFrom",_descriptor3$O,this),_initializerDefineProperty(this,"alignToDirection",_descriptor4$J,this),_initializerDefineProperty(this,"randomDirectionAmount",_descriptor5$A,this),_initializerDefineProperty(this,"sphericalDirectionAmount",_descriptor6$p,this),_initializerDefineProperty(this,"randomPositionAmount",_descriptor7$k,this),_initializerDefineProperty(this,"radius",_descriptor8$h,this),_initializerDefineProperty(this,"radiusThickness",_descriptor9$d,this),_initializerDefineProperty(this,"arcMode",_descriptor10$c,this),_initializerDefineProperty(this,"arcSpread",_descriptor11$a,this),_initializerDefineProperty(this,"arcSpeed",_descriptor12$9,this),_initializerDefineProperty(this,"length",_descriptor13$8,this),_initializerDefineProperty(this,"boxThickness",_descriptor14$7,this),_initializerDefineProperty(this,"_position",_descriptor15$3,this),_initializerDefineProperty(this,"_rotation",_descriptor16$3,this),_initializerDefineProperty(this,"_scale",_descriptor17$2,this),_initializerDefineProperty(this,"_arc",_descriptor18$1,this),_initializerDefineProperty(this,"_angle",_descriptor19$1,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Mat4,this.quat=new Quat,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}return _createClass(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return toDegree(this._arc)},set:function(e){this._arc=toRadian(e)}},{key:"angle",get:function(){return Math.round(100*toDegree(this._angle))/100},set:function(e){this._angle=toRadian(e)}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case ShapeType.Box:this.emitFrom===EmitLocation.Base&&(this.emitFrom=EmitLocation.Volume);break;case ShapeType.Cone:this.emitFrom===EmitLocation.Edge&&(this.emitFrom=EmitLocation.Base);break;case ShapeType.Sphere:case ShapeType.Hemisphere:this.emitFrom!==EmitLocation.Base&&this.emitFrom!==EmitLocation.Edge||(this.emitFrom=EmitLocation.Volume)}}}]),_createClass(e,[{key:"onInit",value:function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time}},{key:"emit",value:function(e){switch(this.shapeType){case ShapeType.Box:boxEmit(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case ShapeType.Circle:circleEmit(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case ShapeType.Cone:coneEmit(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case ShapeType.Sphere:sphereEmit(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case ShapeType.Hemisphere:hemisphereEmit(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(0<this.randomPositionAmount&&(e.position.x+=randomRange(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=randomRange(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=randomRange(-this.randomPositionAmount,this.randomPositionAmount)),Vec3.transformQuat(e.velocity,e.velocity,this.quat),Vec3.transformMat4(e.position,e.position,this.mat),0<this.sphericalDirectionAmount){var t=Vec3.normalize(_intermediVec,e.position);Vec3.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}},{key:"constructMat",value:function(){Quat.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Mat4.fromRTS(this.mat,this.quat,this._position,this._scale)}},{key:"generateArcAngle",value:function(){if(this.arcMode===ArcMode.Random)return randomRange(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case ArcMode.Loop:return repeat(e,this._arc);case ArcMode.PingPong:return pingPong(e,this._arc)}}}]),e}()).prototype,"position",[_dec2$15],Object.getOwnPropertyDescriptor(_class2$1h.prototype,"position"),_class2$1h.prototype),_applyDecoratedDescriptor(_class2$1h.prototype,"rotation",[_dec3$Q],Object.getOwnPropertyDescriptor(_class2$1h.prototype,"rotation"),_class2$1h.prototype),_applyDecoratedDescriptor(_class2$1h.prototype,"scale",[_dec4$I],Object.getOwnPropertyDescriptor(_class2$1h.prototype,"scale"),_class2$1h.prototype),_applyDecoratedDescriptor(_class2$1h.prototype,"arc",[_dec5$D],Object.getOwnPropertyDescriptor(_class2$1h.prototype,"arc"),_class2$1h.prototype),_applyDecoratedDescriptor(_class2$1h.prototype,"angle",[_dec6$y],Object.getOwnPropertyDescriptor(_class2$1h.prototype,"angle"),_class2$1h.prototype),_descriptor$1d=_applyDecoratedDescriptor(_class2$1h.prototype,"enable",[_dec7$o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor2$12=_applyDecoratedDescriptor(_class2$1h.prototype,"_shapeType",[_dec8$e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ShapeType.Cone}}),_applyDecoratedDescriptor(_class2$1h.prototype,"shapeType",[_dec9$c],Object.getOwnPropertyDescriptor(_class2$1h.prototype,"shapeType"),_class2$1h.prototype),_descriptor3$O=_applyDecoratedDescriptor(_class2$1h.prototype,"emitFrom",[_dec10$a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EmitLocation.Volume}}),_descriptor4$J=_applyDecoratedDescriptor(_class2$1h.prototype,"alignToDirection",[_dec11$9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor5$A=_applyDecoratedDescriptor(_class2$1h.prototype,"randomDirectionAmount",[_dec12$8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor6$p=_applyDecoratedDescriptor(_class2$1h.prototype,"sphericalDirectionAmount",[_dec13$4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor7$k=_applyDecoratedDescriptor(_class2$1h.prototype,"randomPositionAmount",[_dec14$3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor8$h=_applyDecoratedDescriptor(_class2$1h.prototype,"radius",[_dec15$3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor9$d=_applyDecoratedDescriptor(_class2$1h.prototype,"radiusThickness",[_dec16$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor10$c=_applyDecoratedDescriptor(_class2$1h.prototype,"arcMode",[_dec17$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ArcMode.Random}}),_descriptor11$a=_applyDecoratedDescriptor(_class2$1h.prototype,"arcSpread",[_dec18$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor12$9=_applyDecoratedDescriptor(_class2$1h.prototype,"arcSpeed",[_dec19],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor13$8=_applyDecoratedDescriptor(_class2$1h.prototype,"length",[_dec20],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),_descriptor14$7=_applyDecoratedDescriptor(_class2$1h.prototype,"boxThickness",[_dec21],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3(0,0,0)}}),_descriptor15$3=_applyDecoratedDescriptor(_class2$1h.prototype,"_position",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3(0,0,0)}}),_descriptor16$3=_applyDecoratedDescriptor(_class2$1h.prototype,"_rotation",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3(0,0,0)}}),_descriptor17$2=_applyDecoratedDescriptor(_class2$1h.prototype,"_scale",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3(1,1,1)}}),_descriptor18$1=_applyDecoratedDescriptor(_class2$1h.prototype,"_arc",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return toRadian(360)}}),_descriptor19$1=_applyDecoratedDescriptor(_class2$1h.prototype,"_angle",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return toRadian(25)}}),_class$1w=_class2$1h))||_class$1w);function sphereEmit(e,t,i,r,n){switch(e){case EmitLocation.Volume:randomPointBetweenSphere(r,t*(1-i),t),Vec3.copy(n,r),Vec3.normalize(n,n);break;case EmitLocation.Shell:randomUnitVector(r),Vec3.multiplyScalar(r,r,t),Vec3.copy(n,r);break;default:console.warn(e+" is not supported for sphere emitter.")}}function hemisphereEmit(e,t,i,r,n){switch(e){case EmitLocation.Volume:randomPointBetweenSphere(r,t*(1-i),t),0<r.z&&(r.z*=-1),Vec3.copy(n,r),Vec3.normalize(n,n);break;case EmitLocation.Shell:randomUnitVector(r),Vec3.multiplyScalar(r,r,t),0<r.z&&(r.z*=-1),Vec3.copy(n,r);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}function coneEmit(e,t,i,r,n,s,a,o){switch(e){case EmitLocation.Base:randomPointBetweenCircleAtFixedAngle(a,t*(1-i),t,r),Vec2.multiplyScalar(o,a,Math.sin(n)),o.z=-Math.cos(n)*t,Vec3.normalize(o,o),a.z=0;break;case EmitLocation.Shell:fixedAngleUnitVector2(a,r),Vec2.multiplyScalar(o,a,Math.sin(n)),o.z=-Math.cos(n),Vec3.normalize(o,o),Vec2.multiplyScalar(a,a,t),a.z=0;break;case EmitLocation.Volume:randomPointBetweenCircleAtFixedAngle(a,t*(1-i),t,r),Vec2.multiplyScalar(o,a,Math.sin(n)),o.z=-Math.cos(n)*t,Vec3.normalize(o,o),a.z=0,Vec3.add(a,a,Vec3.multiplyScalar(_intermediVec,o,s*random()/-o.z));break;default:console.warn(e+" is not supported for cone emitter.")}}function boxEmit(e,t,i,r){switch(e){case EmitLocation.Volume:randomPointInCube(i,_unitBoxExtent);break;case EmitLocation.Shell:_intermediArr.splice(0,_intermediArr.length),_intermediArr.push(randomRange(-.5,.5)),_intermediArr.push(randomRange(-.5,.5)),_intermediArr.push(.5*randomSign()),randomSortArray(_intermediArr),applyBoxThickness(_intermediArr,t),Vec3.set(i,_intermediArr[0],_intermediArr[1],_intermediArr[2]);break;case EmitLocation.Edge:_intermediArr.splice(0,_intermediArr.length),_intermediArr.push(randomRange(-.5,.5)),_intermediArr.push(.5*randomSign()),_intermediArr.push(.5*randomSign()),randomSortArray(_intermediArr),applyBoxThickness(_intermediArr,t),Vec3.set(i,_intermediArr[0],_intermediArr[1],_intermediArr[2]);break;default:console.warn(e+" is not supported for box emitter.")}Vec3.copy(r,particleEmitZAxis)}function circleEmit(e,t,i,r,n){randomPointBetweenCircleAtFixedAngle(r,e*(1-t),e,i),Vec3.normalize(n,r)}function applyBoxThickness(e,t){0<t.x&&(e[0]+=.5*randomRange(-t.x,t.x),e[0]=clamp(e[0],-.5,.5)),0<t.y&&(e[1]+=.5*randomRange(-t.y,t.y),e[1]=clamp(e[1],-.5,.5)),0<t.z&&(e[2]+=.5*randomRange(-t.z,t.z),e[2]=clamp(e[2],-.5,.5))}var _dec$1v,_dec2$16,_dec3$R,_dec4$J,_dec5$E,_dec6$z,_dec7$p,_dec8$f,_dec9$d,_dec10$b,_dec11$a,_dec12$9,_class$1x,_class2$1i,_descriptor$1e,_descriptor2$13,_descriptor3$P,_descriptor4$K,_descriptor5$B,_temp$1p,_dec$1w,_dec2$17,_dec3$S,_dec4$K,_dec5$F,_dec6$A,_dec7$q,_dec8$g,_dec9$e,_dec10$c,_dec11$b,_dec12$a,_dec13$5,_dec14$4,_dec15$4,_class$1y,_class2$1j,_descriptor$1f,_descriptor2$14,_descriptor3$Q,_descriptor4$L,_descriptor5$C,_descriptor6$q,_descriptor7$l,_descriptor8$i,_descriptor9$e,_descriptor10$d,_descriptor11$b,_descriptor12$a,_descriptor13$9,_temp$1q,ParticleBatchModel=function(){function r(e,t){var i;return _classCallCheck(this,r),(i=_possibleConstructorReturn(this,_getPrototypeOf(r).call(this,e,t)))._capacity=void 0,i._vertAttrs=void 0,i._vertSize=void 0,i._vBuffer=void 0,i._vertAttrsFloatCount=void 0,i._vdataF32=void 0,i._vdataUint32=void 0,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=void 0,i._mesh=void 0,i._vertCount=0,i._indexCount=0,i._type="particle-batch",i._capacity=0,i._vertAttrs=null,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:exports.GFXBufferUsageBit.INDIRECT,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:GFX_DRAW_INFO_SIZE,stride:1}),i._subMeshData=null,i._mesh=null,i}return _inherits(r,Model),_createClass(r,[{key:"setCapacity",value:function(e){var t=this._capacity!==e;this._capacity=e,this._inited&&t&&this._recreateBuffer()}},{key:"setVertexAttributes",value:function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;var i=this._vertAttrs,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}var a=s;a.offset=this._vertSize,this._vertSize+=GFXFormatInfos[a.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this._inited=!0}}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex(function(e){return e.name===exports.GFXAttributeName.ATTR_TEX_COORD3}),r=this._vertAttrs[i++].offset;if(this._mesh.copyAttribute(0,exports.GFXAttributeName.ATTR_POSITION,t,this._vertSize,r),r=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,exports.GFXAttributeName.ATTR_NORMAL,t,this._vertSize,r),r=this._vertAttrs[this._vertAttrs.findIndex(function(e){return e.name===exports.GFXAttributeName.ATTR_TEX_COORD})].offset,this._mesh.copyAttribute(0,exports.GFXAttributeName.ATTR_TEX_COORD,t,this._vertSize,r),r=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,exports.GFXAttributeName.ATTR_COLOR,t,this._vertSize,r))for(var n=new Uint32Array(t),s=0;s<this._vertCount;++s)n[s*this._vertAttrsFloatCount+r/4]=Color.WHITE._val;for(var a=new Float32Array(t),o=1;o<this._capacity;o++)a.copyWithin(o*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,c);for(var l=1;l<this._capacity;l++)for(var u=0;u<this._indexCount;u++)c[l*this._indexCount+u]=c[u]+l*this._vertCount}else for(var h=0,_=0;_<this._capacity;++_){var p=4*_;c[h++]=p,c[h++]=1+p,c[h++]=2+p,c[h++]=3+p,c[h++]=2+p,c[h++]=1+p}var d=this._device.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return d.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:d,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:exports.GFXPrimitiveMode.TRIANGLE_LIST,flatBuffers:[]},this.setSubModelMesh(0,this._subMeshData),t}},{key:"setSubModelMaterial",value:function(e,t){this.initLocalBindings(t),_get(_getPrototypeOf(r.prototype),"setSubModelMaterial",this).call(this,e,t)}},{key:"addParticleVertexData",value:function(e,t){if(this._mesh)for(var i=0;i<this._vertCount;i++){var r=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,r+=2,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4]}else{var n=e*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,this._vdataF32[n++]=t[1].x,this._vdataF32[n++]=t[1].y,this._vdataF32[n++]=t[1].z,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataF32[n++]=t[2].z,this._vdataF32[n++]=t[3].x,this._vdataF32[n++]=t[3].y,this._vdataF32[n++]=t[3].z,this._vdataUint32[n++]=t[4],t[5]&&(this._vdataF32[n++]=t[5].x,this._vdataF32[n++]=t[5].y,this._vdataF32[n++]=t[5].z)}}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"clear",value:function(){this.getSubModel(0).inputAssembler.indexCount=0}},{key:"destroy",value:function(){_get(_getPrototypeOf(r.prototype),"destroy",this).call(this),this._vBuffer=null,this._vdataF32=null,this._subMeshData&&this.destroySubMeshData(),this._iaInfoBuffer.destroy(),this._subMeshData=null}},{key:"_recreateBuffer",value:function(){this._vBuffer=this._createSubMeshData(),this.getSubModel(0).updateCommandBuffer(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy()}this._subMeshData.indexBuffer.destroy()}}]),r}(),Particle=function e(t){_classCallCheck(this,e),this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new Vec3(0,0,0),this.velocity=new Vec3(0,0,0),this.animatedVelocity=new Vec3(0,0,0),this.ultimateVelocity=new Vec3(0,0,0),this.angularVelocity=new Vec3(0,0,0),this.axisOfRotation=new Vec3(0,0,0),this.rotation=new Vec3(0,0,0),this.startSize=new Vec3(0,0,0),this.size=new Vec3(0,0,0),this.startColor=Color.WHITE.clone(),this.color=Color.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0},_tempAttribUV=new Vec3,_tempAttribUV0=new Vec2,_tempWorldTrans=new Mat4,_uvs$1=[0,0,1,0,0,1,1,1],CC_USE_WORLD_SPACE$1="CC_USE_WORLD_SPACE",CC_USE_BILLBOARD="CC_USE_BILLBOARD",CC_USE_STRETCHED_BILLBOARD="CC_USE_STRETCHED_BILLBOARD",CC_USE_HORIZONTAL_BILLBOARD="CC_USE_HORIZONTAL_BILLBOARD",CC_USE_VERTICAL_BILLBOARD="CC_USE_VERTICAL_BILLBOARD",CC_USE_MESH="CC_USE_MESH",_vertex_attrs$1=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD1,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD2,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8,isNormalized:!0}],_vertex_attrs_stretch=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD1,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD2,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8,isNormalized:!0},{name:exports.GFXAttributeName.ATTR_COLOR1,format:exports.GFXFormat.RGB32F}],_vertex_attrs_mesh=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD1,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD2,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8,isNormalized:!0},{name:exports.GFXAttributeName.ATTR_TEX_COORD3,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_NORMAL,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR1,format:exports.GFXFormat.RGBA8,isNormalized:!0}],ParticleSystemRenderer=(_dec$1v=ccclass("cc.ParticleSystemRenderer"),_dec2$16=property({type:RenderMode$1,displayOrder:0}),_dec3$R=property({displayOrder:1}),_dec4$J=property({displayOrder:2}),_dec5$E=property({type:RenderMode$1,displayOrder:3}),_dec6$z=property({displayOrder:4}),_dec7$p=property({displayOrder:5}),_dec8$f=property({displayOrder:6}),_dec9$d=property({type:cc.ParticleSystemComponent,visible:!1}),_dec10$b=property({type:Mesh,displayOrder:7}),_dec11$a=property({type:Material,displayOrder:8}),_dec12$9=property({type:Material,displayOrder:9}),_dec$1v((_applyDecoratedDescriptor((_class2$1i=_temp$1p=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"_renderMode",_descriptor$1e,this),_initializerDefineProperty(this,"_velocityScale",_descriptor2$13,this),_initializerDefineProperty(this,"_lengthScale",_descriptor3$P,this),_initializerDefineProperty(this,"_mesh",_descriptor4$K,this),_initializerDefineProperty(this,"_particleSystem",_descriptor5$B,this),this._defines=void 0,this._trailDefines=void 0,this._model=void 0,this.frameTile_velLenScale=void 0,this._node_scale=void 0,this.attrs=void 0,this._vertAttrs=[],this._particles=null,this._defaultMat=null,this._defaultTrailMat=null,this._model=null,this.frameTile_velLenScale=new Vec4(1,1,0,0),this._node_scale=new Vec4,this.attrs=new Array(5),this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},this._trailDefines={CC_USE_WORLD_SPACE:!0}}return _createClass(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._setVertexAttrib(),this._updateModel(),this._updateMaterialParams())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._model&&this._model.setVertexAttributes(this._renderMode===RenderMode$1.Mesh?this._mesh:null,this._vertAttrs)}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem.setMaterial(e,1)}}]),_createClass(e,[{key:"onInit",value:function(e){var t=this;this._particleSystem=e,this._particles=new RecyclePool(function(){return new Particle(t)},16),this._setVertexAttrib(),this.onEnable(),this._updateModel(),this._updateMaterialParams(),this._updateTrailMaterial()}},{key:"onEnable",value:function(){this._particleSystem&&(null==this._model&&(this._model=this._particleSystem._getRenderScene().createModel(ParticleBatchModel,this._particleSystem.node),this._model.visFlags=this._particleSystem.visibility),this._model.inited||(this._model.setCapacity(this._particleSystem.capacity),this._model.node=this._particleSystem.node),this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDestroy",value:function(){this._model&&(this._model.scene.destroyModel(this._model),this._model=null)}},{key:"clear",value:function(){this._particles.reset(),this._updateRenderData()}},{key:"_getFreeParticle",value:function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}},{key:"_setNewParticle",value:function(e){}},{key:"_updateParticles",value:function(e){switch(this._particleSystem.node.getWorldMatrix(_tempWorldTrans),this._particleSystem.scaleSpace){case Space.Local:this._particleSystem.node.getScale(this._node_scale);break;case Space.World:this._particleSystem.node.getWorldScale(this._node_scale)}(this._particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat).setProperty("scale",this._node_scale),this._particleSystem.velocityOvertimeModule.enable&&this._particleSystem.velocityOvertimeModule.update(this._particleSystem._simulationSpace,_tempWorldTrans),this._particleSystem.limitVelocityOvertimeModule.enable&&this._particleSystem.limitVelocityOvertimeModule.update(this._particleSystem._simulationSpace,_tempWorldTrans),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.update(this._particleSystem._simulationSpace,_tempWorldTrans),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.update();for(var t=0;t<this._particles.length;++t){var i=this._particles.data[t];i.remainingLifetime-=e,Vec3.set(i.animatedVelocity,0,0,0),i.remainingLifetime<0?(this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.removeParticle(i),this._particles.removeAt(t),--t):(i.velocity.y-=9.8*this._particleSystem.gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,i.randomSeed)*e,this._particleSystem.sizeOvertimeModule.enable&&this._particleSystem.sizeOvertimeModule.animate(i),this._particleSystem.colorOverLifetimeModule.enable&&this._particleSystem.colorOverLifetimeModule.animate(i),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.animate(i,e),this._particleSystem.velocityOvertimeModule.enable?this._particleSystem.velocityOvertimeModule.animate(i):Vec3.copy(i.ultimateVelocity,i.velocity),this._particleSystem.limitVelocityOvertimeModule.enable&&this._particleSystem.limitVelocityOvertimeModule.animate(i),this._particleSystem.rotationOvertimeModule.enable&&this._particleSystem.rotationOvertimeModule.animate(i,e),this._particleSystem.textureAnimationModule.enable&&this._particleSystem.textureAnimationModule.animate(i),Vec3.scaleAndAdd(i.position,i.position,i.ultimateVelocity,e),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.animate(i,e))}return this._particles.length}},{key:"_updateRenderData",value:function(){for(var e=0,t=this._renderMode===RenderMode$1.StrecthedBillboard,i=0;i<this._particles.length;++i){var r=this._particles.data[i],n=0;this._particleSystem.textureAnimationModule.enable&&(n=r.frameIndex),e=4*i;var s=0;if(this._renderMode!==RenderMode$1.Mesh)for(var a=0;a<4;++a)s=0,this.attrs[s++]=r.position,_tempAttribUV.x=_uvs$1[2*a],_tempAttribUV.y=_uvs$1[2*a+1],_tempAttribUV.z=n,this.attrs[s++]=_tempAttribUV,this.attrs[s++]=r.size,this.attrs[s++]=r.rotation,this.attrs[s++]=r.color._val,this.attrs[s++]=t?r.ultimateVelocity:null,this._model.addParticleVertexData(e++,this.attrs);else s=0,this.attrs[s++]=r.position,_tempAttribUV.z=n,this.attrs[s++]=_tempAttribUV,this.attrs[s++]=r.size,this.attrs[s++]=r.rotation,this.attrs[s++]=r.color._val,this._model.addParticleVertexData(i,this.attrs)}this._model.updateIA(this._particles.length)}},{key:"updateShaderUniform",value:function(){}},{key:"getParticleCount",value:function(){return this._particles.length}},{key:"_onMaterialModified",value:function(e,t){0===e?(this._updateModel(),this._updateMaterialParams()):this._updateTrailMaterial()}},{key:"_onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t),this._particleSystem.trailModule._trailModel&&1===e&&this._particleSystem.trailModule._trailModel.setSubModelMaterial(0,t)}},{key:"_setVertexAttrib",value:function(){switch(this._renderMode){case RenderMode$1.StrecthedBillboard:this._vertAttrs=_vertex_attrs_stretch.slice();break;case RenderMode$1.Mesh:this._vertAttrs=_vertex_attrs_mesh.slice();break;default:this._vertAttrs=_vertex_attrs$1.slice()}}},{key:"_updateMaterialParams",value:function(){if(this._particleSystem){null!=this._particleSystem.sharedMaterial&&-1===this._particleSystem.sharedMaterial._effectAsset._name.indexOf("particle")&&this._particleSystem.setMaterial(null,0,!1),null==this._particleSystem.sharedMaterial&&null==this._defaultMat&&(this._defaultMat=Material.getInstantiatedMaterial(builtinResMgr.get("default-particle-material"),this._particleSystem,!0));var e=this._particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat;this._particleSystem._simulationSpace===Space.World?this._defines[CC_USE_WORLD_SPACE$1]=!0:this._defines[CC_USE_WORLD_SPACE$1]=!1,this._renderMode===RenderMode$1.Billboard?(this._defines[CC_USE_BILLBOARD]=!0,this._defines[CC_USE_STRETCHED_BILLBOARD]=!1,this._defines[CC_USE_HORIZONTAL_BILLBOARD]=!1,this._defines[CC_USE_VERTICAL_BILLBOARD]=!1,this._defines[CC_USE_MESH]=!1):this._renderMode===RenderMode$1.StrecthedBillboard?(this._defines[CC_USE_BILLBOARD]=!1,this._defines[CC_USE_STRETCHED_BILLBOARD]=!0,this._defines[CC_USE_HORIZONTAL_BILLBOARD]=!1,this._defines[CC_USE_VERTICAL_BILLBOARD]=!1,this._defines[CC_USE_MESH]=!1,this.frameTile_velLenScale.z=this._velocityScale,this.frameTile_velLenScale.w=this._lengthScale):this._renderMode===RenderMode$1.HorizontalBillboard?(this._defines[CC_USE_BILLBOARD]=!1,this._defines[CC_USE_STRETCHED_BILLBOARD]=!1,this._defines[CC_USE_HORIZONTAL_BILLBOARD]=!0,this._defines[CC_USE_VERTICAL_BILLBOARD]=!1,this._defines[CC_USE_MESH]=!1):this._renderMode===RenderMode$1.VerticalBillboard?(this._defines[CC_USE_BILLBOARD]=!1,this._defines[CC_USE_STRETCHED_BILLBOARD]=!1,this._defines[CC_USE_HORIZONTAL_BILLBOARD]=!1,this._defines[CC_USE_VERTICAL_BILLBOARD]=!0,this._defines[CC_USE_MESH]=!1):this._renderMode===RenderMode$1.Mesh?(this._defines[CC_USE_BILLBOARD]=!1,this._defines[CC_USE_STRETCHED_BILLBOARD]=!1,this._defines[CC_USE_HORIZONTAL_BILLBOARD]=!1,this._defines[CC_USE_VERTICAL_BILLBOARD]=!1,this._defines[CC_USE_MESH]=!0):console.warn("particle system renderMode ".concat(this._renderMode," not support.")),this._particleSystem.textureAnimationModule.enable&&Vec2.set(this.frameTile_velLenScale,this._particleSystem.textureAnimationModule.numTilesX,this._particleSystem.textureAnimationModule.numTilesY),e.setProperty("frameTile_velLenScale",this.frameTile_velLenScale),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,this._particleSystem.sharedMaterial||this._defaultMat)}}},{key:"_updateTrailMaterial",value:function(){if(this._particleSystem.trailModule.enable){this._particleSystem._simulationSpace===Space.World||this._particleSystem.trailModule.space===Space.World?this._trailDefines[CC_USE_WORLD_SPACE$1]=!0:this._trailDefines[CC_USE_WORLD_SPACE$1]=!1;var e=this.trailMaterial;null===e&&null===this._defaultTrailMat&&(this._defaultTrailMat=Material.getInstantiatedMaterial(builtinResMgr.get("default-trail-material"),this._particleSystem,!0)),null===e&&(e=this._defaultTrailMat),e.recompileShaders(this._trailDefines),this._particleSystem.trailModule._updateMaterial()}}},{key:"_updateModel",value:function(){this._model&&this._model.setVertexAttributes(this._renderMode===RenderMode$1.Mesh?this._mesh:null,this._vertAttrs)}}]),e}()).prototype,"renderMode",[_dec2$16],Object.getOwnPropertyDescriptor(_class2$1i.prototype,"renderMode"),_class2$1i.prototype),_applyDecoratedDescriptor(_class2$1i.prototype,"velocityScale",[_dec3$R],Object.getOwnPropertyDescriptor(_class2$1i.prototype,"velocityScale"),_class2$1i.prototype),_applyDecoratedDescriptor(_class2$1i.prototype,"lengthScale",[_dec4$J],Object.getOwnPropertyDescriptor(_class2$1i.prototype,"lengthScale"),_class2$1i.prototype),_descriptor$1e=_applyDecoratedDescriptor(_class2$1i.prototype,"_renderMode",[_dec5$E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RenderMode$1.Billboard}}),_descriptor2$13=_applyDecoratedDescriptor(_class2$1i.prototype,"_velocityScale",[_dec6$z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor3$P=_applyDecoratedDescriptor(_class2$1i.prototype,"_lengthScale",[_dec7$p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor4$K=_applyDecoratedDescriptor(_class2$1i.prototype,"_mesh",[_dec8$f],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor5$B=_applyDecoratedDescriptor(_class2$1i.prototype,"_particleSystem",[_dec9$d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_applyDecoratedDescriptor(_class2$1i.prototype,"mesh",[_dec10$b],Object.getOwnPropertyDescriptor(_class2$1i.prototype,"mesh"),_class2$1i.prototype),_applyDecoratedDescriptor(_class2$1i.prototype,"particleMaterial",[_dec11$a],Object.getOwnPropertyDescriptor(_class2$1i.prototype,"particleMaterial"),_class2$1i.prototype),_applyDecoratedDescriptor(_class2$1i.prototype,"trailMaterial",[_dec12$9],Object.getOwnPropertyDescriptor(_class2$1i.prototype,"trailMaterial"),_class2$1i.prototype),_class$1x=_class2$1i))||_class$1x);Object.assign(ParticleSystemRenderer,{uv:_uvs$1});var _dec$1x,_dec2$18,_dec3$T,_dec4$L,_dec5$G,_dec6$B,_dec7$r,_dec8$h,_dec9$f,_dec10$d,_dec11$c,_dec12$b,_dec13$6,_dec14$5,_dec15$5,_dec16$3,_dec17$3,_dec18$3,_dec19$1,_dec20$1,_dec21$1,_dec22,_dec23,_dec24,_dec25,_dec26,_dec27,_dec28,_dec29,_dec30,_dec31,_dec32,_dec33,_dec34,_dec35,_dec36,_dec37,_dec38,_class$1z,_class2$1k,_descriptor$1g,_descriptor2$15,_descriptor3$R,_descriptor4$M,_descriptor5$D,_descriptor6$r,_descriptor7$m,_descriptor8$j,_descriptor9$f,_descriptor10$e,_descriptor11$c,_descriptor12$b,_descriptor13$a,_descriptor14$8,_descriptor15$4,_descriptor16$4,_descriptor17$3,_descriptor18$2,_descriptor19$2,_descriptor20,_descriptor21,_descriptor22,_descriptor23,_descriptor24,_descriptor25,_descriptor26,_descriptor27,_descriptor28,_descriptor29,_descriptor30,_descriptor31,_descriptor32,_descriptor33,_descriptor34,_temp$1r,BoxShape,SphereShape,RigidBody,PhysicsWorld,PRE_TRIANGLE_INDEX=1,NEXT_TRIANGLE_INDEX=4,DIRECTION_THRESHOLD=Math.cos(toRadian(100)),_temp_trailEle={position:new Vec3,velocity:new Vec3},_temp_quat=new Quat,_temp_xform=new Mat4,_temp_vec3=new Vec3,_temp_vec3_1$1=new Vec3,_temp_color=new Color,TrailSegment=function(){function t(e){for(_classCallCheck(this,t),this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new Vec3,lifetime:0,width:0,velocity:new Vec3,direction:0,color:new Color})}return _createClass(t,[{key:"getElement",value:function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])}},{key:"addElement",value:function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new Vec3,lifetime:0,width:0,velocity:new Vec3,direction:0,color:new Color}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]}},{key:"iterateElement",value:function(e,t,i,r){for(var n=this.start>=this.end?this.end+this.trailElements.length:this.end,s=this.start;s<n;s++)t(e,this.trailElements[s%this.trailElements.length],i,r)&&(this.start++,this.start%=this.trailElements.length);this.start===n&&(this.start=-1,this.end=-1)}},{key:"count",value:function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}},{key:"clear",value:function(){this.start=-1,this.end=-1}}]),t}(),TrailModule=(_dec$1w=ccclass("cc.TrailModule"),_dec2$17=property({displayOrder:0}),_dec3$S=property({type:TrailMode,displayOrder:1}),_dec4$K=property({type:CurveRange,displayOrder:3}),_dec5$F=property({displayOrder:5}),_dec6$A=property({type:Space,displayOrder:6}),_dec7$q=property({displayOrder:7}),_dec8$g=property({type:TextureMode,displayOrder:8}),_dec9$e=property({displayOrder:9}),_dec10$c=property({type:CurveRange,displayOrder:10}),_dec11$b=property({displayOrder:11}),_dec12$a=property({type:GradientRange,displayOrder:12}),_dec13$5=property({type:GradientRange,displayOrder:13}),_dec14$4=property({type:Space}),_dec15$4=property({type:cc.ParticleSystemComponent,visible:!1}),_dec$1w((_applyDecoratedDescriptor((_class2$1j=_temp$1q=function(){function s(){_classCallCheck(this,s),_initializerDefineProperty(this,"_enable",_descriptor$1f,this),_initializerDefineProperty(this,"mode",_descriptor2$14,this),_initializerDefineProperty(this,"lifeTime",_descriptor3$Q,this),_initializerDefineProperty(this,"_minParticleDistance",_descriptor4$L,this),_initializerDefineProperty(this,"existWithParticles",_descriptor5$C,this),_initializerDefineProperty(this,"textureMode",_descriptor6$q,this),_initializerDefineProperty(this,"widthFromParticle",_descriptor7$l,this),_initializerDefineProperty(this,"widthRatio",_descriptor8$i,this),_initializerDefineProperty(this,"colorFromParticle",_descriptor9$e,this),_initializerDefineProperty(this,"colorOverTrail",_descriptor10$d,this),_initializerDefineProperty(this,"colorOvertime",_descriptor11$b,this),_initializerDefineProperty(this,"_space",_descriptor12$a,this),_initializerDefineProperty(this,"_particleSystem",_descriptor13$9,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._defaultMat=null,this._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},this._vertAttrs=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RGBA32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD1,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_COLOR,format:exports.GFXFormat.RGBA8,isNormalized:!0}],this._vertSize=0;var e=this._vertAttrs,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r;this._vertSize+=GFXFormatInfos[n.format].size}this._particleTrail=new Map}return _createClass(s,[{key:"enable",get:function(){return this._enable},set:function(e){e&&!this._trailModel&&this._createModel(),e&&!this._enable&&(this._enable=e,this._particleSystem.renderer._updateTrailMaterial()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e)}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e,this._particleSystem&&this._particleSystem.renderer._updateTrailMaterial()}}]),_createClass(s,[{key:"onInit",value:function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;var t=0,i=this._particleSystem.bursts,r=Array.isArray(i),n=0;for(i=r?i:i[Symbol.iterator]();;){var s;if(r){if(n>=i.length)break;s=i[n++]}else{if((n=i.next()).done)break;s=n.value}t+=s.getMaxCount(this._particleSystem)}this._trailNum=Math.ceil(this._particleSystem.startLifetime.getMax()*this.lifeTime.getMax()*60*(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration+t)),this._trailSegments=new Pool$1(function(){return new TrailSegment(10)},Math.ceil(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration)),this._enable&&(this.enable=this._enable,this._updateMaterial())}},{key:"onEnable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!0)}},{key:"onDisable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!1)}},{key:"destroy",value:function(){this._trailModel&&(this._trailModel.scene.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.clear(function(e){e.trailElements.length=0}),this._trailSegments=null)}},{key:"clear",value:function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData()}}},{key:"_updateMaterial",value:function(){if(this._particleSystem&&this._trailModel){var e=this._particleSystem.renderer.trailMaterial;e?this._trailModel.setSubModelMaterial(0,e):this._trailModel.setSubModelMaterial(0,this._particleSystem.renderer._defaultTrailMat)}}},{key:"update",value:function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===Space.World&&this._particleSystem._simulationSpace===Space.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(_temp_xform),this._particleSystem.node.getWorldRotation(_temp_quat)):this._needTransform=!1}},{key:"animate",value:function(e,t){if(this._trailSegments){var i=this._particleTrail.get(e);i||(i=this._trailSegments.alloc(),this._particleTrail.set(e,i));var r=i.getElement(i.end-1);if(this._needTransform?Vec3.transformMat4(_temp_vec3,e.position,_temp_xform):Vec3.copy(_temp_vec3,e.position),!(r&&(i.iterateElement(this,this._updateTrailElement,e,t),Vec3.squaredDistance(r.position,_temp_vec3)<this._minSquaredDistance))&&(r=i.addElement())){Vec3.copy(r.position,_temp_vec3),r.lifetime=0,this.widthFromParticle?r.width=e.size.x*this.widthRatio.evaluate(0,1):r.width=this.widthRatio.evaluate(0,1);var n=i.count();if(2===n){var s=i.getElement(i.end-2);Vec3.subtract(s.velocity,r.position,s.position)}else if(2<n){var a=i.getElement(i.end-2),o=i.getElement(i.end-3);Vec3.subtract(_temp_vec3,o.position,a.position),Vec3.subtract(_temp_vec3_1$1,r.position,a.position),Vec3.subtract(a.velocity,_temp_vec3_1$1,_temp_vec3),Vec3.equals(Vec3.ZERO,a.velocity)&&Vec3.copy(a.velocity,_temp_vec3),Vec3.normalize(a.velocity,a.velocity),this._checkDirectionReverse(a,o)}this.colorFromParticle?r.color.set(e.color):r.color.set(this.colorOvertime.evaluate(0,1))}}}},{key:"removeParticle",value:function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))}},{key:"updateRenderData",value:function(){this.vbOffset=0,this.ibOffset=0;var e=this._particleTrail.keys(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}var n=r,s=this._particleTrail.get(n);if(-1!==s.start){var a=4*this.vbOffset/this._vertSize,o=s.start>=s.end?s.end+s.trailElements.length:s.end,c=o-s.start,l=1/c,u=s.trailElements[s.start];this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1,1),a,1,0,NEXT_TRIANGLE_INDEX);for(var h=s.start+1;h<o;h++){var _=s.trailElements[h%s.trailElements.length],p=h-s.start;this._fillVertexBuffer(_,this.colorOverTrail.evaluate(1-p/c,1),a,1-p*l,p,PRE_TRIANGLE_INDEX|NEXT_TRIANGLE_INDEX)}if(this._needTransform?Vec3.transformMat4(_temp_trailEle.position,n.position,_temp_xform):Vec3.copy(_temp_trailEle.position,n.position),1==c||2==c){var d=s.getElement(s.end-1);Vec3.subtract(d.velocity,_temp_trailEle.position,d.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=d.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=d.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=d.velocity.z,this._vbF32[this.vbOffset-4]=d.velocity.x,this._vbF32[this.vbOffset-3]=d.velocity.y,this._vbF32[this.vbOffset-2]=d.velocity.z,Vec3.subtract(_temp_trailEle.velocity,_temp_trailEle.position,d.position),this._checkDirectionReverse(_temp_trailEle,d)}else if(2<c){var f=s.getElement(s.end-1),m=s.getElement(s.end-2);Vec3.subtract(_temp_vec3,m.position,f.position),Vec3.subtract(_temp_vec3_1$1,_temp_trailEle.position,f.position),Vec3.normalize(_temp_vec3,_temp_vec3),Vec3.normalize(_temp_vec3_1$1,_temp_vec3_1$1),Vec3.subtract(f.velocity,_temp_vec3_1$1,_temp_vec3),Vec3.normalize(f.velocity,f.velocity),this._checkDirectionReverse(f,m),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(f,this.colorOverTrail.evaluate(l,1),a,l,c-1,PRE_TRIANGLE_INDEX|NEXT_TRIANGLE_INDEX),Vec3.subtract(_temp_trailEle.velocity,_temp_trailEle.position,f.position),Vec3.normalize(_temp_trailEle.velocity,_temp_trailEle.velocity),this._checkDirectionReverse(_temp_trailEle,f)}this.widthFromParticle?_temp_trailEle.width=n.size.x*this.widthRatio.evaluate(0,1):_temp_trailEle.width=this.widthRatio.evaluate(0,1),_temp_trailEle.color=n.color,Vec3.equals(_temp_trailEle.velocity,Vec3.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(_temp_trailEle,this.colorOverTrail.evaluate(0,1),a,0,c,PRE_TRIANGLE_INDEX)}}this.updateIA(this.ibOffset)}},{key:"updateIA",value:function(e){if(this._trailModel&&0<this._trailModel.subModelNum){var t=this._trailModel.getSubModel(0);t.inputAssembler.vertexBuffers[0].update(this._vbF32),t.inputAssembler.indexBuffer.update(this._iBuffer),t.inputAssembler.indexCount=e,t.inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}}},{key:"_createModel",value:function(){if(!this._trailModel){var e=director.root.device,t=e.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:this._vertSize*(this._trailNum+1)*2,stride:this._vertSize}),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i);var r=e.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});this._iBuffer=new Uint16Array(6*this._trailNum),r.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer({usage:exports.GFXBufferUsageBit.INDIRECT,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:GFX_DRAW_INFO_SIZE,stride:1}),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[t],indexBuffer:r,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:exports.GFXPrimitiveMode.TRIANGLE_LIST,flatBuffers:[]},this._trailModel=this._particleSystem._getRenderScene().createModel(Model,this._particleSystem.node),this._trailModel.visFlags=this._particleSystem.visibility,this._trailModel.setSubModelMesh(0,this._subMeshData),this._trailModel.enabled=!0}}},{key:"_updateTrailElement",value:function(e,t,i,r){return t.lifetime+=r,e.colorFromParticle?(t.color.set(i.color),t.color.multiply(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime}},{key:"_fillVertexBuffer",value:function(e,t,i,r,n,s){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=r,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,_temp_color.set(e.color),_temp_color.multiply(t),this._vbUint32[this.vbOffset++]=_temp_color._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=r,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=_temp_color._val,s&PRE_TRIANGLE_INDEX&&(this._iBuffer[this.ibOffset++]=i+2*n,this._iBuffer[this.ibOffset++]=i+2*n-1,this._iBuffer[this.ibOffset++]=i+2*n+1),s&NEXT_TRIANGLE_INDEX&&(this._iBuffer[this.ibOffset++]=i+2*n,this._iBuffer[this.ibOffset++]=i+2*n+1,this._iBuffer[this.ibOffset++]=i+2*n+2)}},{key:"_checkDirectionReverse",value:function(e,t){Vec3.dot(e.velocity,t.velocity)<DIRECTION_THRESHOLD?e.direction=1-t.direction:e.direction=t.direction}}]),s}()).prototype,"enable",[_dec2$17],Object.getOwnPropertyDescriptor(_class2$1j.prototype,"enable"),_class2$1j.prototype),_descriptor$1f=_applyDecoratedDescriptor(_class2$1j.prototype,"_enable",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2$14=_applyDecoratedDescriptor(_class2$1j.prototype,"mode",[_dec3$S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TrailMode.Particles}}),_descriptor3$Q=_applyDecoratedDescriptor(_class2$1j.prototype,"lifeTime",[_dec4$K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor4$L=_applyDecoratedDescriptor(_class2$1j.prototype,"_minParticleDistance",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_applyDecoratedDescriptor(_class2$1j.prototype,"minParticleDistance",[_dec5$F],Object.getOwnPropertyDescriptor(_class2$1j.prototype,"minParticleDistance"),_class2$1j.prototype),_applyDecoratedDescriptor(_class2$1j.prototype,"space",[_dec6$A],Object.getOwnPropertyDescriptor(_class2$1j.prototype,"space"),_class2$1j.prototype),_descriptor5$C=_applyDecoratedDescriptor(_class2$1j.prototype,"existWithParticles",[_dec7$q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor6$q=_applyDecoratedDescriptor(_class2$1j.prototype,"textureMode",[_dec8$g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TextureMode.Stretch}}),_descriptor7$l=_applyDecoratedDescriptor(_class2$1j.prototype,"widthFromParticle",[_dec9$e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor8$i=_applyDecoratedDescriptor(_class2$1j.prototype,"widthRatio",[_dec10$c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor9$e=_applyDecoratedDescriptor(_class2$1j.prototype,"colorFromParticle",[_dec11$b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor10$d=_applyDecoratedDescriptor(_class2$1j.prototype,"colorOverTrail",[_dec12$a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new GradientRange}}),_descriptor11$b=_applyDecoratedDescriptor(_class2$1j.prototype,"colorOvertime",[_dec13$5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new GradientRange}}),_descriptor12$a=_applyDecoratedDescriptor(_class2$1j.prototype,"_space",[_dec14$4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Space.World}}),_descriptor13$9=_applyDecoratedDescriptor(_class2$1j.prototype,"_particleSystem",[_dec15$4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_class$1y=_class2$1j))||_class$1y),_world_mat=new Mat4,ParticleSystemComponent=(_dec$1x=ccclass("cc.ParticleSystemComponent"),_dec2$18=menu("Components/ParticleSystem"),_dec3$T=executionOrder(99),_dec4$L=property({displayOrder:1}),_dec5$G=property({type:GradientRange,displayOrder:8}),_dec6$B=property({type:Space,displayOrder:9}),_dec7$r=property({displayOrder:10}),_dec8$h=property({type:CurveRange,displayOrder:10,formerlySerializedAs:"startSize"}),_dec9$f=property({type:CurveRange,displayOrder:10}),_dec10$d=property({type:CurveRange,displayOrder:10}),_dec11$c=property({type:CurveRange,range:[-1,1],displayOrder:11}),_dec12$b=property({displayOrder:12}),_dec13$6=property({type:CurveRange,range:[-1,1],radian:!0,displayOrder:12}),_dec14$5=property({type:CurveRange,range:[-1,1],radian:!0,displayOrder:12}),_dec15$5=property({type:CurveRange,range:[-1,1],radian:!0,displayOrder:12,formerlySerializedAs:"startRotation"}),_dec16$3=property({type:CurveRange,displayOrder:6}),_dec17$3=property({type:CurveRange,displayOrder:7}),_dec18$3=property({displayOrder:0}),_dec19$1=property({displayOrder:2}),_dec20$1=property({displayOrder:3}),_dec21$1=property({type:Space,displayOrder:4}),_dec22=property({displayOrder:5}),_dec23=property({displayOrder:2}),_dec24=property({type:CurveRange,range:[-1,1],displayOrder:13}),_dec25=property({type:CurveRange,displayOrder:14}),_dec26=property({type:CurveRange,displayOrder:15}),_dec27=property({type:[Burst],displayOrder:16}),_dec28=property({type:Material,displayName:"Materials",visible:!1,override:!0}),_dec29=property({type:ColorOvertimeModule,displayOrder:23}),_dec30=property({type:ShapeModule,displayOrder:17}),_dec31=property({type:SizeOvertimeModule,displayOrder:21}),_dec32=property({type:VelocityOvertimeModule,displayOrder:18}),_dec33=property({type:ForceOvertimeModule,displayOrder:19}),_dec34=property({type:LimitVelocityOvertimeModule,displayOrder:20}),_dec35=property({type:RotationOvertimeModule,displayOrder:22}),_dec36=property({type:TextureAnimationModule,displayOrder:24}),_dec37=property({type:TrailModule,displayOrder:25}),_dec38=property({type:ParticleSystemRenderer,displayOrder:26}),_dec$1x(_class$1z=_dec2$18(_class$1z=_dec3$T(_class$1z=executeInEditMode((_applyDecoratedDescriptor((_class2$1k=_temp$1r=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"startColor",_descriptor$1g,_assertThisInitialized(e)),_initializerDefineProperty(e,"scaleSpace",_descriptor2$15,_assertThisInitialized(e)),_initializerDefineProperty(e,"startSize3D",_descriptor3$R,_assertThisInitialized(e)),_initializerDefineProperty(e,"startSizeX",_descriptor4$M,_assertThisInitialized(e)),_initializerDefineProperty(e,"startSizeY",_descriptor5$D,_assertThisInitialized(e)),_initializerDefineProperty(e,"startSizeZ",_descriptor6$r,_assertThisInitialized(e)),_initializerDefineProperty(e,"startSpeed",_descriptor7$m,_assertThisInitialized(e)),_initializerDefineProperty(e,"startRotation3D",_descriptor8$j,_assertThisInitialized(e)),_initializerDefineProperty(e,"startRotationX",_descriptor9$f,_assertThisInitialized(e)),_initializerDefineProperty(e,"startRotationY",_descriptor10$e,_assertThisInitialized(e)),_initializerDefineProperty(e,"startRotationZ",_descriptor11$c,_assertThisInitialized(e)),_initializerDefineProperty(e,"startDelay",_descriptor12$b,_assertThisInitialized(e)),_initializerDefineProperty(e,"startLifetime",_descriptor13$a,_assertThisInitialized(e)),_initializerDefineProperty(e,"duration",_descriptor14$8,_assertThisInitialized(e)),_initializerDefineProperty(e,"loop",_descriptor15$4,_assertThisInitialized(e)),_initializerDefineProperty(e,"simulationSpeed",_descriptor16$4,_assertThisInitialized(e)),_initializerDefineProperty(e,"playOnAwake",_descriptor17$3,_assertThisInitialized(e)),_initializerDefineProperty(e,"gravityModifier",_descriptor18$2,_assertThisInitialized(e)),_initializerDefineProperty(e,"rateOverTime",_descriptor19$2,_assertThisInitialized(e)),_initializerDefineProperty(e,"rateOverDistance",_descriptor20,_assertThisInitialized(e)),_initializerDefineProperty(e,"bursts",_descriptor21,_assertThisInitialized(e)),_initializerDefineProperty(e,"colorOverLifetimeModule",_descriptor22,_assertThisInitialized(e)),_initializerDefineProperty(e,"shapeModule",_descriptor23,_assertThisInitialized(e)),_initializerDefineProperty(e,"sizeOvertimeModule",_descriptor24,_assertThisInitialized(e)),_initializerDefineProperty(e,"velocityOvertimeModule",_descriptor25,_assertThisInitialized(e)),_initializerDefineProperty(e,"forceOvertimeModule",_descriptor26,_assertThisInitialized(e)),_initializerDefineProperty(e,"limitVelocityOvertimeModule",_descriptor27,_assertThisInitialized(e)),_initializerDefineProperty(e,"rotationOvertimeModule",_descriptor28,_assertThisInitialized(e)),_initializerDefineProperty(e,"textureAnimationModule",_descriptor29,_assertThisInitialized(e)),_initializerDefineProperty(e,"trailModule",_descriptor30,_assertThisInitialized(e)),_initializerDefineProperty(e,"renderer",_descriptor31,_assertThisInitialized(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,_initializerDefineProperty(e,"_prewarm",_descriptor32,_assertThisInitialized(e)),_initializerDefineProperty(e,"_capacity",_descriptor33,_assertThisInitialized(e)),_initializerDefineProperty(e,"_simulationSpace",_descriptor34,_assertThisInitialized(e)),e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new Vec3,e._curWPos=new Vec3,e._customData1=new Vec2,e._customData2=new Vec2,e._subEmitters=[],e}return _inherits(t,RenderableComponent),_createClass(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=e,this.renderer&&this.renderer._model&&this.renderer._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.renderer._updateMaterialParams(),this.renderer._updateTrailMaterial())}},{key:"sharedMaterials",get:function(){return _get(_getPrototypeOf(t.prototype),"sharedMaterials",this)},set:function(e){_set(_getPrototypeOf(t.prototype),"sharedMaterials",e,this,!0)}}]),_createClass(t,[{key:"onLoad",value:function(){this.renderer.onInit(this),this.shapeModule.onInit(this),this.trailModule.onInit(this),this.textureAnimationModule.onInit(this),this._resetPosition()}},{key:"_onMaterialModified",value:function(e,t){this.renderer._onMaterialModified(e,t)}},{key:"_onRebuildPSO",value:function(e,t){this.renderer._onRebuildPSO(e,t)}},{key:"_collectModels",value:function(){return this._models.length=0,this._models.push(this.renderer._model),this.trailModule.enable&&this.trailModule._trailModel&&this._models.push(this.trailModule._trailModel),this._models}},{key:"_changeSceneInModel",value:function(){if(this.isValid){var e=this.renderer;e&&e._model&&(e._model.scene.destroyModel(e._model),e._model=null,e.onEnable(),e._updateModel(),e._updateMaterialParams());var t=this.trailModule;t&&t._trailModel&&(t._trailModel.scene.destroyModel(t._trailModel),t._trailModel=null,t.enable=t._enable,e._updateTrailMaterial())}}},{key:"play",value:function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem()}},{key:"pause",value:function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}},{key:"stop",value:function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0}},{key:"clear",value:function(){this.enabledInHierarchy&&(this.renderer.clear(),this.trailModule.clear())}},{key:"getParticleCount",value:function(){return this.renderer.getParticleCount()}},{key:"setCustomData1",value:function(e,t){Vec2.set(this._customData1,e,t)}},{key:"setCustomData2",value:function(e,t){Vec2.set(this._customData2,e,t)}},{key:"onDestroy",value:function(){this.renderer.onDestroy(),this.trailModule.destroy()}},{key:"onEnable",value:function(){this.playOnAwake&&this.play(),this.renderer.onEnable(),this.trailModule.onEnable()}},{key:"onDisable",value:function(){this.renderer.onDisable(),this.trailModule.onDisable()}},{key:"update",value:function(e){var t=e*this.simulationSpeed;this._isPlaying&&(this._time+=t,this._emit(t),0!==this.renderer._updateParticles(t)||this._isEmitting||this.stop(),this.renderer._updateRenderData(),this.trailModule.enable&&this.trailModule.updateRenderData())}},{key:"_onVisiblityChange",value:function(e){this.renderer._model&&(this.renderer._model.visFlags=e)}},{key:"emit",value:function(e,t){for(var i=0;i<e;++i){var r=this.renderer._getFreeParticle();if(null===r)return;var n=pseudoRandom(randomRangeInt(0,INT_MAX));switch(this.shapeModule.enable?this.shapeModule.emit(r):(Vec3.set(r.position,0,0,0),Vec3.copy(r.velocity,particleEmitZAxis)),this.textureAnimationModule.enable&&this.textureAnimationModule.init(r),Vec3.multiplyScalar(r.velocity,r.velocity,this.startSpeed.evaluate(this._time/this.duration,n)),this._simulationSpace){case Space.Local:break;case Space.World:this.node.getWorldMatrix(_world_mat),Vec3.transformMat4(r.position,r.position,_world_mat);var s=new Quat;this.node.getWorldRotation(s),Vec3.transformQuat(r.velocity,r.velocity,s);break;case Space.Custom:}Vec3.copy(r.ultimateVelocity,r.velocity),this.startRotation3D?Vec3.set(r.rotation,this.startRotationX.evaluate(this._time/this.duration,n),this.startRotationY.evaluate(this._time/this.duration,n),this.startRotationZ.evaluate(this._time/this.duration,n)):Vec3.set(r.rotation,0,0,this.startRotationZ.evaluate(this._time/this.duration,n)),this.startSize3D?Vec3.set(r.startSize,this.startSizeX.evaluate(this._time/this.duration,n),this.startSizeY.evaluate(this._time/this.duration,n),this.startSizeZ.evaluate(this._time/this.duration,n)):(Vec3.set(r.startSize,this.startSizeX.evaluate(this._time/this.duration,n),1,1),r.startSize.y=r.startSize.x),Vec3.copy(r.size,r.startSize),r.startColor.set(this.startColor.evaluate(this._time/this.duration,n)),r.color.set(r.startColor),r.startLifetime=this.startLifetime.evaluate(this._time/this.duration,n)+t,r.remainingLifetime=r.startLifetime,r.randomSeed=randomRangeInt(0,233280),this.renderer._setNewParticle(r)}}},{key:"_prewarmSystem",value:function(){this.startDelay.mode=Mode$1.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.renderer._updateParticles(1)}},{key:"_emit",value:function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,1<this._emitRateTimeCounter&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,e)}this.node.getWorldPosition(this._curWPos);var r=Vec3.distance(this._curWPos,this._oldWPos);if(Vec3.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=r*this.rateOverDistance.evaluate(this._time/this.duration,1),1<this._emitRateDistanceCounter&&this._isEmitting){var n=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=n,this.emit(n,e)}var s=this.bursts,a=Array.isArray(s),o=0;for(s=a?s:s[Symbol.iterator]();;){var c;if(a){if(o>=s.length)break;c=s[o++]}else{if((o=s.next()).done)break;c=o.value}c.update(this,e)}}}},{key:"_resetPosition",value:function(){this.node.getWorldPosition(this._oldWPos),Vec3.copy(this._curWPos,this._oldWPos)}},{key:"addSubEmitter",value:function(e){this._subEmitters.push(e)}},{key:"removeSubEmitter",value:function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)}},{key:"addBurst",value:function(e){this.bursts.push(e)}},{key:"removeBurst",value:function(e){this.bursts.splice(this.bursts.indexOf(e),1)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}()).prototype,"capacity",[_dec4$L],Object.getOwnPropertyDescriptor(_class2$1k.prototype,"capacity"),_class2$1k.prototype),_descriptor$1g=_applyDecoratedDescriptor(_class2$1k.prototype,"startColor",[_dec5$G],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new GradientRange}}),_descriptor2$15=_applyDecoratedDescriptor(_class2$1k.prototype,"scaleSpace",[_dec6$B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Space.Local}}),_descriptor3$R=_applyDecoratedDescriptor(_class2$1k.prototype,"startSize3D",[_dec7$r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor4$M=_applyDecoratedDescriptor(_class2$1k.prototype,"startSizeX",[_dec8$h],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor5$D=_applyDecoratedDescriptor(_class2$1k.prototype,"startSizeY",[_dec9$f],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor6$r=_applyDecoratedDescriptor(_class2$1k.prototype,"startSizeZ",[_dec10$d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor7$m=_applyDecoratedDescriptor(_class2$1k.prototype,"startSpeed",[_dec11$c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor8$j=_applyDecoratedDescriptor(_class2$1k.prototype,"startRotation3D",[_dec12$b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor9$f=_applyDecoratedDescriptor(_class2$1k.prototype,"startRotationX",[_dec13$6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor10$e=_applyDecoratedDescriptor(_class2$1k.prototype,"startRotationY",[_dec14$5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor11$c=_applyDecoratedDescriptor(_class2$1k.prototype,"startRotationZ",[_dec15$5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor12$b=_applyDecoratedDescriptor(_class2$1k.prototype,"startDelay",[_dec16$3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor13$a=_applyDecoratedDescriptor(_class2$1k.prototype,"startLifetime",[_dec17$3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor14$8=_applyDecoratedDescriptor(_class2$1k.prototype,"duration",[_dec18$3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),_descriptor15$4=_applyDecoratedDescriptor(_class2$1k.prototype,"loop",[_dec19$1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_applyDecoratedDescriptor(_class2$1k.prototype,"prewarm",[_dec20$1],Object.getOwnPropertyDescriptor(_class2$1k.prototype,"prewarm"),_class2$1k.prototype),_applyDecoratedDescriptor(_class2$1k.prototype,"simulationSpace",[_dec21$1],Object.getOwnPropertyDescriptor(_class2$1k.prototype,"simulationSpace"),_class2$1k.prototype),_descriptor16$4=_applyDecoratedDescriptor(_class2$1k.prototype,"simulationSpeed",[_dec22],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor17$3=_applyDecoratedDescriptor(_class2$1k.prototype,"playOnAwake",[_dec23],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor18$2=_applyDecoratedDescriptor(_class2$1k.prototype,"gravityModifier",[_dec24],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor19$2=_applyDecoratedDescriptor(_class2$1k.prototype,"rateOverTime",[_dec25],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor20=_applyDecoratedDescriptor(_class2$1k.prototype,"rateOverDistance",[_dec26],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CurveRange}}),_descriptor21=_applyDecoratedDescriptor(_class2$1k.prototype,"bursts",[_dec27],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),_applyDecoratedDescriptor(_class2$1k.prototype,"sharedMaterials",[_dec28],Object.getOwnPropertyDescriptor(_class2$1k.prototype,"sharedMaterials"),_class2$1k.prototype),_descriptor22=_applyDecoratedDescriptor(_class2$1k.prototype,"colorOverLifetimeModule",[_dec29],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ColorOvertimeModule}}),_descriptor23=_applyDecoratedDescriptor(_class2$1k.prototype,"shapeModule",[_dec30],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ShapeModule}}),_descriptor24=_applyDecoratedDescriptor(_class2$1k.prototype,"sizeOvertimeModule",[_dec31],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SizeOvertimeModule}}),_descriptor25=_applyDecoratedDescriptor(_class2$1k.prototype,"velocityOvertimeModule",[_dec32],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new VelocityOvertimeModule}}),_descriptor26=_applyDecoratedDescriptor(_class2$1k.prototype,"forceOvertimeModule",[_dec33],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ForceOvertimeModule}}),_descriptor27=_applyDecoratedDescriptor(_class2$1k.prototype,"limitVelocityOvertimeModule",[_dec34],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new LimitVelocityOvertimeModule}}),_descriptor28=_applyDecoratedDescriptor(_class2$1k.prototype,"rotationOvertimeModule",[_dec35],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RotationOvertimeModule}}),_descriptor29=_applyDecoratedDescriptor(_class2$1k.prototype,"textureAnimationModule",[_dec36],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new TextureAnimationModule}}),_descriptor30=_applyDecoratedDescriptor(_class2$1k.prototype,"trailModule",[_dec37],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new TrailModule}}),_descriptor31=_applyDecoratedDescriptor(_class2$1k.prototype,"renderer",[_dec38],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ParticleSystemRenderer}}),_descriptor32=_applyDecoratedDescriptor(_class2$1k.prototype,"_prewarm",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor33=_applyDecoratedDescriptor(_class2$1k.prototype,"_capacity",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),_descriptor34=_applyDecoratedDescriptor(_class2$1k.prototype,"_simulationSpace",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Space.Local}}),_class$1z=_class2$1k))||_class$1z)||_class$1z)||_class$1z)||_class$1z),ParticleUtils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"instantiate",value:function(e){return this.registeredSceneEvent||(director.on(Director.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new Pool$1(function(){return instantiate(e)},1)),this.particleSystemPool.get(e._uuid).alloc()}},{key:"destroy",value:function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))}},{key:"onSceneUnload",value:function(){this.particleSystemPool.forEach(function(e){e.clear(function(e){e.destroy()})}),this.particleSystemPool.clear()}},{key:"play",value:function(e){var t=e.getComponentsInChildren(ParticleSystemComponent),i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.play()}}},{key:"stop",value:function(e){var t=e.getComponentsInChildren(ParticleSystemComponent),i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.stop()}}}]),e}();function instantiate$1(e,t,i,r){BoxShape=e,SphereShape=t,RigidBody=i,PhysicsWorld=r}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}ParticleUtils.particleSystemPool=new Map,ParticleUtils.registeredSceneEvent=!1,cc.ParticleSystemComponent=ParticleSystemComponent,cc.BillboardComponent=BillboardComponent,cc.LineComponent=LineComponent,cc.ParticleUtils=ParticleUtils;var ERigidBodyType,ETransformSource,cannon_min=createCommonjsModule(function(e,t){e.exports=function n(s,a,o){function c(i,e){if(!a[i]){if(!s[i]){var t="function"==typeof commonjsRequire&&commonjsRequire;if(!e&&t)return t(i,!0);if(l)return l(i,!0);throw new Error("Cannot find module '"+i+"'")}var r=a[i]={exports:{}};s[i][0].call(r.exports,function(e){var t=s[i][1][e];return c(t||e)},r,r.exports,n,s,a,o)}return a[i].exports}for(var l="function"==typeof commonjsRequire&&commonjsRequire,e=0;e<o.length;e++)c(o[e]);return c}({1:[function(e,t,i){t.exports={name:"@cocos/cannon",version:"1.0.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se), JayceLai",keywords:["cannon","cocos","creator","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -d doProfiling=false,DEBUG=false -c -m"},main:"./build/cannon.min.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,i){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Transform:e("./math/Transform"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(e,t,i){var r=e("../math/Vec3");function n(e){e=e||{},this.lowerBound=new r,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new r,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=n;var l=new r;n.prototype.setFromPoints=function(e,t,i,r){var n=this.lowerBound,s=this.upperBound,a=i;n.copy(e[0]),a&&a.vmult(n,n),s.copy(n);for(var o=1;o<e.length;o++){var c=e[o];a&&(a.vmult(c,l),c=l),c.x>s.x&&(s.x=c.x),c.x<n.x&&(n.x=c.x),c.y>s.y&&(s.y=c.y),c.y<n.y&&(n.y=c.y),c.z>s.z&&(s.z=c.z),c.z<n.z&&(n.z=c.z)}return t&&(t.vadd(n,n),t.vadd(s,s)),r&&(n.x-=r,n.y-=r,n.z-=r,s.x+=r,s.y+=r,s.z+=r),this},n.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},n.prototype.clone=function(){return(new n).copy(this)},n.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},n.prototype.overlaps=function(e){var t=this.lowerBound,i=this.upperBound,r=e.lowerBound,n=e.upperBound,s=r.x<=i.x&&i.x<=n.x||t.x<=n.x&&n.x<=i.x,a=r.y<=i.y&&i.y<=n.y||t.y<=n.y&&n.y<=i.y,o=r.z<=i.z&&i.z<=n.z||t.z<=n.z&&n.z<=i.z;return s&&a&&o},n.prototype.volume=function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)},n.prototype.contains=function(e){var t=this.lowerBound,i=this.upperBound,r=e.lowerBound,n=e.upperBound;return t.x<=r.x&&i.x>=n.x&&t.y<=r.y&&i.y>=n.y&&t.z<=r.z&&i.z>=n.z},n.prototype.getCorners=function(e,t,i,r,n,s,a,o){var c=this.lowerBound,l=this.upperBound;e.copy(c),t.set(l.x,c.y,c.z),i.set(l.x,l.y,c.z),r.set(c.x,l.y,l.z),n.set(l.x,c.y,c.z),s.set(c.x,l.y,c.z),a.set(c.x,c.y,l.z),o.copy(l)};var p=[new r,new r,new r,new r,new r,new r,new r,new r];n.prototype.toLocalFrame=function(e,t){var i=p,r=i[0],n=i[1],s=i[2],a=i[3],o=i[4],c=i[5],l=i[6],u=i[7];this.getCorners(r,n,s,a,o,c,l,u);for(var h=0;8!==h;h++){var _=i[h];e.pointToLocal(_,_)}return t.setFromPoints(i)},n.prototype.toWorldFrame=function(e,t){var i=p,r=i[0],n=i[1],s=i[2],a=i[3],o=i[4],c=i[5],l=i[6],u=i[7];this.getCorners(r,n,s,a,o,c,l,u);for(var h=0;8!==h;h++){var _=i[h];e.pointToWorld(_,_)}return t.setFromPoints(i)},n.prototype.overlapsRay=function(e){var t=1/e._direction.x,i=1/e._direction.y,r=1/e._direction.z,n=(this.lowerBound.x-e.from.x)*t,s=(this.upperBound.x-e.from.x)*t,a=(this.lowerBound.y-e.from.y)*i,o=(this.upperBound.y-e.from.y)*i,c=(this.lowerBound.z-e.from.z)*r,l=(this.upperBound.z-e.from.z)*r,u=Math.max(Math.max(Math.min(n,s),Math.min(a,o)),Math.min(c,l)),h=Math.min(Math.min(Math.max(n,s),Math.max(a,o)),Math.max(c,l));return!(h<0||h<u)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(e,t,i){function r(){this.matrix=[]}(t.exports=r).prototype.get=function(e,t){if((e=e.index)<(t=t.index)){var i=t;t=e,e=i}return this.matrix[(e*(e+1)>>1)+t-1]},r.prototype.set=function(e,t,i){if((e=e.index)<(t=t.index)){var r=t;t=e,e=r}this.matrix[(e*(e+1)>>1)+t-1]=i?1:0},r.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},r.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,i){var r=e("../objects/Body"),n=e("../math/Vec3"),s=e("../math/Quaternion");function a(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),(t.exports=a).prototype.collisionPairs=function(e,t,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")},a.prototype.needBroadphaseCollision=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)&&(0==(e.type&r.STATIC)&&e.sleepState!==r.SLEEPING||0==(t.type&r.STATIC)&&t.sleepState!==r.SLEEPING)},a.prototype.intersectionTest=function(e,t,i,r){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,r):this.doBoundingSphereBroadphase(e,t,i,r)};var o=new n;new n,new s,new n,a.prototype.doBoundingSphereBroadphase=function(e,t,i,r){var n=o;t.position.vsub(e.position,n);var s=Math.pow(e.boundingRadius+t.boundingRadius,2);n.norm2()<s&&(i.push(e),r.push(t))},a.prototype.doBoundingBoxBroadphase=function(e,t,i,r){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),r.push(t))};var h={keys:[]},_=[],p=[];a.prototype.makePairsUnique=function(e,t){for(var i=h,r=_,n=p,s=e.length,a=0;a!==s;a++)r[a]=e[a],n[a]=t[a];for(e.length=0,a=t.length=0;a!==s;a++){var o=r[a].id,c=n[a].id;i[l=o<c?o+","+c:c+","+o]=a,i.keys.push(l)}for(a=0;a!==i.keys.length;a++){var l=i.keys.pop(),u=i[l];e.push(r[u]),t.push(n[u]),delete i[l]}},a.prototype.setWorld=function(e){};var c=new n;a.boundingSphereCheck=function(e,t){var i=c;return e.position.vsub(t.position,i),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()},a.prototype.aabbQuery=function(e,t,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(e,t,i){t.exports=r;var o=e("./Broadphase"),c=e("../math/Vec3"),ie=e("../shapes/Shape");function r(e,t,i,r,n){o.apply(this),this.nx=i||10,this.ny=r||10,this.nz=n||10,this.aabbMin=e||new c(100,100,100),this.aabbMax=t||new c(-100,-100,-100);var s=this.nx*this.ny*this.nz;if(s<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=s,this.binLengths.length=s;for(var a=0;a<s;a++)this.bins[a]=[],this.binLengths[a]=0}(r.prototype=new o).constructor=r;var re=new c;new c,r.prototype.collisionPairs=function(e,t,i){for(var r=e.numObjects(),n=e.bodies,s=this.aabbMax,a=this.aabbMin,y=this.nx,v=this.ny,g=this.nz,b=v*g,x=g,T=1,o=s.x,c=s.y,l=s.z,C=a.x,S=a.y,E=a.z,w=y/(o-C),A=v/(c-S),$=g/(l-E),u=(o-C)/y,h=(c-S)/v,_=(l-E)/g,p=.5*Math.sqrt(u*u+h*h+_*_),d=ie.types,f=d.SPHERE,m=d.PLANE,O=(d.BOX,d.COMPOUND,d.CONVEXPOLYHEDRON,this.bins),D=this.binLengths,k=this.bins.length,R=0;R!==k;R++)D[R]=0;var I=Math.ceil;function F(e,t,i,r,n,s,a){var o=(e-C)*w|0,c=(t-S)*A|0,l=(i-E)*$|0,u=I((r-C)*w),h=I((n-S)*A),_=I((s-E)*$);o<0?o=0:y<=o&&(o=y-1),c<0?c=0:v<=c&&(c=v-1),l<0?l=0:g<=l&&(l=g-1),u<0?u=0:y<=u&&(u=y-1),h<0?h=0:v<=h&&(h=v-1),_<0?_=0:g<=_&&(_=g-1),c*=x,l*=T,u*=b,h*=x,_*=T;for(var p=o*=b;p<=u;p+=b)for(var d=c;d<=h;d+=x)for(var f=l;f<=_;f+=T){var m=p+d+f;O[m][D[m]++]=a}}for(a=Math.min,s=Math.max,R=0;R!==r;R++){var P=(ee=n[R]).shape;switch(P.type){case f:var M=ee.position.x,L=ee.position.y,z=ee.position.z,B=P.radius;F(M-B,L-B,z-B,M+B,L+B,z+B,ee);break;case m:P.worldNormalNeedsUpdate&&P.computeWorldNormal(ee.quaternion);var N=P.worldNormal,G=C+.5*u-ee.position.x,V=S+.5*h-ee.position.y,U=E+.5*_-ee.position.z,X=re;X.set(G,V,U);for(var W=0,H=0;W!==y;W++,H+=b,X.y=V,X.x+=u)for(var q=0,j=0;q!==v;q++,j+=x,X.z=U,X.y+=h)for(var Y=0,Q=0;Y!==g;Y++,Q+=T,X.z+=_)if(X.dot(N)<p){var K=H+j+Q;O[K][D[K]++]=ee}break;default:ee.aabbNeedsUpdate&&ee.computeAABB(),F(ee.aabb.lowerBound.x,ee.aabb.lowerBound.y,ee.aabb.lowerBound.z,ee.aabb.upperBound.x,ee.aabb.upperBound.y,ee.aabb.upperBound.z,ee)}}for(R=0;R!==k;R++){var Z=D[R];if(1<Z){var J=O[R];for(W=0;W!==Z;W++){var ee=J[W];for(q=0;q!==W;q++){var te=J[q];this.needBroadphaseCollision(ee,te)&&this.intersectionTest(ee,te,t,i)}}}}this.makePairsUnique(t,i)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(e,t,i){t.exports=s;var r=e("./Broadphase"),n=e("./AABB");function s(){r.apply(this)}((s.prototype=new r).constructor=s).prototype.collisionPairs=function(e,t,i){var r,n,s,a,o=e.bodies,c=o.length;for(r=0;r!==c;r++)for(n=0;n!==r;n++)s=o[r],a=o[n],this.needBroadphaseCollision(s,a)&&this.intersectionTest(s,a,t,i)},new n,s.prototype.aabbQuery=function(e,t,i){i=i||[];for(var r=0;r<e.bodies.length;r++){var n=e.bodies[r];n.aabbNeedsUpdate&&n.computeAABB(),n.aabb.overlaps(t)&&i.push(n)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,i){function r(){this.matrix={}}(t.exports=r).prototype.get=function(e,t){if((e=e.id)<(t=t.id)){var i=t;t=e,e=i}return e+"-"+t in this.matrix},r.prototype.set=function(e,t,i){if((e=e.id)<(t=t.id)){var r=t;t=e,e=r}i?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},r.prototype.reset=function(){this.matrix={}},r.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,i){function r(){this.current=[],this.previous=[]}function u(e,t){e.push((4294901760&t)>>16,65535&t)}(t.exports=r).prototype.getKey=function(e,t){if(t<e){var i=t;t=e,e=i}return e<<16|t},r.prototype.set=function(e,t){for(var i=this.getKey(e,t),r=this.current,n=0;i>r[n];)n++;if(i!==r[n]){for(t=r.length-1;n<=t;t--)r[t+1]=r[t];r[n]=i}},r.prototype.tick=function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0},r.prototype.reset=function(){this.previous.length=0,this.current.length=0},r.prototype.getDiff=function(e,t){for(var i=this.current,r=this.previous,n=i.length,s=r.length,a=0,o=0;o<n;o++){for(var c=i[o];c>r[a];)a++;c===r[a]||u(e,c)}for(o=a=0;o<s;o++){for(var l=r[o];l>i[a];)a++;i[a]===l||u(t,l)}},r.prototype.copy=function(e){this.current.length=0,this.previous.length=0,this.current=e.current.slice(),this.previous=e.previous.slice()}},{}],10:[function(e,t,i){t.exports=l;var m=e("../math/Vec3"),r=e("../math/Quaternion"),w=e("../math/Transform"),n=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),s=e("../shapes/Shape"),d=e("../collision/AABB");function l(e,t){this.from=e?e.clone():new m,this.to=t?t.clone():new m,this._direction=new m,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=l.ANY,this.result=new n,this.hasHit=!1,this.callback=function(e){}}(l.prototype.constructor=l).CLOSEST=1,l.ANY=2,l.ALL=4;var a=new d,o=[];l.prototype.intersectWorld=function(e,t){return this.mode=t.mode||l.ANY,this.result=t.result||new n,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(a),o.length=0,e.broadphase.aabbQuery(e,a,o),this.intersectBodies(o),this.hasHit};var h=new m,_=new m;function $(e,t,i,r){r.vsub(t,p),i.vsub(t,h),e.vsub(t,_);var n,s,a=p.dot(p),o=p.dot(h),c=p.dot(_),l=h.dot(h),u=h.dot(_);return 0<=(n=l*c-o*u)&&0<=(s=a*u-o*c)&&n+s<a*l-o*o}l.pointInTriangle=$;var c=new m,u=new r;l.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var i=this.checkCollisionResponse;if((!i||e.collisionResponse)&&0!=(this.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&this.collisionFilterMask))for(var r=c,n=u,s=0,a=e.shapes.length;s<a;s++){var o=e.shapes[s];if((!i||o.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[s],n),e.quaternion.vmult(e.shapeOffsets[s],r),r.vadd(e.position,r),this.intersectShape(o,n,r,e),this.result._shouldStop))break}},l.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var i=0,r=e.length;!this.result._shouldStop&&i<r;i++)this.intersectBody(e[i])},l.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},l.prototype.intersectShape=function(e,t,i,r){if(!(function(e,t,i){i.vsub(e,p);var r=p.dot(t);return t.mult(r,T),T.vadd(e,T),i.distanceTo(T)}(this.from,this._direction,i)>e.boundingSphereRadius)){var n=this[e.type];n&&n.call(this,e,t,i,r,e)}},new m,new m;var O=new m,D=new m,k=new m,R=new m;new m,new n,l.prototype.intersectBox=function(e,t,i,r,n){return this.intersectConvex(e.convexPolyhedronRepresentation,t,i,r,n)},l.prototype[s.types.BOX]=l.prototype.intersectBox,l.prototype.intersectPlane=function(e,t,i,r,n){var s=this.from,a=this.to,o=this._direction,c=new m(0,0,1);t.vmult(c,c);var l=new m;s.vsub(i,l);var u=l.dot(c);if(a.vsub(i,l),!(0<u*l.dot(c)||s.distanceTo(a)<u)){var h=c.dot(o);if(!(Math.abs(h)<this.precision)){var _=new m,p=new m,d=new m;s.vsub(i,_);var f=-c.dot(_)/h;o.scale(f,p),s.vadd(p,d),this.reportIntersection(c,d,n,r,-1)}}},l.prototype[s.types.PLANE]=l.prototype.intersectPlane,l.prototype.getAABB=function(e){var t=this.to,i=this.from;e.lowerBound.x=Math.min(t.x,i.x),e.lowerBound.y=Math.min(t.y,i.y),e.lowerBound.z=Math.min(t.z,i.z),e.upperBound.x=Math.max(t.x,i.x),e.upperBound.y=Math.max(t.y,i.y),e.upperBound.z=Math.max(t.z,i.z)};var f={faceList:[0]},y=new m,v=new l,g=[];l.prototype.intersectHeightfield=function(e,t,i,r,n){e.data,e.elementSize;var s=v;s.from.copy(this.from),s.to.copy(this.to),w.pointToLocalFrame(i,t,s.from,s.from),w.pointToLocalFrame(i,t,s.to,s.to),s._updateDirection();var a,o,c,l,u=g;a=o=0,c=l=e.data.length-1;var h=new d;s.getAABB(h),e.getIndexOfPosition(h.lowerBound.x,h.lowerBound.y,u,!0),a=Math.max(a,u[0]),o=Math.max(o,u[1]),e.getIndexOfPosition(h.upperBound.x,h.upperBound.y,u,!0),c=Math.min(c,u[0]+1),l=Math.min(l,u[1]+1);for(var _=a;_<c;_++)for(var p=o;p<l;p++){if(this.result._shouldStop)return;if(e.getAabbAtIndex(_,p,h),h.overlapsRay(s)){if(e.getConvexTrianglePillar(_,p,!1),w.pointToWorldFrame(i,t,e.pillarOffset,y),this.intersectConvex(e.pillarConvex,t,y,r,n,f),this.result._shouldStop)return;e.getConvexTrianglePillar(_,p,!0),w.pointToWorldFrame(i,t,e.pillarOffset,y),this.intersectConvex(e.pillarConvex,t,y,r,n,f)}}},l.prototype[s.types.HEIGHTFIELD]=l.prototype.intersectHeightfield;var b=new m,x=new m;l.prototype.intersectSphere=function(e,t,i,r,n){var s=this.from,a=this.to,o=e.radius,c=Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2)+Math.pow(a.z-s.z,2),l=2*((a.x-s.x)*(s.x-i.x)+(a.y-s.y)*(s.y-i.y)+(a.z-s.z)*(s.z-i.z)),u=Math.pow(s.x-i.x,2)+Math.pow(s.y-i.y,2)+Math.pow(s.z-i.z,2)-Math.pow(o,2),h=Math.pow(l,2)-4*c*u,_=b,p=x;if(!(h<0))if(0==h)s.lerp(a,h,_),_.vsub(i,p),p.normalize(),this.reportIntersection(p,_,n,r,-1);else{var d=(-l-Math.sqrt(h))/(2*c),f=(-l+Math.sqrt(h))/(2*c);if(0<=d&&d<=1&&(s.lerp(a,d,_),_.vsub(i,p),p.normalize(),this.reportIntersection(p,_,n,r,-1)),this.result._shouldStop)return;0<=f&&f<=1&&(s.lerp(a,f,_),_.vsub(i,p),p.normalize(),this.reportIntersection(p,_,n,r,-1))}},l.prototype[s.types.SPHERE]=l.prototype.intersectSphere;var I=new m,F=(new m,new m,new m);l.prototype.intersectConvex=function(e,t,i,r,n,s){for(var a=I,o=F,c=s&&s.faceList||null,l=e.faces,u=e.vertices,h=e.faceNormals,_=this._direction,p=this.from,d=this.to,f=p.distanceTo(d),m=c?c.length:l.length,y=this.result,v=0;!y._shouldStop&&v<m;v++){var g=c?c[v]:v,b=l[g],x=h[g],T=t,C=i;o.copy(u[b[0]]),T.vmult(o,o),o.vadd(C,o),o.vsub(p,o),T.vmult(x,a);var S=_.dot(a);if(!(Math.abs(S)<this.precision)){var E=a.dot(o)/S;if(!(E<0)){_.mult(E,O),O.vadd(p,O),D.copy(u[b[0]]),T.vmult(D,D),C.vadd(D,D);for(var w=1;!y._shouldStop&&w<b.length-1;w++){k.copy(u[b[w]]),R.copy(u[b[w+1]]),T.vmult(k,k),T.vmult(R,R),C.vadd(k,k),C.vadd(R,R);var A=O.distanceTo(p);!$(O,D,k,R)&&!$(O,k,D,R)||f<A||this.reportIntersection(a,O,n,r,g)}}}}},l.prototype[s.types.CONVEXPOLYHEDRON]=l.prototype.intersectConvex;var A=new m,P=new m,M=new m,L=new m,z=new m,B=new m,N=(new d,[]),G=new w;l.prototype.intersectTrimesh=function(e,t,i,r,n,s){var a=A,o=N,c=G,l=F,u=P,h=M,_=L,p=B,d=z,f=(s&&s.faceList,e.indices),m=(e.vertices,e.faceNormals,this.from),y=this.to,v=this._direction;c.position.copy(i),c.quaternion.copy(t),w.vectorToLocalFrame(i,t,v,u),w.pointToLocalFrame(i,t,m,h),w.pointToLocalFrame(i,t,y,_),_.x*=e.scale.x,_.y*=e.scale.y,_.z*=e.scale.z,h.x*=e.scale.x,h.y*=e.scale.y,h.z*=e.scale.z,_.vsub(h,u),u.normalize();var g=h.distanceSquared(_);e.tree.rayQuery(this,c,o);for(var b=0,x=o.length;!this.result._shouldStop&&b!==x;b++){var T=o[b];e.getNormal(T,a),e.getVertex(f[3*T],D),D.vsub(h,l);var C=u.dot(a),S=a.dot(l)/C;if(!(S<0)){u.scale(S,O),O.vadd(h,O),e.getVertex(f[3*T+1],k),e.getVertex(f[3*T+2],R);var E=O.distanceSquared(h);!$(O,k,D,R)&&!$(O,D,k,R)||g<E||(w.vectorToWorldFrame(t,a,d),w.pointToWorldFrame(i,t,O,p),this.reportIntersection(d,p,n,r,T))}}o.length=0},l.prototype[s.types.TRIMESH]=l.prototype.intersectTrimesh,l.prototype.reportIntersection=function(e,t,i,r,n){var s=this.from,a=this.to,o=s.distanceTo(t),c=this.result;if(!(this.skipBackfaces&&0<e.dot(this._direction)))switch(c.hitFaceIndex=void 0!==n?n:-1,this.mode){case l.ALL:this.hasHit=!0,c.set(s,a,e,t,i,r,o),c.hasHit=!0,this.callback(c);break;case l.CLOSEST:(o<c.distance||!c.hasHit)&&(this.hasHit=!0,c.hasHit=!0,c.set(s,a,e,t,i,r,o));break;case l.ANY:this.hasHit=!0,c.hasHit=!0,c.set(s,a,e,t,i,r,o),c._shouldStop=!0}};var p=new m,T=new m},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(e,t,i){var r=e("../math/Vec3");function n(){this.rayFromWorld=new r,this.rayToWorld=new r,this.hitNormalWorld=new r,this.hitPointWorld=new r,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}(t.exports=n).prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},n.prototype.abort=function(){this._shouldStop=!0},n.prototype.set=function(e,t,i,r,n,s,a){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(r),this.shape=n,this.body=s,this.distance=a}},{"../math/Vec3":31}],12:[function(e,t,i){e("../shapes/Shape");var r=e("../collision/Broadphase");function u(e){r.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var i=this.axisList;this._addBodyHandler=function(e){i.push(e.body)},this._removeBodyHandler=function(e){var t=i.indexOf(e.body);-1!==t&&i.splice(t,1)},e&&this.setWorld(e)}((t.exports=u).prototype=new r).setWorld=function(e){for(var t=this.axisList.length=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},u.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){for(var r=e[t],n=t-1;0<=n&&!(e[n].aabb.lowerBound.x<=r.aabb.lowerBound.x);n--)e[n+1]=e[n];e[n+1]=r}return e},u.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){for(var r=e[t],n=t-1;0<=n&&!(e[n].aabb.lowerBound.y<=r.aabb.lowerBound.y);n--)e[n+1]=e[n];e[n+1]=r}return e},u.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){for(var r=e[t],n=t-1;0<=n&&!(e[n].aabb.lowerBound.z<=r.aabb.lowerBound.z);n--)e[n+1]=e[n];e[n+1]=r}return e},u.prototype.collisionPairs=function(e,t,i){var r,n,s=this.axisList,a=s.length,o=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),r=0;r!==a;r++){var c=s[r];for(n=r+1;n<a;n++){var l=s[n];if(this.needBroadphaseCollision(c,l)){if(!u.checkBounds(c,l,o))break;this.intersectionTest(c,l,t,i)}}}},u.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,i=e.length,r=0;r!==i;r++){var n=e[r];n.aabbNeedsUpdate&&n.computeAABB()}0===t?u.insertionSortX(e):1===t?u.insertionSortY(e):2===t&&u.insertionSortZ(e)},u.checkBounds=function(e,t,i){var r,n;0===i?(r=e.position.x,n=t.position.x):1===i?(r=e.position.y,n=t.position.y):2===i&&(r=e.position.z,n=t.position.z);var s=e.boundingRadius,a=t.boundingRadius;return n-a<r+s},u.prototype.autoDetectAxis=function(){for(var e=0,t=0,i=0,r=0,n=0,s=0,a=this.axisList,o=a.length,c=1/o,l=0;l!==o;l++){var u=a[l],h=u.position.x;e+=h,t+=h*h;var _=u.position.y;i+=_,r+=_*_;var p=u.position.z;n+=p,s+=p*p}var d=t-e*e*c,f=r-i*i*c,m=s-n*n*c;this.axisIndex=f<d?m<d?0:2:m<f?1:2},u.prototype.aabbQuery=function(e,t,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var r=this.axisIndex,n="x";1===r&&(n="y"),2===r&&(n="z");for(var s=this.axisList,a=(t.lowerBound[n],t.upperBound[n],0);a<s.length;a++){var o=s[a];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(t)&&i.push(o)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(e,t,i){t.exports=r,e("./Constraint");var c=e("./PointToPointConstraint"),l=e("../equations/ConeEquation"),u=e("../equations/RotationalEquation"),h=(e("../equations/ContactEquation"),e("../math/Vec3"));function r(e,t,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,n=i.pivotA?i.pivotA.clone():new h,s=i.pivotB?i.pivotB.clone():new h;this.axisA=i.axisA?i.axisA.clone():new h,this.axisB=i.axisB?i.axisB.clone():new h,c.call(this,e,n,t,s,r),this.collideConnected=!!i.collideConnected,this.angle=void 0!==i.angle?i.angle:0;var a=this.coneEquation=new l(e,t,i),o=this.twistEquation=new u(e,t,i);this.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,a.maxForce=0,a.minForce=-r,o.maxForce=0,o.minForce=-r,this.equations.push(a,o)}r.prototype=new c,r.constructor=r,new h,new h,r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,r=this.twistEquation;c.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(r.axisA,r.axisA),e.vectorToWorldFrame(r.axisA,r.axisA),this.axisB.tangents(r.axisB,r.axisB),t.vectorToWorldFrame(r.axisB,r.axisB),i.angle=this.angle,r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(e,t,i){t.exports=n;var r=e("../utils/Utils");function n(e,t,i){i=r.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=n.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}n.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},n.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},n.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},n.idCounter=0},{"../utils/Utils":54}],15:[function(e,t,i){t.exports=r;var s=e("./Constraint"),a=e("../equations/ContactEquation");function r(e,t,i,r){s.call(this,e,t),void 0===i&&(i=e.position.distanceTo(t.position)),void 0===r&&(r=1e6),this.distance=i;var n=this.distanceEquation=new a(e,t);this.equations.push(n),n.minForce=-r,n.maxForce=r}(r.prototype=new s).update=function(){var e=this.bodyA,t=this.bodyB,i=this.distanceEquation,r=.5*this.distance,n=i.ni;t.position.vsub(e.position,n),n.normalize(),n.mult(r,i.ri),n.mult(-r,i.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(e,t,i){t.exports=r,e("./Constraint");var l=e("./PointToPointConstraint"),u=e("../equations/RotationalEquation"),h=e("../equations/RotationalMotorEquation"),_=(e("../equations/ContactEquation"),e("../math/Vec3"));function r(e,t,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,n=i.pivotA?i.pivotA.clone():new _,s=i.pivotB?i.pivotB.clone():new _;l.call(this,e,n,t,s,r),(this.axisA=i.axisA?i.axisA.clone():new _(1,0,0)).normalize(),(this.axisB=i.axisB?i.axisB.clone():new _(1,0,0)).normalize();var a=this.rotationalEquation1=new u(e,t,i),o=this.rotationalEquation2=new u(e,t,i),c=this.motorEquation=new h(e,t,r);c.enabled=!1,this.equations.push(a,o,c)}r.prototype=new l,(r.constructor=r).prototype.enableMotor=function(){this.motorEquation.enabled=!0},r.prototype.disableMotor=function(){this.motorEquation.enabled=!1},r.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},r.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var p=new _,d=new _;r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,r=this.rotationalEquation1,n=this.rotationalEquation2,s=p,a=d,o=this.axisA,c=this.axisB;l.prototype.update.call(this),e.quaternion.vmult(o,s),t.quaternion.vmult(c,a),s.tangents(r.axisA,n.axisA),r.axisB.copy(a),n.axisB.copy(a),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(e,t,i){t.exports=r,e("./Constraint");var u=e("./PointToPointConstraint"),h=e("../equations/RotationalEquation"),_=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function r(e,t,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,n=new _,s=new _,a=new _;e.position.vadd(t.position,a),a.scale(.5,a),t.pointToLocalFrame(a,s),e.pointToLocalFrame(a,n),u.call(this,e,n,t,s,r),this.xA=e.vectorToLocalFrame(_.UNIT_X),this.xB=t.vectorToLocalFrame(_.UNIT_X),this.yA=e.vectorToLocalFrame(_.UNIT_Y),this.yB=t.vectorToLocalFrame(_.UNIT_Y),this.zA=e.vectorToLocalFrame(_.UNIT_Z),this.zB=t.vectorToLocalFrame(_.UNIT_Z);var o=this.rotationalEquation1=new h(e,t,i),c=this.rotationalEquation2=new h(e,t,i),l=this.rotationalEquation3=new h(e,t,i);this.equations.push(o,c,l)}r.prototype=new u,r.constructor=r,new _,new _,r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,n=this.rotationalEquation3;u.prototype.update.call(this),e.vectorToWorldFrame(this.xA,i.axisA),t.vectorToWorldFrame(this.yB,i.axisB),e.vectorToWorldFrame(this.yA,r.axisA),t.vectorToWorldFrame(this.zB,r.axisB),e.vectorToWorldFrame(this.zA,n.axisA),t.vectorToWorldFrame(this.xB,n.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(e,t,i){t.exports=r;var c=e("./Constraint"),l=e("../equations/ContactEquation"),u=e("../math/Vec3");function r(e,t,i,r,n){c.call(this,e,i),n=void 0!==n?n:1e6,this.pivotA=t?t.clone():new u,this.pivotB=r?r.clone():new u;var s=this.equationX=new l(e,i),a=this.equationY=new l(e,i),o=this.equationZ=new l(e,i);this.equations.push(s,a,o),s.minForce=a.minForce=o.minForce=-n,s.maxForce=a.maxForce=o.maxForce=n,s.ni.set(1,0,0),a.ni.set(0,1,0),o.ni.set(0,0,1)}(r.prototype=new c).update=function(){var e=this.bodyA,t=this.bodyB,i=this.equationX,r=this.equationY,n=this.equationZ;e.quaternion.vmult(this.pivotA,i.ri),t.quaternion.vmult(this.pivotB,i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(e,t,i){t.exports=r;var n=e("../math/Vec3"),s=(e("../math/Mat3"),e("./Equation"));function r(e,t,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;s.call(this,e,t,-r,r),this.axisA=i.axisA?i.axisA.clone():new n(1,0,0),this.axisB=i.axisB?i.axisB.clone():new n(0,1,0),this.angle=void 0!==i.angle?i.angle:0}(r.prototype=new s).constructor=r;var l=new n,u=new n;r.prototype.computeB=function(e){var t=this.a,i=this.b,r=this.axisA,n=this.axisB,s=l,a=u,o=this.jacobianElementA,c=this.jacobianElementB;return r.cross(n,s),n.cross(r,a),o.rotational.copy(a),c.rotational.copy(s),-(Math.cos(this.angle)-r.dot(n))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(e,t,i){t.exports=s;var r=e("./Equation"),n=e("../math/Vec3");function s(e,t,i){i=void 0!==i?i:1e6,r.call(this,e,t,0,i),this.si=null,this.sj=null,this.restitution=0,this.ri=new n,this.rj=new n,this.ni=new n}e("../math/Mat3"),(s.prototype=new r).constructor=s;var g=new n,b=new n,x=new n;s.prototype.computeB=function(e){var t=this.a,i=this.b,r=this.bi,n=this.bj,s=this.ri,a=this.rj,o=g,c=b,l=r.velocity,u=r.angularVelocity,h=(r.force,r.torque,n.velocity),_=n.angularVelocity,p=(n.force,n.torque,x),d=this.jacobianElementA,f=this.jacobianElementB,m=this.ni;s.cross(m,o),a.cross(m,c),m.negate(d.spatial),o.negate(d.rotational),f.spatial.copy(m),f.rotational.copy(c),p.copy(n.position),p.vadd(a,p),p.vsub(r.position,p),p.vsub(s,p);var y=m.dot(p),v=this.restitution+1;return-y*t-(v*h.dot(m)-v*l.dot(m)+_.dot(c)-u.dot(o))*i-e*this.computeGiMf()};var a=new n,o=new n,c=new n,l=new n,u=new n;s.prototype.getImpactVelocityAlongNormal=function(){var e=a,t=o,i=c,r=l,n=u;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,r),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(r,t),e.vsub(t,n),this.ni.dot(n)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(e,t,i){t.exports=s;var n=e("../math/JacobianElement"),r=e("../math/Vec3");function s(e,t,i,r){this.id=s.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===r?1e6:r,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}(s.prototype.constructor=s).id=0,s.prototype.setSpookParams=function(e,t,i){var r=t,n=e,s=i;this.a=4/(s*(1+4*r)),this.b=4*r/(1+4*r),this.eps=4/(s*s*n*(1+4*r))},s.prototype.computeB=function(e,t,i){var r=this.computeGW();return-this.computeGq()*e-r*t-this.computeGiMf()*i},s.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,n=i.position,s=r.position;return e.spatial.dot(n)+t.spatial.dot(s)},new r,s.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,n=i.velocity,s=r.velocity,a=i.angularVelocity,o=r.angularVelocity;return e.multiplyVectors(n,a)+t.multiplyVectors(s,o)},s.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,n=i.vlambda,s=r.vlambda,a=i.wlambda,o=r.wlambda;return e.multiplyVectors(n,a)+t.multiplyVectors(s,o)};var u=new r,h=new r,_=new r,p=new r;s.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,n=i.force,s=i.torque,a=r.force,o=r.torque,c=i.invMassSolve,l=r.invMassSolve;return n.scale(c,u),a.scale(l,h),i.invInertiaWorldSolve.vmult(s,_),r.invInertiaWorldSolve.vmult(o,p),e.multiplyVectors(u,_)+t.multiplyVectors(h,p)};var l=new r;s.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,n=i.invMassSolve,s=r.invMassSolve,a=i.invInertiaWorldSolve,o=r.invInertiaWorldSolve,c=n+s;return a.vmult(e.rotational,l),c+=l.dot(e.rotational),o.vmult(t.rotational,l),c+=l.dot(t.rotational)};var a=new r;new r,new r,new r,new r,new r,s.prototype.addToWlambda=function(e){var t=this.jacobianElementA,i=this.jacobianElementB,r=this.bi,n=this.bj,s=a;r.vlambda.addScaledVector(r.invMassSolve*e,t.spatial,r.vlambda),n.vlambda.addScaledVector(n.invMassSolve*e,i.spatial,n.vlambda),r.invInertiaWorldSolve.vmult(t.rotational,s),r.wlambda.addScaledVector(e,s,r.wlambda),n.invInertiaWorldSolve.vmult(i.rotational,s),n.wlambda.addScaledVector(e,s,n.wlambda)},s.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(e,t,i){t.exports=s;var r=e("./Equation"),n=e("../math/Vec3");function s(e,t,i){r.call(this,e,t,-i,i),this.ri=new n,this.rj=new n,this.t=new n}e("../math/Mat3"),(s.prototype=new r).constructor=s;var l=new n,u=new n;s.prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.ri),r=this.rj,n=l,s=u,a=this.t;i.cross(a,n),r.cross(a,s);var o=this.jacobianElementA,c=this.jacobianElementB;return a.negate(o.spatial),n.negate(o.rotational),c.spatial.copy(a),c.rotational.copy(s),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(e,t,i){t.exports=r;var n=e("../math/Vec3"),s=(e("../math/Mat3"),e("./Equation"));function r(e,t,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;s.call(this,e,t,-r,r),this.axisA=i.axisA?i.axisA.clone():new n(1,0,0),this.axisB=i.axisB?i.axisB.clone():new n(0,1,0),this.maxAngle=Math.PI/2}(r.prototype=new s).constructor=r;var l=new n,u=new n;r.prototype.computeB=function(e){var t=this.a,i=this.b,r=this.axisA,n=this.axisB,s=l,a=u,o=this.jacobianElementA,c=this.jacobianElementB;return r.cross(n,s),n.cross(r,a),o.rotational.copy(a),c.rotational.copy(s),-(Math.cos(this.maxAngle)-r.dot(n))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(e,t,i){t.exports=s;var r=e("../math/Vec3"),n=(e("../math/Mat3"),e("./Equation"));function s(e,t,i){i=void 0!==i?i:1e6,n.call(this,e,t,-i,i),this.axisA=new r,this.axisB=new r,this.targetVelocity=0}((s.prototype=new n).constructor=s).prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.axisA),r=this.axisB,n=this.jacobianElementA,s=this.jacobianElementB;return n.rotational.copy(i),r.negate(s.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(e,t,i){var n=e("../utils/Utils");(t.exports=function e(t,i,r){r=n.defaults(r,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[t,i],this.friction=r.friction,this.restitution=r.restitution,this.contactEquationStiffness=r.contactEquationStiffness,this.contactEquationRelaxation=r.contactEquationRelaxation,this.frictionEquationStiffness=r.frictionEquationStiffness,this.frictionEquationRelaxation=r.frictionEquationRelaxation}).idCounter=0},{"../utils/Utils":54}],26:[function(e,t,i){(t.exports=function e(t){var i="";"string"==typeof(t=t||{})?(i=t,t={}):"object"==typeof t&&(i=""),this.name=i,this.id=e.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}).idCounter=0},{}],27:[function(e,t,i){t.exports=n;var r=e("./Vec3");function n(){this.spatial=new r,this.rotational=new r}n.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},n.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":31}],28:[function(e,t,i){t.exports=l;var u=e("./Vec3");function l(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}l.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},l.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},l.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},l.prototype.getTrace=function(e){e=e||new u;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},l.prototype.vmult=function(e,t){t=t||new u;var i=this.elements,r=e.x,n=e.y,s=e.z;return t.x=i[0]*r+i[1]*n+i[2]*s,t.y=i[3]*r+i[4]*n+i[5]*s,t.z=i[6]*r+i[7]*n+i[8]*s,t},l.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},l.prototype.mmult=function(e,t){for(var i=t||new l,r=0;r<3;r++)for(var n=0;n<3;n++){for(var s=0,a=0;a<3;a++)s+=e.elements[r+3*a]*this.elements[a+3*n];i.elements[r+3*n]=s}return i},l.prototype.scale=function(e,t){t=t||new l;for(var i=this.elements,r=t.elements,n=0;3!==n;n++)r[3*n+0]=e.x*i[3*n+0],r[3*n+1]=e.y*i[3*n+1],r[3*n+2]=e.z*i[3*n+2];return t},l.prototype.solve=function(e,t){t=t||new u;for(var i,r=[],n=0;n<12;n++)r.push(0);for(n=0;n<3;n++)for(i=0;i<3;i++)r[n+4*i]=this.elements[n+3*i];r[3]=e.x,r[7]=e.y,r[11]=e.z;var s,a,o=3,c=o;do{if(0===r[(n=c-o)+4*n])for(i=n+1;i<c;i++)if(0!==r[n+4*i]){for(s=4;r[(a=4-s)+4*n]+=r[a+4*i],--s;);break}if(0!==r[n+4*n])for(i=n+1;i<c;i++){var l=r[n+4*i]/r[n+4*n];for(s=4;r[(a=4-s)+4*i]=a<=n?0:r[a+4*i]-r[a+4*n]*l,--s;);}}while(--o);if(t.z=r[11]/r[10],t.y=(r[7]-r[6]*t.z)/r[5],t.x=(r[3]-r[2]*t.z-r[1]*t.y)/r[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},l.prototype.e=function(e,t,i){if(void 0===i)return this.elements[t+3*e];this.elements[t+3*e]=i},l.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},l.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},l.prototype.reverse=function(e){e=e||new l;for(var t,i=[],r=0;r<18;r++)i.push(0);for(r=0;r<3;r++)for(t=0;t<3;t++)i[r+6*t]=this.elements[r+3*t];i[3]=1,i[9]=0,i[15]=0,i[4]=0,i[10]=1,i[16]=0,i[5]=0,i[11]=0,i[17]=1;var n,s,a=3,o=a;do{if(0===i[(r=o-a)+6*r])for(t=r+1;t<o;t++)if(0!==i[r+6*t]){for(n=6;i[(s=6-n)+6*r]+=i[s+6*t],--n;);break}if(0!==i[r+6*r])for(t=r+1;t<o;t++){var c=i[r+6*t]/i[r+6*r];for(n=6;i[(s=6-n)+6*t]=s<=r?0:i[s+6*t]-i[s+6*r]*c,--n;);}}while(--a);r=2;do{t=r-1;do{for(c=i[r+6*t]/i[r+6*r],n=6;i[(s=6-n)+6*t]=i[s+6*t]-i[s+6*r]*c,--n;);}while(t--)}while(--r);r=2;do{for(c=1/i[r+6*r],n=6;i[(s=6-n)+6*r]=i[s+6*r]*c,--n;);}while(r--);r=2;do{t=2;do{if(s=i[3+t+6*r],isNaN(s)||s===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(r,t,s)}while(t--)}while(r--);return e},l.prototype.setRotationFromQuaternion=function(e){var t=e.x,i=e.y,r=e.z,n=e.w,s=t+t,a=i+i,o=r+r,c=t*s,l=t*a,u=t*o,h=i*a,_=i*o,p=r*o,d=n*s,f=n*a,m=n*o,y=this.elements;return y[0]=1-(h+p),y[1]=l-m,y[2]=u+f,y[3]=l+m,y[4]=1-(c+p),y[5]=_-d,y[6]=u-f,y[7]=_+d,y[8]=1-(c+h),this},l.prototype.transpose=function(e){for(var t=(e=e||new l).elements,i=this.elements,r=0;3!==r;r++)for(var n=0;3!==n;n++)t[3*r+n]=i[3*n+r];return e}},{"./Vec3":31}],29:[function(e,t,i){t.exports=m;var p=e("./Vec3");function m(e,t,i,r){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.w=void 0!==r?r:1}m.prototype.set=function(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this},m.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},m.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},m.prototype.setFromAxisAngle=function(e,t){var i=Math.sin(.5*t);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(.5*t),this},m.prototype.toAxisAngle=function(e){e=e||new p,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]};var s=new p,a=new p;m.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var i=s,r=a;e.tangents(i,r),this.setFromAxisAngle(i,Math.PI)}else{var n=e.cross(t);this.x=n.x,this.y=n.y,this.z=n.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}return this},new p,new p,new p,m.prototype.mult=function(e,t){t=t||new m;var i=this.x,r=this.y,n=this.z,s=this.w,a=e.x,o=e.y,c=e.z,l=e.w;return t.x=i*l+s*a+r*c-n*o,t.y=r*l+s*o+n*a-i*c,t.z=n*l+s*c+i*o-r*a,t.w=s*l-i*a-r*o-n*c,t},m.prototype.inverse=function(e){var t=this.x,i=this.y,r=this.z,n=this.w;e=e||new m,this.conjugate(e);var s=1/(t*t+i*i+r*r+n*n);return e.x*=s,e.y*=s,e.z*=s,e.w*=s,e},m.prototype.conjugate=function(e){return(e=e||new m).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},m.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},m.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0==e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},m.prototype.vmult=function(e,t){t=t||new p;var i=e.x,r=e.y,n=e.z,s=this.x,a=this.y,o=this.z,c=this.w,l=c*i+a*n-o*r,u=c*r+o*i-s*n,h=c*n+s*r-a*i,_=-s*i-a*r-o*n;return t.x=l*c+_*-s+u*-o-h*-a,t.y=u*c+_*-a+h*-s-l*-o,t.z=h*c+_*-o+l*-a-u*-s,t},m.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},m.prototype.toEuler=function(e,t){var i,r,n;t=t||"YZX";var s=this.x,a=this.y,o=this.z,c=this.w;switch(t){case"YZX":var l=s*a+o*c;if(.499<l&&(i=2*Math.atan2(s,c),r=Math.PI/2,n=0),l<-.499&&(i=-2*Math.atan2(s,c),r=-Math.PI/2,n=0),isNaN(i)){var u=s*s,h=a*a,_=o*o;i=Math.atan2(2*a*c-2*s*o,1-2*h-2*_),r=Math.asin(2*l),n=Math.atan2(2*s*c-2*a*o,1-2*u-2*_)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=i,e.z=r,e.x=n},m.prototype.setFromEuler=function(e,t,i,r){r=r||"XYZ";var n=Math.cos(e/2),s=Math.cos(t/2),a=Math.cos(i/2),o=Math.sin(e/2),c=Math.sin(t/2),l=Math.sin(i/2);return"XYZ"===r?(this.x=o*s*a+n*c*l,this.y=n*c*a-o*s*l,this.z=n*s*l+o*c*a,this.w=n*s*a-o*c*l):"YXZ"===r?(this.x=o*s*a+n*c*l,this.y=n*c*a-o*s*l,this.z=n*s*l-o*c*a,this.w=n*s*a+o*c*l):"ZXY"===r?(this.x=o*s*a-n*c*l,this.y=n*c*a+o*s*l,this.z=n*s*l+o*c*a,this.w=n*s*a-o*c*l):"ZYX"===r?(this.x=o*s*a-n*c*l,this.y=n*c*a+o*s*l,this.z=n*s*l-o*c*a,this.w=n*s*a+o*c*l):"YZX"===r?(this.x=o*s*a+n*c*l,this.y=n*c*a+o*s*l,this.z=n*s*l-o*c*a,this.w=n*s*a-o*c*l):"XZY"===r&&(this.x=o*s*a-n*c*l,this.y=n*c*a-o*s*l,this.z=n*s*l+o*c*a,this.w=n*s*a+o*c*l),this},m.prototype.clone=function(){return new m(this.x,this.y,this.z,this.w)},m.prototype.slerp=function(e,t,i){i=i||new m;var r,n,s,a,o,c=this.x,l=this.y,u=this.z,h=this.w,_=e.x,p=e.y,d=e.z,f=e.w;return(n=c*_+l*p+u*d+h*f)<0&&(n=-n,_=-_,p=-p,d=-d,f=-f),o=1e-6<1-n?(r=Math.acos(n),s=Math.sin(r),a=Math.sin((1-t)*r)/s,Math.sin(t*r)/s):(a=1-t,t),i.x=a*c+o*_,i.y=a*l+o*p,i.z=a*u+o*d,i.w=a*h+o*f,i},m.prototype.integrate=function(e,t,i,r){r=r||new m;var n=e.x*i.x,s=e.y*i.y,a=e.z*i.z,o=this.x,c=this.y,l=this.z,u=this.w,h=.5*t;return r.x+=h*(n*u+s*l-a*c),r.y+=h*(s*u+a*o-n*l),r.z+=h*(a*u+n*c-s*o),r.w+=h*(-n*o-s*c-a*l),r}},{"./Vec3":31}],30:[function(e,t,i){var n=e("./Vec3"),r=e("./Quaternion");function s(e){e=e||{},this.position=new n,e.position&&this.position.copy(e.position),this.quaternion=new r,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=s;var a=new r;s.pointToLocalFrame=function(e,t,i,r){return r=r||new n,i.vsub(e,r),t.conjugate(a),a.vmult(r,r),r},s.prototype.pointToLocal=function(e,t){return s.pointToLocalFrame(this.position,this.quaternion,e,t)},s.pointToWorldFrame=function(e,t,i,r){return r=r||new n,t.vmult(i,r),r.vadd(e,r),r},s.prototype.pointToWorld=function(e,t){return s.pointToWorldFrame(this.position,this.quaternion,e,t)},s.prototype.vectorToWorldFrame=function(e,t){return t=t||new n,this.quaternion.vmult(e,t),t},s.vectorToWorldFrame=function(e,t,i){return e.vmult(t,i),i},s.vectorToLocalFrame=function(e,t,i,r){return r=r||new n,t.w*=-1,t.vmult(i,r),t.w*=-1,r}},{"./Quaternion":29,"./Vec3":31}],31:[function(e,t,i){t.exports=c;var r=e("./Mat3");function c(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}c.ZERO=new c(0,0,0),c.UNIT_X=new c(1,0,0),c.UNIT_Y=new c(0,1,0),c.UNIT_Z=new c(0,0,1),c.prototype.cross=function(e,t){var i=e.x,r=e.y,n=e.z,s=this.x,a=this.y,o=this.z;return(t=t||new c).x=a*n-o*r,t.y=o*i-s*n,t.z=s*r-a*i,t},c.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},c.prototype.setZero=function(){this.x=this.y=this.z=0},c.prototype.vadd=function(e,t){if(!t)return new c(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},c.prototype.vsub=function(e,t){if(!t)return new c(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},c.prototype.crossmat=function(){return new r([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},c.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,r=Math.sqrt(e*e+t*t+i*i);if(0<r){var n=1/r;this.x*=n,this.y*=n,this.z*=n}else this.x=0,this.y=0,this.z=0;return r},c.prototype.unit=function(e){e=e||new c;var t=this.x,i=this.y,r=this.z,n=Math.sqrt(t*t+i*i+r*r);return 0<n?(n=1/n,e.x=t*n,e.y=i*n,e.z=r*n):(e.x=1,e.y=0,e.z=0),e},c.prototype.length=c.prototype.norm=function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)},c.prototype.lengthSquared=c.prototype.norm2=function(){return this.dot(this)},c.prototype.distanceTo=function(e){var t=this.x,i=this.y,r=this.z,n=e.x,s=e.y,a=e.z;return Math.sqrt((n-t)*(n-t)+(s-i)*(s-i)+(a-r)*(a-r))},c.prototype.distanceSquared=function(e){var t=this.x,i=this.y,r=this.z,n=e.x,s=e.y,a=e.z;return(n-t)*(n-t)+(s-i)*(s-i)+(a-r)*(a-r)},c.prototype.mult=function(e,t){t=t||new c;var i=this.x,r=this.y,n=this.z;return t.x=e*i,t.y=e*r,t.z=e*n,t},c.prototype.vmul=function(e,t){return(t=t||new c).x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t},c.prototype.scale=c.prototype.mult,c.prototype.addScaledVector=function(e,t,i){return(i=i||new c).x=this.x+e*t.x,i.y=this.y+e*t.y,i.z=this.z+e*t.z,i},c.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},c.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},c.prototype.negate=function(e){return(e=e||new c).x=-this.x,e.y=-this.y,e.z=-this.z,e};var a=new c,o=new c;c.prototype.tangents=function(e,t){var i=this.norm();if(0<i){var r=a,n=1/i;r.set(this.x*n,this.y*n,this.z*n);var s=o;Math.abs(r.x)<.9?s.set(1,0,0):s.set(0,1,0),r.cross(s,e),r.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},c.prototype.toString=function(){return this.x+","+this.y+","+this.z},c.prototype.toArray=function(){return[this.x,this.y,this.z]},c.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},c.prototype.lerp=function(e,t,i){var r=this.x,n=this.y,s=this.z;i.x=r+(e.x-r)*t,i.y=n+(e.y-n)*t,i.z=s+(e.z-s)*t},c.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},c.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var n=new c;c.prototype.isAntiparallelTo=function(e,t){return this.negate(n),n.almostEquals(e,t)},c.prototype.clone=function(){return new c(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(e,t,i){t.exports=v;var r=e("../utils/EventTarget"),s=(e("../shapes/Shape"),e("../math/Vec3")),n=e("../math/Mat3"),a=e("../math/Quaternion"),o=(e("../material/Material"),e("../collision/AABB")),c=e("../shapes/Box"),l=e("../world/World");function v(e){e=e||{},r.apply(this),this.id=v.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new s,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new s,this.previousPosition=new s,this.interpolatedPosition=new s,this.initPosition=new s,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new s,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new s,this.force=new s;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=0<t?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?v.STATIC:v.DYNAMIC,typeof e.type==typeof v.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new s,this.quaternion=new a,this.initQuaternion=new a,this.previousQuaternion=new a,this.interpolatedQuaternion=new a,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new s,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new s,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new s,this.invInertia=new s,this.invInertiaWorld=new n,this.invMassSolve=0,this.invInertiaSolve=new s,this.invInertiaWorldSolve=new n,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new s(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new s(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new o,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new s,e.shape&&this.addShape(e.shape),this.updateMassProperties()}((v.prototype=new r).constructor=v).COLLIDE_EVENT_NAME="collide",v.DYNAMIC=1,v.STATIC=2,v.KINEMATIC=4,v.AWAKE=0,v.SLEEPY=1,v.SLEEPING=2,v.idCounter=0,v.wakeupEvent={type:"wakeup"},v.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,e===v.SLEEPING&&this.dispatchEvent(v.wakeupEvent)},v.prototype.sleep=function(){this.sleepState=v.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},v.sleepyEvent={type:"sleepy"},v.sleepEvent={type:"sleep"},v.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),r=Math.pow(this.sleepSpeedLimit,2);t===v.AWAKE&&i<r?(this.sleepState=v.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(v.sleepyEvent)):t===v.SLEEPY&&r<i?this.wakeUp():t===v.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(v.sleepEvent))}},v.prototype.updateSolveMassProperties=function(){this.sleepState===v.SLEEPING||this.type===v.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},v.prototype.pointToLocalFrame=function(e,t){return t=t||new s,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},v.prototype.vectorToLocalFrame=function(e,t){return t=t||new s,this.quaternion.conjugate().vmult(e,t),t},v.prototype.pointToWorldFrame=function(e,t){return t=t||new s,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},v.prototype.vectorToWorldFrame=function(e,t){return t=t||new s,this.quaternion.vmult(e,t),t};var h=new s,_=new a;v.prototype.addShape=function(e,t,i){if(-1===this.shapes.indexOf(e)){var r=new s,n=new a;return t&&r.copy(t),i&&n.copy(i),l.idToShapeMap[e.id]=e,this.shapes.push(e),this.shapeOffsets.push(r),this.shapeOrientations.push(n),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=this}},v.prototype.removeShape=function(e){var t=this.shapes.indexOf(e);-1!==t&&(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0)},v.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,r=0,n=0;n!==i;n++){var s=e[n];s.updateBoundingSphereRadius();var a=t[n].norm(),o=s.boundingSphereRadius;r<a+o&&(r=a+o)}this.boundingRadius=r};var p=new o;v.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,r=e.length,n=h,s=_,a=this.quaternion,o=this.aabb,c=p,l=0;l!==r;l++){var u=e[l];a.vmult(t[l],n),n.vadd(this.position,n),i[l].mult(a,s),u.calculateWorldAABB(n,s,c.lowerBound,c.upperBound),0===l?o.copy(c):o.extend(c)}this.aabbNeedsUpdate=!1};var u=new n,d=new n;new n,v.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var i=u,r=d;i.setRotationFromQuaternion(this.quaternion),i.transpose(r),i.scale(t,i),i.mmult(r,this.invInertiaWorld)}};var f=new s;v.prototype.applyForce=function(e,t){if(this.type===v.DYNAMIC){var i=f;t.cross(e,i),this.force.vadd(e,this.force),this.torque.vadd(i,this.torque)}};var m=new s,y=new s;v.prototype.applyLocalForce=function(e,t){if(this.type===v.DYNAMIC){var i=m,r=y;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,r),this.applyForce(i,r)}};var g=new s,b=new s;v.prototype.applyImpulse=function(e,t){if(this.type===v.DYNAMIC){var i=t,r=g;r.copy(e),r.mult(this.invMass,r),this.velocity.vadd(r,this.velocity);var n=b;i.cross(e,n),this.invInertiaWorld.vmult(n,n),this.angularVelocity.vadd(n,this.angularVelocity)}};var x=new s,T=new s;v.prototype.applyLocalImpulse=function(e,t){if(this.type===v.DYNAMIC){var i=x,r=T;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,r),this.applyImpulse(i,r)}};var C=new s;v.prototype.updateMassProperties=function(){var e=C;this.invMass=0<this.mass?1/this.mass:0;var t=this.inertia,i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),c.calculateInertia(e,this.mass,t),this.invInertia.set(0<t.x&&!i?1/t.x:0,0<t.y&&!i?1/t.y:0,0<t.z&&!i?1/t.z:0),this.updateInertiaWorld(!0)},v.prototype.getVelocityAtWorldPoint=function(e,t){var i=new s;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t},v.prototype.integrate=function(e,t,i){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===v.DYNAMIC||this.type===v.KINEMATIC)&&this.sleepState!==v.SLEEPING){var r=this.velocity,n=this.angularVelocity,s=this.position,a=this.force,o=this.torque,c=this.quaternion,l=this.invMass,u=this.invInertiaWorld,h=this.linearFactor,_=l*e;r.x+=a.x*_*h.x,r.y+=a.y*_*h.y,r.z+=a.z*_*h.z;var p=u.elements,d=this.angularFactor,f=o.x*d.x,m=o.y*d.y,y=o.z*d.z;n.x+=e*(p[0]*f+p[1]*m+p[2]*y),n.y+=e*(p[3]*f+p[4]*m+p[5]*y),n.z+=e*(p[6]*f+p[7]*m+p[8]*y),s.x+=r.x*e,s.y+=r.y*e,s.z+=r.z*e,c.integrate(this.angularVelocity,e,this.angularFactor,c),t&&(i?c.normalizeFast():c.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},v.prototype.isSleeping=function(){return this.sleepState===v.SLEEPING},v.prototype.isSleepy=function(){return this.sleepState===v.SLEEPY},v.prototype.isAwake=function(){return this.sleepState===v.AWAKE}},{"../collision/AABB":3,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(e,t,i){e("./Body");var E=e("../math/Vec3"),u=e("../math/Quaternion"),r=(e("../collision/RaycastResult"),e("../collision/Ray")),n=e("../objects/WheelInfo");function s(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=s,new E,new E,new E;var h=new E,_=new E,p=new E;new r,s.prototype.addWheel=function(e){var t=new n(e=e||{}),i=this.wheelInfos.length;return this.wheelInfos.push(t),i},s.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new E,s.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},s.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},s.prototype.addToWorld=function(e){this.constraints,e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},s.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},s.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,r=this.chassisBody,n=0;n<i;n++)this.updateWheelTransform(n);this.currentVehicleSpeedKmHour=3.6*r.velocity.norm();var s=new E;for(this.getVehicleAxisWorld(this.indexForwardAxis,s),s.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),n=0;n<i;n++)this.castRay(t[n]);this.updateSuspension(e);var a=new E,o=new E;for(n=0;n<i;n++){var c=(_=t[n]).suspensionForce;c>_.maxSuspensionForce&&(c=_.maxSuspensionForce),_.raycastResult.hitNormalWorld.scale(c*e,a),_.raycastResult.hitPointWorld.vsub(r.position,o),r.applyImpulse(a,o)}this.updateFriction(e);var l=new E,u=new E,h=new E;for(n=0;n<i;n++){var _=t[n];r.getVelocityAtWorldPoint(_.chassisConnectionPointWorld,h);var p=1;switch(this.indexUpAxis){case 1:p=-1}if(_.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);var d=u.dot(_.raycastResult.hitNormalWorld);_.raycastResult.hitNormalWorld.scale(d,l),u.vsub(l,u);var f=u.dot(h);_.deltaRotation=p*f*e/_.radius}!_.sliding&&_.isInContact||0===_.engineForce||!_.useCustomSlidingRotationalSpeed||(_.deltaRotation=(0<_.engineForce?1:-1)*_.customSlidingRotationalSpeed*e),Math.abs(_.brake)>Math.abs(_.engineForce)&&(_.deltaRotation=0),_.rotation+=_.deltaRotation,_.deltaRotation*=.99}},s.prototype.updateSuspension=function(e){for(var t=this.chassisBody.mass,i=this.wheelInfos,r=i.length,n=0;n<r;n++){var s=i[n];if(s.isInContact){var a,o=s.suspensionRestLength-s.suspensionLength;a=s.suspensionStiffness*o*s.clippedInvContactDotSuspension;var c=s.suspensionRelativeVelocity;a-=(c<0?s.dampingCompression:s.dampingRelaxation)*c,s.suspensionForce=a*t,s.suspensionForce<0&&(s.suspensionForce=0)}else s.suspensionForce=0}},s.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var y=new E,v=new E;s.prototype.castRay=function(e){var t=y,i=v;this.updateWheelTransformWorld(e);var r=this.chassisBody,n=-1,s=e.suspensionRestLength+e.radius;e.directionWorld.scale(s,t);var a=e.chassisConnectionPointWorld;a.vadd(t,i);var o=e.raycastResult;o.reset();var c=r.collisionResponse;r.collisionResponse=!1,this.world.rayTest(a,i,o),r.collisionResponse=c;var l=o.body;if(e.raycastResult.groundObject=0,l){n=o.distance,e.raycastResult.hitNormalWorld=o.hitNormalWorld,e.isInContact=!0;var u=o.distance;e.suspensionLength=u-e.radius;var h=e.suspensionRestLength-e.maxSuspensionTravel,_=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<h&&(e.suspensionLength=h),e.suspensionLength>_&&(e.suspensionLength=_,e.raycastResult.reset());var p=e.raycastResult.hitNormalWorld.dot(e.directionWorld),d=new E;r.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,d);var f=e.raycastResult.hitNormalWorld.dot(d);if(-.1<=p)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var m=-1/p;e.suspensionRelativeVelocity=f*m,e.clippedInvContactDotSuspension=m}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return n},s.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},s.prototype.updateWheelTransform=function(e){var t=h,i=_,r=p,n=this.wheelInfos[e];this.updateWheelTransformWorld(n),n.directionLocal.scale(-1,t),i.copy(n.axleLocal),t.cross(i,r),r.normalize(),i.normalize();var s=n.steering,a=new u;a.setFromAxisAngle(t,s);var o=new u;o.setFromAxisAngle(i,n.rotation);var c=n.worldTransform.quaternion;this.chassisBody.quaternion.mult(a,c),c.mult(o,c),c.normalize();var l=n.worldTransform.position;l.copy(n.directionWorld),l.scale(n.suspensionLength,l),l.vadd(n.chassisConnectionPointWorld,l)};var w=[new E(1,0,0),new E(0,1,0),new E(0,0,1)];s.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var A=new E,$=[],O=[];s.prototype.updateFriction=function(e){for(var t=A,i=this.wheelInfos,r=i.length,n=this.chassisBody,s=O,a=$,o=0;o<r;o++)h=(b=i[o]).raycastResult.body,b.sideImpulse=0,b.forwardImpulse=0,s[o]||(s[o]=new E),a[o]||(a[o]=new E);for(o=0;o<r;o++)if(h=(b=i[o]).raycastResult.body){var c=a[o];this.getWheelTransformWorld(o).vectorToWorldFrame(w[this.indexRightAxis],c);var l=b.raycastResult.hitNormalWorld,u=c.dot(l);l.scale(u,t),c.vsub(t,c),c.normalize(),l.cross(c,s[o]),s[o].normalize(),b.sideImpulse=k(n,b.raycastResult.hitPointWorld,h,b.raycastResult.hitPointWorld,c),b.sideImpulse*=1}for(this.sliding=!1,o=0;o<r;o++){var h=(b=i[o]).raycastResult.body,_=0;if(b.slipInfo=1,h){var p=b.brake?b.brake:0;_=D(n,h,b.raycastResult.hitPointWorld,s[o],p);var d=p/(_+=b.engineForce*e);b.slipInfo*=d}if(b.forwardImpulse=0,b.skidInfo=1,h){b.skidInfo=1;var f=b.suspensionForce*e*b.frictionSlip,m=f*f;b.forwardImpulse=_;var y=.5*b.forwardImpulse,v=1*b.sideImpulse,g=y*y+v*v;b.sliding=!1,m<g&&(this.sliding=!0,b.sliding=!0,d=f/Math.sqrt(g),b.skidInfo*=d)}}if(this.sliding)for(o=0;o<r;o++)0!==(b=i[o]).sideImpulse&&b.skidInfo<1&&(b.forwardImpulse*=b.skidInfo,b.sideImpulse*=b.skidInfo);for(o=0;o<r;o++){var b=i[o],x=new E;if(b.raycastResult.hitPointWorld.vsub(n.position,x),0!==b.forwardImpulse){var T=new E;s[o].scale(b.forwardImpulse,T),n.applyImpulse(T,x)}if(0!==b.sideImpulse){h=b.raycastResult.body;var C=new E;b.raycastResult.hitPointWorld.vsub(h.position,C);var S=new E;a[o].scale(b.sideImpulse,S),n.vectorToLocalFrame(x,x),x["xyz"[this.indexUpAxis]]*=b.rollInfluence,n.vectorToWorldFrame(x,x),n.applyImpulse(S,x),S.scale(-1,S),h.applyImpulse(S,C)}}};var d=new E,f=new E,m=new E;function D(e,t,i,r,n){var s=0,a=i,o=d,c=f,l=m;return e.getVelocityAtWorldPoint(a,o),t.getVelocityAtWorldPoint(a,c),o.vsub(c,l),n<(s=-r.dot(l)*(1/(b(e,i,r)+b(t,i,r))))&&(s=n),s<-n&&(s=-n),s}var o=new E,c=new E,l=new E,g=new E;function b(e,t,i){var r=o,n=c,s=l,a=g;return t.vsub(e.position,r),r.cross(i,n),e.invInertiaWorld.vmult(n,a),a.cross(r,s),e.invMass+i.dot(s)}var x=new E,T=new E,C=new E;function k(e,t,i,r,n){if(1.1<n.norm2())return 0;var s=x,a=T,o=C;return e.getVelocityAtWorldPoint(t,s),i.getVelocityAtWorldPoint(r,a),s.vsub(a,o),-.2*n.dot(o)*(1/(e.invMass+i.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(e,t,i){var a=e("./Body"),o=e("../shapes/Sphere"),r=e("../shapes/Box"),c=e("../math/Vec3"),l=e("../constraints/HingeConstraint");function n(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new c(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new r(new c(5,2,.5));this.chassisBody=new a(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}(t.exports=n).prototype.addWheel=function(e){var t=(e=e||{}).body;t=t||new a(1,new o(1.2)),this.wheelBodies.push(t),this.wheelForces.push(0),new c;var i=void 0!==e.position?e.position.clone():new c,r=new c;this.chassisBody.pointToWorldFrame(i,r),t.position.set(r.x,r.y,r.z);var n=void 0!==e.axis?e.axis.clone():new c(0,1,0);this.wheelAxes.push(n);var s=new l(this.chassisBody,t,{pivotA:i,axisA:n,pivotB:c.ZERO,axisB:n,collideConnected:!1});return this.constraints.push(s),this.wheelBodies.length-1},n.prototype.setSteeringValue=function(e,t){var i=this.wheelAxes[t],r=Math.cos(e),n=Math.sin(e),s=i.x,a=i.y;this.constraints[t].axisA.set(r*s-n*a,n*s+r*a,0)},n.prototype.setMotorSpeed=function(e,t){var i=this.constraints[t];i.enableMotor(),i.motorTargetVelocity=e},n.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var s=new c;n.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},n.prototype.applyWheelForce=function(e,t){var i=this.wheelAxes[t],r=this.wheelBodies[t],n=r.torque;i.scale(e,s),r.vectorToWorldFrame(s,s),n.vadd(s,n)},n.prototype.addToWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),r=0;r<i.length;r++)e.addBody(i[r]);for(r=0;r<t.length;r++)e.addConstraint(t[r]);e.addEventListener("preStep",this._update.bind(this))},n.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},n.prototype.removeFromWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),r=0;r<i.length;r++)e.remove(i[r]);for(r=0;r<t.length;r++)e.removeConstraint(t[r])};var u=new c;n.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],i=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,u),i.dot(u)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(e,t,i){t.exports=n,e("../shapes/Shape");var r=e("../math/Vec3");function n(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),n.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},n.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var c=new r;n.prototype.getNeighbors=function(e,t){for(var i=this.particles.length,r=e.id,n=this.smoothingRadius*this.smoothingRadius,s=c,a=0;a!==i;a++){var o=this.particles[a];o.position.vsub(e.position,s),r!==o.id&&s.norm2()<n&&t.push(o)}};var T=new r,C=new r,S=new r,E=new r,w=new r,A=new r;n.prototype.update=function(){for(var e=this.particles.length,t=T,i=this.speedOfSound,r=this.eps,n=0;n!==e;n++){var s=this.particles[n];(v=this.neighbors[n]).length=0,this.getNeighbors(s,v),v.push(this.particles[n]);for(var a=v.length,o=0,c=0;c!==a;c++){s.position.vsub(v[c].position,t);var l=t.norm(),u=this.w(l);o+=v[c].mass*u}this.densities[n]=o,this.pressures[n]=i*i*(this.densities[n]-this.density)}var h=C,_=S,p=E,d=w,f=A;for(n=0;n!==e;n++){var m,y,v,g=this.particles[n];for(h.set(0,0,0),_.set(0,0,0),a=(v=this.neighbors[n]).length,c=0;c!==a;c++){var b=v[c];g.position.vsub(b.position,d);var x=d.norm();m=-b.mass*(this.pressures[n]/(this.densities[n]*this.densities[n]+r)+this.pressures[c]/(this.densities[c]*this.densities[c]+r)),this.gradw(d,p),p.mult(m,p),h.vadd(p,h),b.velocity.vsub(g.velocity,f),f.mult(1/(1e-4+this.densities[n]*this.densities[c])*this.viscosity*b.mass,f),y=this.nablaw(x),f.mult(y,f),_.vadd(f,_)}_.mult(g.mass,_),h.mult(g.mass,h),g.force.vadd(_,g.force),g.force.vadd(h,g.force)}},n.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},n.prototype.gradw=function(e,t){var i=e.norm(),r=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(r,9))*Math.pow(r*r-i*i,2),t)},n.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(e,t,i){var r=e("../math/Vec3");function n(e,t,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new r,this.localAnchorB=new r,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}(t.exports=n).prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},n.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},n.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},n.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var y=new r,v=new r,g=new r,b=new r,x=new r,T=new r,C=new r,S=new r,E=new r,w=new r,A=new r;n.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,i=this.restLength,r=this.bodyA,n=this.bodyB,s=y,a=v,o=g,c=b,l=A,u=x,h=T,_=C,p=S,d=E,f=w;this.getWorldAnchorA(u),this.getWorldAnchorB(h),u.vsub(r.position,_),h.vsub(n.position,p),h.vsub(u,s);var m=s.norm();a.copy(s),a.normalize(),n.velocity.vsub(r.velocity,o),n.angularVelocity.cross(p,l),o.vadd(l,o),r.angularVelocity.cross(_,l),o.vsub(l,o),a.mult(-e*(m-i)-t*o.dot(a),c),r.force.vsub(c,r.force),n.force.vadd(c,n.force),_.cross(c,d),p.cross(c,f),r.torque.vsub(d,r.torque),n.torque.vadd(f,n.torque)}},{"../math/Vec3":31}],37:[function(e,t,i){var r=e("../math/Vec3"),n=e("../math/Transform"),s=e("../collision/RaycastResult"),a=e("../utils/Utils");function o(e){e=a.defaults(e,{chassisConnectionPointLocal:new r,chassisConnectionPointWorld:new r,directionLocal:new r,directionWorld:new r,axleLocal:new r,axleWorld:new r,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new s,this.worldTransform=new n,this.isInContact=!1}t.exports=o;var c=new r,l=new r;c=new r,o.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var i=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,l),e.getVelocityAtWorldPoint(l,c);var r=t.hitNormalWorld.dot(c);if(-.1<=i)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var n=-1/i;this.suspensionRelativeVelocity=r*n,this.clippedInvContactDotSuspension=n}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(e,t,i){t.exports=n;var r=e("./Shape"),a=e("../math/Vec3"),o=e("./ConvexPolyhedron");function n(e){r.call(this,{type:r.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}((n.prototype=new r).constructor=n).prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,r=a,n=[new r(-e,-t,-i),new r(e,-t,-i),new r(e,t,-i),new r(-e,t,-i),new r(-e,-t,i),new r(e,-t,i),new r(e,t,i),new r(-e,t,i)],s=(new r(0,0,1),new r(0,1,0),new r(1,0,0),new o(n,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));(this.convexPolyhedronRepresentation=s).material=this.material},n.prototype.calculateLocalInertia=function(e,t){return t=t||new a,n.calculateInertia(this.halfExtents,e,t),t},n.calculateInertia=function(e,t,i){var r=e;r.isZero()?(i.x=2/12*t,i.y=2/12*t,i.z=2/12*t):(i.x=1/12*t*(2*r.y*2*r.y+2*r.z*2*r.z),i.y=1/12*t*(2*r.x*2*r.x+2*r.z*2*r.z),i.z=1/12*t*(2*r.y*2*r.y+2*r.x*2*r.x))},n.prototype.getSideNormals=function(e,t){var i=e,r=this.halfExtents;if(i[0].set(r.x,0,0),i[1].set(0,r.y,0),i[2].set(0,0,r.z),i[3].set(-r.x,0,0),i[4].set(0,-r.y,0),i[5].set(0,0,-r.z),void 0!==t)for(var n=0;n!==i.length;n++)t.vmult(i[n],i[n]);return i},n.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var c=new a;new a,n.prototype.forEachWorldCorner=function(e,t,i){for(var r=this.halfExtents,n=[[r.x,r.y,r.z],[-r.x,r.y,r.z],[-r.x,-r.y,r.z],[-r.x,-r.y,-r.z],[r.x,-r.y,-r.z],[r.x,r.y,-r.z],[-r.x,r.y,-r.z],[r.x,-r.y,r.z]],s=0;s<n.length;s++)c.set(n[s][0],n[s][1],n[s][2]),t.vmult(c,c),e.vadd(c,c),i(c.x,c.y,c.z)};var u=[new a,new a,new a,new a,new a,new a,new a,new a];n.prototype.calculateWorldAABB=function(e,t,i,r){var n=this.halfExtents;u[0].set(n.x,n.y,n.z),u[1].set(-n.x,n.y,n.z),u[2].set(-n.x,-n.y,n.z),u[3].set(-n.x,-n.y,-n.z),u[4].set(n.x,-n.y,-n.z),u[5].set(n.x,n.y,-n.z),u[6].set(-n.x,n.y,-n.z),u[7].set(n.x,-n.y,n.z);var s=u[0];t.vmult(s,s),e.vadd(s,s),r.copy(s),i.copy(s);for(var a=1;a<8;a++){s=u[a],t.vmult(s,s),e.vadd(s,s);var o=s.x,c=s.y,l=s.z;o>r.x&&(r.x=o),c>r.y&&(r.y=c),l>r.z&&(r.z=l),o<i.x&&(i.x=o),c<i.y&&(i.y=c),l<i.z&&(i.z=l)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(e,t,i){t.exports=_;var r=e("./Shape"),b=e("../math/Vec3"),f=(e("../math/Quaternion"),e("../math/Transform"));function _(e,t,i){r.call(this,{type:r.types.CONVEXPOLYHEDRON}),this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}(_.prototype=new r).constructor=_;var h=new b;_.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,i=(t.length,this.uniqueEdges);i.length=0;for(var r=h,n=0;n!==e.length;n++)for(var s=e[n],a=s.length,o=0;o!==a;o++){var c=(o+1)%a;t[s[o]].vsub(t[s[c]],r),r.normalize();for(var l=!1,u=0;u!==i.length;u++)if(i[u].almostEquals(r)||i[u].almostEquals(r)){l=!0;break}l||i.push(r.clone())}},_.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var i=this.faceNormals[e]||new b;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i;var r=this.vertices[this.faces[e][0]];if(i.dot(r)<0)for(console.error(".faceNormals["+e+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),t=0;t<this.faces[e].length;t++)console.warn(".vertices["+this.faces[e][t]+"] = Vec3("+this.vertices[this.faces[e][t]].toString()+")")}};var n=new b,s=new b;_.computeNormal=function(e,t,i,r){t.vsub(e,s),i.vsub(t,n),n.cross(s,r),r.isZero()||r.normalize()},_.prototype.getFaceNormal=function(e,t){var i=this.faces[e],r=this.vertices[i[0]],n=this.vertices[i[1]],s=this.vertices[i[2]];return _.computeNormal(r,n,s,t)};var x=new b;_.prototype.clipAgainstHull=function(e,t,i,r,n,s,a,o,c){for(var l=x,u=-1,h=-Number.MAX_VALUE,_=0;_<i.faces.length;_++){l.copy(i.faceNormals[_]),n.vmult(l,l);var p=l.dot(s);h<p&&(h=p,u=_)}for(var d=[],f=i.faces[u],m=f.length,y=0;y<m;y++){var v=i.vertices[f[y]],g=new b;g.copy(v),n.vmult(g,g),r.vadd(g,g),d.push(g)}0<=u&&this.clipFaceAgainstHull(s,e,t,d,a,o,c)};var S=new b,E=new b,w=new b,A=new b,$=new b,O=new b;_.prototype.findSeparatingAxis=function(e,t,i,r,n,s,a,o){var c=S,l=E,u=w,h=A,_=$,p=O,d=Number.MAX_VALUE,f=this;if(f.uniqueAxes)for(y=0;y!==f.uniqueAxes.length;y++){if(i.vmult(f.uniqueAxes[y],c),!1===(b=f.testSepAxis(c,e,t,i,r,n)))return!1;b<d&&(d=b,s.copy(c))}else for(var m=a?a.length:f.faces.length,y=0;y<m;y++){var v=a?a[y]:y;if(c.copy(f.faceNormals[v]),i.vmult(c,c),!1===(b=f.testSepAxis(c,e,t,i,r,n)))return!1;b<d&&(d=b,s.copy(c))}if(e.uniqueAxes)for(y=0;y!==e.uniqueAxes.length;y++){if(n.vmult(e.uniqueAxes[y],l),!1===(b=f.testSepAxis(l,e,t,i,r,n)))return!1;b<d&&(d=b,s.copy(l))}else for(var g=o?o.length:e.faces.length,y=0;y<g;y++){var b;if(v=o?o[y]:y,l.copy(e.faceNormals[v]),n.vmult(l,l),!1===(b=f.testSepAxis(l,e,t,i,r,n)))return!1;b<d&&(d=b,s.copy(l))}for(var x=0;x!==f.uniqueEdges.length;x++){i.vmult(f.uniqueEdges[x],h);for(var T=0;T!==e.uniqueEdges.length;T++)if(n.vmult(e.uniqueEdges[T],_),h.cross(_,p),!p.almostZero()){p.normalize();var C=f.testSepAxis(p,e,t,i,r,n);if(!1===C)return!1;C<d&&(d=C,s.copy(p))}}return r.vsub(t,u),0<u.dot(s)&&s.negate(s),!0};var p=[],d=[];_.prototype.testSepAxis=function(e,t,i,r,n,s){_.project(this,e,i,r,p),_.project(t,e,n,s,d);var a=p[0],o=p[1],c=d[0],l=d[1];if(a<l||c<o)return!1;var u=a-l,h=c-o;return u<h?u:h};var a=new b,o=new b;_.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(a,o);var i=o.x-a.x,r=o.y-a.y,n=o.z-a.z;t.x=1/12*e*(2*r*2*r+2*n*2*n),t.y=1/12*e*(2*i*2*i+2*n*2*n),t.z=1/12*e*(2*r*2*r+2*i*2*i)},_.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],i=this.faceNormals[e],r=this.vertices[t[0]];return-i.dot(r)};var F=new b,P=new b,M=new b,L=new b,z=new b,B=new b,N=new b,G=new b;_.prototype.clipFaceAgainstHull=function(e,t,i,r,n,s,a){for(var o=F,c=P,l=M,u=L,h=z,_=B,p=N,d=G,f=r,m=[],y=-1,v=Number.MAX_VALUE,g=0;g<this.faces.length;g++){o.copy(this.faceNormals[g]),i.vmult(o,o);var b=o.dot(e);b<v&&(v=b,y=g)}if(!(y<0)){var x=this.faces[y];x.connectedFaces=[];for(var T=0;T<this.faces.length;T++)for(var C=0;C<this.faces[T].length;C++)-1!==x.indexOf(this.faces[T][C])&&T!==y&&-1===x.connectedFaces.indexOf(T)&&x.connectedFaces.push(T);f.length;for(var S=x.length,E=0;E<S;E++){var w=this.vertices[x[E]],A=this.vertices[x[(E+1)%S]];w.vsub(A,c),l.copy(c),i.vmult(l,l),t.vadd(l,l),u.copy(this.faceNormals[y]),i.vmult(u,u),t.vadd(u,u),l.cross(u,h),h.negate(h),_.copy(w),i.vmult(_,_),t.vadd(_,_),_.dot(h);var $=x.connectedFaces[E];p.copy(this.faceNormals[$]);var O=this.getPlaneConstantOfFace($);d.copy(p),i.vmult(d,d);var D=O-d.dot(t);for(this.clipFaceAgainstPlane(f,m,d,D);f.length;)f.shift();for(;m.length;)f.push(m.shift())}for(p.copy(this.faceNormals[y]),O=this.getPlaneConstantOfFace(y),d.copy(p),i.vmult(d,d),D=O-d.dot(t),T=0;T<f.length;T++){var k=d.dot(f[T])+D;if(k<=n&&(k=n),k<=s){var R=f[T];if(k<=0){var I={point:R,normal:d,depth:k};a.push(I)}}}}},_.prototype.clipFaceAgainstPlane=function(e,t,i,r){var n,s,a=e.length;if(a<2)return t;var o=e[e.length-1],c=e[0];n=i.dot(o)+r;for(var l=0;l<a;l++){if(c=e[l],s=i.dot(c)+r,n<0)if(s<0)(u=new b).copy(c),t.push(u);else{var u=new b;o.lerp(c,n/(n-s),u),t.push(u)}else s<0&&(u=new b,o.lerp(c,n/(n-s),u),t.push(u),t.push(c));o=c,n=s}return t},_.prototype.computeWorldVertices=function(e,t){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new b);for(var r=this.vertices,n=this.worldVertices,s=0;s!==i;s++)t.vmult(r[s],n[s]),e.vadd(n[s],n[s]);this.worldVerticesNeedsUpdate=!1},new b,_.prototype.computeLocalAABB=function(e,t){var i=this.vertices.length,r=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var n=0;n<i;n++){var s=r[n];s.x<e.x?e.x=s.x:s.x>t.x&&(t.x=s.x),s.y<e.y?e.y=s.y:s.y>t.y&&(t.y=s.y),s.z<e.z?e.z=s.z:s.z>t.z&&(t.z=s.z)}},_.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new b);for(var i=this.faceNormals,r=this.worldFaceNormals,n=0;n!==t;n++)e.vmult(i[n],r[n]);this.worldFaceNormalsNeedsUpdate=!1},_.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=0,r=t.length;i!==r;i++){var n=t[i].norm2();e<n&&(e=n)}this.boundingSphereRadius=Math.sqrt(e)};var m=new b;_.prototype.calculateWorldAABB=function(e,t,i,r){for(var n,s,a,o,c,l,u=this.vertices.length,h=this.vertices,_=0;_<u;_++){m.copy(h[_]),t.vmult(m,m),e.vadd(m,m);var p=m;p.x<n||void 0===n?n=p.x:(p.x>o||void 0===o)&&(o=p.x),p.y<s||void 0===s?s=p.y:(p.y>c||void 0===c)&&(c=p.y),p.z<a||void 0===a?a=p.z:(p.z>l||void 0===l)&&(l=p.z)}i.set(n,s,a),r.set(o,c,l)},_.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},_.prototype.getAveragePointLocal=function(e){e=e||new b;for(var t=this.vertices.length,i=this.vertices,r=0;r<t;r++)e.vadd(i[r],e);return e.mult(1/t,e),e},_.prototype.transformAllPoints=function(e,t){var i=this.vertices.length,r=this.vertices;if(t){for(var n=0;n<i;n++){var s=r[n];t.vmult(s,s)}for(n=0;n<this.faceNormals.length;n++)s=this.faceNormals[n],t.vmult(s,s)}if(e)for(n=0;n<i;n++)(s=r[n]).vadd(e,s)};var y=new b,v=new b,g=new b;_.prototype.pointIsInside=function(e){var t=this.vertices.length,i=this.vertices,r=this.faces,n=this.faceNormals,s=this.faces.length,a=y;this.getAveragePointLocal(a);for(var o=0;o<s;o++){this.faces[o].length,t=n[o];var c=i[r[o][0]],l=v;e.vsub(c,l);var u=t.dot(l),h=g;a.vsub(c,h);var _=t.dot(h);if(u<0&&0<_||0<u&&_<0)return!1}return-1},new b;var T=new b,C=new b;_.project=function(e,t,i,r,n){var s=e.vertices.length,a=T,o=0,c=0,l=C,u=e.vertices;l.setZero(),f.vectorToLocalFrame(i,r,t,a),f.pointToLocalFrame(i,r,l,l);var h=l.dot(a);c=o=u[0].dot(a);for(var _=1;_<s;_++){var p=u[_].dot(a);o<p&&(o=p),p<c&&(c=p)}if((o-=h)<(c-=h)){var d=c;c=o,o=d}n[0]=o,n[1]=c}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(e,t,i){t.exports=r,e("./Shape");var m=e("../math/Vec3"),y=(e("../math/Quaternion"),e("./ConvexPolyhedron"));function r(e,t,i,r){var n=r,s=[],a=[],o=[],c=[],l=[],u=Math.cos,h=Math.sin;s.push(new m(t*u(0),t*h(0),.5*-i)),c.push(0),s.push(new m(e*u(0),e*h(0),.5*i)),l.push(1);for(var _=0;_<n;_++){var p=2*Math.PI/n*(_+1),d=2*Math.PI/n*(_+.5);_<n-1?(s.push(new m(t*u(p),t*h(p),.5*-i)),c.push(2*_+2),s.push(new m(e*u(p),e*h(p),.5*i)),l.push(2*_+3),o.push([2*_+2,2*_+3,2*_+1,2*_])):o.push([0,1,2*_+1,2*_]),(n%2==1||_<n/2)&&a.push(new m(u(d),h(d),0))}o.push(l),a.push(new m(0,0,1));var f=[];for(_=0;_<c.length;_++)f.push(c[c.length-_-1]);o.push(f),y.call(this,s,o,a)}r.prototype=new y},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(e,t,i){var r=e("./Shape"),h=e("./ConvexPolyhedron"),_=e("../math/Vec3"),n=e("../utils/Utils");function s(e,t){t=n.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,r.call(this,{type:r.types.HEIGHTFIELD}),this.pillarConvex=new h,this.pillarOffset=new _,this.updateBoundingSphereRadius(),this._cachedPillars={}}((t.exports=s).prototype=new r).update=function(){this._cachedPillars={}},s.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var r=0;r!==e[i].length;r++){var n=e[i][r];n<t&&(t=n)}this.minValue=t},s.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var r=0;r!==e[i].length;r++){var n=e[i][r];t<n&&(t=n)}this.maxValue=t},s.prototype.setHeightValueAtIndex=function(e,t,i){this.data[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),0<e&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),0<t&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),0<t&&0<e&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},s.prototype.getRectMinMax=function(e,t,i,r,n){n=n||[];for(var s=this.data,a=this.minValue,o=e;o<=i;o++)for(var c=t;c<=r;c++){var l=s[o][c];a<l&&(a=l)}n[0]=this.minValue,n[1]=a},s.prototype.getIndexOfPosition=function(e,t,i,r){var n=this.elementSize,s=this.data,a=Math.floor(e/n),o=Math.floor(t/n);return i[0]=a,i[1]=o,r&&(a<0&&(a=0),o<0&&(o=0),a>=s.length-1&&(a=s.length-1),o>=s[0].length-1&&(o=s[0].length-1)),!(a<0||o<0||a>=s.length-1||o>=s[0].length-1)};var p=[],d=new _,f=new _,m=new _,y=new _;s.prototype.getTriangleAt=function(e,t,i,r,n,s){var a=p;this.getIndexOfPosition(e,t,a,i);var o=a[0],c=a[1],l=this.data;i&&(o=Math.min(l.length-2,Math.max(0,o)),c=Math.min(l[0].length-2,Math.max(0,c)));var u=this.elementSize,h=Math.pow(e/u-o,2)+Math.pow(t/u-c,2),_=Math.pow(e/u-(o+1),2)+Math.pow(t/u-(c+1),2)<h;return this.getTriangle(o,c,_,r,n,s),_};var l=new _,u=new _,v=new _,g=new _,b=new _;s.prototype.getNormalAt=function(e,t,i,r){var n=l,s=u,a=v,o=g,c=b;this.getTriangleAt(e,t,i,n,s,a),s.vsub(n,o),a.vsub(n,c),o.cross(c,r),r.normalize()},s.prototype.getAabbAtIndex=function(e,t,i){var r=this.data,n=this.elementSize;i.lowerBound.set(e*n,t*n,r[e][t]),i.upperBound.set((e+1)*n,(t+1)*n,r[e+1][t+1])},s.prototype.getHeightAt=function(e,t,i){var r=this.data,n=f,s=m,a=y,o=p;this.getIndexOfPosition(e,t,o,i);var c=o[0],l=o[1];i&&(c=Math.min(r.length-2,Math.max(0,c)),l=Math.min(r[0].length-2,Math.max(0,l)));var u=this.getTriangleAt(e,t,i,n,s,a);!function(e,t,i,r,n,s,a,o,c){c.x=((s-o)*(e-a)+(a-n)*(t-o))/((s-o)*(i-a)+(a-n)*(r-o)),c.y=((o-r)*(e-a)+(i-a)*(t-o))/((s-o)*(i-a)+(a-n)*(r-o)),c.z=1-c.x-c.y}(e,t,n.x,n.y,s.x,s.y,a.x,a.y,d);var h=d;return u?r[c+1][l+1]*h.x+r[c][l+1]*h.y+r[c+1][l]*h.z:r[c][l]*h.x+r[c+1][l]*h.y+r[c][l+1]*h.z},s.prototype.getCacheConvexTrianglePillarKey=function(e,t,i){return e+"_"+t+"_"+(i?1:0)},s.prototype.getCachedConvexTrianglePillar=function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},s.prototype.setCachedConvexTrianglePillar=function(e,t,i,r,n){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:r,offset:n}},s.prototype.clearCachedConvexTrianglePillar=function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},s.prototype.getTriangle=function(e,t,i,r,n,s){var a=this.data,o=this.elementSize;i?(r.set((e+1)*o,(t+1)*o,a[e+1][t+1]),n.set(e*o,(t+1)*o,a[e][t+1]),s.set((e+1)*o,t*o,a[e+1][t])):(r.set(e*o,t*o,a[e][t]),n.set((e+1)*o,t*o,a[e+1][t]),s.set(e*o,(t+1)*o,a[e][t+1]))},s.prototype.getConvexTrianglePillar=function(e,t,i){var r=this.pillarConvex,n=this.pillarOffset;if(this.cacheEnabled){if(s=this.getCachedConvexTrianglePillar(e,t,i))return this.pillarConvex=s.convex,void(this.pillarOffset=s.offset);r=new h,n=new _,this.pillarConvex=r,this.pillarOffset=n}var s=this.data,a=this.elementSize,o=r.faces;r.vertices.length=6;for(var c=0;c<6;c++)r.vertices[c]||(r.vertices[c]=new _);for(o.length=5,c=0;c<5;c++)o[c]||(o[c]=[]);var l=r.vertices,u=(Math.min(s[e][t],s[e+1][t],s[e][t+1],s[e+1][t+1])-this.minValue)/2+this.minValue;i?(n.set((e+.75)*a,(t+.75)*a,u),l[0].set(.25*a,.25*a,s[e+1][t+1]-u),l[1].set(-.75*a,.25*a,s[e][t+1]-u),l[2].set(.25*a,-.75*a,s[e+1][t]-u),l[3].set(.25*a,.25*a,-u-1),l[4].set(-.75*a,.25*a,-u-1),l[5].set(.25*a,-.75*a,-u-1),o[0][0]=0,o[0][1]=1,o[0][2]=2,o[1][0]=5,o[1][1]=4,o[1][2]=3,o[2][0]=2,o[2][1]=5,o[2][2]=3,o[2][3]=0,o[3][0]=3,o[3][1]=4,o[3][2]=1,o[3][3]=0,o[4][0]=1,o[4][1]=4,o[4][2]=5,o[4][3]=2):(n.set((e+.25)*a,(t+.25)*a,u),l[0].set(-.25*a,-.25*a,s[e][t]-u),l[1].set(.75*a,-.25*a,s[e+1][t]-u),l[2].set(-.25*a,.75*a,s[e][t+1]-u),l[3].set(-.25*a,-.25*a,-u-1),l[4].set(.75*a,-.25*a,-u-1),l[5].set(-.25*a,.75*a,-u-1),o[0][0]=0,o[0][1]=1,o[0][2]=2,o[1][0]=5,o[1][1]=4,o[1][2]=3,o[2][0]=0,o[2][1]=2,o[2][2]=5,o[2][3]=3,o[3][0]=1,o[3][1]=0,o[3][2]=3,o[3][3]=4,o[4][0]=4,o[4][1]=5,o[4][2]=2,o[4][3]=1),r.computeNormals(),r.computeEdges(),r.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,r,n)},s.prototype.calculateLocalInertia=function(e,t){return(t=t||new _).set(0,0,0),t},s.prototype.volume=function(){return Number.MAX_VALUE},s.prototype.calculateWorldAABB=function(e,t,i,r){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),r.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},s.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new _(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},s.prototype.setHeightsFromImage=function(e,t){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var r=i.getContext("2d");r.drawImage(e,0,0);var n=r.getImageData(0,0,e.width,e.height),s=this.data;s.length=0,this.elementSize=Math.abs(t.x)/n.width;for(var a=0;a<n.height;a++){for(var o=[],c=0;c<n.width;c++){var l=(n.data[4*(a*n.height+c)]+n.data[4*(a*n.height+c)+1]+n.data[4*(a*n.height+c)+2])/4/255*t.z;t.x<0?o.push(l):o.unshift(l)}t.y<0?s.unshift(o):s.push(o)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(e,t,i){t.exports=s;var r=e("./Shape"),n=e("../math/Vec3");function s(){r.call(this,{type:r.types.PARTICLE})}((s.prototype=new r).constructor=s).prototype.calculateLocalInertia=function(e,t){return(t=t||new n).set(0,0,0),t},s.prototype.volume=function(){return 0},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},s.prototype.calculateWorldAABB=function(e,t,i,r){i.copy(e),r.copy(e)}},{"../math/Vec3":31,"./Shape":44}],43:[function(e,t,i){t.exports=s;var r=e("./Shape"),n=e("../math/Vec3");function s(){r.call(this,{type:r.types.PLANE}),this.worldNormal=new n,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}((s.prototype=new r).constructor=s).prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},s.prototype.calculateLocalInertia=function(e,t){return t=t||new n},s.prototype.volume=function(){return Number.MAX_VALUE};var a=new n;s.prototype.calculateWorldAABB=function(e,t,i,r){a.set(0,0,1),t.vmult(a,a);var n=Number.MAX_VALUE;i.set(-n,-n,-n),r.set(n,n,n),1===a.x&&(r.x=e.x),1===a.y&&(r.y=e.y),1===a.z&&(r.z=e.z),-1===a.x&&(i.x=e.x),-1===a.y&&(i.y=e.y),-1===a.z&&(i.z=e.z)},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(e,t,i){t.exports=n;var r=e("../utils/EventTarget"),n=e("./Shape");function n(e){e=e||{},r.apply(this),this.id=n.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),n.prototype=new r,(n.prototype.constructor=n).prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},n.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},n.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type},n.idCounter=0,n.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(e,t,i){t.exports=s;var r=e("./Shape"),n=e("../math/Vec3");function s(e){if(r.call(this,{type:r.types.SPHERE}),this.radius=void 0!==e?e:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}((s.prototype=new r).constructor=s).prototype.calculateLocalInertia=function(e,t){t=t||new n;var i=2*e*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t},s.prototype.volume=function(){return 4*Math.PI*this.radius/3},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},s.prototype.calculateWorldAABB=function(e,t,i,r){for(var n=this.radius,s=["x","y","z"],a=0;a<s.length;a++){var o=s[a];i[o]=e[o]-n,r[o]=e[o]+n}}},{"../math/Vec3":31,"./Shape":44}],46:[function(e,t,i){t.exports=v;var r=e("./Shape"),l=e("../math/Vec3"),n=(e("../math/Quaternion"),e("../math/Transform")),u=e("../collision/AABB"),s=e("../utils/Octree");function v(e,t){r.call(this,{type:r.types.TRIMESH}),this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new u,this.edges=null,this.scale=new l(1,1,1),this.tree=new s,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}(v.prototype=new r).constructor=v;var o=new l;v.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new u,r=new l,n=new l,s=new l,a=[r,n,s],o=0;o<this.indices.length/3;o++){var c=3*o;this._getUnscaledVertex(this.indices[c],r),this._getUnscaledVertex(this.indices[1+c],n),this._getUnscaledVertex(this.indices[2+c],s),i.setFromPoints(a),e.insert(i,o)}e.removeEmptyNodes()};var c=new u;v.prototype.getTrianglesInAABB=function(e,t){c.copy(e);var i=this.scale,r=i.x,n=i.y,s=i.z,a=c.lowerBound,o=c.upperBound;return a.x/=r,a.y/=n,a.z/=s,o.x/=r,o.y/=n,o.z/=s,this.tree.aabbQuery(c,t)},v.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,i=e.x===e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},v.prototype.updateNormals=function(){for(var e=o,t=this.normals,i=0;i<this.indices.length/3;i++){var r=3*i,n=this.indices[r],s=this.indices[1+r],a=this.indices[2+r];this.getVertex(n,d),this.getVertex(s,f),this.getVertex(a,m),v.computeNormal(f,d,m,e),t[r]=e.x,t[1+r]=e.y,t[2+r]=e.z}},v.prototype.updateEdges=function(){function e(e,t){i[n<s?n+"_"+s:s+"_"+n]=!0}for(var i={},t=0;t<this.indices.length/3;t++){var r=3*t,n=this.indices[r],s=this.indices[1+r];this.indices[2+r],e(),e(),e()}var a=Object.keys(i);for(this.edges=new Int16Array(2*a.length),t=0;t<a.length;t++){var o=a[t].split("_");this.edges[2*t]=parseInt(o[0],10),this.edges[2*t+1]=parseInt(o[1],10)}},v.prototype.getEdgeVertex=function(e,t,i){var r=this.edges[2*e+(t?1:0)];this.getVertex(r,i)};var a=new l,h=new l;v.prototype.getEdgeVector=function(e,t){var i=a,r=h;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,r),r.vsub(i,t)};var _=new l,p=new l;v.computeNormal=function(e,t,i,r){t.vsub(e,p),i.vsub(t,_),_.cross(p,r),r.isZero()||r.normalize()};var d=new l,f=new l,m=new l;v.prototype.getVertex=function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t},v.prototype._getUnscaledVertex=function(e,t){var i=3*e,r=this.vertices;return t.set(r[i],r[1+i],r[2+i])},v.prototype.getWorldVertex=function(e,t,i,r){return this.getVertex(e,r),n.pointToWorldFrame(t,i,r,r),r},v.prototype.getTriangleVertices=function(e,t,i,r){var n=3*e;this.getVertex(this.indices[n],t),this.getVertex(this.indices[1+n],i),this.getVertex(this.indices[2+n],r)},v.prototype.getNormal=function(e,t){var i=3*e;return t.set(this.normals[i],this.normals[1+i],this.normals[2+i])};var y=new u;v.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(y);var i=y.upperBound.x-y.lowerBound.x,r=y.upperBound.y-y.lowerBound.y,n=y.upperBound.z-y.lowerBound.z;return t.set(1/12*e*(2*r*2*r+2*n*2*n),1/12*e*(2*i*2*i+2*n*2*n),1/12*e*(2*r*2*r+2*i*2*i))};var g=new l;v.prototype.computeLocalAABB=function(e){var t=e.lowerBound,i=e.upperBound,r=this.vertices.length,n=(this.vertices,g);this.getVertex(0,n),t.copy(n),i.copy(n);for(var s=0;s!==r;s++)this.getVertex(s,n),n.x<t.x?t.x=n.x:n.x>i.x&&(i.x=n.x),n.y<t.y?t.y=n.y:n.y>i.y&&(i.y=n.y),n.z<t.z?t.z=n.z:n.z>i.z&&(i.z=n.z)},v.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},v.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=new l,r=0,n=t.length/3;r!==n;r++){this.getVertex(r,i);var s=i.norm2();e<s&&(e=s)}this.boundingSphereRadius=Math.sqrt(e)},new l;var b=new n,x=new u;v.prototype.calculateWorldAABB=function(e,t,i,r){var n=b,s=x;n.position=e,n.quaternion=t,this.aabb.toWorldFrame(n,s),i.copy(s.lowerBound),r.copy(s.upperBound)},v.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},v.createTorus=function(e,t,i,r,n){e=e||1,t=t||.5,i=i||8,r=r||6,n=n||2*Math.PI;for(var s=[],a=[],o=0;o<=i;o++)for(var c=0;c<=r;c++){var l=c/r*n,u=o/i*Math.PI*2,h=(e+t*Math.cos(u))*Math.cos(l),_=(e+t*Math.cos(u))*Math.sin(l),p=t*Math.sin(u);s.push(h,_,p)}for(o=1;o<=i;o++)for(c=1;c<=r;c++){var d=(r+1)*o+c-1,f=(r+1)*(o-1)+c-1,m=(r+1)*(o-1)+c,y=(r+1)*o+c;a.push(d,f,y),a.push(f,m,y)}return new v(s,a)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(e,t,i){t.exports=n,e("../math/Vec3"),e("../math/Quaternion");var r=e("./Solver");function n(){r.call(this),this.iterations=10,this.tolerance=1e-7}n.prototype=new r;var $=[],O=[],D=[];n.prototype.solve=function(e,t){var i,r,n,s,a,o=0,c=this.iterations,l=this.tolerance*this.tolerance,u=this.equations,h=u.length,_=t.bodies,p=_.length,d=e;if(0!==h)for(var f=0;f!==p;f++)_[f].updateSolveMassProperties();var m=O,y=D,v=$;for(m.length=h,y.length=h,v.length=h,f=0;f!==h;f++){var g=u[f];v[f]=0,y[f]=g.computeB(d),m[f]=1/g.computeC()}if(0!==h){for(f=0;f!==p;f++){var b=(C=_[f]).vlambda,x=C.wlambda;b.set(0,0,0),x.set(0,0,0)}for(o=0;o!==c;o++){for(var T=s=0;T!==h;T++)g=u[T],i=y[T],r=m[T],(a=v[T])+(n=r*(i-g.computeGWlambda()-g.eps*a))<g.minForce?n=g.minForce-a:a+n>g.maxForce&&(n=g.maxForce-a),v[T]+=n,s+=0<n?n:-n,g.addToWlambda(n);if(s*s<l)break}for(f=0;f!==p;f++){var C,S=(C=_[f]).velocity,E=C.angularVelocity;C.vlambda.vmul(C.linearFactor,C.vlambda),S.vadd(C.vlambda,S),C.wlambda.vmul(C.angularFactor,C.wlambda),E.vadd(C.wlambda,E)}for(var w=u.length,A=1/d;w--;)u[w].multiplier=v[w]*A}return o}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(e,t,i){function r(){this.equations=[]}(t.exports=r).prototype.solve=function(e,t){return 0},r.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},r.prototype.removeEquation=function(e){var t=this.equations,i=t.indexOf(e);-1!==i&&t.splice(i,1)},r.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(e,t,i){t.exports=s,e("../math/Vec3"),e("../math/Quaternion");var r=e("./Solver"),n=e("../objects/Body");function s(e){for(r.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}s.prototype=new r;var x=[],T=[],C={bodies:[]},a=n.STATIC;function S(e){for(var t=e.length,i=0;i!==t;i++){var r=e[i];if(!(r.visited||r.body.type&a))return r}return!1}var o=[];function E(e,t,i,r){for(o.push(e),e.visited=!0,t(e,i,r);o.length;)for(var n,s=o.pop();n=S(s.children);)n.visited=!0,t(n,i,r),o.push(n)}function w(e,t,i){t.push(e.body);for(var r=e.eqs.length,n=0;n!==r;n++){var s=e.eqs[n];-1===i.indexOf(s)&&i.push(s)}}function A(e,t){return t.id-e.id}s.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},s.prototype.solve=function(e,t){for(var i=x,r=this.nodePool,n=t.bodies,s=this.equations,a=s.length,o=n.length,c=this.subsolver;r.length<o;)r.push(this.createNode());i.length=o;for(var l=0;l<o;l++)i[l]=r[l];for(l=0;l!==o;l++){var u=i[l];u.body=n[l],u.children.length=0,u.eqs.length=0,u.visited=!1}for(var h=0;h!==a;h++){var _=s[h],p=(l=n.indexOf(_.bi),n.indexOf(_.bj)),d=i[l],f=i[p];d.children.push(f),d.eqs.push(_),f.children.push(d),f.eqs.push(_)}var m,y=0,v=T;c.tolerance=this.tolerance,c.iterations=this.iterations;for(var g=C;m=S(i);){v.length=0,g.bodies.length=0,E(m,w,g.bodies,v);var b=v.length;for(v=v.sort(A),l=0;l!==b;l++)c.addEquation(v[l]);c.solve(e,g),c.removeAllEquations(),y++}return y}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(e,t,i){function r(){}(t.exports=r).prototype={constructor:r,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},hasAnyEventListener:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;var r=i[e].indexOf(t);return-1!==r&&i[e].splice(r,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=0,r=t.length;i<r;i++)t[i].call(this,e)}return this}}},{}],51:[function(e,t,i){var c=e("../collision/AABB"),l=e("../math/Vec3");function u(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new c,this.data=[],this.children=[]}(t.exports=function(e,t){(t=t||{}).root=null,t.aabb=e,u.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}).prototype=new u,u.prototype.reset=function(e,t){this.children.length=this.data.length=0},u.prototype.insert=function(e,t,i){var r=this.data;if(i=i||0,!this.aabb.contains(e))return!1;var n=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var s=!1;n.length||(this.subdivide(),s=!0);for(var a=0;8!==a;a++)if(n[a].insert(e,t,i+1))return!0;s&&(n.length=0)}return r.push(t),!0};var h=new l;u.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,i=e.upperBound,r=this.children;r.push(new u({aabb:new c({lowerBound:new l(0,0,0)})}),new u({aabb:new c({lowerBound:new l(1,0,0)})}),new u({aabb:new c({lowerBound:new l(1,1,0)})}),new u({aabb:new c({lowerBound:new l(1,1,1)})}),new u({aabb:new c({lowerBound:new l(0,1,1)})}),new u({aabb:new c({lowerBound:new l(0,0,1)})}),new u({aabb:new c({lowerBound:new l(1,0,1)})}),new u({aabb:new c({lowerBound:new l(0,1,0)})})),i.vsub(t,h),h.scale(.5,h);for(var n=this.root||this,s=0;8!==s;s++){var a=r[s];a.root=n;var o=a.aabb.lowerBound;o.x*=h.x,o.y*=h.y,o.z*=h.z,o.vadd(t,o),o.vadd(h,a.aabb.upperBound)}},u.prototype.aabbQuery=function(e,t){this.data,this.children;for(var i=[this];i.length;){var r=i.pop();r.aabb.overlaps(e)&&Array.prototype.push.apply(t,r.data),Array.prototype.push.apply(i,r.children)}return t};var r=new c;u.prototype.rayQuery=function(e,t,i){return e.getAABB(r),r.toLocalFrame(t,r),this.aabbQuery(r,i),i},u.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),i=t.children.length-1;0<=i;i--)t.children[i].data.length||t.children.splice(i,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(e,t,i){function r(){this.objects=[],this.type=Object}(t.exports=r).prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t]);return this},r.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},r.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},r.prototype.resize=function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}},{}],53:[function(e,t,i){function r(){this.data={keys:[]}}(t.exports=r).prototype.get=function(e,t){if(t<e){var i=t;t=e,e=i}return this.data[e+"-"+t]},r.prototype.set=function(e,t,i){if(t<e){var r=t;t=e,e=r}var n=e+"-"+t;return this.get(e,t)||this.data.keys.push(n),this.data[n]=i,this.data[n]},r.prototype.reset=function(){for(var e=this.data,t=e.keys;0<t.length;)delete e[t.pop()]},r.prototype.getLength=function(){return this.data.keys.length},r.prototype.getKeyByIndex=function(e){return this.data.keys[e]},r.prototype.getDataByKey=function(e){return this.data[e]}},{}],54:[function(e,t,i){(t.exports=function(){}).defaults=function(e,t){for(var i in e=e||{},t)i in e||(e[i]=t[i]);return e}},{}],55:[function(e,t,i){t.exports=s;var r=e("../math/Vec3"),n=e("./Pool");function s(){n.call(this),this.type=r}(s.prototype=new n).constructObject=function(){return new r}},{"../math/Vec3":31,"./Pool":52}],56:[function(e,t,i){t.exports=o;var r=e("../collision/AABB"),C=e("../objects/Body"),n=e("../shapes/Shape"),P=e("../collision/Ray"),v=e("../math/Vec3"),M=e("../math/Transform"),s=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),a=(e("../solver/Solver"),e("../utils/Vec3Pool")),u=e("../equations/ContactEquation"),m=e("../equations/FrictionEquation");function o(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new a,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}o.prototype.createContactEquation=function(e,t,i,r,n,s){var a;this.contactPointPool.length?((a=this.contactPointPool.pop()).bi=e,a.bj=t):a=new u(e,t);var o=this.currentContactMaterial;a.restitution=o.restitution,a.setSpookParams(o.contactEquationStiffness,o.contactEquationRelaxation,this.world.dt);var c=i.material||e.material,l=r.material||t.material;return c&&l&&0<=c.restitution&&0<=l.restitution&&(a.restitution=c.restitution*l.restitution),a.si=n||i,a.sj=s||r,a},o.prototype.createFrictionEquationsFromContact=function(e,t){var i=e.bi,r=e.bj,n=e.si,s=e.sj,a=this.world,o=this.currentContactMaterial,c=o.friction,l=n.material||i.material,u=s.material||r.material;if(l&&u&&0<=l.friction&&0<=u.friction&&(c=l.friction*u.friction),0<c){var h=c*a.gravity.length(),_=i.invMass+r.invMass;0<_&&(_=1/_);var p=this.frictionEquationPool,d=p.length?p.pop():new m(i,r,h*_),f=p.length?p.pop():new m(i,r,h*_);return d.bi=f.bi=i,d.bj=f.bj=r,d.minForce=f.minForce=-h*_,d.maxForce=f.maxForce=h*_,d.ri.copy(e.ri),d.rj.copy(e.rj),f.ri.copy(e.ri),f.rj.copy(e.rj),e.ni.tangents(d.t,f.t),d.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,a.dt),f.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,a.dt),d.enabled=f.enabled=e.enabled,t.push(d,f),!0}return!1};var c=new v,l=new v,h=new v;o.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],r=this.frictionResult[this.frictionResult.length-1];c.setZero(),l.setZero(),h.setZero();for(var n=t.bi,s=(t.bj,0);s!==e;s++)(t=this.result[this.result.length-1-s]).bodyA!==n?(c.vadd(t.ni,c),l.vadd(t.ri,l),h.vadd(t.rj,h)):(c.vsub(t.ni,c),l.vadd(t.rj,l),h.vadd(t.ri,h));var a=1/e;l.scale(a,i.ri),h.scale(a,i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj),c.normalize(),c.tangents(i.t,r.t)}};var S=new v,E=new v,w=new s,A=new s;o.prototype.getContacts=function(e,t,i,r,n,s,a){this.frictionEquationPool=a,this.result=r,this.frictionResult=s;for(var o=w,c=A,l=S,u=E,h=0,_=e.length;h!==_;h++){var p=e[h],d=t[h],f=null;p.material&&d.material&&(f=i.getContactMaterial(p.material,d.material)||null);for(var m=0==p.collisionResponse||0==d.collisionResponse||p.type&C.KINEMATIC&&d.type&C.STATIC||p.type&C.STATIC&&d.type&C.KINEMATIC||p.type&C.KINEMATIC&&d.type&C.KINEMATIC,y=0;y<p.shapes.length;y++){p.quaternion.mult(p.shapeOrientations[y],o),p.quaternion.vmult(p.shapeOffsets[y],l),l.vadd(p.position,l);for(var v=p.shapes[y],g=0;g<d.shapes.length;g++){d.quaternion.mult(d.shapeOrientations[g],c),d.quaternion.vmult(d.shapeOffsets[g],u),u.vadd(d.position,u);var b=d.shapes[g];if(v.collisionFilterMask&b.collisionFilterGroup&&b.collisionFilterMask&v.collisionFilterGroup&&!(l.distanceTo(u)>v.boundingSphereRadius+b.boundingSphereRadius)){m|=0==v.collisionResponse||0==b.collisionResponse;var x=null;v.material&&b.material&&(x=i.getContactMaterial(v.material,b.material)||null),this.currentContactMaterial=x||f||i.defaultContactMaterial;var T=this[v.type|b.type];T&&(v.type<b.type?T.call(this,v,b,l,u,o,c,p,d,v,b,m):T.call(this,b,v,u,l,c,o,d,p,v,b,m))&&m&&(i.shapeOverlapKeeper.set(v.id,b.id),i.shapeOverlapKeeperExit.set(v.id,b.id))}}}}},o.prototype[n.types.BOX|n.types.BOX]=o.prototype.boxBox=function(e,t,i,r,n,s,a,o,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,r,n,s,a,o,e,t,u)},o.prototype[n.types.BOX|n.types.CONVEXPOLYHEDRON]=o.prototype.boxConvex=function(e,t,i,r,n,s,a,o,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,r,n,s,a,o,e,t,u)},o.prototype[n.types.BOX|n.types.PARTICLE]=o.prototype.boxParticle=function(e,t,i,r,n,s,a,o,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,r,n,s,a,o,e,t,u)},o.prototype[n.types.SPHERE]=o.prototype.sphereSphere=function(e,t,i,r,n,s,a,o,c,l,u){if(u)return i.distanceSquared(r)<Math.pow(e.radius+t.radius,2);var h=this.createContactEquation(a,o,e,t,c,l);r.vsub(i,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(e.radius,h.ri),h.rj.mult(-t.radius,h.rj),h.ri.vadd(i,h.ri),h.ri.vsub(a.position,h.ri),h.rj.vadd(r,h.rj),h.rj.vsub(o.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var g=new v,b=new v,x=new v;o.prototype[n.types.PLANE|n.types.TRIMESH]=o.prototype.planeTrimesh=function(e,t,i,r,n,s,a,o,c,l,u){var h=new v,_=g;_.set(0,0,1),n.vmult(_,_);for(var p=0;p<t.vertices.length/3;p++){t.getVertex(p,h);var d=new v;d.copy(h),M.pointToWorldFrame(r,s,d,h);var f=b;if(h.vsub(i,f),_.dot(f)<=0){if(u)return!0;var m=this.createContactEquation(a,o,e,t,c,l);m.ni.copy(_);var y=x;_.scale(f.dot(_),y),h.vsub(y,y),m.ri.copy(y),m.ri.vsub(a.position,m.ri),m.rj.copy(h),m.rj.vsub(o.position,m.rj),this.result.push(m),this.createFrictionEquationsFromContact(m,this.frictionResult)}}};var L=new v,z=new v,B=(new v,new v),N=new v,G=new v,V=new v,U=new v,X=new v,W=new v,H=new v,q=new v,j=new v,Y=new v,Q=new r,K=[];o.prototype[n.types.SPHERE|n.types.TRIMESH]=o.prototype.sphereTrimesh=function(e,t,i,r,n,s,a,o,c,l,u){var h=G,_=V,p=U,d=X,f=W,m=H,y=Q,v=N,g=z,b=K;M.pointToLocalFrame(r,s,i,f);var x=e.radius;y.lowerBound.set(f.x-x,f.y-x,f.z-x),y.upperBound.set(f.x+x,f.y+x,f.z+x),t.getTrianglesInAABB(y,b);for(var T=B,C=e.radius*e.radius,S=0;S<b.length;S++)for(var E=0;E<3;E++)if(t.getVertex(t.indices[3*b[S]+E],T),T.vsub(f,g),g.norm2()<=C){if(v.copy(T),M.pointToWorldFrame(r,s,v,T),T.vsub(i,g),u)return!0;($=this.createContactEquation(a,o,e,t,c,l)).ni.copy(g),$.ni.normalize(),$.ri.copy($.ni),$.ri.scale(e.radius,$.ri),$.ri.vadd(i,$.ri),$.ri.vsub(a.position,$.ri),$.rj.copy(T),$.rj.vsub(o.position,$.rj),this.result.push($),this.createFrictionEquationsFromContact($,this.frictionResult)}for(S=0;S<b.length;S++)for(E=0;E<3;E++){t.getVertex(t.indices[3*b[S]+E],h),t.getVertex(t.indices[3*b[S]+(E+1)%3],_),_.vsub(h,p),f.vsub(_,m);var w=m.dot(p);f.vsub(h,m);var A=m.dot(p);if(0<A&&w<0&&(f.vsub(h,m),d.copy(p),d.normalize(),A=m.dot(d),d.scale(A,m),m.vadd(h,m),(F=m.distanceTo(f))<e.radius)){if(u)return!0;var $=this.createContactEquation(a,o,e,t,c,l);m.vsub(f,$.ni),$.ni.normalize(),$.ni.scale(e.radius,$.ri),M.pointToWorldFrame(r,s,m,m),m.vsub(o.position,$.rj),M.vectorToWorldFrame(s,$.ni,$.ni),M.vectorToWorldFrame(s,$.ri,$.ri),this.result.push($),this.createFrictionEquationsFromContact($,this.frictionResult)}}for(var O=q,D=j,k=Y,R=L,I=(S=0,b.length);S!==I;S++){t.getTriangleVertices(b[S],O,D,k),t.getNormal(b[S],R),f.vsub(O,m);var F=m.dot(R);if(R.scale(F,m),f.vsub(m,m),F=m.distanceTo(f),P.pointInTriangle(m,O,D,k)&&F<e.radius){if(u)return!0;$=this.createContactEquation(a,o,e,t,c,l),m.vsub(f,$.ni),$.ni.normalize(),$.ni.scale(e.radius,$.ri),M.pointToWorldFrame(r,s,m,m),m.vsub(o.position,$.rj),M.vectorToWorldFrame(s,$.ni,$.ni),M.vectorToWorldFrame(s,$.ri,$.ri),this.result.push($),this.createFrictionEquationsFromContact($,this.frictionResult)}}b.length=0};var d=new v,f=new v,y=new v,T=new v,$=new v;o.prototype[n.types.SPHERE|n.types.PLANE]=o.prototype.spherePlane=function(e,t,i,r,n,s,a,o,c,l,u){if(y.set(0,0,1),s.vmult(y,y),y.negate(y),y.normalize(),y.mult(e.radius,T),i.vsub(r,d),y.mult(y.dot(d),f),d.vsub(f,$),-d.dot(y)<=e.radius){if(u)return!0;var h=this.createContactEquation(a,o,e,t,c,l);h.ni.copy(y),h.ri.copy(T),h.rj.copy($);var _=h.ri,p=h.rj;_.vadd(i,_),_.vsub(a.position,_),p.vadd(r,p),p.vsub(o.position,p),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var _=new v,p=new v,O=new v;function Z(e,t,i){for(var r=null,n=e.length,s=0;s!==n;s++){var a=e[s],o=_;e[(s+1)%n].vsub(a,o);var c=p;o.cross(t,c);var l=O;i.vsub(a,l);var u=c.dot(l);if(!(null===r||0<u&&!0===r||u<=0&&!1===r))return!1;null===r&&(r=0<u)}return!0}var J=new v,ee=new v,te=new v,ie=new v,re=[new v,new v,new v,new v,new v,new v],ne=new v,se=new v,ae=new v,oe=new v;o.prototype[n.types.SPHERE|n.types.BOX]=o.prototype.sphereBox=function(e,t,i,r,n,s,a,o,c,l,u){var h=this.v3pool,_=re;i.vsub(r,J),t.getSideNormals(_,s);for(var p=e.radius,d=!1,f=se,m=ae,y=oe,v=null,g=0,b=0,x=0,T=null,C=0,S=_.length;C!==S&&!1===d;C++){var E=ee;E.copy(_[C]);var w=E.norm();E.normalize();var A=J.dot(E);if(A<w+p&&0<A){var $=te,O=ie;$.copy(_[(C+1)%3]),O.copy(_[(C+2)%3]);var D=$.norm(),k=O.norm();$.normalize(),O.normalize();var R=J.dot($),I=J.dot(O);if(R<D&&-D<R&&I<k&&-k<I){var F=Math.abs(A-w-p);if((null===T||F<T)&&(T=F,b=R,x=I,v=w,f.copy(E),m.copy($),y.copy(O),g++,u))return!0}}}if(g){d=!0;var P=this.createContactEquation(a,o,e,t,c,l);f.mult(-p,P.ri),P.ni.copy(f),P.ni.negate(P.ni),f.mult(v,f),m.mult(b,m),f.vadd(m,f),y.mult(x,y),f.vadd(y,P.rj),P.ri.vadd(i,P.ri),P.ri.vsub(a.position,P.ri),P.rj.vadd(r,P.rj),P.rj.vsub(o.position,P.rj),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult)}for(var M=h.get(),L=ne,z=0;2!==z&&!d;z++)for(var B=0;2!==B&&!d;B++)for(var N=0;2!==N&&!d;N++)if(M.set(0,0,0),z?M.vadd(_[0],M):M.vsub(_[0],M),B?M.vadd(_[1],M):M.vsub(_[1],M),N?M.vadd(_[2],M):M.vsub(_[2],M),r.vadd(M,L),L.vsub(i,L),L.norm2()<p*p){if(u)return!0;d=!0,(P=this.createContactEquation(a,o,e,t,c,l)).ri.copy(L),P.ri.normalize(),P.ni.copy(P.ri),P.ri.mult(p,P.ri),P.rj.copy(M),P.ri.vadd(i,P.ri),P.ri.vsub(a.position,P.ri),P.rj.vadd(r,P.rj),P.rj.vsub(o.position,P.rj),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult)}h.release(M),M=null;var G=h.get(),V=h.get(),U=(P=h.get(),h.get()),X=(F=h.get(),_.length);for(z=0;z!==X&&!d;z++)for(B=0;B!==X&&!d;B++)if(z%3!=B%3){_[B].cross(_[z],G),G.normalize(),_[z].vadd(_[B],V),P.copy(i),P.vsub(V,P),P.vsub(r,P);var W=P.dot(G);for(G.mult(W,U),N=0;N===z%3||N===B%3;)N++;F.copy(i),F.vsub(U,F),F.vsub(V,F),F.vsub(r,F);var H=Math.abs(W),q=F.norm();if(H<_[N].norm()&&q<p){if(u)return!0;d=!0;var j=this.createContactEquation(a,o,e,t,c,l);V.vadd(U,j.rj),j.rj.copy(j.rj),F.negate(j.ni),j.ni.normalize(),j.ri.copy(j.rj),j.ri.vadd(r,j.ri),j.ri.vsub(i,j.ri),j.ri.normalize(),j.ri.mult(p,j.ri),j.ri.vadd(i,j.ri),j.ri.vsub(a.position,j.ri),j.rj.vadd(r,j.rj),j.rj.vsub(o.position,j.rj),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}}h.release(G,V,P,U,F)};var ce=new v,le=new v,ue=new v,he=new v,_e=new v,pe=new v,de=new v,fe=new v,me=new v,ye=new v;o.prototype[n.types.SPHERE|n.types.CONVEXPOLYHEDRON]=o.prototype.sphereConvex=function(e,t,i,r,n,s,a,o,c,l,u){var h=this.v3pool;i.vsub(r,ce);for(var _=t.faceNormals,p=t.faces,d=t.vertices,f=e.radius,m=0;m!==d.length;m++){var y=d[m],v=_e;s.vmult(y,v),r.vadd(v,v);var g=he;if(v.vsub(i,g),g.norm2()<f*f)return!!u||(b=!0,(F=this.createContactEquation(a,o,e,t,c,l)).ri.copy(g),F.ri.normalize(),F.ni.copy(F.ri),F.ri.mult(f,F.ri),v.vsub(r,F.rj),F.ri.vadd(i,F.ri),F.ri.vsub(a.position,F.ri),F.rj.vadd(r,F.rj),F.rj.vsub(o.position,F.rj),this.result.push(F),void this.createFrictionEquationsFromContact(F,this.frictionResult))}for(var b=!1,x=(m=0,p.length);m!==x&&!1===b;m++){var T=_[m],C=p[m],S=pe;s.vmult(T,S);var E=de;s.vmult(d[C[0]],E),E.vadd(r,E);var w=fe;S.mult(-f,w),i.vadd(w,w);var A=me;w.vsub(E,A);var $=A.dot(S),O=ye;if(i.vsub(E,O),$<0&&0<O.dot(S)){for(var D=[],k=0,R=C.length;k!==R;k++){var I=h.get();s.vmult(d[C[k]],I),r.vadd(I,I),D.push(I)}if(Z(D,S,i)){if(u)return!0;b=!0;var F=this.createContactEquation(a,o,e,t,c,l);S.mult(-f,F.ri),S.negate(F.ni);var P=h.get();S.mult(-$,P);var M=h.get();S.mult(-f,M),i.vsub(r,F.rj),F.rj.vadd(M,F.rj),F.rj.vadd(P,F.rj),F.rj.vadd(r,F.rj),F.rj.vsub(o.position,F.rj),F.ri.vadd(i,F.ri),F.ri.vsub(a.position,F.ri),h.release(P),h.release(M),this.result.push(F),this.createFrictionEquationsFromContact(F,this.frictionResult),k=0;for(var L=D.length;k!==L;k++)h.release(D[k]);return}for(k=0;k!==C.length;k++){var z=h.get(),B=h.get();s.vmult(d[C[(k+1)%C.length]],z),s.vmult(d[C[(k+2)%C.length]],B),r.vadd(z,z),r.vadd(B,B);var N=le;B.vsub(z,N);var G=ue;N.unit(G);var V=h.get(),U=h.get();i.vsub(z,U);var X=U.dot(G);G.mult(X,V),V.vadd(z,V);var W=h.get();if(V.vsub(i,W),0<X&&X*X<N.norm2()&&W.norm2()<f*f){if(u)return!0;for(F=this.createContactEquation(a,o,e,t,c,l),V.vsub(r,F.rj),V.vsub(i,F.ni),F.ni.normalize(),F.ni.mult(f,F.ri),F.rj.vadd(r,F.rj),F.rj.vsub(o.position,F.rj),F.ri.vadd(i,F.ri),F.ri.vsub(a.position,F.ri),this.result.push(F),this.createFrictionEquationsFromContact(F,this.frictionResult),k=0,L=D.length;k!==L;k++)h.release(D[k]);return h.release(z),h.release(B),h.release(V),h.release(W),void h.release(U)}h.release(z),h.release(B),h.release(V),h.release(W),h.release(U)}for(k=0,L=D.length;k!==L;k++)h.release(D[k])}}},new v,new v,o.prototype[n.types.PLANE|n.types.BOX]=o.prototype.planeBox=function(e,t,i,r,n,s,a,o,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,i,r,n,s,a,o,e,t,u)};var D=new v,k=new v,R=new v,I=new v;o.prototype[n.types.PLANE|n.types.CONVEXPOLYHEDRON]=o.prototype.planeConvex=function(e,t,i,r,n,s,a,o,c,l,u){var h=D,_=k;_.set(0,0,1),n.vmult(_,_);for(var p=0,d=R,f=0;f!==t.vertices.length;f++)if(h.copy(t.vertices[f]),s.vmult(h,h),r.vadd(h,h),h.vsub(i,d),_.dot(d)<=0){if(u)return!0;var m=this.createContactEquation(a,o,e,t,c,l),y=I;_.mult(_.dot(d),y),h.vsub(y,y),y.vsub(i,m.ri),m.ni.copy(_),h.vsub(r,m.rj),m.ri.vadd(i,m.ri),m.ri.vsub(a.position,m.ri),m.rj.vadd(r,m.rj),m.rj.vsub(o.position,m.rj),this.result.push(m),p++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)};var F=new v,ve=new v;o.prototype[n.types.CONVEXPOLYHEDRON]=o.prototype.convexConvex=function(e,t,i,r,n,s,a,o,c,l,u,h,_){var p=F;if(!(i.distanceTo(r)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,n,r,s,p,h,_)){var d=[],f=ve;e.clipAgainstHull(i,n,t,r,s,p,-100,100,d);for(var m=0,y=0;y!==d.length;y++){if(u)return!0;var v=this.createContactEquation(a,o,e,t,c,l),g=v.ri,b=v.rj;p.negate(v.ni),d[y].normal.negate(f),f.mult(d[y].depth,f),d[y].point.vadd(f,g),b.copy(d[y].point),g.vsub(i,g),b.vsub(r,b),g.vadd(i,g),g.vsub(a.position,g),b.vadd(r,b),b.vsub(o.position,b),this.result.push(v),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}};var ge=new v,be=new v,xe=new v;o.prototype[n.types.PLANE|n.types.PARTICLE]=o.prototype.planeParticle=function(e,t,i,r,n,s,a,o,c,l,u){var h=ge;h.set(0,0,1),a.quaternion.vmult(h,h);var _=be;if(r.vsub(a.position,_),h.dot(_)<=0){if(u)return!0;var p=this.createContactEquation(o,a,t,e,c,l);p.ni.copy(h),p.ni.negate(p.ni),p.ri.set(0,0,0);var d=xe;h.mult(h.dot(r),d),r.vsub(d,d),p.rj.copy(d),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)}};var Te=new v;o.prototype[n.types.PARTICLE|n.types.SPHERE]=o.prototype.sphereParticle=function(e,t,i,r,n,s,a,o,c,l,u){var h=Te;if(h.set(0,0,1),r.vsub(i,h),h.norm2()<=e.radius*e.radius){if(u)return!0;var _=this.createContactEquation(o,a,t,e,c,l);h.normalize(),_.rj.copy(h),_.rj.mult(e.radius,_.rj),_.ni.copy(h),_.ni.negate(_.ni),_.ri.set(0,0,0),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult)}};var Ce=new s,Se=new v,Ee=(new v,new v),we=new v,Ae=new v;o.prototype[n.types.PARTICLE|n.types.CONVEXPOLYHEDRON]=o.prototype.convexParticle=function(e,t,i,r,n,s,a,o,c,l,u){var h=-1,_=Ee,p=Ae,d=null,f=Se;if(f.copy(r),f.vsub(i,f),n.conjugate(Ce),Ce.vmult(f,f),e.pointIsInside(f)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,n),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(n);for(var m=0,y=e.faces.length;m!==y;m++){var v=[e.worldVertices[e.faces[m][0]]],g=e.worldFaceNormals[m];r.vsub(v[0],we);var b=-g.dot(we);if(null===d||Math.abs(b)<Math.abs(d)){if(u)return!0;d=b,h=m,_.copy(g)}}if(-1!==h){var x=this.createContactEquation(o,a,t,e,c,l);_.mult(d,p),p.vadd(r,p),p.vsub(i,p),x.rj.copy(p),_.negate(x.ni),x.ri.set(0,0,0);var T=x.ri,C=x.rj;T.vadd(r,T),T.vsub(o.position,T),C.vadd(i,C),C.vsub(a.position,C),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},o.prototype[n.types.BOX|n.types.HEIGHTFIELD]=o.prototype.boxHeightfield=function(e,t,i,r,n,s,a,o,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,r,n,s,a,o,e,t,u)};var $e=new v,Oe=new v,De=[0];o.prototype[n.types.CONVEXPOLYHEDRON|n.types.HEIGHTFIELD]=o.prototype.convexHeightfield=function(e,t,i,r,n,s,a,o,c,l,u){var h=t.data,_=t.elementSize,p=e.boundingSphereRadius,d=Oe,f=De,m=$e;M.pointToLocalFrame(r,s,i,m);var y=Math.floor((m.x-p)/_)-1,v=Math.ceil((m.x+p)/_)+1,g=Math.floor((m.y-p)/_)-1,b=Math.ceil((m.y+p)/_)+1;if(!(v<0||b<0||y>h.length||g>h[0].length)){y<0&&(y=0),v<0&&(v=0),g<0&&(g=0),b<0&&(b=0),y>=h.length&&(y=h.length-1),v>=h.length&&(v=h.length-1),b>=h[0].length&&(b=h[0].length-1),g>=h[0].length&&(g=h[0].length-1);var x=[];t.getRectMinMax(y,g,v,b,x);var T=x[0],C=x[1];if(!(m.z-p>C||m.z+p<T))for(var S=y;S<v;S++)for(var E=g;E<b;E++){var w=!1;if(t.getConvexTrianglePillar(S,E,!1),M.pointToWorldFrame(r,s,t.pillarOffset,d),i.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(w=this.convexConvex(e,t.pillarConvex,i,d,n,s,a,o,null,null,u,f,null)),u&&w)return!0;if(t.getConvexTrianglePillar(S,E,!0),M.pointToWorldFrame(r,s,t.pillarOffset,d),i.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(w=this.convexConvex(e,t.pillarConvex,i,d,n,s,a,o,null,null,u,f,null)),u&&w)return!0}}};var ke=new v,Re=new v;o.prototype[n.types.SPHERE|n.types.HEIGHTFIELD]=o.prototype.sphereHeightfield=function(e,t,i,r,n,s,a,o,c,l,u){var h=t.data,_=e.radius,p=t.elementSize,d=Re,f=ke;M.pointToLocalFrame(r,s,i,f);var m=Math.floor((f.x-_)/p)-1,y=Math.ceil((f.x+_)/p)+1,v=Math.floor((f.y-_)/p)-1,g=Math.ceil((f.y+_)/p)+1;if(!(y<0||g<0||m>h.length||g>h[0].length)){m<0&&(m=0),y<0&&(y=0),v<0&&(v=0),g<0&&(g=0),m>=h.length&&(m=h.length-1),y>=h.length&&(y=h.length-1),g>=h[0].length&&(g=h[0].length-1),v>=h[0].length&&(v=h[0].length-1);var b=[];t.getRectMinMax(m,v,y,g,b);var x=b[0],T=b[1];if(!(f.z-_>T||f.z+_<x))for(var C=this.result,S=m;S<y;S++)for(var E=v;E<g;E++){var w=C.length,A=!1;if(t.getConvexTrianglePillar(S,E,!1),M.pointToWorldFrame(r,s,t.pillarOffset,d),i.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.sphereConvex(e,t.pillarConvex,i,d,n,s,a,o,e,t,u)),u&&A)return!0;if(t.getConvexTrianglePillar(S,E,!0),M.pointToWorldFrame(r,s,t.pillarOffset,d),i.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.sphereConvex(e,t.pillarConvex,i,d,n,s,a,o,e,t,u)),u&&A)return!0;if(2<C.length-w)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(b,x,e){(function(e){x.exports=p,b("../shapes/Shape");var t=b("../math/Vec3"),i=(b("../math/Quaternion"),b("../solver/GSSolver")),r=(b("../equations/ContactEquation"),b("../equations/FrictionEquation"),b("./Narrowphase")),n=b("../utils/EventTarget"),s=(b("../collision/ArrayCollisionMatrix"),b("../collision/ObjectCollisionMatrix")),a=b("../collision/OverlapKeeper"),o=b("../material/Material"),c=b("../material/ContactMaterial"),I=b("../objects/Body"),l=b("../utils/TupleDictionary"),u=b("../collision/RaycastResult"),h=(b("../collision/AABB"),b("../collision/Ray")),_=b("../collision/NaiveBroadphase");function p(e){e=e||{},n.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.contactsDic=new l,this.oldContactsDic=new l,this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new t,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new _,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new i,this.constraints=[],this.narrowphase=new r(this),this.collisionMatrix=new s,this.triggerMatrix=new s,this.shapeOverlapKeeper=new a,this.shapeOverlapKeeperExit=new a,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new l,this.defaultMaterial=new o("default"),this.defaultContactMaterial=new c(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.broadphase.setWorld(this)}e?(e.doProfiling=!1,e.DEBUG=!0):window&&(window.doProfiling=!1,window.DEBUG=!0),p.idToBodyMap={},p.idToShapeMap={},p.prototype=new n;var d=new h;p.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},p.prototype.numObjects=function(){return this.bodies.length},p.prototype.collisionMatrixTick=function(){},p.prototype.add=p.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof I&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,p.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))},p.prototype.addConstraint=function(e){this.constraints.push(e)},p.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},p.prototype.rayTest=function(e,t,i){i instanceof u?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)},p.prototype.raycastAll=function(e,t,i,r){return i.mode=h.ALL,i.from=e,i.to=t,i.callback=r,d.intersectWorld(this,i)},p.prototype.raycastAny=function(e,t,i,r){return i.mode=h.ANY,i.from=e,i.to=t,i.result=r,d.intersectWorld(this,i)},p.prototype.raycastClosest=function(e,t,i,r){return i.mode=h.CLOSEST,i.from=e,i.to=t,i.result=r,d.intersectWorld(this,i)},p.prototype.removeBody=p.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,r=i.indexOf(e);if(-1!==r){i.splice(r,1);for(var n=0;n!==i.length;n++)i[n].index=n;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete p.idToBodyMap[e.id],this.dispatchEvent(this.removeBodyEvent)}},p.prototype.getBodyById=function(e){return p.idToBodyMap[e]},p.prototype.getShapeById=function(e){return p.idToShapeMap[e]},p.prototype.addMaterial=function(e){this.materials.push(e)},p.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},p.prototype.step=function(e,t,i){if(i=i||10,t=t||0,m=this.contacts.slice(),0===t)this.internalStep(e),this.time+=e;else{this.accumulator+=t;for(var r=0;this.accumulator>=e&&r<i;)this.internalStep(e),this.accumulator-=e,r++;for(var n=this.accumulator%e/e,s=0;s!==this.bodies.length;s++){var a=this.bodies[s];a.previousPosition.lerp(a.position,n,a.interpolatedPosition),a.previousQuaternion.slerp(a.quaternion,n,a.interpolatedQuaternion),a.previousQuaternion.normalize()}this.time+=t}for(var o=this.contacts,c=this.contacts.length;c--;){var l=o[c],u=l.si,h=l.sj,_=this.contactsDic.get(u.id,h.id);null==_&&(_=this.contactsDic.set(u.id,h.id,[])),_.push(l)}};var f={type:"collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},m=[],F=[],P=[],M=[];p.prototype.internalStep=function(e){this.dt=e;var t=this.contacts,i=P,r=M,n=this.numObjects(),s=this.bodies,a=this.solver,o=this.gravity,c=(this.profile,I.DYNAMIC),l=this.constraints,u=F,h=o.x,_=o.y,p=o.z,d=0;for(d=0;d!==n;d++)if((w=s[d]).useGravity&&w.type===c){var f=w.force,m=w.mass;f.x+=m*h,f.y+=m*_,f.z+=m*p}d=0;for(var y=this.subsystems.length;d!==y;d++)this.subsystems[d].update();i.length=0,r.length=0,this.broadphase.collisionPairs(this,i,r);var v=l.length;for(d=0;d!==v;d++)if(!(T=l[d]).collideConnected)for(var g=i.length-1;0<=g;g-=1)(T.bodyA===i[g]&&T.bodyB===r[g]||T.bodyB===i[g]&&T.bodyA===r[g])&&(i.splice(g,1),r.splice(g,1));t.length=0;var b=this.frictionEquations.length;for(d=0;d!==b;d++)u.push(this.frictionEquations[d]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,r,this,t,null,this.frictionEquations,u),d=0;d<this.frictionEquations.length;d++)a.addEquation(this.frictionEquations[d]);var x=t.length;for(d=0;d!==x;d++)a.addEquation(t[d]);for(v=l.length,d=0;d!==v;d++){var T;(T=l[d]).update(),g=0;for(var C=T.equations.length;g!==C;g++){var S=T.equations[g];a.addEquation(S)}}a.solve(e,this),a.removeAllEquations();var E=Math.pow;for(n=this.numObjects(),d=0;d!==n;d++){var w;if((w=s[d]).type&c){var A=E(1-w.linearDamping,e),$=w.velocity;$.mult(A,$);var O=w.angularVelocity;if(O){var D=E(1-w.angularDamping,e);O.mult(D,O)}}}var k=this.stepnumber%(this.quatNormalizeSkip+1)==0,R=this.quatNormalizeFast;for(d=0;d!==n;d++)s[d].integrate(e,k,R);if(this.clearForces(),this.broadphase.dirty=!0,this.time+=e,this.stepnumber+=1,this.allowSleep)for(d=0;d!==n;d++)s[d].sleepTick(this.time)};var y=[],v=[],g={type:"triggered",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null};p.prototype.emitTriggeredEvents=function(){y.length=v.length=0,this.shapeOverlapKeeperExit.getDiff(y,v);for(var e=0,t=v.length;e<t;e+=2){g.event="onTriggerExit";var i=this.getShapeById(v[e]),r=this.getShapeById(v[e+1]);this.triggerMatrix.set(i,r,!1),g.selfShape=i,g.otherShape=r,g.selfBody=i.body,g.otherBody=r.body,i.dispatchEvent(g),g.selfShape=r,g.otherShape=i,g.selfBody=r.body,g.otherBody=i.body,r.dispatchEvent(g)}for(y.length=v.length=0,this.shapeOverlapKeeper.getDiff(y,v),e=0,t=y.length;e<t;e+=2){var n=y[e],s=y[e+1];i=this.getShapeById(n),r=this.getShapeById(s),this.triggerMatrix.get(i,r)?g.event="onTriggerStay":(this.triggerMatrix.set(i,r,!0),g.event="onTriggerEnter"),g.selfShape=i,g.otherShape=r,g.selfBody=i.body,g.otherBody=r.body,i.dispatchEvent(g),g.selfShape=r,g.otherShape=i,g.selfBody=r.body,g.otherBody=i.body,r.dispatchEvent(g)}this.shapeOverlapKeeper.reset(),this.shapeOverlapKeeperExit.tick()},p.prototype.emitCollisionEvents=function(){for(var e,t,i=this.contactsDic.getLength();i--;)if(e=this.contactsDic.getKeyByIndex(i),null!=(t=this.contactsDic.getDataByKey(e))){var r=t[0].bi,n=t[0].bj,s=t[0].si,a=t[0].sj;if(r.allowSleep&&r.type===I.DYNAMIC&&r.sleepState===I.SLEEPING&&n.sleepState===I.AWAKE&&n.type!==I.STATIC){var o=n.velocity.norm2()+n.angularVelocity.norm2();2*Math.pow(n.sleepSpeedLimit,2)<=o&&r.wakeUp()}if(n.allowSleep&&n.type===I.DYNAMIC&&n.sleepState===I.SLEEPING&&r.sleepState===I.AWAKE&&r.type!==I.STATIC){var c=r.velocity.norm2()+r.angularVelocity.norm2();2*Math.pow(r.sleepSpeedLimit,2)<=c&&n.wakeUp()}this.collisionMatrix.get(r,n)?f.event="onCollisionStay":(this.collisionMatrix.set(r,n,!0),f.event="onCollisionEnter"),f.contacts=t,f.body=a.body,f.selfShape=s,f.otherShape=a,s.body.dispatchEvent(f),f.body=s.body,f.selfShape=a,f.otherShape=s,a.body.dispatchEvent(f)}var l=m;for(i=l.length;i--;){var u=l[i];s=u.si,a=u.sj,null==this.oldContactsDic.get(s.id,a.id)&&this.oldContactsDic.set(s.id,a.id,u)}for(i=this.oldContactsDic.getLength();i--;)e=this.oldContactsDic.getKeyByIndex(i),null==this.contactsDic.getDataByKey(e)&&(r=(t=this.oldContactsDic.getDataByKey(e)).bi,n=t.bj,s=t.si,a=t.sj,this.collisionMatrix.get(r,n)&&(r.isSleeping()&&n.isSleeping()||(this.collisionMatrix.set(r,n,!1),f.event="onCollisionExit",f.body=a.body,f.selfShape=s,f.otherShape=a,f.contacts.length=0,f.contacts.push(t),s.body.dispatchEvent(f),f.body=s.body,f.selfShape=a,f.otherShape=s,a.body.dispatchEvent(f))));this.contactsDic.reset(),this.oldContactsDic.reset()},p.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var r=e[i];r.force.set(0,0,0),r.torque.set(0,0,0)}}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2)}),cannon_min_1=cannon_min.CANNON;function stringfyVec3(e){return Vec3.strictEquals(e,new Vec3)?"<origin>":"(x: ".concat(e.x,", y: ").concat(e.y,", z: ").concat(e.z,")")}function setWrap(e,t){e.__cc_wrapper__=t}function getWrap(e){return e.__cc_wrapper__}function maxComponent$1(e){return Math.max(e.x,Math.max(e.y,e.z))}!function(e){e[e.DYNAMIC=1]="DYNAMIC",e[e.STATIC=2]="STATIC",e[e.KINEMATIC=4]="KINEMATIC"}(ERigidBodyType=ERigidBodyType||{}),function(e){e[e.SCENE=0]="SCENE",e[e.PHYSIC=1]="PHYSIC"}(ETransformSource=ETransformSource||{});var CannonRigidBody=function(){function t(e){_classCallCheck(this,t),this._body=void 0,this._onCollidedListener=void 0,this._collisionCallbacks=[],this._shapes=[],this._userData=void 0,this._world=null,this._name=void 0,e=e||{},this._name=e.name||"",this._body=new cannon_min.Body({type:ERigidBodyType.DYNAMIC}),setWrap(this._body,this),this._body.sleepSpeedLimit=.1,this._body.sleepTimeLimit=1,this._onCollidedListener=this._onCollided.bind(this)}return _createClass(t,[{key:"impl",get:function(){return this._body}}]),_createClass(t,[{key:"getAllowSleep",value:function(){return this._body.allowSleep}},{key:"setAllowSleep",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.allowSleep=e}},{key:"getGroup",value:function(){return this._body.collisionFilterGroup}},{key:"setGroup",value:function(e){this._body.collisionFilterGroup=e}},{key:"addGroup",value:function(e){this._body.collisionFilterGroup|=e}},{key:"removeGroup",value:function(e){this._body.collisionFilterGroup&=~e}},{key:"getMask",value:function(){return this._body.collisionFilterMask}},{key:"setMask",value:function(e){this._body.collisionFilterMask=e}},{key:"addMask",value:function(e){this._body.collisionFilterMask|=e}},{key:"removeMask",value:function(e){this._body.collisionFilterMask&=~e}},{key:"wakeUp",value:function(){return this._body.wakeUp()}},{key:"sleep",value:function(){return this._body.sleep()}},{key:"name",value:function(){return this._name}},{key:"getType",value:function(){return this._body.type}},{key:"setType",value:function(e){this._body.type=e}},{key:"isAwake",value:function(){return this._body.isAwake()}},{key:"isSleepy",value:function(){return this._body.isSleepy()}},{key:"isSleeping",value:function(){return this._body.isSleeping()}},{key:"addShape",value:function(e,t){this._shapes.push(e),null!=t?this._body.addShape(e.impl,Vec3.copy(_tCannonV1,t)):this._body.addShape(e.impl),e.setBody(this._body,this._shapes.length-1)}},{key:"removeShape",value:function(e){var t=this._shapes.indexOf(e);0<=t&&(this._shapes.splice(t,1),this._body.removeShape(e.impl),e.setBody(null,-1))}},{key:"getMass",value:function(){return this._body.mass}},{key:"setMass",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.mass=e,this._body.updateMassProperties()}},{key:"getIsKinematic",value:function(){return this._body.type===cannon_min.Body.KINEMATIC}},{key:"setIsKinematic",value:function(e){this._body.type=e?cannon_min.Body.KINEMATIC:cannon_min.Body.DYNAMIC}},{key:"getLinearDamping",value:function(){return this._body.linearDamping}},{key:"setLinearDamping",value:function(e){this._body.linearDamping=e}},{key:"getAngularDamping",value:function(){return this._body.angularDamping}},{key:"setAngularDamping",value:function(e){this._body.angularDamping=e}},{key:"getUseGravity",value:function(){return this._body.useGravity}},{key:"setUseGravity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.useGravity=e}},{key:"getCollisionResponse",value:function(){return this._body.collisionResponse}},{key:"setCollisionResponse",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.collisionResponse=!e}},{key:"getLinearVelocity",value:function(e){return Vec3.copy(e,this._body.velocity),e}},{key:"setLinearVelocity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Vec3.copy(this._body.velocity,e)}},{key:"getAngularVelocity",value:function(e){return Vec3.copy(e,this._body.angularVelocity),e}},{key:"setAngularVelocity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Vec3.copy(this._body.angularVelocity,e)}},{key:"getLinearFactor",value:function(e){return Vec3.copy(e,this._body.linearFactor),e}},{key:"setLinearFactor",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Vec3.copy(this._body.linearFactor,e)}},{key:"getAngularFactor",value:function(e){return Vec3.copy(e,this._body.angularFactor),e}},{key:"setAngularFactor",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Vec3.copy(this._body.angularFactor,e)}},{key:"getFreezeRotation",value:function(){return this._body.fixedRotation}},{key:"setFreezeRotation",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.fixedRotation=e,this._body.updateMassProperties()}},{key:"applyForce",value:function(e,t){null==t&&(t=Vec3.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyForce(Vec3.copy(_tCannonV1,e),Vec3.copy(_tCannonV2,t))}},{key:"applyImpulse",value:function(e,t){null==t&&(t=Vec3.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyImpulse(Vec3.copy(_tCannonV1,e),Vec3.copy(_tCannonV2,t))}},{key:"applyLocalForce",value:function(e,t){null==t&&(t=Vec3.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyLocalForce(Vec3.copy(_tCannonV1,e),Vec3.copy(_tCannonV2,t))}},{key:"applyLocalImpulse",value:function(e,t){null==t&&(t=Vec3.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyLocalImpulse(Vec3.copy(_tCannonV1,e),Vec3.copy(_tCannonV2,t))}},{key:"applyTorque",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.torque.x+=e.x,this._body.torque.y+=e.y,this._body.torque.z+=e.z}},{key:"applyLocalTorque",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Vec3.copy(_tCannonV1,e),this._body.vectorToWorldFrame(_tCannonV1,_tCannonV1),this._body.torque.x+=_tCannonV1.x,this._body.torque.y+=_tCannonV1.y,this._body.torque.z+=_tCannonV1.z}},{key:"setWorld",value:function(e){this._world&&(this._body.removeEventListener("collide",this._onCollidedListener),this._body.world.remove(this._body),this._world=null);var t=e;t&&(t.impl.addBody(this._body),this._body.addEventListener("collide",this._onCollidedListener),null==this._body.material&&(this._body.material=t.impl.defaultMaterial)),this._world=t}},{key:"getPosition",value:function(e){Vec3.copy(e,this._body.position)}},{key:"setPosition",value:function(e){Vec3.copy(this._body.position,e)}},{key:"getRotation",value:function(e){Quat.copy(e,this._body.quaternion)}},{key:"setRotation",value:function(e){Quat.copy(this._body.quaternion,e)}},{key:"translateAndRotate",value:function(e,t){Mat4.getTranslation(this._body.position,e),Quat.copy(this._body.quaternion,t)}},{key:"scaleAllShapes",value:function(e){var t=this._shapes,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.setScale(e)}}},{key:"addCollisionCallback",value:function(e){this._collisionCallbacks.push(e)}},{key:"removeCollisionCllback",value:function(e){var t=this._collisionCallbacks.indexOf(e);0<=t&&this._collisionCallbacks.splice(t,1)}},{key:"getUserData",value:function(){return this._userData}},{key:"setUserData",value:function(e){this._userData=e}},{key:"_stringfyThis",value:function(){return"".concat(this._name.length?this._name:"<No-name>")}},{key:"_devStrinfy",value:function(){var e=this._body.shapes.map(function(e){return getWrap(e)._devStrinfy()}).join("; ");return"Name: [[".concat(this._name.length?this._name:"<No-name>","]], position: ").concat(stringfyVec3(this._body.position),", shapes: [").concat(e,"]")}},{key:"_onCollided",value:function(e){CollisionEventObject.type=e.event,CollisionEventObject.selfCollider=getWrap(e.selfShape).getUserData(),CollisionEventObject.otherCollider=getWrap(e.otherShape).getUserData();var t=0;for(t=CollisionEventObject.contacts.length;t--;)contactsPool.push(CollisionEventObject.contacts.pop());for(t=0;t<e.contacts.length;t++){var i=e.contacts[t];if(0<contactsPool.length){var r=contactsPool.pop();Vec3.copy(r.contactA,i.ri),Vec3.copy(r.contactB,i.rj),Vec3.copy(r.normal,i.ni),CollisionEventObject.contacts.push(r)}else{var n={contactA:Vec3.copy(new Vec3,i.ri),contactB:Vec3.copy(new Vec3,i.rj),normal:Vec3.copy(new Vec3,i.ni)};CollisionEventObject.contacts.push(n)}}for(t=0;t<this._collisionCallbacks.length;t++){(0,this._collisionCallbacks[t])(CollisionEventObject)}}}]),t}(),CollisionEventObject={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[]},contactsPool=[],_tCannonV1=new cannon_min.Vec3,_tCannonV2=new cannon_min.Vec3;function toCannonRaycastOptions(e,t){e.checkCollisionResponse=!t.queryTrigger,e.skipBackFaces=!1}function fillRaycastResult(e,t){e._assign(Vec3.copy(new Vec3,t.hitPointWorld),t.distance,getWrap(t.shape))}function commitShapeUpdates(e){e.updateMassProperties(),e.updateBoundingRadius(),e.aabbNeedsUpdate=!0}var CannonShape=function(){function t(){_classCallCheck(this,t),this._scale=new Vec3(1,1,1),this._shape=null,this._body=null,this._index=-1,this._center=new Vec3(0,0,0),this._userData=void 0,this._onTriggerListener=void 0,this._triggeredCB=[],this._onTriggerListener=this.onTrigger.bind(this)}return _createClass(t,[{key:"impl",get:function(){return this._shape}},{key:"material",set:function(e){null==e?this._shape.material=null:(null==t.idToMaterial[e._uuid]&&(t.idToMaterial[e._uuid]=new cannon_min.Material(e._uuid)),this._shape.material=t.idToMaterial[e._uuid],this._shape.material.friction=e.friction,this._shape.material.restitution=e.restitution)}}]),_createClass(t,[{key:"addTriggerCallback",value:function(e){this._triggeredCB.push(e)}},{key:"removeTriggerCallback",value:function(e){var t=this._triggeredCB.indexOf(e);0<=t&&this._triggeredCB.splice(t,1)}},{key:"getUserData",value:function(){return this._userData}},{key:"setUserData",value:function(e){this._userData=e}},{key:"setBody",value:function(e,t){null==e?this._shape.removeEventListener("triggered",this._onTriggerListener):this._shape.addEventListener("triggered",this._onTriggerListener),this._body=e,this._index=t}},{key:"setCenter",value:function(e){Vec3.copy(this._center,e),this._recalcCenter()}},{key:"setScale",value:function(e){Vec3.copy(this._scale,e),this._recalcCenter()}},{key:"setRotation",value:function(e){}},{key:"getCollisionResponse",value:function(){return this.impl.collisionResponse}},{key:"setCollisionResponse",value:function(e){this.impl.collisionResponse=e}},{key:"_devStrinfy",value:function(){return this._body?"centerOffset: ".concat(stringfyVec3(this._body.shapeOffsets[this._index])):"<NotAttached>"}},{key:"onTrigger",value:function(e){TriggerEventObject.type=e.event,TriggerEventObject.selfCollider=getWrap(e.selfShape).getUserData(),TriggerEventObject.otherCollider=getWrap(e.otherShape).getUserData();var t=this._triggeredCB,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n(TriggerEventObject)}}},{key:"_recalcCenter",value:function(){if(this._body){var e=this._body.shapeOffsets[this._index];Vec3.copy(e,this._center),Vec3.multiply(e,e,this._scale),commitShapeUpdates(this._body)}}}]),t}();CannonShape.idToMaterial={};var TriggerEventObject={type:"",selfCollider:null,otherCollider:null},CannonWorld=function(){function e(){_classCallCheck(this,e),this._world=void 0,this._customBeforeStepListener=[],this._customAfterStepListener=[],this._raycastResult=new cannon_min.RaycastResult,this._world=new cannon_min.World,setWrap(this._world,this),this._world.broadphase=new cannon_min.NaiveBroadphase}return _createClass(e,[{key:"impl",get:function(){return this._world}}]),_createClass(e,[{key:"getAllowSleep",value:function(){return this._world.allowSleep}},{key:"setAllowSleep",value:function(e){this._world.allowSleep=e}},{key:"setGravity",value:function(e){Vec3.copy(this._world.gravity,e)}},{key:"getGravity",value:function(e){Vec3.copy(e,this._world.gravity)}},{key:"destroy",value:function(){}},{key:"step",value:function(e,t,i){this._callCustomBeforeSteps(),this._world.step(e,t,i),this._callCustomAfterSteps(),this._world.emitTriggeredEvents(),this._world.emitCollisionEvents(),this._callCustomBeforeSteps()}},{key:"addBeforeStep",value:function(e){this._customBeforeStepListener.push(e)}},{key:"removeBeforeStep",value:function(e){var t=this._customBeforeStepListener.indexOf(e);t<0||this._customBeforeStepListener.splice(t,1)}},{key:"addAfterStep",value:function(e){this._customAfterStepListener.push(e)}},{key:"removeAfterStep",value:function(e){var t=this._customAfterStepListener.indexOf(e);t<0||this._customAfterStepListener.splice(t,1)}},{key:"raycastClosest",value:function(e,t,i){setupFromAndTo(e,t.maxDistance),toCannonRaycastOptions(raycastOpt,t);var r=this._world.raycastClosest(from,to,raycastOpt,this._raycastResult);return r&&fillRaycastResult(i,this._raycastResult),r}},{key:"raycast",value:function(e,t,i,r){return setupFromAndTo(e,t.maxDistance),toCannonRaycastOptions(raycastOpt,t),this._world.raycastAll(from,to,raycastOpt,function(e){var t=i.add();fillRaycastResult(t,e),r.push(t)})}},{key:"addConstraint",value:function(e){this._world.addConstraint(e.impl)}},{key:"removeConstraint",value:function(e){this._world.removeConstraint(e.impl)}},{key:"_callCustomBeforeSteps",value:function(){this._customBeforeStepListener.forEach(function(e){return e()})}},{key:"_callCustomAfterSteps",value:function(){this._customAfterStepListener.forEach(function(e){return e()})}},{key:"defaultMaterial",set:function(e){this._world.defaultMaterial.friction=e.friction,this._world.defaultMaterial.restitution=e.restitution,null!=CannonShape.idToMaterial[e._uuid]&&(CannonShape.idToMaterial[e._uuid]=this._world.defaultMaterial)}}]),e}(),from=new cannon_min.Vec3,to=new cannon_min.Vec3;function setupFromAndTo(e,t){Vec3.copy(from,e.o),e.computeHit(to,t)}var _dec$1y,_class$1A,_class2$1l,_descriptor$1h,_descriptor2$16,_class3$B,_temp$1s,raycastOpt={checkCollisionResponse:!1,collisionFilterGroup:-1,collisionFilterMask:-1,skipBackFaces:!1},CannonBoxShape=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this)))._box=void 0,t._halfExtent=new cannon_min.Vec3,Vec3.multiplyScalar(t._halfExtent,e,.5),t._box=new cannon_min.Box(t._halfExtent.clone()),setWrap(t._box,_assertThisInitialized(t)),t._shape=t._box,t._shape.addEventListener("trigger",t.onTrigger),t}return _inherits(i,CannonShape),_createClass(i,[{key:"setScale",value:function(e){_get(_getPrototypeOf(i.prototype),"setScale",this).call(this,e),this._recalcExtents()}},{key:"setSize",value:function(e){Vec3.multiplyScalar(this._halfExtent,e,.5),this._recalcExtents()}},{key:"_stringfyThis",value:function(){return"".concat(this._body?getWrap(this._body)._stringfyThis():"<No-body>","(Box)")}},{key:"_devStrinfy",value:function(){return"Box(".concat(_get(_getPrototypeOf(i.prototype),"_devStrinfy",this).call(this),", halfExtents: ").concat(stringfyVec3(this._box.halfExtents),")")}},{key:"_recalcExtents",value:function(){Vec3.multiply(this._box.halfExtents,this._halfExtent,this._scale),this._box.updateConvexPolyhedronRepresentation(),null!=this._body&&commitShapeUpdates(this._body)}}]),i}(),CannonSphereShape=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this)))._sphere=void 0,t._radius=0,t._radius=e,t._sphere=new cannon_min.Sphere(t._radius),setWrap(t._sphere,_assertThisInitialized(t)),t._shape=t._sphere,t}return _inherits(i,CannonShape),_createClass(i,[{key:"setScale",value:function(e){_get(_getPrototypeOf(i.prototype),"setScale",this).call(this,e),this._recalcRadius()}},{key:"setRadius",value:function(e){this._radius=e,this._recalcRadius()}},{key:"_devStrinfy",value:function(){return"Sphere(".concat(_get(_getPrototypeOf(i.prototype),"_devStrinfy",this).call(this),", radius: ").concat(this._sphere.radius,")")}},{key:"_recalcRadius",value:function(){this._sphere.radius=this._radius*maxComponent$1(this._scale),null!=this._body&&commitShapeUpdates(this._body)}}]),i}();instantiate$1(CannonBoxShape,CannonSphereShape,CannonRigidBody,CannonWorld);var PhysicMaterial=(_dec$1y=ccclass("cc.PhysicMaterial"))((_temp$1s=_class3$B=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"_friction",_descriptor$1h,_assertThisInitialized(e)),_initializerDefineProperty(e,"_restitution",_descriptor2$16,_assertThisInitialized(e)),t.allMaterials.push(_assertThisInitialized(e)),""==e._uuid&&(e._uuid="pm_"+t._idCounter++),e}return _inherits(t,Asset),_createClass(t,[{key:"friction",get:function(){return this._friction},set:function(e){equals(this._friction,e)||(this._friction=e,this.emit("physics_material_update"))}},{key:"restitution",get:function(){return this._restitution},set:function(e){equals(this._restitution,e)||(this._restitution=e,this.emit("physics_material_update"))}}]),_createClass(t,[{key:"clone",value:function(){var e=new t;return e._friction=this._friction,e._restitution=this._restitution,e}},{key:"destroy",value:function(){if(_get(_getPrototypeOf(t.prototype),"destroy",this).call(this)){var e=t.allMaterials.indexOf(this);return 0<=e&&t.allMaterials.splice(e,1),!0}return!1}}]),t}(),_class3$B.allMaterials=[],_class3$B._idCounter=0,_descriptor$1h=_applyDecoratedDescriptor((_class2$1l=_temp$1s).prototype,"_friction",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_descriptor2$16=_applyDecoratedDescriptor(_class2$1l.prototype,"_restitution",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),_applyDecoratedDescriptor(_class2$1l.prototype,"friction",[property],Object.getOwnPropertyDescriptor(_class2$1l.prototype,"friction"),_class2$1l.prototype),_applyDecoratedDescriptor(_class2$1l.prototype,"restitution",[property],Object.getOwnPropertyDescriptor(_class2$1l.prototype,"restitution"),_class2$1l.prototype),_class$1A=_class2$1l))||_class$1A,PhysicsRayResult=function(){function t(){_classCallCheck(this,t),this._hitPoint=new Vec3,this._distance=0,this._collidier=null}return _createClass(t,[{key:"_assign",value:function(e,t,i){Vec3.copy(this._hitPoint,e),this._distance=t,this._collidier=i.getUserData()}},{key:"clone",value:function(){var e=new t;return Vec3.copy(e._hitPoint,this._hitPoint),e._distance=this._distance,e._collidier=this._collidier,e}},{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collidier}}]),t}();function createPhysicsWorld(){return new PhysicsWorld}function createRigidBody(e){return new RigidBody(e)}function createBoxShape(e){return new BoxShape(e)}function createSphereShape(e){return new SphereShape(e)}function createRaycastResult(){return new PhysicsRayResult}cc.createRaycastResult=createRaycastResult;var PhysicsSystem=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._world=void 0,e._enable=!0,e._deltaTime=1/60,e._maxSubStep=2,e._allowSleep=!0,e._gravity=new Vec3(0,-10,0),e._material=null,e.raycastClosestResult=new PhysicsRayResult,e.raycastResults=[],e.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1/0},e.raycastResultPool=new RecyclePool(function(){return new PhysicsRayResult},1),e._world=createPhysicsWorld(),e.gravity=e._gravity,e.allowSleep=e._allowSleep,e._material=new PhysicMaterial,e._material.friction=.6,e._material.restitution=-1,e._material.on("physics_material_update",e._updateMaterial,_assertThisInitialized(e)),e._world.defaultMaterial=e._material,e}return _inherits(t,System),_createClass(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._world.setAllowSleep(this._allowSleep)}},{key:"maxSubStep",get:function(){return this._maxSubStep},set:function(e){this._maxSubStep=e}},{key:"deltaTime",get:function(){return this._deltaTime},set:function(e){this._deltaTime=e}},{key:"gravity",get:function(){return this._world.getGravity(this._gravity),this._gravity},set:function(e){this._gravity.x=e.x,this._gravity.y=e.y,this._gravity.z=e.z,this._world.setGravity(e)}},{key:"defaultMaterial",get:function(){return this._material}}]),_createClass(t,[{key:"postUpdate",value:function(e){this._enable&&(director.emit(Director.EVENT_BEFORE_PHYSICS),this._world.step(this._deltaTime,e,this._maxSubStep),director.emit(Director.EVENT_AFTER_PHYSICS))}},{key:"raycast",value:function(e,t,i,r){var n=1<arguments.length&&void 0!==t?t:Layers.Enum.DEFAULT,s=2<arguments.length&&void 0!==i?i:1/0,a=!(3<arguments.length&&void 0!==r)||r;return this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=n,this.raycastOptions.maxDistance=s,this.raycastOptions.queryTrigger=a,this._world.raycast(e,this.raycastOptions,this.raycastResultPool,this.raycastResults)}},{key:"raycastClosest",value:function(e,t,i,r){var n=1<arguments.length&&void 0!==t?t:Layers.Enum.DEFAULT,s=2<arguments.length&&void 0!==i?i:1/0,a=!(3<arguments.length&&void 0!==r)||r;return this.raycastOptions.mask=n,this.raycastOptions.maxDistance=s,this.raycastOptions.queryTrigger=a,this._world.raycastClosest(e,this.raycastOptions,this.raycastClosestResult)}},{key:"_updateMaterial",value:function(){this._world.defaultMaterial=this._material}}]),t}();PhysicsSystem.instance=void 0,PhysicsSystem.ID=void 0,cc.PhysicsSystem=PhysicsSystem,director.on(Director.EVENT_INIT,function(){var e=new cc.PhysicsSystem;cc.PhysicsSystem.instance=e,director.registerSystem(PhysicsSystem.ID,e,0)});var _dec$1z,_dec2$19,_dec3$U,_dec4$M,_dec5$H,_class$1B,_class2$1m,_descriptor$1i,_descriptor2$17,_descriptor3$S,_temp$1t,PhysicsBasedComponent=function(){function o(){var e;return _classCallCheck(this,o),(e=_possibleConstructorReturn(this,_getPrototypeOf(o).call(this)))._sharedBody=void 0,e._isPreLoaded=!1,e}return _inherits(o,Component),_createClass(o,[{key:"_body",get:function(){return this._sharedBody.body}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_assertPreload",get:function(){return this._isPreLoaded||error("Physic Error: Please make sure that the node has been added to the scene"),this._isPreLoaded}}]),_createClass(o,[{key:"setGroup",value:function(e){if(this._assertPreload)return this._body.setGroup(e)}},{key:"getGroup",value:function(){return this._assertPreload?this._body.getGroup():0}},{key:"addGroup",value:function(e){if(this._assertPreload)return this._body.addGroup(e)}},{key:"removeGroup",value:function(e){if(this._assertPreload)return this._body.removeGroup(e)}},{key:"getMask",value:function(){return this._assertPreload?this._body.getMask():0}},{key:"setMask",value:function(e){if(this._assertPreload)return this._body.setMask(e)}},{key:"addMask",value:function(e){if(this._assertPreload)return this._body.addMask(e)}},{key:"removeMask",value:function(e){if(this._assertPreload)return this._body.removeMask(e)}},{key:"__preload",value:function(){if(null==this._sharedBody){var e=null,t=this.node.getComponents(o),i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}var s=n;if(s._sharedBody){e=s._sharedBody;break}}if(!e){var a=this.getComponent(cc.RigidBodyComponent);e=new SharedRigidBody(this.node,a,PhysicsSystem.instance._world)}e.ref(),this._sharedBody=e}this._isPreLoaded=!0}},{key:"onEnable",value:function(){this.sharedBody.enable()}},{key:"onDisable",value:function(){this.sharedBody.disable()}},{key:"onDestroy",value:function(){this._sharedBody.deref(),this._sharedBody=null}},{key:"_findRigidbody",value:function(e){var t=e.getComponent(cc.RigidBodyComponent);return t||(e.parent?e.parent===e.scene?null:this._findRigidbody(e.parent):null)}}]),o}(),SharedRigidBody=function(){function r(e,t,i){_classCallCheck(this,r),this._body=void 0,this._refCount=0,this._actived=!1,this._world=void 0,this._rigidBody=void 0,this._node=void 0,this._worldScale=new Vec3(1,1,1),this._beforeStepCallback=void 0,this._afterStepCallback=void 0,this._isShapeOnly=!0,this._body=createRigidBody({name:e.name}),this._node=e,this._rigidBody=t,this._world=i,this._body.setUserData(this._rigidBody),this._beforeStepCallback=this._beforeStep.bind(this),this._afterStepCallback=this._afterStep.bind(this),this._rigidBody?this._isShapeOnly=!1:(this._isShapeOnly=!0,this._body.setUseGravity(!1))}return _createClass(r,[{key:"body",get:function(){return this._body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"isShapeOnly",get:function(){return this._isShapeOnly},set:function(e){this._isShapeOnly=e}}]),_createClass(r,[{key:"ref",value:function(){++this._refCount}},{key:"deref",value:function(){--this._refCount,this._refCount||this.destroy()}},{key:"enable",value:function(){this._activeBody()}},{key:"disable",value:function(){this._deactiveBody()}},{key:"destroy",value:function(){this._deactiveBody(),this._body.setUserData(null),this._body=null,this._beforeStepCallback=null,this._afterStepCallback=null,this._world=null,this._node=null,this._rigidBody&&(this._rigidBody=null)}},{key:"syncPhysWithScene",value:function(){this._syncPhysWithScene(this._node)}},{key:"_syncPhysWithScene",value:function(e){e.getWorldMatrix(r._tempMat4),e.getWorldRotation(r._tempQuat),this._body.translateAndRotate(r._tempMat4,r._tempQuat)}},{key:"_syncSceneWithPhys",value:function(){this._node&&(this._body.getPosition(r._tempVec3),this._node.setWorldPosition(r._tempVec3),this._body.getFreezeRotation()||(this._body.getRotation(r._tempQuat),this._node.setWorldRotation(r._tempQuat)))}},{key:"_activeBody",value:function(){this._syncPhysWithScene(this._node),this._actived||(this._actived=!0,this._body.setWorld(this._world),this._world.addBeforeStep(this._beforeStepCallback),this._world.addAfterStep(this._afterStepCallback),this._body.wakeUp())}},{key:"_deactiveBody",value:function(){this._actived&&(this._actived=!1,this._world.removeBeforeStep(this._beforeStepCallback),this._world.removeAfterStep(this._afterStepCallback),this._body.sleep(),this._body.setWorld(null))}},{key:"_beforeStep",value:function(){this._node.hasChangedFlags&&(this._node.hasChangedFlags&TransformDirtyBit.SCALE&&this._body.scaleAllShapes(this._node.worldScale),this._syncPhysWithScene(this._node),this._body.isSleeping()&&this._body.wakeUp())}},{key:"_afterStep",value:function(){this._body.getType()!==ERigidBodyType.STATIC?this._syncSceneWithPhys():this._node.hasChangedFlags&&(this._syncPhysWithScene(this._node),this._body.isSleeping()&&this._body.wakeUp())}}]),r}();SharedRigidBody._tempMat4=new Mat4,SharedRigidBody._tempQuat=new Quat,SharedRigidBody._tempVec3=new Vec3;var ColliderComponent=(_dec$1z=ccclass("cc.ColliderComponent"),_dec2$19=property({type:PhysicMaterial,displayName:"Material",displayOrder:-1}),_dec3$U=property({displayOrder:0}),_dec4$M=property({type:Vec3,displayOrder:1,tooltip:"The center of the collider, in local space"}),_dec5$H=property({type:PhysicMaterial}),_dec$1z((_applyDecoratedDescriptor((_class2$1m=_temp$1t=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._callbackTable=createMap(!0),e._shapeBase=void 0,e._isSharedMaterial=!0,e._trrigerCallback=void 0,e._collisionCallBack=void 0,_initializerDefineProperty(e,"_material",_descriptor$1i,_assertThisInitialized(e)),_initializerDefineProperty(e,"_isTrigger",_descriptor2$17,_assertThisInitialized(e)),_initializerDefineProperty(e,"_center",_descriptor3$S,_assertThisInitialized(e)),e._trrigerCallback=e._onTrigger.bind(_assertThisInitialized(e)),e._collisionCallBack=e._onCollision.bind(_assertThisInitialized(e)),e}return _inherits(t,PhysicsBasedComponent),_createClass(t,[{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._isSharedMaterial&&null!=this._material&&(this._material.off("physics_material_update",this._updateMaterial,this),this._material=this._material.clone(),this._material.on("physics_material_update",this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(e){null!=e&&null!=this._material?this._material._uuid!=e._uuid&&(this._material.off("physics_material_update",this._updateMaterial,this),e.on("physics_material_update",this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):null!=e&&null==this._material?(e.on("physics_material_update",this._updateMaterial,this),this._material=e):null==e&&null!=this._material&&(this._material.off("physics_material_update",this._updateMaterial,this),this._material=e),this._updateMaterial()}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){if(this._isTrigger=e,this.sharedBody){var t=this._isTrigger?ERigidBodyType.DYNAMIC:ERigidBodyType.STATIC;this.sharedBody.body.setType(t),this._shapeBase.setCollisionResponse(!this._isTrigger)}}},{key:"center",get:function(){return this._center},set:function(e){Vec3.copy(this._center,e);var t=this.sharedBody.rigidBody;null!=t?(Vec3.subtract(offset,this.node.worldPosition,t.node.worldPosition),Vec3.add(offset,offset,this._center),this._shapeBase.setCenter(offset)):this._shapeBase.setCenter(this._center)}},{key:"attachedRigidbody",get:function(){return this.sharedBody.rigidBody}}]),_createClass(t,[{key:"on",value:function(e,t,i,r){}},{key:"off",value:function(e,t,i,r){}},{key:"once",value:function(e,t,i,r){}},{key:"targetOff",value:function(e){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"onLoad",value:function(){this.isTrigger=this._isTrigger,this.sharedMaterial=null==this._material?PhysicsSystem.instance.defaultMaterial:this._material,this.center=this._center}},{key:"onEnable",value:function(){_get(_getPrototypeOf(t.prototype),"onEnable",this).call(this);var e=this.sharedBody.rigidBody;null!=e?(Vec3.subtract(offset,this.node.worldPosition,e.node.worldPosition),Vec3.add(offset,offset,this._center),this.sharedBody.body.addShape(this._shapeBase,offset)):this.sharedBody.body.addShape(this._shapeBase,this._center),this.center=this._center,this._shapeBase.addTriggerCallback(this._trrigerCallback),this.sharedBody.body.addCollisionCallback(this._collisionCallBack),this.sharedBody.syncPhysWithScene()}},{key:"onDisable",value:function(){this._shapeBase.removeTriggerCallback(this._trrigerCallback),this.sharedBody.body.removeCollisionCllback(this._collisionCallBack),this.sharedBody.body.removeShape(this._shapeBase),this.sharedBody.isShapeOnly&&_get(_getPrototypeOf(t.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){this.sharedBody.body.removeShape(this._shapeBase),null!=this._material&&this._material._uuid!=PhysicsSystem.instance.defaultMaterial._uuid&&(this._material.destroy(),this._material=null),_get(_getPrototypeOf(t.prototype),"onDestroy",this).call(this)}},{key:"_updateMaterial",value:function(){this._shapeBase.material=this._material}},{key:"_onTrigger",value:function(e){this.emit(e.type,e)}},{key:"_onCollision",value:function(e){this.emit(e.type,e)}}]),t}()).prototype,"sharedMaterial",[_dec2$19],Object.getOwnPropertyDescriptor(_class2$1m.prototype,"sharedMaterial"),_class2$1m.prototype),_applyDecoratedDescriptor(_class2$1m.prototype,"isTrigger",[_dec3$U],Object.getOwnPropertyDescriptor(_class2$1m.prototype,"isTrigger"),_class2$1m.prototype),_applyDecoratedDescriptor(_class2$1m.prototype,"center",[_dec4$M],Object.getOwnPropertyDescriptor(_class2$1m.prototype,"center"),_class2$1m.prototype),_descriptor$1i=_applyDecoratedDescriptor(_class2$1m.prototype,"_material",[_dec5$H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$17=_applyDecoratedDescriptor(_class2$1m.prototype,"_isTrigger",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor3$S=_applyDecoratedDescriptor(_class2$1m.prototype,"_center",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new cc.Vec3(0,0,0)}}),_class$1B=_class2$1m))||_class$1B);applyMixins(ColliderComponent,[CallbacksInvoker,EventTarget]);var _dec$1A,_dec2$1a,_dec3$V,_dec4$N,_class$1C,_class2$1n,_descriptor$1j,_temp$1u,_dec$1B,_dec2$1b,_dec3$W,_class$1D,_class2$1o,_descriptor$1k,_temp$1v,_dec$1C,_dec2$1c,_dec3$X,_dec4$O,_dec5$I,_dec6$C,_dec7$s,_dec8$i,_dec9$g,_dec10$e,_dec11$d,_class$1E,_class2$1p,_descriptor$1l,_descriptor2$18,_descriptor3$T,_descriptor4$N,_descriptor5$E,_descriptor6$s,_descriptor7$n,_descriptor8$k,_temp$1w,_dec$1D,_dec2$1d,_dec3$Y,_dec4$P,_dec5$J,_dec6$D,_dec7$t,_dec8$j,_class$1F,_class2$1q,_descriptor$1m,_descriptor2$19,_descriptor3$U,_descriptor4$O,_temp$1x,offset=new Vec3,BoxColliderComponent=(_dec$1A=ccclass("cc.BoxColliderComponent"),_dec2$1a=executionOrder(98),_dec3$V=menu("Components/BoxCollider"),_dec4$N=property({type:Vec3}),_dec$1A(_class$1C=_dec2$1a(_class$1C=_dec3$V(_class$1C=executeInEditMode((_descriptor$1j=_applyDecoratedDescriptor((_class2$1n=_temp$1u=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._shape=void 0,_initializerDefineProperty(e,"_size",_descriptor$1j,_assertThisInitialized(e)),e._shape=createBoxShape(e._size),e._shape.setUserData(_assertThisInitialized(e)),e._shapeBase=e._shape,e}return _inherits(t,ColliderComponent),_createClass(t,[{key:"onLoad",value:function(){_get(_getPrototypeOf(t.prototype),"onLoad",this).call(this),this.size=this._size,this._shape.setScale(this.node.worldScale)}},{key:"size",get:function(){return this._size},set:function(e){Vec3.copy(this._size,e),this._shape.setSize(this._size)}}]),t}()).prototype,"_size",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3(0,0,0)}}),_applyDecoratedDescriptor(_class2$1n.prototype,"size",[_dec4$N],Object.getOwnPropertyDescriptor(_class2$1n.prototype,"size"),_class2$1n.prototype),_class$1C=_class2$1n))||_class$1C)||_class$1C)||_class$1C)||_class$1C),SphereColliderComponent=(_dec$1B=ccclass("cc.SphereColliderComponent"))(_class$1D=(_dec2$1b=executionOrder(98))(_class$1D=(_dec3$W=menu("Components/SphereCollider"))(_class$1D=executeInEditMode((_descriptor$1k=_applyDecoratedDescriptor((_class2$1o=_temp$1v=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._shape=void 0,_initializerDefineProperty(e,"_radius",_descriptor$1k,_assertThisInitialized(e)),e._shape=createSphereShape(e._radius),e._shape.setUserData(_assertThisInitialized(e)),e._shapeBase=e._shape,e}return _inherits(t,ColliderComponent),_createClass(t,[{key:"onLoad",value:function(){_get(_getPrototypeOf(t.prototype),"onLoad",this).call(this),this.radius=this._radius,this._shape.setScale(this.node.worldScale)}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._shape.setRadius(this._radius)}}]),t}()).prototype,"_radius",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_applyDecoratedDescriptor(_class2$1o.prototype,"radius",[property],Object.getOwnPropertyDescriptor(_class2$1o.prototype,"radius"),_class2$1o.prototype),_class$1D=_class2$1o))||_class$1D)||_class$1D)||_class$1D)||_class$1D,NonRigidBodyProperties={mass:10,linearDamping:0,angularDamping:0},RigidBodyComponent=(_dec$1C=ccclass("cc.RigidBodyComponent"),_dec2$1c=executionOrder(99),_dec3$X=menu("Components/RigidBody"),_dec4$O=property({displayOrder:0}),_dec5$I=property({displayOrder:1}),_dec6$C=property({displayOrder:2}),_dec7$s=property({displayOrder:3}),_dec8$i=property({displayOrder:4}),_dec9$g=property({displayOrder:5}),_dec10$e=property({displayOrder:6}),_dec11$d=property({displayOrder:7}),_dec$1C(_class$1E=_dec2$1c(_class$1E=_dec3$X(_class$1E=executeInEditMode(_class$1E=disallowMultiple((_applyDecoratedDescriptor((_class2$1p=_temp$1w=function(){function t(){var e;return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._allowSleep=!0,_initializerDefineProperty(e,"_mass",_descriptor$1l,_assertThisInitialized(e)),_initializerDefineProperty(e,"_linearDamping",_descriptor2$18,_assertThisInitialized(e)),_initializerDefineProperty(e,"_angularDamping",_descriptor3$T,_assertThisInitialized(e)),_initializerDefineProperty(e,"_fixedRotation",_descriptor4$N,_assertThisInitialized(e)),_initializerDefineProperty(e,"_isKinematic",_descriptor5$E,_assertThisInitialized(e)),_initializerDefineProperty(e,"_useGravity",_descriptor6$s,_assertThisInitialized(e)),_initializerDefineProperty(e,"_linearFactor",_descriptor7$n,_assertThisInitialized(e)),_initializerDefineProperty(e,"_angularFactor",_descriptor8$k,_assertThisInitialized(e)),e}return _inherits(t,PhysicsBasedComponent),_createClass(t,[{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.sharedBody.body.setAllowSleep(e)}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass=e,this._body.setMass(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body.setAngularDamping(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._body.setIsKinematic(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body.setUseGravity(e)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(e){this._fixedRotation=e,this._body.setFreezeRotation(e)}},{key:"linearFactor",get:function(){return this._body.getLinearFactor(this._linearFactor)},set:function(e){Vec3.copy(this._linearFactor,e),this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._body.getAngularFactor(this._angularFactor)},set:function(e){Vec3.copy(this._angularFactor,e),this._body.setAngularFactor(this._angularFactor)}},{key:"isAwake",get:function(){return!!this._assertPreload&&this._body.isAwake()}},{key:"isSleepy",get:function(){return!!this._assertPreload&&this._body.isSleepy()}},{key:"isSleeping",get:function(){return!!this._assertPreload&&this._body.isSleeping()}}]),_createClass(t,[{key:"applyForce",value:function(e,t){this._assertPreload&&this._body.applyForce(e,t)}},{key:"applyLocalForce",value:function(e,t){this._assertPreload&&this._body.applyLocalForce(e,t)}},{key:"applyImpulse",value:function(e,t){this._assertPreload&&this._body.applyImpulse(e,t)}},{key:"applyLocalImpulse",value:function(e,t){this._assertPreload&&this._body.applyLocalImpulse(e,t)}},{key:"applyTorque",value:function(e){this._assertPreload&&this._body.applyTorque(e)}},{key:"applyLocalTorque",value:function(e){this._assertPreload&&this._body.applyLocalTorque(e)}},{key:"wakeUp",value:function(){this._assertPreload&&this._body.wakeUp()}},{key:"sleep",value:function(){this._assertPreload&&this._body.sleep()}},{key:"getLinearVelocity",value:function(e){this._assertPreload&&this._body.getLinearVelocity(e)}},{key:"setLinearVelocity",value:function(e){this._assertPreload&&this._body.setLinearVelocity(e)}},{key:"getAngularVelocity",value:function(e){this._assertPreload&&this._body.getAngularVelocity(e)}},{key:"setAngularVelocity",value:function(e){this._assertPreload&&this._body.setAngularVelocity(e)}},{key:"onEnable",value:function(){_get(_getPrototypeOf(t.prototype),"onEnable",this).call(this),this.sharedBody&&(this.allowSleep=this._allowSleep,this.mass=this._mass,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.useGravity=this._useGravity,this.isKinematic=this._isKinematic,this.fixedRotation=this._fixedRotation,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor,this.sharedBody.isShapeOnly=!1)}}]),t}()).prototype,"mass",[_dec4$O],Object.getOwnPropertyDescriptor(_class2$1p.prototype,"mass"),_class2$1p.prototype),_applyDecoratedDescriptor(_class2$1p.prototype,"linearDamping",[_dec5$I],Object.getOwnPropertyDescriptor(_class2$1p.prototype,"linearDamping"),_class2$1p.prototype),_applyDecoratedDescriptor(_class2$1p.prototype,"angularDamping",[_dec6$C],Object.getOwnPropertyDescriptor(_class2$1p.prototype,"angularDamping"),_class2$1p.prototype),_applyDecoratedDescriptor(_class2$1p.prototype,"isKinematic",[_dec7$s],Object.getOwnPropertyDescriptor(_class2$1p.prototype,"isKinematic"),_class2$1p.prototype),_applyDecoratedDescriptor(_class2$1p.prototype,"useGravity",[_dec8$i],Object.getOwnPropertyDescriptor(_class2$1p.prototype,"useGravity"),_class2$1p.prototype),_applyDecoratedDescriptor(_class2$1p.prototype,"fixedRotation",[_dec9$g],Object.getOwnPropertyDescriptor(_class2$1p.prototype,"fixedRotation"),_class2$1p.prototype),_applyDecoratedDescriptor(_class2$1p.prototype,"linearFactor",[_dec10$e],Object.getOwnPropertyDescriptor(_class2$1p.prototype,"linearFactor"),_class2$1p.prototype),_applyDecoratedDescriptor(_class2$1p.prototype,"angularFactor",[_dec11$d],Object.getOwnPropertyDescriptor(_class2$1p.prototype,"angularFactor"),_class2$1p.prototype),_descriptor$1l=_applyDecoratedDescriptor(_class2$1p.prototype,"_mass",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NonRigidBodyProperties.mass}}),_descriptor2$18=_applyDecoratedDescriptor(_class2$1p.prototype,"_linearDamping",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NonRigidBodyProperties.linearDamping}}),_descriptor3$T=_applyDecoratedDescriptor(_class2$1p.prototype,"_angularDamping",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NonRigidBodyProperties.angularDamping}}),_descriptor4$N=_applyDecoratedDescriptor(_class2$1p.prototype,"_fixedRotation",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor5$E=_applyDecoratedDescriptor(_class2$1p.prototype,"_isKinematic",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor6$s=_applyDecoratedDescriptor(_class2$1p.prototype,"_useGravity",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor7$n=_applyDecoratedDescriptor(_class2$1p.prototype,"_linearFactor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3(1,1,1)}}),_descriptor8$k=_applyDecoratedDescriptor(_class2$1p.prototype,"_angularFactor",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3(1,1,1)}}),_class$1E=_class2$1p))||_class$1E)||_class$1E)||_class$1E)||_class$1E)||_class$1E),ConstantForce=(_dec$1D=ccclass("cc.ConstantForce"),_dec2$1d=executionOrder(98),_dec3$Y=requireComponent(RigidBodyComponent),_dec4$P=menu("Components/ConstantForce"),_dec5$J=property({displayOrder:0}),_dec6$D=property({displayOrder:1}),_dec7$t=property({displayOrder:2}),_dec8$j=property({displayOrder:3}),_dec$1D(_class$1F=_dec2$1d(_class$1F=_dec3$Y(_class$1F=_dec4$P(_class$1F=disallowMultiple(_class$1F=executeInEditMode((_descriptor$1m=_applyDecoratedDescriptor((_class2$1q=_temp$1x=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._rigidbody=null,_initializerDefineProperty(t,"_force",_descriptor$1m,_assertThisInitialized(t)),_initializerDefineProperty(t,"_localForce",_descriptor2$19,_assertThisInitialized(t)),_initializerDefineProperty(t,"_torque",_descriptor3$U,_assertThisInitialized(t)),_initializerDefineProperty(t,"_localTorque",_descriptor4$O,_assertThisInitialized(t)),t._mask=0,t}return _inherits(s,Component),_createClass(s,[{key:"onLoad",value:function(){this._rigidbody=this.node.getComponent(RigidBodyComponent),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)}},{key:"lateUpdate",value:function(e){null!=this._rigidbody&&0!=this._mask&&(1&this._mask&&this._rigidbody.applyForce(this._force),2&this._mask&&this._rigidbody.applyLocalForce(this.localForce),4&this._mask&&this._rigidbody.applyTorque(this._torque),8&this._mask&&this._rigidbody.applyLocalTorque(this._localTorque))}},{key:"_maskUpdate",value:function(e,t){e.strictEquals(Vec3.ZERO)?this._mask&=~t:this._mask|=t}},{key:"force",get:function(){return this._force},set:function(e){Vec3.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){Vec3.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){Vec3.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){Vec3.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),s}()).prototype,"_force",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3}}),_descriptor2$19=_applyDecoratedDescriptor(_class2$1q.prototype,"_localForce",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3}}),_descriptor3$U=_applyDecoratedDescriptor(_class2$1q.prototype,"_torque",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3}}),_descriptor4$O=_applyDecoratedDescriptor(_class2$1q.prototype,"_localTorque",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vec3}}),_applyDecoratedDescriptor(_class2$1q.prototype,"force",[_dec5$J],Object.getOwnPropertyDescriptor(_class2$1q.prototype,"force"),_class2$1q.prototype),_applyDecoratedDescriptor(_class2$1q.prototype,"localForce",[_dec6$D],Object.getOwnPropertyDescriptor(_class2$1q.prototype,"localForce"),_class2$1q.prototype),_applyDecoratedDescriptor(_class2$1q.prototype,"torque",[_dec7$t],Object.getOwnPropertyDescriptor(_class2$1q.prototype,"torque"),_class2$1q.prototype),_applyDecoratedDescriptor(_class2$1q.prototype,"localTorque",[_dec8$j],Object.getOwnPropertyDescriptor(_class2$1q.prototype,"localTorque"),_class2$1q.prototype),_class$1F=_class2$1q))||_class$1F)||_class$1F)||_class$1F)||_class$1F)||_class$1F)||_class$1F);cc.ConstantForce=ConstantForce,exports.replaceProperty(PhysicsSystem,"PhysicsSystem",[{name:"ins",newName:"instance"}]),cc.ColliderComponent=ColliderComponent,cc.BoxColliderComponent=BoxColliderComponent,cc.SphereColliderComponent=SphereColliderComponent,cc.RigidBodyComponent=RigidBodyComponent,cc.PhysicMaterial=PhysicMaterial,cc.PhysicsRayResult=PhysicsRayResult;var _dec$1E,_dec2$1e,_class$1G,_class2$1r,_descriptor$1n,_descriptor2$1a,_class3$C,_temp$1y,PlayingState={INITIALIZING:0,PLAYING:1,STOPPED:2},AudioPlayer=function(){function i(e){var t=this;_classCallCheck(this,i),this._state=PlayingState.STOPPED,this._duration=0,this._eventTarget=void 0,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._blocking=!1,this._duration=e.duration,this._eventTarget=e.eventTarget,this._onHide=function(){t._blocking=!0,t._state===PlayingState.PLAYING&&(t.pause(),t._interrupted=!0)},this._onShow=function(){t._blocking=!1,t._interrupted&&(t.play(),t._interrupted=!1)},cc.game.on(cc.Game.EVENT_HIDE,this._onHide),cc.game.on(cc.Game.EVENT_SHOW,this._onShow)}return _createClass(i,[{key:"getState",value:function(){return this._state}},{key:"getDuration",value:function(){return this._duration}},{key:"destroy",value:function(){cc.game.off(cc.Game.EVENT_HIDE,this._onHide),cc.game.off(cc.Game.EVENT_SHOW,this._onShow)}}]),i}(),AudioPlayerDOM=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._volume=1,t._loop=!1,t._oneShoting=!1,t._audio=void 0,t._cbRegistered=!1,t._remove_cb=void 0,t._post_play=void 0,t._on_gesture=void 0,t._post_gesture=void 0,t._audio=e.clip,t._remove_cb=function(){t._cbRegistered&&(cc.game.canvas.removeEventListener("touchend",t._on_gesture),cc.game.canvas.removeEventListener("mouseup",t._on_gesture),t._cbRegistered=!1)},t._post_play=function(){t._state=PlayingState.PLAYING,t._eventTarget.emit("started"),t._remove_cb()},t._post_gesture=function(){t._interrupted?(t._post_play(),t._interrupted=!1):(t._audio.pause(),t._audio.currentTime=0)},t._on_gesture=function(){if(t._audio){var e=t._audio.play();if(!e)return t._state=PlayingState.PLAYING,void cc.director.once(cc.Director.EVENT_AFTER_UPDATE,t._post_gesture);e.then(t._post_gesture),t._remove_cb()}},t._audio.volume=t._volume,t._audio.loop=t._loop,t._audio.addEventListener("ended",function(){t._oneShoting||(t._state=PlayingState.STOPPED,t._audio.currentTime=0,t._eventTarget.emit("ended"))}),cc.game.canvas.addEventListener("touchend",t._on_gesture),cc.game.canvas.addEventListener("mouseup",t._on_gesture),t._cbRegistered=!0,t}return _inherits(i,AudioPlayer),_createClass(i,[{key:"play",value:function(){var e=this;if(this._audio&&this._state!==PlayingState.PLAYING)if(this._blocking)this._interrupted=!0;else{var t=this._audio.play();if(!t)return this._state=PlayingState.PLAYING,void cc.director.once(cc.Director.EVENT_AFTER_UPDATE,this._post_play);t.then(this._post_play).catch(function(){e._interrupted=!0})}}},{key:"pause",value:function(){this._audio&&this._state===PlayingState.PLAYING&&(this._audio.pause(),this._state=PlayingState.STOPPED,this._oneShoting=!1)}},{key:"stop",value:function(){this._audio&&(this._audio.currentTime=0,this._state===PlayingState.PLAYING&&(this._audio.pause(),this._state=PlayingState.STOPPED,this._oneShoting=!1))}},{key:"playOneShot",value:function(e){var t=this,i=0<arguments.length&&void 0!==e?e:1,r=this._audio;r&&(r.currentTime=0,r.volume=i,this._oneShoting||(r.loop=!1,this._oneShoting=!0,r.play().then(function(){r.addEventListener("ended",function(){r.currentTime=0,r.volume=t._volume,r.loop=t._loop,t._oneShoting=!1},{once:!0})}).catch(function(){t._oneShoting=!1})))}},{key:"setCurrentTime",value:function(e){this._audio&&(this._audio.currentTime=clamp(e,0,this._duration))}},{key:"getCurrentTime",value:function(){return this._audio?this._audio.currentTime:0}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}},{key:"getVolume",value:function(){return this._audio?this._audio.volume:this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"getLoop",value:function(){return this._loop}},{key:"destroy",value:function(){this._audio&&(this._audio.src=""),_get(_getPrototypeOf(i.prototype),"destroy",this).call(this)}}]),i}(),audioSupport=sys.__audioSupport,AudioPlayerWeb=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._startTime=0,t._offset=0,t._volume=1,t._loop=!1,t._currentTimer=0,t._audio=void 0,t._context=void 0,t._sourceNode=void 0,t._gainNode=void 0,t._on_ended=void 0,t._do_play=void 0,t._on_gesture=void 0,t._audio=e.clip,t._context=audioSupport.context,t._sourceNode=t._context.createBufferSource(),t._gainNode=t._context.createGain(),t._gainNode.connect(t._context.destination),t._on_ended=function(){t._offset=0,t._startTime=t._context.currentTime,t._sourceNode.loop||(t._eventTarget.emit("ended"),t._state=PlayingState.STOPPED)},t._do_play=function(){t._sourceNode=t._context.createBufferSource(),t._sourceNode.buffer=t._audio,t._sourceNode.loop=t._loop,t._sourceNode.connect(t._gainNode),t._startTime=t._context.currentTime,cc.director.once(cc.Director.EVENT_AFTER_UPDATE,function(){t._sourceNode.start(0,t._offset),t._eventTarget.emit("started"),t._state=PlayingState.PLAYING}),clearInterval(t._currentTimer),t._currentTimer=window.setInterval(function(){t._on_ended(),clearInterval(t._currentTimer),t._sourceNode.loop&&(t._currentTimer=window.setInterval(t._on_ended,1e3*t._audio.duration))},1e3*(t._audio.duration-t._offset))},t._on_gesture=function(){t._context.resume().then(function(){t._interrupted&&(t._do_play(),t._interrupted=!1),cc.game.canvas.removeEventListener("touchend",t._on_gesture),cc.game.canvas.removeEventListener("mouseup",t._on_gesture)})},"running"!==t._context.state&&t._context.resume&&(cc.game.canvas.addEventListener("touchend",t._on_gesture),cc.game.canvas.addEventListener("mouseup",t._on_gesture)),t}return _inherits(i,AudioPlayer),_createClass(i,[{key:"play",value:function(){this._audio&&this._state!==PlayingState.PLAYING&&(this._blocking||"running"!==this._context.state?this._interrupted=!0:this._do_play())}},{key:"pause",value:function(){this._state===PlayingState.PLAYING&&(this._sourceNode.stop(),this._offset+=this._context.currentTime-this._startTime,this._state=PlayingState.STOPPED,clearInterval(this._currentTimer))}},{key:"stop",value:function(){this._offset=0,this._state===PlayingState.PLAYING&&(this._sourceNode.stop(),this._state=PlayingState.STOPPED,clearInterval(this._currentTimer))}},{key:"playOneShot",value:function(e){var t=0<arguments.length&&void 0!==e?e:1;if(this._audio){var i=this._context.createGain();i.connect(this._context.destination),i.gain.value=t;var r=this._context.createBufferSource();r.buffer=this._audio,r.loop=!1,r.connect(i),r.start()}}},{key:"setCurrentTime",value:function(e){this._offset=clamp(e,0,this._audio&&this._audio.duration||this._duration),this._state===PlayingState.PLAYING&&(this._sourceNode.stop(),this._do_play())}},{key:"getCurrentTime",value:function(){return this._state!==PlayingState.PLAYING?this._offset:this._context.currentTime-this._startTime+this._offset}},{key:"setVolume",value:function(e,t){this._volume=e,!t&&this._gainNode.gain.setTargetAtTime?this._gainNode.gain.setTargetAtTime(e,this._context.currentTime,.01):this._gainNode.gain.value=e}},{key:"getVolume",value:function(){return this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._sourceNode.loop=e}},{key:"getLoop",value:function(){return this._loop}},{key:"destroy",value:function(){_get(_getPrototypeOf(i.prototype),"destroy",this).call(this)}}]),i}(),AudioPlayerWX=function(){function i(e){var t;return _classCallCheck(this,i),(t=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this,e)))._startTime=0,t._offset=0,t._volume=1,t._loop=!1,t._oneShoting=!1,t._audio=void 0,t._audio=e.clip,t._audio.play(),t._audio.stop(),t._audio.onPlay(function(){t._state!==PlayingState.PLAYING&&(t._state=PlayingState.PLAYING,t._startTime=performance.now(),t._eventTarget.emit("started"))}),t._audio.onPause(function(){t._state!==PlayingState.STOPPED&&(t._state=PlayingState.STOPPED,t._offset+=performance.now()-t._startTime)}),t._audio.onStop(function(){t._state!==PlayingState.STOPPED&&(t._state=PlayingState.STOPPED,t._offset=0,t._oneShoting&&(t._audio.volume=t._volume,t._audio.loop=t._loop,t._oneShoting=!1))}),t._audio.onEnded(function(){t._state!==PlayingState.STOPPED&&(t._state=PlayingState.STOPPED,t._offset=0,t._eventTarget.emit("ended"),t._oneShoting&&(t._audio.volume=t._volume,t._audio.loop=t._loop,t._oneShoting=!1))}),t._audio.onError(function(e){return console.error(e.errMsg)}),t}return _inherits(i,AudioPlayer),_createClass(i,[{key:"play",value:function(){this._audio&&this._state!==PlayingState.PLAYING&&(this._blocking?this._interrupted=!0:this._audio.play())}},{key:"pause",value:function(){this._audio&&this._state===PlayingState.PLAYING&&this._audio.pause()}},{key:"stop",value:function(){this._audio&&this._audio.stop()}},{key:"playOneShot",value:function(e){var t=0<arguments.length&&void 0!==e?e:1;this._audio&&(this._offset=0,this._oneShoting=!0,this._audio.stop(),this._audio.loop=!1,this._audio.volume=t,this._audio.play())}},{key:"getCurrentTime",value:function(){if(this._state!==PlayingState.PLAYING)return this._offset/1e3;var e=(performance.now()-this._startTime+this._offset)/1e3;return e>this._duration&&(e-=this._duration,this._startTime+=1e3*this._duration),e}},{key:"setCurrentTime",value:function(e){this._audio&&(this._offset=1e3*clamp(e,0,this._duration),this._startTime=performance.now(),this._audio.seek(e))}},{key:"getVolume",value:function(){return this._volume}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}},{key:"getLoop",value:function(){return this._loop}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"destroy",value:function(){this._audio&&this._audio.destroy(),wx.offAudioInterruptionBegin(this._onHide),wx.offAudioInterruptionEnd(this._onShow),_get(_getPrototypeOf(i.prototype),"destroy",this).call(this)}}]),i}(),AudioType=Enum({WEB_AUDIO:0,DOM_AUDIO:1,WX_GAME_AUDIO:2,UNKNOWN_AUDIO:3}),AudioClip=(_dec$1E=ccclass("cc.AudioClip"),_dec2$1e=property({type:AudioType}),_dec$1E((_temp$1y=_class3$C=function(){function t(){var e;return _classCallCheck(this,t),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),"_duration",_descriptor$1n,_assertThisInitialized(e)),_initializerDefineProperty(e,"_loadMode",_descriptor2$1a,_assertThisInitialized(e)),e._audio=null,e._player=null,e.loaded=!1,e}return _inherits(t,Asset),_createClass(t,[{key:"destroy",value:function(){return this._player&&this._player.destroy(),_get(_getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"play",value:function(){this._player&&this._player.play()}},{key:"pause",value:function(){this._player&&this._player.pause()}},{key:"stop",value:function(){this._player&&this._player.stop()}},{key:"playOneShot",value:function(e){this._player&&this._player.playOneShot(e)}},{key:"setCurrentTime",value:function(e){this._player&&this._player.setCurrentTime(e)}},{key:"getCurrentTime",value:function(){return this._player?this._player.getCurrentTime():0}},{key:"getDuration",value:function(){return this._player?this._player.getDuration():this._duration}},{key:"setVolume",value:function(e,t){this._player&&this._player.setVolume(e,t||!1)}},{key:"getVolume",value:function(){return this._player?this._player.getVolume():1}},{key:"setLoop",value:function(e){this._player&&this._player.setLoop(e)}},{key:"getLoop",value:function(){return!!this._player&&this._player.getLoop()}},{key:"_nativeAsset",set:function(e){var t;(this._audio=e)?(t=AudioPlayerWX,this._loadMode=AudioType.WX_GAME_AUDIO,this._player=new t({clip:e,duration:this._duration,eventTarget:this}),this.loaded=!0,this.emit("load")):(this._player=null,this._loadMode=AudioType.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1)},get:function(){return this._audio}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():PlayingState.INITIALIZING}}]),t}(),_class3$C.PlayingState=PlayingState,_class3$C.AudioType=AudioType,_class3$C.preventDeferredLoadDependents=!0,_descriptor$1n=_applyDecoratedDescriptor((_class2$1r=_temp$1y).prototype,"_duration",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor2$1a=_applyDecoratedDescriptor(_class2$1r.prototype,"_loadMode",[_dec2$1e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AudioType.UNKNOWN_AUDIO}}),_class$1G=_class2$1r))||_class$1G);cc.AudioClip=AudioClip;var _dec$1F,_dec2$1f,_dec3$Z,_dec4$Q,_class$1H,_class2$1s,_descriptor$1o,_descriptor2$1b,_descriptor3$V,_descriptor4$P,_temp$1z,__audioSupport$1=sys.__audioSupport,formatSupport$1=__audioSupport$1.format;function loadWXAudio(e,t){var i=wx.createInnerAudioContext();i.src=e.url,i.onCanplay(function(){return t(null,i)})}function loadDomAudio(t,i){var e=document.createElement("audio");e.src=t.url;function r(){clearTimeout(n),e.removeEventListener("canplaythrough",s,!1),e.removeEventListener("error",a,!1),__audioSupport$1.USE_LOADER_EVENT&&e.removeEventListener(__audioSupport$1.USE_LOADER_EVENT,s,!1)}var n=setTimeout(function(){0===e.readyState?a():s()},8e3),s=function(){r(),i(null,e)},a=function(){r();var e="load audio failure - "+t.url;log(e),i(e)};e.addEventListener("canplaythrough",s,!1),e.addEventListener("error",a,!1),__audioSupport$1.USE_LOADER_EVENT&&e.addEventListener(__audioSupport$1.USE_LOADER_EVENT,s,!1)}function loadWebAudio(e,t){var i=__audioSupport$1.context;i||t(new Error(getError(4926)));var r=loader.getXMLHttpRequest();r.open("GET",e.url,!0),r.responseType="arraybuffer",r.onload=function(){i.decodeAudioData(r.response,function(e){t(null,e)},function(){t("decode error - "+e.id,null)})},r.onerror=function(){t("request error - "+e.id,null)},r.send()}function downloadAudio(e,t){if(0===formatSupport$1.length)return new Error(getError(4927));loadWXAudio(e,t)}loader.downloader.addHandlers({mp3:downloadAudio,ogg:downloadAudio,wav:downloadAudio,m4a:downloadAudio});var AudioSourceComponent=(_dec$1F=ccclass("cc.AudioSourceComponent"),_dec2$1f=menu("Components/AudioSource"),_dec3$Z=property(AudioClip),_dec4$Q=property({type:AudioClip}),_dec$1F(_class$1H=_dec2$1f((_descriptor$1o=_applyDecoratedDescriptor((_class2$1s=_temp$1z=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return _initializerDefineProperty(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))),"_clip",_descriptor$1o,_assertThisInitialized(t)),_initializerDefineProperty(t,"_loop",_descriptor2$1b,_assertThisInitialized(t)),_initializerDefineProperty(t,"_playOnAwake",_descriptor3$V,_assertThisInitialized(t)),_initializerDefineProperty(t,"_volume",_descriptor4$P,_assertThisInitialized(t)),t._cachedCurrentTime=0,t}return _inherits(s,Component),_createClass(s,[{key:"onLoad",value:function(){this._syncStates(),this._playOnAwake&&this.play()}},{key:"onDisable",value:function(){this.pause()}},{key:"onDestroy",value:function(){this.stop()}},{key:"play",value:function(){this._clip&&(this.playing?this.currentTime=0:this._clip.play())}},{key:"pause",value:function(){this._clip&&this._clip.pause()}},{key:"stop",value:function(){this._clip&&this._clip.stop()}},{key:"playOneShot",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:1;e.playOneShot(this._volume*i)}},{key:"_syncStates",value:function(){this._clip&&(this._clip.setCurrentTime(this._cachedCurrentTime),this._clip.setLoop(this._loop),this._clip.setVolume(this._volume,!0),this._volume=this._clip.getVolume())}},{key:"clip",set:function(e){this._clip=e,this._syncStates()},get:function(){return this._clip}},{key:"loop",set:function(e){this._loop=e,this._clip&&this._clip.setLoop(e)},get:function(){return this._loop}},{key:"playOnAwake",set:function(e){this._playOnAwake=e},get:function(){return this._playOnAwake}},{key:"volume",set:function(e){isNaN(e)?console.warn("illegal audio volume!"):(e=clamp(e,0,1),this._clip?(this._clip.setVolume(e),this._volume=this._clip.getVolume()):this._volume=e)},get:function(){return this._volume}},{key:"currentTime",set:function(e){isNaN(e)?console.warn("illegal audio time!"):(e=clamp(e,0,this.duration),this._cachedCurrentTime=e,this._clip&&this._clip.setCurrentTime(this._cachedCurrentTime))},get:function(){return this._clip?this._clip.getCurrentTime():this._cachedCurrentTime}},{key:"duration",get:function(){return this._clip?this._clip.getDuration():0}},{key:"state",get:function(){return this._clip?this._clip.state:AudioClip.PlayingState.INITIALIZING}},{key:"playing",get:function(){return this.state===AudioClip.PlayingState.PLAYING}}]),s}()).prototype,"_clip",[_dec3$Z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2$1b=_applyDecoratedDescriptor(_class2$1s.prototype,"_loop",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor3$V=_applyDecoratedDescriptor(_class2$1s.prototype,"_playOnAwake",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor4$P=_applyDecoratedDescriptor(_class2$1s.prototype,"_volume",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_applyDecoratedDescriptor(_class2$1s.prototype,"clip",[_dec4$Q],Object.getOwnPropertyDescriptor(_class2$1s.prototype,"clip"),_class2$1s.prototype),_applyDecoratedDescriptor(_class2$1s.prototype,"loop",[property],Object.getOwnPropertyDescriptor(_class2$1s.prototype,"loop"),_class2$1s.prototype),_applyDecoratedDescriptor(_class2$1s.prototype,"playOnAwake",[property],Object.getOwnPropertyDescriptor(_class2$1s.prototype,"playOnAwake"),_class2$1s.prototype),_applyDecoratedDescriptor(_class2$1s.prototype,"volume",[property],Object.getOwnPropertyDescriptor(_class2$1s.prototype,"volume"),_class2$1s.prototype),_class$1H=_class2$1s))||_class$1H)||_class$1H);cc.AudioSourceComponent=AudioSourceComponent;var Tween_min=createCommonjsModule(function(e,t){function i(){this._tweens={},this._tweensAddedDuringUpdate={}}i.prototype={getAll:function(){return Object.keys(this._tweens).map(function(e){return this._tweens[e]}.bind(this))},removeAll:function(){this._tweens={}},add:function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},remove:function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},update:function(e,t){var i=Object.keys(this._tweens);if(0===i.length)return!1;for(e=void 0!==e?e:c.now();0<i.length;){this._tweensAddedDuringUpdate={};for(var r=0;r<i.length;r++){var n=this._tweens[i[r]];n&&!1===n.update(e)&&(n._isPlaying=!1,t||delete this._tweens[i[r]])}i=Object.keys(this._tweensAddedDuringUpdate)}return!0}};var r,c=new i;c.Group=i,c._nextId=0,c.nextId=function(){return c._nextId++},"undefined"==typeof self&&"undefined"!=typeof process&&process.hrtime?c.now=function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof self&&void 0!==self.performance&&void 0!==self.performance.now?c.now=self.performance.now.bind(self.performance):void 0!==Date.now?c.now=Date.now:c.now=function(){return(new Date).getTime()},c.Tween=function(e,t){this._object=e,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._repeat=0,this._repeatDelayTime=void 0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=null,this._easingFunction=c.Easing.Linear.None,this._interpolationFunction=c.Interpolation.Linear,this._chainedTweens=[],this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onRepeatCallback=null,this._onCompleteCallback=null,this._onStopCallback=null,this._group=t||c,this._id=c.nextId(),this._onCompleteCallbackForCocos=null},c.Tween.prototype={getId:function(){return this._id},isPlaying:function(){return this._isPlaying},to:function(e,t){return this._valuesEnd=JSON.parse(JSON.stringify(e)),void 0!==t&&(this._duration=t),this},duration:function(e){return this._duration=e,this},start:function(e){return this._group.add(this),this._isPlaying=!0,this._onStartCallbackFired=!1,this._startTime=void 0!==e?"string"==typeof e?c.now()+parseFloat(e):e:c.now(),this._startTime+=this._delayTime,c._recursiveObjetCopy(this._valuesEnd,this._valuesStart,this._valuesStartRepeat,this._object),this},stop:function(){return this._isPlaying&&(this._group.remove(this),this._isPlaying=!1,null!==this._onStopCallback&&this._onStopCallback(this._object),this.stopChainedTweens()),this},end:function(){return this.update(1/0),this},stopChainedTweens:function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop()},group:function(e){return this._group=e,this},delay:function(e){return this._delayTime=e,this},repeat:function(e){return this._repeat=e,this},repeatDelay:function(e){return this._repeatDelayTime=e,this},yoyo:function(e){return this._yoyo=e,this},easing:function(e){return this._easingFunction=e,this},interpolation:function(e){return this._interpolationFunction=e,this},chain:function(){return this._chainedTweens=arguments,this},onStart:function(e){return this._onStartCallback=e,this},onUpdate:function(e){return this._onUpdateCallback=e,this},onRepeat:function(e){return this._onRepeatCallback=e,this},onComplete:function(e){return this._onCompleteCallback=e,this},onStop:function(e){return this._onStopCallback=e,this},update:function(e){var t,i,r;if(e<this._startTime)return!0;if(!1===this._onStartCallbackFired&&(null!==this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),i=(e-this._startTime)/this._duration,i=0===this._duration||1<i?1:i,r=this._easingFunction(i),c._recursiveObjetUpdate(this._valuesEnd,this._valuesStart,r,this._object,this),null!==this._onUpdateCallback&&this._onUpdateCallback(this._object,i),1!==i)return!0;if(0<this._repeat){for(t in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat){if("string"==typeof this._valuesEnd[t]&&(this._valuesStartRepeat[t]=this._valuesStartRepeat[t]+parseFloat(this._valuesEnd[t])),this._yoyo){var n=this._valuesStartRepeat[t];this._valuesStartRepeat[t]=this._valuesEnd[t],this._valuesEnd[t]=n}this._valuesStart[t]=this._valuesStartRepeat[t]}return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=e+this._repeatDelayTime:this._startTime=e+this._delayTime,null!==this._onRepeatCallback&&this._onRepeatCallback(this._object),!0}if(null!==this._onCompleteCallback&&this._onCompleteCallback(this._object),null!==this._onCompleteCallbackForCocos)this._onCompleteCallbackForCocos(this);else for(var s=0,a=this._chainedTweens.length;s<a;s++)this._chainedTweens[s].start(this._startTime+this._duration);return!1},cc_onCompleteCallback:function(e){this._onCompleteCallbackForCocos=e}},c._recursiveObjetUpdate=function(e,t,i,r,n){var s,a;for(var o in e)s=e[o],a=t[o],s instanceof Array?r[o]=n._interpolationFunction(s,i):("string"==typeof s&&(s="+"===s.charAt(0)||"-"===s.charAt(0)?a+parseFloat(s):parseFloat(s)),"number"==typeof s?r[o]=a+(s-a)*i:"object"==typeof s&&c._recursiveObjetUpdate(s,a,i,r[o],n))},c._recursiveObjetCopy=function(e,t,i,r){for(var n in e){if(e[n]instanceof Array){if(0===e[n].length)continue;e[n]=[r[n]].concat(e[n])}void 0!==r[n]&&("object"==typeof r[n]?(t[n]={},i[n]={},c._recursiveObjetCopy(e[n],t[n],i[n],r[n])):(t[n]=r[n],"string"==typeof t[n]&&(t[n]*=1),i[n]=t[n]||0))}},c.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}},Back:{In:function(e){return e*e*(2.70158*e-1.70158)},Out:function(e){return--e*e*(2.70158*e+1.70158)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((1+t)*e-t)*.5:.5*((e-=2)*e*((1+t)*e+t)+2)}},Bounce:{In:function(e){return 1-c.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*c.Easing.Bounce.In(2*e):.5*c.Easing.Bounce.Out(2*e-1)+.5}}},c.Interpolation={Linear:function(e,t){var i=e.length-1,r=i*t,n=Math.floor(r),s=c.Interpolation.Utils.Linear;return t<0?s(e[0],e[1],r):1<t?s(e[i],e[i-1],i-r):s(e[n],e[i<n+1?i:n+1],r-n)},Bezier:function(e,t){for(var i=0,r=e.length-1,n=Math.pow,s=c.Interpolation.Utils.Bernstein,a=0;a<=r;a++)i+=n(1-t,r-a)*n(t,a)*e[a]*s(r,a);return i},CatmullRom:function(e,t){var i=e.length-1,r=i*t,n=Math.floor(r),s=c.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(n=Math.floor(r=i*(1+t))),s(e[(n-1+i)%i],e[n],e[(n+1)%i],e[(n+2)%i],r-n)):t<0?e[0]-(s(e[0],e[0],e[1],e[1],-r)-e[0]):1<t?e[i]-(s(e[i],e[i],e[i-1],e[i-1],r-i)-e[i]):s(e[n?n-1:0],e[n],e[i<n+1?i:n+1],e[i<n+2?i:n+2],r-n)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=c.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:(r=[1],function(e){var t=1;if(r[e])return r[e];for(var i=e;1<i;i--)t*=i;return r[e]=t}),CatmullRom:function(e,t,i,r,n){var s=.5*(i-e),a=.5*(r-t),o=n*n;return n*o*(2*t-2*i+s+a)+(-3*t+3*i-2*s-a)*o+s*n+t}}},e.exports=c}),Tween_min_1=Tween_min.TWEEN,TweenAction=function e(t,i,r,n){if(_classCallCheck(this,e),this.id=void 0,this.tween=void 0,this._opts=void 0,this._props=void 0,this.id=e._idCounter++,this.tween=new Tween_min.Tween(t),this._props=r,this._opts=n,this.tween.to(r,i),null!=n){if(null!=n.delay&&this.tween.delay(n.delay),null!=n.repeat&&this.tween.repeat(n.repeat),null!=n.repeatDelay&&this.tween.repeatDelay(n.repeatDelay),null!=n.yoyo&&this.tween.yoyo(n.yoyo),null!=n.easing)if("string"==typeof n.easing){var s=n.easing.split("-");if(2<=s.length){var a=s[0],o=s[1];"Linear"===a?"None"===o&&this.tween.easing(Tween_min.Easing[a][o]):"In"!==o&&"Out"!==o&&"InOut"!==o||this.tween.easing(Tween_min.Easing[a][o])}}else this.tween.easing(n.easing);if(null!=n.interpolation)if("string"==typeof n.interpolation){var c=n.interpolation.split("-");if(1<=c.length){var l=c[0];this.tween.interpolation(Tween_min.Interpolation[l])}}else this.tween.interpolation(n.interpolation);null!=n.onStart&&this.tween.onStart(n.onStart),null!=n.onStop&&this.tween.onStop(n.onStop),null!=n.onUpdate&&this.tween.onUpdate(n.onUpdate),null!=n.onComplete&&this.tween.onComplete(n.onComplete)}};function setWrap$1(e,t){e.__cc_wrapper__=t}function getWrap$1(e){return e.__cc_wrapper__}TweenAction._idCounter=0,cc.TweenAction=TweenAction,window.TWEEN=Tween_min;var TweenCommand=function(){function e(){_classCallCheck(this,e),this.quene=[]}return _createClass(e,[{key:"updateChain",value:function(){for(var e=this.length,t=0,i=1;t<e;){var r=this.quene[t];if(i<e){if(0<r.length){var n=this.quene[i];if(0===r.repeatTimes){if(0<n.length)r.lastAction.tween.chain(n.lastAction.tween)}else this.wrapAndEvent(r)}}else if(0<r.length&&0!==r.repeatTimes){var s=r.lastAction;setWrap$1(s.tween,r),s.tween.cc_onCompleteCallback(this._onComplete.bind(this))}++t,++i}}},{key:"start",value:function(){this.updateChain(),0<this.length&&this.firstUnion.start()}},{key:"stop",value:function(){for(var e=0;e<this.length;e++){if(this.quene[e].stop())break}}},{key:"union",value:function(e){this.quene.push(e)}},{key:"isExistUnion",value:function(e){return-1!==this.quene.indexOf(e)}},{key:"wrapAndEvent",value:function(e){var t=e.lastAction;setWrap$1(t.tween,e),t.tween.cc_onCompleteCallback(this._onComplete.bind(this))}},{key:"_onComplete",value:function(e){var t=getWrap$1(e);if(0<t.repeatTimes&&0<t.lastCount){t.runTimes++;var i=this.quene.indexOf(t);if(0<=i){for(var r=0;r<i;r++)this.quene[r].runTimes=0;this.firstUnion.start()}}else if(-1===t.repeatTimes){var n=this.quene.indexOf(t);if(0<=n){for(var s=0;s<n;s++)this.quene[s].runTimes=0;this.firstUnion.start()}}else{t.onCompeleteCallback&&t.onCompeleteCallback(e._object);var a=this.quene.indexOf(t);if(a!==this.length-1)this.quene[a+1].start()}}},{key:"length",get:function(){return this.quene.length}},{key:"firstUnion",get:function(){return this.quene[0]}},{key:"lastUnion",get:function(){return this.quene[this.quene.length-1]}}]),e}();cc.TweenCommand=TweenCommand;var TweenUnion=function(){function t(e){_classCallCheck(this,t),this.id=void 0,this._actions=[],this._target=void 0,this._runTimes=0,this._repeatTimes=0,this._onCompeleteCallback=void 0,this._delay=0,this.id=t._idCounter++,this._target=e}return _createClass(t,[{key:"actions",get:function(){return this._actions}},{key:"length",get:function(){return this._actions.length}},{key:"firstAction",get:function(){return this._actions[0]}},{key:"lastAction",get:function(){return this._actions[this._actions.length-1]}},{key:"target",get:function(){return this._target}},{key:"runTimes",get:function(){return this._runTimes},set:function(e){this._runTimes=e}},{key:"repeatTimes",get:function(){return this._repeatTimes},set:function(e){this._repeatTimes=e}},{key:"lastCount",get:function(){return this._repeatTimes-this._runTimes}},{key:"onCompeleteCallback",set:function(e){this._onCompeleteCallback=e},get:function(){return this._onCompeleteCallback}},{key:"delay",get:function(){return this._delay},set:function(e){this._delay=e}}]),_createClass(t,[{key:"start",value:function(){if(0<this.length)if(0<this.delay){var e=this.actions[0].tween;setTimeout(e.start.bind(e),this.delay)}else this.actions[0].tween.start()}},{key:"stop",value:function(){for(var e=0;e<this._actions.length;e++){var t=this._actions[e].tween;if(t.isPlaying())return t.stop(),!0}return!1}}]),t}();TweenUnion._idCounter=0,cc.TweenUnion=TweenUnion;var Tween=function(){function n(e){_classCallCheck(this,n),this._command=new TweenCommand,this._default=void 0,this._uionDirty=!1,this._default=new TweenUnion(e)}return _createClass(n,null,[{key:"_recursiveForBy",value:function(e){var t;for(var i in e)if("number"==typeof(t=e[i])){var r=0<t?"+":"-";e[i]=r+t}else"object"===_typeof(t)&&n._recursiveForBy(t)}}]),_createClass(n,[{key:"to",value:function(e,t,i){this._uionDirty&&(this._default=new TweenUnion(this._default.target),this._uionDirty=!1);var r=new TweenAction(this._default.target,1e3*e,t,i);return 0<this._default.length&&this._default.actions[this._default.length-1].tween.chain(r.tween),this._default.actions.push(r),this}},{key:"by",value:function(e,t,i){this._uionDirty&&(this._default=new TweenUnion(this._default.target),this._uionDirty=!1),n._recursiveForBy(t);var r=new TweenAction(this._default.target,1e3*e,t,i);return 0<this._default.length&&this._default.actions[this._default.length-1].tween.chain(r.tween),this._default.actions.push(r),this}},{key:"union",value:function(){return this._command.isExistUnion(this._default)||(this._command.union(this._default),this._uionDirty=!0),this}},{key:"start",value:function(){return 0<this._default.length&&(this._command.isExistUnion(this._default)||this._command.union(this._default)),this._command.start(),this}},{key:"stop",value:function(){return this._command.stop(),this}},{key:"repeat",value:function(e){return this._uionDirty?this._default.repeatTimes=e:0<this._default.length&&this._default.lastAction.tween.repeat(e),this}},{key:"repeatForever",value:function(){return this._uionDirty?this._default.repeatTimes=-1:0<this._default.length&&this._default.lastAction.tween.repeat(1/0),this}},{key:"delay",value:function(e){return this._uionDirty?this._default.delay=1e3*e:0<this._default.length&&this._default.lastAction.tween.delay(1e3*e),this}},{key:"call",value:function(e){return this._uionDirty?this._default.onCompeleteCallback=e:0<this._default.length&&this._default.lastAction.tween.onComplete(e),this}}]),n}();function tweenUtil(e){return new Tween(e)}cc.Tween=Tween,cc.tweenUtil=tweenUtil;var TweenSystem=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,System),_createClass(e,[{key:"postUpdate",value:function(e){window.TWEEN&&window.TWEEN.update(performance.now())}}]),e}();function tween(e){return warn("tween' is deprecated, please use 'tweenUtil' instead "),tweenUtil(e)}TweenSystem.ID="tween",director.on(Director.EVENT_INIT,function(){var e=new TweenSystem;director.registerSystem(TweenSystem.ID,e,100)}),cc.tween=tween;var _dec$1G,_class$1I,_class2$1t,_descriptor$1p,_descriptor2$1c,_descriptor3$W,_descriptor4$Q,_temp$1A,_dec2$1g,_class4$7,_class5$7,_descriptor5$F,_descriptor6$t,_temp2$7,_dec3$_,_class7$2,_class8$2,_descriptor7$o,_temp3$2,_dec4$R,_dec5$K,_dec6$E,_dec7$u,_dec8$k,_dec9$h,_dec10$f,_class10$1,_class11$1,_descriptor8$l,_descriptor9$g,_descriptor10$f,_descriptor11$d,_descriptor12$c,_temp4$1,HeightField=function(){function r(e,t){_classCallCheck(this,r),this.data=new Uint16Array,this.w=0,this.h=0,this.w=e,this.h=t,this.data=new Uint16Array(e*t);for(var i=0;i<e*t;++i)this.data[i]=0}return _createClass(r,[{key:"set",value:function(e,t,i){this.data[t*this.w+e]=i}},{key:"get",value:function(e,t){return this.data[t*this.w+e]}},{key:"getClamp",value:function(e,t){return e=clamp(e,0,this.w-1),t=clamp(t,0,this.h-1),this.get(e,t)}},{key:"getAt",value:function(e,t){var i=e/this.w,r=t/this.h,n=Math.floor(i),s=Math.floor(r),a=n+1,o=s+1,c=i-n,l=r-s;n=clamp(n,0,this.w-1),s=clamp(s,0,this.h-1),a=clamp(a,0,this.w-1),o=clamp(o,0,this.h-1);var u=this.get(n,s),h=this.get(a,s),_=this.get(n,o),p=this.get(a,o),d=.5*(h+_);return c+l<=1?p=d-u+d:u=d-p+d,(u*(1-c)+h*c)*(1-l)+(_*(1-c)+p*c)*l}}]),r}(),TERRAIN_MAX_LEVELS=4,TERRAIN_MAX_BLEND_LAYERS=4,TERRAIN_MAX_LAYER_COUNT=256,TERRAIN_BLOCK_TILE_COMPLEXITY=32,TERRAIN_BLOCK_VERTEX_COMPLEXITY=33,TERRAIN_BLOCK_VERTEX_SIZE=8,TERRAIN_NORTH_INDEX=0,TERRAIN_SOUTH_INDEX=1,TERRAIN_WEST_INDEX=2,TERRAIN_EAST_INDEX=3,TerrainInfo=(_dec$1G=ccclass("cc.TerrainInfo"))((_descriptor$1p=_applyDecoratedDescriptor((_class2$1t=_temp$1A=function(){function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"tileSize",_descriptor$1p,this),_initializerDefineProperty(this,"blockCount",_descriptor2$1c,this),_initializerDefineProperty(this,"weightMapSize",_descriptor3$W,this),_initializerDefineProperty(this,"lightMapSize",_descriptor4$Q,this),this._tileCount=[0,0],this._vertexCount=[0,0],this._size=new Size(0,0)}return _createClass(e,[{key:"initialize",value:function(){this._tileCount[0]=this.blockCount[0]*TERRAIN_BLOCK_TILE_COMPLEXITY,this._tileCount[1]=this.blockCount[1]*TERRAIN_BLOCK_TILE_COMPLEXITY,this._vertexCount[0]=this._tileCount[0]+1,this._vertexCount[1]=this._tileCount[1]+1,this._size.width=this._tileCount[0]*this.tileSize,this._size.height=this._tileCount[1]*this.tileSize}},{key:"tileCount",get:function(){return this._tileCount}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"size",get:function(){return this._size}}]),e}()).prototype,"tileSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor2$1c=_applyDecoratedDescriptor(_class2$1t.prototype,"blockCount",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),_descriptor3$W=_applyDecoratedDescriptor(_class2$1t.prototype,"weightMapSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),_descriptor4$Q=_applyDecoratedDescriptor(_class2$1t.prototype,"lightMapSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),_class$1I=_class2$1t))||_class$1I,TerrainLayer=(_dec2$1g=ccclass("cc.TerrainLayer"))((_descriptor5$F=_applyDecoratedDescriptor((_class5$7=_temp2$7=function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"detailMap",_descriptor5$F,this),_initializerDefineProperty(this,"tileSize",_descriptor6$t,this)}).prototype,"detailMap",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor6$t=_applyDecoratedDescriptor(_class5$7.prototype,"tileSize",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_class4$7=_class5$7))||_class4$7,TerrainVertex=function e(){_classCallCheck(this,e),this.position=new Vec3(0,0,0),this.normal=new Vec3(0,1,0),this.uv=new Vec2(0,0)},TerrainRenderable=function(){function s(){var e,t;_classCallCheck(this,s);for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=_possibleConstructorReturn(this,(e=_getPrototypeOf(s)).call.apply(e,[this].concat(r))))._model=null,t._meshData=null,t._brushMaterial=null,t._currentMaterial=null,t._currentMaterialLayers=0,t}return _inherits(s,RenderableComponent),_createClass(s,[{key:"destroy",value:function(){this._invalidMaterial(),null!=this._model&&(this._getRenderScene().destroyModel(this._model),this._model=null),_get(_getPrototypeOf(s.prototype),"destroy",this).call(this)}},{key:"_invalidMaterial",value:function(){null!=this._currentMaterial&&(this._clearMaterials(),(this._currentMaterial=null)!=this._model&&(this._model.enabled=!1))}},{key:"_updateMaterial",value:function(e,t){if(null!=this._meshData&&null!=this._model){var i=e.getMaxLayer();if(null==this._currentMaterial||i!==this._currentMaterialLayers){if(this._currentMaterial=new Material,this._currentMaterial.initialize({effectAsset:EffectAsset.get("builtin-terrain"),defines:e._getMaterialDefines(i)}),null!==this._brushMaterial)this._currentMaterial.passes.push(this._brushMaterial.passes[0]);t&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0}}}},{key:"_onMaterialModified",value:function(e,t){null!=this._model&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_clearMaterials",value:function(){null!=this._model&&this._onMaterialModified(0,null)}},{key:"_getBuiltinMaterial",value:function(){return builtinResMgr.get("missing-material")}}]),s}(),TerrainBlockInfo=(_dec3$_=ccclass("cc.TerrainBlockInfo"))((_descriptor7$o=_applyDecoratedDescriptor((_class8$2=_temp3$2=function e(){_classCallCheck(this,e),_initializerDefineProperty(this,"layers",_descriptor7$o,this)}).prototype,"layers",[property],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[-1,-1,-1,-1]}}),_class7$2=_class8$2))||_class7$2,TerrainBlock=function(){function r(e,t,i){_classCallCheck(this,r),this._terrain=void 0,this._info=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._terrain=e,this._info=e.getBlockInfo(t,i),this._index[0]=t,this._index[1]=i,this._node=new PrivateNode(""),this._node.setParent(this._terrain.node),this._node._objFlags|=cc.Object.Flags.DontSave,this._renderable=this._node.addComponent(TerrainRenderable)}return _createClass(r,[{key:"build",value:function(){for(var e=director.root.device,t=new Float32Array(TERRAIN_BLOCK_VERTEX_SIZE*TERRAIN_BLOCK_VERTEX_COMPLEXITY*TERRAIN_BLOCK_VERTEX_COMPLEXITY),i=0,r=0;r<TERRAIN_BLOCK_VERTEX_COMPLEXITY;++r)for(var n=0;n<TERRAIN_BLOCK_VERTEX_COMPLEXITY;++n){var s=this._index[0]*TERRAIN_BLOCK_TILE_COMPLEXITY+n,a=this._index[1]*TERRAIN_BLOCK_TILE_COMPLEXITY+r,o=this._terrain.getPosition(s,a),c=this._terrain.getNormal(s,a),l=new Vec2(n/TERRAIN_BLOCK_TILE_COMPLEXITY,r/TERRAIN_BLOCK_TILE_COMPLEXITY);t[i++]=o.x,t[i++]=o.y,t[i++]=o.z,t[i++]=c.x,t[i++]=c.y,t[i++]=c.z,t[i++]=l.x,t[i++]=l.y}var u=e.createBuffer({usage:exports.GFXBufferUsageBit.VERTEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:TERRAIN_BLOCK_VERTEX_SIZE*Float32Array.BYTES_PER_ELEMENT*TERRAIN_BLOCK_VERTEX_COMPLEXITY*TERRAIN_BLOCK_VERTEX_COMPLEXITY,stride:TERRAIN_BLOCK_VERTEX_SIZE*Float32Array.BYTES_PER_ELEMENT});u.update(t);var h=[{name:exports.GFXAttributeName.ATTR_POSITION,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_NORMAL,format:exports.GFXFormat.RGB32F},{name:exports.GFXAttributeName.ATTR_TEX_COORD,format:exports.GFXFormat.RG32F}];this._renderable._meshData={attributes:h,vertexBuffers:[u],indexBuffer:this._terrain.getSharedIndexBuffer(),flatBuffers:[],primitiveMode:exports.GFXPrimitiveMode.TRIANGLE_LIST},this._renderable._model=this._renderable._getRenderScene().createModel(Model,this._node),this._updateWeightMap(),this._updateMaterial(!0)}},{key:"rebuild",value:function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)}},{key:"destroy",value:function(){null!=this._renderable&&this._renderable.destroy(),null!=this._node&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()}},{key:"update",value:function(){this._updateMaterial(!1);var e=this._renderable._currentMaterial;if(null!=e){var t=this.getMaxLayer(),i=new Vec4(1,1,1,1);if(0===t)if(-1!==this.layers[0]){var r=this._terrain.getLayer(this.layers[0]);null!=r&&(i.x=1/r.tileSize),e.setProperty("detailMap0",null!=r?r.detailMap:null)}else e.setProperty("detailMap0",builtinResMgr.get("default-texture"));else if(1===t){var n=this._terrain.getLayer(this.layers[0]),s=this._terrain.getLayer(this.layers[1]);null!=n&&(i.x=1/n.tileSize),null!=s&&(i.y=1/s.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=n?n.detailMap:null),e.setProperty("detailMap1",null!=s?s.detailMap:null)}else if(2===t){var a=this._terrain.getLayer(this.layers[0]),o=this._terrain.getLayer(this.layers[1]),c=this._terrain.getLayer(this.layers[2]);null!=a&&(i.x=1/a.tileSize),null!=o&&(i.y=1/o.tileSize),null!=c&&(i.z=1/c.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=a?a.detailMap:null),e.setProperty("detailMap1",null!=o?o.detailMap:null),e.setProperty("detailMap2",null!=c?c.detailMap:null)}else if(3===t){var l=this._terrain.getLayer(this.layers[0]),u=this._terrain.getLayer(this.layers[1]),h=this._terrain.getLayer(this.layers[2]),_=this._terrain.getLayer(this.layers[3]);null!=l&&(i.x=1/l.tileSize),null!=u&&(i.y=1/u.tileSize),null!=h&&(i.z=1/h.tileSize),null!=_&&(i.z=1/_.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=l?l.detailMap:null),e.setProperty("detailMap1",null!=u?u.detailMap:null),e.setProperty("detailMap2",null!=h?h.detailMap:null),e.setProperty("detailMap3",null!=_?_.detailMap:null)}e.setProperty("UVScale",i)}}},{key:"setBrushMaterial",value:function(e){this._renderable._brushMaterial!==e&&(this._renderable._brushMaterial=e,this._renderable._invalidMaterial())}},{key:"getTerrain",value:function(){return this._terrain}},{key:"getIndex",value:function(){return this._index}},{key:"getRect",value:function(){var e=new Rect;return e.x=this._index[0]*TERRAIN_BLOCK_TILE_COMPLEXITY,e.y=this._index[1]*TERRAIN_BLOCK_TILE_COMPLEXITY,e.width=TERRAIN_BLOCK_TILE_COMPLEXITY,e.height=TERRAIN_BLOCK_TILE_COMPLEXITY,e}},{key:"setLayer",value:function(e,t){this.layers[e]!==t&&(this.layers[e]=t,this._renderable._invalidMaterial(),this._updateMaterial(!1))}},{key:"getLayer",value:function(e){return this.layers[e]}},{key:"getMaxLayer",value:function(){return 0<=this.layers[3]?3:0<=this.layers[2]?2:0<=this.layers[1]?1:0}},{key:"_getMaterialDefines",value:function(e){return 0===e?{LAYERS:1}:1===e?{LAYERS:2}:2===e?{LAYERS:3}:3===e?{LAYERS:4}:{LAYERS:0}}},{key:"_invalidMaterial",value:function(){this._renderable._invalidMaterial()}},{key:"_updateMaterial",value:function(e){this._renderable._updateMaterial(this,e)}},{key:"_updateHeight",value:function(){if(null!=this._renderable._meshData){for(var e=new Float32Array(TERRAIN_BLOCK_VERTEX_SIZE*TERRAIN_BLOCK_VERTEX_COMPLEXITY*TERRAIN_BLOCK_VERTEX_COMPLEXITY),t=0,i=0;i<TERRAIN_BLOCK_VERTEX_COMPLEXITY;++i)for(var r=0;r<TERRAIN_BLOCK_VERTEX_COMPLEXITY;++r){var n=this._index[0]*TERRAIN_BLOCK_TILE_COMPLEXITY+r,s=this._index[1]*TERRAIN_BLOCK_TILE_COMPLEXITY+i,a=this._terrain.getPosition(n,s),o=this._terrain.getNormal(n,s),c=new Vec2(r/TERRAIN_BLOCK_VERTEX_COMPLEXITY,i/TERRAIN_BLOCK_VERTEX_COMPLEXITY);e[t++]=a.x,e[t++]=a.y,e[t++]=a.z,e[t++]=o.x,e[t++]=o.y,e[t++]=o.z,e[t++]=c.x,e[t++]=c.y}this._renderable._meshData.vertexBuffers[0].update(e)}}},{key:"_updateWeightMap",value:function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new Texture2D,this._weightMap.create(this._terrain.info.weightMapSize,this._terrain.info.weightMapSize,PixelFormat.RGBA8888),this._weightMap.setFilters(Filter.LINEAR,Filter.LINEAR),this._weightMap.setWrapMode(WrapMode$1.CLAMP_TO_EDGE,WrapMode$1.CLAMP_TO_EDGE));for(var e=new Uint8Array(this._terrain.info.weightMapSize*this._terrain.info.weightMapSize*4),t=0,i=0;i<this._terrain.info.weightMapSize;++i)for(var r=0;r<this._terrain.info.weightMapSize;++r){var n=this._index[0]*this._terrain.info.weightMapSize+r,s=this._index[1]*this._terrain.info.weightMapSize+i,a=this._terrain.getWeight(n,s);e[4*t+0]=Math.floor(255*a.x),e[4*t+1]=Math.floor(255*a.y),e[4*t+2]=Math.floor(255*a.z),e[4*t+3]=Math.floor(255*a.w),t+=1}this._weightMap.uploadData(e.buffer)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)}},{key:"layers",get:function(){return this._info.layers}}]),r}(),Terrain=(_dec4$R=ccclass("cc.Terrain"),_dec5$K=menu("Components/Terrain"),_dec6$E=property({type:TerrainInfo,visible:!0}),_dec7$u=property({type:TerrainLayer,visible:!0}),_dec8$k=property({visible:!1}),_dec9$h=property({visible:!1}),_dec10$f=property({visible:!1}),_dec4$R(_class10$1=_dec5$K(_class10$1=executeInEditMode((_descriptor8$l=_applyDecoratedDescriptor((_class11$1=_temp4$1=function(){function i(){var e;_classCallCheck(this,i),_initializerDefineProperty(e=_possibleConstructorReturn(this,_getPrototypeOf(i).call(this)),"_info",_descriptor8$l,_assertThisInitialized(e)),_initializerDefineProperty(e,"_layers",_descriptor9$g,_assertThisInitialized(e)),_initializerDefineProperty(e,"_heights",_descriptor10$f,_assertThisInitialized(e)),_initializerDefineProperty(e,"_weights",_descriptor11$d,_assertThisInitialized(e)),_initializerDefineProperty(e,"_blockInfos",_descriptor12$c,_assertThisInitialized(e)),e._normals=[],e._blocks=[],e._sharedIndexBuffer=null;for(var t=0;t<TERRAIN_MAX_LAYER_COUNT;++t)e._layers.push(null);return e}return _inherits(i,Component),_createClass(i,[{key:"build",value:function(e){return this._info.tileSize=e.tileSize,this._info.blockCount[0]=e.blockCount[0],this._info.blockCount[1]=e.blockCount[1],this._info.weightMapSize=e.weightMapSize,this._info.lightMapSize=e.lightMapSize,this._info.initialize(),this._buildImp()}},{key:"rebuild",value:function(e){e.initialize();for(var t=[],i=0;i<e.blockCount[0]*e.blockCount[1];++i)t.push(new TerrainBlockInfo);for(var r=Math.min(this.info.blockCount[0],e.blockCount[0]),n=Math.min(this.info.blockCount[1],e.blockCount[1]),s=0;s<n;++s)for(var a=0;a<r;++a){var o=s*e.vertexCount[0]+a,c=s*this.info.vertexCount[0]+a;t[o]=this._blockInfos[c]}this._blockInfos=t;var l=this._blocks,u=Array.isArray(l),h=0;for(l=u?l:l[Symbol.iterator]();;){var _;if(u){if(h>=l.length)break;_=l[h++]}else{if((h=l.next()).done)break;_=h.value}_.destroy()}this._blocks=[],this._rebuildHeights(e),this._rebuildWeights(e),this._info.tileSize=e.tileSize,this._info.blockCount[0]=e.blockCount[0],this._info.blockCount[1]=e.blockCount[1],this._info.weightMapSize=e.weightMapSize,this._info.lightMapSize=e.lightMapSize,this._info.initialize(),this._buildNormals();for(var p=0;p<this._info.blockCount[1];++p)for(var d=0;d<this._info.blockCount[0];++d)this._blocks.push(new TerrainBlock(this,d,p));var f=this._blocks,m=Array.isArray(f),y=0;for(f=m?f:f[Symbol.iterator]();;){var v;if(m){if(y>=f.length)break;v=f[y++]}else{if((y=f.next()).done)break;v=y.value}v.build()}}},{key:"importHeightField",value:function(e,t){for(var i=0,r=0;r<this._info.vertexCount[1];++r)for(var n=0;n<this._info.vertexCount[0];++n){var s=n/this._info.tileCount[0],a=r/this._info.tileCount[1],o=e.getAt(s*e.w,a*e.h)*t;this._heights[i++]=o}this._buildNormals();var c=this._blocks,l=Array.isArray(c),u=0;for(c=l?c:c[Symbol.iterator]();;){var h;if(l){if(u>=c.length)break;h=c[u++]}else{if((u=c.next()).done)break;h=u.value}h._updateHeight()}}},{key:"exportHeightField",value:function(e,t){for(var i=0,r=0;r<e.h;++r)for(var n=0;n<e.w;++n){var s=n/(e.w-1),a=r/(e.h-1),o=s*this._info.size.width,c=a*this._info.size.height,l=this.getHeightAt(o,c);null!=l&&(e.data[i++]=l*t)}}},{key:"onLoad",value:function(){for(var e=director.root.device,t=new Uint16Array(TERRAIN_BLOCK_TILE_COMPLEXITY*TERRAIN_BLOCK_TILE_COMPLEXITY*6),i=0,r=0;r<TERRAIN_BLOCK_TILE_COMPLEXITY;++r)for(var n=0;n<TERRAIN_BLOCK_TILE_COMPLEXITY;++n){var s=r*TERRAIN_BLOCK_VERTEX_COMPLEXITY+n,a=r*TERRAIN_BLOCK_VERTEX_COMPLEXITY+n+1,o=(r+1)*TERRAIN_BLOCK_VERTEX_COMPLEXITY+n,c=(r+1)*TERRAIN_BLOCK_VERTEX_COMPLEXITY+n+1;t[i++]=s,t[i++]=o,t[i++]=a,t[i++]=a,t[i++]=o,t[i++]=c}this._sharedIndexBuffer=e.createBuffer({usage:exports.GFXBufferUsageBit.INDEX|exports.GFXBufferUsageBit.TRANSFER_DST,memUsage:exports.GFXMemoryUsageBit.HOST|exports.GFXMemoryUsageBit.DEVICE,size:Uint16Array.BYTES_PER_ELEMENT*TERRAIN_BLOCK_TILE_COMPLEXITY*TERRAIN_BLOCK_TILE_COMPLEXITY*6,stride:Uint16Array.BYTES_PER_ELEMENT}),this._sharedIndexBuffer.update(t)}},{key:"onEnable",value:function(){0===this._blocks.length&&this._buildImp()}},{key:"onDisable",value:function(){var e=this._blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var r;if(t){if(i>=e.length)break;r=e[i++]}else{if((i=e.next()).done)break;r=i.value}r.destroy()}this._blocks=[]}},{key:"onDestroy",value:function(){for(var e=0;e<this._layers.length;++e)this._layers[e]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()}},{key:"onRestore",value:function(){this.onDisable(),this.onLoad(),this._buildImp()}},{key:"update",value:function(e){var t=this._blocks,i=Array.isArray(t),r=0;for(t=i?t:t[Symbol.iterator]();;){var n;if(i){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}n.update()}}},{key:"addLayer",value:function(e){for(var t=0;t<this._layers.length;++t)if(null==this._layers[t])return this._layers[t]=e,t;return-1}},{key:"setLayer",value:function(e,t){this._layers[e]=t}},{key:"removeLayer",value:function(e){this._layers[e]=null}},{key:"getLayer",value:function(e){return this._layers[e]}},{key:"getPosition",value:function(e,t){var i=e*this._info.tileSize,r=t*this._info.tileSize,n=this.getHeight(e,t);return new Vec3(i,n,r)}},{key:"setHeight",value:function(e,t,i){this._heights[t*this._info.vertexCount[0]+e]=i}},{key:"getHeight",value:function(e,t){return this._heights[t*this._info.vertexCount[0]+e]}},{key:"getHeightClamp",value:function(e,t){return e=clamp(e,0,this._info.vertexCount[0]-1),t=clamp(t,0,this._info.vertexCount[1]-1),this.getHeight(e,t)}},{key:"getHeightAt",value:function(e,t){var i=e/this._info.vertexCount[0],r=t/this._info.vertexCount[1],n=Math.floor(i),s=Math.floor(r),a=n+1,o=s+1,c=i-n,l=r-s;if(n<0||n>this._info.vertexCount[0]-1||s<0||s>this._info.vertexCount[1]-1)return null;n=clamp(n,0,this._info.vertexCount[0]-1),s=clamp(s,0,this._info.vertexCount[1]-1),a=clamp(a,0,this._info.vertexCount[0]-1),o=clamp(o,0,this._info.vertexCount[1]-1);var u=this.getHeight(n,s),h=this.getHeight(a,s),_=this.getHeight(n,o),p=this.getHeight(a,o),d=.5*(h+_);return c+l<=1?p=d-u+d:u=d-p+d,(u*(1-c)+h*c)*(1-l)+(_*(1-c)+p*c)*l}},{key:"_setNormal",value:function(e,t,i){var r=t*this._info.vertexCount[0]+e;this._normals[3*r+0]=i.x,this._normals[3*r+1]=i.y,this._normals[3*r+2]=i.z}},{key:"getNormal",value:function(e,t){var i=t*this._info.vertexCount[0]+e,r=new Vec3;return r.x=this._normals[3*i+0],r.y=this._normals[3*i+1],r.z=this._normals[3*i+2],r}},{key:"getNormalAt",value:function(e,t){var i=e/this._info.vertexCount[0],r=t/this._info.vertexCount[1],n=Math.floor(i),s=Math.floor(r),a=n+1,o=s+1,c=i-n,l=r-s;if(n<0||n>this._info.vertexCount[0]-1||s<0||s>this._info.vertexCount[1]-1)return null;n=clamp(n,0,this._info.vertexCount[0]-1),s=clamp(s,0,this._info.vertexCount[1]-1),a=clamp(a,0,this._info.vertexCount[0]-1),o=clamp(o,0,this._info.vertexCount[1]-1);var u=this.getNormal(n,s),h=this.getNormal(a,s),_=this.getNormal(n,o),p=this.getNormal(a,o),d=new Vec3;Vec3.add(d,h,_).multiplyScalar(.5),c+l<=1?(p.set(d),p.subtract(u),p.add(d)):(u.set(d),u.subtract(p),u.add(d));var f=new Vec3,m=new Vec3,y=new Vec3;return Vec3.lerp(f,u,h,c),Vec3.lerp(m,_,p,c),Vec3.lerp(y,f,m,l),y}},{key:"setWeight",value:function(e,t,i){var r=t*this.info.weightMapSize*this.info.blockCount[0]+e;this._weights[4*r+0]=255*i.x,this._weights[4*r+1]=255*i.y,this._weights[4*r+2]=255*i.z,this._weights[4*r+3]=255*i.w}},{key:"getWeight",value:function(e,t){var i=t*this.info.weightMapSize*this.info.blockCount[0]+e,r=new Vec4;return r.x=this._weights[4*i+0]/255,r.y=this._weights[4*i+1]/255,r.z=this._weights[4*i+2]/255,r.w=this._weights[4*i+3]/255,r}},{key:"getWeightAt",value:function(e,t){var i=e/this._info.vertexCount[0],r=t/this._info.vertexCount[1],n=Math.floor(i),s=Math.floor(r),a=n+1,o=s+1,c=i-n,l=r-s;if(n<0||n>this._info.vertexCount[0]-1||s<0||s>this._info.vertexCount[1]-1)return null;n=clamp(n,0,this._info.vertexCount[0]-1),s=clamp(s,0,this._info.vertexCount[1]-1),a=clamp(a,0,this._info.vertexCount[0]-1),o=clamp(o,0,this._info.vertexCount[1]-1);var u=this.getWeight(n,s),h=this.getWeight(a,s),_=this.getWeight(n,o),p=this.getWeight(a,o),d=new Vec4;Vec4.add(d,h,_).multiplyScalar(.5),c+l<=1?(p=new Vec4,Vec4.subtract(p,d,u).add(d)):(u=new Vec4,Vec4.subtract(u,d,p).add(d));var f=new Vec4,m=new Vec4,y=new Vec4;return Vec4.lerp(f,u,h,c),Vec4.lerp(m,_,p,c),Vec4.lerp(y,f,m,l),y}},{key:"getBlockInfo",value:function(e,t){return this._blockInfos[t*this._info.blockCount[0]+e]}},{key:"getBlock",value:function(e,t){return this._blocks[t*this._info.blockCount[0]+e]}},{key:"getBlocks",value:function(){return this._blocks}},{key:"getSharedIndexBuffer",value:function(){return this._sharedIndexBuffer}},{key:"rayCheck",value:function(e,t,i){var r=0,n=e,s=null,a=new Vec3;if(a.set(t),a.multiplyScalar(i),t.equals(new Vec3(0,1,0))){var o=this.getHeightAt(n.x,n.z);null!=o&&n.y<=o&&(s=new Vec3(n.x,o,n.z))}else if(t.equals(new Vec3(0,-1,0))){var c=this.getHeightAt(n.x,n.z);null!=c&&n.y>=c&&(s=new Vec3(n.x,c,n.z))}else for(;r++<2e3;){var l=this.getHeightAt(n.x,n.z);if(null!=l&&n.y<=l){s=new Vec3(n.x,l,n.z);break}n.add(a)}return s}},{key:"_calcuNormal",value:function(e,t){var i,r,n=1,s=this.getPosition(e,t);i=e<this._info.vertexCount[0]-1?this.getPosition(e+1,t):(n*=-1,this.getPosition(e-1,t)),r=t<this._info.vertexCount[1]-1?this.getPosition(e,t+1):(n*=-1,this.getPosition(e,t-1)),i.subtract(s),r.subtract(s);var a=new Vec3;return a.set(r),a.cross(i),a.multiplyScalar(n),a.normalize(),a}},{key:"_buildNormals",value:function(){for(var e=0,t=0;t<this._info.vertexCount[1];++t)for(var i=0;i<this._info.vertexCount[0];++i){var r=this._calcuNormal(i,t);this._normals[3*e+0]=r.x,this._normals[3*e+1]=r.y,this._normals[3*e+2]=r.z,e+=1}}},{key:"_buildImp",value:function(){if(0<this._blocks.length)return!0;if(this._info.initialize(),0===this._info.blockCount[0]||0===this._info.blockCount[1])return!1;var e=this._info.vertexCount[0]*this._info.vertexCount[1];if(this._heights.length!==e){this._heights=new Array(e),this._normals=new Array(3*e);for(var t=0;t<e;++t)this._heights[t]=0,this._normals[3*t+0]=0,this._normals[3*t+1]=1,this._normals[3*t+2]=0}else this._normals=new Array(3*e),this._buildNormals();var i=this.info.weightMapSize*this.info.blockCount[0],r=this.info.weightMapSize*this.info.blockCount[1];if(this._weights.length!==i*r*4){this._weights=new Uint8Array(i*r*4);for(var n=0;n<i*r;++n)this._weights[4*n+0]=255,this._weights[4*n+1]=0,this._weights[4*n+2]=0,this._weights[4*n+3]=0}if(this._blockInfos.length!==this.info.blockCount[0]*this.info.blockCount[1]){this._blockInfos=[];for(var s=0;s<this.info.blockCount[1];++s)for(var a=0;a<this.info.blockCount[0];++a)this._blockInfos.push(new TerrainBlockInfo)}for(var o=0;o<this.info.blockCount[1];++o)for(var c=0;c<this.info.blockCount[0];++c)this._blocks.push(new TerrainBlock(this,c,o));var l=this._blocks,u=Array.isArray(l),h=0;for(l=u?l:l[Symbol.iterator]();;){var _;if(u){if(h>=l.length)break;_=l[h++]}else{if((h=l.next()).done)break;_=h.value}_.build()}}},{key:"_rebuildHeights",value:function(e){if(this.info.vertexCount[0]===e.vertexCount[0]&&this.info.vertexCount[1]===e.vertexCount[1])return!1;for(var t=new Array(e.vertexCount[0]*e.vertexCount[1]),i=0;i<t.length;++i)t[i]=0;for(var r=Math.min(this.info.vertexCount[0],e.vertexCount[0]),n=Math.min(this.info.vertexCount[1],e.vertexCount[1]),s=0;s<n;++s)for(var a=0;a<r;++a){var o=s*e.vertexCount[0]+a,c=s*this.info.vertexCount[0]+a;t[o]=this._heights[c]}return this._heights=t,!0}},{key:"_rebuildWeights",value:function(e){var g=this,t=this.info.weightMapSize,s=this.info.weightMapSize*this.info.blockCount[0],i=this.info.weightMapSize*this.info.blockCount[1],r=e.weightMapSize*e.blockCount[0],n=e.weightMapSize*e.blockCount[1];if(r==s&&n==i)return!1;for(var a=new Uint8Array(r*n*4),o=0;o<r*n;++o)a[4*o+0]=255,a[4*o+1]=0,a[4*o+2]=0,a[4*o+3]=0;for(var c=Math.min(e.blockCount[0],this.info.blockCount[0]),l=Math.min(e.blockCount[1],this.info.blockCount[1]),b=function(e,t,i){var r=t*s+e,n=new Vec4;return n.x=i[4*r+0]/255,n.y=i[4*r+1]/255,n.z=i[4*r+2]/255,n.w=i[4*r+3]/255,n},u=function(e,t,i,r,n){var s=Math.floor(e),a=Math.floor(t),o=s+1,c=a+1,l=e-s,u=t-a,h=b(s+i,a+r,g._weights),_=b(o+i,a+r,g._weights),p=b(s+i,c+r,g._weights),d=b(o+i,c+r,g._weights),f=new Vec4;Vec4.add(f,_,p).multiplyScalar(.5),l+u<=1?(d.set(f),d.subtract(h),d.add(f)):(h.set(f),h.subtract(d),h.add(f));var m=new Vec4,y=new Vec4,v=new Vec4;return Vec4.lerp(m,h,_,l),Vec4.lerp(y,p,d,l),Vec4.lerp(v,m,y,u),v},h=0;h<l;++h)for(var _=0;_<c;++_)for(var p=_*t,d=h*t,f=0;f<this.info.weightMapSize;++f)for(var m=0;m<this.info.weightMapSize;++m){var y=void 0;if(e.weightMapSize==t)y=b(m+p,f+d,this._weights);else y=u(m/(this.info.weightMapSize-1)*(t-1),f/(this.info.weightMapSize-1)*(t-1),p,d,this._weights);var v=_*this.info.weightMapSize+m,x=(h*this.info.weightMapSize+f)*r+v;a[4*x+0]=255*y.x,a[4*x+1]=255*y.y,a[4*x+2]=255*y.z,a[4*x+3]=255*y.w}return this._weights=a,!0}},{key:"info",get:function(){return this._info}}]),i}()).prototype,"_info",[_dec6$E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new TerrainInfo}}),_descriptor9$g=_applyDecoratedDescriptor(_class11$1.prototype,"_layers",[_dec7$u],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor10$f=_applyDecoratedDescriptor(_class11$1.prototype,"_heights",[_dec8$k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor11$d=_applyDecoratedDescriptor(_class11$1.prototype,"_weights",[_dec9$h],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Uint8Array}}),_descriptor12$c=_applyDecoratedDescriptor(_class11$1.prototype,"_blockInfos",[_dec10$f],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_class10$1=_class11$1))||_class10$1)||_class10$1)||_class10$1);exports.AffineTransform=AffineTransform,exports.AnimCurve=AnimCurve,exports.AnimationClip=AnimationClip,exports.AnimationComponent=AnimationComponent,exports.AnimationManager=AnimationManager,exports.AnimationState=AnimationState,exports.Asset=Asset,exports.AssetLibrary=AssetLibrary,exports.AudioClip=AudioClip,exports.AudioSourceComponent=AudioSourceComponent,exports.BaseNode=BaseNode,exports.BatchedSkinningModelComponent=BatchedSkinningModelComponent,exports.BillboardComponent=BillboardComponent,exports.BitMask=BitMask,exports.BitmapFont=BitmapFont,exports.BlockInputEventsComponent=BlockInputEventsComponent,exports.BoxColliderComponent=BoxColliderComponent,exports.ButtonComponent=ButtonComponent,exports.CCBoolean=CCBoolean,exports.CCClass=CCClass,exports.CCFloat=CCFloat,exports.CCInteger=CCInteger,exports.CCObject=CCObject,exports.CCString=CCString,exports.CameraComponent=CameraComponent,exports.CanvasComponent=CanvasComponent,exports.CanvasPool=CanvasPool,exports.CircularPool=CircularPool,exports.ColliderComponent=ColliderComponent,exports.Color=Color,exports.CompactValueTypeArray=CompactValueTypeArray,exports.Component=Component,exports.ComponentModifier=ComponentModifier,exports.ConstantForce=ConstantForce,exports.CubicSplineNumberValue=CubicSplineNumberValue,exports.CubicSplineQuatValue=CubicSplineQuatValue,exports.CubicSplineVec2Value=CubicSplineVec2Value,exports.CubicSplineVec3Value=CubicSplineVec3Value,exports.CubicSplineVec4Value=CubicSplineVec4Value,exports.CurveValueAdapter=CurveValueAdapter,exports.DirectionalLightComponent=DirectionalLightComponent,exports.Director=Director,exports.Downloader=Downloader,exports.EPSILON=EPSILON,exports.EditBoxComponent=EditBoxComponent,exports.EffectAsset=EffectAsset,exports.Enum=Enum,exports.Event=Event,exports.EventAcceleration=EventAcceleration,exports.EventHandler=EventHandler,exports.EventInfo=EventInfo,exports.EventKeyboard=EventKeyboard,exports.EventMouse=EventMouse,exports.EventTarget=EventTarget,exports.EventTouch=EventTouch,exports.FixedArray=FixedArray,exports.Font=Font,exports.GFXBuffer=GFXBuffer,exports.GFXBufferTextureCopy=GFXBufferTextureCopy,exports.GFXCommandBuffer=GFXCommandBuffer,exports.GFXDevice=GFXDevice,exports.GFXFormatInfos=GFXFormatInfos,exports.GFXFormatSize=GFXFormatSize,exports.GFXFormatSurfaceSize=GFXFormatSurfaceSize,exports.GFXFramebuffer=GFXFramebuffer,exports.GFXGetTypeSize=GFXGetTypeSize,exports.GFXInputAssembler=GFXInputAssembler,exports.GFXObject=GFXObject,exports.GFXPipelineLayout=GFXPipelineLayout,exports.GFXPipelineState=GFXPipelineState,exports.GFXQueue=GFXQueue,exports.GFXRenderPass=GFXRenderPass,exports.GFXSampler=GFXSampler,exports.GFXShader=GFXShader,exports.GFXTexture=GFXTexture,exports.GFXTextureCopy=GFXTextureCopy,exports.GFXTextureSubres=GFXTextureSubres,exports.GFXTextureView=GFXTextureView,exports.GFX_MAX_ATTACHMENTS=GFX_MAX_ATTACHMENTS,exports.GFX_MAX_BUFFER_BINDINGS=GFX_MAX_BUFFER_BINDINGS,exports.GFX_MAX_TEXTURE_UNITS=GFX_MAX_TEXTURE_UNITS,exports.GFX_MAX_VERTEX_ATTRIBUTES=GFX_MAX_VERTEX_ATTRIBUTES,exports.Game=Game,exports.GraphicsComponent=GraphicsComponent,exports.HeightField=HeightField,exports.HierachyModifier=HierachyModifier,exports.HtmlTextParser=HtmlTextParser,exports.ImageAsset=ImageAsset,exports.JavaScript=JavaScript,exports.JsonAsset=JsonAsset,exports.LabelAtlas=LabelAtlas,exports.LabelComponent=LabelComponent,exports.LabelOutlineComponent=LabelOutlineComponent,exports.Layers=Layers,exports.LayoutComponent=LayoutComponent,exports.LightComponent=LightComponent,exports.LineComponent=LineComponent,exports.LinkedArray=LinkedArray,exports.Loader=Loader,exports.LoadingItems=LoadingItems,exports.MaskComponent=MaskComponent,exports.Mat3=Mat3,exports.Mat4=Mat4,exports.Material=Material,exports.Mesh=Mesh,exports.MeshBuffer=MeshBuffer,exports.MissingScript=MissingScript,exports.ModelComponent=ModelComponent,exports.Node=Node$1,exports.NodeActivator=NodeActivator,exports.NodePool=NodePool,exports.PageViewComponent=PageViewComponent,exports.PageViewIndicatorComponent=PageViewIndicatorComponent,exports.ParticleSystemComponent=ParticleSystemComponent,exports.ParticleUtils=ParticleUtils,exports.PhysicMaterial=PhysicMaterial,exports.PhysicsRayResult=PhysicsRayResult,exports.PhysicsSystem=PhysicsSystem,exports.Pipeline=Pipeline,exports.Pool=Pool$1,exports.Prefab=Prefab,exports.PrefabInfo=PrefabInfo,exports.Primitive=Primitive,exports.PrivateNode=PrivateNode,exports.Profiler=Profiler,exports.ProgressBarComponent=ProgressBarComponent,exports.Quat=Quat,exports.RatioSampler=RatioSampler,exports.RawAsset=RawAsset,exports.Rect=Rect,exports.RecyclePool=RecyclePool,exports.RenderTexture=RenderTexture,exports.RenderableComponent=RenderableComponent,exports.ResolutionPolicy=ResolutionPolicy,exports.RichTextComponent=RichTextComponent,exports.RigidBodyComponent=RigidBodyComponent,exports.Scene=Scene,exports.SceneAsset=SceneAsset,exports.Scheduler=Scheduler,exports.Script=Script,exports.ScrollBarComponent=ScrollBarComponent,exports.ScrollViewComponent=ScrollViewComponent,exports.Size=Size,exports.SkelAnimDataHub=SkelAnimDataHub,exports.SkeletalAnimationComponent=SkeletalAnimationComponent,exports.SkeletalAnimationState=SkeletalAnimationState,exports.Skeleton=Skeleton,exports.SkinningModelComponent=SkinningModelComponent,exports.SkinningModelUnit=SkinningModelUnit,exports.SliderComponent=SliderComponent,exports.Socket=Socket,exports.SphereColliderComponent=SphereColliderComponent,exports.SphereLightComponent=SphereLightComponent,exports.SpotLightComponent=SpotLightComponent,exports.SpriteAtlas=SpriteAtlas,exports.SpriteComponent=SpriteComponent,exports.SpriteFrame=SpriteFrame,exports.StencilManager=StencilManager,exports.SubContextView=SubContextView,exports.System=System,exports.SystemEvent=SystemEvent,exports.TERRAIN_BLOCK_TILE_COMPLEXITY=TERRAIN_BLOCK_TILE_COMPLEXITY,exports.TERRAIN_BLOCK_VERTEX_COMPLEXITY=TERRAIN_BLOCK_VERTEX_COMPLEXITY,exports.TERRAIN_BLOCK_VERTEX_SIZE=TERRAIN_BLOCK_VERTEX_SIZE,exports.TERRAIN_EAST_INDEX=TERRAIN_EAST_INDEX,exports.TERRAIN_MAX_BLEND_LAYERS=TERRAIN_MAX_BLEND_LAYERS,exports.TERRAIN_MAX_LAYER_COUNT=TERRAIN_MAX_LAYER_COUNT,exports.TERRAIN_MAX_LEVELS=TERRAIN_MAX_LEVELS,exports.TERRAIN_NORTH_INDEX=TERRAIN_NORTH_INDEX,exports.TERRAIN_SOUTH_INDEX=TERRAIN_SOUTH_INDEX,exports.TERRAIN_WEST_INDEX=TERRAIN_WEST_INDEX,exports.TTFFont=TTFFont,exports.Terrain=Terrain,exports.TerrainBlock=TerrainBlock,exports.TerrainBlockInfo=TerrainBlockInfo,exports.TerrainInfo=TerrainInfo,exports.TerrainLayer=TerrainLayer,exports.TerrainRenderable=TerrainRenderable,exports.TerrainVertex=TerrainVertex,exports.TextAsset=TextAsset,exports.Texture2D=Texture2D,exports.TextureCube=TextureCube,exports.ToggleComponent=ToggleComponent,exports.ToggleContainerComponent=ToggleContainerComponent,exports.Touch=Touch,exports.Tween=Tween,exports.TypeScript=TypeScript,exports.TypedArrayPool=typedArrayPool,exports.UIComponent=UIComponent,exports.UIModelComponent=UIModelComponent,exports.UIRenderComponent=UIRenderComponent,exports.UIReorderComponent=UIReorderComponent,exports.UITransformComponent=UITransformComponent,exports.UIVertexFormat=UIVertexFormat,exports.UniformCurveValueAdapter=UniformCurveValueAdapter,exports.ValueType=ValueType,exports.Vec2=Vec2,exports.Vec3=Vec3,exports.Vec4=Vec4,exports.View=View,exports.ViewGroupComponent=ViewGroupComponent,exports.WebviewComponent=WebviewComponent,exports.WidgetComponent=WidgetComponent,exports.WorldNode3DToLocalNodeUI=WorldNode3DToLocalNodeUI,exports.WorldNode3DToWorldNodeUI=WorldNode3DToWorldNodeUI,exports._decorator=_decorator,exports.approx=approx,exports.assert=assert,exports.assertID=assertID,exports.barFilled=barFilled,exports.bezier=bezier,exports.bezierByTime=bezierByTime,exports.bits=bits,exports.bmfont=bmfont,exports.builtinResMgr=builtinResMgr,exports.cclegacy=cclegacy,exports.clamp=clamp,exports.clamp01=clamp01,exports.color=color,exports.computeRatioByType=computeRatioByType,exports.convertUtils=convertUtils,exports.deserialize=deserialize,exports.director=director,exports.easing=easing,exports.effects=effects$1,exports.equals=equals,exports.error=error,exports.errorID=errorID,exports.eventManager=eventManager,exports.find=find,exports.fragmentText=fragmentText,exports.game=game,exports.geometry=geometry,exports.getPathFromRoot=getPathFromRoot,exports.getWorldTransformUntilRoot=getWorldTransformUntilRoot,exports.graphics=graphicsAssembler,exports.graphicsAssembler=graphicsAssemblerManager,exports.instantiate=instantiate,exports.inverseLerp=inverseLerp,exports.isCustomTargetModifier=isCustomTargetModifier,exports.isDisplayStats=isDisplayStats,exports.isElementModifier=isElementModifier,exports.isPropertyModifier=isPropertyModifier,exports.isUnicodeCJK=isUnicodeCJK,exports.isUnicodeSpace=isUnicodeSpace,exports.isValid=isValid,exports.js=js$1,exports.labelAssembler=labelAssembler,exports.lerp=lerp,exports.letter=letter,exports.loader=loader,exports.log=log,exports.logID=logID,exports.macro=macro,exports.mask=maskAssembler,exports.maskEnd=maskEndAssembler,exports.mat4=mat4,exports.math=math,exports.misc=misc,exports.nextPow2=nextPow2$1,exports.path=path,exports.pingPong=pingPong,exports.primitives=primitives,exports.profiler=profiler,exports.pseudoRandom=pseudoRandom,exports.pseudoRandomRange=pseudoRandomRange,exports.pseudoRandomRangeInt=pseudoRandomRangeInt,exports.quat=quat,exports.radialFilled=radialFilled,exports.random=random,exports.randomRange=randomRange,exports.randomRangeInt=randomRangeInt,exports.rect=rect,exports.renderer=renderer,exports.repeat=repeat,exports.safeMeasureText=safeMeasureText,exports.sampleAnimationCurve=sampleAnimationCurve,exports.screen=screen$1,exports.setDefaultLogTimes=setDefaultLogTimes,exports.setDisplayStats=setDisplayStats,exports.simple=simple,exports.size=size,exports.sliced=sliced,exports.spriteAssembler=spriteAssembler,exports.systemEvent=systemEvent,exports.textureUtil=textureUtil,exports.toDegree=toDegree,exports.toRadian=toRadian,exports.ttf=ttf,exports.tween=tween,exports.tweenUtil=tweenUtil,exports.url=url,exports.utils=utils,exports.v2=v2,exports.v3=v3,exports.v4=v4,exports.view=view,exports.warn=warn,exports.warnID=warnID,exports.widgetManager=widgetManager;
