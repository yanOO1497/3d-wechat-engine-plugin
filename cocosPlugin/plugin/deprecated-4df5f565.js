System.register(["./deprecated-0768b3d4.js"],(function(e,t){"use strict";var i,n,r,s,a,o,h,u,l,_,c,d,f,p,m,g,v,E,T,A,S,y,R,I,O,N,C,b,w,L,M,P,B,F,x,D,U,G,H,k,z,V,W,Y,X,j,K,Z,Q,q,J,$,ee,te,ie,ne,re,se,ae,oe,he,ue,le,_e,ce,de,fe,pe,me,ge,ve,Ee,Te,Ae,Se,ye,Re,Ie,Oe,Ne,Ce,be,we,Le,Me,Pe,Be,Fe,xe,De,Ue,Ge,He;return{setters:[function(e){i=e.aV,n=e.aW,r=e.V,s=e.a,a=e._,o=e.S,h=e.aB,u=e.l,l=e.aC,_=e.a3,c=e.a2,d=e.ac,f=e.Z,p=e.a0,m=e.at,g=e.E,v=e.aE,E=e.g,T=e.ar,A=e.aq,S=e.as,y=e.aX,R=e.Q,I=e.c,O=e.b,N=e.s,C=e.T,b=e.e,w=e.i,L=e.y,M=e.A,P=e.o,B=e.f,F=e.z,x=e.aY,D=e.aU,U=e.t,G=e.av,H=e.aZ,k=e.a_,z=e.w,V=e.a$,W=e.b0,Y=e.b1,X=e.W,j=e.a8,K=e.a6,Z=e.b2,Q=e.b3,q=e.b4,J=e.b5,$=e.h,ee=e.m,te=e.b6,ie=e.d,ne=e.C,re=e.aL,se=e.x,ae=e.B,oe=e.aF,he=e.b7,ue=e.b8,le=e.k,_e=e.b9,ce=e.n,de=e.ba,fe=e.bb,pe=e.bc,me=e.q,ge=e.af,ve=e.aK,Ee=e.R,Te=e.p,Ae=e.P,Se=e.aa,ye=e.ap,Re=e.bd,Ie=e.ag,Oe=e.ah,Ne=e.aD,Ce=e.be,be=e.bf,we=e.bg,Le=e.bh,Me=e.a9,Pe=e.bi,Be=e.aS,Fe=e.aT,xe=e.bj,De=e.aM,Ue=e.bk,Ge=e.bl,He=e.bm}],execute:function(){e({C:void 0,F:void 0,H:void 0,L:void 0,M:void 0,P:void 0,Y:void 0,Z:void 0,_:void 0,a:void 0,a$:void 0,a8:Wu,a9:Yu,aD:void 0,aF:void 0,aH:void 0,aJ:void 0,aL:void 0,aN:void 0,aP:void 0,aR:void 0,aT:void 0,aV:void 0,aX:void 0,aZ:void 0,aa:void 0,ac:ll,ae:void 0,ag:Po,ai:Sl,an:Pt,ao:void 0,b:void 0,b1:void 0,b3:void 0,b5:void 0,b7:void 0,b9:void 0,bC:dr,bD:CT,bE:bT,b_:void 0,bb:void 0,bd:void 0,bf:void 0,bh:void 0,bj:sd,bk:ad,bn:function(e){for(var t=e,i=0;i<(arguments.length<=1?0:arguments.length-1);++i){var n=i+1<1||arguments.length<=i+1?void 0:arguments[i+1];if(sd(n)){if(!(n in t))return z('Target object has no property "'+n+'"'),null;t=t[n]}else t=n.get(t);if(null===t)break}return t},bo:Mg,bt:function(){return 0},bu:function(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)},bv:function(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t},bw:function(e,t,i){var n=(i||e.font)+"ðŸŽ®"+t,r=Wa.get(n);if(null!==r)return r;var s=e.measureText(t),a=s&&s.width||0;return Wa.put(n,a),a},bx:function(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var s=e;t>i&&s.length>1;){for(var a=s.length*(i/t)|0,o=Qa(s,a),h=t-n(o),u=o,l=0,_=0;h>i&&_++<10;)a*=i/h,h=t-n(o=Qa(s,a|=0));for(_=0;h<=i&&_++<10;){if(o){var c=Ya.exec(o);l=c?c[0].length:1,u=o}h=t-n(o=Qa(s,a+=l))}0==(a-=l)?(a=1,u=Qa(s,1)):1===a&&s[0]>="\ud800"&&s[0]<="\udbff"&&(a=2,u=Qa(s,2));var d=Qa(s,0,a),f=void 0;Xa.test(u||o)&&(0==(a-=(f=ja.exec(d))?f[0].length:0)&&(a=1),u=Qa(s,a),d=Qa(s,0,a)),Za.test(u)&&(f=Ka.exec(d))&&d!==f[0]&&(u=Qa(s,a-=f[0].length),d=Qa(s,0,a)),(0===r.length||(d=d.trim()).length>0)&&r.push(d),t=n(s=u||o)}return(0===r.length||(s=s.trim()).length>0)&&r.push(s),r},c:function(e,t,i,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===i&&(i=2),void 0===n&&(n={});var s=.5*i,a=n.radialSegments||32,o=n.heightSegments||1,h=void 0===n.capped||n.capped,u=n.arc||2*Math.PI,l=0;h||(e>0&&l++,t>0&&l++);var _=(a+1)*(o+1);h&&(_+=(a+1)*l+a*l);var c=a*o*6;h&&(c+=a*l*3);var d=new Array(c),f=new Array(3*_),p=new Array(3*_),m=new Array(2*_),g=Math.max(e,t),v=new r(-g,-s,-g),E=new r(g,s,g),T=Math.sqrt(g*g+s*s),A=0,S=0;return function(){for(var n=[],h=e-t,l=h*h/i*Math.sign(h),_=0;_<=o;_++){for(var c=[],g=_/o,v=g*h+t,E=0;E<=a;++E){var T=E/a,y=T*u,R=Math.sin(y),I=Math.cos(y);f[3*A]=v*R,f[3*A+1]=g*i-s,f[3*A+2]=v*I,r.normalize(tv,r.set(iv,R,-l,I)),p[3*A]=tv.x,p[3*A+1]=tv.y,p[3*A+2]=tv.z,m[2*A]=2*(1-T)%1,m[2*A+1]=g,c.push(A),++A}n.push(c)}for(var O=0;O<o;++O)for(var N=0;N<a;++N){var C=n[O][N],b=n[O+1][N],w=n[O+1][N+1],L=n[O][N+1];d[S]=C,++S,d[S]=L,++S,d[S]=b,++S,d[S]=L,++S,d[S]=w,++S,d[S]=b,++S}}(),h&&(t>0&&y(!1),e>0&&y(!0)),{positions:f,normals:p,uvs:m,indices:d,minPos:v,maxPos:E,boundingRadius:T};function y(i){for(var n=i?e:t,r=i?1:-1,o=A,h=1;h<=a;++h)f[3*A]=0,f[3*A+1]=s*r,f[3*A+2]=0,p[3*A]=0,p[3*A+1]=r,p[3*A+2]=0,m[2*A]=.5,m[2*A+1]=.5,++A;for(var l=A,_=0;_<=a;++_){var c=_/a*u,g=Math.cos(c),v=Math.sin(c);f[3*A]=n*v,f[3*A+1]=s*r,f[3*A+2]=n*g,p[3*A]=0,p[3*A+1]=r,p[3*A+2]=0,m[2*A]=.5-.5*v*r,m[2*A+1]=.5+.5*g,++A}for(var E=0;E<a;++E){var T=o+E,y=l+E;i?(d[S]=y+1,++S,d[S]=T,++S,d[S]=y,++S):(d[S]=T,++S,d[S]=y+1,++S,d[S]=y,++S)}}},cA:void 0,cB:void 0,cC:void 0,cD:void 0,cE:void 0,cF:void 0,cG:void 0,cH:void 0,cI:void 0,cJ:void 0,cK:void 0,cO:jn,cP:Kn,cd:void 0,cf:void 0,cg:void 0,ch:void 0,ci:void 0,cj:void 0,ck:void 0,cl:void 0,cm:void 0,cn:void 0,co:void 0,cp:void 0,cq:void 0,cr:void 0,cs:void 0,ct:void 0,cu:void 0,cv:void 0,cw:void 0,cx:void 0,cy:void 0,cz:void 0,d:Pg,d$:void 0,dS:bg,dY:function(e,t){for(var i=e,n="";null!==i&&i!==t;)n=i.name+"/"+n,i=i.parent;return n.slice(0,-1)},dZ:_d,e:Bg,eA:function(e,t){void 0===t&&(t=0);for(var i,n={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),s=e.struct,a=s.primitives[t],o=R(a.vertexBundelIndices);!(i=o()).done;)for(var h,u=i.value,l=s.vertexBundles[u],_=l.view.offset,c=l.view,d=c.length,f=c.stride,p=R(l.attributes);!(h=p()).done;){var m=h.value,g=Ng[m.name];g&&(n[g]=(n[g]||[]).concat(mo(r,m.format,_,d,f))),_+=Xn[m.format].size}var v=a.indexView;return n.indices=mo(r,hn["R"+8*v.stride+"UI"],v.offset,v.length),n},eB:mo,eC:po,eD:go,eE:void 0,eF:function(e){return"function"==typeof e.lerp},eG:void 0,eI:void 0,eJ:void 0,eL:Zr,eM:qn,eN:void 0,ea:void 0,eb:void 0,ec:void 0,eq:void 0,f:function(e,t,i,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===i&&(i=2),void 0===n&&(n={});var s=i-e-t,a=n.sides||32,o=n.heightSegments||32,h=t/i,u=s/i,l=e/i,_=Math.floor(o*h),c=Math.floor(o*l),d=Math.floor(o*u),f=s+t-i/2,p=t-i/2,m=t-i/2,g=n.arc||2*Math.PI,v=[],E=[],T=[],A=[],S=Math.max(e,t),y=new r(-S,-i/2,-S),R=new r(S,i/2,S),I=i/2,O=0,N=[];return function(){for(var e=0;e<=_;++e)for(var i=e*Math.PI/_/2,n=Math.sin(i),r=-Math.cos(i),s=0;s<=a;++s){var h=2*s*Math.PI/a-Math.PI/2,u=Math.sin(h)*n,l=r,c=Math.cos(h)*n,d=s/a,f=e/o;if(v.push(u*t,l*t+m,c*t),E.push(u,l,c),T.push(d,f),e<_&&s<a){var p=a+1,g=p*e+s,S=p*(e+1)+s,y=p*(e+1)+s+1,R=p*e+s+1;A.push(g,R,S),A.push(R,y,S)}++O}}(),function(){for(var i=(e-t)/s,n=0;n<=d;n++){for(var o=[],l=n/d,_=l*(e-t)+t,c=0;c<=a;++c){var f=c/a,m=l*u+h,S=f*g-g/4,y=Math.sin(S),R=Math.cos(S);v.push(_*y),v.push(l*s+p),v.push(_*R),r.normalize(lv,r.set(_v,y,-i,R)),E.push(lv.x),E.push(lv.y),E.push(lv.z),T.push(f,m),o.push(O),++O}N.push(o)}for(var I=0;I<d;++I)for(var C=0;C<a;++C){var b=N[I][C],w=N[I+1][C],L=N[I+1][C+1],M=N[I][C+1];A.push(b),A.push(M),A.push(w),A.push(M),A.push(L),A.push(w)}}(),function(){for(var t=0;t<=c;++t)for(var i=t*Math.PI/c/2+Math.PI/2,n=Math.sin(i),r=-Math.cos(i),s=0;s<=a;++s){var h=2*s*Math.PI/a-Math.PI/2,u=Math.sin(h)*n,_=r,p=Math.cos(h)*n,m=s/a,g=t/o+(1-l);if(v.push(u*e,_*e+f,p*e),E.push(u,_,p),T.push(m,g),t<c&&s<a){var S=a+1,y=S*t+s+N[d][a]+1,R=S*(t+1)+s+N[d][a]+1,I=S*(t+1)+s+1+N[d][a]+1,O=S*t+s+1+N[d][a]+1;A.push(y,O,R),A.push(O,I,R)}}}(),{positions:v,normals:E,uvs:T,indices:A,minPos:y,maxPos:R,boundingRadius:I}},i:Xv,k:jv,l:Kv,p:function(e){var t=function(e){return(e=Pg(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),i=t.width,n=t.length,s=t.widthSegments,a=t.lengthSegments,o=.5*i,h=.5*n,u=[],l=[],_=[],c=new r(-o,0,-h),d=new r(o,0,h),f=Math.sqrt(i*i+n*n);r.set(ov,-o,0,h),r.set(hv,o,0,h),r.set(uv,-o,0,-h);for(var p=0;p<=a;p++)for(var m=0;m<=s;m++){var g=m/s,v=p/a;if(r.lerp(nv,ov,hv,g),r.lerp(rv,ov,uv,v),r.subtract(sv,rv,ov),r.add(av,nv,sv),u.push(av.x,av.y,av.z),t.includeUV&&l.push(g,v),m<s&&p<a){var E=s+1,T=m+p*E,A=m+(p+1)*E,S=m+1+(p+1)*E,y=m+1+p*E;_.push(T,y,A),_.push(y,S,A)}}var R={positions:u,indices:_,minPos:c,maxPos:d,boundingRadius:f};if(t.includeNormal){var I=(a+1)*(s+1),O=new Array(3*I);R.normals=O;for(var N=0;N<I;++N)O[3*N+0]=0,O[3*N+1]=1,O[3*N+2]=0}return t.includeUV&&(R.uvs=l),R},q:void 0,r:void 0,s:fd,t:void 0,v:void 0,z:$p}),e("e6",i("requireComponent"));var ke=e("e5",i("executionOrder")),ze=e("e7",n),Ve=e("ee",{SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512}),We=new r,Ye=new r,Xe=new r,je=new r,Ke=new r,Ze=new r,Qe=new Array(3),qe=new Array(3);function Je(e,t){return r.dot(t.n,e)-t.d}function $e(e,t,i){return r.copy(e,t),r.subtract(Ke,i.center,i.halfExtents),r.add(Ze,i.center,i.halfExtents),e.x=e.x<Ke.x?Ke.x:e.x,e.y=e.y<Ke.y?Ke.y:e.y,e.z=e.z<Ke.z?Ke.z:e.z,e.x=e.x>Ze.x?Ze.x:e.x,e.y=e.y>Ze.y?Ze.y:e.y,e.z=e.z>Ze.z?Ze.z:e.z,e}function et(e,t,i){r.set(We,i.orientation.m00,i.orientation.m01,i.orientation.m02),r.set(Ye,i.orientation.m03,i.orientation.m04,i.orientation.m05),r.set(Xe,i.orientation.m06,i.orientation.m07,i.orientation.m08),Qe[0]=We,Qe[1]=Ye,Qe[2]=Xe,qe[0]=i.halfExtents.x,qe[1]=i.halfExtents.y,qe[2]=i.halfExtents.z,r.subtract(je,t,i.center),r.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var s=r.dot(je,Qe[n]);s>qe[n]&&(s=qe[n]),s<-qe[n]&&(s=-qe[n]),e.x+=s*Qe[n].x,e.y+=s*Qe[n].y,e.z+=s*Qe[n].z}return e}e("ed",Object.freeze({__proto__:null,point_plane:Je,pt_point_plane:function(e,t,i){var n=Je(t,i);return r.subtract(e,t,r.multiplyScalar(e,i.n,n))},pt_point_aabb:$e,pt_point_obb:et,pt_point_line:function(e,t,i,n){r.subtract(We,i,n);var s=We,a=r.lengthSqr(s);if(0==a)r.copy(e,i);else{r.subtract(We,t,i);var o=r.dot(We,s)/a;o<0?r.copy(e,i):o>1?r.copy(e,n):r.scaleAndAdd(e,i,s,o)}}}));var tt,it,nt,rt,st,at,ot,ht,ut,lt,_t,ct,dt,ft,pt,mt,gt,vt,Et,Tt,At,St,yt,Rt=e("e0",function(){function e(e,t,i,n,s,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===s&&(s=0),void 0===a&&(a=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Ve.SHAPE_RAY,this.o=new r(e,t,i),this.d=new r(n,s,a)}return e.create=function(t,i,n,r,s,a){return void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=0),void 0===a&&(a=1),new e(t,i,n,r,s,a)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return r.copy(e.o,t.o),r.copy(e.d,t.d),e},e.fromPoints=function(e,t,i){return r.copy(e.o,t),r.normalize(e.d,r.subtract(e.d,i,t)),e},e.set=function(e,t,i,n,r,s,a){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=s,e.d.z=a,e},s(e,[{key:"type",get:function(){return this._type}}]),e.prototype.computeHit=function(e,t){r.normalize(e,this.d),r.scaleAndAdd(e,this.o,e,t)},e}()),It=function(){function e(e,t,i){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=i*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}(),Ot=function(){},Nt=function(){function e(){}var t=e.prototype;return t.alloc=function(e,t){return new ArrayBuffer(t)},t.free=function(){},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(yt||(yt={}));var Ct,bt=function(){function e(e,t,i,n){void 0===n&&(n=8),this._dataType=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freelists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=n,this._dataType=t,this._stride=4*this._elementCount,this._entriesPerChunk=1<<n,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new It(e,n,this._stride);var r=yt.NEVER,s=!1,a=!1;for(var o in t){if(s=this._hasFloat32,(a=this._hasUint32)&&s)break;r=t[o],s||r!==yt.FLOAT32?a||r!==yt.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freelists.length;e++){var t=this._freelists[e];if(t.length){var i=t[t.length-1];return t.length--,(e<<this._entryBits)+i+this._poolFlag}}for(var n=this._nativePool.allocateNewChunk(),r=[],s=[],a=[],o=this._hasFloat32,h=this._hasUint32,u=0;u<this._entriesPerChunk;u++)o&&r.push(new Float32Array(n,this._stride*u,this._elementCount)),h&&s.push(new Uint32Array(n,this._stride*u,this._elementCount)),u&&a.push(u);return this._arrayBuffers.push(n),h&&this._uint32BufferViews.push(s),o&&this._float32BufferViews.push(r),this._freelists.push(a),(e<<this._entryBits)+this._poolFlag},t.get=function(e,t){var i=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._dataType[t]===yt.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][n][t]},t.set=function(e,t,i){var n=(this._chunkMask&e)>>this._entryBits,r=this._entryMask&e;(this._dataType[t]===yt.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][r][t]=i},t.setVec2=function(){},t.setVec3=function(){},t.setVec4=function(){},t.setMat4=function(){},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][i].fill(0),this._freelists[t].push(i)},e}(),wt=e("am",function(){function e(e,t,i){this._ctor=void 0,this._dtor=void 0,this._indexMask=void 0,this._poolFlag=void 0,this._array=[],this._freelist=[],this._nativePool=void 0,this._ctor=t,i&&(this._dtor=i),this._poolFlag=1<<29,this._indexMask=~this._poolFlag,this._nativePool=new Ot(e,this._array)}var t=e.prototype;return t.alloc=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=this._freelist,r=-1;if(n.length)r=n[n.length-1],n.length--,this._array[r]=this._ctor(arguments,this._array[r]);else{r=this._array.length;var s=this._ctor(arguments);if(!s)return 0;this._array.push(s)}return r+this._poolFlag},t.get=function(e){var t=this._indexMask&e;return this._array[t]},t.free=function(e){var t=this._indexMask&e;this._dtor&&(this._array[t]=this._dtor(this._array[t])),this._freelist.push(t)},e}()),Lt=function(){function e(e){this._nativeBufferAllocator=void 0,this._buffers=new Map,this._nextBufferIdx=0,this._poolFlag=void 0,this._bufferIdxMask=void 0,this._poolFlag=1<<30,this._bufferIdxMask=~this._poolFlag,this._nativeBufferAllocator=new Nt(e)}var t=e.prototype;return t.alloc=function(e){var t=this._nextBufferIdx++,i=this._nativeBufferAllocator.alloc(t,e);return this._buffers.set(t,i),t|this._poolFlag},t.free=function(e){var t=this._bufferIdxMask&e;this._buffers.get(t)&&(this._nativeBufferAllocator.free(t),this._buffers.delete(t))},t.getBuffer=function(e){var t=this._bufferIdxMask&e;return this._buffers.get(t)||null},e}(),Mt=function(e){function t(t,i,n,r){var s;return(s=e.call(this,t)||this)._viewCtor=void 0,s._size=void 0,s._step=void 0,s._viewCtor=i,s._size=n*i.BYTES_PER_ELEMENT,s._step=r||n,s}a(t,e);var i=t.prototype;return i.alloc=function(){var e=this._nextBufferIdx++,t=this._nativeBufferAllocator.alloc(e,this._size);return this._buffers.set(e,new this._viewCtor(t)),e|this._poolFlag},i.getBuffer=function(){return null},i.assign=function(e,t,i){var n=this._bufferIdxMask&e,r=this._buffers.get(n);if(r){var s=t+1;if(s>=r.length){for(var a=r.length;s>=a;)a+=this._step;a*=this._viewCtor.BYTES_PER_ELEMENT;var o=new this._viewCtor(this._nativeBufferAllocator.alloc(n,a));o.set(r),r=o,this._buffers.set(n,r)}r[s]=i;var h=r[0];r[0]=s>h?s:h}},i.erase=function(e,t){var i=this._bufferIdxMask&e,n=this._buffers.get(i);if(n&&!(t>=n[0])){for(var r=t+1;r<n[0];++r)n[r]=n[r+1];--n[0]}},i.push=function(e,t){var i=this._bufferIdxMask&e,n=this._buffers.get(i);n&&this.assign(e,n[0],t)},i.pop=function(e){var t=this._bufferIdxMask&e,i=this._buffers.get(t);i&&0!==i[0]&&--i[0]},i.clear=function(e){var t=this._bufferIdxMask&e,i=this._buffers.get(t);i&&(i[0]=0)},i.get=function(e,t){var i=this._bufferIdxMask&e,n=this._buffers.get(i);return!n||t>=n[0]?0:n[t+1]},i.length=function(e){var t=this._bufferIdxMask&e,i=this._buffers.get(t);return i?i[0]:0},t}(Lt);function Pt(e,t,i,n){void 0===n&&(n=!0);for(var r=t.length(e),s=0;s<r;s++){var a=t.get(e,s);a&&i.free(a)}n?t.free(e):t.clear(e)}!function(e){e[e.ATTRIBUTE=0]="ATTRIBUTE",e[e.DESCRIPTOR_SETS=1]="DESCRIPTOR_SETS",e[e.SHADER=2]="SHADER",e[e.INPUT_ASSEMBLER=3]="INPUT_ASSEMBLER",e[e.PIPELINE_LAYOUT=4]="PIPELINE_LAYOUT",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.PASS=100]="PASS",e[e.SUB_MODEL=101]="SUB_MODEL",e[e.MODEL=102]="MODEL",e[e.SCENE=103]="SCENE",e[e.CAMERA=104]="CAMERA",e[e.NODE=105]="NODE",e[e.ROOT=106]="ROOT",e[e.AABB=107]="AABB",e[e.RENDER_WINDOW=108]="RENDER_WINDOW",e[e.FRUSTUM=109]="FRUSTUM",e[e.AMBIENT=110]="AMBIENT",e[e.FOG=111]="FOG",e[e.SKYBOX=112]="SKYBOX",e[e.SHADOW=113]="SHADOW",e[e.LIGHT=114]="LIGHT",e[e.SPHERE=115]="SPHERE",e[e.INSTANCED_ATTRIBUTE=116]="INSTANCED_ATTRIBUTE",e[e.FLAT_BUFFER=117]="FLAT_BUFFER",e[e.SUB_MESH=118]="SUB_MESH",e[e.RASTERIZER_STATE=119]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=120]="DEPTH_STENCIL_STATE",e[e.BLEND_TARGET=121]="BLEND_TARGET",e[e.BLEND_STATE=122]="BLEND_STATE",e[e.SUB_MODEL_ARRAY=200]="SUB_MODEL_ARRAY",e[e.MODEL_ARRAY=201]="MODEL_ARRAY",e[e.ATTRIBUTE_ARRAY=202]="ATTRIBUTE_ARRAY",e[e.FLAT_BUFFER_ARRAY=203]="FLAT_BUFFER_ARRAY",e[e.INSTANCED_BUFFER_ARRAY=204]="INSTANCED_BUFFER_ARRAY",e[e.LIGHT_ARRAY=205]="LIGHT_ARRAY",e[e.BLEND_TARGET_ARRAY=206]="BLEND_TARGET_ARRAY",e[e.RAW_BUFFER=300]="RAW_BUFFER",e[e.RAW_OBJECT=400]="RAW_OBJECT"}(Ct||(Ct=e("ao",{})));var Bt,Ft=e("ap",0),xt=e("aq",new wt(Ct.SHADER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createShader(e[1])}),(function(e){return e&&e.destroy(),e}))),Dt=e("ar",new wt(Ct.DESCRIPTOR_SETS,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createDescriptorSet(e[1])}),(function(e){return e&&e.destroy(),e}))),Ut=e("as",new wt(Ct.INPUT_ASSEMBLER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createInputAssembler(e[1])}),(function(e){return e&&e.destroy(),e}))),Gt=e("at",new wt(Ct.PIPELINE_LAYOUT,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createPipelineLayout(e[1])}),(function(e){return e&&e.destroy(),e}))),Ht=(e("au",new wt(Ct.FRAMEBUFFER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createFramebuffer(e[1])}),(function(e){return e&&e.destroy(),e}))),e("av",new Mt(Ct.SUB_MODEL_ARRAY,Uint32Array,8,4))),kt=e("aw",new Mt(Ct.MODEL_ARRAY,Uint32Array,32,16)),zt=e("ax",new Mt(Ct.ATTRIBUTE_ARRAY,Uint32Array,8,4)),Vt=e("ay",new Mt(Ct.FLAT_BUFFER_ARRAY,Uint32Array,8,4)),Wt=e("az",new Mt(Ct.LIGHT_ARRAY,Uint32Array,8,4)),Yt=(e("aA",new Mt(Ct.BLEND_TARGET_ARRAY,Uint32Array,8,4)),e("aB",new Lt(Ct.RAW_BUFFER)));e("aC",new wt(Ct.RAW_OBJECT,(function(e){return e[0]||{}}),(function(){}))),function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.BATCHING_SCHEME=3]="BATCHING_SCHEME",e[e.PRIMITIVE=4]="PRIMITIVE",e[e.DYNAMIC_STATES=5]="DYNAMIC_STATES",e[e.HASH=6]="HASH",e[e.RASTERIZER_STATE=7]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=8]="DEPTH_STENCIL_STATE",e[e.BLEND_STATE=9]="BLEND_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.PIPELINE_LAYOUT=11]="PIPELINE_LAYOUT",e[e.COUNT=12]="COUNT"}(Bt||(Bt=e("aD",{})));var Xt,jt=((tt={})[Bt.PRIORITY]=yt.UINT32,tt[Bt.STAGE]=yt.UINT32,tt[Bt.PHASE]=yt.UINT32,tt[Bt.BATCHING_SCHEME]=yt.UINT32,tt[Bt.PRIMITIVE]=yt.UINT32,tt[Bt.DYNAMIC_STATES]=yt.UINT32,tt[Bt.HASH]=yt.UINT32,tt[Bt.RASTERIZER_STATE]=yt.UINT32,tt[Bt.DEPTH_STENCIL_STATE]=yt.UINT32,tt[Bt.BLEND_STATE]=yt.UINT32,tt[Bt.DESCRIPTOR_SET]=yt.UINT32,tt[Bt.PIPELINE_LAYOUT]=yt.UINT32,tt[Bt.COUNT]=yt.NEVER,tt),Kt=e("aE",new bt(Ct.PASS,jt,Bt));!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.PASS_COUNT=1]="PASS_COUNT",e[e.PASS_0=2]="PASS_0",e[e.PASS_1=3]="PASS_1",e[e.PASS_2=4]="PASS_2",e[e.PASS_3=5]="PASS_3",e[e.SHADER_0=6]="SHADER_0",e[e.SHADER_1=7]="SHADER_1",e[e.SHADER_2=8]="SHADER_2",e[e.SHADER_3=9]="SHADER_3",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.SUB_MESH=12]="SUB_MESH",e[e.COUNT=13]="COUNT"}(Xt||(Xt=e("aF",{})));var Zt,Qt=((it={})[Xt.PRIORITY]=yt.UINT32,it[Xt.PASS_COUNT]=yt.UINT32,it[Xt.PASS_0]=yt.UINT32,it[Xt.PASS_1]=yt.UINT32,it[Xt.PASS_2]=yt.UINT32,it[Xt.PASS_3]=yt.UINT32,it[Xt.SHADER_0]=yt.UINT32,it[Xt.SHADER_1]=yt.UINT32,it[Xt.SHADER_2]=yt.UINT32,it[Xt.SHADER_3]=yt.UINT32,it[Xt.DESCRIPTOR_SET]=yt.UINT32,it[Xt.INPUT_ASSEMBLER]=yt.UINT32,it[Xt.SUB_MESH]=yt.UINT32,it[Xt.COUNT]=yt.NEVER,it),qt=e("aG",new bt(Ct.SUB_MODEL,Qt,Xt));!function(e){e[e.ENABLED=0]="ENABLED",e[e.VIS_FLAGS=1]="VIS_FLAGS",e[e.CAST_SHADOW=2]="CAST_SHADOW",e[e.RECEIVE_SHADOW=3]="RECEIVE_SHADOW",e[e.WORLD_BOUNDS=4]="WORLD_BOUNDS",e[e.NODE=5]="NODE",e[e.TRANSFORM=6]="TRANSFORM",e[e.SUB_MODEL_ARRAY=7]="SUB_MODEL_ARRAY",e[e.INSTANCED_BUFFER=8]="INSTANCED_BUFFER",e[e.INSTANCED_ATTR_ARRAY=9]="INSTANCED_ATTR_ARRAY",e[e.COUNT=10]="COUNT"}(Zt||(Zt=e("aH",{})));var Jt,$t=((nt={})[Zt.ENABLED]=yt.UINT32,nt[Zt.VIS_FLAGS]=yt.UINT32,nt[Zt.CAST_SHADOW]=yt.UINT32,nt[Zt.RECEIVE_SHADOW]=yt.UINT32,nt[Zt.WORLD_BOUNDS]=yt.UINT32,nt[Zt.NODE]=yt.UINT32,nt[Zt.TRANSFORM]=yt.UINT32,nt[Zt.SUB_MODEL_ARRAY]=yt.UINT32,nt[Zt.INSTANCED_BUFFER]=yt.UINT32,nt[Zt.INSTANCED_ATTR_ARRAY]=yt.UINT32,nt[Zt.COUNT]=yt.NEVER,nt),ei=e("aI",new bt(Ct.MODEL,$t,Zt));!function(e){e[e.CENTER=0]="CENTER",e[e.HALF_EXTENSION=3]="HALF_EXTENSION",e[e.COUNT=6]="COUNT"}(Jt||(Jt=e("aJ",{})));var ti,ii=((rt={})[Jt.CENTER]=yt.FLOAT32,rt[Jt.HALF_EXTENSION]=yt.FLOAT32,rt[Jt.COUNT]=yt.NEVER,rt),ni=e("aK",new bt(Ct.AABB,ii,Jt));!function(e){e[e.MAIN_LIGHT=0]="MAIN_LIGHT",e[e.MODEL_ARRAY=1]="MODEL_ARRAY",e[e.SPHERE_LIGHT_ARRAY=2]="SPHERE_LIGHT_ARRAY",e[e.SPOT_LIGHT_ARRAY=3]="SPOT_LIGHT_ARRAY",e[e.COUNT=4]="COUNT"}(ti||(ti=e("aL",{})));var ri,si=((st={})[ti.MAIN_LIGHT]=yt.UINT32,st[ti.MODEL_ARRAY]=yt.UINT32,st[ti.SPHERE_LIGHT_ARRAY]=yt.UINT32,st[ti.SPOT_LIGHT_ARRAY]=yt.UINT32,st[ti.COUNT]=yt.NEVER,st),ai=e("aM",new bt(Ct.SCENE,si,ti));!function(e){e[e.WIDTH=0]="WIDTH",e[e.HEIGHT=1]="HEIGHT",e[e.EXPOSURE=2]="EXPOSURE",e[e.CLEAR_FLAG=3]="CLEAR_FLAG",e[e.CLEAR_DEPTH=4]="CLEAR_DEPTH",e[e.CLEAR_STENCIL=5]="CLEAR_STENCIL",e[e.NODE=6]="NODE",e[e.SCENE=7]="SCENE",e[e.FRUSTUM=8]="FRUSTUM",e[e.FORWARD=9]="FORWARD",e[e.POSITION=12]="POSITION",e[e.VIEW_PORT=15]="VIEW_PORT",e[e.CLEAR_COLOR=19]="CLEAR_COLOR",e[e.MAT_VIEW=23]="MAT_VIEW",e[e.MAT_VIEW_PROJ=39]="MAT_VIEW_PROJ",e[e.MAT_VIEW_PROJ_INV=55]="MAT_VIEW_PROJ_INV",e[e.MAT_PROJ=71]="MAT_PROJ",e[e.MAT_PROJ_INV=87]="MAT_PROJ_INV",e[e.COUNT=103]="COUNT"}(ri||(ri=e("aN",{})));var oi,hi=((at={})[ri.WIDTH]=yt.UINT32,at[ri.HEIGHT]=yt.UINT32,at[ri.EXPOSURE]=yt.FLOAT32,at[ri.CLEAR_FLAG]=yt.UINT32,at[ri.CLEAR_DEPTH]=yt.FLOAT32,at[ri.CLEAR_STENCIL]=yt.UINT32,at[ri.NODE]=yt.UINT32,at[ri.SCENE]=yt.UINT32,at[ri.FRUSTUM]=yt.UINT32,at[ri.FORWARD]=yt.FLOAT32,at[ri.POSITION]=yt.FLOAT32,at[ri.VIEW_PORT]=yt.FLOAT32,at[ri.CLEAR_COLOR]=yt.FLOAT32,at[ri.MAT_VIEW]=yt.FLOAT32,at[ri.MAT_VIEW_PROJ]=yt.FLOAT32,at[ri.MAT_VIEW_PROJ_INV]=yt.FLOAT32,at[ri.MAT_PROJ]=yt.FLOAT32,at[ri.MAT_PROJ_INV]=yt.FLOAT32,at[ri.COUNT]=yt.NEVER,at),ui=e("aO",new bt(Ct.CAMERA,hi,ri));!function(e){e[e.FLAGS_CHANGED=0]="FLAGS_CHANGED",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.COUNT=28]="COUNT"}(oi||(oi=e("aP",{})));var li=((ot={})[oi.FLAGS_CHANGED]=yt.UINT32,ot[oi.LAYER]=yt.UINT32,ot[oi.WORLD_SCALE]=yt.FLOAT32,ot[oi.WORLD_POSITION]=yt.FLOAT32,ot[oi.WORLD_ROTATION]=yt.FLOAT32,ot[oi.WORLD_MATRIX]=yt.FLOAT32,ot[oi.COUNT]=yt.NEVER,ot);delete oi[oi.COUNT],oi[oi.COUNT=oi.LAYER+1]="COUNT";var _i,ci=e("aQ",new bt(Ct.NODE,li,oi));!function(e){e[e.CUMULATIVE_TIME=0]="CUMULATIVE_TIME",e[e.FRAME_TIME=1]="FRAME_TIME",e[e.COUNT=2]="COUNT"}(_i||(_i=e("aR",{})));var di,fi=((ht={})[_i.CUMULATIVE_TIME]=yt.FLOAT32,ht[_i.FRAME_TIME]=yt.FLOAT32,ht[_i.COUNT]=yt.NEVER,ht);e("aS",new bt(Ct.ROOT,fi,_i,1)),function(e){e[e.HAS_ON_SCREEN_ATTACHMENTS=0]="HAS_ON_SCREEN_ATTACHMENTS",e[e.HAS_OFF_SCREEN_ATTACHMENTS=1]="HAS_OFF_SCREEN_ATTACHMENTS",e[e.FRAMEBUFFER=2]="FRAMEBUFFER",e[e.COUNT=3]="COUNT"}(di||(di=e("aT",{})));var pi,mi=((ut={})[di.HAS_ON_SCREEN_ATTACHMENTS]=yt.UINT32,ut[di.HAS_OFF_SCREEN_ATTACHMENTS]=yt.UINT32,ut[di.FRAMEBUFFER]=yt.UINT32,ut[di.COUNT]=yt.NEVER,ut);e("aU",new bt(Ct.RENDER_WINDOW,mi,di,2)),function(e){e[e.VERTICES=0]="VERTICES",e[e.PLANES=24]="PLANES",e[e.COUNT=48]="COUNT"}(pi||(pi=e("aV",{})));var gi,vi=((lt={})[pi.VERTICES]=yt.FLOAT32,lt[pi.PLANES]=yt.FLOAT32,lt[pi.COUNT]=yt.NEVER,lt),Ei=e("aW",new bt(Ct.FRUSTUM,vi,pi));!function(e){e[e.ENABLE=0]="ENABLE",e[e.ILLUM=1]="ILLUM",e[e.SKY_COLOR=2]="SKY_COLOR",e[e.GROUND_ALBEDO=6]="GROUND_ALBEDO",e[e.COUNT=10]="COUNT"}(gi||(gi=e("aX",{})));var Ti=((_t={})[gi.ENABLE]=yt.UINT32,_t[gi.ILLUM]=yt.FLOAT32,_t[gi.SKY_COLOR]=yt.FLOAT32,_t[gi.GROUND_ALBEDO]=yt.FLOAT32,_t[gi.COUNT]=yt.NEVER,_t);delete gi[gi.COUNT],gi[gi.COUNT=gi.ILLUM+1]="COUNT";var Ai,Si=e("aY",new bt(Ct.AMBIENT,Ti,gi,1));!function(e){e[e.ENABLE=0]="ENABLE",e[e.IS_RGBE=1]="IS_RGBE",e[e.USE_IBL=2]="USE_IBL",e[e.MODEL=3]="MODEL",e[e.COUNT=4]="COUNT"}(Ai||(Ai=e("aZ",{})));var yi,Ri=((ct={})[Ai.ENABLE]=yt.UINT32,ct[Ai.IS_RGBE]=yt.UINT32,ct[Ai.USE_IBL]=yt.UINT32,ct[Ai.MODEL]=yt.UINT32,ct[Ai.COUNT]=yt.NEVER,ct),Ii=e("a_",new bt(Ct.SKYBOX,Ri,Ai,1));!function(e){e[e.ENABLE=0]="ENABLE",e[e.TYPE=1]="TYPE",e[e.DENSITY=2]="DENSITY",e[e.START=3]="START",e[e.END=4]="END",e[e.ATTEN=5]="ATTEN",e[e.TOP=6]="TOP",e[e.RANGE=7]="RANGE",e[e.COLOR=8]="COLOR",e[e.COUNT=12]="COUNT"}(yi||(yi=e("a$",{})));var Oi=((dt={})[yi.ENABLE]=yt.UINT32,dt[yi.TYPE]=yt.UINT32,dt[yi.DENSITY]=yt.FLOAT32,dt[yi.START]=yt.FLOAT32,dt[yi.END]=yt.FLOAT32,dt[yi.ATTEN]=yt.FLOAT32,dt[yi.TOP]=yt.FLOAT32,dt[yi.RANGE]=yt.FLOAT32,dt[yi.COLOR]=yt.FLOAT32,dt[yi.COUNT]=yt.NEVER,dt);delete yi[yi.COUNT],yi[yi.COUNT=yi.RANGE+1]="COUNT";var Ni,Ci=e("b0",new bt(Ct.FOG,Oi,yi));!function(e){e[e.ENABLE=0]="ENABLE",e[e.DIRTY=1]="DIRTY",e[e.TYPE=2]="TYPE",e[e.DISTANCE=3]="DISTANCE",e[e.INSTANCE_PASS=4]="INSTANCE_PASS",e[e.PLANAR_PASS=5]="PLANAR_PASS",e[e.PLANAR_SHADER=6]="PLANAR_SHADER",e[e.NEAR=7]="NEAR",e[e.FAR=8]="FAR",e[e.ASPECT=9]="ASPECT",e[e.PCF_TYPE=10]="PCF_TYPE",e[e.SHADOW_MAP_DIRTY=11]="SHADOW_MAP_DIRTY",e[e.BIAS=12]="BIAS",e[e.ORTHO_SIZE=13]="ORTHO_SIZE",e[e.AUTO_ADAPT=14]="AUTO_ADAPT",e[e.COLOR=15]="COLOR",e[e.SIZE=19]="SIZE",e[e.NORMAL=21]="NORMAL",e[e.MAT_LIGHT=24]="MAT_LIGHT",e[e.COUNT=40]="COUNT"}(Ni||(Ni=e("b1",{})));var bi=((ft={})[Ni.ENABLE]=yt.UINT32,ft[Ni.DIRTY]=yt.UINT32,ft[Ni.TYPE]=yt.UINT32,ft[Ni.DISTANCE]=yt.FLOAT32,ft[Ni.INSTANCE_PASS]=yt.UINT32,ft[Ni.PLANAR_PASS]=yt.UINT32,ft[Ni.PLANAR_SHADER]=yt.UINT32,ft[Ni.NEAR]=yt.FLOAT32,ft[Ni.FAR]=yt.FLOAT32,ft[Ni.ASPECT]=yt.FLOAT32,ft[Ni.PCF_TYPE]=yt.UINT32,ft[Ni.SHADOW_MAP_DIRTY]=yt.UINT32,ft[Ni.BIAS]=yt.FLOAT32,ft[Ni.ORTHO_SIZE]=yt.FLOAT32,ft[Ni.AUTO_ADAPT]=yt.UINT32,ft[Ni.COLOR]=yt.FLOAT32,ft[Ni.SIZE]=yt.FLOAT32,ft[Ni.NORMAL]=yt.FLOAT32,ft[Ni.MAT_LIGHT]=yt.FLOAT32,ft[Ni.COUNT]=yt.NEVER,ft);delete Ni[Ni.COUNT],Ni[Ni.COUNT=Ni.AUTO_ADAPT+1]="COUNT";var wi,Li=e("b2",new bt(Ct.SHADOW,bi,Ni,1));!function(e){e[e.USE_COLOR_TEMPERATURE=0]="USE_COLOR_TEMPERATURE",e[e.ILLUMINANCE=1]="ILLUMINANCE",e[e.NODE=2]="NODE",e[e.RANGE=3]="RANGE",e[e.TYPE=4]="TYPE",e[e.AABB=5]="AABB",e[e.FRUSTUM=6]="FRUSTUM",e[e.SIZE=7]="SIZE",e[e.SPOT_ANGLE=8]="SPOT_ANGLE",e[e.ASPECT=9]="ASPECT",e[e.DIRECTION=10]="DIRECTION",e[e.COLOR=13]="COLOR",e[e.COLOR_TEMPERATURE_RGB=16]="COLOR_TEMPERATURE_RGB",e[e.POSITION=19]="POSITION",e[e.COUNT=22]="COUNT"}(wi||(wi=e("b3",{})));var Mi,Pi=((pt={})[wi.USE_COLOR_TEMPERATURE]=yt.UINT32,pt[wi.ILLUMINANCE]=yt.FLOAT32,pt[wi.NODE]=yt.UINT32,pt[wi.RANGE]=yt.FLOAT32,pt[wi.TYPE]=yt.UINT32,pt[wi.AABB]=yt.UINT32,pt[wi.FRUSTUM]=yt.UINT32,pt[wi.SIZE]=yt.FLOAT32,pt[wi.SPOT_ANGLE]=yt.FLOAT32,pt[wi.ASPECT]=yt.FLOAT32,pt[wi.DIRECTION]=yt.FLOAT32,pt[wi.COLOR]=yt.FLOAT32,pt[wi.COLOR_TEMPERATURE_RGB]=yt.FLOAT32,pt[wi.POSITION]=yt.FLOAT32,pt[wi.COUNT]=yt.NEVER,pt),Bi=e("b4",new bt(Ct.LIGHT,Pi,wi,3));!function(e){e[e.RADIUS=0]="RADIUS",e[e.CENTER=1]="CENTER",e[e.COUNT=4]="COUNT"}(Mi||(Mi=e("b5",{})));var Fi=((mt={})[Mi.RADIUS]=yt.FLOAT32,mt[Mi.CENTER]=yt.FLOAT32,mt[Mi.COUNT]=yt.NEVER,mt);delete Mi[Mi.COUNT],Mi[Mi.COUNT=Mi.RADIUS+1]="COUNT";var xi,Di=e("b6",new bt(Ct.SPHERE,Fi,Mi,3));!function(e){e[e.STRIDE=0]="STRIDE",e[e.AMOUNT=1]="AMOUNT",e[e.BUFFER=2]="BUFFER",e[e.COUNT=3]="COUNT"}(xi||(xi=e("b7",{})));var Ui,Gi=((gt={})[xi.STRIDE]=yt.UINT32,gt[xi.AMOUNT]=yt.UINT32,gt[xi.BUFFER]=yt.UINT32,gt[xi.COUNT]=yt.NEVER,gt),Hi=e("b8",new bt(Ct.FLAT_BUFFER,Gi,xi,3));!function(e){e[e.FLAT_BUFFER_ARRAY=0]="FLAT_BUFFER_ARRAY",e[e.COUNT=1]="COUNT"}(Ui||(Ui=e("b9",{})));var ki,zi=((vt={})[Ui.FLAT_BUFFER_ARRAY]=yt.UINT32,vt[Ui.COUNT]=yt.NEVER,vt),Vi=e("ba",new bt(Ct.SUB_MESH,zi,Ui,3));!function(e){e[e.IS_DISCARD=0]="IS_DISCARD",e[e.POLYGO_MODEL=1]="POLYGO_MODEL",e[e.SHADE_MODEL=2]="SHADE_MODEL",e[e.CULL_MODE=3]="CULL_MODE",e[e.IS_FRONT_FACE_CCW=4]="IS_FRONT_FACE_CCW",e[e.DEPTH_BIAS_ENABLED=5]="DEPTH_BIAS_ENABLED",e[e.DEPTH_BIAS=6]="DEPTH_BIAS",e[e.DEPTH_BIAS_CLAMP=7]="DEPTH_BIAS_CLAMP",e[e.DEPTH_BIAS_SLOP=8]="DEPTH_BIAS_SLOP",e[e.IS_DEPTH_CLIP=9]="IS_DEPTH_CLIP",e[e.IS_MULTI_SAMPLE=10]="IS_MULTI_SAMPLE",e[e.LINE_WIDTH=11]="LINE_WIDTH",e[e.COUNT=12]="COUNT"}(ki||(ki=e("bb",{})));var Wi,Yi=((Et={})[ki.IS_DISCARD]=yt.UINT32,Et[ki.POLYGO_MODEL]=yt.UINT32,Et[ki.SHADE_MODEL]=yt.UINT32,Et[ki.CULL_MODE]=yt.UINT32,Et[ki.IS_FRONT_FACE_CCW]=yt.UINT32,Et[ki.DEPTH_BIAS_ENABLED]=yt.UINT32,Et[ki.DEPTH_BIAS]=yt.FLOAT32,Et[ki.DEPTH_BIAS_CLAMP]=yt.FLOAT32,Et[ki.DEPTH_BIAS_SLOP]=yt.FLOAT32,Et[ki.IS_DEPTH_CLIP]=yt.UINT32,Et[ki.IS_MULTI_SAMPLE]=yt.UINT32,Et[ki.LINE_WIDTH]=yt.FLOAT32,Et[ki.COUNT]=yt.NEVER,Et);e("bc",new bt(Ct.RASTERIZER_STATE,Yi,ki,9)),function(e){e[e.DEPTH_TEST=0]="DEPTH_TEST",e[e.DEPTH_WRITE=1]="DEPTH_WRITE",e[e.DEPTH_FUNC=2]="DEPTH_FUNC",e[e.STENCIL_TEST_FRONT=3]="STENCIL_TEST_FRONT",e[e.STENCIL_FUNC_FRONT=4]="STENCIL_FUNC_FRONT",e[e.STENCIL_READ_MASK_FRONT=5]="STENCIL_READ_MASK_FRONT",e[e.STENCIL_WRITE_MASK_FRONT=6]="STENCIL_WRITE_MASK_FRONT",e[e.STENCIL_FAIL_OP_FRONT=7]="STENCIL_FAIL_OP_FRONT",e[e.STENCIL_Z_FAIL_OP_FRONT=8]="STENCIL_Z_FAIL_OP_FRONT",e[e.STENCIL_PASS_OP_FRONT=9]="STENCIL_PASS_OP_FRONT",e[e.STENCIL_REF_FRONT=10]="STENCIL_REF_FRONT",e[e.STENCIL_TEST_BACK=11]="STENCIL_TEST_BACK",e[e.STENCIL_FUNC_BACK=12]="STENCIL_FUNC_BACK",e[e.STENCIL_READ_MADK_BACK=13]="STENCIL_READ_MADK_BACK",e[e.STENCIL_WRITE_MASK_BACK=14]="STENCIL_WRITE_MASK_BACK",e[e.STENCIL_FAIL_OP_BACK=15]="STENCIL_FAIL_OP_BACK",e[e.STENCIL_Z_FAIL_OP_BACK=16]="STENCIL_Z_FAIL_OP_BACK",e[e.STENCIL_PASS_OP_BACK=17]="STENCIL_PASS_OP_BACK",e[e.STENCIL_REF_BACK=18]="STENCIL_REF_BACK",e[e.COUNT=19]="COUNT"}(Wi||(Wi=e("bd",{})));var Xi,ji,Ki=((Tt={})[Wi.DEPTH_TEST]=yt.UINT32,Tt[Wi.DEPTH_WRITE]=yt.UINT32,Tt[Wi.DEPTH_FUNC]=yt.UINT32,Tt[Wi.STENCIL_TEST_FRONT]=yt.UINT32,Tt[Wi.STENCIL_FUNC_FRONT]=yt.UINT32,Tt[Wi.STENCIL_READ_MASK_FRONT]=yt.UINT32,Tt[Wi.STENCIL_WRITE_MASK_FRONT]=yt.UINT32,Tt[Wi.STENCIL_FAIL_OP_FRONT]=yt.UINT32,Tt[Wi.STENCIL_Z_FAIL_OP_FRONT]=yt.UINT32,Tt[Wi.STENCIL_PASS_OP_FRONT]=yt.UINT32,Tt[Wi.STENCIL_REF_FRONT]=yt.UINT32,Tt[Wi.STENCIL_TEST_BACK]=yt.UINT32,Tt[Wi.STENCIL_FUNC_BACK]=yt.UINT32,Tt[Wi.STENCIL_READ_MADK_BACK]=yt.UINT32,Tt[Wi.STENCIL_WRITE_MASK_BACK]=yt.UINT32,Tt[Wi.STENCIL_FAIL_OP_BACK]=yt.UINT32,Tt[Wi.STENCIL_Z_FAIL_OP_BACK]=yt.UINT32,Tt[Wi.STENCIL_PASS_OP_BACK]=yt.UINT32,Tt[Wi.STENCIL_REF_BACK]=yt.UINT32,Tt[Wi.COUNT]=yt.NEVER,Tt);e("be",new bt(Ct.DEPTH_STENCIL_STATE,Ki,Wi,9)),function(e){e[e.BLEND=0]="BLEND",e[e.BLEND_SRC=1]="BLEND_SRC",e[e.BLEND_DST=2]="BLEND_DST",e[e.BLEND_EQ=3]="BLEND_EQ",e[e.BLEND_SRC_ALPHA=4]="BLEND_SRC_ALPHA",e[e.BLEND_DST_ALPHA=5]="BLEND_DST_ALPHA",e[e.BLEND_ALPHA_EQ=6]="BLEND_ALPHA_EQ",e[e.BLEND_COLOR_MASK=7]="BLEND_COLOR_MASK",e[e.COUNT=8]="COUNT"}(Xi||(Xi=e("bf",{}))),(At={})[Xi.BLEND]=yt.UINT32,At[Xi.BLEND_SRC]=yt.UINT32,At[Xi.BLEND_DST]=yt.UINT32,At[Xi.BLEND_EQ]=yt.UINT32,At[Xi.BLEND_SRC_ALPHA]=yt.UINT32,At[Xi.BLEND_DST_ALPHA]=yt.UINT32,At[Xi.BLEND_ALPHA_EQ]=yt.UINT32,At[Xi.BLEND_COLOR_MASK]=yt.UINT32,At[Xi.COUNT]=yt.NEVER,e("bg",new bt(Ct.BLEND_TARGET,Ki,Xi,9)),function(e){e[e.IS_A2C=0]="IS_A2C",e[e.IS_INDEPEND=1]="IS_INDEPEND",e[e.BLEND_COLOR=2]="BLEND_COLOR",e[e.BLEND_TARGET=6]="BLEND_TARGET",e[e.COUNT=7]="COUNT"}(ji||(ji=e("bh",{})));var Zi=((St={})[ji.IS_A2C]=yt.UINT32,St[ji.IS_INDEPEND]=yt.UINT32,St[ji.BLEND_COLOR]=yt.FLOAT32,St[ji.BLEND_TARGET]=yt.UINT32,St[ji.COUNT]=yt.NEVER,St),Qi=(e("bi",new bt(Ct.BLEND_STATE,Zi,ji,9)),new r),qi=new r,Ji=new r,$i=new r;function en(e){return Math.max(Math.max(e.x,e.y),e.z)}var tn,nn=e("ej",function(){function e(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),this._center=new r(0,0,0),this._poolHandle=Ft,this._type=void 0,this._type=Ve.SHAPE_SPHERE,this._center=new r(e,t,i),this._poolHandle=Di.alloc(),Di.setVec3(this._poolHandle,Mi.CENTER,this._center),Di.set(this._poolHandle,Mi.RADIUS,n)}e.create=function(t,i,n,r){return new e(t,i,n,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return r.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,i){return r.multiplyScalar(e.center,r.add(Qi,t,i),.5),e.radius=.5*r.subtract(Qi,i,t).length(),e},e.set=function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e},e.mergePoint=function(e,t,i){if(t.radius<0)return e.center.set(i),e.radius=0,e;r.subtract(qi,i,t.center);var n=qi.length();if(n>t.radius){var s=.5*(n-t.radius);e.radius+=s,r.multiplyScalar(qi,qi,s/n),r.add(e.center,e.center,qi)}return e},e.mergeAABB=function(t,i,n){return n.getBoundary(Ji,$i),e.mergePoint(t,i,Ji),e.mergePoint(t,i,$i),t},s(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e,Di.setVec3(this._poolHandle,Mi.CENTER,this._center)}},{key:"radius",get:function(){return Di.get(this._poolHandle,Mi.RADIUS)},set:function(e){Di.set(this._poolHandle,Mi.RADIUS,e)}},{key:"handle",get:function(){return this._poolHandle}},{key:"type",get:function(){return this._type}}]);var t=e.prototype;return t.destroy=function(){this._poolHandle&&(Di.free(this._poolHandle),this._poolHandle=Ft)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){r.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),r.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,i,n,s){r.transformMat4(s.center,this.center,e),s.radius=this.radius*en(n)},t.translateAndRotate=function(e,t,i){r.transformMat4(i.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*en(e)},e}()),rn=e("ei",function(){function e(e,t,i,n,s,a,o,h,u){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===s&&(s=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===h&&(h=1),void 0===u&&(u=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Ve.SHAPE_TRIANGLE,this.a=new r(e,t,i),this.b=new r(n,s,a),this.c=new r(o,h,u)}return e.create=function(t,i,n,r,s,a,o,h,u){return void 0===t&&(t=1),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===h&&(h=0),void 0===u&&(u=1),new e(t,i,n,r,s,a,o,h,u)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return r.copy(e.a,t.a),r.copy(e.b,t.b),r.copy(e.c,t.c),e},e.fromPoints=function(e,t,i,n){return r.copy(e.a,t),r.copy(e.b,i),r.copy(e.c,n),e},e.set=function(e,t,i,n,r,s,a,o,h,u){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=s,e.b.z=a,e.c.x=o,e.c.y=h,e.c.z=u,e},s(e,[{key:"type",get:function(){return this._type}}]),e}()),sn=e("cc",4);!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BUFFER=1]="BUFFER",e[e.TEXTURE=2]="TEXTURE",e[e.RENDER_PASS=3]="RENDER_PASS",e[e.FRAMEBUFFER=4]="FRAMEBUFFER",e[e.SAMPLER=5]="SAMPLER",e[e.SHADER=6]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=9]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=12]="COMMAND_BUFFER",e[e.FENCE=13]="FENCE",e[e.QUEUE=14]="QUEUE",e[e.WINDOW=15]="WINDOW"}(tn||(tn=e("cd",{})));var an,on,hn,un,ln,_n,cn,dn,fn,pn,mn,gn,vn,En,Tn,An,Sn,yn,Rn,In,On,Nn,Cn,bn,wn,Ln,Mn,Pn,Bn,Fn,xn,Dn,Un,Gn,Hn,kn,zn,Vn=e("ce",function(){function e(e){this._gfxType=tn.UNKNOWN,this._gfxType=e}return s(e,[{key:"gfxType",get:function(){return this._gfxType}}]),e}());!function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(an||(an=e("a",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.COUNT=32]="COUNT"}(on||(on=e("cf",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.D16=54]="D16",e[e.D16S8=55]="D16S8",e[e.D24=56]="D24",e[e.D24S8=57]="D24S8",e[e.D32F=58]="D32F",e[e.D32F_S8=59]="D32F_S8",e[e.BC1=60]="BC1",e[e.BC1_ALPHA=61]="BC1_ALPHA",e[e.BC1_SRGB=62]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",e[e.BC2=64]="BC2",e[e.BC2_SRGB=65]="BC2_SRGB",e[e.BC3=66]="BC3",e[e.BC3_SRGB=67]="BC3_SRGB",e[e.BC4=68]="BC4",e[e.BC4_SNORM=69]="BC4_SNORM",e[e.BC5=70]="BC5",e[e.BC5_SNORM=71]="BC5_SNORM",e[e.BC6H_UF16=72]="BC6H_UF16",e[e.BC6H_SF16=73]="BC6H_SF16",e[e.BC7=74]="BC7",e[e.BC7_SRGB=75]="BC7_SRGB",e[e.ETC_RGB8=76]="ETC_RGB8",e[e.ETC2_RGB8=77]="ETC2_RGB8",e[e.ETC2_SRGB8=78]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=81]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",e[e.EAC_R11=83]="EAC_R11",e[e.EAC_R11SN=84]="EAC_R11SN",e[e.EAC_RG11=85]="EAC_RG11",e[e.EAC_RG11SN=86]="EAC_RG11SN",e[e.PVRTC_RGB2=87]="PVRTC_RGB2",e[e.PVRTC_RGBA2=88]="PVRTC_RGBA2",e[e.PVRTC_RGB4=89]="PVRTC_RGB4",e[e.PVRTC_RGBA4=90]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=91]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=92]="PVRTC2_4BPP",e[e.ASTC_RGBA_4x4=93]="ASTC_RGBA_4x4",e[e.ASTC_RGBA_5x4=94]="ASTC_RGBA_5x4",e[e.ASTC_RGBA_5x5=95]="ASTC_RGBA_5x5",e[e.ASTC_RGBA_6x5=96]="ASTC_RGBA_6x5",e[e.ASTC_RGBA_6x6=97]="ASTC_RGBA_6x6",e[e.ASTC_RGBA_8x5=98]="ASTC_RGBA_8x5",e[e.ASTC_RGBA_8x6=99]="ASTC_RGBA_8x6",e[e.ASTC_RGBA_8x8=100]="ASTC_RGBA_8x8",e[e.ASTC_RGBA_10x5=101]="ASTC_RGBA_10x5",e[e.ASTC_RGBA_10x6=102]="ASTC_RGBA_10x6",e[e.ASTC_RGBA_10x8=103]="ASTC_RGBA_10x8",e[e.ASTC_RGBA_10x10=104]="ASTC_RGBA_10x10",e[e.ASTC_RGBA_12x10=105]="ASTC_RGBA_12x10",e[e.ASTC_RGBA_12x12=106]="ASTC_RGBA_12x12",e[e.ASTC_SRGBA_4x4=107]="ASTC_SRGBA_4x4",e[e.ASTC_SRGBA_5x4=108]="ASTC_SRGBA_5x4",e[e.ASTC_SRGBA_5x5=109]="ASTC_SRGBA_5x5",e[e.ASTC_SRGBA_6x5=110]="ASTC_SRGBA_6x5",e[e.ASTC_SRGBA_6x6=111]="ASTC_SRGBA_6x6",e[e.ASTC_SRGBA_8x5=112]="ASTC_SRGBA_8x5",e[e.ASTC_SRGBA_8x6=113]="ASTC_SRGBA_8x6",e[e.ASTC_SRGBA_8x8=114]="ASTC_SRGBA_8x8",e[e.ASTC_SRGBA_10x5=115]="ASTC_SRGBA_10x5",e[e.ASTC_SRGBA_10x6=116]="ASTC_SRGBA_10x6",e[e.ASTC_SRGBA_10x8=117]="ASTC_SRGBA_10x8",e[e.ASTC_SRGBA_10x10=118]="ASTC_SRGBA_10x10",e[e.ASTC_SRGBA_12x10=119]="ASTC_SRGBA_12x10",e[e.ASTC_SRGBA_12x12=120]="ASTC_SRGBA_12x12"}(hn||(hn=e("F",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(un||(un=e("b",{}))),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(ln||(ln=e("M",{}))),function(e){e[e.NONE=0]="NONE",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(_n||(_n=e("cg",{}))),function(e){e[e.NONE=0]="NONE",e[e.READ=1]="READ",e[e.WRITE=2]="WRITE"}(cn||(cn=e("ch",{}))),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(dn||(dn=e("P",{}))),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(fn||(fn=e("ci",{}))),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(pn||(pn=e("cj",{}))),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(mn||(mn=e("ck",{}))),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(gn||(gn=e("cl",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(vn||(vn=e("cm",{}))),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(En||(En=e("cn",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Tn||(Tn=e("co",{}))),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(An||(An=e("cp",{}))),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(Sn||(Sn=e("cq",{}))),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(yn||(yn=e("cr",{}))),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Rn||(Rn=e("cs",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",e[e.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(In||(In=e("ct",{}))),function(e){e[e.X1=0]="X1",e[e.X2=1]="X2",e[e.X4=2]="X4",e[e.X8=3]="X8",e[e.X16=4]="X16",e[e.X32=5]="X32",e[e.X64=6]="X64"}(On||(On=e("cu",{}))),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.CUBEMAP=2]="CUBEMAP",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(Nn||(Nn=e("cv",{}))),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Cn||(Cn=e("cw",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER=16]="SAMPLER"}(bn||(bn=e("cx",{}))),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(wn||(wn=e("cy",{}))),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(Ln||(Ln=e("cz",{}))),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Mn||(Mn=e("cA",{}))),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.GENERAL=1]="GENERAL",e[e.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",e[e.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",e[e.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",e[e.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",e[e.PREINITIALIZED=8]="PREINITIALIZED",e[e.PRESENT_SRC=9]="PRESENT_SRC"}(Pn||(Pn=e("cB",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Bn||(Bn=e("cC",{}))),function(e){e[e.NONE=0]="NONE",e[e.VIEWPORT=1]="VIEWPORT",e[e.SCISSOR=2]="SCISSOR",e[e.LINE_WIDTH=4]="LINE_WIDTH",e[e.DEPTH_BIAS=8]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(Fn||(Fn=e("cD",{}))),function(e){e[e.FRONT=0]="FRONT",e[e.BACK=1]="BACK",e[e.ALL=2]="ALL"}(xn||(xn=e("cE",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(Dn||(Dn=e("cF",{}))),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Un||(Un=e("cG",{}))),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Gn||(Gn=e("cH",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.WEBGL=5]="WEBGL",e[e.WEBGL2=6]="WEBGL2",e[e.WEBGPU=7]="WEBGPU"}(Hn||(Hn=e("cI",{}))),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(kn||(kn=e("cJ",{}))),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_D16=7]="FORMAT_D16",e[e.FORMAT_D16S8=8]="FORMAT_D16S8",e[e.FORMAT_D24=9]="FORMAT_D24",e[e.FORMAT_D24S8=10]="FORMAT_D24S8",e[e.FORMAT_D32F=11]="FORMAT_D32F",e[e.FORMAT_D32FS8=12]="FORMAT_D32FS8",e[e.FORMAT_ETC1=13]="FORMAT_ETC1",e[e.FORMAT_ETC2=14]="FORMAT_ETC2",e[e.FORMAT_DXT=15]="FORMAT_DXT",e[e.FORMAT_PVRTC=16]="FORMAT_PVRTC",e[e.FORMAT_ASTC=17]="FORMAT_ASTC",e[e.FORMAT_RGB8=18]="FORMAT_RGB8",e[e.MSAA=19]="MSAA",e[e.ELEMENT_INDEX_UINT=20]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=21]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=22]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=23]="BLEND_MINMAX",e[e.DEPTH_BOUNDS=24]="DEPTH_BOUNDS",e[e.LINE_WIDTH=25]="LINE_WIDTH",e[e.STENCIL_WRITE_MASK=26]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=27]="STENCIL_COMPARE_MASK",e[e.COUNT=28]="COUNT"}(zn||(zn=e("cK",{})));var Wn=e("cL",(function(e,t,i,n,r,s,a,o){this.name=e,this.size=t,this.count=i,this.type=n,this.hasAlpha=r,this.hasDepth=s,this.hasStencil=a,this.isCompressed=o})),Yn=e("cM",(function(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t})),Xn=e("cN",Object.freeze([new Wn("UNKNOWN",0,0,Gn.NONE,!1,!1,!1,!1),new Wn("A8",1,1,Gn.UNORM,!0,!1,!1,!1),new Wn("L8",1,1,Gn.UNORM,!1,!1,!1,!1),new Wn("LA8",1,2,Gn.UNORM,!0,!1,!1,!1),new Wn("R8",1,1,Gn.UNORM,!1,!1,!1,!1),new Wn("R8SN",1,1,Gn.SNORM,!1,!1,!1,!1),new Wn("R8UI",1,1,Gn.UINT,!1,!1,!1,!1),new Wn("R8I",1,1,Gn.INT,!1,!1,!1,!1),new Wn("R16F",2,1,Gn.FLOAT,!1,!1,!1,!1),new Wn("R16UI",2,1,Gn.UINT,!1,!1,!1,!1),new Wn("R16I",2,1,Gn.INT,!1,!1,!1,!1),new Wn("R32F",4,1,Gn.FLOAT,!1,!1,!1,!1),new Wn("R32UI",4,1,Gn.UINT,!1,!1,!1,!1),new Wn("R32I",4,1,Gn.INT,!1,!1,!1,!1),new Wn("RG8",2,2,Gn.UNORM,!1,!1,!1,!1),new Wn("RG8SN",2,2,Gn.SNORM,!1,!1,!1,!1),new Wn("RG8UI",2,2,Gn.UINT,!1,!1,!1,!1),new Wn("RG8I",2,2,Gn.INT,!1,!1,!1,!1),new Wn("RG16F",4,2,Gn.FLOAT,!1,!1,!1,!1),new Wn("RG16UI",4,2,Gn.UINT,!1,!1,!1,!1),new Wn("RG16I",4,2,Gn.INT,!1,!1,!1,!1),new Wn("RG32F",8,2,Gn.FLOAT,!1,!1,!1,!1),new Wn("RG32UI",8,2,Gn.UINT,!1,!1,!1,!1),new Wn("RG32I",8,2,Gn.INT,!1,!1,!1,!1),new Wn("RGB8",3,3,Gn.UNORM,!1,!1,!1,!1),new Wn("SRGB8",3,3,Gn.UNORM,!1,!1,!1,!1),new Wn("RGB8SN",3,3,Gn.SNORM,!1,!1,!1,!1),new Wn("RGB8UI",3,3,Gn.UINT,!1,!1,!1,!1),new Wn("RGB8I",3,3,Gn.INT,!1,!1,!1,!1),new Wn("RGB16F",6,3,Gn.FLOAT,!1,!1,!1,!1),new Wn("RGB16UI",6,3,Gn.UINT,!1,!1,!1,!1),new Wn("RGB16I",6,3,Gn.INT,!1,!1,!1,!1),new Wn("RGB32F",12,3,Gn.FLOAT,!1,!1,!1,!1),new Wn("RGB32UI",12,3,Gn.UINT,!1,!1,!1,!1),new Wn("RGB32I",12,3,Gn.INT,!1,!1,!1,!1),new Wn("RGBA8",4,4,Gn.UNORM,!0,!1,!1,!1),new Wn("BGRA8",4,4,Gn.UNORM,!0,!1,!1,!1),new Wn("SRGB8_A8",4,4,Gn.UNORM,!0,!1,!1,!1),new Wn("RGBA8SN",4,4,Gn.SNORM,!0,!1,!1,!1),new Wn("RGBA8UI",4,4,Gn.UINT,!0,!1,!1,!1),new Wn("RGBA8I",4,4,Gn.INT,!0,!1,!1,!1),new Wn("RGBA16F",8,4,Gn.FLOAT,!0,!1,!1,!1),new Wn("RGBA16UI",8,4,Gn.UINT,!0,!1,!1,!1),new Wn("RGBA16I",8,4,Gn.INT,!0,!1,!1,!1),new Wn("RGBA32F",16,4,Gn.FLOAT,!0,!1,!1,!1),new Wn("RGBA32UI",16,4,Gn.UINT,!0,!1,!1,!1),new Wn("RGBA32I",16,4,Gn.INT,!0,!1,!1,!1),new Wn("R5G6B5",2,3,Gn.UNORM,!1,!1,!1,!1),new Wn("R11G11B10F",4,3,Gn.FLOAT,!1,!1,!1,!1),new Wn("RGB5A1",2,4,Gn.UNORM,!0,!1,!1,!1),new Wn("RGBA4",2,4,Gn.UNORM,!0,!1,!1,!1),new Wn("RGB10A2",2,4,Gn.UNORM,!0,!1,!1,!1),new Wn("RGB10A2UI",2,4,Gn.UINT,!0,!1,!1,!1),new Wn("RGB9E5",2,4,Gn.FLOAT,!0,!1,!1,!1),new Wn("D16",2,1,Gn.UINT,!1,!0,!1,!1),new Wn("D16S8",3,2,Gn.UINT,!1,!0,!0,!1),new Wn("D24",3,1,Gn.UINT,!1,!0,!1,!1),new Wn("D24S8",4,2,Gn.UINT,!1,!0,!0,!1),new Wn("D32F",4,1,Gn.FLOAT,!1,!0,!1,!1),new Wn("D32FS8",5,2,Gn.FLOAT,!1,!0,!0,!1),new Wn("BC1",1,3,Gn.UNORM,!1,!1,!1,!0),new Wn("BC1_ALPHA",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("BC1_SRGB",1,3,Gn.UNORM,!1,!1,!1,!0),new Wn("BC1_SRGB_ALPHA",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("BC2",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("BC2_SRGB",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("BC3",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("BC3_SRGB",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("BC4",1,1,Gn.UNORM,!1,!1,!1,!0),new Wn("BC4_SNORM",1,1,Gn.SNORM,!1,!1,!1,!0),new Wn("BC5",1,2,Gn.UNORM,!1,!1,!1,!0),new Wn("BC5_SNORM",1,2,Gn.SNORM,!1,!1,!1,!0),new Wn("BC6H_UF16",1,3,Gn.UFLOAT,!1,!1,!1,!0),new Wn("BC6H_SF16",1,3,Gn.FLOAT,!1,!1,!1,!0),new Wn("BC7",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("BC7_SRGB",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ETC_RGB8",1,3,Gn.UNORM,!1,!1,!1,!0),new Wn("ETC2_RGB8",1,3,Gn.UNORM,!1,!1,!1,!0),new Wn("ETC2_SRGB8",1,3,Gn.UNORM,!1,!1,!1,!0),new Wn("ETC2_RGB8_A1",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ETC2_SRGB8_A1",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ETC2_RGBA8",2,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ETC2_SRGB8_A8",2,4,Gn.UNORM,!0,!1,!1,!0),new Wn("EAC_R11",1,1,Gn.UNORM,!1,!1,!1,!0),new Wn("EAC_R11SN",1,1,Gn.SNORM,!1,!1,!1,!0),new Wn("EAC_RG11",2,2,Gn.UNORM,!1,!1,!1,!0),new Wn("EAC_RG11SN",2,2,Gn.SNORM,!1,!1,!1,!0),new Wn("PVRTC_RGB2",2,3,Gn.UNORM,!1,!1,!1,!0),new Wn("PVRTC_RGBA2",2,4,Gn.UNORM,!0,!1,!1,!0),new Wn("PVRTC_RGB4",2,3,Gn.UNORM,!1,!1,!1,!0),new Wn("PVRTC_RGBA4",2,4,Gn.UNORM,!0,!1,!1,!0),new Wn("PVRTC2_2BPP",2,4,Gn.UNORM,!0,!1,!1,!0),new Wn("PVRTC2_4BPP",2,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_4x4",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_5x4",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_5x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_6x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_6x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_8x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_8x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_8x8",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_10x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_10x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_10x8",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_10x10",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_12x10",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_12x12",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_4x4",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_5x4",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_5x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_6x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_6x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_8x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_8x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_8x8",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_10x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_10x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_10x8",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_10x10",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_12x10",1,4,Gn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_12x12",1,4,Gn.UNORM,!0,!1,!1,!0)]));function jn(e,t,i,n){if(!Xn[e].isCompressed)return t*i*n*Xn[e].size;switch(e){case hn.BC1:case hn.BC1_ALPHA:case hn.BC1_SRGB:case hn.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case hn.BC2:case hn.BC2_SRGB:case hn.BC3:case hn.BC3_SRGB:case hn.BC4:case hn.BC4_SNORM:case hn.BC6H_SF16:case hn.BC6H_UF16:case hn.BC7:case hn.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case hn.BC5:case hn.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case hn.ETC_RGB8:case hn.ETC2_RGB8:case hn.ETC2_SRGB8:case hn.ETC2_RGB8_A1:case hn.EAC_R11:case hn.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case hn.ETC2_RGBA8:case hn.ETC2_SRGB8_A1:case hn.EAC_RG11:case hn.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case hn.PVRTC_RGB2:case hn.PVRTC_RGBA2:case hn.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case hn.PVRTC_RGB4:case hn.PVRTC_RGBA4:case hn.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(i,8)/2)*n;case hn.ASTC_RGBA_4x4:case hn.ASTC_SRGBA_4x4:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case hn.ASTC_RGBA_5x4:case hn.ASTC_SRGBA_5x4:return Math.ceil(t/5)*Math.ceil(i/4)*16*n;case hn.ASTC_RGBA_5x5:case hn.ASTC_SRGBA_5x5:return Math.ceil(t/5)*Math.ceil(i/5)*16*n;case hn.ASTC_RGBA_6x5:case hn.ASTC_SRGBA_6x5:return Math.ceil(t/6)*Math.ceil(i/5)*16*n;case hn.ASTC_RGBA_6x6:case hn.ASTC_SRGBA_6x6:return Math.ceil(t/6)*Math.ceil(i/6)*16*n;case hn.ASTC_RGBA_8x5:case hn.ASTC_SRGBA_8x5:return Math.ceil(t/8)*Math.ceil(i/5)*16*n;case hn.ASTC_RGBA_8x6:case hn.ASTC_SRGBA_8x6:return Math.ceil(t/8)*Math.ceil(i/6)*16*n;case hn.ASTC_RGBA_8x8:case hn.ASTC_SRGBA_8x8:return Math.ceil(t/8)*Math.ceil(i/8)*16*n;case hn.ASTC_RGBA_10x5:case hn.ASTC_SRGBA_10x5:return Math.ceil(t/10)*Math.ceil(i/5)*16*n;case hn.ASTC_RGBA_10x6:case hn.ASTC_SRGBA_10x6:return Math.ceil(t/10)*Math.ceil(i/6)*16*n;case hn.ASTC_RGBA_10x8:case hn.ASTC_SRGBA_10x8:return Math.ceil(t/10)*Math.ceil(i/8)*16*n;case hn.ASTC_RGBA_10x10:case hn.ASTC_SRGBA_10x10:return Math.ceil(t/10)*Math.ceil(i/10)*16*n;case hn.ASTC_RGBA_12x10:case hn.ASTC_SRGBA_12x10:return Math.ceil(t/12)*Math.ceil(i/10)*16*n;case hn.ASTC_RGBA_12x12:case hn.ASTC_SRGBA_12x12:return Math.ceil(t/12)*Math.ceil(i/12)*16*n;default:return 0}}function Kn(e,t,i,n,r){for(var s=0,a=0;a<r;++a)s+=jn(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1);return s}var Zn=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Qn(e){return Zn[e]||0}function qn(e){var t=e.size/e.count;switch(e.type){case Gn.UNORM:case Gn.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Gn.SNORM:case Gn.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Gn.FLOAT:return Float32Array}return Float32Array}var Jn=e("c5",(function(e,t,i,n,r,s,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=0),void 0===a&&(a=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=i,this.firstIndex=n,this.vertexOffset=r,this.instanceCount=s,this.firstInstance=a})),$n=e("c6",28),er=e("c7",(function(e){void 0===e&&(e=[]),this.drawInfos=e})),tr=e("B",(function(e,t,i,n,r){void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=_n.NONE),this.usage=e,this.memUsage=t,this.size=i,this.stride=n,this.flags=r})),ir=e("c8",(function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.buffer=e,this.offset=t,this.range=i})),nr=e("c9",function(e){function t(t){var i;return(i=e.call(this,tn.BUFFER)||this)._device=void 0,i._usage=un.NONE,i._memUsage=ln.NONE,i._size=0,i._stride=1,i._count=0,i._flags=_n.NONE,i._bakcupBuffer=null,i._indirectBuffer=null,i._isBufferView=!1,i._device=t,i}return a(t,e),s(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}},{key:"backupBuffer",get:function(){return this._bakcupBuffer}}]),t}(Vn)),rr=e("ca",(function(e,t){void 0===t&&(t=wn.PRIMARY),this.queue=e,this.type=t})),sr=e("cb",function(e){function t(t){var i;return(i=e.call(this,tn.COMMAND_BUFFER)||this)._device=void 0,i._queue=null,i._type=wn.PRIMARY,i._numDrawCalls=0,i._numInstances=0,i._numTris=0,i._device=t,i}return a(t,e),s(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(Vn));o(hn);var ar=e("cY",(function(e,t,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===i&&(i=0),this.bufferOffsets=e,this.samplerOffsets=t,this.flexibleSet=i})),or=e("cZ",(function(e,t,i,n,r,s,a){void 0===t&&(t=!0),void 0===i&&(i=!0),void 0===n&&(n=1),void 0===r&&(r=1),void 0===s&&(s=1),void 0===a&&(a=new ar),this.canvasElm=e,this.isAntialias=t,this.isPremultipliedAlpha=i,this.devicePixelRatio=n,this.nativeWidth=r,this.nativeHeight=s,this.bindingMappingInfo=a})),hr=e("c_",function(){function e(){this._canvas=null,this._canvas2D=null,this._gfxAPI=Hn.UNKNOWN,this._transform=kn.IDENTITY,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(zn.COUNT),this._queue=null,this._cmdBuff=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=0,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._uboOffsetAlignment=1,this._depthBits=0,this._stencilBits=0,this._colorFmt=hn.UNKNOWN,this._depthStencilFmt=hn.UNKNOWN,this._macros=new Map,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Yn,this._clipSpaceMinZ=-1,this._screenSpaceSignY=1,this._UVSpaceSignY=-1}return e.prototype.hasFeature=function(e){return this._features[e]},s(e,[{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"maxTextureSize",get:function(){return this._maxTextureSize}},{key:"maxCubeMapTextureSize",get:function(){return this._maxCubeMapTextureSize}},{key:"uboOffsetAlignment",get:function(){return this._uboOffsetAlignment}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"clipSpaceMinZ",get:function(){return this._clipSpaceMinZ}},{key:"screenSpaceSignY",get:function(){return this._screenSpaceSignY}},{key:"UVSpaceSignY",get:function(){return this._UVSpaceSignY}},{key:"surfaceTransform",get:function(){return this._transform}}]),e}()),ur=e("c$",(function(e,t,i,n,r){void 0===t&&(t=[]),void 0===i&&(i=null),void 0===n&&(n=[]),void 0===r&&(r=0),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=i,this.colorMipmapLevels=n,this.depStencilMipmapLevel=r})),lr=e("d0",function(e){function t(t){var i;return(i=e.call(this,tn.FRAMEBUFFER)||this)._device=void 0,i._renderPass=null,i._colorTextures=[],i._depthStencilTexture=null,i._device=t,i}return a(t,e),s(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(Vn)),_r=String.prototype.charCodeAt;function cr(e){return this[e]}function dr(e,t){for(var i=e.length,n=t^i,r=0,s="string"==typeof e?_r:cr;i>=4;){var a=255&s.call(e,r)|(255&s.call(e,++r))<<8|(255&s.call(e,++r))<<16|(255&s.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&s.call(e,r+2))<<16;case 2:n^=(255&s.call(e,r+1))<<8;case 1:n=1540483477*(65535&(n^=255&s.call(e,r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}var fr=e("A",(function(e,t,i,n,r,s){void 0===e&&(e=""),void 0===t&&(t=hn.UNKNOWN),void 0===i&&(i=!1),void 0===n&&(n=0),void 0===r&&(r=!1),void 0===s&&(s=0),this.name=e,this.format=t,this.isNormalized=i,this.stream=n,this.isInstanced=r,this.location=s})),pr=e("I",(function(e,t,i,n){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===i&&(i=null),void 0===n&&(n=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=i,this.indirectBuffer=n})),mr=e("d1",function(e){function t(t){var i;return(i=e.call(this,tn.INPUT_ASSEMBLER)||this)._device=void 0,i._attributes=[],i._vertexBuffers=[],i._indexBuffer=null,i._vertexCount=0,i._firstVertex=0,i._indexCount=0,i._firstIndex=0,i._vertexOffset=0,i._instanceCount=0,i._firstInstance=0,i._attributesHash=0,i._indirectBuffer=null,i._device=t,i}a(t,e),s(t,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]);var i=t.prototype;return i.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},i.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var i=this.attributes[t];e+=","+i.name+","+i.format+","+i.isNormalized+","+i.stream+","+i.isInstanced}return dr(e,666)},t}(Vn)),gr=e("cQ",(function(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=1),void 0===n&&(n=1),this.x=e,this.y=t,this.width=i,this.height=n})),vr=e("cR",(function(e,t,i,n,r,s){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=1),this.left=e,this.top=t,this.width=i,this.height=n,this.minDepth=r,this.maxDepth=s})),Er=e("cS",(function(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=i,this.w=n})),Tr=e("cT",(function(e,t,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=i})),Ar=e("cU",(function(e,t,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=1),this.width=e,this.height=t,this.depth=i})),Sr=e("cV",(function(e,t,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=i})),yr=e("cW",(function(e,t,i,n,r){void 0===e&&(e=new Sr),void 0===t&&(t=new Tr),void 0===i&&(i=new Sr),void 0===n&&(n=new Tr),void 0===r&&(r=new Ar),this.srcSubres=e,this.srcOffset=t,this.dstSubres=i,this.dstOffset=n,this.extent=r})),Rr=e("cX",(function(e,t,i,n,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=new Tr),void 0===n&&(n=new Ar),void 0===r&&(r=new Sr),this.buffStride=e,this.buffTexHeight=t,this.texOffset=i,this.texExtent=n,this.texSubres=r})),Ir=e("d8",function(){function e(e,t,i,n,r,s,a,o,h,u,l,_){void 0===e&&(e=!1),void 0===t&&(t=fn.FILL),void 0===i&&(i=pn.GOURAND),void 0===n&&(n=mn.BACK),void 0===r&&(r=!0),void 0===s&&(s=!1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===h&&(h=0),void 0===u&&(u=!0),void 0===l&&(l=!1),void 0===_&&(_=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=i,this.cullMode=n,this.isFrontFaceCCW=r,this.depthBiasEnabled=s,this.depthBias=a,this.depthBiasClamp=o,this.depthBiasSlop=h,this.isDepthClip=u,this.isMultisample=l,this.lineWidth=_}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=fn.FILL,this.shadeModel=pn.GOURAND,this.cullMode=mn.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},s(e,[{key:"handle",get:function(){return Ft}}]),e}()),Or=e("d9",function(){function e(e,t,i,n,r,s,a,o,h,u,l,_,c,d,f,p,m,g,v){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===i&&(i=gn.LESS),void 0===n&&(n=!1),void 0===r&&(r=gn.ALWAYS),void 0===s&&(s=65535),void 0===a&&(a=65535),void 0===o&&(o=vn.KEEP),void 0===h&&(h=vn.KEEP),void 0===u&&(u=vn.KEEP),void 0===l&&(l=1),void 0===_&&(_=!1),void 0===c&&(c=gn.ALWAYS),void 0===d&&(d=65535),void 0===f&&(f=65535),void 0===p&&(p=vn.KEEP),void 0===m&&(m=vn.KEEP),void 0===g&&(g=vn.KEEP),void 0===v&&(v=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=i,this.stencilTestFront=n,this.stencilFuncFront=r,this.stencilReadMaskFront=s,this.stencilWriteMaskFront=a,this.stencilFailOpFront=o,this.stencilZFailOpFront=h,this.stencilPassOpFront=u,this.stencilRefFront=l,this.stencilTestBack=_,this.stencilFuncBack=c,this.stencilReadMaskBack=d,this.stencilWriteMaskBack=f,this.stencilFailOpBack=p,this.stencilZFailOpBack=m,this.stencilPassOpBack=g,this.stencilRefBack=v}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=gn.LESS,this.stencilTestFront=!1,this.stencilFuncFront=gn.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=vn.KEEP,this.stencilZFailOpFront=vn.KEEP,this.stencilPassOpFront=vn.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=gn.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=vn.KEEP,this.stencilZFailOpBack=vn.KEEP,this.stencilPassOpBack=vn.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},s(e,[{key:"handle",get:function(){return Ft}}]),e}()),Nr=e("da",function(){function e(e,t,i,n,r,s,a,o){void 0===e&&(e=!1),void 0===t&&(t=Tn.ONE),void 0===i&&(i=Tn.ZERO),void 0===n&&(n=En.ADD),void 0===r&&(r=Tn.ONE),void 0===s&&(s=Tn.ZERO),void 0===a&&(a=En.ADD),void 0===o&&(o=An.ALL),this.blend=e,this.blendSrc=t,this.blendDst=i,this.blendEq=n,this.blendSrcAlpha=r,this.blendDstAlpha=s,this.blendAlphaEq=a,this.blendColorMask=o}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=Tn.ONE,this.blendDst=Tn.ZERO,this.blendEq=En.ADD,this.blendSrcAlpha=Tn.ONE,this.blendDstAlpha=Tn.ZERO,this.blendAlphaEq=En.ADD,this.blendColorMask=An.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},s(e,[{key:"handle",get:function(){return Ft}}]),e}()),Cr=e("db",function(){function e(e,t,i,n){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===i&&(i=new Er),void 0===n&&(n=[new Nr]),this.isA2C=e,this.isIndepend=t,this.blendColor=i,this.targets=n}var t=e.prototype;return t.setTarget=function(e,t){var i=this.targets[e];i||(i=this.targets[e]=new Nr),Object.assign(i,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},s(e,[{key:"handle",get:function(){return Ft}}]),e}()),br=e("dc",(function(e){void 0===e&&(e=[]),this.attributes=e})),wr=e("dd",(function(e,t,i,n,r,s,a,o,h){void 0===o&&(o=dn.TRIANGLE_LIST),void 0===h&&(h=Fn.NONE),this.shader=e,this.pipelineLayout=t,this.renderPass=i,this.inputState=n,this.rasterizerState=r,this.depthStencilState=s,this.blendState=a,this.primitive=o,this.dynamicStates=h})),Lr=e("de",function(e){function t(t){var i;return(i=e.call(this,tn.PIPELINE_STATE)||this)._device=void 0,i._shader=null,i._pipelineLayout=null,i._primitive=dn.TRIANGLE_LIST,i._is=null,i._rs=null,i._dss=null,i._bs=null,i._dynamicStates=Fn.NONE,i._renderPass=null,i._device=t,i}return a(t,e),s(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(Vn)),Mr=e("dh",(function(e){void 0===e&&(e=Dn.GRAPHICS),this.type=e})),Pr=e("di",function(e){function t(t){var i;return(i=e.call(this,tn.QUEUE)||this)._device=void 0,i._type=Dn.GRAPHICS,i._isAsync=!1,i._device=t,i}return a(t,e),s(t,[{key:"type",get:function(){return this._type}}]),t.prototype.isAsync=function(){return this._isAsync},t}(Vn)),Br=e("dj",(function(e,t,i,n,r,s){void 0===e&&(e=hn.UNKNOWN),void 0===t&&(t=1),void 0===i&&(i=Ln.CLEAR),void 0===n&&(n=Mn.STORE),void 0===r&&(r=Pn.UNDEFINED),void 0===s&&(s=Pn.PRESENT_SRC),this.format=e,this.sampleCount=t,this.loadOp=i,this.storeOp=n,this.beginLayout=r,this.endLayout=s})),Fr=e("dk",(function(e,t,i,n,r,s,a,o){void 0===e&&(e=hn.UNKNOWN),void 0===t&&(t=1),void 0===i&&(i=Ln.CLEAR),void 0===n&&(n=Mn.STORE),void 0===r&&(r=Ln.CLEAR),void 0===s&&(s=Mn.STORE),void 0===a&&(a=Pn.UNDEFINED),void 0===o&&(o=Pn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL),this.format=e,this.sampleCount=t,this.depthLoadOp=i,this.depthStoreOp=n,this.stencilLoadOp=r,this.stencilStoreOp=s,this.beginLayout=a,this.endLayout=o})),xr=e("dl",(function(e,t,i,n,r,s){void 0===e&&(e=Bn.GRAPHICS),void 0===t&&(t=[]),void 0===i&&(i=[]),void 0===n&&(n=[]),void 0===r&&(r=-1),void 0===s&&(s=[]),this.bindPoint=e,this.inputs=t,this.colors=i,this.resolves=n,this.depthStencil=r,this.preserves=s})),Dr=e("dm",(function(e,t,i){void 0===e&&(e=[]),void 0===t&&(t=null),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subPasses=i})),Ur=e("dn",function(e){function t(t){var i;return(i=e.call(this,tn.RENDER_PASS)||this)._device=void 0,i._colorInfos=[],i._depthStencilInfo=null,i._subPasses=[],i._hash=0,i._device=t,i}return a(t,e),s(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subPasses}},{key:"hash",get:function(){return this._hash}}]),t.prototype.computeHash=function(){var e="";if(this._subPasses.length)for(var t=0;t<this._subPasses.length;++t){var i=this._subPasses[t];if(i.inputs.length){e+="ia";for(var n=0;n<i.inputs.length;++n){var r=this._colorInfos[i.inputs[n]];e+=","+r.format+","+r.sampleCount}}if(i.colors.length){e+="ca";for(var s=0;s<i.inputs.length;++s){var a=this._colorInfos[i.inputs[s]];e+=","+a.format+","+a.sampleCount}}if(i.depthStencil>=0){var o=this._colorInfos[i.depthStencil];e+="ds,"+o.format+","+o.sampleCount}}else{e+="ca";for(var h=0;h<this._colorInfos.length;++h){var u=this._colorInfos[h];e+=","+u.format+","+u.sampleCount}var l=this._depthStencilInfo;l&&(e+="ds,"+l.format+","+l.sampleCount)}return dr(e,666)},t}(Vn)),Gr=e("dp",(function(e,t,i,n,r,s,a,o,h,u,l,_){void 0===e&&(e=Sn.LINEAR),void 0===t&&(t=Sn.LINEAR),void 0===i&&(i=Sn.NONE),void 0===n&&(n=yn.WRAP),void 0===r&&(r=yn.WRAP),void 0===s&&(s=yn.WRAP),void 0===a&&(a=16),void 0===o&&(o=gn.NEVER),void 0===h&&(h=new Er),void 0===u&&(u=0),void 0===l&&(l=0),void 0===_&&(_=0),this.minFilter=e,this.magFilter=t,this.mipFilter=i,this.addressU=n,this.addressV=r,this.addressW=s,this.maxAnisotropy=a,this.cmpFunc=o,this.borderColor=h,this.minLOD=u,this.maxLOD=l,this.mipLODBias=_})),Hr=e("dq",function(e){function t(t){var i;return(i=e.call(this,tn.SAMPLER)||this)._device=void 0,i._minFilter=Sn.LINEAR,i._magFilter=Sn.LINEAR,i._mipFilter=Sn.NONE,i._addressU=yn.WRAP,i._addressV=yn.WRAP,i._addressW=yn.WRAP,i._maxAnisotropy=16,i._cmpFunc=gn.NEVER,i._borderColor=new Er,i._minLOD=0,i._maxLOD=0,i._mipLODBias=0,i._device=t,i}return a(t,e),s(t,[{key:"minFilter",get:function(){return this._minFilter}},{key:"magFilter",get:function(){return this._magFilter}},{key:"mipFilter",get:function(){return this._mipFilter}},{key:"addressU",get:function(){return this._addressU}},{key:"addressV",get:function(){return this._addressV}},{key:"addressW",get:function(){return this._addressW}},{key:"maxAnisotropy",get:function(){return this._maxAnisotropy}},{key:"cmpFunc",get:function(){return this._cmpFunc}},{key:"borderColor",get:function(){return this._borderColor}},{key:"minLOD",get:function(){return this._minLOD}},{key:"maxLOD",get:function(){return this._maxLOD}},{key:"mipLODBias",get:function(){return this._mipLODBias}}]),t}(Vn)),kr=e("dr",(function(e,t){void 0===e&&(e=Cn.NONE),void 0===t&&(t=""),this.stage=e,this.source=t})),zr=e("ds",(function(e,t,i){void 0===e&&(e=""),void 0===t&&(t=on.UNKNOWN),void 0===i&&(i=1),this.name=e,this.type=t,this.count=i})),Vr=e("dt",(function(e,t,i,n,r){void 0===e&&(e=-1),void 0===t&&(t=-1),void 0===i&&(i=""),void 0===n&&(n=[]),void 0===r&&(r=1),this.set=e,this.binding=t,this.name=i,this.members=n,this.count=r})),Wr=e("du",(function(e,t,i,n,r){void 0===e&&(e=-1),void 0===t&&(t=-1),void 0===i&&(i=""),void 0===n&&(n=on.UNKNOWN),void 0===r&&(r=1),this.set=e,this.binding=t,this.name=i,this.type=n,this.count=r})),Yr=e("dv",(function(e,t,i,n,r){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===i&&(i=[]),void 0===n&&(n=[]),void 0===r&&(r=[]),this.name=e,this.stages=t,this.attributes=i,this.blocks=n,this.samplers=r})),Xr=e("dw",function(e){function t(i){var n;return(n=e.call(this,tn.SHADER)||this)._device=void 0,n._id=void 0,n._name="",n._stages=[],n._attributes=[],n._blocks=[],n._samplers=[],n._device=i,n._id=t._shaderIdGen++,n}return a(t,e),s(t,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(Vn));Xr._shaderIdGen=0;var jr=e("dx",(function(e,t,i,n,r,s,a,o,h,u){void 0===t&&(t=In.NONE),void 0===i&&(i=hn.UNKNOWN),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=Nn.NONE),void 0===a&&(a=1),void 0===o&&(o=1),void 0===h&&(h=On.X1),void 0===u&&(u=1),this.type=e,this.usage=t,this.format=i,this.width=n,this.height=r,this.flags=s,this.layerCount=a,this.levelCount=o,this.samples=h,this.depth=u})),Kr=e("dy",(function(e,t,i,n,r,s,a){void 0===t&&(t=Rn.TEX2D),void 0===i&&(i=hn.UNKNOWN),void 0===n&&(n=0),void 0===r&&(r=1),void 0===s&&(s=0),void 0===a&&(a=1),this.texture=e,this.type=t,this.format=i,this.baseLevel=n,this.levelCount=r,this.baseLayer=s,this.layerCount=a}));function Zr(e){return e>0&&0==(e&e-1)}var Qr=e("dz",function(e){function t(t){var i;return(i=e.call(this,tn.TEXTURE)||this)._device=void 0,i._type=Rn.TEX2D,i._usage=In.NONE,i._format=hn.UNKNOWN,i._width=0,i._height=0,i._depth=1,i._layerCount=1,i._levelCount=1,i._samples=On.X1,i._flags=Nn.NONE,i._isPowerOf2=!1,i._size=0,i._buffer=null,i._device=t,i}return a(t,e),s(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),t}(Vn)),qr={Device:hr,Buffer:nr,Texture:Qr,Sampler:Hr,Shader:Xr,InputAssembler:mr,RenderPass:Ur,Framebuffer:lr,PipelineState:Lr,CommandBuffer:sr,Queue:Pr,FormatSize:jn,FormatSurfaceSize:Kn,GetTypeSize:Qn,getTypedArrayConstructor:qn,MAX_ATTACHMENTS:sn,ObjectType:tn,Obj:Vn,AttributeName:an,Type:on,Format:hn,BufferUsageBit:un,MemoryUsageBit:ln,BufferFlagBit:_n,BufferAccessBit:cn,PrimitiveMode:dn,PolygonMode:fn,ShadeModel:pn,CullMode:mn,ComparisonFunc:gn,StencilOp:vn,BlendOp:En,BlendFactor:Tn,ColorMask:An,Filter:Sn,Address:yn,TextureType:Rn,TextureUsageBit:In,SampleCount:On,TextureFlagBit:Nn,ShaderStageFlagBit:Cn,DescriptorType:bn,CommandBufferType:wn,LoadOp:Ln,StoreOp:Mn,TextureLayout:Pn,PipelineBindPoint:Bn,DynamicStateFlagBit:Fn,StencilFace:xn,QueueType:Dn,Rect:gr,Viewport:vr,Color:Er,ClearFlag:Un,Offset:Tr,Extent:Ar,TextureSubres:Sr,TextureCopy:yr,BufferTextureCopy:Rr,FormatType:Gn,FormatInfo:Wn,MemoryStatus:Yn,FormatInfos:Xn},Jr=e("c1",bn.UNIFORM_BUFFER|bn.DYNAMIC_UNIFORM_BUFFER|bn.STORAGE_BUFFER|bn.DYNAMIC_STORAGE_BUFFER),$r=e("c2",bn.SAMPLER),es=e("c3",(function(e){this.layout=e})),ts=e("c4",function(e){function t(t){var i;return(i=e.call(this,tn.DESCRIPTOR_SET)||this)._device=void 0,i._layout=null,i._buffers=[],i._textures=[],i._samplers=[],i._isDirty=!1,i._device=t,i}a(t,e),s(t,[{key:"layout",get:function(){return this._layout}}]);var i=t.prototype;return i.bindBuffer=function(e,t,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[e],r=this._layout.bindings[n];if(r)if(r.descriptorType&Jr){var s=this._layout.descriptorIndices[e];this._buffers[s+i]!==t&&(this._buffers[s+i]=t,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.UNIFORM_BUFFER.")},i.bindSampler=function(e,t,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[e],r=this._layout.bindings[n];if(r)if(r.descriptorType&$r){var s=this._layout.descriptorIndices[e];this._samplers[s+i]!==t&&(this._samplers[s+i]=t,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.SAMPLER.")},i.bindTexture=function(e,t,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[e],r=this._layout.bindings[n];if(r)if(r.descriptorType&$r){var s=this._layout.descriptorIndices[e];this._textures[s+i]!==t&&(this._textures[s+i]=t,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.SAMPLER.")},i.getBuffer=function(e,t){void 0===t&&(t=0);var i=this._layout.descriptorIndices[e];return this._buffers[i+t]},i.getSampler=function(e,t){void 0===t&&(t=0);var i=this._layout.descriptorIndices[e];return this._samplers[i+t]},i.getTexture=function(e,t){void 0===t&&(t=0);var i=this._layout.descriptorIndices[e];return this._textures[i+t]},t}(Vn)),is=e("d2",(function(e,t,i,n,r){void 0===e&&(e=-1),void 0===t&&(t=bn.UNKNOWN),void 0===i&&(i=0),void 0===n&&(n=Cn.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=i,this.stageFlags=n,this.immutableSamplers=r})),ns=e("d3",(function(e){void 0===e&&(e=[]),this.bindings=e})),rs=e("d4",bn.DYNAMIC_STORAGE_BUFFER|bn.DYNAMIC_UNIFORM_BUFFER),ss=e("d5",function(e){function t(t){var i;return(i=e.call(this,tn.DESCRIPTOR_SET_LAYOUT)||this)._device=void 0,i._bindings=[],i._bindingIndices=[],i._descriptorIndices=[],i._device=t,i}return a(t,e),s(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(Vn)),as=e("d6",(function(e){void 0===e&&(e=[]),this.setLayouts=e})),os=e("d7",function(e){function t(t){var i;return(i=e.call(this,tn.PIPELINE_LAYOUT)||this)._device=void 0,i._setLayouts=[],i._device=t,i}return a(t,e),s(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(Vn)),hs=e("df",(function(){})),us=e("dg",function(e){function t(t){var i;return(i=e.call(this,tn.FENCE)||this)._device=void 0,i._device=t,i}return a(t,e),t}(Vn));h(u,"cc",[{name:"GFXDynamicState",newName:"DynamicStateFlagBit"},{name:"GFXBindingType",newName:"DescriptorType"},{name:"GFXBindingLayout",newName:"DescriptorSet"}]),l(sr.prototype,"CommandBuffer.prototype",[{name:"bindBindingLayout",suggest:"Use `bindDescriptorSet` instead"}]);var ls,_s={MAX_ATTACHMENTS:"GFX_MAX_ATTACHMENTS",Obj:"GFXObject",getTypedArrayConstructor:""};for(var cs in qr){var ds=_s[cs];""!==ds&&(void 0===ds&&(ds="GFX"+cs),h(u,"cc",[{name:ds,newName:cs,target:u.gfx,targetName:"cc.gfx"}]))}u.gfx=qr,e("bq",Object.freeze({__proto__:null,DESCRIPTOR_BUFFER_TYPE:Jr,DESCRIPTOR_SAMPLER_TYPE:$r,DescriptorSetInfo:es,DescriptorSet:ts,DrawInfo:Jn,DRAW_INFO_SIZE:$n,IndirectBuffer:er,BufferInfo:tr,BufferViewInfo:ir,Buffer:nr,CommandBufferInfo:rr,CommandBuffer:sr,MAX_ATTACHMENTS:sn,get ObjectType(){return tn},Obj:Vn,get AttributeName(){return an},get Type(){return on},get Format(){return hn},get BufferUsageBit(){return un},get MemoryUsageBit(){return ln},get BufferFlagBit(){return _n},get BufferAccessBit(){return cn},get PrimitiveMode(){return dn},get PolygonMode(){return fn},get ShadeModel(){return pn},get CullMode(){return mn},get ComparisonFunc(){return gn},get StencilOp(){return vn},get BlendOp(){return En},get BlendFactor(){return Tn},get ColorMask(){return An},get Filter(){return Sn},get Address(){return yn},get TextureType(){return Rn},get TextureUsageBit(){return In},get SampleCount(){return On},get TextureFlagBit(){return Nn},get ShaderStageFlagBit(){return Cn},get DescriptorType(){return bn},get CommandBufferType(){return wn},get LoadOp(){return Ln},get StoreOp(){return Mn},get TextureLayout(){return Pn},get PipelineBindPoint(){return Bn},get DynamicStateFlagBit(){return Fn},get StencilFace(){return xn},get QueueType(){return Dn},get ClearFlag(){return Un},get FormatType(){return Gn},get API(){return Hn},get SurfaceTransform(){return kn},get Feature(){return zn},FormatInfo:Wn,MemoryStatus:Yn,FormatInfos:Xn,FormatSize:jn,FormatSurfaceSize:Kn,GetTypeSize:Qn,getTypedArrayConstructor:qn,Rect:gr,Viewport:vr,Color:Er,Offset:Tr,Extent:Ar,TextureSubres:Sr,TextureCopy:yr,BufferTextureCopy:Rr,BindingMappingInfo:ar,DeviceInfo:or,Device:hr,FramebufferInfo:ur,Framebuffer:lr,Attribute:fr,InputAssemblerInfo:pr,InputAssembler:mr,DescriptorSetLayoutBinding:is,DescriptorSetLayoutInfo:ns,DESCRIPTOR_DYNAMIC_TYPE:rs,DescriptorSetLayout:ss,PipelineLayoutInfo:as,PipelineLayout:os,RasterizerState:Ir,DepthStencilState:Or,BlendTarget:Nr,BlendState:Cr,InputState:br,PipelineStateInfo:wr,PipelineState:Lr,FenceInfo:hs,Fence:us,QueueInfo:Mr,Queue:Pr,ColorAttachment:Br,DepthStencilAttachment:Fr,SubPassInfo:xr,RenderPassInfo:Dr,RenderPass:Ur,SamplerInfo:Gr,Sampler:Hr,ShaderStage:kr,Uniform:zr,UniformBlock:Vr,UniformSampler:Wr,ShaderInfo:Yr,Shader:Xr,TextureInfo:jr,TextureViewInfo:Kr,IsPowerOf2:Zr,Texture:Qr})),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(ls||(ls=e("eq",{})));var fs,ps,ms,gs,vs,Es,Ts=(fs=new r(0,0,0),function(e,t){var i=r.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;r.multiplyScalar(fs,t.n,t.d);var n=r.dot(r.subtract(fs,fs,e.o),t.n)/i;return n<0?0:n}),As=(ps=new r(0,0,0),ms=new r(0,0,0),gs=new r(0,0,0),vs=new r(0,0,0),Es=new r(0,0,0),function(e,t,i){r.subtract(ps,t.b,t.a),r.subtract(ms,t.c,t.a),r.cross(gs,e.d,ms);var n=r.dot(ps,gs);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var s=1/n;r.subtract(vs,e.o,t.a);var a=r.dot(vs,gs)*s;if(a<0||a>1)return 0;r.cross(Es,vs,ps);var o=r.dot(e.d,Es)*s;if(o<0||a+o>1)return 0;var h=r.dot(ms,Es)*s;return h<0?0:h}),Ss=function(){var e=new r(0,0,0);return function(t,i){var n=i.radius,s=i.center,a=t.o,o=t.d,h=n*n;r.subtract(e,s,a);var u=e.lengthSqr(),l=r.dot(e,o),_=h-(u-l*l);if(_<0)return 0;var c=Math.sqrt(_),d=u<h?l+c:l-c;return d<0?0:d}}(),ys=function(){var e=new r,t=new r;return function(i,n){return r.subtract(e,n.center,n.halfExtents),r.add(t,n.center,n.halfExtents),Rs(i,e,t)}}();function Rs(e,t,i){var n=e.o,r=e.d,s=1/r.x,a=1/r.y,o=1/r.z,h=(t.x-n.x)*s,u=(i.x-n.x)*s,l=(t.y-n.y)*a,_=(i.y-n.y)*a,c=(t.z-n.z)*o,d=(i.z-n.z)*o,f=Math.max(Math.max(Math.min(h,u),Math.min(l,_)),Math.min(c,d)),p=Math.min(Math.min(Math.max(h,u),Math.max(l,_)),Math.max(c,d));return p<0||f>p?0:f>0?f:p}var Is,Os,Ns=function(){var e=new r,t=new r,i=new r,n=new r,s=new r,a=new r,o=new r,h=new Array(3),u=new Array(3),l=new Array(3),_=new Array(6);return function(c,d){h[0]=d.halfExtents.x,h[1]=d.halfExtents.y,h[2]=d.halfExtents.z,e=d.center,t=c.o,i=c.d,r.set(n,d.orientation.m00,d.orientation.m01,d.orientation.m02),r.set(s,d.orientation.m03,d.orientation.m04,d.orientation.m05),r.set(a,d.orientation.m06,d.orientation.m07,d.orientation.m08),r.subtract(o,e,t),u[0]=r.dot(n,i),u[1]=r.dot(s,i),u[2]=r.dot(a,i),l[0]=r.dot(n,o),l[1]=r.dot(s,o),l[2]=r.dot(a,o);for(var f=0;f<3;++f){if(0===u[f]){if(-l[f]-h[f]>0||-l[f]+h[f]<0)return 0;u[f]=1e-7}_[2*f+0]=(l[f]+h[f])/u[f],_[2*f+1]=(l[f]-h[f])/u[f]}var p=Math.max(Math.max(Math.min(_[0],_[1]),Math.min(_[2],_[3])),Math.min(_[4],_[5])),m=Math.min(Math.min(Math.max(_[0],_[1]),Math.max(_[2],_[3])),Math.max(_[4],_[5]));return m<0||p>m?0:p>0?p:m}}(),Cs=function(){var e=new r,t=new r,i=new r,n=new r,s=new r,a=new r,o=new r,h=new nn;return function(u,l){var _=l.radius*l.radius,c=r.normalize(e,u.d),d=l.ellipseCenter0,f=l.ellipseCenter1,p=r.subtract(t,f,d);if(p.equals(r.ZERO))return h.radius=l.radius,h.center.set(l.ellipseCenter0),ca.raySphere(u,h);var m=u.o,g=r.subtract(i,m,d),v=r.cross(n,c,p),E=v.lengthSqr();if(0===E){h.radius=l.radius;var T=r.subtract(s,f,m);return g.lengthSqr()<T.lengthSqr()?h.center.set(l.ellipseCenter0):h.center.set(l.ellipseCenter1),ca.raySphere(u,h)}var A=r.cross(s,g,p),S=p.lengthSqr(),y=2*r.dot(v,A),R=y*y-4*E*(A.lengthSqr()-_*S);if(R<0)return 0;var I=(-y-Math.sqrt(R))/(2*E);if(I<0){h.radius=l.radius;var O=r.subtract(a,f,m);return g.lengthSqr()<O.lengthSqr()?h.center.set(l.ellipseCenter0):h.center.set(l.ellipseCenter1),ca.raySphere(u,h)}var N=r.scaleAndAdd(a,u.o,c,I),C=r.subtract(o,N,d),b=r.dot(C,p)/S;return b>=0&&b<=1?I:b<0?(h.radius=l.radius,h.center.set(l.ellipseCenter0),ca.raySphere(u,h)):b>1?(h.radius=l.radius,h.center.set(l.ellipseCenter1),ca.raySphere(u,h)):0}}(),bs=function(){var e=rn.create(),t={distance:1/0,doubleSided:!1,mode:ls.ANY},i=0,n=function(e,t,n,r,s,a){e===ls.CLOSEST?(i>t||0===i)&&(i=t,a&&(0===a.length?a.push({distance:t,vertexIndex0:n/3,vertexIndex1:r/3,vertexIndex2:s/3}):(a[0].distance=t,a[0].vertexIndex0=n/3,a[0].vertexIndex1=r/3,a[0].vertexIndex2=s/3))):(i=t,a&&a.push({distance:t,vertexIndex0:n/3,vertexIndex1:r/3,vertexIndex2:s/3}))};return function(s,a,o){if(i=0,0===a.geometricInfo.positions.length)return i;var h=void 0===o?t:o;if(Rs(s,a.geometricInfo.boundingBox.min,a.geometricInfo.boundingBox.max)){var u=a.primitiveMode,l=a.geometricInfo;!function(t,i,s,a,o){if(s===dn.TRIANGLE_LIST)for(var h=i.length,u=0;u<h;u+=3){var l=3*i[u],_=3*i[u+1],c=3*i[u+2];r.set(e.a,t[l],t[l+1],t[l+2]),r.set(e.b,t[_],t[_+1],t[_+2]),r.set(e.c,t[c],t[c+1],t[c+2]);var d=ca.rayTriangle(a,e,o.doubleSided);if(!(0===d||d>o.distance)&&(n(o.mode,d,l,_,c,o.result),o.mode===ls.ANY))return d}else if(s===dn.TRIANGLE_STRIP)for(var f=i.length-2,p=0,m=0;m<f;m+=1){var g=3*i[m-p],v=3*i[m+p+1],E=3*i[m+2];r.set(e.a,t[g],t[g+1],t[g+2]),r.set(e.b,t[v],t[v+1],t[v+2]),r.set(e.c,t[E],t[E+1],t[E+2]),p=~p;var T=ca.rayTriangle(a,e,o.doubleSided);if(!(0===T||T>o.distance)&&(n(o.mode,T,g,v,E,o.result),o.mode===ls.ANY))return T}else if(s===dn.TRIANGLE_FAN){var A=i.length-1,S=3*i[0];r.set(e.a,t[S],t[S+1],t[S+2]);for(var y=1;y<A;y+=1){var R=3*i[y],I=3*i[y+1];r.set(e.b,t[R],t[R+1],t[R+2]),r.set(e.c,t[I],t[I+1],t[I+2]);var O=ca.rayTriangle(a,e,o.doubleSided);if(!(0===O||O>o.distance)&&(n(o.mode,O,S,R,I,o.result),o.mode===ls.ANY))return O}}}(l.positions,l.indices,u,s,h)}return i}}(),ws=(Is=0,Os={distance:1/0,doubleSided:!1,mode:ls.ANY},function(e,t,i){Is=0;var n=void 0===i?Os:i,r=t.renderingSubMeshes.length,s=t.struct.minPosition,a=t.struct.maxPosition;if(s&&a&&!Rs(e,s,a))return Is;for(var o=0;o<r;o++){var h=t.renderingSubMeshes[o],u=bs(e,h,n);if(u)if(n.mode===ls.CLOSEST)(0===Is||Is>u)&&(Is=u,n.subIndices&&(n.subIndices[0]=o));else if(Is=u,n.subIndices&&n.subIndices.push(o),n.mode===ls.ANY)return u}return Is&&n.mode===ls.CLOSEST&&(n.result&&(n.result[0].distance=Is,n.result.length=1),n.subIndices&&(n.subIndices.length=1)),Is}),Ls=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:ls.ANY},i=new Rt,n=new _;return function(s,a,o){e=0;var h=void 0===o?t:o,u=a.worldBounds;if(u&&!ys(s,u))return e;Rt.copy(i,s),a.node&&(_.invert(n,a.node.getWorldMatrix(n)),r.transformMat4(i.o,s.o,n),r.transformMat4Normal(i.d,s.d,n));for(var l=a.subModels,c=0;c<l.length;c++){var d=l[c].subMesh,f=bs(i,d,h);if(f)if(h.mode===ls.CLOSEST)(0===e||e>f)&&(e=f,h.subIndices&&(h.subIndices[0]=c));else if(e=f,h.subIndices&&h.subIndices.push(c),h.mode===ls.ANY)return f}return e&&h.mode===ls.CLOSEST&&(h.result&&(h.result[0].distance=e,h.result.length=1),h.subIndices&&(h.subIndices.length=1)),e}}(),Ms=function(){var e=new r(0,0,0);return function(t,i){r.subtract(e,t.e,t.s);var n=(i.d-r.dot(t.s,i.n))/r.dot(e,i.n);return n<0||n>1?0:n}}(),Ps=function(){var e=new r(0,0,0),t=new r(0,0,0),i=new r(0,0,0),n=new r(0,0,0),s=new r(0,0,0),a=new r(0,0,0);return function(o,h,u){r.subtract(e,h.b,h.a),r.subtract(t,h.c,h.a),r.subtract(i,o.s,o.e),r.cross(s,e,t);var l=r.dot(i,s);if(l<=0)return 0;r.subtract(n,o.s,h.a);var _=r.dot(n,s);if(_<0||_>l)return 0;r.cross(a,i,n);var c=r.dot(t,a);if(c<0||c>l)return 0;var d=-r.dot(e,a);if(d<0||c+d>l)return 0;if(u){var f=1/l,p=1-(c*=f)-(d*=f);r.set(u,h.a.x*p+h.b.x*c+h.c.x*d,h.a.y*p+h.b.y*c+h.c.y*d,h.a.z*p+h.b.z*c+h.c.z*d)}return 1}}(),Bs=new Rt;function Fs(e,t){Bs.o.set(e.s),r.subtract(Bs.d,e.e,e.s),Bs.d.normalize();var i=ys(Bs,t);return i<=e.length()?i:0}function xs(e,t){Bs.o.set(e.s),r.subtract(Bs.d,e.e,e.s),Bs.d.normalize();var i=Ns(Bs,t);return i<=e.length()?i:0}function Ds(e,t){Bs.o.set(e.s),r.subtract(Bs.d,e.e,e.s),Bs.d.normalize();var i=Ss(Bs,t);return i<=e.length()?i:0}var Us,Gs,Hs,ks,zs=(Us=new r,Gs=new r,Hs=new r,ks=new r,function(e,t){return r.subtract(Us,e.center,e.halfExtents),r.add(Gs,e.center,e.halfExtents),r.subtract(Hs,t.center,t.halfExtents),r.add(ks,t.center,t.halfExtents),Us.x<=ks.x&&Gs.x>=Hs.x&&Us.y<=ks.y&&Gs.y>=Hs.y&&Us.z<=ks.z&&Gs.z>=Hs.z});function Vs(e,t,i,n,s,a){r.set(a[0],e.x+i.x*t.x+n.x*t.y+s.x*t.z,e.y+i.y*t.x+n.y*t.y+s.y*t.z,e.z+i.z*t.x+n.z*t.y+s.z*t.z),r.set(a[1],e.x-i.x*t.x+n.x*t.y+s.x*t.z,e.y-i.y*t.x+n.y*t.y+s.y*t.z,e.z-i.z*t.x+n.z*t.y+s.z*t.z),r.set(a[2],e.x+i.x*t.x-n.x*t.y+s.x*t.z,e.y+i.y*t.x-n.y*t.y+s.y*t.z,e.z+i.z*t.x-n.z*t.y+s.z*t.z),r.set(a[3],e.x+i.x*t.x+n.x*t.y-s.x*t.z,e.y+i.y*t.x+n.y*t.y-s.y*t.z,e.z+i.z*t.x+n.z*t.y-s.z*t.z),r.set(a[4],e.x-i.x*t.x-n.x*t.y-s.x*t.z,e.y-i.y*t.x-n.y*t.y-s.y*t.z,e.z-i.z*t.x-n.z*t.y-s.z*t.z),r.set(a[5],e.x+i.x*t.x-n.x*t.y-s.x*t.z,e.y+i.y*t.x-n.y*t.y-s.y*t.z,e.z+i.z*t.x-n.z*t.y-s.z*t.z),r.set(a[6],e.x-i.x*t.x+n.x*t.y-s.x*t.z,e.y-i.y*t.x+n.y*t.y-s.y*t.z,e.z-i.z*t.x+n.z*t.y-s.z*t.z),r.set(a[7],e.x-i.x*t.x-n.x*t.y+s.x*t.z,e.y-i.y*t.x-n.y*t.y+s.y*t.z,e.z-i.z*t.x-n.z*t.y+s.z*t.z)}function Ws(e,t){for(var i=r.dot(t,e[0]),n=i,s=1;s<8;++s){var a=r.dot(t,e[s]);i=a<i?a:i,n=a>n?a:n}return[i,n]}var Ys,Xs,js,Ks=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new r(0,0,0);for(var i=new Array(8),n=new Array(8),s=0;s<8;s++)i[s]=new r(0,0,0),n[s]=new r(0,0,0);var a=new r,o=new r;return function(t,s){r.set(e[0],1,0,0),r.set(e[1],0,1,0),r.set(e[2],0,0,1),r.set(e[3],s.orientation.m00,s.orientation.m01,s.orientation.m02),r.set(e[4],s.orientation.m03,s.orientation.m04,s.orientation.m05),r.set(e[5],s.orientation.m06,s.orientation.m07,s.orientation.m08);for(var h=0;h<3;++h)r.cross(e[6+3*h],e[h],e[0]),r.cross(e[7+3*h],e[h],e[1]),r.cross(e[7+3*h],e[h],e[2]);r.subtract(a,t.center,t.halfExtents),r.add(o,t.center,t.halfExtents),function(e,t,i){r.set(i[0],e.x,t.y,t.z),r.set(i[1],e.x,t.y,e.z),r.set(i[2],e.x,e.y,t.z),r.set(i[3],e.x,e.y,e.z),r.set(i[4],t.x,t.y,t.z),r.set(i[5],t.x,t.y,e.z),r.set(i[6],t.x,e.y,t.z),r.set(i[7],t.x,e.y,e.z)}(a,o,i),Vs(s.center,s.halfExtents,e[3],e[4],e[5],n);for(var u=0;u<15;++u){var l=Ws(i,e[u]),_=Ws(n,e[u]);if(_[0]>l[1]||l[0]>_[1])return 0}return 1}}(),Zs=function(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=r.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1},Qs=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Zs(e,t.planes[i]))return 0;return 1},qs=function(){for(var e=new Array(8),t=0,i=0,n=0;n<e.length;n++)e[n]=new r(0,0,0);return function(n,s){for(var a=0,o=!1,h=0;h<s.planes.length;h++){if(-1===(a=Zs(n,s.planes[h])))return 0;1===a&&(o=!0)}if(!o)return 1;for(var u=0;u<s.vertices.length;u++)r.subtract(e[u],s.vertices[u],n.center);t=0,i=0;for(var l=0;l<s.vertices.length;l++)e[l].x>n.halfExtents.x?t++:e[l].x<-n.halfExtents.x&&i++;if(t===s.vertices.length||i===s.vertices.length)return 0;t=0,i=0;for(var _=0;_<s.vertices.length;_++)e[_].y>n.halfExtents.y?t++:e[_].y<-n.halfExtents.y&&i++;if(t===s.vertices.length||i===s.vertices.length)return 0;t=0,i=0;for(var c=0;c<s.vertices.length;c++)e[c].z>n.halfExtents.z?t++:e[c].z<-n.halfExtents.z&&i++;return t===s.vertices.length||i===s.vertices.length?0:1}}(),Js=(Ys=new r(0,0,0),Xs=new c,function(e,t){return r.subtract(Ys,t,e.center),r.transformMat3(Ys,Ys,c.transpose(Xs,e.orientation)),i=Ys,n=e.halfExtents,Math.abs(i.x)<n.x&&Math.abs(i.y)<n.y&&Math.abs(i.z)<n.z;var i,n}),$s=(js=function(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)},function(e,t){var i=e.halfExtents.x*js(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*js(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*js(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),n=r.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1}),ea=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===$s(e,t.planes[i]))return 0;return 1},ta=function(){for(var e=new Array(8),t=0,i=0,n=0,s=0;s<e.length;s++)e[s]=new r(0,0,0);var a=function(e,t,i,n){return e.x*t+e.y*i+e.z*n};return function(s,o){for(var h=0,u=!1,l=0;l<o.planes.length;l++){if(-1===(h=$s(s,o.planes[l])))return 0;1===h&&(u=!0)}if(!u)return 1;for(var _=0;_<o.vertices.length;_++)r.subtract(e[_],o.vertices[_],s.center);i=0,n=0;for(var c=0;c<o.vertices.length;c++)(t=a(e[c],s.orientation.m00,s.orientation.m01,s.orientation.m02))>s.halfExtents.x?i++:t<-s.halfExtents.x&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(var d=0;d<o.vertices.length;d++)(t=a(e[d],s.orientation.m03,s.orientation.m04,s.orientation.m05))>s.halfExtents.y?i++:t<-s.halfExtents.y&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(var f=0;f<o.vertices.length;f++)(t=a(e[f],s.orientation.m06,s.orientation.m07,s.orientation.m08))>s.halfExtents.z?i++:t<-s.halfExtents.z&&n++;return i===o.vertices.length||n===o.vertices.length?0:1}}(),ia=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new r(0,0,0);for(var i=new Array(8),n=new Array(8),s=0;s<8;s++)i[s]=new r(0,0,0),n[s]=new r(0,0,0);return function(t,s){r.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),r.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),r.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),r.set(e[3],s.orientation.m00,s.orientation.m01,s.orientation.m02),r.set(e[4],s.orientation.m03,s.orientation.m04,s.orientation.m05),r.set(e[5],s.orientation.m06,s.orientation.m07,s.orientation.m08);for(var a=0;a<3;++a)r.cross(e[6+3*a],e[a],e[0]),r.cross(e[7+3*a],e[a],e[1]),r.cross(e[7+3*a],e[a],e[2]);Vs(t.center,t.halfExtents,e[0],e[1],e[2],i),Vs(s.center,s.halfExtents,e[3],e[4],e[5],n);for(var o=0;o<15;++o){var h=Ws(i,e[o]),u=Ws(n,e[o]);if(u[0]>h[1]||h[0]>u[1])return 0}return 1}}(),na=function(){for(var e=new nn,t=new r,i=new r,n=new r,s=new Array(8),a=0;a<8;a++)s[a]=new r;for(var o=new Array(8),h=0;h<8;h++)o[h]=new r;return function(a,h){if(0===r.squaredDistance(h.ellipseCenter0,h.ellipseCenter1))return e.radius=h.radius,e.center.set(h.ellipseCenter0),ca.sphereOBB(e,a);t.x=a.orientation.m00,t.y=a.orientation.m01,t.z=a.orientation.m02,i.x=a.orientation.m03,i.y=a.orientation.m04,i.z=a.orientation.m05,n.x=a.orientation.m06,n.y=a.orientation.m07,n.z=a.orientation.m08,Vs(a.center,a.halfExtents,t,i,n,s);var u=o,l=r.copy(u[0],t),_=r.copy(u[1],i),c=r.copy(u[2],n);r.subtract(u[3],h.center,a.center).normalize();var d=r.subtract(u[4],h.ellipseCenter0,h.ellipseCenter1);d.normalize(),r.cross(u[5],l,d),r.cross(u[6],_,d),r.cross(u[7],c,d);for(var f=0;f<8;++f){var p=Ws(s,u[f]),m=r.dot(u[f],h.ellipseCenter0),g=r.dot(u[f],h.ellipseCenter1),v=Math.max(m,g),E=Math.min(m,g)-h.radius,T=v+h.radius;if(E>p[1]||p[0]>T)return 0}return 1}}(),ra=function(e,t){var i=r.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1},sa=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===ra(e,t.planes[i]))return 0;return 1},aa=function(){var e=new r(0,0,0),t=[1,-1,1,-1,1,-1];return function(i,n){for(var s=0;s<6;s++){var a=n.planes[s],o=i.radius,h=i.center,u=a.n,l=a.d,_=r.dot(u,h);if(_+o<l)return 0;if(!(_-o>l)){r.add(e,h,r.multiplyScalar(e,u,o));for(var c=0;c<6;c++)if(c!==s&&c!==s+t[s]){var d=n.planes[c];if(r.dot(d.n,e)<d.d)return 0}}}return 1}}(),oa=function(e,t){var i=e.radius+t.radius;return r.squaredDistance(e.center,t.center)<i*i},ha=function(){var e=new r;return function(t,i){return $e(e,t.center,i),r.squaredDistance(t.center,e)<t.radius*t.radius}}(),ua=function(){var e=new r;return function(t,i){return et(e,t.center,i),r.squaredDistance(t.center,e)<t.radius*t.radius}}(),la=function(){var e=new r,t=new r;return function(i,n){var s=i.radius+n.radius,a=s*s,o=r.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===o)return r.squaredDistance(i.center,n.center)<a;r.subtract(e,i.center,n.ellipseCenter0),r.subtract(t,n.ellipseCenter1,n.ellipseCenter0);var h=r.dot(e,t)/o;return h<0?r.squaredDistance(i.center,n.ellipseCenter0)<a:h>1?r.squaredDistance(i.center,n.ellipseCenter1)<a:(r.scaleAndAdd(e,n.ellipseCenter0,t,h),r.squaredDistance(i.center,e)<a)}}(),_a=function(){var e=new r,t=new r,i=new r,n=new r,s=new r,a=new r;return function(o,h){var u,l,_,c,f=r.subtract(e,o.ellipseCenter1,o.ellipseCenter0),p=r.subtract(t,h.ellipseCenter1,h.ellipseCenter0),m=r.subtract(i,o.ellipseCenter0,h.ellipseCenter0),g=r.dot(f,f),v=r.dot(f,p),E=r.dot(p,p),T=r.dot(f,m),A=r.dot(p,m),S=g*E-v*v,y=S,R=S;S<d?(l=0,y=1,c=A,R=E):(c=g*A-v*T,(l=v*A-E*T)<0?(l=0,c=A,R=E):l>y&&(l=y,c=A+v,R=E)),c<0?(c=0,-T<0?l=0:-T>g?l=y:(l=-T,y=g)):c>R&&(c=R,-T+v<0?l=0:-T+v>g?l=y:(l=-T+v,y=g)),u=Math.abs(l)<d?0:l/y,_=Math.abs(c)<d?0:c/R;var I=n;I.set(m),I.add(r.multiplyScalar(s,f,u)),I.subtract(r.multiplyScalar(a,p,_));var O=o.radius+h.radius;return I.lengthSqr()<O*O}}(),ca=e("ef",{raySphere:Ss,rayAABB:ys,rayOBB:Ns,rayPlane:Ts,rayTriangle:As,rayCapsule:Cs,raySubMesh:bs,rayMesh:ws,rayModel:Ls,lineSphere:Ds,lineAABB:Fs,lineOBB:xs,linePlane:Ms,lineTriangle:Ps,sphereWithSphere:oa,sphereAABB:ha,sphereOBB:ua,spherePlane:ra,sphereFrustum:sa,sphereFrustumAccurate:aa,sphereCapsule:la,aabbWithAABB:zs,aabbWithOBB:Ks,aabbPlane:Zs,aabbFrustum:Qs,aabbFrustumAccurate:qs,obbWithOBB:ia,obbPlane:$s,obbFrustum:ea,obbFrustumAccurate:ta,obbPoint:Js,obbCapsule:na,capsuleWithCapsule:_a,resolve:function(e,t,i){void 0===i&&(i=null);var n=e._type,r=t._type,s=this[n|r];return n<r?s(e,t,i):s(t,e,i)}});ca[Ve.SHAPE_RAY|Ve.SHAPE_SPHERE]=Ss,ca[Ve.SHAPE_RAY|Ve.SHAPE_AABB]=ys,ca[Ve.SHAPE_RAY|Ve.SHAPE_OBB]=Ns,ca[Ve.SHAPE_RAY|Ve.SHAPE_PLANE]=Ts,ca[Ve.SHAPE_RAY|Ve.SHAPE_TRIANGLE]=As,ca[Ve.SHAPE_RAY|Ve.SHAPE_CAPSULE]=Cs,ca[Ve.SHAPE_LINE|Ve.SHAPE_SPHERE]=Ds,ca[Ve.SHAPE_LINE|Ve.SHAPE_AABB]=Fs,ca[Ve.SHAPE_LINE|Ve.SHAPE_OBB]=xs,ca[Ve.SHAPE_LINE|Ve.SHAPE_PLANE]=Ms,ca[Ve.SHAPE_LINE|Ve.SHAPE_TRIANGLE]=Ps,ca[Ve.SHAPE_SPHERE]=oa,ca[Ve.SHAPE_SPHERE|Ve.SHAPE_AABB]=ha,ca[Ve.SHAPE_SPHERE|Ve.SHAPE_OBB]=ua,ca[Ve.SHAPE_SPHERE|Ve.SHAPE_PLANE]=ra,ca[Ve.SHAPE_SPHERE|Ve.SHAPE_FRUSTUM]=sa,ca[Ve.SHAPE_SPHERE|Ve.SHAPE_FRUSTUM_ACCURATE]=aa,ca[Ve.SHAPE_SPHERE|Ve.SHAPE_CAPSULE]=la,ca[Ve.SHAPE_AABB]=zs,ca[Ve.SHAPE_AABB|Ve.SHAPE_OBB]=Ks,ca[Ve.SHAPE_AABB|Ve.SHAPE_PLANE]=Zs,ca[Ve.SHAPE_AABB|Ve.SHAPE_FRUSTUM]=Qs,ca[Ve.SHAPE_AABB|Ve.SHAPE_FRUSTUM_ACCURATE]=qs,ca[Ve.SHAPE_OBB]=ia,ca[Ve.SHAPE_OBB|Ve.SHAPE_PLANE]=$s,ca[Ve.SHAPE_OBB|Ve.SHAPE_FRUSTUM]=ea,ca[Ve.SHAPE_OBB|Ve.SHAPE_FRUSTUM_ACCURATE]=ta,ca[Ve.SHAPE_OBB|Ve.SHAPE_CAPSULE]=na,ca[Ve.SHAPE_CAPSULE]=_a;var da=e("eg",function(){function e(e,t,i,n,s,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===s&&(s=0),void 0===a&&(a=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Ve.SHAPE_LINE,this.s=new r(e,t,i),this.e=new r(n,s,a)}return e.create=function(t,i,n,r,s,a){return new e(t,i,n,r,s,a)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return r.copy(e.s,t.s),r.copy(e.e,t.e),e},e.fromPoints=function(e,t,i){return r.copy(e.s,t),r.copy(e.e,i),e},e.set=function(e,t,i,n,r,s,a){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=s,e.e.z=a,e},e.len=function(e){return r.distance(e.s,e.e)},s(e,[{key:"type",get:function(){return this._type}}]),e.prototype.length=function(){return r.distance(this.s,this.e)},e}()),fa=new r(0,0,0),pa=new r(0,0,0),ma=u.mat4(),ga=u.v4(),va=e("eh",function(){function e(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=1),void 0===i&&(i=0),void 0===n&&(n=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=Ve.SHAPE_PLANE,this.n=new r(e,t,i),this.d=n}return e.create=function(t,i,n,r){return new e(t,i,n,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return r.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,i,n){return r.subtract(fa,i,t),r.subtract(pa,n,t),r.normalize(e.n,r.cross(e.n,fa,pa)),e.d=r.dot(e.n,t),e},e.set=function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e},e.fromNormalAndPoint=function(e,t,i){return r.copy(e.n,t),e.d=r.dot(t,i),e},e.normalize=function(e,t){var i=t.n.length();return r.normalize(e.n,t.n),i>0&&(e.d=t.d/i),e},s(e,[{key:"type",get:function(){return this._type}},{key:"x",set:function(e){this.n.x=e},get:function(){return this.n.x}},{key:"y",set:function(e){this.n.y=e},get:function(){return this.n.y}},{key:"z",set:function(e){this.n.z=e},get:function(){return this.n.z}},{key:"w",set:function(e){this.d=e},get:function(){return this.d}}]),e.prototype.transform=function(e){_.invert(ma,e),_.transpose(ma,ma),f.set(ga,this.n.x,this.n.y,this.n.z,this.d),f.transformMat4(ga,ga,ma),r.set(this.n,ga.x,ga.y,ga.z),this.d=ga.w},e}()),Ea=new r,Ta=new r,Aa=new r,Sa=new r,ya=new c,Ra=function(e,t,i){ya.m00=Math.abs(i.m00),ya.m01=Math.abs(i.m01),ya.m02=Math.abs(i.m02),ya.m03=Math.abs(i.m04),ya.m04=Math.abs(i.m05),ya.m05=Math.abs(i.m06),ya.m06=Math.abs(i.m08),ya.m07=Math.abs(i.m09),ya.m08=Math.abs(i.m10),r.transformMat3(e,t,ya)},Ia=e("ek",function(){function e(e,t,i,n,s,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===s&&(s=1),void 0===a&&(a=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=Ve.SHAPE_AABB,this.center=new r(e,t,i),this.halfExtents=new r(n,s,a)}e.create=function(t,i,n,r,s,a){return new e(t,i,n,r,s,a)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return r.copy(e.center,t.center),r.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,i){return r.add(Ea,i,t),r.subtract(Ta,i,t),r.multiplyScalar(e.center,Ea,.5),r.multiplyScalar(e.halfExtents,Ta,.5),e},e.set=function(e,t,i,n,s,a,o){return r.set(e.center,t,i,n),r.set(e.halfExtents,s,a,o),e},e.merge=function(t,i,n){return r.subtract(Ea,i.center,i.halfExtents),r.subtract(Ta,n.center,n.halfExtents),r.add(Aa,i.center,i.halfExtents),r.add(Sa,n.center,n.halfExtents),r.max(Sa,Aa,Sa),r.min(Aa,Ea,Ta),e.fromPoints(t,Aa,Sa)},e.toBoundingSphere=function(e,t){t.getBoundary(Ea,Ta),e.center.set(Ea),e.radius=0,r.subtract(Aa,Ta,e.center);var i=Aa.length(),n=.5*i;return e.radius+=n,r.multiplyScalar(Aa,Aa,n/i),r.add(e.center,e.center,Aa),e},e.transform=function(e,t,i){return r.transformMat4(e.center,t.center,i),Ra(e.halfExtents,t.halfExtents,i),e},s(e,[{key:"type",get:function(){return this._type}}]);var t=e.prototype;return t.getBoundary=function(e,t){r.subtract(e,this.center,this.halfExtents),r.add(t,this.center,this.halfExtents)},t.transform=function(e,t,i,n,s){r.transformMat4(s.center,this.center,e),Ra(s.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},e}()),Oa=new r,Na=new r,Ca=new c,ba=e("el",function(){function e(e,t,i,n,s,a,o,h,u,l,_,d,f,p,m){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===s&&(s=1),void 0===a&&(a=1),void 0===o&&(o=1),void 0===h&&(h=0),void 0===u&&(u=0),void 0===l&&(l=0),void 0===_&&(_=1),void 0===d&&(d=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===m&&(m=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Ve.SHAPE_OBB,this.center=new r(e,t,i),this.halfExtents=new r(n,s,a),this.orientation=new c(o,h,u,l,_,d,f,p,m)}e.create=function(t,i,n,r,s,a,o,h,u,l,_,c,d,f,p){return new e(t,i,n,r,s,a,o,h,u,l,_,c,d,f,p)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return r.copy(e.center,t.center),r.copy(e.halfExtents,t.halfExtents),c.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,i){return r.multiplyScalar(e.center,r.add(Oa,t,i),.5),r.multiplyScalar(e.halfExtents,r.subtract(Na,i,t),.5),c.identity(e.orientation),e},e.set=function(e,t,i,n,s,a,o,h,u,l,_,d,f,p,m,g){return r.set(e.center,t,i,n),r.set(e.halfExtents,s,a,o),c.set(e.orientation,h,u,l,_,d,f,p,m,g),e},s(e,[{key:"type",get:function(){return this._type}}]);var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,i){Ca.m00=Math.abs(i.m00),Ca.m01=Math.abs(i.m01),Ca.m02=Math.abs(i.m02),Ca.m03=Math.abs(i.m03),Ca.m04=Math.abs(i.m04),Ca.m05=Math.abs(i.m05),Ca.m06=Math.abs(i.m06),Ca.m07=Math.abs(i.m07),Ca.m08=Math.abs(i.m08),r.transformMat3(e,t,Ca)}(Oa,this.halfExtents,this.orientation),r.subtract(e,this.center,Oa),r.add(t,this.center,Oa)},t.transform=function(e,t,i,n,s){r.transformMat4(s.center,this.center,e),c.fromQuat(s.orientation,i),r.multiply(s.halfExtents,this.halfExtents,n)},t.translateAndRotate=function(e,t,i){r.transformMat4(i.center,this.center,e),c.fromQuat(i.orientation,t)},t.setScale=function(e,t){r.multiply(t.halfExtents,this.halfExtents,e)},e}()),wa=e("em",function(){function e(e,t,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===i&&(i=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Ve.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=i,this.center=new r,this.rotation=new p,this.ellipseCenter0=new r(0,t,0),this.ellipseCenter1=new r(0,-t,0),this.updateCache()}s(e,[{key:"type",get:function(){return this._type}}]);var t=e.prototype;return t.transform=function(e,t,i,n,s){var a=n,o=m(a);s.radius=this.radius*Math.abs(o);var h=(this.halfHeight+this.radius)*Math.abs(a.y)-s.radius;h<0&&(h=0),s.halfHeight=h,r.transformMat4(s.center,this.center,e),p.multiply(s.rotation,this.rotation,i),s.updateCache()},t.updateCache=function(){this.updateLocalCenter(),r.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),r.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},e}()),La=new Array(8);La[0]=new r(1,1,1),La[1]=new r(-1,1,1),La[2]=new r(-1,-1,1),La[3]=new r(1,-1,1),La[4]=new r(1,1,-1),La[5]=new r(-1,1,-1),La[6]=new r(-1,-1,-1),La[7]=new r(1,-1,-1);var Ma,Pa,Ba,Fa=e("en",function(){function e(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=Ve.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=va.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new r}e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var i=0;i<6;++i)va.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)r.copy(e.vertices[n],t.vertices[n]);return e},s(e,[{key:"accurate",set:function(e){this._type=e?Ve.SHAPE_FRUSTUM_ACCURATE:Ve.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]);var t=e.prototype;return t.update=function(e,t){if(r.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),r.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),r.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),r.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),r.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),r.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===Ve.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],s=1/n.n.length();r.multiplyScalar(n.n,n.n,s),n.d*=s}for(var a=0;a<8;a++)r.transformMat4(this.vertices[a],La[a],t)}},t.transform=function(e){if(this._type===Ve.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)r.transformMat4(this.vertices[t],this.vertices[t],e);va.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),va.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),va.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),va.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),va.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),va.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}},e}());function xa(e,t){if(t&&e!==Ft){for(var i=t.vertices,n=pi.VERTICES,r=0;r<8;++r)Ei.setVec3(e,n,i[r]),n+=3;for(var s=t.planes,a=pi.PLANES,o=0;o<6;o++,a+=4)Ei.setVec4(e,a,s[o])}}Fa.createOrtho=(Ma=new r,function(e,t,i,n,s,a){var o=t/2,h=i/2;r.set(Ma,o,h,n),r.transformMat4(e.vertices[0],Ma,a),r.set(Ma,-o,h,n),r.transformMat4(e.vertices[1],Ma,a),r.set(Ma,-o,-h,n),r.transformMat4(e.vertices[2],Ma,a),r.set(Ma,o,-h,n),r.transformMat4(e.vertices[3],Ma,a),r.set(Ma,o,h,s),r.transformMat4(e.vertices[4],Ma,a),r.set(Ma,-o,h,s),r.transformMat4(e.vertices[5],Ma,a),r.set(Ma,-o,-h,s),r.transformMat4(e.vertices[6],Ma,a),r.set(Ma,o,-h,s),r.transformMat4(e.vertices[7],Ma,a),va.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),va.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),va.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),va.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),va.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),va.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])}),function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(Pa||(Pa=e("eI",{}))),function(e){e[e.Default=Pa.Default]="Default",e[e.Normal=Pa.Normal]="Normal",e[e.Reverse=Pa.Reverse]="Reverse",e[e.Loop=Pa.Loop]="Loop",e[e.LoopReverse=Pa.Loop|Pa.Reverse]="LoopReverse",e[e.PingPong=Pa.PingPong]="PingPong",e[e.PingPongReverse=Pa.PingPong|Pa.Reverse]="PingPongReverse"}(Ba||(Ba=e("eG",{}))),o(Ba),e("eH",function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}());var Da=g({Default:Pa.Default,Normal:Pa.Normal,Clamp:Pa.Clamp,Loop:Pa.Loop,PingPong:Pa.PingPong}),Ua=e("eo",(function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}));v.fastDefine("cc.Keyframe",Ua,{time:0,value:0,inTangent:0,outTangent:0});var Ga=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,i=this.coefficient,t*(t*(t*i[0]+i[1])+i[2])+i[3];var t,i},e}(),Ha=e("ep",function(){function e(t){void 0===t&&(t=null),this.keyFrames=void 0,this.preWrapMode=Da.Loop,this.postWrapMode=Da.Clamp,this.cachedKey=void 0,this.keyFrames=t||[].concat(e.defaultKF),this.cachedKey=new Ga}var t=e.prototype;return t.addKey=function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)},t.evaluate_slow=function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case Da.Loop:t=A(e-n,r-n)+n;break;case Da.PingPong:t=T(e-n,r-n)+n;break;case Da.Default:case Da.Normal:case Da.Clamp:t=E(e,n,r)}var s=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)s=this.keyFrames.length-2;else for(var a=0;a<this.keyFrames.length-1;a++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[a+1].time){s=a;break}var o=this.keyFrames[s],h=this.keyFrames[s+1],u=S(o.time,h.time,t),l=h.time-o.time,_=o.outTangent*l,c=h.inTangent*l,d=u*u,f=d*u,p=f-2*d+u,m=f-d,g=-2*f+3*d;return(2*f-3*d+1)*o.value+p*_+m*c+g*h.value},t.evaluate=function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case Da.Loop:t=A(e-n,r-n)+n;break;case Da.PingPong:t=T(e-n,r-n)+n;break;case Da.Default:case Da.Normal:case Da.Clamp:t=E(e,n,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var s=this.findIndex(this.cachedKey,t),a=Math.min(s+1,this.keyFrames.length-1);return this.calcOptimizedKey(this.cachedKey,s,a),this.cachedKey.evaluate(t)},t.calcOptimizedKey=function(e,t,i){var n=this.keyFrames[t],r=this.keyFrames[i];e.index=t,e.time=n.time,e.endTime=r.time;var s=r.time-n.time,a=r.value-n.value,o=1/(s*s),h=n.outTangent*s,u=r.inTangent*s;e.coefficient[0]=(h+u-a-a)*o/s,e.coefficient[1]=(a+a+a-h-h-u)*o,e.coefficient[2]=n.outTangent,e.coefficient[3]=n.value},t.findIndex=function(e,t){var i=e.index;if(-1!==i)if(t>this.keyFrames[i].time)for(var n=0;n<3;n++){var r=i+n;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var s=0;s<3;s++){var a=i-s;if(a>=0&&this.keyFrames[a-1].time<=t)return a-1}for(var o=0,h=this.keyFrames.length,u=Math.floor((o+h)/2);h-o>1;)this.keyFrames[u].time>=t?h=u:o=u+1,u=Math.floor((o+h)/2);return o},e}());function ka(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}Ha.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],v.fastDefine("cc.AnimationCurve",Ha,{preWrapMode:Da.Default,postWrapMode:Da.Default,keyFrames:[]}),h(da.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),l(ca,"intersect",[{name:"line_quad"}]),h(ca,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]),e("er",function(e){function t(){var t;return t=e.call(this)||this,ka("line","Line"),t}return a(t,e),t}(da)),e("es",function(e){function t(){var t;return t=e.call(this)||this,ka("plane","Plane"),t}return a(t,e),t}(va)),e("et",function(e){function t(){var t;return t=e.call(this)||this,ka("ray","Ray"),t}return a(t,e),t}(Rt)),e("eu",function(e){function t(){var t;return t=e.call(this)||this,ka("triangle","Triangle"),t}return a(t,e),t}(rn)),e("ev",function(e){function t(){var t;return t=e.call(this)||this,ka("sphere","Sphere"),t}return a(t,e),t}(nn)),e("ew",function(e){function t(){var t;return t=e.call(this)||this,ka("aabb","AABB"),t}return a(t,e),t}(Ia)),e("ex",function(e){function t(){var t;return t=e.call(this)||this,ka("obb","OBB"),t}return a(t,e),t}(ba)),e("ey",function(e){function t(){var t;return t=e.call(this)||this,ka("capsule","Capsule"),t}return a(t,e),t}(wa)),e("ez",function(e){function t(){var t;return t=e.call(this)||this,ka("frustum","Frustum"),t}return a(t,e),t}(Fa));var za=e("br",.26);e("bs",(za+1)/2-za);var Va=new y(2);Va.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var Wa=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var i=Va.get();if(i.key=e,i.value=t,this.count>=this.limit){var n=this.tail;delete this.datas[n.key],this.count--,this.tail=n.prev,this.tail.next=null,n.prev=null,n.next=null,Va.put(n)}this.moveToHead(i)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),Ya=/([a-zA-Z0-9Ã„Ã–ÃœÃ¤Ã¶Ã¼ÃŸÃ©Ã¨Ã§Ã Ã¹ÃªÃ¢Ã®Ã´Ã»Ð°-ÑÐ-Ð¯ÐÑ‘]+|\S)/,Xa=/^[!,.:;'}\]%\?>ã€â€˜â€œã€‹ï¼Ÿã€‚ï¼Œï¼]/,ja=/([a-zA-Z0-9Ã„Ã–ÃœÃ¤Ã¶Ã¼ÃŸÃ©Ã¨Ã§Ã Ã¹ÃªÃ¢Ã®Ã´Ã»Ð°Ã­Ã¬ÃÃŒÃ¯ÃÃ€Ã¡Ã Ã‰ÃˆÃ’Ã“Ã²Ã³ÅÅ‘Ã™ÃšÅ°ÃºÅ±Ã±Ã‘Ã¦Ã†Å“Å’ÃƒÃ‚Ã£Ã”ÃµÄ›Å¡ÄÅ™Å¾Ã½Ã¡Ã­Ã©Ã³ÃºÅ¯Å¥ÄÅˆÄšÅ ÄŒÅ˜Å½ÃÃÃ‰Ã“ÃšÅ¤Å¼ÅºÅ›Ã³Å„Å‚Ä™Ä‡Ä…Å»Å¹ÅšÃ“ÅƒÅÄ˜Ä†Ä„-ÑÐ-Ð¯ÐÑ‘]+|\S)$/,Ka=/[a-zA-Z0-9Ã„Ã–ÃœÃ¤Ã¶Ã¼ÃŸÃ©Ã¨Ã§Ã Ã¹ÃªÃ¢Ã®Ã´Ã»Ð°Ã­Ã¬ÃÃŒÃ¯ÃÃ€Ã¡Ã Ã‰ÃˆÃ’Ã“Ã²Ã³ÅÅ‘Ã™ÃšÅ°ÃºÅ±Ã±Ã‘Ã¦Ã†Å“Å’ÃƒÃ‚Ã£Ã”ÃµÄ›Å¡ÄÅ™Å¾Ã½Ã¡Ã­Ã©Ã³ÃºÅ¯Å¥ÄÅˆÄšÅ ÄŒÅ˜Å½ÃÃÃ‰Ã“ÃšÅ¤Å¼ÅºÅ›Ã³Å„Å‚Ä™Ä‡Ä…Å»Å¹ÅšÃ“ÅƒÅÄ˜Ä†Ä„-ÑÐ-Ð¯ÐÑ‘]+$/,Za=/^[a-zA-Z0-9Ã„Ã–ÃœÃ¤Ã¶Ã¼ÃŸÃ©Ã¨Ã§Ã Ã¹ÃªÃ¢Ã®Ã´Ã»Ð°Ã­Ã¬ÃÃŒÃ¯ÃÃ€Ã¡Ã Ã‰ÃˆÃ’Ã“Ã²Ã³ÅÅ‘Ã™ÃšÅ°ÃºÅ±Ã±Ã‘Ã¦Ã†Å“Å’ÃƒÃ‚Ã£Ã”ÃµÄ›Å¡ÄÅ™Å¾Ã½Ã¡Ã­Ã©Ã³ÃºÅ¯Å¥ÄÅˆÄšÅ ÄŒÅ˜Å½ÃÃÃ‰Ã“ÃšÅ¤Å¼ÅºÅ›Ã³Å„Å‚Ä™Ä‡Ä…Å»Å¹ÅšÃ“ÅƒÅÄ˜Ä†Ä„-ÑÐ-Ð¯ÐÑ‘]/;function Qa(e,t,i){var n=t,r=i,s=e[t];if(s>="\udc00"&&s<="\udfff"&&n--,void 0!==i)if(i-1!==t){var a=e[i-1];a>="\ud800"&&a<="\udbff"&&r--}else s>="\ud800"&&s<="\udbff"&&r++;return e.substring(n,r)}var qa,Ja,$a,eo,to,io,no,ro,so,ao,oo=/^(click)(\s)*=|(param)(\s)*=/,ho=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,uo=(e("by",function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,i=e.length;t<i;){var n=e.indexOf(">",t),r=-1;if(n>=0&&(r=e.lastIndexOf("<",n))<t-1&&(r=e.indexOf("<",n+1),n=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{var s=e.substring(t,r),a=e.substring(r+1,n);""===a&&(s=e.substring(t,n+1)),this._processResult(s),-1===n?n=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(a),t=n+1}}return this._resultObjectArray},t._attributeToObject=function(e){var t={},i=(e=e.trim()).match(/^(color|size)(\s)*=/),n="",r=0,s="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(r=e.indexOf(" "),n[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(s=e.substring(r+1).trim(),t.event=this._processEventHandler(s)),t}if((i=e.match(/^(br(\s)*\/)/))&&i[0].length>0&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var a="";if((i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/))&&i[0].length>0&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var o;i=e.match(ho);for(var h=!1;i;){if(n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),o=(r=(a=e.substring(n.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),o.endsWith("/")&&(o=o.slice(0,-1)),"src"===n){switch(o.charCodeAt(0)){case 34:case 39:h=!0,o=o.slice(1,-1)}t.isImage=!0,t.src=o}else if("height"===n)t.imageHeight=parseInt(o);else if("width"===n)t.imageWidth=parseInt(o);else if("align"===n){switch(o.charCodeAt(0)){case 34:case 39:o=o.slice(1,-1)}t.imageAlign=o.toLowerCase()}else"offset"===n?t.imageOffset=o:"click"===n&&(t.event=this._processEventHandler(n+"="+o));t.event&&"param"===n&&(t.event[n]=o.replace(/^\"|\"$/g,"")),i=e.match(ho)}return h&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/)){var u={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var l,_=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=e.match(_);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),l=(r=(a=e.substring(n.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),"click"===n?t.event=this._processEventHandler(n+"="+l):"color"===n?u.color=l:"width"===n&&(u.width=parseInt(l)),t.event&&"param"===n&&(t.event[n]=l.replace(/^\"|\"$/g,"")),i=e.match(_)}t.outline=u}if((i=e.match(/^(on|u|b|i)(\s)*/))&&i[0].length>0){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t._processEventHandler=function(e){for(var t=new Map,i=0,n=!1,r=e.match(oo);r;){var s=r[0],a="";if(n=!1,'"'===(e=e.substring(s.length).trim()).charAt(0))(i=e.indexOf('"',1))>-1&&(a=e.substring(1,i).trim(),n=!0),i++;else if("'"===e.charAt(0))(i=e.indexOf("'",1))>-1&&(a=e.substring(1,i).trim(),n=!0),i++;else{var o=e.match(/(\S)+/);i=(a=o?o[0]:"").length}n&&(t[s=s.substring(0,s.length-1).trim()]=a),r=(e=e.substring(i).trim()).match(oo)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)t[n]||(t[n]=i[n]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,i=R(this._specialSymbolArray);!(t=i()).done;){var n=t.value,r=n[0],s=n[1];e=e.replace(r,s)}return e},e}()),e("bz",I("cc.PrefabInfo")(($a=O((Ja=function(){b(this,"root",$a,this),b(this,"asset",eo,this),b(this,"fileId",to,this),b(this,"sync",io,this),b(this,"_synced",no,this)}).prototype,"root",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eo=O(Ja.prototype,"asset",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),to=O(Ja.prototype,"fileId",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),io=O(Ja.prototype,"sync",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),no=O(Ja.prototype,"_synced",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),qa=Ja))||qa));u._PrefabInfo=uo,e("bA",I("cc.CompPrefabInfo ")((ao=O((so=function(){b(this,"fileId",ao,this)}).prototype,"fileId",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ro=so))||ro);var lo,_o=function(){function e(){this._arrayBufferOrPaddings=[],this._length=0}var t=e.prototype;return t.setNextAlignment=function(e){if(0!==e){var t=this._length%e;if(0!==t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}},t.addBuffer=function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t},t.getLength=function(){return this._length},t.getCombined=function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(i){"number"==typeof i?t+=i:(e.set(new Uint8Array(i),t),t+=i.byteLength)})),e.buffer},e}(),co=((lo={})[Gn.UNORM]="Uint",lo[Gn.SNORM]="Int",lo[Gn.UINT]="Uint",lo[Gn.INT]="Int",lo[Gn.UFLOAT]="Float",lo[Gn.FLOAT]="Float",lo.default="Uint",lo);function fo(e){return(co[e.type]||co.default)+e.size/e.count*8}function po(e,t,i,n,r){void 0===i&&(i=hn.R32F),void 0===n&&(n=0),void 0===r&&(r=0);var s=Xn[i];r||(r=s.size);for(var a="set"+fo(s),o=s.size/s.count,h=Math.floor(t.length/s.count),u=w.isLittleEndian,l=0;l<h;++l)for(var _=n+r*l,c=0;c<s.count;++c){var d=_+o*c;e[a](d,t[s.count*l+c],u)}}function mo(e,t,i,n,r,s){void 0===t&&(t=hn.R32F),void 0===i&&(i=0),void 0===n&&(n=e.byteLength-i),void 0===r&&(r=0),void 0===s&&(s=[]);var a=Xn[t];r||(r=a.size);for(var o="get"+fo(a),h=a.size/a.count,u=Math.floor(n/r),l=w.isLittleEndian,_=0;_<u;++_)for(var c=i+r*_,d=0;d<a.count;++d){var f=c+h*d;s[a.count*_+d]=e[o](f,l)}return s}function go(e,t,i,n,r,s,a){void 0===i&&(i=hn.R32F),void 0===n&&(n=0),void 0===r&&(r=e.byteLength-n),void 0===s&&(s=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var o=Xn[i];s||(s=o.size);for(var h="set"+fo(o),u="get"+fo(o),l=o.size/o.count,_=Math.floor(r/s),c=w.isLittleEndian,d=0;d<_;++d)for(var f=n+s*d,p=0;p<o.count;++p){var m=f+l*p,g=e[u](m,c);a[h](m,t(g,p,e),c)}return a}var vo,Eo,To,Ao,So,yo,Ro,Io=1024;function Oo(e){return u.sys.capabilities.imageBitmap&&e instanceof ImageBitmap}!function(e){e[e.RGB565=hn.R5G6B5]="RGB565",e[e.RGB5A1=hn.RGB5A1]="RGB5A1",e[e.RGBA4444=hn.RGBA4]="RGBA4444",e[e.RGB888=hn.RGB8]="RGB888",e[e.RGB32F=hn.RGB32F]="RGB32F",e[e.RGBA8888=hn.RGBA8]="RGBA8888",e[e.RGBA32F=hn.RGBA32F]="RGBA32F",e[e.A8=hn.A8]="A8",e[e.I8=hn.L8]="I8",e[e.AI8=hn.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=hn.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=hn.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=Io++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=hn.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=hn.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=Io++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=hn.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=Io++]="RGBA_ETC1",e[e.RGB_ETC2=hn.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=hn.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=hn.ASTC_RGBA_4x4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=hn.ASTC_RGBA_5x4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=hn.ASTC_RGBA_5x5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=hn.ASTC_RGBA_6x5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=hn.ASTC_RGBA_6x6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=hn.ASTC_RGBA_8x5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=hn.ASTC_RGBA_8x6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=hn.ASTC_RGBA_8x8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=hn.ASTC_RGBA_10x5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=hn.ASTC_RGBA_10x6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=hn.ASTC_RGBA_10x8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=hn.ASTC_RGBA_10x10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=hn.ASTC_RGBA_12x10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=hn.ASTC_RGBA_12x12]="RGBA_ASTC_12x12"}(vo||(vo=e("ec",{}))),function(e){e[e.REPEAT=yn.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=yn.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=yn.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=yn.BORDER]="CLAMP_TO_BORDER"}(Eo||(Eo=e("eN",{}))),function(e){e[e.NONE=Sn.NONE]="NONE",e[e.LINEAR=Sn.LINEAR]="LINEAR",e[e.NEAREST=Sn.POINT]="NEAREST"}(To||(To=e("eE",{})));var No,Co=e("bG",I("cc.ImageAsset")((Ro=yo=function(e){function t(t){var i;return(i=e.call(this)||this)._nativeData=void 0,i._tex=void 0,i._exportedExts=void 0,i._format=vo.RGBA8888,i._width=0,i._height=0,i.loaded=!1,i._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&i.reset(t),i}a(t,e),s(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||Oo(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||Oo(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=vo.RGB_ETC1&&this._format<=vo.RGBA_ASTC_12x12||this._format>=vo.RGB_A_PVRTC_2BPPV1&&this._format<=vo.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}},{key:"_texture",set:function(e){this._tex=e},get:function(){if(!this._tex){var e=new u.Texture2D;e.name=this.nativeUrl,e.image=this,this._tex=e}return this._tex}}]);var i=t.prototype;return i.reset=function(e){Oo(e)||e instanceof HTMLElement?(this._nativeData=e,this._onDataComplete()):(this._nativeData=e,this._format=e.format,this._onDataComplete())},i.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Oo(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},i._serialize=function(){},i._deserialize=function(e){var i="";"string"==typeof e?i=e:(this._width=e.w,this._height=e.h,i=e.fmt);for(var n,r=u.director.root?u.director.root.device:null,s=i.split("_"),a="",o=Number.MAX_VALUE,h=this._format,l="",_=u.macro.SUPPORT_TEXTURE_FORMATS,c=R(s);!(n=c()).done;){var d=n.value.split("@"),f=parseInt(d[0],void 0),p=t.extnames[f]||d[0],m=_.indexOf(p);if(-1!==m&&m<o){var g=d[1]?parseInt(d[1]):this._format;if(!(".astc"!==p||r&&r.hasFeature(zn.FORMAT_ASTC)))continue;if(!(".pvr"!==p||r&&r.hasFeature(zn.FORMAT_PVRTC)))continue;if(!(g!==vo.RGB_ETC1&&g!==vo.RGBA_ETC1||r&&r.hasFeature(zn.FORMAT_ETC1)))continue;if(!(g!==vo.RGB_ETC2&&g!==vo.RGBA_ETC2||r&&r.hasFeature(zn.FORMAT_ETC2)))continue;if(".webp"===p&&!u.sys.capabilities.webp)continue;o=m,l=p,h=g}else a||(a=p)}l?(this._setRawAsset(l),this._format=h):a?(this._setRawAsset(a),L(3120,a,a)):L(3121)},i._onDataComplete=function(){this.loaded=!0,this.emit("load")},t}(M),yo.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],O((So=Ro).prototype,"_nativeAsset",[P],Object.getOwnPropertyDescriptor(So.prototype,"_nativeAsset"),So.prototype),Ao=So))||Ao);u.ImageAsset=Co,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.minLOD=8]="minLOD",e[e.maxLOD=9]="maxLOD",e[e.mipLODBias=10]="mipLODBias",e[e.total=11]="total"}(No||(No=e("ae",{})));var bo=[Sn.LINEAR,Sn.LINEAR,Sn.NONE,yn.WRAP,yn.WRAP,yn.WRAP,8,gn.NEVER,0,0,0],wo=e("af",Po(bo)),Lo=new Er,Mo=new Gr;function Po(e){for(var t=0,i=0,n=0;n<bo.length;n++)switch(t=e[n]||bo[n],n){case No.minFilter:i|=t;break;case No.magFilter:i|=t<<2;break;case No.mipFilter:i|=t<<4;break;case No.addressU:i|=t<<6;break;case No.addressV:i|=t<<8;break;case No.addressW:i|=t<<10;break;case No.maxAnisotropy:i|=t<<12;break;case No.cmpFunc:i|=t<<16;break;case No.minLOD:i|=t<<20;break;case No.maxLOD:i|=t<<24;break;case No.mipLODBias:i|=t<<28}return i}var Bo,Fo,xo,Do,Uo,Go,Ho,ko,zo,Vo,Wo,Yo,Xo=function(){function e(){this._cache={}}return e.prototype.getSampler=function(e,t){return t||(t=wo),this._cache[t]||(Mo.minFilter=3&t,Mo.magFilter=t>>2&3,Mo.mipFilter=t>>4&3,Mo.addressU=t>>6&3,Mo.addressV=t>>8&3,Mo.addressW=t>>10&3,Mo.maxAnisotropy=t>>12&15,Mo.cmpFunc=t>>16&15,Mo.minLOD=t>>20&15,Mo.maxLOD=t>>24&15,Mo.mipLODBias=t>>28&15,Mo.borderColor=Lo,this._cache[t]=e.createSampler(Mo))},e}(),jo=e("ah",new Xo);u.samplerLib=jo;var Ko,Zo=new x("Tex"),Qo=e("d_",I("cc.TextureBase")((Yo=Wo=function(e){function t(){var t;return t=e.call(this)||this,b(t,"_format",xo,B(t)),b(t,"_minFilter",Do,B(t)),b(t,"_magFilter",Uo,B(t)),b(t,"_mipFilter",Go,B(t)),b(t,"_wrapS",Ho,B(t)),b(t,"_wrapT",ko,B(t)),b(t,"_wrapR",zo,B(t)),b(t,"_anisotropy",Vo,B(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=[],t._samplerHash=0,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=Zo.getNewId(),t.loaded=!1,t._gfxDevice=t._getGFXDevice(),t._textureHash=dr(t._id,666),t}a(t,e),s(t,[{key:"isCompressed",get:function(){return this._format>=vo.RGB_ETC1&&this._format<=vo.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]);var i=t.prototype;return i.getId=function(){return this._id},i.getPixelFormat=function(){return this._format},i.getAnisotropy=function(){return this._anisotropy},i.setWrapMode=function(e,t,i){this._wrapS=e,this._samplerInfo[No.addressU]=e,this._wrapT=t,this._samplerInfo[No.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[No.addressW]=i),this._samplerHash=Po(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=jo.getSampler(this._gfxDevice,this._samplerHash))},i.setFilters=function(e,t){this._minFilter=e,this._samplerInfo[No.minFilter]=e,this._magFilter=t,this._samplerInfo[No.magFilter]=t,this._samplerHash=Po(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=jo.getSampler(this._gfxDevice,this._samplerHash))},i.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo[No.mipFilter]=e,this._samplerInfo[No.maxLOD]=e===To.NONE?0:15,this._samplerHash=Po(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=jo.getSampler(this._gfxDevice,this._samplerHash))},i.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo[No.maxAnisotropy]=e,this._samplerHash=Po(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=jo.getSampler(this._gfxDevice,this._samplerHash))},i.destroy=function(){var t=e.prototype.destroy.call(this);return t&&u.director.root&&u.director.root.ui&&u.director.root.ui._releaseDescriptorSetCache(this._textureHash),t},i.getHash=function(){return this._textureHash},i.getGFXTexture=function(){return null},i.getSamplerHash=function(){return this._samplerHash},i.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=jo.getSampler(this._gfxDevice,this._samplerHash):F(9302)),this._gfxSampler},i._serialize=function(){},i._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},i._getGFXDevice=function(){return u.director.root&&u.director.root.device},i._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},i._setGFXFormat=function(e){this._format=void 0===e?vo.RGBA8888:e},i._getGFXPixelFormat=function(e){return e===vo.RGBA_ETC1?e=vo.RGB_ETC1:e===vo.RGB_A_PVRTC_4BPPV1?e=vo.RGB_PVRTC_4BPPV1:e===vo.RGB_A_PVRTC_2BPPV1&&(e=vo.RGB_PVRTC_2BPPV1),e},t}(M),Wo.PixelFormat=vo,Wo.WrapMode=Eo,Wo.Filter=To,xo=O((Fo=Yo).prototype,"_format",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vo.RGBA8888}}),Do=O(Fo.prototype,"_minFilter",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return To.LINEAR}}),Uo=O(Fo.prototype,"_magFilter",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return To.LINEAR}}),Go=O(Fo.prototype,"_mipFilter",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return To.NONE}}),Ho=O(Fo.prototype,"_wrapS",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Eo.REPEAT}}),ko=O(Fo.prototype,"_wrapT",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Eo.REPEAT}}),zo=O(Fo.prototype,"_wrapR",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Eo.REPEAT}}),Vo=O(Fo.prototype,"_anisotropy",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),Bo=Fo))||Bo);u.TextureBase=Qo;var qo=[new Rr];function Jo(e){return e&&0==(e&e-1)}var $o,eh,th,ih,nh,rh,sh=I("cc.SimpleTexture")(Ko=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._gfxTexture=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t}a(t,e);var i=t.prototype;return i.getGFXTexture=function(){return this._gfxTexture},i.destroy=function(){return this._tryDestroyTexture(),e.prototype.destroy.call(this)},i.updateImage=function(){this.updateMipmaps(0)},i.updateMipmaps=function(){},i.uploadData=function(e,t,i){if(void 0===t&&(t=0),void 0===i&&(i=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var n=this._getGFXDevice();if(n){var r=qo[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=i,ArrayBuffer.isView(e)?n.copyBuffersToTexture([e],this._gfxTexture,qo):n.copyTexImagesToTexture([e],this._gfxTexture,qo)}}},i._assignImage=function(e,t,i){var n=this,r=function(){var r=e.data;r&&(n.uploadData(r,t,i),n._checkTextureLoaded(),D.CLEANUP_IMAGE_CACHE&&u.assetManager.releaseAsset(e))};if(e.loaded)r();else{if(e.once("load",(function(){r()})),!this.isCompressed){var s=u.builtinResMgr.get("black-texture").image;this.uploadData(s.data,t,i)}u.assetManager.postLoadNative(e)}},i._checkTextureLoaded=function(){this._textureReady()},i._textureReady=function(){this.loaded=!0,this.emit("load")},i._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},i._getGfxTextureCreateInfo=function(){return null},i._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}},i._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=Nn.NONE;this._mipFilter!==To.NONE&&function(e,t,i){return!(e.gfxAPI===Hn.WEBGL)||Jo(t)&&Jo(i)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var i=Math.max(e,t),n=0;i;)i>>=1,n++;return n}(this._width,this._height),t=Nn.GEN_MIPMAP);var i=this._getGfxTextureCreateInfo({usage:In.SAMPLED|In.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(i){var n=e.createTexture(i);this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=n}}},i._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},s(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(Qo))||Ko;u.SimpleTexture=sh;var ah=e("bH",($o=I("cc.Texture2D"),eh=U([Co]),$o((rh=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,b(t,"_mipmaps",nh,B(t)),t}a(t,e);var i=t.prototype;return i.initialize=function(){this.mipmaps=this._mipmaps},i.onLoaded=function(){this.initialize()},i.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},i.create=function(e,t,i,n){void 0===i&&(i=vo.RGBA8888),void 0===n&&(n=1),this.reset({width:e,height:t,format:i,mipmapLevel:n})},i.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},i.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),n=0;n<i;++n){var r=e+n;this._assignImage(this._mipmaps[r],r)}},i.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},i.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},i.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},i.releaseTexture=function(){this.destroy()},i._serialize=function(){},i._deserialize=function(t,i){var n=t;e.prototype._deserialize.call(this,n.base,i),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r)if(this._mipmaps[r]=new Co,n.mipmaps[r]){var s=n.mipmaps[r];i.result.push(this._mipmaps,""+r,s),this._mipmaps[r]._texture=this}},i._getGfxTextureCreateInfo=function(e){var t=new jr(Rn.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)},i._checkTextureLoaded=function(){for(var t=!0,i=0;i<this._mipmaps.length;++i)if(!this._mipmaps[i].loaded){t=!1;break}t&&e.prototype._textureReady.call(this)},s(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0];this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,i){t._assignImage(e,i)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(sh),nh=O((ih=rh).prototype,"_mipmaps",[eh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),th=ih))||th));u.Texture2D=ah;var oh,hh,uh={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},lh=e("dR",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,i=0,n=R(e);!(t=n()).done;)i|=t.value;return i},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,i){void 0!==i?i>19||i<0?console.warn("maximum layers reached."):(e.Enum[t]=1<<i,e.Enum[i]=t,e.BitMask[t]=1<<i,e.BitMask[i]=t):console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){t>19||t<0?console.warn("do not change buildin layers."):(delete e.Enum[e.Enum[t]],delete e.Enum[t],delete e.BitMask[e.BitMask[t]],delete e.BitMask[t])},e}());lh.Enum=g(uh),lh.BitMask=G(H({},uh)),u.Layers=lh,function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(oh||(oh={})),u.RenderPassStage=oh,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(hh||(hh=e("ea",{})));var _h,ch={bindings:[],layouts:{}},dh={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_SHADOW=1]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=2]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=3]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=4]="SAMPLER_SPOT_LIGHTING_MAP",e[e.COUNT=5]="COUNT"}(_h||(_h={}));var fh,ph=_h.SAMPLER_SHADOWMAP,mh=_h.COUNT-ph;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=9]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",e[e.COUNT=11]="COUNT"}(fh||(fh=e("eb",{})));var gh,vh=fh.SAMPLER_JOINTS,Eh=fh.COUNT-vh;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(gh||(gh=e("eJ",{})));var Th=new ar;Th.bufferOffsets=[0,ph+vh,ph],Th.samplerOffsets=[-ph,mh+Eh,mh-vh],Th.flexibleSet=1;var Ah=function(){};Ah.SIZE=4*(Ah.COUNT=4+(Ah.GLOBAL_FOG_ADD_OFFSET=4+(Ah.GLOBAL_FOG_BASE_OFFSET=4+(Ah.GLOBAL_FOG_COLOR_OFFSET=4+(Ah.AMBIENT_GROUND_OFFSET=4+(Ah.AMBIENT_SKY_OFFSET=4+(Ah.MAIN_LIT_COLOR_OFFSET=4+(Ah.MAIN_LIT_DIR_OFFSET=4+(Ah.EXPOSURE_OFFSET=4+(Ah.CAMERA_POS_OFFSET=16+(Ah.MAT_VIEW_PROJ_INV_OFFSET=16+(Ah.MAT_VIEW_PROJ_OFFSET=16+(Ah.MAT_PROJ_INV_OFFSET=16+(Ah.MAT_PROJ_OFFSET=16+(Ah.MAT_VIEW_INV_OFFSET=16+(Ah.MAT_VIEW_OFFSET=4+(Ah.NATIVE_SIZE_OFFSET=4+(Ah.SCREEN_SCALE_OFFSET=4+(Ah.SCREEN_SIZE_OFFSET=4+(Ah.TIME_OFFSET=0)))))))))))))))))))),Ah.NAME="CCGlobal",Ah.BINDING=_h.UBO_GLOBAL,Ah.DESCRIPTOR=new is(Ah.BINDING,bn.UNIFORM_BUFFER,1,Cn.ALL),Ah.LAYOUT=new Vr(gh.GLOBAL,Ah.BINDING,Ah.NAME,[new zr("cc_time",on.FLOAT4,1),new zr("cc_screenSize",on.FLOAT4,1),new zr("cc_screenScale",on.FLOAT4,1),new zr("cc_nativeSize",on.FLOAT4,1),new zr("cc_matView",on.MAT4,1),new zr("cc_matViewInv",on.MAT4,1),new zr("cc_matProj",on.MAT4,1),new zr("cc_matProjInv",on.MAT4,1),new zr("cc_matViewProj",on.MAT4,1),new zr("cc_matViewProjInv",on.MAT4,1),new zr("cc_cameraPos",on.FLOAT4,1),new zr("cc_exposure",on.FLOAT4,1),new zr("cc_mainLitDir",on.FLOAT4,1),new zr("cc_mainLitColor",on.FLOAT4,1),new zr("cc_ambientSky",on.FLOAT4,1),new zr("cc_ambientGround",on.FLOAT4,1),new zr("cc_fogColor",on.FLOAT4,1),new zr("cc_fogBase",on.FLOAT4,1),new zr("cc_fogAdd",on.FLOAT4,1)],1),ch.layouts[Ah.NAME]=Ah.LAYOUT,ch.bindings[Ah.BINDING]=Ah.DESCRIPTOR;var Sh=function(){};Sh.SIZE=4*(Sh.COUNT=4+(Sh.SHADOW_INFO_OFFSET=4+(Sh.SHADOW_COLOR_OFFSET=16+(Sh.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Sh.MAT_LIGHT_PLANE_PROJ_OFFSET=0))))),Sh.NAME="CCShadow",Sh.BINDING=_h.UBO_SHADOW,Sh.DESCRIPTOR=new is(Sh.BINDING,bn.UNIFORM_BUFFER,1,Cn.ALL),Sh.LAYOUT=new Vr(gh.GLOBAL,Sh.BINDING,Sh.NAME,[new zr("cc_matLightPlaneProj",on.MAT4,1),new zr("cc_matLightViewProj",on.MAT4,1),new zr("cc_shadowColor",on.FLOAT4,1),new zr("cc_shadowInfo",on.FLOAT4,1)],1),ch.layouts[Sh.NAME]=Sh.LAYOUT,ch.bindings[Sh.BINDING]=Sh.DESCRIPTOR;var yh=_h.SAMPLER_SHADOWMAP,Rh=new is(yh,bn.SAMPLER,1,Cn.FRAGMENT),Ih=new Wr(gh.GLOBAL,yh,"cc_shadowMap",on.SAMPLER2D,1);ch.layouts.cc_shadowMap=Ih,ch.bindings[yh]=Rh;var Oh=_h.SAMPLER_ENVIRONMENT,Nh=new is(Oh,bn.SAMPLER,1,Cn.FRAGMENT),Ch=new Wr(gh.GLOBAL,Oh,"cc_environment",on.SAMPLER_CUBE,1);ch.layouts.cc_environment=Ch,ch.bindings[Oh]=Nh;var bh=_h.SAMPLER_SPOT_LIGHTING_MAP,wh=new is(bh,bn.SAMPLER,1,Cn.FRAGMENT),Lh=new Wr(gh.GLOBAL,bh,"cc_spotLightingMap",on.SAMPLER2D,1);ch.layouts.cc_spotLightingMap=Lh,ch.bindings[bh]=wh;var Mh=e("e9",(function(){}));Mh.MAT_WORLD_OFFSET=0,Mh.MAT_WORLD_IT_OFFSET=Mh.MAT_WORLD_OFFSET+16,Mh.LIGHTINGMAP_UVPARAM=Mh.MAT_WORLD_IT_OFFSET+16,Mh.COUNT=Mh.LIGHTINGMAP_UVPARAM+4,Mh.SIZE=4*Mh.COUNT,Mh.NAME="CCLocal",Mh.BINDING=fh.UBO_LOCAL,Mh.DESCRIPTOR=new is(Mh.BINDING,bn.UNIFORM_BUFFER,1,Cn.VERTEX),Mh.LAYOUT=new Vr(gh.LOCAL,Mh.BINDING,Mh.NAME,[new zr("cc_matWorld",on.MAT4,1),new zr("cc_matWorldIT",on.MAT4,1),new zr("cc_lightingMapUVParam",on.FLOAT4,1)],1),dh.layouts[Mh.NAME]=Mh.LAYOUT,dh.bindings[Mh.BINDING]=Mh.DESCRIPTOR;var Ph=function(){};Ph.BATCHING_COUNT=10,Ph.MAT_WORLDS_OFFSET=0,Ph.SIZE=4*(Ph.COUNT=16*Ph.BATCHING_COUNT),Ph.NAME="CCLocalBatched",Ph.BINDING=fh.UBO_LOCAL,Ph.DESCRIPTOR=new is(Ph.BINDING,bn.UNIFORM_BUFFER,1,Cn.VERTEX),Ph.LAYOUT=new Vr(gh.LOCAL,Ph.BINDING,Ph.NAME,[new zr("cc_matWorlds",on.MAT4,Ph.BATCHING_COUNT)],1),dh.layouts[Ph.NAME]=Ph.LAYOUT,dh.bindings[Ph.BINDING]=Ph.DESCRIPTOR;var Bh=function(){};Bh.LIGHTS_PER_PASS=1,Bh.SIZE=4*(Bh.COUNT=(Bh.LIGHT_DIR_OFFSET=(Bh.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Bh.LIGHT_COLOR_OFFSET=(Bh.LIGHT_POS_OFFSET=0)+4*Bh.LIGHTS_PER_PASS)+4*Bh.LIGHTS_PER_PASS)+4*Bh.LIGHTS_PER_PASS)+4*Bh.LIGHTS_PER_PASS),Bh.NAME="CCForwardLight",Bh.BINDING=fh.UBO_FORWARD_LIGHTS,Bh.DESCRIPTOR=new is(Bh.BINDING,bn.DYNAMIC_UNIFORM_BUFFER,1,Cn.FRAGMENT),Bh.LAYOUT=new Vr(gh.LOCAL,Bh.BINDING,Bh.NAME,[new zr("cc_lightPos",on.FLOAT4,Bh.LIGHTS_PER_PASS),new zr("cc_lightColor",on.FLOAT4,Bh.LIGHTS_PER_PASS),new zr("cc_lightSizeRangeAngle",on.FLOAT4,Bh.LIGHTS_PER_PASS),new zr("cc_lightDir",on.FLOAT4,Bh.LIGHTS_PER_PASS)],1),dh.layouts[Bh.NAME]=Bh.LAYOUT,dh.bindings[Bh.BINDING]=Bh.DESCRIPTOR;var Fh=function(){};Fh.SIZE=4*(Fh.COUNT=4+(Fh.JOINTS_TEXTURE_INFO_OFFSET=0)),Fh.NAME="CCSkinningTexture",Fh.BINDING=fh.UBO_SKINNING_TEXTURE,Fh.DESCRIPTOR=new is(Fh.BINDING,bn.UNIFORM_BUFFER,1,Cn.VERTEX),Fh.LAYOUT=new Vr(gh.LOCAL,Fh.BINDING,Fh.NAME,[new zr("cc_jointTextureInfo",on.FLOAT4,1)],1),dh.layouts[Fh.NAME]=Fh.LAYOUT,dh.bindings[Fh.BINDING]=Fh.DESCRIPTOR;var xh=function(){};xh.SIZE=4*(xh.COUNT=4+(xh.JOINTS_ANIM_INFO_OFFSET=0)),xh.NAME="CCSkinningAnimation",xh.BINDING=fh.UBO_SKINNING_ANIMATION,xh.DESCRIPTOR=new is(xh.BINDING,bn.UNIFORM_BUFFER,1,Cn.VERTEX),xh.LAYOUT=new Vr(gh.LOCAL,xh.BINDING,xh.NAME,[new zr("cc_jointAnimInfo",on.FLOAT4,1)],1),dh.layouts[xh.NAME]=xh.LAYOUT,dh.bindings[xh.BINDING]=xh.DESCRIPTOR;var Dh=function(){};Dh.SIZE=4*(Dh.COUNT=360+(Dh.JOINTS_OFFSET=0)),Dh.NAME="CCSkinning",Dh.BINDING=fh.UBO_SKINNING_TEXTURE,Dh.DESCRIPTOR=new is(Dh.BINDING,bn.UNIFORM_BUFFER,1,Cn.VERTEX),Dh.LAYOUT=new Vr(gh.LOCAL,Dh.BINDING,Dh.NAME,[new zr("cc_joints",on.FLOAT4,90)],1),dh.layouts[Dh.NAME]=Dh.LAYOUT,dh.bindings[Dh.BINDING]=Dh.DESCRIPTOR;var Uh=function(){};Uh.MAX_MORPH_TARGET_COUNT=60,Uh.OFFSET_OF_WEIGHTS=0,Uh.OFFSET_OF_VERTICES_COUNT=4+(Uh.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(Uh.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Uh.MAX_MORPH_TARGET_COUNT)),Uh.COUNT_BASE_4_BYTES=4*Math.ceil(Uh.MAX_MORPH_TARGET_COUNT/4)+4,Uh.SIZE=4*Uh.COUNT_BASE_4_BYTES,Uh.NAME="CCMorph",Uh.BINDING=fh.UBO_MORPH,Uh.DESCRIPTOR=new is(Uh.BINDING,bn.UNIFORM_BUFFER,1,Cn.VERTEX),Uh.LAYOUT=new Vr(gh.LOCAL,Uh.BINDING,Uh.NAME,[new zr("cc_displacementWeights",on.FLOAT4,Uh.MAX_MORPH_TARGET_COUNT/4),new zr("cc_displacementTextureInfo",on.FLOAT4,1)],1),dh.layouts[Uh.NAME]=Uh.LAYOUT,dh.bindings[Uh.BINDING]=Uh.DESCRIPTOR;var Gh=fh.SAMPLER_JOINTS,Hh=new is(Gh,bn.SAMPLER,1,Cn.VERTEX),kh=new Wr(gh.LOCAL,Gh,"cc_jointTexture",on.SAMPLER2D,1);dh.layouts.cc_jointTexture=kh,dh.bindings[Gh]=Hh;var zh=fh.SAMPLER_MORPH_POSITION,Vh=new is(zh,bn.SAMPLER,1,Cn.VERTEX),Wh=new Wr(gh.LOCAL,zh,"cc_PositionDisplacements",on.SAMPLER2D,1);dh.layouts.cc_PositionDisplacements=Wh,dh.bindings[zh]=Vh;var Yh=fh.SAMPLER_MORPH_NORMAL,Xh=new is(Yh,bn.SAMPLER,1,Cn.VERTEX),jh=new Wr(gh.LOCAL,Yh,"cc_NormalDisplacements",on.SAMPLER2D,1);dh.layouts.cc_NormalDisplacements=jh,dh.bindings[Yh]=Xh;var Kh=fh.SAMPLER_MORPH_TANGENT,Zh=new is(Kh,bn.SAMPLER,1,Cn.VERTEX),Qh=new Wr(gh.LOCAL,Kh,"cc_TangentDisplacements",on.SAMPLER2D,1);dh.layouts.cc_TangentDisplacements=Qh,dh.bindings[Kh]=Zh;var qh=fh.SAMPLER_LIGHTMAP,Jh=new is(qh,bn.SAMPLER,1,Cn.FRAGMENT),$h=new Wr(gh.LOCAL,qh,"cc_lightingMap",on.SAMPLER2D,1);dh.layouts.cc_lightingMap=$h,dh.bindings[qh]=Jh;var eu=fh.SAMPLER_SPRITE,tu=new is(eu,bn.SAMPLER,1,Cn.FRAGMENT),iu=new Wr(gh.LOCAL,eu,"cc_spriteTexture",on.SAMPLER2D,1);dh.layouts.cc_spriteTexture=iu,dh.bindings[eu]=tu;var nu=e("e1",lh.makeMaskExclude([lh.BitMask.UI_2D,lh.BitMask.GIZMOS,lh.BitMask.EDITOR,lh.BitMask.SCENE_GIZMO,lh.BitMask.PROFILER])),ru=lh.makeMaskExclude([lh.BitMask.UI_2D,lh.BitMask.PROFILER]),su=lh.Enum.ALL;e("dA",Object.freeze({__proto__:null,PIPELINE_FLOW_FORWARD:"ForwardFlow",PIPELINE_FLOW_SHADOW:"ShadowFlow",PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return oh},get RenderPriority(){return hh},globalDescriptorSetLayout:ch,localDescriptorSetLayout:dh,get PipelineGlobalBindings(){return _h},get ModelLocalBindings(){return fh},get SetIndex(){return gh},bindingMappingInfo:Th,UBOGlobal:Ah,UBOShadow:Sh,UNIFORM_SHADOWMAP_BINDING:yh,UNIFORM_ENVIRONMENT_BINDING:Oh,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:bh,UBOLocal:Mh,INST_MAT_WORLD:"a_matWorld0",UBOLocalBatched:Ph,UBOForwardLight:Bh,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:Fh,UBOSkinningAnimation:xh,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:Dh,UBOMorph:Uh,UNIFORM_JOINT_TEXTURE_BINDING:Gh,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:zh,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Yh,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Kh,UNIFORM_LIGHTMAP_TEXTURE_BINDING:qh,UNIFORM_SPRITE_TEXTURE_BINDING:eu,CAMERA_DEFAULT_MASK:nu,CAMERA_EDITOR_MASK:ru,MODEL_ALWAYS_MASK:su}));var au,ou,hu,uu,lu,_u,cu=function(){function e(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,this._mesh.struct.morph){var i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(var n=0;n<i;++n){var r=this._mesh.struct.morph.subMeshMorphs[n];r&&(r.targets.length>Uh.MAX_MORPH_TARGET_COUNT?L(10002,Uh.MAX_MORPH_TARGET_COUNT,r.targets.length):this._subMeshRenderings[n]=new du(this._mesh,n,this._mesh.struct.morph,t))}}}return e.prototype.createInstance=function(){for(var e=this,t=this._mesh.struct.primitives.length,i=new Array(t),n=0;n<t;++n){var r,s;i[n]=null!==(r=null===(s=this._subMeshRenderings[n])||void 0===s?void 0:s.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var n;null===(n=i[e])||void 0===n||n.setWeights(t)},requiredPatches:function(t){Y(e._mesh.struct.morph);var n=e._mesh.struct.morph.subMeshMorphs[t],r=i[t];if(null!==r){var s=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:n.targets.length}];return n.attributes.includes(an.ATTR_POSITION)&&s.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),n.attributes.includes(an.ATTR_NORMAL)&&s.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),n.attributes.includes(an.ATTR_TANGENT)&&s.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),s.push.apply(s,r.requiredPatches()),s}},adaptPipelineState:function(e,t){var n;null===(n=i[e])||void 0===n||n.adaptPipelineState(t)},destroy:function(){for(var e,t=R(i);!(e=t()).done;){var n=e.value;null==n||n.destroy()}}}},e}(),du=function(){function e(e,t,i,n){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=n;var r=i.subMeshMorphs[t];this._subMeshMorph=r,gu(e,t,n);var s=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=s;var a=r.targets.length,o=mu(n,s*a);this._textureInfo={width:o.width,height:o.height},this._attributes=r.attributes.map((function(t,i){var n=o.create(),a=n.valueView;return r.targets.forEach((function(t,n){for(var r=t.displacements[i],o=new Float32Array(e.data.buffer,e.data.byteOffset+r.offset,r.count),h=s*n*4,u=0;u<s;++u)a[h+4*u+0]=o[3*u+0],a[h+4*u+1]=o[3*u+1],a[h+4*u+2]=o[3*u+2]})),n.updatePixels(),{name:t,morphTexture:n}}))}var t=e.prototype;return t.destroy=function(){for(var e,t=R(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()},t.createInstance=function(){var e=this,t=new pu(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(i){for(var n,r=R(e._attributes);!(n=r()).done;){var s=n.value,a=void 0;switch(s.name){case an.ATTR_POSITION:a=zh;break;case an.ATTR_NORMAL:a=Yh;break;case an.ATTR_TANGENT:a=Kh;break;default:z("Unexpected attribute!")}void 0!==a&&(i.bindSampler(a,s.morphTexture.sampler),i.bindTexture(a,s.morphTexture.texture))}i.bindBuffer(Uh.BINDING,t.buffer),i.update()},destroy:function(){}}},e}(),fu=(function(){function e(e,t,i,n){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=n;var r=i.subMeshMorphs[t];gu(e,t,n),this._attributes=r.attributes.map((function(t,i){return{name:t,targets:r.targets.map((function(t){return{displacements:new Float32Array(e.data.buffer,e.data.byteOffset+t.displacements[i].offset,t.displacements[i].count)}}))}}))}e.prototype.createInstance=function(){return new fu(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},s(e,[{key:"data",get:function(){return this._attributes}}])}(),function(){function e(e,t,i){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new pu(i,0);var n=mu(i,t);this._morphUniforms.setMorphTextureInfo(n.width,n.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=n.create();return{attributeName:e.name,morphTexture:t}}))}var t=e.prototype;return t.setWeights=function(e){for(var t=0;t<this._attributes.length;++t){var i=this._attributes[t],n=i.morphTexture.valueView,r=this._owner.data[t];k(e.length===r.targets.length);for(var s=0;s<r.targets.length;++s){var a=r.targets[s].displacements,o=e[s],h=a.length/3;if(0===s)for(var u=0;u<h;++u)n[4*u+0]=a[3*u+0]*o,n[4*u+1]=a[3*u+1]*o,n[4*u+2]=a[3*u+2]*o;else for(var l=0;l<h;++l)n[4*l+0]+=a[3*l+0]*o,n[4*l+1]+=a[3*l+1]*o,n[4*l+2]+=a[3*l+2]*o}i.morphTexture.updatePixels()}},t.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},t.adaptPipelineState=function(e){for(var t,i=R(this._attributes);!(t=i()).done;){var n=t.value,r=void 0;switch(n.attributeName){case an.ATTR_POSITION:r=zh;break;case an.ATTR_NORMAL:r=Yh;break;case an.ATTR_TANGENT:r=Kh;break;default:z("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,n.morphTexture.sampler),e.bindTexture(r,n.morphTexture.texture))}e.bindBuffer(Uh.BINDING,this._morphUniforms.buffer),e.update()},t.destroy=function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()},e}()),pu=function(){function e(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(Uh.SIZE)),this._remoteBuffer=e.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,Uh.SIZE,Uh.SIZE))}var t=e.prototype;return t.destroy=function(){this._remoteBuffer.destroy()},t.setWeights=function(e){k(e.length===this._targetCount);for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(Uh.OFFSET_OF_WEIGHTS+4*t,e[t],u.sys.isLittleEndian)},t.setMorphTextureInfo=function(e,t){this._localBuffer.setFloat32(Uh.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,u.sys.isLittleEndian),this._localBuffer.setFloat32(Uh.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,u.sys.isLittleEndian)},t.setVerticesCount=function(e){this._localBuffer.setFloat32(Uh.OFFSET_OF_VERTICES_COUNT,e,u.sys.isLittleEndian)},t.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer,this._localBuffer.byteOffset,this._localBuffer.byteLength)},s(e,[{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function mu(e,t){var i,n,r,s;e.hasFeature(zn.TEXTURE_FLOAT)?(i=t,r=16,n=ah.PixelFormat.RGBA32F,s=Float32Array):(i=4*t,r=4,n=ah.PixelFormat.RGBA8888,s=Uint8Array);var a=function(e){e<5&&(e=5);var t=V(e),i=W(t),n=i>>1;return{width:1<<(1&i?n+1:n),height:1<<n}}(i),o=a.width,h=a.height;return{width:o,height:h,create:function(){var t=new ArrayBuffer(o*h*r),i=new Float32Array(t),a=s===Float32Array?i:new s(t),u=new Co({width:o,height:h,_data:a,_compressed:!1,format:n}),l=new ah;l.setFilters(ah.Filter.NEAREST,ah.Filter.NEAREST),l.setMipFilter(ah.Filter.NONE),l.setWrapMode(ah.WrapMode.CLAMP_TO_EDGE,ah.WrapMode.CLAMP_TO_EDGE,ah.WrapMode.CLAMP_TO_EDGE),l.image=u,l.getGFXTexture()||z("Unexpected: failed to create morph texture?");var _=jo.getSampler(e,l.getSamplerHash());return{get texture(){return l.getGFXTexture()},get sampler(){return _},get valueView(){return i},destroy:function(){l.destroy()},updatePixels:function(){l.uploadData(a)}}}}}function gu(e,t,i){e.renderingSubMeshes[t].enableVertexIdChannel(i)}function vu(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var Eu=e("bL",function(){function e(e,t,i,n,r){void 0===n&&(n=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._handle=Ft,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=n,this._indirectBuffer=r,this._primitiveMode=i,this._iaInfo=new pr(t,e,n,r),this._handle=Vi.alloc();var s=Vt.alloc();Vi.set(this._handle,Ui.FLAT_BUFFER_ARRAY,s)}var t=e.prototype;return t.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,i=e.struct.primitives[this.subMeshIdx],n=Vi.get(this._handle,Ui.FLAT_BUFFER_ARRAY);i.indexView&&(t=i.indexView.count);for(var r=0;r<i.vertexBundelIndices.length;r++){var s=i.vertexBundelIndices[r],a=e.struct.vertexBundles[s],o=i.indexView?i.indexView.count:a.view.count,h=a.view.stride,u=h*o,l=new Uint8Array(e.data.buffer,a.view.offset,a.view.length),_=Yt.alloc(i.indexView?u:a.view.length),c=Hi.alloc();Hi.set(c,xi.STRIDE,h),Hi.set(c,xi.AMOUNT,o),Hi.set(c,xi.BUFFER,_),Vt.push(n,c);var d=Yt.getBuffer(_),f=new Uint8Array(d);if(i.indexView){for(var p=e.readIndices(this.subMeshIdx),m=0;m<t;++m)for(var g=m*h,v=p[m]*h,E=0;E<h;++E)f[g+E]=l[v+E];this._flatBuffers.push({stride:h,count:o,buffer:f})}else f.set(e.data.subarray(a.view.offset,a.view.offset+a.view.length)),this._flatBuffers.push({stride:h,count:o,buffer:f})}}},t.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null),this._handle&&(Pt(Vi.get(this._handle,Ui.FLAT_BUFFER_ARRAY),Vt,Hi),Vi.free(this._handle),this._handle=Ft)},t.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(e);this._vertexBuffers.push(n),this._attributes.push(new fr("a_vertexId",hn.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:i}}},t._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(t),n=0;n<t;++n)i[n]=n+.5;var r=e.createBuffer(new tr(un.VERTEX|un.TRANSFER_DST,ln.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return r.update(i),r},s(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:r.ZERO,max:r.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:r.ZERO,max:r.ZERO}};var e=this.mesh,t=this.subMeshIdx,i=e.readAttribute(t,an.ATTR_POSITION),n=e.readIndices(t),s=new r,a=new r,o=this.attributes.find((function(e){return e.name===an.ATTR_POSITION}));if(o){var h=Xn[o.format].count;2===h?(s.set(i[0],i[1],0),a.set(i[0],i[1],0)):(s.set(i[0],i[1],i[2]),a.set(i[0],i[1],i[2]));for(var u=0;u<i.length;u+=h)2===h?(s.x=i[u]>s.x?i[u]:s.x,s.y=i[u+1]>s.y?i[u+1]:s.y,a.x=i[u]<a.x?i[u]:a.x,a.y=i[u+1]<a.y?i[u+1]:a.y):(s.x=i[u]>s.x?i[u]:s.x,s.y=i[u+1]>s.y?i[u+1]:s.y,s.z=i[u+2]>s.z?i[u+2]:s.z,a.x=i[u]<a.x?i[u]:a.x,a.y=i[u+1]<a.y?i[u+1]:a.y,a.z=i[u+2]<a.z?i[u+2]:a.z)}return this._geometricInfo={positions:i,indices:n,boundingBox:{max:s,min:a}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],i=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var n,r,s=this.mesh.struct,a=s.primitives[this.subMeshIdx];if(!s.jointMaps||void 0===a.jointMapIndex||!s.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var o=u.director.root.device,h=0;h<a.vertexBundelIndices.length;h++){var l=s.vertexBundles[a.vertexBundelIndices[h]];r=0,n=hn.UNKNOWN;for(var _=0;_<l.attributes.length;_++){var c=l.attributes[_];if(c.name===an.ATTR_JOINTS){n=c.format;break}r+=Xn[c.format].size}n?function(){var u=new Uint8Array(e.mesh.data.buffer,l.view.offset,l.view.length),_=new DataView(u.slice().buffer),c=s.jointMaps[a.jointMapIndex];go(_,(function(e){return c.indexOf(e)}),n,r,l.view.length,l.view.stride,_);var d=o.createBuffer(new tr(un.VERTEX|un.TRANSFER_DST,ln.DEVICE,l.view.length,l.view.stride));d.update(_.buffer),t.push(d),i.push(h)}():t.push(this.vertexBuffers[a.vertexBundelIndices[h]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(o)),t}},{key:"iaInfo",get:function(){return this._iaInfo}},{key:"handle",get:function(){return this._handle}}]),e}()),Tu=new r,Au=new r,Su=new Uint8Array,yu=e("bp",I("cc.Mesh")((_u=function(e){function t(){var t;return(t=e.call(this)||this).morphRendering=null,b(t,"_struct",hu,B(t)),b(t,"_dataLength",uu,B(t)),b(t,"_hash",lu,B(t)),t._data=Su,t._initialized=!1,t._renderingSubMeshes=null,t._boneSpaceBounds=new Map,t._jointBufferIndices=null,t.loaded=!1,t}a(t,e),s(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data.byteLength===e.byteLength?this._data.set(new Uint8Array(e)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=dr(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]);var i=t.prototype;return i.initialize=function(){var e=this;if(!this._initialized){this._initialized=!0,this._data.byteLength!==this._dataLength&&(this._data=new Uint8Array(this._dataLength),u.assetManager.postLoadNative(this));for(var t=this._data.buffer,i=u.director.root.device,n=this._createVertexBuffers(i,t),r=[],s=function(s){var a=e._struct.primitives[s];if(0===a.vertexBundelIndices.length)return"continue";var o=null,h=null;if(a.indexView){var u=a.indexView,l=u.stride,_=u.length;if(4===l&&!i.hasFeature(zn.ELEMENT_INDEX_UINT)){var c=e._struct.vertexBundles[a.vertexBundelIndices[0]].view.count;if(c>=65536)return L(10001,c,65536),"continue";l>>=1,_>>=1}o=i.createBuffer(new tr(un.INDEX|un.TRANSFER_DST,ln.DEVICE,_,l)),h=new(vu(u.stride))(t,u.offset,u.count),u.stride!==l&&(h=vu(l).from(h)),e.loaded?o.update(h):e.once("load",(function(){o.update(h)}))}var d=a.vertexBundelIndices.map((function(e){return n[e]})),f=[];if(a.vertexBundelIndices.length>0)for(var p=a.vertexBundelIndices[0],m=e._struct.vertexBundles[p].attributes,g=0;g<m.length;++g){var v=m[g];f[g]=new fr(v.name,v.format,v.isInstanced,v.stream,v.isInstanced,v.location)}var E=new Eu(d,f,a.primitiveMode,o);E.mesh=e,E.subMeshIdx=s,r.push(E)},a=0;a<this._struct.primitives.length;a++)s(a);this._renderingSubMeshes=r,this._struct.morph&&(this.morphRendering=function(e,t){return new cu(e,t)}(this,i))}},i.destroy=function(){return this.destroyRenderingMesh(),e.prototype.destroy.call(this)},i.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}},i.assign=function(e,t){this.reset({struct:e,data:t})},i.reset=function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._dataLength=this.data.byteLength,this._hash=0,this.loaded=!0,this.emit("load")},i.getBoneSpaceBounds=function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var i=[],n=e.bindposes,s=0;s<n.length;s++)t.push(new Ia(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);for(var a=this._struct.primitives,o=0;o<a.length;o++){var h=this.readAttribute(o,an.ATTR_JOINTS),u=this.readAttribute(o,an.ATTR_WEIGHTS),l=this.readAttribute(o,an.ATTR_POSITION);if(h&&u&&l)for(var _=Math.min(h.length/4,u.length/4,l.length/3),c=0;c<_;c++){r.set(Tu,l[3*c+0],l[3*c+1],l[3*c+2]);for(var d=0;d<4;++d){var f=4*c+d,p=h[f];if(!(0===u[f]||p>=n.length)){r.transformMat4(Au,Tu,n[p]),i[p]=!0;var m=t[p];r.min(m.center,m.center,Au),r.max(m.halfExtents,m.halfExtents,Au)}}}}for(var g=0;g<n.length;g++){var v=t[g];i[g]?Ia.fromPoints(v,v.center,v.halfExtents):t[g]=null}return t},i.merge=function(e,t,i){if(i&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;var n=new r,s=t&&new p,a=t&&new Ia;if(s&&t.getRotation(s),!this._initialized){var o=JSON.parse(JSON.stringify(e._struct)),h=e._data.slice();if(t){o.maxPosition&&o.minPosition&&(r.add(a.center,o.maxPosition,o.minPosition),r.multiplyScalar(a.center,a.center,.5),r.subtract(a.halfExtents,o.maxPosition,o.minPosition),r.multiplyScalar(a.halfExtents,a.halfExtents,.5),Ia.transform(a,a,t),r.add(o.maxPosition,a.center,a.halfExtents),r.subtract(o.minPosition,a.center,a.halfExtents));for(var u=0;u<o.vertexBundles.length;u++)for(var l=o.vertexBundles[u],_=0;_<l.attributes.length;_++)if(l.attributes[_].name===an.ATTR_POSITION||l.attributes[_].name===an.ATTR_NORMAL){var c=l.attributes[_].format,d=new DataView(h.buffer,l.view.offset+Ru(l.attributes,_)),f=Mu(d,c),m=Pu(d,c);if(!f||!m)continue;for(var g=l.view.count,v=l.view.stride,E=Lu(c),T=0;T<g;T++){var A=T*v,S=A+E,y=S+E;switch(n.set(f(A),f(S),f(y)),l.attributes[_].name){case an.ATTR_POSITION:n.transformMat4(t);break;case an.ATTR_NORMAL:r.transformQuat(n,n,s)}m(A,n.x),m(S,n.y),m(y,n.z)}}}return this.reset({struct:o,data:h}),this.initialize(),!0}for(var I,O,N,C,b,w=new _o,L=0,M=0,P=0,B=0,F=0,x=0,D=0,U=0,G=!1,H=new Array(this._struct.vertexBundles.length),k=0;k<this._struct.vertexBundles.length;++k){var z=this._struct.vertexBundles[k],V=e._struct.vertexBundles[k];P=z.view.offset,B=V.view.offset,M=z.view.stride,L=z.view.count+V.view.count,I=new ArrayBuffer(L*M),O=new Uint8Array(I),P+=(N=this._data.subarray(P,P+z.view.length)).length,B+=(C=e._data.subarray(B,B+V.view.length)).length,O.set(N),F=0;for(var W,Y=R(z.attributes);!(W=Y()).done;){var X=W.value;D=0,G=!1;for(var j,K=R(V.attributes);!(j=K()).done;){var Z=j.value;if(X.name===Z.name&&X.format===Z.format){G=!0;break}D+=Xn[Z.format].size}if(G){U=Xn[X.format].size,x=z.view.length+F;for(var Q=0;Q<V.view.count;++Q){if(b=C.subarray(D,D+U),O.set(b,x),(X.name===an.ATTR_POSITION||X.name===an.ATTR_NORMAL)&&t){var q=new Float32Array(O.buffer,x,3);switch(n.set(q[0],q[1],q[2]),X.name){case an.ATTR_POSITION:n.transformMat4(t);break;case an.ATTR_NORMAL:r.transformQuat(n,n,s)}q[0]=n.x,q[1]=n.y,q[2]=n.z}x+=z.view.stride,D+=V.view.stride}}F+=Xn[X.format].size}H[k]={attributes:z.attributes,view:{offset:w.getLength(),length:I.byteLength,count:L,stride:M}},w.addBuffer(I)}for(var J,$,ee,te=0,ie=2,ne=0,re=new Array(this._struct.primitives.length),se=0;se<this._struct.primitives.length;++se){var ae=this._struct.primitives[se],oe=e._struct.primitives[se];re[se]={primitiveMode:ae.primitiveMode,vertexBundelIndices:ae.vertexBundelIndices};for(var he,ue=R(ae.vertexBundelIndices);!(he=ue()).done;){var le=he.value;ne=Math.max(ne,this._struct.vertexBundles[le].view.count)}if(ae.indexView&&oe.indexView){te=ae.indexView.count,te+=oe.indexView.count,P=ae.indexView.offset,B=oe.indexView.offset,ie=te<256?1:te<65536?2:4;var _e=new ArrayBuffer(te*ie);if(J=2===ie?new Uint16Array(_e):1===ie?new Uint8Array(_e):new Uint32Array(_e),$=2===ae.indexView.stride?new Uint16Array(this._data.buffer,P,ae.indexView.count):1===ae.indexView.stride?new Uint8Array(this._data.buffer,P,ae.indexView.count):new Uint32Array(this._data.buffer,P,ae.indexView.count),ie===ae.indexView.stride)J.set($);else for(var ce=0;ce<ae.indexView.count;++ce)J[ce]=$[ce];P+=ae.indexView.length,ee=2===oe.indexView.stride?new Uint16Array(e._data.buffer,B,oe.indexView.count):1===oe.indexView.stride?new Uint8Array(e._data.buffer,B,oe.indexView.count):new Uint32Array(e._data.buffer,B,oe.indexView.count);for(var de=0;de<oe.indexView.count;++de)J[ae.indexView.count+de]=ne+ee[de];B+=oe.indexView.length,re[se].indexView={offset:w.getLength(),length:_e.byteLength,count:te,stride:ie},w.setNextAlignment(ie),w.addBuffer(_e)}}var fe={vertexBundles:H,primitives:re,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return fe.minPosition&&e._struct.minPosition&&fe.maxPosition&&e._struct.maxPosition&&(t?(r.add(a.center,e._struct.maxPosition,e._struct.minPosition),r.multiplyScalar(a.center,a.center,.5),r.subtract(a.halfExtents,e._struct.maxPosition,e._struct.minPosition),r.multiplyScalar(a.halfExtents,a.halfExtents,.5),Ia.transform(a,a,t),r.add(n,a.center,a.halfExtents),r.max(fe.maxPosition,fe.maxPosition,n),r.subtract(n,a.center,a.halfExtents),r.min(fe.minPosition,fe.minPosition,n)):(r.min(fe.minPosition,fe.minPosition,e._struct.minPosition),r.max(fe.maxPosition,fe.maxPosition,e._struct.maxPosition))),this.reset({struct:fe,data:new Uint8Array(w.getCombined())}),this.initialize(),!0},i.validateMergingMesh=function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var s=0;s<this._struct.primitives.length;++s){var a=this._struct.primitives[s],o=e._struct.primitives[s];if(a.vertexBundelIndices.length!==o.vertexBundelIndices.length)return!1;for(var h=0;h<a.vertexBundelIndices.length;++h)if(a.vertexBundelIndices[h]!==o.vertexBundelIndices[h])return!1;if(a.primitiveMode!==o.primitiveMode)return!1;if(a.indexView){if(void 0===o.indexView)return!1}else if(o.indexView)return!1}return!0},i.readAttribute=function(e,t){var i=this,n=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,s=e.attributes[t].format,a=qn(Xn[s]);if(0!==r){var o=new DataView(i._data.buffer,e.view.offset+Ru(e.attributes,t)),h=Xn[s],u=Mu(o,s);if(a&&u){for(var l=h.count,_=new a(r*l),c=e.view.stride,d=0;d<r;++d)for(var f=0;f<l;++f)_[l*d+f]=u(c*d+_.BYTES_PER_ELEMENT*f);n=_}}})),n},i.copyAttribute=function(e,t,i,n,r){var s=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var o=e.view.count;if(0!==o){var h=e.attributes[t].format,u=new DataView(s._data.buffer,e.view.offset+Ru(e.attributes,t)),l=new DataView(i,r),_=Xn[h],c=Mu(u,h),d=Pu(l,h);if(c&&d){for(var f=_.count,p=e.view.stride,m=Lu(h),g=n,v=m,E=0;E<o;++E)for(var T=0;T<f;++T)d(g*E+v*T,c(p*E+m*T));a=!0}}else a=!0})),a},i.readIndices=function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var i=t.indexView.stride;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)},i.copyIndices=function(e,t){if(e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?hn.R8UI:2===i.indexView.stride?hn.R16UI:hn.R32UI,s=Mu(new DataView(this._data.buffer),r),a=0;a<n;++a)t[a]=s(i.indexView.offset+Xn[r].size*a);return!0},i._accessAttribute=function(e,t,i){if(!(e>=this._struct.primitives.length))for(var n,r=this._struct.primitives[e],s=R(r.vertexBundelIndices);!(n=s()).done;){var a=n.value,o=this._struct.vertexBundles[a],h=o.attributes.findIndex((function(e){return e.name===t}));if(!(h<0)){i(o,h);break}}},i._createVertexBuffers=function(e,t){var i=this;return this._struct.vertexBundles.map((function(n){var r=e.createBuffer(new tr(un.VERTEX|un.TRANSFER_DST,ln.DEVICE,n.view.length,n.view.stride)),s=new Uint8Array(t,n.view.offset,n.view.length);return i.loaded?r.update(s):i.once("load",(function(){r.update(s)})),r}))},t}(M),hu=O((ou=_u).prototype,"_struct",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),uu=O(ou.prototype,"_dataLength",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lu=O(ou.prototype,"_hash",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),au=ou))||au);function Ru(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=Xn[r.format].size}return i}u.Mesh=yu;var Iu,Ou,Nu,Cu,bu,wu=w.isLittleEndian;function Lu(e){var t=Xn[e];return t.size/t.count}function Mu(e,t){var i=Xn[t],n=i.size/i.count;switch(i.type){case Gn.UNORM:switch(n){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,wu)};case 4:return function(t){return e.getUint32(t,wu)}}break;case Gn.SNORM:case Gn.INT:switch(n){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,wu)};case 4:return function(t){return e.getInt32(t,wu)}}break;case Gn.UINT:switch(n){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,wu)};case 4:return function(t){return e.getUint32(t,wu)}}break;case Gn.FLOAT:return function(t){return e.getFloat32(t,wu)}}return null}function Pu(e,t){var i=Xn[t],n=i.size/i.count;switch(i.type){case Gn.UNORM:switch(n){case 1:return function(t,i){return e.setUint8(t,i)};case 2:return function(t,i){return e.setUint16(t,i,wu)};case 4:return function(t,i){return e.setUint32(t,i,wu)}}break;case Gn.SNORM:case Gn.INT:switch(n){case 1:return function(t,i){return e.setInt8(t,i)};case 2:return function(t,i){return e.setInt16(t,i,wu)};case 4:return function(t,i){return e.setInt32(t,i,wu)}}break;case Gn.UINT:switch(n){case 1:return function(t,i){return e.setUint8(t,i)};case 2:return function(t,i){return e.setUint16(t,i,wu)};case 4:return function(t,i){return e.setUint32(t,i,wu)}}break;case Gn.FLOAT:return function(t,i){return e.setFloat32(t,i,wu)}}return null}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(Iu||(Iu=e("Y",{}))),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(Ou||(Ou=e("Z",{}))),function(e){e[e.UBO=0]="UBO",e[e.SAMPLER=1]="SAMPLER"}(bu||(bu=e("_",{})));var Bu,Fu=e("$",(function(e,t,i,n,r){return void 0===r&&(r=0),e<<28&4026531840|n<<22&264241152|t<<20&3145728|i<<14&1032192|16383&r})),xu=e("a0",(function(e){return(4026531840&e)>>>28})),Du=e("a1",(function(e){return(264241152&e)>>>22})),Uu=(e("a2",(function(e){return(3145728&e)>>>20})),e("a3",(function(e){return(1032192&e)>>>14}))),Gu=e("a4",(function(e){return 16383&e})),Hu=e("a5",(function(e,t){return-264241153&e|t<<22&264241152})),ku=e("a6",((Nu={})[on.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Nu[on.INT]=function(e,t,i){return void 0===i&&(i=0),e[i]},Nu[on.INT2]=function(e,t,i){return void 0===i&&(i=0),X.fromArray(t,e,i)},Nu[on.INT3]=function(e,t,i){return void 0===i&&(i=0),r.fromArray(t,e,i)},Nu[on.INT4]=function(e,t,i){return void 0===i&&(i=0),f.fromArray(t,e,i)},Nu[on.FLOAT]=function(e,t,i){return void 0===i&&(i=0),e[i]},Nu[on.FLOAT2]=function(e,t,i){return void 0===i&&(i=0),X.fromArray(t,e,i)},Nu[on.FLOAT3]=function(e,t,i){return void 0===i&&(i=0),r.fromArray(t,e,i)},Nu[on.FLOAT4]=function(e,t,i){return void 0===i&&(i=0),f.fromArray(t,e,i)},Nu[on.MAT3]=function(e,t,i){return void 0===i&&(i=0),c.fromArray(t,e,i)},Nu[on.MAT4]=function(e,t,i){return void 0===i&&(i=0),_.fromArray(t,e,i)},Nu)),zu=e("a7",((Cu={})[on.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Cu[on.INT]=function(e,t,i){return void 0===i&&(i=0),e[i]=t},Cu[on.INT2]=function(e,t,i){return void 0===i&&(i=0),X.toArray(e,t,i)},Cu[on.INT3]=function(e,t,i){return void 0===i&&(i=0),r.toArray(e,t,i)},Cu[on.INT4]=function(e,t,i){return void 0===i&&(i=0),f.toArray(e,t,i)},Cu[on.FLOAT]=function(e,t,i){return void 0===i&&(i=0),e[i]=t},Cu[on.FLOAT2]=function(e,t,i){return void 0===i&&(i=0),X.toArray(e,t,i)},Cu[on.FLOAT3]=function(e,t,i){return void 0===i&&(i=0),r.toArray(e,t,i)},Cu[on.FLOAT4]=function(e,t,i){return void 0===i&&(i=0),f.toArray(e,t,i)},Cu[on.MAT3]=function(e,t,i){return void 0===i&&(i=0),c.toArray(e,t,i)},Cu[on.MAT4]=function(e,t,i){return void 0===i&&(i=0),_.toArray(e,t,i)},Cu)),Vu=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Wu(e){switch(e){case on.BOOL:case on.INT:case on.UINT:case on.FLOAT:return Vu[0];case on.BOOL2:case on.INT2:case on.UINT2:case on.FLOAT2:return Vu[1];case on.BOOL4:case on.INT4:case on.UINT4:case on.FLOAT4:return Vu[2];case on.MAT4:return Vu[3];case on.SAMPLER2D:return"default-texture";case on.SAMPLER_CUBE:return"default-cube-texture"}return Vu[0]}function Yu(e,t){for(var i=Object.entries(t),n=!1,r=0;r<i.length;r++)e[i[r][0]]!==i[r][1]&&(e[i[r][0]]=i[r][1],n=!0);return n}var Xu,ju,Ku,Zu,Qu,qu,Ju=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],$u=e("bN",I("cc.SpriteFrame")(Bu=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.uvHash=0,t.unbiasUV=[],t.uvSliced=[],t._rect=new j,t._offset=new X,t._originalSize=new K,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t}a(t,e),t.createWithImage=function(e){var i=e instanceof Co?e:new Co(e),n=new ah;n.image=i;var r=new t;return r.texture=n,r},s(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}}]);var i=t.prototype;return i.textureLoaded=function(){return this.texture&&this.texture.loaded},i.isRotated=function(){return this._rotated},i.setRotated=function(e){this.rotated=e},i.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},i.setRect=function(e){this.rect=e},i.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},i.setOriginalSize=function(e){this.originalSize=e},i.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},i.setOffset=function(e){this.offset=e},i.getGFXTexture=function(){return this._texture.getGFXTexture()},i.getGFXSampler=function(){return this._texture.getGFXSampler()},i.getHash=function(){return this._texture.getHash()},i.getSamplerHash=function(){return this._texture.getSamplerHash()},i.reset=function(e,t){void 0===t&&(t=!1);var i=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),e&&(e.texture&&(this.loaded=!1,this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),i=!0),i&&this.texture&&this._calculateUV()},i.checkRect=function(e){var t=this._rect,i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(F(3300,this.name+"/"+e.name,i,e.width),!1):!(n>e.height&&(F(3301,this.name+"/"+e.name,n,e.height),1))},i.onLoaded=function(){this.loaded=!0,this.emit("load")},i.destroy=function(){return e.prototype.destroy.call(this)},i._calculateSlicedUV=function(){var e=this._rect,t=this.texture,i=t.width,n=t.height,r=this._capInsets[0],s=this._capInsets[2],a=e.width-r-s,o=this._capInsets[1],h=this._capInsets[3],u=e.height-o-h,l=this.uvSliced;if(l.length=0,this._rotated){Ju[0].u=(e.x+.5)/i,Ju[1].u=(e.x+h)/i,Ju[2].u=(e.x+h+u)/i,Ju[3].u=(e.x+e.height-.5)/i,Ju[3].v=(e.y+.5)/n,Ju[2].v=(e.y+r)/n,Ju[1].v=(e.y+r+a)/n,Ju[0].v=(e.y+e.width-.5)/n;for(var _=0;_<4;++_)for(var c=Ju[_],d=0;d<4;++d){var f=Ju[3-d];l.push({u:c.u,v:f.v})}}else{Ju[0].u=(e.x+.5)/i,Ju[1].u=(e.x+r)/i,Ju[2].u=(e.x+r+a)/i,Ju[3].u=(e.x+e.width-.5)/i,Ju[3].v=(e.y+.5)/n,Ju[2].v=(e.y+o)/n,Ju[1].v=(e.y+o+u)/n,Ju[0].v=(e.y+e.height-.5)/n;for(var p=0;p<4;++p)for(var m=Ju[p],g=0;g<4;++g){var v=Ju[g];l.push({u:v.u,v:m.v})}}},i._calculateUV=function(){var e=this._rect,t=this.uv,i=this.unbiasUV,n=this.texture,r=n.width,s=n.height;if(this._rotated){var a=0===r?0:(e.x+.5)/r,o=0===r?0:(e.x+e.height-.5)/r,h=0===s?0:(e.y+.5)/s,u=0===s?0:(e.y+e.width-.5)/s;this._isFlipUVX&&this._isFlipUVY?(t[0]=o,t[1]=u,t[2]=o,t[3]=h,t[4]=a,t[5]=u,t[6]=a,t[7]=h):this._isFlipUVX?(t[0]=o,t[1]=h,t[2]=o,t[3]=u,t[4]=a,t[5]=h,t[6]=a,t[7]=u):this._isFlipUVY?(t[0]=a,t[1]=u,t[2]=a,t[3]=h,t[4]=o,t[5]=u,t[6]=o,t[7]=h):(t[0]=a,t[1]=h,t[2]=a,t[3]=u,t[4]=o,t[5]=h,t[6]=o,t[7]=u);var l=0===r?0:e.x/r,_=0===r?0:(e.x+e.height)/r,c=0===s?0:e.y/s,d=0===s?0:(e.y+e.width)/s;this._isFlipUVX&&this._isFlipUVY?(i[0]=_,i[1]=d,i[2]=_,i[3]=c,i[4]=l,i[5]=d,i[6]=l,i[7]=c):this._isFlipUVX?(i[0]=_,i[1]=c,i[2]=_,i[3]=d,i[4]=l,i[5]=c,i[6]=l,i[7]=d):this._isFlipUVY?(i[0]=l,i[1]=d,i[2]=l,i[3]=c,i[4]=_,i[5]=d,i[6]=_,i[7]=c):(i[0]=l,i[1]=c,i[2]=l,i[3]=d,i[4]=_,i[5]=c,i[6]=_,i[7]=d)}else{var f=0===r?0:(e.x+.5)/r,p=0===r?0:(e.x+e.width-.5)/r,m=0===s?0:(e.y+e.height-.5)/s,g=0===s?0:(e.y+.5)/s;this._isFlipUVX&&this._isFlipUVY?(t[0]=p,t[1]=g,t[2]=f,t[3]=g,t[4]=p,t[5]=m,t[6]=f,t[7]=m):this._isFlipUVX?(t[0]=p,t[1]=m,t[2]=f,t[3]=m,t[4]=p,t[5]=g,t[6]=f,t[7]=g):this._isFlipUVY?(t[0]=f,t[1]=g,t[2]=p,t[3]=g,t[4]=f,t[5]=m,t[6]=p,t[7]=m):(t[0]=f,t[1]=m,t[2]=p,t[3]=m,t[4]=f,t[5]=g,t[6]=p,t[7]=g);var v=0===r?0:e.x/r,E=0===r?0:(e.x+e.width)/r,T=0===s?0:(e.y+e.height)/s,A=0===s?0:e.y/s;this._isFlipUVX&&this._isFlipUVY?(i[0]=E,i[1]=A,i[2]=v,i[3]=A,i[4]=E,i[5]=T,i[6]=v,i[7]=T):this._isFlipUVX?(i[0]=E,i[1]=T,i[2]=v,i[3]=T,i[4]=E,i[5]=A,i[6]=v,i[7]=A):this._isFlipUVY?(i[0]=v,i[1]=A,i[2]=E,i[3]=A,i[4]=v,i[5]=T,i[6]=E,i[7]=T):(i[0]=v,i[1]=T,i[2]=E,i[3]=T,i[4]=v,i[5]=A,i[6]=E,i[7]=A)}for(var S="",y=0;y<t.length;y++)S+=t[y];this.uvHash=dr(S,666);var R=this.vertices;if(R){R.nu.length=0,R.nv.length=0;for(var I=0;I<R.u.length;I++)R.nu[I]=R.u[I]/r,R.nv[I]=R.v[I]/s}this._calculateSlicedUV()},i._serialize=function(){},i._deserialize=function(e){var t=e,i=t.rect;i&&(this._rect=new j(i.x,i.y,i.width,i.height));var n=t.offset;t.offset&&(this._offset=new X(n.x,n.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new K(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name;var s=t.capInsets;s&&(this._capInsets[0]=s[0],this._capInsets[1]=s[1],this._capInsets[2]=s[2],this._capInsets[3]=s[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},i.clone=function(){var e,i,n,r,s,a,o,h,u=new t,l=this.vertices;return u.vertices=l?{x:l.x,y:l.y,triangles:l.triangles,nu:null===(e=l.nu)||void 0===e?void 0:e.slice(0),u:null===(i=l.u)||void 0===i?void 0:i.slice(0),nv:null===(n=l.nv)||void 0===n?void 0:n.slice(0),v:null===(r=l.v)||void 0===r?void 0:r.slice(0)}:null,(s=u.uv).splice.apply(s,[0,u.uv.length].concat(this.uv)),u.uvHash=this.uvHash,(a=u.unbiasUV).splice.apply(a,[0,u.unbiasUV.length].concat(this.unbiasUV)),(o=u.uvSliced).splice.apply(o,[0,u.uvSliced.length].concat(this.uvSliced)),u._rect.set(this._rect),u._offset.set(this._offset),u._originalSize.set(this._originalSize),u._rotated=this._rotated,(h=u._capInsets).splice.apply(h,[0,u._capInsets.length].concat(this._capInsets)),u._atlasUuid=this._atlasUuid,u._texture=this._texture,u._isFlipUVX=this._isFlipUVX,u._isFlipUVY=this._isFlipUVY,u},i._textureLoaded=function(){var e=this._texture,t={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new j(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(t.originalSize=new K(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded())},i._refreshTexture=function(e){this._texture=e,e.loaded?this._textureLoaded():e.once("load",this._textureLoaded,this)},t}(M))||Bu);u.SpriteFrame=$u,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(qu||(qu={}));var el=e("bI",I("cc.TextureCube")((Qu=Zu=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,b(t,"_mipmaps",Ku,B(t)),t}a(t,e),t.fromTexture2DArray=function(e,i){for(var n=[],r=e.length/6,s=0;s<r;s++){var a=6*s;n.push({front:e[a+qu.front].image,back:e[a+qu.back].image,left:e[a+qu.left].image,right:e[a+qu.right].image,top:e[a+qu.top].image,bottom:e[a+qu.bottom].image})}return(i=i||new t).mipmaps=n,i};var i=t.prototype;return i.onLoaded=function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")},i.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},i.updateMipmaps=function(e,t){var i=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var n=e+t;tl(i._mipmaps[n],(function(e,t){i._assignImage(e,n,t)}))},s=0;s<n;++s)r(s)},i.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},i.releaseTexture=function(){this.mipmaps=[]},i._serialize=function(){},i._deserialize=function(t,i){var n=t;e.prototype._deserialize.call(this,n.base,i),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r){this._mipmaps[r]={front:new Co,back:new Co,left:new Co,right:new Co,top:new Co,bottom:new Co};var s=n.mipmaps[r];i.result.push(this._mipmaps[r],"front",s.front),i.result.push(this._mipmaps[r],"back",s.back),i.result.push(this._mipmaps[r],"left",s.left),i.result.push(this._mipmaps[r],"right",s.right),i.result.push(this._mipmaps[r],"top",s.top),i.result.push(this._mipmaps[r],"bottom",s.bottom)}},i._getGfxTextureCreateInfo=function(e){var t=new jr(Rn.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t.flags=t.flags|Nn.CUBEMAP,t},s(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0].front;this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,i){tl(e,(function(e,n){t._assignImage(e,i,n)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(sh),Zu.FaceIndex=qu,Ku=O((ju=Qu).prototype,"_mipmaps",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xu=ju))||Xu);function tl(e,t){t(e.front,qu.front),t(e.back,qu.back),t(e.left,qu.left),t(e.right,qu.right),t(e.top,qu.top),t(e.bottom,qu.bottom)}u.TextureCube=el;var il=e("dT",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2143664850,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:1062464958,builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0}]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:3946667351,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:3696836305,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:4115155772,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:66662317,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"spine-two-colored",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine-two-colored|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine-two-colored|sprite-vs:vert|sprite-fs:frag",hash:3853945046,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color2",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:3640649043,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs:vert|standard-fs:frag",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"standard|standard-vs:vert|standard-fs:frag",hash:3835610303,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:15,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:32,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3020491,builtins:{globals:{blocks:[{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal-texture",type:28},normalMap1:{value:"normal-texture",type:28},normalMap2:{value:"normal-texture",type:28},normalMap3:{value:"normal-texture",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs:vert|terrain-fs:frag",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal-texture",type:28},normalMap1:{value:"normal-texture",type:28},normalMap2:{value:"normal-texture",type:28},normalMap3:{value:"normal-texture",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs:vert|terrain-fs:frag",hash:408884017,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplers:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3874167763,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3822871803,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:1840901952,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:4},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:5},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:6},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:8}]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:2319917655,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:2029303284,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"splash-screen",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:2106901053,builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[{name:"splashFrag",defines:[],binding:0,stageFlags:16,members:[{name:"u_precent",type:13,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]),nl=new ns;function rl(e){return Math.ceil(Math.log2(Math.max(e,2)))}function sl(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function al(e,t,i,n,r){for(var s=e.builtins[n],a=[],o=function(e){var t=s.blocks[e],n=i.layouts[t.name],o=n&&i.bindings.find((function(e){return e.binding===n.binding}));if(!(n&&o&&o.descriptorType&Jr))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";a.push(n),r&&!r.includes(o)&&r.push(o)},h=0;h<s.blocks.length;h++)o(h);Array.prototype.unshift.apply(t.gfxBlocks,a);for(var u=[],l=function(e){var t=s.samplers[e],n=i.layouts[t.name],a=n&&i.bindings.find((function(e){return e.binding===n.binding}));if(!(n&&a&&a.descriptorType&$r))return console.warn("builtin sampler '"+t.name+"' not available!"),"continue";u.push(n),r&&!r.includes(a)&&r.push(a)},_=0;_<s.samplers.length;_++)l(_);Array.prototype.unshift.apply(t.gfxSamplers,u),r&&r.sort((function(e,t){return e.binding-t.binding}))}function ol(e){return e.members.reduce((function(e,t){return e+Qn(t.type)*t.count}),0)}function hl(e,t){for(var i=0;i<e.length;i++){var n=e[i];if("!"===n[0]){if(t[n.slice(1)])return!1}else if(!t[n])return!1}return!0}var ul=function(){function e(){this._localBindings={},this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=this._localBindings[e.name]=[],i=0;i<e.shaders.length;i++){var n=this.define(e.shaders[i]);n.effectName=e.name,al(n,this._templateInfos[n.hash],dh,"locals",t)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var i=H({},e),n=0,r=function(e){var t=i.defines[e],r=1;if("number"===t.type){var s=t.range;r=rl(s[1]-s[0]+1),t._map=function(e){return e-s[0]}}else"string"===t.type?(r=rl(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=n,n+=r},s=0;s<i.defines.length;s++)r(s);if(n>31&&(i.uber=!0),this._templates[e.name]=i,!this._templateInfos[i.hash]){var a={};a.samplerStartBinding=i.blocks.length,a.gfxBlocks=[],a.gfxSamplers=[],a.bindings=[],a.blockSizes=[];for(var o=0;o<i.blocks.length;o++){var h=i.blocks[o];a.blockSizes.push(ol(h)),a.bindings.push(new is(h.binding,h.descriptorType||bn.UNIFORM_BUFFER,1,h.stageFlags)),a.gfxBlocks.push(new Vr(gh.MATERIAL,h.binding,h.name,h.members.map((function(e){return new zr(e.name,e.type,e.count)})),1))}for(var u=0;u<i.samplers.length;u++){var l=i.samplers[u];a.bindings.push(new is(l.binding,l.descriptorType||bn.SAMPLER,l.count,l.stageFlags)),a.gfxSamplers.push(new Wr(gh.MATERIAL,l.binding,l.name,l.type,l.count))}a.gfxAttributes=[];for(var _=0;_<i.attributes.length;_++){var c=i.attributes[_];a.gfxAttributes.push(new fr(c.name,c.format,c.isNormalized,0,c.isInstanced,c.location))}a.gfxStages=[],a.gfxStages.push(new kr(Cn.VERTEX,"")),a.gfxStages.push(new kr(Cn.FRAGMENT,"")),a.handleMap=function(e){for(var t={},i=0;i<e.blocks.length;i++)for(var n=e.blocks[i],r=n.members,s=0,a=0;a<r.length;a++){var o=r[a];t[o.name]=Fu(bu.UBO,gh.MATERIAL,n.binding,o.type,s),s+=(Qn(o.type)>>2)*o.count}for(var h=0;h<e.samplers.length;h++){var u=e.samplers[h];t[u.name]=Fu(bu.SAMPLER,gh.MATERIAL,u.binding,u.type)}return t}(i),a.hPipelineLayout=Ft,a.setLayouts=[],this._templateInfos[i.hash]=a}return i},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,i){void 0===i&&(i=!1);var n=this._templates[t],r=this._templateInfos[n.hash];return r.setLayouts.length||(nl.bindings=r.bindings,r.setLayouts[gh.MATERIAL]=e.createDescriptorSetLayout(nl),nl.bindings=dh.bindings,r.setLayouts[gh.LOCAL]=e.createDescriptorSetLayout(nl)),r.setLayouts[i?gh.LOCAL:gh.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var i=this._templates[e],n=i.defines;if(i.uber){for(var r="",s=0;s<n.length;s++){var a=n[s],o=t[a.name];if(o&&a._map){var h=a._map(o);r+=""+a._offset+h+"|"}}return""+r+i.hash}for(var u=0,l=0;l<n.length;l++){var _=n[l],c=t[_.name];c&&_._map&&(u|=_._map(c)<<_._offset)}return u.toString(16)+"|"+i.hash},t.destroyShaderByDefines=function(e){var t=this,i=Object.keys(e);if(i.length)for(var n=i.map((function(t){var i=e[t];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(""+t+i)})),r=Object.keys(this._cache).filter((function(e){return n.every((function(i){return i.test(xt.get(t._cache[e]).name)}))})),s=0;s<r.length;s++){var a=r[s],o=xt.get(this._cache[a]);console.log("destroyed shader "+o.name),o.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,i,n,r){Object.assign(i,n.macros),r||(r=this.getKey(t,i));var s=this._cache[r];if(s)return s;var a=this._templates[t],o=this._templateInfos[a.hash];o.hPipelineLayout||(this.getDescriptorSetLayout(e,t),al(a,o,ch,"globals"),o.setLayouts[gh.GLOBAL]=n.descriptorSetLayout,o.hPipelineLayout=Gt.alloc(e,new as(o.setLayouts)));var h=function(e,t){for(var i=[],n=0;n<t.length;n++){var r=t[n],s=r.name,a=e[s],o=sl(r,a),h=!a||"0"===a;i.push({name:s,value:o,isDefault:h})}return i}(i,a.defines),u=h.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),"")+"\n",l=a.glsl3,_=ll(e);_?l=a[_]:console.error("Invalid GFX API!"),o.gfxStages[0].source=u+l.vert,o.gfxStages[1].source=u+l.frag;var c=function(e,t,i){for(var n=[],r=e.attributes,s=t.gfxAttributes,a=0;a<r.length;a++)hl(r[a].defines,i)&&n.push(s[a]);return n}(a,o,i),d=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,h),f=new Yr(d,o.gfxStages,c,o.gfxBlocks,o.gfxSamplers);return this._cache[r]=xt.alloc(e,f)},e}();function ll(e){switch(e.gfxAPI){case Hn.GLES2:case Hn.WEBGL:return"glsl1";case Hn.GLES3:case Hn.WEBGL2:return"glsl3";default:return"glsl4"}}var _l=e("ad",new ul);u.programLib=_l;var cl,dl,fl,pl=function(){function e(){this._device=null,this._resources={}}var i=e.prototype;return i.initBuiltinRes=function(e){var i=this;this._device=e;var n=this._resources,r=document.createElement("canvas"),s=r.getContext("2d"),a=new Co(r),o=r.width=r.height=2;s.fillStyle="#000",s.fillRect(0,0,o,o);var h=new ah;h._uuid="black-texture",h.image=a,n[h._uuid]=h,s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,o,o);for(var l=new Uint8Array(16),_=0;_<l.length;++_)l[_]=0;var c=new ah;c._uuid="empty-texture",c.image=a,c.uploadData(l),n[c._uuid]=c;var d=new el;d._uuid="black-cube-texture",d.setMipFilter(el.Filter.NEAREST),d.image={front:new Co(r),back:new Co(r),left:new Co(r),right:new Co(r),top:new Co(r),bottom:new Co(r)},n[d._uuid]=d,s.fillStyle="#777",s.fillRect(0,0,o,o);var f=new ah;f._uuid="grey-texture",f.image=a,n[f._uuid]=f,s.fillStyle="#fff",s.fillRect(0,0,o,o);var p=new ah;p._uuid="white-texture",p.image=a,n[p._uuid]=p;var m=new el;m._uuid="white-cube-texture",m.setMipFilter(el.Filter.NEAREST),m.image={front:new Co(r),back:new Co(r),left:new Co(r),right:new Co(r),top:new Co(r),bottom:new Co(r)},n[m._uuid]=m,s.fillStyle="#7f7fff",s.fillRect(0,0,o,o);var g=new ah;g._uuid="normal-texture",g.image=a,n[g._uuid]=g,r.width=r.height=16,s.fillStyle="#ddd",s.fillRect(0,0,16,16),s.fillStyle="#555",s.fillRect(0,0,8,8),s.fillStyle="#555",s.fillRect(8,8,8,8);var v=new ah;v._uuid="default-texture",v.image=a,n[v._uuid]=v;var E=new el;E.setMipFilter(el.Filter.NEAREST),E._uuid="default-cube-texture",E.image={front:new Co(r),back:new Co(r),left:new Co(r),right:new Co(r),top:new Co(r),bottom:new Co(r)},n[E._uuid]=E;var T=new $u,A=a._texture;T.texture=A,T._uuid="default-spriteframe",n[T._uuid]=T;var S=ll(e);return S?function(e){switch(e){case"./shader-sources/glsl1.js":return t.import("./glsl1-fe40e638.js");case"./shader-sources/glsl3.js":return t.import("./glsl3-831e2430.js");case"./shader-sources/glsl4.js":return t.import("./glsl4-853c6907.js");default:return t.import(e)}}("./shader-sources/"+S+".js").then((function(e){var t=e.default;il.forEach((function(e,i){var n=Object.assign(new u.EffectAsset,e);n.shaders.forEach((function(e,n){var r=t[i][n];r&&(e[S]=r)})),n.hideInEditor=!0,n.onLoaded()})),i._initMaterials()})):Promise.reject(Error("Failed to initialize builtin shaders: unknown device."))},i.get=function(e){return this._resources[e]},i._initMaterials=function(){var e=this._resources,t=new u.Material;t._uuid="standard-material",t.initialize({effectName:"standard"}),e[t._uuid]=t;var i=new u.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",u.color("#ffff00")),e[i._uuid]=i;var n=new u.Material;n._uuid="missing-material",n.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),n.setProperty("mainColor",u.color("#ff00ff")),e[n._uuid]=n;var r=new u.Material;r._uuid="default-clear-stencil",r.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[r._uuid]=r;var s=new u.Material;s._uuid="ui-base-material",s.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[s._uuid]=s;var a=new u.Material;a._uuid="ui-sprite-material",a.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[a._uuid]=a;var o=new u.Material;o._uuid="ui-alpha-test-material",o.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[o._uuid]=o;var h=new u.Material;h._uuid="ui-sprite-gray-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[h._uuid]=h;var l=new u.Material;l._uuid="ui-sprite-alpha-sep-material",l.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[l._uuid]=l;var _=new u.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[_._uuid]=_;var c=new u.Material;c._uuid="ui-graphics-material",c.initialize({effectName:"graphics"}),e[c._uuid]=c;var d=new u.Material;d._uuid="default-particle-material",d.initialize({effectName:"particle"}),e[d._uuid]=d;var f=new u.Material;f._uuid="default-particle-gpu-material",f.initialize({effectName:"particle-gpu"}),e[f._uuid]=f;var p=new u.Material;p._uuid="default-trail-material",p.initialize({effectName:"particle-trail"}),e[p._uuid]=p;var m=new u.Material;m._uuid="default-billboard-material",m.initialize({effectName:"billboard"}),e[m._uuid]=m;var g=new u.Material;g._uuid="ui-spine-two-colored-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"spine-two-colored"}),e[g._uuid]=g},e}(),ml=e("dU",u.builtinResMgr=new pl),gl=e("dO",(cl=new Map,dl=0,function(e){return"number"==typeof e?e:(cl.has(e)||(cl.set(e,1<<dl),dl++),cl.get(e))})),vl=new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE),El=new ir(null),Tl=new es(null);!function(e){e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(fl||(fl=e("aa",{})));var Al=e("ab",function(){function e(e){this._rootBuffer=null,this._rootBufferDirty=!1,this._buffers=[],this._descriptorSet=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._root=void 0,this._device=void 0,this._hShaderDefault=Ft,this._handle=Ft,this._bs=new Cr,this._dss=new Or,this._rs=new Ir,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){var i=e.handle;void 0!==t.priority&&Kt.set(i,Bt.PRIORITY,t.priority),void 0!==t.primitive&&Kt.set(i,Bt.PRIMITIVE,t.primitive),void 0!==t.stage&&Kt.set(i,Bt.STAGE,t.stage),void 0!==t.dynamicStates&&Kt.set(i,Bt.DYNAMIC_STATES,t.dynamicStates),void 0!==t.phase&&Kt.set(i,Bt.PHASE,gl(t.phase));var n=e._bs;if(t.blendState){var r=t.blendState,s=r.targets;s&&s.forEach((function(e,t){n.setTarget(t,e)})),void 0!==r.isA2C&&(n.isA2C=r.isA2C),void 0!==r.isIndepend&&(n.isIndepend=r.isIndepend),void 0!==r.blendColor&&(n.blendColor=r.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e,t){var i,n=e.handle,r=t+","+Kt.get(n,Bt.PRIMITIVE)+","+Kt.get(n,Bt.DYNAMIC_STATES);return r+=function(e){for(var t,i=",bs,"+e.isA2C,n=R(e.targets);!(t=n()).done;){var r=t.value;i+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,i+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return i}(e._bs),r+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),dr(r+=",rs,"+(i=e._rs).cullMode+","+i.depthBias+","+i.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=on.UNKNOWN);var n=this._propertyHandleMap[e];return n?(i?n=Hu(n,i):t&&(n=Hu(n,Du(n)-t)),n+t):0},t.getBinding=function(t){var i=this.getHandle(t);return i?e.getBindingFromHandle(i):-1},t.setUniform=function(t,i){var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),s=e.getOffsetFromHandle(t),a=this._blocks[n];zu[r](a,i,s),this._rootBufferDirty=!0},t.getUniform=function(t,i){var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),s=e.getOffsetFromHandle(t),a=this._blocks[n];return ku[r](a,i,s)},t.setUniformArray=function(t,i){for(var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),s=Qn(r)>>2,a=this._blocks[n],o=e.getOffsetFromHandle(t),h=0;h<i.length;h++,o+=s)null!==i[h]&&zu[r](a,i[h],o);this._rootBufferDirty=!0},t.bindTexture=function(e,t,i){this._descriptorSet.bindTexture(e,t,i||0)},t.bindSampler=function(e,t,i){this._descriptorSet.bindSampler(e,t,i||0)},t.setDynamicState=function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t.update=function(){this._rootBufferDirty&&this._rootBuffer&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBlock=null),this._descriptorSet=null,this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._handle&&(Dt.free(Kt.get(this._handle,Bt.DESCRIPTOR_SET)),Kt.free(this._handle),this._handle=Ft)},t.resetUniform=function(t){var i=this.getHandle(t);if(i){var n=e.getTypeFromHandle(i),r=e.getBindingFromHandle(i),s=e.getOffsetFromHandle(i),a=this._blocks[r],o=this._properties[t],h=o&&o.value||Wu(n);zu[n](a,h,s),this._rootBufferDirty=!0}},t.resetTexture=function(t,i){var n=this.getHandle(t);if(n){var r=e.getTypeFromHandle(n),s=e.getBindingFromHandle(n),a=this._properties[t],o=a&&a.value,h=o?o+"-texture":Wu(r),u=ml.get(h),l=u&&u.getGFXTexture(),_=a&&void 0!==a.samplerHash?a.samplerHash:u&&u.getSamplerHash(),c=jo.getSampler(this._device,_);this._descriptorSet.bindSampler(s,c,i),this._descriptorSet.bindTexture(s,l,i)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],i=this._blocks[t.binding],n=0,r=0;r<t.members.length;r++){for(var s=t.members[r],a=this._properties[s.name],o=a&&a.value||Wu(s.type),h=(Qn(s.type)>>2)*s.count,u=0;u+o.length<=h;u+=o.length)i.set(o,n+u);n+=h}this._rootBufferDirty=!0},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplers.length;e++)for(var t=this._shaderInfo.samplers[e],i=0;i<t.count;i++)this.resetTexture(t.name,i)},t.tryCompile=function(){var t=this._root.pipeline;return!!t&&(this._syncBatchingScheme(),this._hShaderDefault=_l.getGFXShader(this._device,this._programName,this._defines,t),this._hShaderDefault?(Kt.set(this._handle,Bt.PIPELINE_LAYOUT,_l.getTemplateInfo(this._programName).hPipelineLayout),Kt.set(this._handle,Bt.HASH,e.getPassHash(this,this._hShaderDefault)),!0):(console.warn("create shader "+this._programName+" failed"),!1))},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._hShaderDefault&&!this.tryCompile())return console.warn("pass resources incomplete"),Ft;if(!e)return this._hShaderDefault;for(var t=this._root.pipeline,i=0;i<e.length;i++){var n=e[i];this._defines[n.name]=n.value}for(var r=_l.getGFXShader(this._device,this._programName,this._defines,t),s=0;s<e.length;s++){var a=e[s];delete this._defines[a.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._doInit=function(t,i){void 0===i&&(i=!1);var n=this._handle=Kt.alloc();Kt.set(n,Bt.PRIORITY,hh.DEFAULT),Kt.set(n,Bt.STAGE,oh.DEFAULT),Kt.set(n,Bt.PHASE,gl("default")),Kt.set(n,Bt.PRIMITIVE,dn.TRIANGLE_LIST),Kt.set(n,Bt.RASTERIZER_STATE,this._rs.handle),Kt.set(n,Bt.DEPTH_STENCIL_STATE,this._dss.handle),Kt.set(n,Bt.BLEND_STATE,this._bs.handle),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=i?H({},t.defines):t.defines,this._shaderInfo=_l.getTemplate(t.program),this._properties=t.properties||this._properties;var r=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),Tl.layout=_l.getDescriptorSetLayout(this._device,t.program);var s=Dt.alloc(this._device,Tl);Kt.set(this._handle,Bt.DESCRIPTOR_SET,s),this._descriptorSet=Dt.get(s);for(var a=this._shaderInfo.blocks,o=_l.getTemplateInfo(t.program),h=o.blockSizes,u=o.handleMap,l=r.uboOffsetAlignment,_=[],c=0,d=0,f=0;f<a.length;f++){var p=h[f];_.push(d),d+=Math.ceil(p/l)*l,c=p}var m=_[_.length-1]+c;m&&(vl.size=16*Math.ceil(m/16),this._rootBuffer=r.createBuffer(vl),this._rootBlock=new ArrayBuffer(m));for(var g=0,v=0;g<a.length;g++){var E=a[g].binding,T=h[g];El.buffer=this._rootBuffer,El.offset=_[v++],El.range=16*Math.ceil(T/16);var A=this._buffers[E]=r.createBuffer(El);this._blocks[E]=new Float32Array(this._rootBlock,El.offset,T/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(E,A)}var S=this._propertyHandleMap=u,y={};for(var R in this._properties){var I=this._properties[R];I.handleInfo&&(y[R]=this.getHandle.apply(this,I.handleInfo))}Object.assign(S,y)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(zn.INSTANCED_ARRAYS)?Kt.set(this._handle,Bt.BATCHING_SCHEME,fl.INSTANCING):(this._defines.USE_INSTANCING=!1,Kt.set(this._handle,Bt.BATCHING_SCHEME,0)):this._defines.USE_BATCHING?Kt.set(this._handle,Bt.BATCHING_SCHEME,fl.VB_MERGING):Kt.set(this._handle,Bt.BATCHING_SCHEME,0)},s(e,[{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return _l.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"handle",get:function(){return this._handle}},{key:"priority",get:function(){return Kt.get(this._handle,Bt.PRIORITY)}},{key:"primitive",get:function(){return Kt.get(this._handle,Bt.PRIMITIVE)}},{key:"stage",get:function(){return Kt.get(this._handle,Bt.STAGE)}},{key:"phase",get:function(){return Kt.get(this._handle,Bt.PHASE)}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return Kt.get(this._handle,Bt.DYNAMIC_STATES)}},{key:"batchingScheme",get:function(){return Kt.get(this._handle,Bt.BATCHING_SCHEME)}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return Kt.get(this._handle,Bt.HASH)}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}}]),e}());function Sl(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function yl(e,t){return Math.ceil(e/t)*t}Al.PropertyType=bu,Al.getPropertyTypeFromHandle=xu,Al.getTypeFromHandle=Du,Al.getBindingFromHandle=Uu,Al.getOffsetFromHandle=Gu;var Rl,Il,Ol,Nl,Cl,bl,wl,Ll,Ml,Pl,Bl,Fl,xl,Dl,Ul,Gl,Hl,kl,zl=e("aj",function(){function e(e){this._device=void 0,this._format=hn.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Rr,this._region1=new Rr,this._region2=new Rr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=Xn[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=qn(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=yl(e,this._alignment);var i=-1,n=-1;if(void 0!==t&&(i=t,n=this._findAvailableSpace(e,i)),n<0)for(var r=0;r<this._chunkCount&&(i=r,!((n=this._findAvailableSpace(e,i))>=0));++r);if(n>=0){var s=this._chunks[i];s.start+=e;var a={chunkIdx:i,start:n,end:n+e,texture:s.texture};return this._handles.push(a),a}var o=Math.sqrt(e/this._formatSize),h=this._roundUpFn&&this._roundUpFn(o,this._formatSize)||Math.max(1024,Sl(o)),u=this._chunks[this.createChunk(h)];u.start+=e;var l={chunkIdx:this._chunkCount-1,start:0,end:e,texture:u.texture};return this._handles.push(l),l},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var i={texture:this._device.createTexture(new jr(Rn.TEX2D,In.SAMPLED|In.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=i,this._chunkCount++},t.update=function(e,t){var i=[],n=[],r=e.start/this._formatSize,s=t.byteLength/this._formatSize,a=r%e.texture.width,o=Math.floor(r/e.texture.width),h=Math.min(e.texture.width-a,s),u=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=o,this._region0.texExtent.width=h,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(t,u*this._formatSize,h*this._channels)),n.push(this._region0),a=0,o+=1,s-=h,u+=h),s>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=o,s>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(s/e.texture.width),h=this._region1.texExtent.width*this._region1.texExtent.height):(h=s,this._region1.texExtent.width=h,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(t,u*this._formatSize,h*this._channels)),n.push(this._region1),a=0,o+=this._region1.texExtent.height,s-=h,u+=h),s>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=o,this._region2.texExtent.width=s,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(t,u*this._formatSize,s*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)},t._findAvailableSpace=function(e,t){var i=this._chunks[t],n=!1,r=i.start;if(r+e<=i.size)n=!0;else{r=0;for(var s=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<s.length;a++){var o=s[a];if(r+e<=o.start){n=!0;break}r=o.end}!n&&r+e<=i.size&&(n=!0)}return n?r:-1},t._McDonaldAlloc=function(e){e=yl(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var i=this._chunks[t],n=!1,r=i.start;if(r+e<=i.end?n=!0:r>i.end?r+e<=i.size?n=!0:e<=i.end&&(i.start=r=0,n=!0):r===i.end&&(i.start=r=0,i.end=i.size,e<=i.end&&(n=!0)),n){i.start+=e;var s={chunkIdx:t,start:r,end:r+e,texture:i.texture};return this._handles.push(s),s}}var a=Math.sqrt(e/this._formatSize),o=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,Sl(a)),h=this._chunks[this.createChunk(o)];h.start+=e;var u={chunkIdx:this._chunkCount,start:0,end:e,texture:h.texture};return this._handles.push(u),u},e}()),Vl=e("bJ",I("cc.EffectAsset")((Ll=wl=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,b(t,"techniques",Ol,B(t)),b(t,"shaders",Nl,B(t)),b(t,"combinations",Cl,B(t)),b(t,"hideInEditor",bl,B(t)),t}a(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if(t._effects[e])delete t._effects[e];else for(var i in t._effects)if(t._effects[i]._uuid===e)return void delete t._effects[i]},t.get=function(e){if(t._effects[e])return t._effects[e];for(var i in t._effects)if(t._effects[i]._uuid===e)return t._effects[i];return null},t.getAll=function(){return t._effects};var i=t.prototype;return i.onLoaded=function(){_l.register(this),t.register(this),u.game.once(u.Game.EVENT_ENGINE_INITED,this._precompile,this)},i._precompile=function(){for(var e=this,t=u.director.root,i=function(i){var n=e.shaders[i],r=e.combinations[i];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,i){var n=r[t],s=[i].concat([].concat(Array(n.length-1)).map((function(){return H({},i)})));return s.forEach((function(e,i){return e[t]=n[i]})),e.concat(s)}),[])}),[{}]).forEach((function(e){return _l.getGFXShader(t.device,n.name,e,t.pipeline)}))},n=0;n<this.shaders.length;n++)i(n)},i.destroy=function(){return t.remove(this.name),e.prototype.destroy.call(this)},t}(M),wl._effects={},Ol=O((Il=Ll).prototype,"techniques",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nl=O(Il.prototype,"shaders",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cl=O(Il.prototype,"combinations",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bl=O(Il.prototype,"hideInEditor",[N,Z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Rl=Il))||Rl);u.EffectAsset=Vl;var Wl=new x("RenderTex"),Yl=new Br;Yl.endLayout=Pn.SHADER_READONLY_OPTIMAL;var Xl,jl,Kl,Zl,Ql,ql,Jl,$l,e_,t_,i_=new Fr,n_=new Dr([Yl],i_),r_={width:1,height:1,renderPassInfo:n_},s_=e("bM",(Ml=I("cc.RenderTexture"),Pl=Q(),Bl=q(),Fl=Q(),xl=q(),Ml((kl=function(e){function t(){var t;return t=e.call(this)||this,b(t,"_width",Gl,B(t)),b(t,"_height",Hl,B(t)),t._textureHash=0,t._id=void 0,t._window=null,t._id=Wl.getNewId(),t._textureHash=dr(t._id,666),t}a(t,e);var i=t.prototype;return i.getHash=function(){return this._textureHash},i.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},i.reset=function(e){this.initialize(e)},i.destroy=function(){return this._window&&(u.director.root.destroyWindow(this._window),this._window=null),e.prototype.destroy.call(this)},i.resize=function(e,t){this._width=e,this._height=t,this._window&&this._window.resize(e,t),this.emit("resize",this._window)},i.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},i.getGFXSampler=function(){var e=u.director.root;return jo.getSampler(e.device,wo)},i.getSamplerHash=function(){return wo},i.onLoaded=function(){this._initWindow(),this.loaded=!0,this.emit("load")},i._initWindow=function(e){var t=u.director.root;r_.title=this._name,r_.width=this._width,r_.height=this._height,r_.renderPassInfo=e&&e.passInfo?e.passInfo:n_,this._window?(this._window.destroy(),this._window.initialize(t.device,r_)):this._window=t.createWindow(r_)},s(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"window",get:function(){return this._window}}]),t}(M),Gl=O((Ul=kl).prototype,"_width",[N,Pl,Bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Hl=O(Ul.prototype,"_height",[N,Fl,xl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Dl=Ul))||Dl));u.RenderTexture=s_;var a_=e("bK",(Xl=I("cc.Material"),jl=U(Vl),Xl((t_=function(e){function t(){var t;return t=e.call(this)||this,b(t,"_effectAsset",Ql,B(t)),b(t,"_techIdx",ql,B(t)),b(t,"_defines",Jl,B(t)),b(t,"_states",$l,B(t)),b(t,"_props",e_,B(t)),t._passes=[],t._hash=0,t.loaded=!1,t}a(t,e),t.getHash=function(e){for(var t,i=0,n=R(e.passes);!(t=n()).done;)i^=t.value.hash;return i};var i=t.prototype;return i.initialize=function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=Vl.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()},i.reset=function(e){this.initialize(e)},i.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},i.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},i.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},i.onLoaded=function(){this._update(),this.loaded=!0,this.emit("load")},i.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var i,n=R(this._passes);!(i=n()).done;){var r=i.value;r.resetUBOs(),r.resetTextures()}},i.setProperty=function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,s=r.length,a=0;a<s;a++){var o=r[a];this._uploadProperty(o,e,t)&&(this._props[o.propertyIndex][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: "+i+".");var h=this._passes[i];this._uploadProperty(h,e,t)&&(this._props[h.propertyIndex][e]=t,n=!0)}n||console.warn("illegal property name: "+e+".")},i.getProperty=function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++){var s=i[r];if(e in s)return s[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},i.copy=function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=H({},e._props[t]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=H({},e._defines[i]);this._states.length=e._states.length;for(var n=0;n<e._states.length;n++)this._states[n]=H({},e._states[n]);this._effectAsset=e._effectAsset,this._update()},i._prepareInfo=function(e,t){var i=e;if(!Array.isArray(i)){var n=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;i=Array(n).fill(i)}for(var r=0;r<i.length;++r)Object.assign(t[r]||(t[r]={}),i[r])},i._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,i=[],n=0;n<t;++n){var r=e.passes[n],s=r.passIndex=n,a=r.defines=this._defines[s]||(this._defines[s]={}),o=r.stateOverrides=this._states[s]||(this._states[s]={});if(void 0!==r.propertyIndex&&(Object.assign(a,this._defines[r.propertyIndex]),Object.assign(o,this._states[r.propertyIndex])),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var h=new Al(u.director.root);h.initialize(r),i.push(h)}}return i},i._update=function(e){var i=this;if(void 0===e&&(e=!0),this._effectAsset){if(this._passes&&this._passes.length)for(var n,r=R(this._passes);!(n=r()).done;)n.value.destroy();this._passes=this._createPasses();var s=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=s,e)this._passes.forEach((function(e,t){var n=i._props[t];for(var r in n||(n=i._props[t]={}),n=i._props[e.propertyIndex])i._uploadProperty(e,r,n[r])}));else for(var a=0;a<this._props.length;a++)this._props[a]={}}else{var o=ml.get("missing-effect-material");o&&(this._passes=o._passes.slice())}this._hash=t.getHash(this)},i._uploadProperty=function(e,t,i){var n=e.getHandle(t);if(!n)return!1;var r=Al.getPropertyTypeFromHandle(n);if(r===bu.UBO)Array.isArray(i)?e.setUniformArray(n,i):null!==i?e.setUniform(n,i):e.resetUniform(t);else if(r===bu.SAMPLER)if(Array.isArray(i))for(var s=0;s<i.length;s++)this._bindTexture(e,n,i[s],s);else i?this._bindTexture(e,n,i):e.resetTexture(t);return!0},i._bindTexture=function(e,t,i,n){var r=Al.getBindingFromHandle(t);if(i instanceof Qr)e.bindTexture(r,i,n);else if(i instanceof Qo||i instanceof $u||i instanceof s_){var s=i.getGFXTexture();if(!s||!s.width||!s.height)return;e.bindTexture(r,s,n),e.bindSampler(r,i.getGFXSampler(),n)}},i._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=R(this._passes);!(e=t()).done;)e.value.destroy();this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0},s(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(M),Ql=O((Zl=t_).prototype,"_effectAsset",[jl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ql=O(Zl.prototype,"_techIdx",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jl=O(Zl.prototype,"_defines",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$l=O(Zl.prototype,"_states",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),e_=O(Zl.prototype,"_props",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kl=Zl))||Kl));u.Material=a_;var o_,h_,u_,l_,__,c_,d_,f_,p_,m_,g_,v_,E_,T_,A_,S_,y_,R_=e("al",function(e){function t(t,i){var n;(n=e.call(this,t.root)||this)._parent=void 0,n._owner=void 0,n._dontNotify=!1,n._parent=t,n._owner=i,n._doInit(n._parent,!0);for(var r=0;r<n._shaderInfo.blocks.length;r++){var s=n._shaderInfo.blocks[r],a=n._blocks[s.binding],o=n._parent.blocks[s.binding];a.set(o)}n._rootBufferDirty=!0;for(var h=n._parent,u=0;u<n._shaderInfo.samplers.length;u++)for(var l=n._shaderInfo.samplers[u],_=0;_<l.count;_++){var c=h._descriptorSet.getSampler(l.binding,_),d=h._descriptorSet.getTexture(l.binding,_);n._descriptorSet.bindSampler(l.binding,c,_),n._descriptorSet.bindTexture(l.binding,d,_)}return e.prototype.tryCompile.call(B(n)),n}a(t,e),s(t,[{key:"parent",get:function(){return this._parent}}]);var i=t.prototype;return i.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),Al.fillPipelineInfo(this,e),Al.fillPipelineInfo(this,t),this._onStateChange()},i.tryCompile=function(t){if(t&&!Yu(this._defines,t))return!1;var i=e.prototype.tryCompile.call(this);return this._onStateChange(),i},i.beginChangeStatesSilently=function(){this._dontNotify=!0},i.endChangeStatesSilently=function(){this._dontNotify=!1},i._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,Kt.set(this._handle,Bt.BATCHING_SCHEME,0)},i._onStateChange=function(){Kt.set(this._handle,Bt.HASH,Al.getPassHash(this,this._hShaderDefault)),this._owner.onPassStateChange(this._dontNotify)},t}(Al)),I_=e("ak",function(e){function t(t){var i;return(i=e.call(this)||this)._passes=[],i._parent=void 0,i._owner=void 0,i._subModelIdx=0,i._parent=t.parent,i._owner=t.owner||null,i._subModelIdx=t.subModelIdx||0,i.copy(i._parent),i}a(t,e),s(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]);var i=t.prototype;return i.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var i,n=R(this._passes);!(i=n()).done;)i.value.tryCompile(e);else this._passes[t].tryCompile(e)},i.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r=this._passes[n],s=this._states[n]||(this._states[n]={});for(var a in e)s[a]=e[a];r.overridePipelineStates(i[r.passIndex],s)}else{var o=this._states[t]||(this._states[t]={});for(var h in e)o[h]=e[h];this._passes[t].overridePipelineStates(i[t],o)}}},i.destroy=function(){return this._doDestroy(),!0},i.onPassStateChange=function(e){this._hash=a_.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},i._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var i=0;i<t.length;++i)e.push(new R_(t[i],this));return e},t}(a_));!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed"}(o_||(o_=e("b_",{}))),o(o_),u.SystemEventType=o_;var O_=new X,N_=new X,C_=new _,b_=new _,w_=new _,L_=new _(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),M_=new j,P_=e("e4",(h_=I("cc.UITransform"),u_=$(),l_=ke(110),__=ee(),c_=te(),d_=ie(),f_=te(),p_=ie(),m_=ie(),h_(g_=u_(g_=l_(g_=__(g_=ze(g_=J((y_=S_=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,b(t,"_priority",E_,B(t)),t._canvas=null,b(t,"_contentSize",T_,B(t)),b(t,"_anchorPoint",A_,B(t)),t}a(t,e);var i=t.prototype;return i.__preload=function(){this.node._uiProps.uiTransformComp=this},i.onEnable=function(){this._updateVisibility(),this.node.on(o_.PARENT_CHANGED,this._parentChanged,this),this._sortSiblings()},i.onDisable=function(){this.node.off(o_.PARENT_CHANGED,this._parentChanged,this),this._canvas=null},i.onDestroy=function(){this.node._uiProps.uiTransformComp=null},i.setContentSize=function(e,t){var i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;i.width=e,i.height=t}this.node.emit(o_.SIZE_CHANGED)},i.setAnchorPoint=function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(o_.ANCHOR_CHANGED,this._anchorPoint)},i.isHit=function(e,t){var i=this._contentSize.width,n=this._contentSize.height,r=O_,s=N_,a=this._canvas;if(a){a.node.getWorldRT(C_);var o=C_.m12,h=C_.m13,l=u.visibleRect.center;if(C_.m12=l.x-(C_.m00*o+C_.m04*h),C_.m13=l.y-(C_.m01*o+C_.m05*h),_.invert(C_,C_),X.transformMat4(r,e,C_),this.node.getWorldMatrix(w_),_.invert(C_,w_),_.strictEquals(C_,L_))return!1;if(X.transformMat4(s,r,C_),s.x+=this._anchorPoint.x*i,s.y+=this._anchorPoint.y*n,s.x>=0&&s.y>=0&&s.x<=i&&s.y<=n){if(t&&t.mask){for(var c=t.mask,d=this.node,f=0;d&&f<c.index;++f,d=d.parent);if(d===c.node){var p=d.getComponent(u.Mask);return!p||!p.enabledInHierarchy||p.isHit(r)}return t.mask=null,!0}return!0}return!1}},i.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(w_),_.invert(C_,w_),t||(t=new r),r.transformMat4(t,e,C_)},i.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(w_),t||(t=new r),r.transformMat4(t,e,w_)},i.getBoundingBox=function(){_.fromRTS(b_,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new j(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(b_),i},i.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(w_),this.getBoundingBoxTo(w_)):this.getBoundingBox()},i.getBoundingBoxTo=function(e){_.fromRTS(b_,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var i=this._contentSize.width,n=this._contentSize.height,r=new j(-this._anchorPoint.x*i,-this._anchorPoint.y*n,i,n);if(_.multiply(w_,e,b_),r.transformMat4(w_),!this.node.children)return r;for(var s,a=this.node.children,o=R(a);!(s=o()).done;){var h=s.value;if(h&&h.active){var u=h.getComponent(t);if(u){var l=u.getBoundingBoxTo(e);l&&j.union(r,r,l)}}}return r},i.getComputeAABB=function(e){var t=this._contentSize.width,i=this._contentSize.height;M_.set(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i),M_.transformMat4(this.node.worldMatrix);var n=M_.x+.5*M_.width,r=M_.y+.5*M_.height,s=this.node.worldPosition.z,a=M_.width/2,o=M_.height/2;if(null==e)return new Ia(n,r,s,a,o,.001);Ia.set(e,n,r,s,a,o,.001)},i._updateVisibility=function(){for(var e=this.node;e;){if(e){var t=e.getComponent("cc.Canvas");if(t){this._canvas=t;break}}e=e.parent}},i._parentChanged=function(){this._canvas&&this._canvas.node===this.node||this._sortSiblings()},i._sortSiblings=function(){var e=this.node.parent&&this.node.parent.children;e&&(e.sort((function(e,t){var i=e._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp,r=(i?i.priority:0)-(n?n.priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r})),this.node.parent._updateSiblingIndex())},s(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(o_.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(o_.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(o_.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(o_.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(o_.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(o_.ANCHOR_CHANGED,this._anchorPoint))}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._canvas&&this._canvas.node===this.node?L(6706):(this._priority=e,this._sortSiblings()))}},{key:"visibility",get:function(){return this._canvas?this._canvas.visibility:-1}}]),t}(ne),S_.EventType=o_,O((v_=y_).prototype,"contentSize",[c_,d_],Object.getOwnPropertyDescriptor(v_.prototype,"contentSize"),v_.prototype),O(v_.prototype,"anchorPoint",[f_,p_],Object.getOwnPropertyDescriptor(v_.prototype,"anchorPoint"),v_.prototype),O(v_.prototype,"priority",[m_],Object.getOwnPropertyDescriptor(v_.prototype,"priority"),v_.prototype),E_=O(v_.prototype,"_priority",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T_=O(v_.prototype,"_contentSize",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K(100,100)}}),A_=O(v_.prototype,"_anchorPoint",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new X(.5,.5)}}),g_=v_))||g_)||g_)||g_)||g_)||g_)||g_)),B_=function(){function e(e){this._uiComp=null,this.opacity=1,this._uiTransformComp=null,this._node=void 0,this._node=e}return s(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent(P_)),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?L(12002):this._uiComp=e}}]),e}(),F_=new X,x_=e("bV",function(e){function t(i,n,r){var s;return(s=e.call(this,re.MOUSE,n)||this).movementX=0,s.movementY=0,s.eventType=void 0,s._button=t.BUTTON_MISSING,s._x=0,s._y=0,s._prevX=0,s._prevY=0,s._scrollX=0,s._scrollY=0,s.eventType=i,r&&(s._prevX=r.x,s._prevY=r.y),s}a(t,e);var i=t.prototype;return i.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},i.getScrollX=function(){return this._scrollX},i.getScrollY=function(){return this._scrollY},i.setLocation=function(e,t){this._x=e,this._y=t},i.getLocation=function(e){return e||(e=new X),X.set(e,this._x,this._y),e},i.getLocationInView=function(e){return e||(e=new X),X.set(e,this._x,u.view._designResolutionSize.height-this._y),e},i.getUILocation=function(e){return e||(e=new X),X.set(e,this._x,this._y),u.view._convertPointWithScale(e),e},i.getPreviousLocation=function(e){return e||(e=new X),X.set(e,this._prevX,this._prevY),e},i.getUIPreviousLocation=function(e){return e||(e=new X),X.set(e,this._prevX,this._prevY),u.view._convertPointWithScale(e),e},i.getDelta=function(e){return e||(e=new X),X.set(e,this._x-this._prevX,this._y-this._prevY),e},i.getDeltaX=function(){return this._x-this._prevX},i.getDeltaY=function(){return this._y-this._prevY},i.getUIDelta=function(e){return e||(e=new X),X.set(e,(this._x-this._prevX)/u.view.getScaleX(),(this._y-this._prevY)/u.view.getScaleY()),e},i.getUIDeltaX=function(){return(this._x-this._prevX)/u.view.getScaleX()},i.getUIDeltaY=function(){return(this._y-this._prevY)/u.view.getScaleY()},i.setButton=function(e){this._button=e},i.getButton=function(){return this._button},i.getLocationX=function(){return this._x},i.getLocationY=function(){return this._y},i.getUILocationX=function(){var e=u.view.getViewportRect();return(this._x-e.x)/u.view.getScaleX()},i.getUILocationY=function(){var e=u.view.getViewportRect();return(this._y-e.y)/u.view.getScaleY()},t}(re));x_.NONE=0,x_.DOWN=1,x_.UP=2,x_.MOVE=3,x_.SCROLL=4,x_.BUTTON_MISSING=-1,x_.BUTTON_LEFT=0,x_.BUTTON_RIGHT=2,x_.BUTTON_MIDDLE=1,x_.BUTTON_4=3,x_.BUTTON_5=4,x_.BUTTON_6=5,x_.BUTTON_7=6,x_.BUTTON_8=7;var D_=e("bW",function(e){function t(t,i,n,r){var s;return(s=e.call(this,re.TOUCH,i)||this).touch=null,s.simulate=!1,s._eventCode=void 0,s._touches=void 0,s._allTouches=void 0,s._eventCode=n||0,s._touches=t||[],s._allTouches=r||[],s}a(t,e);var i=t.prototype;return i.getEventCode=function(){return this._eventCode},i.getTouches=function(){return this._touches},i.getAllTouches=function(){return this._allTouches},i.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},i.getLocation=function(e){return this.touch?this.touch.getLocation(e):new X},i.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new X},i.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new X},i.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new X},i.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new X},i.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new X},i.getID=function(){return this.touch?this.touch.getID():null},i.getDelta=function(e){return this.touch?this.touch.getDelta(e):new X},i.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new X},i.getDeltaX=function(){return this.touch?this.touch.getDelta(F_).x:0},i.getDeltaY=function(){return this.touch?this.touch.getDelta(F_).y:0},i.getLocationX=function(){return this.touch?this.touch.getLocationX():0},i.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(re));D_.MAX_TOUCHES=5,D_.BEGAN=0,D_.MOVED=1,D_.ENDED=2,D_.CANCELLED=3;var U_=e("bX",function(e){function t(t,i){var n;return(n=e.call(this,re.ACCELERATION,i)||this).acc=void 0,n.acc=t,n}return a(t,e),t}(re)),G_=e("bY",function(e){function t(t,i,n){var r;return(r=e.call(this,re.KEYBOARD,n)||this).keyCode=void 0,r.rawEvent=void 0,r.isPressed=void 0,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r.isPressed=i,r}return a(t,e),t}(re));re.EventMouse=x_,re.EventTouch=D_,re.EventAcceleration=U_,re.EventKeyboard=G_;var H_=function(){function e(e,t,i){this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=e||0,this._listenerID=t||""}e.create=function(e){ae(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===u.EventListener.TOUCH_ONE_BY_ONE?i=new V_:t===u.EventListener.TOUCH_ALL_AT_ONCE?i=new W_:t===u.EventListener.MOUSE?i=new z_:t===u.EventListener.KEYBOARD?i=new X_:t===u.EventListener.ACCELERATION&&(i=new Y_(e.callback),delete e.callback),i)for(var n=0,r=Object.keys(e);n<r.length;n++){var s=r[n];i[s]=e[s]}return i},s(e,[{key:"onEvent",get:function(){return this._onEvent}}]);var t=e.prototype;return t._setPaused=function(e){this._paused=e},t._isPaused=function(){return this._paused},t._setRegistered=function(e){this._registered=e},t._isRegistered=function(){return this._registered},t._getType=function(){return this._type},t._getListenerID=function(){return this._listenerID},t._setFixedPriority=function(e){this._fixedPriority=e},t._getFixedPriority=function(){return this._fixedPriority},t._setSceneGraphPriority=function(e){this._target=e,this._node=e},t._getSceneGraphPriority=function(){return this._node},t.checkAvailable=function(){return null!==this._onEvent},t.clone=function(){return null},t.setEnabled=function(e){this._isEnabled=e},t.isEnabled=function(){return this._isEnabled},e}();H_.UNKNOWN=0,H_.TOUCH_ONE_BY_ONE=1,H_.TOUCH_ALL_AT_ONCE=2,H_.KEYBOARD=3,H_.MOUSE=4,H_.ACCELERATION=6,H_.CUSTOM=8,H_.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var k_=H_.ListenerID,z_=function(e){function t(){var t;return(t=e.call(this,H_.MOUSE,k_.MOUSE,null)||this).onMouseDown=null,t.onMouseUp=null,t.onMouseMove=null,t.onMouseScroll=null,t._onEvent=function(e){return t._callback(e)},t}a(t,e);var i=t.prototype;return i._callback=function(e){var t=u.Event.EventMouse;switch(e.eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}},i.clone=function(){var e=new t;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e},i.checkAvailable=function(){return!0},t}(H_),V_=function(e){function t(){var t;return(t=e.call(this,H_.TOUCH_ONE_BY_ONE,k_.TOUCH_ONE_BY_ONE,null)||this).swallowTouches=!1,t.onTouchBegan=null,t.onTouchMoved=null,t.onTouchEnded=null,t.onTouchCancelled=null,t._claimedTouches=[],t}a(t,e);var i=t.prototype;return i.setSwallowTouches=function(e){this.swallowTouches=e},i.isSwallowTouches=function(){return this.swallowTouches},i.clone=function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e},i.checkAvailable=function(){return!!this.onTouchBegan||(se(1801),!1)},t}(H_),W_=function(e){function t(){var t;return(t=e.call(this,H_.TOUCH_ALL_AT_ONCE,k_.TOUCH_ALL_AT_ONCE,null)||this).onTouchesBegan=null,t.onTouchesMoved=null,t.onTouchesEnded=null,t.onTouchesCancelled=null,t}a(t,e);var i=t.prototype;return i.clone=function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e},i.checkAvailable=function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(se(1802),!1)},t}(H_),Y_=function(e){function t(t){var i;return(i=e.call(this,H_.ACCELERATION,k_.ACCELERATION,null)||this)._onAccelerationEvent=null,i._onEvent=function(e){return i._callback(e)},i._onAccelerationEvent=t,i}a(t,e);var i=t.prototype;return i._callback=function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)},i.checkAvailable=function(){return ae(this._onAccelerationEvent,1803),!0},i.clone=function(){return new t(this._onAccelerationEvent)},t}(H_),X_=function(e){function t(){var t;return(t=e.call(this,H_.KEYBOARD,k_.KEYBOARD,null)||this).onKeyPressed=null,t.onKeyReleased=null,t._onEvent=function(e){return t._callback(e)},t}a(t,e);var i=t.prototype;return i._callback=function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)},i.clone=function(){var e=new t;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e},i.checkAvailable=function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(se(1800),!1)},t}(H_);u.EventListener=H_;var j_=H_.ListenerID,K_=function(){function e(){this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}var t=e.prototype;return t.size=function(){return this._fixedListeners.length+this._sceneGraphListeners.length},t.empty=function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length},t.push=function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)},t.clearSceneGraphListeners=function(){this._sceneGraphListeners.length=0},t.clearFixedListeners=function(){this._fixedListeners.length=0},t.clear=function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0},t.getFixedPriorityListeners=function(){return this._fixedListeners},t.getSceneGraphPriorityListeners=function(){return this._sceneGraphListeners},e}(),Z_=function(){function e(){this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}var t=e.prototype;return t.pauseTarget=function(e,t){if(void 0===t&&(t=!1),e instanceof u._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n)i[n]._setPaused(!0);if(!0===t){var r=e.children;if(r)for(var s=0;s<r.length;++s){var a=r[s];this.pauseTarget(a,!0)}}}else L(3506)},t.resumeTarget=function(e,t){if(void 0===t&&(t=!1),e instanceof u._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n)i[n]._setPaused(!1);if(this._setDirtyForNode(e),!0===t&&e.children.length>0){var r=e.children;if(r)for(var s=0;s<r.length;++s){var a=r[s];this.resumeTarget(a,!0)}}}else L(3506)},t.frameUpdateListeners=function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,s=n.length;r<s;r++)this._forceAddEventListener(n[r]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()},t.hasEventListener=function(e){return!!this._getListeners(e)},t.addListener=function(e,t){if(ae(e&&t,3503),u.js.isNumber(t)||t instanceof u._BaseNode){if(e instanceof u.EventListener){if(e._isRegistered())return void se(3505)}else ae(!u.js.isNumber(t),3504),e=u.EventListener.create(e);if(e.checkAvailable()){if(u.js.isNumber(t)){if(0===t)return void se(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!(i=t)||!i.getComponent("cc.UITransform"))return void se(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}var i;return e}}else L(3506)},t.addCustomListener=function(e,t){var i=H_.create({event:u.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i},t.removeListener=function(e){if(null!=e){var t=!1,i=this._listenersMap;for(var n in i){var r=i[n],s=r.getFixedPriorityListeners(),a=r.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(a,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(s,e))&&this._setDirty(e._getListenerID(),1),r.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[n]),t)break}if(!t)for(var o=this._toAddedListeners,h=o.length-1;h>=0;h--){var l=o[h];if(l===e){u.js.array.removeAt(o,h),l._setRegistered(!1);break}}}},t.removeListeners=function(e,t){if(void 0===t&&(t=!1),u.js.isNumber(e)||e instanceof u._BaseNode)if(void 0!==e._id){var i=this._nodeListenersMap[e._id];if(i){for(var n=u.js.array.copy(i),r=0;r<n.length;++r){var s=n[r];this.removeListener(s)}delete this._nodeListenersMap[e._id]}for(var a=this._toAddedListeners,o=0;o<a.length;){var h=a[o];h._getSceneGraphPriority()===e?(h._setSceneGraphPriority(null),h._setRegistered(!1),a.splice(o,1)):++o}if(!0===t)for(var l=e.getChildren(),_=0;_<l.length;++_){var c=l[_];this.removeListeners(c,!0)}}else e===u.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(j_.TOUCH_ONE_BY_ONE):e===u.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(j_.TOUCH_ALL_AT_ONCE):e===u.EventListener.MOUSE?this._removeListenersForListenerID(j_.MOUSE):e===u.EventListener.ACCELERATION?this._removeListenersForListenerID(j_.ACCELERATION):e===u.EventListener.KEYBOARD?this._removeListenersForListenerID(j_.KEYBOARD):se(3501);else L(3506)},t.removeCustomListeners=function(e){this._removeListenersForListenerID(e)},t.removeAllListeners=function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)},t.setPriority=function(e,t){if(null!=e){var i=this._listenersMap;for(var n in i){var r=i[n].getFixedPriorityListeners();if(r&&-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&se(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}},t.setEnabled=function(e){this._isEnabled=e},t.isEnabled=function(){return this._isEnabled},t.dispatchEvent=function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(u.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=re,i=e.type;return i===t.ACCELERATION?j_.ACCELERATION:i===t.KEYBOARD?j_.KEYBOARD:i.startsWith(t.MOUSE)?j_.MOUSE:(i.startsWith(t.TOUCH)&&se(2e3),"")}(e);this._sortEventListeners(t);var i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}else F(3511)},t._onListenerCallback=function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()},t.dispatchCustomEvent=function(e,t){var i=new u.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)},t._setDirtyForNode=function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var i=0,n=t.length;i<n;i++){var r=t[i]._getListenerID();null==this._dirtyListeners[r]&&(this._dirtyListeners[r]=!0)}if(e.children.length>0)for(var s=e.children,a=0,o=s?s.length:0;a<o;a++)this._setDirtyForNode(s[a])},t._addListener=function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)},t._forceAddEventListener=function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new K_,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var n=e._getSceneGraphPriority();null===n&&se(3507),this._associateNodeAndEventListener(n,e),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(t,1)},t._getListeners=function(e){return this._listenersMap[e]},t._updateDirtyFlagForSceneGraph=function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2);this._dirtyListeners.length=0},t._removeAllListenersInVector=function(e){if(e)for(var t,i=e.length-1;i>=0;i--)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&u.js.array.removeAt(e,i)},t._removeListenersForListenerID=function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,s=r.length-1;s>=0;s--){var a=r[s];a&&a._getListenerID()===e&&u.js.array.removeAt(r,s)}},t._sortEventListeners=function(e){var t=0,i=this._priorityDirtyFlagMap;i[e]&&(t=i[e]),0!==t&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&u.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))},t._sortListenersOfSceneGraphPriority=function(e){var t=this._getListeners(e);if(t){var i=t.getSceneGraphPriorityListeners();i&&0!==i.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}},t._sortEventListenersOfSceneGraphPriorityDes=function(e,t){var i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(e&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return 1;var r=i,s=n,a=!1,o=i._uiProps.uiTransformComp,h=n._uiProps.uiTransformComp;if(o.visibility!==h.visibility)return h.visibility-o.visibility;for(;r.parent._id!==s.parent._id;)r=null===r.parent.parent?(a=!0)&&n:r.parent,s=null===s.parent.parent?(a=!0)&&i:s.parent;if(r._id===s._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}var u=r.getSiblingIndex(),l=s.getSiblingIndex();return a?u-l:l-u},t._sortListenersOfFixedPriority=function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var n=0,r=i.length;n<r&&!(i[n]._getFixedPriority()>=0);)++n;t.gt0Index=n}}},t._sortListenersOfFixedPriorityAsc=function(e,t){return e._getFixedPriority()-t._getFixedPriority()},t._onUpdateListeners=function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),n=this._toRemovedListeners;if(i)for(var r=i.length-1;r>=0;r--){var s=i[r];if(!s._isRegistered()){u.js.array.removeAt(i,r);var a=n.indexOf(s);-1!==a&&n.splice(a,1)}}if(t)for(var o=t.length-1;o>=0;o--){var h=t[o];if(!h._isRegistered()){u.js.array.removeAt(t,o);var l=n.indexOf(h);-1!==l&&n.splice(l,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()},t._updateTouchListeners=function(){var e=this._inDispatch;if(ae(e>0,3508),!(e>1)){var t;(t=this._listenersMap[j_.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(t),(t=this._listenersMap[j_.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(t),ae(1===e,3509);var i=this._toAddedListeners;if(0!==i.length){for(var n=0,r=i.length;n<r;n++)this._forceAddEventListener(i[n]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},t._cleanToRemovedListeners=function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var i=e[t],n=this._listenersMap[i._getListenerID()];if(n){var r=n.getFixedPriorityListeners(),s=n.getSceneGraphPriorityListeners();if(s){var a=s.indexOf(i);-1!==a&&s.splice(a,1)}if(r){var o=r.indexOf(i);-1!==o&&r.splice(o,1)}}}e.length=0},t._onTouchEventCallback=function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();var r=!1,s=-1,a=i.getEventCode();if(a===D_.BEGAN){if(!D.ENABLE_MULTI_TOUCH&&Q_._currentTouch){var o=Q_._currentTouchListener._node;if(!o||o.activeInHierarchy)return!1}e.onTouchBegan&&(r=e.onTouchBegan(n,i))&&e._isRegistered()&&(e._claimedTouches.push(n),!D.ENABLE_MULTI_TOUCH&&Q_._currentTouch||(Q_._currentTouch=n),Q_._currentTouchListener=e)}else if(e._claimedTouches.length>0&&-1!==(s=e._claimedTouches.indexOf(n))){if(r=!0,!D.ENABLE_MULTI_TOUCH&&Q_._currentTouch&&Q_._currentTouch!==n)return!1;a===D_.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):a===D_.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(s,1),(D.ENABLE_MULTI_TOUCH||Q_._currentTouch===n)&&(Q_._currentTouch=null),Q_._currentTouchListener=null):a===D_.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(s,1),(D.ENABLE_MULTI_TOUCH||Q_._currentTouch===n)&&(Q_._currentTouch=null),Q_._currentTouchListener=null)}return i.isStopped()?(Q_._updateTouchListeners(i),!0):!!(r&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)},t._dispatchTouchEvent=function(e){this._sortEventListeners(j_.TOUCH_ONE_BY_ONE),this._sortEventListeners(j_.TOUCH_ALL_AT_ONCE);var t=this._getListeners(j_.TOUCH_ONE_BY_ONE),i=this._getListeners(j_.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var n=e.getTouches(),r=u.js.array.copy(n),s={event:e,needsMutableSet:t&&i,touches:r,selTouch:null};if(t)for(var a=0;a<n.length;++a){var o=n[a];e.touch=o,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,s)}i&&r.length>0&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}},t._onTouchesEventCallback=function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=t.touches,r=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),r===D_.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):r===D_.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):r===D_.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):r===D_.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(Q_._updateTouchListeners(i),!0)},t._associateNodeAndEventListener=function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)},t._dissociateNodeAndEventListener=function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(u.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])},t._dispatchEventToListeners=function(e,t,i){var n=!1,r=e.getFixedPriorityListeners(),s=e.getSceneGraphPriorityListeners(),a=0;if(r&&0!==r.length)for(;a<e.gt0Index;++a){var o=r[a];if(o.isEnabled()&&!o._isPaused()&&o._isRegistered()&&t(o,i)){n=!0;break}}if(s&&!n)for(var h=0;h<s.length;++h){var u=s[h];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,i)){n=!0;break}}if(r&&!n)for(;a<r.length;++a){var l=r[a];if(l.isEnabled()&&!l._isPaused()&&l._isRegistered()&&t(l,i)){n=!0;break}}},t._setDirty=function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]},t._sortNumberAsc=function(e,t){return e-t},t._removeListenerInCallback=function(e,t){if(null==e)return!1;for(var i=e.length-1;i>=0;i--){var n=e[i];if(n._onCustomEvent===t||n.onEvent===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?u.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1},t._removeListenerInVector=function(e,t){if(null==e)return!1;for(var i=e.length-1;i>=0;i--){var n=e[i];if(n===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?u.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1},e}(),Q_=e("bR",new Z_);u.eventManager=Q_,oe.Flags.Destroying;var q_=new Array(16),J_=null,$_=new X,ec=[o_.TOUCH_START.toString(),o_.TOUCH_MOVE.toString(),o_.TOUCH_END.toString(),o_.TOUCH_CANCEL.toString()],tc=[o_.MOUSE_DOWN.toString(),o_.MOUSE_ENTER.toString(),o_.MOUSE_MOVE.toString(),o_.MOUSE_LEAVE.toString(),o_.MOUSE_UP.toString(),o_.MOUSE_WHEEL.toString()];function ic(e,t){var i=this.owner;return!(!i||!i._uiProps.uiTransformComp||(e.getUILocation($_),!i._uiProps.uiTransformComp.isHit($_,this)||(t.type=o_.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),0)))}function nc(e,t){var i=this.owner;if(!i||!i._uiProps.uiTransformComp)return!1;t.type=o_.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function rc(e,t){var i=this.owner;i&&i._uiProps.uiTransformComp&&(e.getUILocation($_),i._uiProps.uiTransformComp.isHit($_,this)?t.type=o_.TOUCH_END.toString():t.type=o_.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function sc(e,t){var i=this.owner;i&&i._uiProps.uiTransformComp&&(t.type=o_.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function ac(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&($_=e.getUILocation(),t._uiProps.uiTransformComp.isHit($_,this)&&(e.type=o_.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function oc(e){var t=this.owner;if(t&&t._uiProps.uiTransformComp){if($_=e.getUILocation(),t._uiProps.uiTransformComp.isHit($_,this))this._previousIn||(J_&&J_.eventProcessor.mouseListener&&(e.type=o_.MOUSE_LEAVE,J_.dispatchEvent(e),J_.eventProcessor.mouseListener&&(J_.eventProcessor.mouseListener._previousIn=!1)),J_=t,e.type=o_.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=o_.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=o_.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,J_=null}e.propagationStopped=!0}}function hc(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&($_=e.getUILocation(),t._uiProps.uiTransformComp.isHit($_,this)&&(e.type=o_.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function uc(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&($_=e.getUILocation(),t._uiProps.uiTransformComp.isHit($_,this)&&(e.type=o_.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function lc(e){var t=u.Mask;if(t)for(var i=0,n=e;n&&u.Node.isNode(n);n=n.parent,++i)if(n.getComponent(t))return{index:i,node:n};return null}function _c(e,t){if(!e._persistNode){if(e.eventProcessor.bubblingTargets)for(var i=0;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(var n=0;n<t.length;++n)if(e.eventProcessor.capturingTargets.hasEventListener(t[n]))return!0;return!1}return!0}var cc,dc,fc,pc,mc,gc,vc,Ec,Tc,Ac=function(){function e(e){this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}s(e,[{key:"node",get:function(){return this._node}}]);var t=e.prototype;return t.reattach=function(){if(this.touchListener){var e=this.touchListener.mask=lc(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=lc(this._node))},t.destroy=function(){J_===this._node&&(J_=null),(this.touchListener||this.mouseListener)&&(Q_.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()},t.on=function(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new he),this.bubblingTargets.on(e,t,i))},t.once=function(e,t,i,n){var r,s=this;(r=this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new he:this.bubblingTargets=this.bubblingTargets||new he).on(e,t,i,!0),r.on(e,(function(){s.off(e,t,i)}),void 0,!0)},t.off=function(e,t,i,n){var r=-1!==ec.indexOf(e),s=!r&&-1!==tc.indexOf(e);r||s?(this._offDispatch(e,t,i,n),r?this.touchListener&&!_c(this._node,ec)&&(Q_.removeListener(this.touchListener),this.touchListener=null):s&&this.mouseListener&&!_c(this._node,tc)&&(Q_.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)},t.emit=function(e,t,i,n,r,s){this.bubblingTargets&&this.bubblingTargets.emit(e,t,i,n,r,s)},t.dispatchEvent=function(e){!function(e,t){var i,n=0;for(t.target=e,q_.length=0,e.eventProcessor.getCapturingTargets(t.type,q_),t.eventPhase=1,n=q_.length-1;n>=0;--n)if((i=q_[n]).eventProcessor.capturingTargets&&(t.currentTarget=i,i.eventProcessor.capturingTargets.emit(t.type,t,q_),t.propagationStopped))return void(q_.length=0);if(q_.length=0,t.eventPhase=2,t.currentTarget=e,e.eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,q_),t.eventPhase=3,n=0;n<q_.length;++n)if((i=q_[n]).eventProcessor.bubblingTargets&&(t.currentTarget=i,i.eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(q_.length=0);q_.length=0}(this._node,e),q_.length=0},t.hasEventListener=function(e,t,i){var n=!1;return this.bubblingTargets&&(n=this.bubblingTargets.hasEventListener(e,t,i)),!n&&this.capturingTargets&&(n=this.capturingTargets.hasEventListener(e,t,i)),n},t.targetOff=function(e){this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e),this.touchListener&&!_c(this.node,ec)&&(Q_.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!_c(this.node,tc)&&(Q_.removeListener(this.mouseListener),this.mouseListener=null)},t.getCapturingTargets=function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent},t.getBubblingTargets=function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent},t._checknSetupSysEvent=function(e){var t=this,i=!1,n=!1;return-1!==ec.indexOf(e)?(this.touchListener||(this.touchListener=u.EventListener.create({event:u.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:lc(this._node),onTouchBegan:ic,onTouchMoved:nc,onTouchEnded:rc,onTouchCancelled:sc}),Q_.addListener(this.touchListener,this._node),i=!0),n=!0):-1!==tc.indexOf(e)&&(this.mouseListener||(this.mouseListener=u.EventListener.create({event:u.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:lc(this._node),onMouseDown:ac,onMouseMove:oc,onMouseUp:hc,onMouseScroll:uc}),Q_.addListener(this.mouseListener,this._node),i=!0),n=!0),i&&!this._node.activeInHierarchy&&u.director.getScheduler().schedule((function(){t._node.activeInHierarchy||Q_.pauseTarget(t._node)}),this._node,0,0,0,!1),n},t._onDispatch=function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=null;return(r=n?this.capturingTargets=this.capturingTargets||new he:this.bubblingTargets=this.bubblingTargets||new he).hasEventListener(e,t,i)||r.on(e,t,i),t}F(6800)},t._offDispatch=function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=n?this.capturingTargets:this.bubblingTargets;r&&r.off(e,t,i)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)},e}();u.NodeEventProcessor=Ac;var Sc=oe.Flags.Destroying,yc=oe.Flags.DontDestroy,Rc=oe.Flags.Deactivating,Ic=(oe.Flags.Activating,new x("Node"));function Oc(e){return e?"string"==typeof e?_e(e):e:(F(3804),null)}var Nc,Cc,bc,wc,Lc,Mc,Pc,Bc,Fc,xc,Dc,Uc,Gc,Hc=e("dP",I("cc.BaseNode")((Tc=Ec=function(e){function t(t){var i;return i=e.call(this,t)||this,b(i,"_parent",fc,B(i)),b(i,"_children",pc,B(i)),b(i,"_active",mc,B(i)),b(i,"_components",gc,B(i)),b(i,"_prefab",vc,B(i)),i._scene=null,i._activeInHierarchy=!1,i._id=Ic.getNewId(),i._name=void 0,i._eventProcessor=new Ac(B(i)),i._eventMask=0,i._siblingIndex=0,i._registerIfAttached=void 0,i._name=void 0!==t?t:"New Node",i}a(t,e),t._setScene=function(e){e instanceof u.Scene?e._scene=e:null==e._parent?me("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene},t._findComponent=function(e,t){var i=t,n=e._components;if(i._sealed)for(var r=0;r<n.length;++r){var s=n[r];if(s.constructor===t)return s}else for(var a=0;a<n.length;++a){var o=n[a];if(o instanceof t)return o}return null},t._findComponents=function(e,t,i){var n=t,r=e._components;if(n._sealed)for(var s=0;s<r.length;++s){var a=r[s];a.constructor===t&&i.push(a)}else for(var o=0;o<r.length;++o){var h=r[o];h instanceof t&&i.push(h)}},t._findChildComponent=function(e,i){for(var n=0;n<e.length;++n){var r=e[n],s=t._findComponent(r,i);if(s)return s;if(r._children.length>0&&(s=t._findChildComponent(r._children,i)))return s}return null},t._findChildComponents=function(e,i,n){for(var r=0;r<e.length;++r){var s=e[r];t._findComponents(s,i,n),s._children.length>0&&t._findChildComponents(s._children,i,n)}},s(t,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&yc)>0},set:function(e){e?this._objFlags|=yc:this._objFlags&=~yc}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&u.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]);var i=t.prototype;return i.attr=function(e){ue(this,e)},i.getParent=function(){return this._parent},i.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var i=this._parent,n=e;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,t),this.emit&&this.emit(o_.PARENT_CHANGED,i),i&&!(i._objFlags&Sc)){var r=i._children.indexOf(this);i._children.splice(r,1),i._updateSiblingIndex(),i.emit&&i.emit(o_.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(o_.CHILD_ADDED,this)),this._onHierarchyChanged(i)}},i.getChildByUuid=function(e){if(!e)return le("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null},i.getChildByName=function(e){if(!e)return le("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null},i.getChildByPath=function(e){for(var t=e.split("/"),i=this,n=function(e){var n=t[e];if(0===n.length)return"continue";var r=i.children.find((function(e){return e.name===n}));if(!r)return{v:null};i=r},r=0;r<t.length;++r){var s=n(r);switch(s){case"continue":continue;default:if("object"==typeof s)return s.v}}return i},i.addChild=function(e){e.setParent(this)},i.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},i.getSiblingIndex=function(){return this._siblingIndex},i.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&Rc)F(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},i.walk=function(e,i){var n=1,r=null,s=null,a=0,o=t._stacks[t._stackId];o||(o=[],t._stacks.push(o)),t._stackId++,o.length=0,o[0]=this;for(var h=null,u=!1;n;)if(s=o[--n])if(!u&&e?e(s):u&&i&&i(s),o[n]=null,u){if(h===this._parent)break;if(u=!1,r)if(r[++a])o[n]=r[a],n++;else if(h&&(o[n]=h,n++,u=!0,h._parent?(a=(r=h._parent._children).indexOf(h),h=h._parent):(h=null,r=null),a<0))break}else s._children.length>0?(h=s,r=s._children,a=0,o[n]=r[a],n++):(o[n]=s,n++,u=!0);o.length=0,t._stackId--},i.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},i.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},i.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0},i.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},i.getComponent=function(e){var i=Oc(e);return i?t._findComponent(this,i):null},i.getComponents=function(e){var i=Oc(e),n=[];return i&&t._findComponents(this,i,n),n},i.getComponentInChildren=function(e){var i=Oc(e);return i?t._findChildComponent(this._children,i):null},i.getComponentsInChildren=function(e){var i=Oc(e),n=[];return i&&(t._findComponents(this,i,n),t._findChildComponents(this._children,i,n)),n},i.addComponent=function(e){var t;if("string"==typeof e){if(!(t=_e(e)))throw u._RF.peek()&&F(3808,e),TypeError(ce(3807,e))}else{if(!e)throw TypeError(ce(3804));t=e}if("function"!=typeof t)throw TypeError(ce(3809));if(!de(t,u.Component))throw TypeError(ce(3810));var i=t._requireComponent;i&&!this.getComponent(i)&&this.addComponent(i);var n=new t;return n.node=this,this._components.push(n),this._activeInHierarchy&&u.director._nodeActivator.activateComp(n),n},i.removeComponent=function(e){if(e){var t=null;(t=e instanceof ne?e:this.getComponent(e))&&t.destroy()}else F(3813)},i.on=function(e,t,i,n){switch(void 0===n&&(n=!1),e){case o_.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)},i.off=function(e,t,i,n){if(void 0===n&&(n=!1),this._eventProcessor.off(e,t,i,n),!this._eventProcessor.hasEventListener(e))switch(e){case o_.TRANSFORM_CHANGED:this._eventMask&=-2}},i.once=function(e,t,i,n){this._eventProcessor.once(e,t,i,n)},i.emit=function(e,t,i,n,r,s){this._eventProcessor.emit(e,t,i,n,r,s)},i.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},i.hasEventListener=function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)},i.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(o_.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},i.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},i.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},i._removeComponent=function(e){if(e){if(!(this._objFlags&Sc)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&F(3815)}}else F(3814)},i._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e},i._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk((function(e){t._setScene(e)})))},i._onPostActivated=function(){},i._onBatchRestored=function(){},i._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},i._onPreDestroy=function(){this._onPreDestroyBase()},i._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},i._instantiate=function(e){e||(e=u.instantiate._clone(this,this));var t=this._prefab;return t&&this===t.root&&t.sync,e._parent=null,e._onBatchRestored(),e},i._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof u.Scene||u.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&u.director._nodeActivator.activateNode(this,t)},i._onPreDestroyBase=function(){this._objFlags|=Sc;var e=this._parent,t=!!e&&0!=(e._objFlags&Sc);if(!t&&fe&&this._registerIfAttached(!1),this._persistNode&&u.game.removePersistRootNode(this),!t&&e){this.emit(o_.PARENT_CHANGED,this);var i=e._children.indexOf(this);e._children.splice(i,1),this._siblingIndex=0,e.emit&&e.emit(o_.CHILD_REMOVED,this)}this.emit(o_.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var n=this._children,r=0;r<n.length;++r)n[r]._destroyImmediate();for(var s=this._components,a=0;a<s.length;++a)s[a]._destroyImmediate();return t},t}(oe),Ec.idGenerator=Ic,Ec._stacks=[[]],Ec._stackId=0,O((dc=Tc).prototype,"_persistNode",[pe],Object.getOwnPropertyDescriptor(dc.prototype,"_persistNode"),dc.prototype),O(dc.prototype,"name",[C],Object.getOwnPropertyDescriptor(dc.prototype,"name"),dc.prototype),O(dc.prototype,"children",[C],Object.getOwnPropertyDescriptor(dc.prototype,"children"),dc.prototype),O(dc.prototype,"active",[C],Object.getOwnPropertyDescriptor(dc.prototype,"active"),dc.prototype),O(dc.prototype,"activeInHierarchy",[C],Object.getOwnPropertyDescriptor(dc.prototype,"activeInHierarchy"),dc.prototype),O(dc.prototype,"parent",[C],Object.getOwnPropertyDescriptor(dc.prototype,"parent"),dc.prototype),fc=O(dc.prototype,"_parent",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pc=O(dc.prototype,"_children",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mc=O(dc.prototype,"_active",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gc=O(dc.prototype,"_components",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vc=O(dc.prototype,"_prefab",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cc=dc))||cc);u._BaseNode=Hc,function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(Nc||(Nc={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(Cc||(Cc=e("d$",{}))),u.internal.TransformBit=Cc;var kc,zc,Vc,Wc,Yc,Xc,jc,Kc,Zc=new r,Qc=new p,qc=new p,Jc=new Array(10),$c=new p,ed=new c,td=new c,id=new _,nd=new Map,rd=e("dQ",(bc=I("cc.Node"),wc=U(r),bc((Gc=Uc=function(e){function t(t){var i;return(i=e.call(this,t)||this)._uiProps=new B_(B(i)),i._static=!1,i._pos=new r,i._rot=new p,i._scale=new r(1,1,1),i._mat=new _,b(i,"_lpos",Pc,B(i)),b(i,"_lrot",Bc,B(i)),b(i,"_lscale",Fc,B(i)),b(i,"_layer",xc,B(i)),b(i,"_euler",Dc,B(i)),i._dirtyFlags=Cc.NONE,i._eulerDirty=!1,i._poolHandle=Ft,i._poolHandle=ci.alloc(),ci.set(i._poolHandle,oi.LAYER,i._layer),ci.setVec3(i._poolHandle,oi.WORLD_SCALE,i._scale),i}a(t,e),t.isNode=function(e){return e instanceof t&&(e.constructor===t||!(e instanceof u.Scene))};var i=t.prototype;return i.destroy=function(){return this._poolHandle&&(ci.free(this._poolHandle),this._poolHandle=Ft),e.prototype.destroy.call(this)},i.setParent=function(t,i){void 0===i&&(i=!1),i&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,i)},i._onSetParent=function(t,i){if(e.prototype._onSetParent.call(this,t,i),i){var n=this._parent;n?(n.updateWorldTransform(),_.multiply(id,_.invert(id,n._mat),this._mat),_.toRTS(id,this._lrot,this._lpos,this._lscale)):(r.copy(this._lpos,this._pos),p.copy(this._lrot,this._rot),r.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Cc.TRS)},i._onBatchCreated=function(){e.prototype._onBatchCreated.call(this),this.hasChangedFlags=Cc.TRS,this._dirtyFlags=Cc.TRS;for(var t=this._children.length,i=0;i<t;++i)this._children[i]._onBatchCreated()},i._onBatchRestored=function(){this._onBatchCreated()},i._onBeforeSerialize=function(){this.eulerAngles},i._onPostActivated=function(e){e?(Q_.resumeTarget(this),this.eventProcessor.reattach(),this.invalidateChildren(Cc.TRS)):Q_.pauseTarget(this)},i.translate=function(e,t){var i=t||Nc.LOCAL;if(i===Nc.LOCAL)r.transformQuat(Zc,e,this._lrot),this._lpos.x+=Zc.x,this._lpos.y+=Zc.y,this._lpos.z+=Zc.z;else if(i===Nc.WORLD)if(this._parent){p.invert(Qc,this._parent.worldRotation),r.transformQuat(Zc,e,Qc);var n=this.worldScale;this._lpos.x+=Zc.x/n.x,this._lpos.y+=Zc.y/n.y,this._lpos.z+=Zc.z/n.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(Cc.POSITION),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.POSITION)},i.rotate=function(e,t){var i=t||Nc.LOCAL;if(p.normalize(Qc,e),i===Nc.LOCAL)p.multiply(this._lrot,this._lrot,Qc);else if(i===Nc.WORLD){var n=this.worldRotation;p.multiply(qc,Qc,n),p.invert(Qc,n),p.multiply(qc,Qc,qc),p.multiply(this._lrot,this._lrot,qc)}this._eulerDirty=!0,this.invalidateChildren(Cc.ROTATION),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.ROTATION)},i.lookAt=function(e,t){this.getWorldPosition(Zc),r.subtract(Zc,Zc,e),r.normalize(Zc,Zc),p.fromViewUp(Qc,Zc,t),this.setWorldRotation(Qc)},i.invalidateChildren=function(e){var t=this.hasChangedFlags;if((this._dirtyFlags&t&e)!==e){this._dirtyFlags|=e,this.hasChangedFlags=t|e;for(var i=e|Cc.POSITION,n=this._children.length,r=0;r<n;++r){var s=this._children[r];s.isValid&&s.invalidateChildren(i)}}},i.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,i=0;t&&t._dirtyFlags;)Jc[i++]=t,t=t._parent;for(var n=0;i;)n|=(e=Jc[--i])._dirtyFlags,t?(n&Cc.POSITION&&(r.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z,ci.setVec3(e._poolHandle,oi.WORLD_POSITION,e._pos)),n&Cc.RS&&(_.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),_.multiply(e._mat,t._mat,e._mat),n&Cc.ROTATION&&(p.multiply(e._rot,t._rot,e._lrot),ci.setVec4(e._poolHandle,oi.WORLD_ROTATION,e._rot)),c.fromQuat(ed,p.conjugate($c,e._rot)),c.multiplyMat4(ed,ed,e._mat),e._scale.x=ed.m00,e._scale.y=ed.m04,e._scale.z=ed.m08,ci.setVec3(e._poolHandle,oi.WORLD_SCALE,e._scale))):(n&Cc.POSITION&&(r.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z,ci.setVec3(e._poolHandle,oi.WORLD_POSITION,e._pos)),n&Cc.RS&&(n&Cc.ROTATION&&(p.copy(e._rot,e._lrot),ci.setVec4(e._poolHandle,oi.WORLD_ROTATION,e._rot)),n&Cc.SCALE&&(r.copy(e._scale,e._lscale),ci.setVec3(e._poolHandle,oi.WORLD_SCALE,e._scale),_.fromRTS(e._mat,e._rot,e._pos,e._scale)))),n!==Cc.NONE&&ci.setMat4(e._poolHandle,oi.WORLD_MATRIX,e._mat),e._dirtyFlags=Cc.NONE,t=e}},i.setPosition=function(e,t,i){void 0===t&&void 0===i?r.copy(this._lpos,e):void 0===i?r.set(this._lpos,e,t,this._lpos.z):r.set(this._lpos,e,t,i),this.invalidateChildren(Cc.POSITION),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.POSITION)},i.getPosition=function(e){return e?r.set(e,this._lpos.x,this._lpos.y,this._lpos.z):r.copy(new r,this._lpos)},i.setRotation=function(e,t,i,n){void 0===t||void 0===i||void 0===n?p.copy(this._lrot,e):p.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(Cc.ROTATION),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.ROTATION)},i.setRotationFromEuler=function(e,t,i){var n=void 0===i?this._euler.z:i;r.set(this._euler,e,t,n),p.fromEuler(this._lrot,e,t,n),this._eulerDirty=!1,this.invalidateChildren(Cc.ROTATION),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.ROTATION)},i.getRotation=function(e){return e?p.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):p.copy(new p,this._lrot)},i.setScale=function(e,t,i){void 0===t&&void 0===i?r.copy(this._lscale,e):void 0===i?r.set(this._lscale,e,t,this._lscale.z):r.set(this._lscale,e,t,i),this.invalidateChildren(Cc.SCALE),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.SCALE)},i.getScale=function(e){return e?r.set(e,this._lscale.x,this._lscale.y,this._lscale.z):r.copy(new r,this._lscale)},i.inverseTransformPoint=function(e,t){r.copy(e,t);for(var i=this,n=0;i._parent;)Jc[n++]=i,i=i._parent;for(;n>=0;)r.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=Jc[--n];return e},i.setWorldPosition=function(e,t,i){void 0===t||void 0===i?r.copy(this._pos,e):r.set(this._pos,e,t,i),ci.setVec3(this._poolHandle,oi.WORLD_POSITION,this._pos);var n=this._parent,s=this._lpos;n?(n.updateWorldTransform(),r.transformMat4(s,this._pos,_.invert(id,n._mat))):r.copy(s,this._pos),this.invalidateChildren(Cc.POSITION),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.POSITION)},i.getWorldPosition=function(e){return this.updateWorldTransform(),e?r.copy(e,this._pos):r.copy(new r,this._pos)},i.setWorldRotation=function(e,t,i,n){void 0===t||void 0===i||void 0===n?p.copy(this._rot,e):p.set(this._rot,e,t,i,n),ci.setVec4(this._poolHandle,oi.WORLD_ROTATION,this._rot),this._parent?(this._parent.updateWorldTransform(),p.multiply(this._lrot,p.conjugate(this._lrot,this._parent._rot),this._rot)):p.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Cc.ROTATION),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.ROTATION)},i.setWorldRotationFromEuler=function(e,t,i){p.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),p.multiply(this._lrot,p.conjugate(this._lrot,this._parent._rot),this._rot)):p.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Cc.ROTATION),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.ROTATION)},i.getWorldRotation=function(e){return this.updateWorldTransform(),e?p.copy(e,this._rot):p.copy(new p,this._rot)},i.setWorldScale=function(e,t,i){void 0===t||void 0===i?r.copy(this._scale,e):r.set(this._scale,e,t,i),ci.setVec3(this._poolHandle,oi.WORLD_SCALE,this._scale);var n=this._parent;n?(n.updateWorldTransform(),c.fromQuat(ed,p.conjugate($c,n._rot)),c.multiplyMat4(ed,ed,n._mat),td.m00=this._scale.x,td.m04=this._scale.y,td.m08=this._scale.z,c.multiply(ed,td,c.invert(ed,ed)),this._lscale.x=r.set(Zc,ed.m00,ed.m01,ed.m02).length(),this._lscale.y=r.set(Zc,ed.m03,ed.m04,ed.m05).length(),this._lscale.z=r.set(Zc,ed.m06,ed.m07,ed.m08).length()):r.copy(this._lscale,this._scale),this.invalidateChildren(Cc.SCALE),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.SCALE)},i.getWorldScale=function(e){return this.updateWorldTransform(),e?r.copy(e,this._scale):r.copy(new r,this._scale)},i.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new _;return _.copy(t,this._mat)},i.getWorldRS=function(e){this.updateWorldTransform();var t=e||new _;return _.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},i.getWorldRT=function(e){this.updateWorldTransform();var t=e||new _;return _.fromRT(t,this._rot,this._pos)},i.setRTS=function(e,t,i){var n=0;e&&(n|=Cc.ROTATION,void 0!==e.w?(p.copy(this._lrot,e),this._eulerDirty=!0):(r.copy(this._euler,e),p.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(r.copy(this._lpos,t),n|=Cc.POSITION),i&&(r.copy(this._lscale,i),n|=Cc.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,n))},i.pauseSystemEvents=function(e){Q_.pauseTarget(this,e)},i.resumeSystemEvents=function(e){Q_.resumeTarget(this,e)},s(t,[{key:"handle",get:function(){return this._poolHandle}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(p.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"angle",get:function(){return this._euler.z},set:function(e){r.set(this._euler,0,0,e),p.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(Cc.ROTATION),1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){_.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Cc.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(o_.TRANSFORM_CHANGED,Cc.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return r.transformQuat(new r,r.FORWARD,this.worldRotation)},set:function(e){var t=e.length();r.multiplyScalar(Zc,e,-1/t),p.fromViewUp(Qc,Zc),this.setWorldRotation(Qc)}},{key:"layer",set:function(e){this._layer=e,ci.set(this._poolHandle,oi.LAYER,this._layer),this.emit(o_.LAYER_CHANGED,this._layer)},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return nd.get(this)||0},set:function(e){nd.set(this,e),ci.set(this._poolHandle,oi.FLAGS_CHANGED,e)}}]),t}(Hc),Uc.bookOfChange=nd,Uc.EventType=o_,Uc.NodeSpace=Nc,Uc.TransformDirtyBit=Cc,Uc.TransformBit=Cc,Pc=O((Mc=Gc).prototype,"_lpos",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),Bc=O(Mc.prototype,"_lrot",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),Fc=O(Mc.prototype,"_lscale",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r(1,1,1)}}),xc=O(Mc.prototype,"_layer",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lh.Enum.DEFAULT}}),Dc=O(Mc.prototype,"_euler",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),O(Mc.prototype,"eulerAngles",[wc],Object.getOwnPropertyDescriptor(Mc.prototype,"eulerAngles"),Mc.prototype),O(Mc.prototype,"angle",[C],Object.getOwnPropertyDescriptor(Mc.prototype,"angle"),Mc.prototype),O(Mc.prototype,"layer",[C],Object.getOwnPropertyDescriptor(Mc.prototype,"layer"),Mc.prototype),Lc=Mc))||Lc));function sd(e){return"string"==typeof e||"number"==typeof e}function ad(e,t){return e instanceof t}u.Node=rd;var od=e("bl",I("cc.animation.HierarchyPath")((Wc=function(){function e(e){b(this,"path",Vc,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof rd?e.getChildByPath(this.path)||(z('Node "'+e.name+'" has no path "'+this.path+'"'),null):(z("Target of hierarchy path should be of type Node."),null)},e}(),Vc=O((zc=Wc).prototype,"path",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kc=zc))||kc);e("bm",I("cc.animation.ComponentPath")((Kc=function(){function e(e){b(this,"component",jc,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof rd?e.getComponent(this.component)||(z('Node "'+e.name+'" has no component "'+this.component+'"'),null):(z("Target of component path should be of type Node."),null)},e}(),jc=O((Xc=Kc).prototype,"component",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Yc=Xc))||Yc);var hd=e("dX",function(){function e(){}return e.getOrExtract=function(t){var i=e.pool.get(t);return i&&i.info.sample===t.sample||(i&&u.director.root.dataPoolManager.releaseAnimationClip(t),i=function(e){var t={};e.curves.forEach((function(e){if(!e.valueAdapter&&ad(e.modifiers[0],od)&&sd(e.modifiers[1])){var i=e.modifiers[0].path,n=t[i];n||(n=t[i]={}),n[e.modifiers[1]]={values:e.data.values,keys:e.data.keys}}}));for(var i=Math.ceil(e.sample*e.duration)+1,n=function(){var n=s[r],a=t[n];if(!a)return"continue";Object.defineProperty(a,"worldMatrix",{get:function(){if(!a._worldMatrix){var r=a.position,s=a.rotation,o=a.scale;ud(e,r,i),ud(e,s,i),ud(e,o,i),function(e,t,i){var n=i.position.values,r=i.rotation.values,s=i.scale.values,a=n.map((function(){return new _})),o=t.lastIndexOf("/"),h=null;if(o>0){var u=e[t.substring(0,o)];if(!u)return void console.warn("no data for parent bone?");h=u.worldMatrix.values}for(var l=0;l<n.length;l++){var c=n[l],d=r[l],f=s[l],p=a[l];_.fromRTS(p,d,c,f),h&&_.multiply(p,h[l],p)}Object.keys(i).forEach((function(e){return delete i[e]})),i._worldMatrix={keys:0,interpolate:!1,values:a}}(t,n,a)}return a._worldMatrix}})},r=0,s=Object.keys(t);r<s.length;r++)n();return{info:{frames:i,sample:e.sample},data:t}}(t),e.pool.set(t,i)),i},e.destroy=function(t){e.pool.delete(t)},e}());function ud(e,t,i){var n=e.keys[t.keys],r=[];if(n&&1!==n.length)for(var s=t.values[0]instanceof p,a=0,o=0;a<i;a++){for(var h=a/e.sample;n[o]<=h;)o++;o>n.length-1?h=n[o=n.length-1]:0===o&&(o=1);var u=t.values[o-1].clone(),l=n[o]-n[o-1],_=l?ge((h-n[o-1])/l):1;s?u.slerp(t.values[o],_):u.lerp(t.values[o],_),r[a]=u}else for(var c=0;c<i;c++)r[c]=t.values[0].clone();t.values=r}hd.pool=new Map;var ld=new _;function _d(e,t,i){for(_.identity(i);e!==t;)_.fromRTS(ld,e.rotation,e.position,e.scale),_.multiply(i,ld,i),e=e.parent;return i}var cd=e("u",(function(e,t,i){e[t+0]=i.m00,e[t+1]=i.m01,e[t+2]=i.m02,e[t+3]=i.m12,e[t+4]=i.m04,e[t+5]=i.m05,e[t+6]=i.m06,e[t+7]=i.m13,e[t+8]=i.m08,e[t+9]=i.m09,e[t+10]=i.m10,e[t+11]=i.m14})),dd=e("g",480);function fd(e){return e.hasFeature(zn.TEXTURE_FLOAT)?hn.RGBA32F:hn.RGBA8}function pd(e,t){var i=4/Math.sqrt(t);return 12*Math.ceil(Math.max(dd*i,e)/12)}new p,new p,new r,new p,new r;var md,gd,vd,Ed,Td,Ad,Sd,yd,Rd,Id,Od,Nd,Cd,bd,wd,Ld,Md,Pd,Bd,Fd,xd,Dd,Ud,Gd=e("j",Po([Sn.POINT,Sn.POINT,Sn.NONE,yn.CLAMP,yn.CLAMP,yn.CLAMP])),Hd=new r,kd=new r,zd=new r,Vd=new r,Wd=new _,Yd=new _,Xd=new Ia,jd=Number.MAX_SAFE_INTEGER,Kd=(e("J",function(){function e(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;var t=fd(this._device);this._formatSize=Xn[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new zl(e),this._pool.initialize({format:t,roundUpFn:pd}),this._customPool=new zl(e),this._customPool.initialize({format:t,roundUpFn:pd})}s(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]);var t=e.prototype;return t.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},t.registerCustomTextureLayouts=function(e){for(var t=0;t<e.length;t++)for(var i=e[t],n=this._customPool.createChunk(i.textureLength),r=0;r<i.contents.length;r++){var s=i.contents[r],a=s.skeleton;this._chunkIdxMap.set(a,n);for(var o=0;o<s.clips.length;o++){var h=s.clips[o];this._chunkIdxMap.set(a^h,n)}}},t.getDefaultPoseTexture=function(e,t,i){var n=0^e.hash,s=this._textureBuffers.get(n)||null;if(s&&s.bounds.has(t.hash))return s.refCount++,s;var a=e.joints,o=e.bindposes,h=null,u=!1,l=a.length;if(s)s.refCount++;else{var c=12*l,d=this._chunkIdxMap.get(n),f=void 0!==d?this._customPool.alloc(c*Float32Array.BYTES_PER_ELEMENT,d):this._pool.alloc(c*Float32Array.BYTES_PER_ELEMENT);if(!f)return s;s={pixelOffset:f.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:f},h=new Float32Array(c),u=!0}r.set(zd,jd,jd,jd),r.set(Vd,-jd,-jd,-jd);for(var p=t.getBoneSpaceBounds(e),m=0,g=0;m<l;m++,g+=12){var v=i.getChildByPath(a[m]),E=v?_d(v,i,Wd):e.inverseBindposes[m],T=p[m];T&&(Ia.transform(Xd,T,E),Xd.getBoundary(Hd,kd),r.min(zd,zd,Hd),r.max(Vd,Vd,kd)),u&&(v&&_.multiply(E,E,o[m]),cd(h,g,v?E:_.IDENTITY))}var A=[new Ia];return s.bounds.set(t.hash,A),Ia.fromPoints(A[0],zd,Vd),u&&(this._pool.update(s.handle,h.buffer),this._textureBuffers.set(n,s)),s},t.getSequencePoseTexture=function(e,t,i,n){var s=e.hash^t.hash,a=this._textureBuffers.get(s)||null;if(a&&a.bounds.has(i.hash))return a.refCount++,a;var o=e.joints,h=e.bindposes,u=hd.getOrExtract(t).info.frames,l=null,c=!1,d=o.length;if(a)a.refCount++;else{var f=12*d*u,p=this._chunkIdxMap.get(s),m=void 0!==p?this._customPool.alloc(f*Float32Array.BYTES_PER_ELEMENT,p):this._pool.alloc(f*Float32Array.BYTES_PER_ELEMENT);if(!m)return null;var g=this._createAnimInfos(e,t,n);a={pixelOffset:m.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:m,animInfos:g},l=new Float32Array(f),c=!0}var v=i.getBoneSpaceBounds(e),E=[];a.bounds.set(i.hash,E);for(var T=0;T<u;T++)E.push(new Ia(jd,jd,jd,-jd,-jd,-jd));for(var A=0,S=0;A<u;A++){for(var y=E[A],R=0;R<d;R++,S+=12){var I=a.animInfos[R],O=I.curveData,N=I.downstream,C=I.bindposeIdx,b=I.bindposeCorrection,w=void 0,L=!0;O&&N?w=_.multiply(Wd,O[A],N):O?w=O[A]:N?w=N:(w=e.inverseBindposes[C],L=!1);var M=v[R];if(M){var P=b?_.multiply(Yd,w,b):w;Ia.transform(Xd,M,P),Xd.getBoundary(Hd,kd),r.min(y.center,y.center,Hd),r.max(y.halfExtents,y.halfExtents,kd)}c&&(L&&_.multiply(Wd,w,h[C]),cd(l,S,L?Wd:_.IDENTITY))}Ia.fromPoints(y,y.center,y.halfExtents)}return c&&(this._pool.update(a.handle,l.buffer),this._textureBuffers.set(s,a)),a},t.releaseHandle=function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}},t.releaseSkeleton=function(e){for(var t=this._textureBuffers.values(),i=t.next();!i.done;){var n=i.value;n.skeletonHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}},t.releaseAnimationClip=function(e){for(var t=this._textureBuffers.values(),i=t.next();!i.done;){var n=i.value;n.clipHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}},t._createAnimInfos=function(e,t,i){for(var n=[],r=e.joints,s=e.bindposes,a=r.length,o=hd.getOrExtract(t),h=0;h<a;h++){for(var u=r[h],l=o.data[u],c=i.getChildByPath(u),d=void 0,f=void 0;!l;){var p=u.lastIndexOf("/");if(u=u.substring(0,p),l=o.data[u],c?(d||(d=new _),_.fromRTS(Wd,c.rotation,c.position,c.scale),_.multiply(d,Wd,d),c=c.parent):f=u,p<0)break}var m=h,g=void 0;if(void 0!==f&&l){m=h-1;for(var v=0;v<a;v++)if(r[v]===f){m=v,g=new _,_.multiply(g,s[v],e.inverseBindposes[h]);break}}n.push({curveData:l&&l.worldMatrix.values,downstream:d,bindposeIdx:m,bindposeCorrection:g})}return n},e}()),e("h",function(){function e(e){this._pool=new Map,this._device=void 0,this._device=e}var t=e.prototype;return t.getData=function(e){void 0===e&&(e="-1");var t=this._pool.get(e);if(t)return t;var i=this._device.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,xh.SIZE,xh.SIZE)),n=new Float32Array([0,0,0,0]);i.update(n);var r={buffer:i,data:n,dirty:!1};return this._pool.set(e,r),r},t.destroy=function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))},t.switchClip=function(e){return e.data[0]=0,e.buffer.update(e.data),e.dirty=!1,e},t.clear=function(){for(var e,t=R(this._pool.values());!(e=t()).done;)e.value.buffer.destroy();this._pool.clear()},e}()),new es(null)),Zd=e("X",function(){function e(){this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=Ft,this._priority=hh.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}var t=e.prototype;return t.initialize=function(e,t,i){void 0===i&&(i=null),this._device=u.director.root.device,this._subMesh=e,this._patches=i,this._passes=t,this._handle=qt.alloc(),this._flushPassInfo(),t[0].batchingScheme===fl.VB_MERGING&&this._subMesh.genFlatBuffers(),Kd.layout=t[0].localSetLayout;var n=Dt.alloc(this._device,Kd),r=Ut.alloc(this._device,e.iaInfo);qt.set(this._handle,Xt.PRIORITY,hh.DEFAULT),qt.set(this._handle,Xt.INPUT_ASSEMBLER,r),qt.set(this._handle,Xt.DESCRIPTOR_SET,n),qt.set(this._handle,Xt.SUB_MESH,e.handle),this._inputAssembler=Ut.get(r),this._descriptorSet=Dt.get(n)},t.destroy=function(){Dt.free(qt.get(this._handle,Xt.DESCRIPTOR_SET)),Ut.free(qt.get(this._handle,Xt.INPUT_ASSEMBLER)),qt.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=hh.DEFAULT,this._handle=Ft,this._patches=null,this._subMesh=null,this._passes=null},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var i=0;i<t.length;i++){var n=t[i];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){qt.set(this._handle,Xt.PASS_COUNT,e.length);for(var t=Xt.PASS_0,i=Xt.SHADER_0,n=0;n<e.length;n++,t++,i++)qt.set(this._handle,t,e[n].handle),qt.set(this._handle,i,e[n].getShaderVariant(this._patches))}},s(e,[{key:"passes",set:function(e){if(this._passes=e,this._flushPassInfo(),this._descriptorSet){Dt.free(qt.get(this._handle,Xt.DESCRIPTOR_SET)),Kd.layout=e[0].localSetLayout;var t=Dt.alloc(this._device,Kd);qt.set(this._handle,Xt.DESCRIPTOR_SET,t),this._descriptorSet=Dt.get(t)}},get:function(){return this._passes}},{key:"subMesh",set:function(e){this._subMesh=e,this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===fl.VB_MERGING&&this._subMesh.genFlatBuffers(),qt.set(this._handle,Xt.SUB_MESH,e.handle)},get:function(){return this._subMesh}},{key:"priority",set:function(e){this._priority=e,qt.set(this._handle,Xt.PRIORITY,e)},get:function(){return this._priority}},{key:"handle",get:function(){return this._handle}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"patches",get:function(){return this._patches}}]),e}()),Qd=e("dD",(md=I("RenderStage"),gd=te(),vd=te(),Ed=te(),md((Id=function(){function e(){b(this,"_name",Sd,this),b(this,"_priority",yd,this),b(this,"_tag",Rd,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},s(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}}]),e}(),Sd=O((Ad=Id).prototype,"_name",[gd,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yd=O(Ad.prototype,"_priority",[vd,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rd=O(Ad.prototype,"_tag",[Ed,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Td=Ad))||Td));u.RenderStage=Qd;var qd,Jd,$d,ef,tf,nf,rf,sf,af,of=e("dC",(Od=I("RenderFlow"),Nd=te(),Cd=te(),bd=te(),wd=te(),Ld=U([Qd]),Od((Ud=function(){function e(){b(this,"_name",Bd,this),b(this,"_priority",Fd,this),b(this,"_tag",xd,this),b(this,"_stages",Dd,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},s(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}}]),e}(),Bd=O((Pd=Ud).prototype,"_name",[Nd,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Fd=O(Pd.prototype,"_priority",[Cd,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xd=O(Pd.prototype,"_tag",[bd,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dd=O(Pd.prototype,"_stages",[wd,Ld,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Md=Pd))||Md));u.RenderFlow=of;var hf,uf,lf,_f,cf,df,ff,pf,mf,gf,vf,Ef,Tf,Af,Sf,yf,Rf,If,Of,Nf,Cf,bf,wf,Lf,Mf,Pf,Bf,Ff,xf,Df,Uf,Gf,Hf,kf,zf,Vf,Wf,Yf,Xf,jf,Kf,Zf,Qf,qf,Jf,$f,ep,tp,ip,np,rp,sp,ap,op,hp,up,lp,_p,cp,dp,fp,pp,mp,gp,vp,Ep,Tp,Ap,Sp,yp,Rp,Ip,Op,Np,Cp,bp,wp,Lp,Mp,Pp,Bp=e("dB",(qd=I("cc.RenderPipeline"),Jd=te(),$d=te(),ef=U([of]),qd((af=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,b(t,"_tag",rf,B(t)),b(t,"_flows",sf,B(t)),t._macros={},t._commandBuffers=[],t}a(t,e);var i=t.prototype;return i.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},i.activate=function(){this._device=u.director.root.device;var e=new ns(ch.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._descriptorSet=this._device.createDescriptorSet(new es(this._descriptorSetLayout));for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},i.render=function(e){for(var t=0;t<e.length;t++)for(var i=e[t],n=0;n<i.flows.length;n++)i.flows[n].render(i)},i.destroy=function(){for(var t=0;t<this._flows.length;t++)this._flows[t].destroy();this._flows.length=0,this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null);for(var i=0;i<this._commandBuffers.length;i++)this._commandBuffers[i].destroy();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},s(t,[{key:"macros",get:function(){return this._macros}},{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"device",get:function(){return this._device}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}}]),t}(M),rf=O((nf=af).prototype,"_tag",[Jd,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sf=O(nf.prototype,"_flows",[$d,ef,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tf=nf))||tf));u.RenderPipeline=Bp,o(Rn),o(In),o(Mn),o(Ln),o(Pn),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(Pp||(Pp={})),o(Pp),hf=I("RenderTextureDesc"),uf=U(Rn),lf=U(In),_f=U(hn),hf((df=O((cf=function(){b(this,"name",df,this),b(this,"type",ff,this),b(this,"usage",pf,this),b(this,"format",mf,this),b(this,"width",gf,this),b(this,"height",vf,this)}).prototype,"name",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ff=O(cf.prototype,"type",[uf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rn.TEX2D}}),pf=O(cf.prototype,"usage",[lf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return In.COLOR_ATTACHMENT}}),mf=O(cf.prototype,"format",[_f],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hn.UNKNOWN}}),gf=O(cf.prototype,"width",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),vf=O(cf.prototype,"height",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),cf));var Fp,xp=(Ef=I("RenderTextureConfig"),Tf=U(s_),Ef((yf=O((Sf=function(){b(this,"name",yf,this),b(this,"texture",Rf,this)}).prototype,"name",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Rf=O(Sf.prototype,"texture",[Tf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Af=Sf))||Af),Dp=(If=I("MaterialConfig"),Of=U(a_),If((bf=O((Cf=function(){b(this,"name",bf,this),b(this,"material",wf,this)}).prototype,"name",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wf=O(Cf.prototype,"material",[Of],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nf=Cf))||Nf),Up=(Lf=I("FrameBufferDesc"),Mf=U([ve]),Pf=U(s_),Lf((Ff=O((Bf=function(){b(this,"name",Ff,this),b(this,"renderPass",xf,this),b(this,"colorTextures",Df,this),b(this,"depthStencilTexture",Uf,this),b(this,"texture",Gf,this)}).prototype,"name",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xf=O(Bf.prototype,"renderPass",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Df=O(Bf.prototype,"colorTextures",[Mf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uf=O(Bf.prototype,"depthStencilTexture",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Gf=O(Bf.prototype,"texture",[Pf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bf)),Hf=I("ColorDesc"),kf=U(hn),zf=U(Ln),Vf=U(Mn),Wf=U(Pn),Yf=U(Pn),Hf((Kf=O((jf=function(){b(this,"format",Kf,this),b(this,"loadOp",Zf,this),b(this,"storeOp",Qf,this),b(this,"sampleCount",qf,this),b(this,"beginLayout",Jf,this),b(this,"endLayout",$f,this)}).prototype,"format",[kf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hn.UNKNOWN}}),Zf=O(jf.prototype,"loadOp",[zf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.CLEAR}}),Qf=O(jf.prototype,"storeOp",[Vf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mn.STORE}}),qf=O(jf.prototype,"sampleCount",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Jf=O(jf.prototype,"beginLayout",[Wf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.UNDEFINED}}),$f=O(jf.prototype,"endLayout",[Yf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.PRESENT_SRC}}),Xf=jf))||Xf),Gp=(ep=I("DepthStencilDesc"),tp=U(hn),ip=U(Ln),np=U(Mn),rp=U(Ln),sp=U(Mn),ap=U(Pn),op=U(Pn),ep((lp=O((up=function(){b(this,"format",lp,this),b(this,"depthLoadOp",_p,this),b(this,"depthStoreOp",cp,this),b(this,"stencilLoadOp",dp,this),b(this,"stencilStoreOp",fp,this),b(this,"sampleCount",pp,this),b(this,"beginLayout",mp,this),b(this,"endLayout",gp,this)}).prototype,"format",[tp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hn.UNKNOWN}}),_p=O(up.prototype,"depthLoadOp",[ip],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.CLEAR}}),cp=O(up.prototype,"depthStoreOp",[np],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mn.STORE}}),dp=O(up.prototype,"stencilLoadOp",[rp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.CLEAR}}),fp=O(up.prototype,"stencilStoreOp",[sp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mn.STORE}}),pp=O(up.prototype,"sampleCount",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mp=O(up.prototype,"beginLayout",[ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.UNDEFINED}}),gp=O(up.prototype,"endLayout",[op],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),hp=up))||hp);vp=I("RenderPassDesc"),Ep=U([Up]),Tp=U(Gp),vp((Sp=O((Ap=function(){b(this,"index",Sp,this),b(this,"colorAttachments",yp,this),b(this,"depthStencilAttachment",Rp,this)}).prototype,"index",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),yp=O(Ap.prototype,"colorAttachments",[Ep],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rp=O(Ap.prototype,"depthStencilAttachment",[Tp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gp}}),Ap)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(Fp||(Fp={})),o(Fp);var Hp,kp,zp,Vp=(Ip=I("RenderQueueDesc"),Op=U(Fp),Np=U([ve]),Ip((wp=O((bp=function(){b(this,"isTransparent",wp,this),b(this,"sortMode",Lp,this),b(this,"stages",Mp,this)}).prototype,"isTransparent",[N,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lp=O(bp.prototype,"sortMode",[Op],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fp.FRONT_TO_BACK}}),Mp=O(bp.prototype,"stages",[Np],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cp=bp))||Cp);!function(e){e[e.GENERAL=100]="GENERAL"}(Hp||(Hp={})),e("dE",function(){function e(){this._name="",this._window=null,this._priority=0,this._visibility=nu,this._isEnable=!1,this._flows=[]}s(e,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,u.director.root&&u.director.root.sortViews()}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"flows",get:function(){return this._flows}}]);var t=e.prototype;return t.initialize=function(e){return this._camera=e.camera,this._name=e.name,this.priority=e.priority,this.setExecuteFlows(e.flows),!0},t.destroy=function(){this._window=null,this._priority=0},t.enable=function(e){this._isEnable=e},t.setExecuteFlows=function(e){this._flows.length=0;var t=u.director.root.pipeline.flows;if(e&&1===e.length&&"UIFlow"===e[0]){for(var i=0;i<t.length;i++)if("UIFlow"===t[i].name){this._flows.push(t[i]);break}}else for(var n=0;n<t.length;++n){var r=t[n];(r.tag===Pp.SCENE||e&&-1!==e.indexOf(r.name))&&this._flows.push(r)}},t.onGlobalPipelineStateChanged=function(){for(var e=u.director.root.pipeline.flows,t=0;t<this._flows.length;++t)for(var i=this._flows[t],n=0;n<e.length;n++)if(e[n].name===i.name){this._flows[t]=e[n];break}},e}()),function(e){e[e.FORWARD=10]="FORWARD",e[e.UI=20]="UI"}(kp||(kp={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(zp||(zp={}));var Wp=e("dN",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,i,n,r){var s=t.handle,a=Kt.get(s,Bt.HASH)^n.hash^r.attributesHash^i.id,o=this._PSOHashMap.get(a);if(!o){var h=Gt.get(Kt.get(s,Bt.PIPELINE_LAYOUT)),u=new br(r.attributes),l=new wr(i,h,n,u,t.rasterizerState,t.depthStencilState,t.blendState,Kt.get(s,Bt.PRIMITIVE),Kt.get(s,Bt.DYNAMIC_STATES));o=e.createPipelineState(l),this._PSOHashMap.set(a,o)}return o},e}());function Yp(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function Xp(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}Wp._PSOHashMap=new Map;var jp=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new Ee((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Te(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,i){var n=e.model.subModels[t],r=qt.get(n.handle,Xt.PASS_0+i);if(n.passes[i].blendState.targets[0].blend!==this._passDesc.isTransparent||!(Kt.get(r,Bt.PHASE)&this._passDesc.phases))return!1;var s=0|Kt.get(r,Bt.PRIORITY)<<16|n.priority<<8|i,a=this._passPool.add();return a.hash=s,a.depth=e.depth||0,a.shaderId=qt.get(n.handle,Xt.SHADER_0+i),a.subModel=n,a.passIdx=i,this.queue.push(a),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,i){for(var n=0;n<this.queue.length;++n){var r=this.queue.array[n],s=r.subModel,a=r.passIdx,o=s.inputAssembler,h=s.handle,u=s.passes[a],l=xt.get(qt.get(h,Xt.SHADER_0+a)),_=Wp.getOrCreatePipelineState(e,u,l,t,o);i.bindPipelineState(_),i.bindDescriptorSet(gh.MATERIAL,u.descriptorSet),i.bindDescriptorSet(gh.LOCAL,s.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}(),Kp=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;){for(var n=0;n<i.value.batches.length;++n){var r=i.value.batches[n];if(r.mergeCount){for(var s=0;s<r.vbs.length;++s)r.vbs[s].update(r.vbDatas[s]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}i=t.next()}},t.recordCommandBuffer=function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){for(var s=!1,a=0;a<r.value.batches.length;++a){var o=r.value.batches[a];if(o.mergeCount){if(!s){var h=xt.get(o.hShader),u=Wp.getOrCreatePipelineState(e,o.pass,h,t,o.ia);i.bindPipelineState(u),i.bindDescriptorSet(gh.MATERIAL,o.pass.descriptorSet),s=!0}i.bindDescriptorSet(gh.LOCAL,o.descriptorSet,r.value.dynamicOffsets),i.bindInputAssembler(o.ia),i.draw(o.ia)}}r=n.next()}},e}(),Zp=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(e),i=t.next()},t.recordCommandBuffer=function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){var s=r.value,a=s.instances,o=s.pass;if(s.hasPendingModels){i.bindDescriptorSet(gh.MATERIAL,o.descriptorSet);for(var h=null,u=0;u<a.length;++u){var l=a[u];if(l.count){var _=xt.get(l.hShader),c=Wp.getOrCreatePipelineState(e,o,_,t,l.ia);h!==c&&(i.bindPipelineState(c),h=c),i.bindDescriptorSet(gh.LOCAL,Dt.get(l.hDescriptorSet),r.value.dynamicOffsets),i.bindInputAssembler(l.ia),i.draw(l.ia)}}}r=n.next()}},e}(),Qp=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}e.get=function(t,i){void 0===i&&(i=0);var n=e._buffers;n.has(t)||n.set(t,{});var r=n.get(t);return r[i]||(r[i]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,i){var n=e.subMesh.flatBuffers;if(0!==n.length){for(var r=0,s=0,a=n[0].count,o=e.passes[t],h=qt.get(e.handle,Xt.SHADER_0+t),u=e.descriptorSet,l=!1,c=0;c<this.batches.length;++c){var d=this.batches[c];if(d.vbs.length===n.length&&d.mergeCount<Ph.BATCHING_COUNT){l=!0;for(var f=0;f<d.vbs.length;++f)if(d.vbs[f].stride!==n[f].stride){l=!1;break}if(l){for(var p=0;p<d.vbs.length;++p){var m=n[p],g=d.vbs[p],v=d.vbDatas[p];(r=(a+d.vbCount)*m.stride)>g.size&&(g.resize(r),d.vbDatas[p]=new Uint8Array(r),d.vbDatas[p].set(v)),d.vbDatas[p].set(m.buffer,d.vbCount*m.stride)}var E=d.vbIdxData;(s=4*(a+d.vbCount))>d.vbIdx.size&&(d.vbIdx.resize(s),d.vbIdxData=new Float32Array(s/Float32Array.BYTES_PER_ELEMENT),d.vbIdxData.set(E),E=d.vbIdxData);var T=d.vbCount,A=T+a,S=d.mergeCount;if(E[T]!==S||E[A-1]!==S)for(var y=T;y<A;y++)E[y]=S+.1;return _.toArray(d.uboData,i.transform.worldMatrix,Ph.MAT_WORLDS_OFFSET+16*d.mergeCount),d.mergeCount||(u.bindBuffer(Ph.BINDING,d.ubo),u.update(),d.pass=o,d.hShader=h,d.descriptorSet=u),++d.mergeCount,d.vbCount+=a,void(d.ia.vertexCount+=a)}}}for(var R=[],I=[],O=[],N=0;N<n.length;++N){var C=n[N],b=this._device.createBuffer(new tr(un.VERTEX|un.TRANSFER_DST,ln.HOST|ln.DEVICE,C.count*C.stride,C.stride));b.update(C.buffer.buffer),R.push(b),I.push(new Uint8Array(b.size)),O.push(b)}var w=this._device.createBuffer(new tr(un.VERTEX|un.TRANSFER_DST,ln.HOST|ln.DEVICE,4*a,4)),L=new Float32Array(a);L.fill(0),w.update(L),O.push(w);for(var M=e.inputAssembler.attributes,P=new Array(M.length+1),B=0;B<M.length;++B)P[B]=M[B];P[M.length]=new fr("a_dyn_batch_id",hn.R32F,!1,n.length);var F=new pr(P,O),x=this._device.createInputAssembler(F),D=this._device.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,Ph.SIZE,Ph.SIZE));u.bindBuffer(Ph.BINDING,D),u.update();var U=new Float32Array(Ph.COUNT);_.toArray(U,i.transform.worldMatrix,Ph.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:R,vbDatas:I,vbIdx:w,vbIdxData:L,vbCount:a,ia:x,ubo:D,uboData:U,pass:o,hShader:h,descriptorSet:u})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}();Qp._buffers=new Map;var qp,Jp=e("dM",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}e.get=function(t,i){void 0===i&&(i=0);var n=e._buffers;n.has(t)||n.set(t,{});var r=n.get(t);return r[i]||(r[i]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,i){var n=t.buffer.length;if(n){for(var r=e.inputAssembler,s=e.descriptorSet.getTexture(qh),a=qt.get(e.handle,Xt.SHADER_0+i),o=qt.get(e.handle,Xt.DESCRIPTOR_SET),h=0;h<this.instances.length;++h){var u=this.instances[h];if(!(u.ia.indexBuffer!==r.indexBuffer||u.count>=1024)&&u.lightingMap===s){if(u.stride!==n)return;if(u.count>=u.capacity){u.capacity<<=1;var l=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(l),u.data.set(_),u.vb.resize(l)}return u.hShader!==a&&(u.hShader=a),u.hDescriptorSet!==o&&(u.hDescriptorSet=o),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var c=this._device.createBuffer(new tr(un.VERTEX|un.TRANSFER_DST,ln.HOST|ln.DEVICE,32*n,n)),d=new Uint8Array(32*n),f=r.vertexBuffers.slice(),p=r.attributes.slice(),m=r.indexBuffer,g=0;g<t.attributes.length;g++){var v=t.attributes[g],E=new fr(v.name,v.format,v.isNormalized,f.length,!0);p.push(E)}d.set(t.buffer),f.push(c);var T=new pr(p,f,m),A=this._device.createInputAssembler(T);this.instances.push({count:1,capacity:32,vb:c,data:d,ia:A,stride:n,hShader:a,hDescriptorSet:o,lightingMap:s}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var i=this.instances[t];i.count&&(i.ia.instanceCount=i.count,e.updateBuffer(i.vb,i.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}());function $p(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),s=2*n-8*r+4,a=3*n/s,o=2*r/s,h=1/o*a,u=1/o*(1-a-o);e.x=3.2404542*h-1.5371385+-.4985314*u,e.y=-.969266*h+1.8760108+.041556*u,e.z=.0556434*h-.2040259+1.0572252*u}Jp._buffers=new Map,function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(qp||(qp=e("L",{})));var em=e("E",(function(e){return 4*Math.PI*Math.PI*e*e})),tm=e("G",function(){function e(){this._color=new r(1,1,1),this._colorTemp=6550,this._colorTempRGB=new r(1,1,1),this._scene=null,this._node=null,this._name=null,this._handle=Ft}var t=e.prototype;return t.initialize=function(){this._handle=Bi.alloc(),Bi.setVec3(this._handle,wi.COLOR,this._color),Bi.setVec3(this._handle,wi.COLOR_TEMPERATURE_RGB,this._colorTempRGB),Bi.set(this._handle,wi.TYPE,qp.UNKNOWN)},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._handle&&(Bi.free(this._handle),this._handle=Ft)},t.update=function(){},s(e,[{key:"color",set:function(e){this._color.set(e),Bi.setVec3(this._handle,wi.COLOR,e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){Bi.set(this._handle,wi.USE_COLOR_TEMPERATURE,e?1:0)},get:function(){return 1===Bi.get(this._handle,wi.USE_COLOR_TEMPERATURE)}},{key:"colorTemperature",set:function(e){this._colorTemp=e,$p(this._colorTempRGB,this._colorTemp),Bi.setVec3(this._handle,wi.COLOR_TEMPERATURE_RGB,this._colorTempRGB)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=Cc.ROTATION,Bi.set(this._handle,wi.NODE,this._node.handle))},get:function(){return this._node}},{key:"type",get:function(){return Bi.get(this._handle,wi.TYPE)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"handle",get:function(){return this._handle}}]),e}()),im=[Sn.LINEAR,Sn.LINEAR,Sn.NONE,yn.CLAMP,yn.CLAMP,yn.CLAMP],nm=new Ae((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),rm=new Float32Array(4),sm=nn.create(0,0,0,1),am=[],om=[],hm=new _,um=new _;function lm(e,t){return!(!t.worldBounds||ca.aabbWithAABB(t.worldBounds,e.aabb))}function _m(e,t){return!(!t.worldBounds||ca.aabbWithAABB(t.worldBounds,e.aabb)&&ca.aabbFrustum(t.worldBounds,e.frustum))}var cm=gl("forward-add"),dm=[];function fm(e,t){t.length=0;for(var i=!1,n=0;n<e.length;n++){for(var r=e[n].passes,s=-1,a=0;a<r.length;a++)if(r[a].phase===cm){s=a,i=!0;break}t.push(s)}return i}var pm=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._validLights=[],this._lightPasses=[],this._descriptorSetMap=new Map,this._globalUBO=new Float32Array(Ah.COUNT),this._shadowUBO=new Float32Array(Sh.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._isHDR=void 0,this._fpScale=void 0,this._renderObjects=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._sampler=null,this._pipeline=e,this._device=e.device,this._isHDR=e.isHDR,this._fpScale=e.fpScale,this._renderObjects=e.renderObjects,this._instancedQueue=new Zp,this._batchedQueue=new Kp,this._lightBufferStride=Math.ceil(Bh.SIZE/this._device.uboOffsetAlignment)*this._device.uboOffsetAlignment,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new ir(this._lightBuffer,0,Bh.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount);var t=Po(im);this._sampler=jo.getSampler(this._device,t)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear(),this._validLights.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}nm.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=Array.from(this._descriptorSetMap.values()),t=0;t<e.length;++t){var i=e[t];i&&(i.getBuffer(Ah.BINDING).destroy(),i.getBuffer(Sh.BINDING).destroy(),i.destroy())}this._descriptorSetMap.clear()},t.gatherLightPasses=function(e,t){var i=this._validLights,n=e.camera.scene.sphereLights;this.clear();for(var r=0;r<n.length;r++){var s=n[r];nn.set(sm,s.position.x,s.position.y,s.position.z,s.range),ca.sphereFrustum(sm,e.camera.frustum)&&(i.push(s),this._getOrCreateDescriptorSet(s))}for(var a=e.camera.scene.spotLights,o=0;o<a.length;o++){var h=a[o];nn.set(sm,h.position.x,h.position.y,h.position.z,h.range),ca.sphereFrustum(sm,e.camera.frustum)&&(i.push(h),this._getOrCreateDescriptorSet(h))}if(i.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var u=0;u<this._renderObjects.length;u++){var l=this._renderObjects[u].model,_=l.subModels;if(fm(_,dm)){om.length=0;for(var c=0;c<i.length;c++){var d=i[c],f=!1;switch(d.type){case qp.SPHERE:f=lm(d,l);break;case qp.SPOT:f=_m(d,l)}f||om.push(c)}if(om.length)for(var p=0;p<_.length;p++){var m=dm[p];if(!(m<0)){var g=_[p],v=g.passes[m],E=v.batchingScheme;if(g.descriptorSet.bindBuffer(Bh.BINDING,this._firstLightBufferView),g.descriptorSet.update(),E===fl.INSTANCING)for(var T=0;T<om.length;T++){var A=om[T],S=Jp.get(v,A);S.merge(g,l.instancedAttributes,m),S.dynamicOffsets[0]=this._lightBufferStride*A,this._instancedQueue.queue.add(S)}else if(E===fl.VB_MERGING)for(var y=0;y<om.length;y++){var R=om[y],I=Qp.get(v,R);I.merge(g,m,l),I.dynamicOffsets[0]=this._lightBufferStride*R,this._batchedQueue.queue.add(I)}else{var O=nm.alloc();O.subModel=g,O.passIdx=m;for(var N=0;N<om.length;N++)O.lights.push(i[N]),O.dynamicOffsets.push(this._lightBufferStride*om[N]);this._lightPasses.push(O)}}}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._lightPasses.length;n++){var r=this._lightPasses[n],s=r.subModel,a=r.passIdx,o=r.dynamicOffsets,h=r.lights,u=xt.get(qt.get(s.handle,Xt.SHADER_0+a)),l=s.passes[a],_=s.inputAssembler,c=Wp.getOrCreatePipelineState(e,l,u,t,_),d=Dt.get(Kt.get(l.handle,Bt.DESCRIPTOR_SET)),f=s.descriptorSet;i.bindPipelineState(c),i.bindDescriptorSet(gh.MATERIAL,d),i.bindInputAssembler(_);for(var p=0;p<o.length;++p){var m=h[p],g=this._getOrCreateDescriptorSet(m);am[0]=o[p],i.bindDescriptorSet(gh.GLOBAL,g),i.bindDescriptorSet(gh.LOCAL,f,am),i.draw(_)}}},t._updateLightDescriptorSet=function(e,t){for(var i=this._pipeline.shadows,n=0;n<this._validLights.length;n++){var r=this._validLights[n],s=this._getOrCreateDescriptorSet(r);if(!s)return;switch(s.bindSampler(yh,this._sampler),s.bindSampler(bh,this._sampler),s.bindTexture(yh,ml.get("default-texture").getGFXTexture()),s.update(),this._updateGlobalDescriptorSet(e,t),r.type){case qp.SPHERE:Se.toArray(this._shadowUBO,i.shadowColor,Sh.SHADOW_COLOR_OFFSET),this._shadowUBO[Sh.SHADOW_INFO_OFFSET+0]=i.size.x,this._shadowUBO[Sh.SHADOW_INFO_OFFSET+1]=i.size.y,this._shadowUBO[Sh.SHADOW_INFO_OFFSET+2]=i.pcf,this._shadowUBO[Sh.SHADOW_INFO_OFFSET+3]=i.bias,s.bindTexture(bh,ml.get("default-texture").getGFXTexture());break;case qp.SPOT:var a,o=r;_.invert(hm,o.node.getWorldMatrix()),_.perspective(um,o.spotAngle,o.aspect,.001,o.range),_.multiply(um,um,hm),_.toArray(this._shadowUBO,um,Sh.MAT_LIGHT_VIEW_PROJ_OFFSET),Se.toArray(this._shadowUBO,i.shadowColor,Sh.SHADOW_COLOR_OFFSET),this._shadowUBO[Sh.SHADOW_INFO_OFFSET+0]=i.size.x,this._shadowUBO[Sh.SHADOW_INFO_OFFSET+1]=i.size.y,this._shadowUBO[Sh.SHADOW_INFO_OFFSET+2]=i.pcf,this._shadowUBO[Sh.SHADOW_INFO_OFFSET+3]=i.bias,this._pipeline.shadowFrameBufferMap.has(r)?s.bindTexture(bh,null===(a=this._pipeline.shadowFrameBufferMap.get(r))||void 0===a?void 0:a.colorTextures[0]):s.bindTexture(bh,ml.get("default-texture").getGFXTexture())}s.update(),t.updateBuffer(s.getBuffer(Ah.BINDING),this._globalUBO),t.updateBuffer(s.getBuffer(Sh.BINDING),this._shadowUBO)}},t._updateGlobalDescriptorSet=function(e){var t=u.director.root,i=this._pipeline.device,n=this._pipeline,s=e.camera,a=s.scene.mainLight,o=n.ambient,h=n.fog,l=this._globalUBO,c=n.shadingScale,d=Math.floor(i.width),p=Math.floor(i.height);l[Ah.TIME_OFFSET]=t.cumulativeTime,l[Ah.TIME_OFFSET+1]=t.frameTime,l[Ah.TIME_OFFSET+2]=u.director.getTotalFrames(),l[Ah.SCREEN_SIZE_OFFSET]=i.width,l[Ah.SCREEN_SIZE_OFFSET+1]=i.height,l[Ah.SCREEN_SIZE_OFFSET+2]=1/l[Ah.SCREEN_SIZE_OFFSET],l[Ah.SCREEN_SIZE_OFFSET+3]=1/l[Ah.SCREEN_SIZE_OFFSET+1],l[Ah.SCREEN_SCALE_OFFSET]=s.width/d*c,l[Ah.SCREEN_SCALE_OFFSET+1]=s.height/p*c,l[Ah.SCREEN_SCALE_OFFSET+2]=1/l[Ah.SCREEN_SCALE_OFFSET],l[Ah.SCREEN_SCALE_OFFSET+3]=1/l[Ah.SCREEN_SCALE_OFFSET+1],l[Ah.NATIVE_SIZE_OFFSET]=d,l[Ah.NATIVE_SIZE_OFFSET+1]=p,l[Ah.NATIVE_SIZE_OFFSET+2]=1/l[Ah.NATIVE_SIZE_OFFSET],l[Ah.NATIVE_SIZE_OFFSET+3]=1/l[Ah.NATIVE_SIZE_OFFSET+1],_.toArray(l,s.matView,Ah.MAT_VIEW_OFFSET),_.toArray(l,s.node.worldMatrix,Ah.MAT_VIEW_INV_OFFSET),_.toArray(l,s.matProj,Ah.MAT_PROJ_OFFSET),_.toArray(l,s.matProjInv,Ah.MAT_PROJ_INV_OFFSET),_.toArray(l,s.matViewProj,Ah.MAT_VIEW_PROJ_OFFSET),_.toArray(l,s.matViewProjInv,Ah.MAT_VIEW_PROJ_INV_OFFSET),r.toArray(l,s.position,Ah.CAMERA_POS_OFFSET);var m=i.screenSpaceSignY;e.window.hasOffScreenAttachments&&(m*=i.UVSpaceSignY),l[Ah.CAMERA_POS_OFFSET+3]=m;var g=s.exposure;if(l[Ah.EXPOSURE_OFFSET]=g,l[Ah.EXPOSURE_OFFSET+1]=1/g,l[Ah.EXPOSURE_OFFSET+2]=this._isHDR?1:0,l[Ah.EXPOSURE_OFFSET+3]=this._fpScale/g,a){if(r.toArray(l,a.direction,Ah.MAIN_LIT_DIR_OFFSET),r.toArray(l,a.color,Ah.MAIN_LIT_COLOR_OFFSET),a.useColorTemperature){var v=a.colorTemperatureRGB;l[Ah.MAIN_LIT_COLOR_OFFSET]*=v.x,l[Ah.MAIN_LIT_COLOR_OFFSET+1]*=v.y,l[Ah.MAIN_LIT_COLOR_OFFSET+2]*=v.z}this._isHDR?l[Ah.MAIN_LIT_COLOR_OFFSET+3]=a.illuminance*this._fpScale:l[Ah.MAIN_LIT_COLOR_OFFSET+3]=a.illuminance*g}else r.toArray(l,r.UNIT_Z,Ah.MAIN_LIT_DIR_OFFSET),f.toArray(l,f.ZERO,Ah.MAIN_LIT_COLOR_OFFSET);var E=o.colorArray;this._isHDR?E[3]=o.skyIllum*this._fpScale:E[3]=o.skyIllum*g,l.set(E,Ah.AMBIENT_SKY_OFFSET),l.set(o.albedoArray,Ah.AMBIENT_GROUND_OFFSET),h.enabled&&(l.set(h.colorArray,Ah.GLOBAL_FOG_COLOR_OFFSET),l[Ah.GLOBAL_FOG_BASE_OFFSET]=h.fogStart,l[Ah.GLOBAL_FOG_BASE_OFFSET+1]=h.fogEnd,l[Ah.GLOBAL_FOG_BASE_OFFSET+2]=h.fogDensity,l[Ah.GLOBAL_FOG_ADD_OFFSET]=h.fogTop,l[Ah.GLOBAL_FOG_ADD_OFFSET+1]=h.fogRange,l[Ah.GLOBAL_FOG_ADD_OFFSET+2]=h.fogAtten)},t._updateUBOs=function(e,t){var i=e.camera.exposure;this._validLights.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=ye(this._validLights.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new ir(this._lightBuffer,0,Bh.SIZE)));for(var n=0,s=0;n<this._validLights.length;n++,s+=this._lightBufferElementCount){var a=this._validLights[n];switch(a.type){case qp.SPHERE:var o=a;if(r.toArray(rm,o.position),rm[3]=0,this._lightBufferData.set(rm,s+Bh.LIGHT_POS_OFFSET),rm[0]=o.size,rm[1]=o.range,rm[2]=0,this._lightBufferData.set(rm,s+Bh.LIGHT_SIZE_RANGE_ANGLE_OFFSET),r.toArray(rm,a.color),a.useColorTemperature){var h=a.colorTemperatureRGB;rm[0]*=h.x,rm[1]*=h.y,rm[2]*=h.z}this._isHDR?rm[3]=o.luminance*this._fpScale*this._lightMeterScale:rm[3]=o.luminance*i*this._lightMeterScale,this._lightBufferData.set(rm,s+Bh.LIGHT_COLOR_OFFSET);break;case qp.SPOT:var u=a;if(r.toArray(rm,u.position),rm[3]=1,this._lightBufferData.set(rm,s+Bh.LIGHT_POS_OFFSET),rm[0]=u.size,rm[1]=u.range,rm[2]=u.spotAngle,this._lightBufferData.set(rm,s+Bh.LIGHT_SIZE_RANGE_ANGLE_OFFSET),r.toArray(rm,u.direction),this._lightBufferData.set(rm,s+Bh.LIGHT_DIR_OFFSET),r.toArray(rm,a.color),a.useColorTemperature){var l=a.colorTemperatureRGB;rm[0]*=l.x,rm[1]*=l.y,rm[2]*=l.z}this._isHDR?rm[3]=u.luminance*this._fpScale*this._lightMeterScale:rm[3]=u.luminance*i*this._lightMeterScale,this._lightBufferData.set(rm,s+Bh.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},t._getOrCreateDescriptorSet=function(e){if(!this._descriptorSetMap.has(e)){var t=this._device,i=t.createDescriptorSet(new es(this._pipeline.descriptorSetLayout)),n=t.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,Ah.SIZE,Ah.SIZE));i.bindBuffer(Ah.BINDING,n);var r=t.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,Sh.SIZE,Sh.SIZE));return i.bindBuffer(Sh.BINDING,r),i.update(),this._descriptorSetMap.set(e,i),i}return this._descriptorSetMap.get(e)},e}(),mm=e("N",g({Planar:0,ShadowMap:1})),gm=(e("O",g({HARD:0,FILTER_X5:1,FILTER_X9:2,FILTER_X25:3})),mm.ShadowMap+1),vm=e("Q",function(){function e(){this.sphere=new nn(0,0,0,.01),this.maxReceived=4,this._normal=new r(0,1,0),this._shadowColor=new Se(0,0,0,76),this._matLight=new _,this._material=null,this._instancingMaterial=null,this._size=new X(512,512),this._handle=Ft,this._handle=Li.alloc()}s(e,[{key:"enabled",get:function(){return!!Li.get(this._handle,Ni.ENABLE)},set:function(e){Li.set(this._handle,Ni.ENABLE,e?1:0),e||Li.set(this._handle,Ni.TYPE,gm),e?this.activate():this._updatePipeline()}},{key:"normal",get:function(){return this._normal},set:function(e){r.copy(this._normal,e),Li.setVec3(this._handle,Ni.NORMAL,this._normal)}},{key:"distance",get:function(){return Li.get(this._handle,Ni.DISTANCE)},set:function(e){Li.set(this._handle,Ni.DISTANCE,e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e,Li.setVec4(this._handle,Ni.COLOR,e)}},{key:"type",get:function(){return Li.get(this._handle,Ni.TYPE)},set:function(e){Li.set(this._handle,Ni.TYPE,this.enabled?e:gm),this._updatePipeline(),this._updatePlanarInfo()}},{key:"near",get:function(){return Li.get(this._handle,Ni.NEAR)},set:function(e){Li.set(this._handle,Ni.NEAR,e)}},{key:"far",get:function(){return Li.get(this._handle,Ni.FAR)},set:function(e){Li.set(this._handle,Ni.FAR,e)}},{key:"aspect",get:function(){return Li.get(this._handle,Ni.ASPECT)},set:function(e){Li.set(this._handle,Ni.ASPECT,e)}},{key:"orthoSize",get:function(){return Li.get(this._handle,Ni.ORTHO_SIZE)},set:function(e){Li.set(this._handle,Ni.ORTHO_SIZE,e)}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,Li.setVec2(this._handle,Ni.SIZE,this._size)}},{key:"pcf",get:function(){return Li.get(this._handle,Ni.PCF_TYPE)},set:function(e){Li.set(this._handle,Ni.PCF_TYPE,e)}},{key:"shadowMapDirty",get:function(){return!!Li.get(this._handle,Ni.SHADOW_MAP_DIRTY)},set:function(e){Li.set(this._handle,Ni.SHADOW_MAP_DIRTY,e?1:0)}},{key:"bias",get:function(){return Li.get(this._handle,Ni.BIAS)},set:function(e){Li.set(this._handle,Ni.BIAS,e)}},{key:"autoAdapt",get:function(){return!!Li.get(this._handle,Ni.AUTO_ADAPT)},set:function(e){Li.set(this._handle,Ni.AUTO_ADAPT,e?1:0)}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"handle",get:function(){return this._handle}}]);var t=e.prototype;return t.initialize=function(e){Li.set(this._handle,Ni.TYPE,e.enabled?e.type:gm),Li.set(this._handle,Ni.NEAR,e.near),Li.set(this._handle,Ni.FAR,e.far),Li.set(this._handle,Ni.ASPECT,e.aspect),Li.set(this._handle,Ni.ORTHO_SIZE,e.orthoSize),this._size=e.shadowMapSize,Li.setVec2(this._handle,Ni.SIZE,this._size),Li.set(this._handle,Ni.PCF_TYPE,e.pcf),r.copy(this._normal,e.normal),Li.setVec3(this._handle,Ni.NORMAL,this._normal),Li.set(this._handle,Ni.DISTANCE,e.distance),this._shadowColor.set(e.shadowColor),Li.setVec4(this._handle,Ni.COLOR,this._shadowColor),Li.set(this._handle,Ni.BIAS,e.bias),Li.set(this._handle,Ni.ENABLE,e.enabled?1:0),this.maxReceived=e.maxReceived,Li.set(this._handle,Ni.AUTO_ADAPT,e.autoAdapt?1:0)},t.activate=function(){this.enabled&&this.type!==mm.ShadowMap?this._updatePlanarInfo():this._updatePipeline()},t._updatePlanarInfo=function(){this._material||(this._material=new a_,this._material.initialize({effectName:"planar-shadow"}),Li.set(this._handle,Ni.PLANAR_PASS,this._material.passes[0].handle),Li.set(this._handle,Ni.PLANAR_SHADER,this._material.passes[0].getShaderVariant(null))),this._instancingMaterial||(this._instancingMaterial=new a_,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),Li.set(this._handle,Ni.INSTANCE_PASS,this._instancingMaterial.passes[0].handle));var e=u.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=0,e.onGlobalPipelineStateChanged()},t._updatePipeline=function(){var e=u.director.root,t=e.pipeline,i=this.enabled&&this.type===mm.ShadowMap;t.macros.CC_RECEIVE_SHADOW!==i&&(t.macros.CC_RECEIVE_SHADOW=i,e.onGlobalPipelineStateChanged())},t.destroy=function(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this._handle&&(Li.free(this._handle),this._handle=Ft),this.sphere.destroy()},e}());vm.MAX_FAR=2e3,vm.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),u.Shadows=vm;var Em,Tm,Am,Sm,ym,Rm,Im,Om,Nm,Cm,bm,wm,Lm,Mm,Pm,Bm,Fm=new Ia,xm=function(){function e(e){this._pendingModels=[],this._instancedQueue=new Zp,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var i=this._pipeline.shadows;if(i.enabled&&i.type===mm.Planar){var n=e.camera,r=n.scene,s=n.frustum,a=0!=(n.visibility&lh.BitMask.DEFAULT);if(r.mainLight&&a){var o=r.models;this._pendingModels.length=0;var h=Jp.get(i.instancingMaterial.passes[0]);this._instancedQueue.clear(),this._instancedQueue.queue.add(h);for(var u=0;u<o.length;u++){var l=o[u];if(l.enabled&&l.node&&l.castShadow&&(!l.worldBounds||(Ia.transform(Fm,l.worldBounds,i.matLight),ca.aabbFrustum(Fm,s))))if(l.isInstancingEnabled)for(var _=0;_<l.subModels.length;_++)h.merge(l.subModels[_],l.instancedAttributes,0);else this._pendingModels.push(l)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,i){var n=this._pipeline.shadows;if(n.enabled&&n.type===mm.Planar&&this._pendingModels.length){this._instancedQueue.recordCommandBuffer(e,t,i);var r=n.material.passes[0],s=Dt.get(Kt.get(r.handle,Bt.DESCRIPTOR_SET));i.bindDescriptorSet(gh.MATERIAL,s);for(var a=xt.get(Li.get(n.handle,Ni.PLANAR_SHADER)),o=this._pendingModels.length,h=0;h<o;h++)for(var u=this._pendingModels[h],l=0;l<u.subModels.length;l++){var _=u.subModels[l],c=_.inputAssembler,d=Wp.getOrCreatePipelineState(e,r,a,t,c);i.bindPipelineState(d),i.bindDescriptorSet(gh.LOCAL,_.descriptorSet),i.bindInputAssembler(c),i.draw(c)}}},e}(),Dm=[new Er(0,0,0,1)],Um=e("dH",(Em=I("ForwardStage"),Tm=U([Vp]),Am=te(),Em((Om=Im=function(e){function t(){var t;return t=e.call(this)||this,b(t,"renderQueues",Rm,B(t)),t._renderQueues=[],t._renderArea=new gr,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=gl("default"),t._batchedQueue=new Kp,t._instancedQueue=new Zp,t}a(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var n=0;n<this.renderQueues.length;n++){for(var r=0,s=0;s<this.renderQueues[n].stages.length;s++)r|=gl(this.renderQueues[n].stages[s]);var a=Yp;switch(this.renderQueues[n].sortMode){case Fp.BACK_TO_FRONT:a=Xp;break;case Fp.FRONT_TO_BACK:a=Yp}this._renderQueues[n]=new jp({isTransparent:this.renderQueues[n].isTransparent,phases:r,sortFunc:a})}this._additiveLightQueue=new pm(this._pipeline),this._planarQueue=new xm(this._pipeline)},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(this.renderQueueClearFunc);for(var n=t.renderObjects,r=0,s=0,a=0,o=0;o<n.length;++o){var h=n[o],u=h.model.subModels;for(r=0;r<u.length;++r){var l=u[r],_=l.passes;for(s=0;s<_.length;++s){var c=_[s];if(c.phase===this._phaseID){var d=c.batchingScheme;if(d===fl.INSTANCING){var f=Jp.get(c);f.merge(l,h.model.instancedAttributes,s),this._instancedQueue.queue.add(f)}else if(d===fl.VB_MERGING){var p=Qp.get(c);p.merge(l,s,h.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(h,r,s)}}}}this._renderQueues.forEach(this.renderQueueSortFunc);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m);var g,v,E=e.camera,T=E.viewport,A=e.window.hasOnScreenAttachments&&i.surfaceTransform%2?E.height:E.width,S=e.window.hasOnScreenAttachments&&i.surfaceTransform%2?E.width:E.height;if(this._renderArea.x=T.x*A,this._renderArea.y=T.y*S,this._renderArea.width=T.width*A*t.shadingScale,this._renderArea.height=T.height*S*t.shadingScale,E.clearFlag&Un.COLOR)if(t.isHDR){g=Dm[0],v=E.clearColor,g.x=v.x*v.x,g.y=v.y*v.y,g.z=v.z*v.z;var y=t.fpScale/E.exposure;Dm[0].x*=y,Dm[0].y*=y,Dm[0].z*=y}else Dm[0].x=E.clearColor.x,Dm[0].y=E.clearColor.y,Dm[0].z=E.clearColor.z;Dm[0].w=E.clearColor.w;var R=e.window.framebuffer,I=R.colorTextures[0]?R.renderPass:t.getRenderPass(E.clearFlag);m.beginRenderPass(I,R,this._renderArea,Dm,E.clearDepth,E.clearStencil),m.bindDescriptorSet(gh.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,I,m),this._instancedQueue.recordCommandBuffer(i,I,m),this._batchedQueue.recordCommandBuffer(i,I,m),this._additiveLightQueue.recordCommandBuffer(i,I,m),this._planarQueue.recordCommandBuffer(i,I,m),this._renderQueues[1].recordCommandBuffer(i,I,m),m.endRenderPass()},i.renderQueueClearFunc=function(e){e.clear()},i.renderQueueSortFunc=function(e){e.sort()},t}(Qd),Im.initInfo={name:"ForwardStage",priority:kp.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:Fp.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:Fp.BACK_TO_FRONT,stages:["default","planarShadow"]}]},Rm=O((ym=Om).prototype,"renderQueues",[Tm,N,Am],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sm=ym))||Sm)),Gm=e("dG",I("ForwardFlow")((bm=Cm=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new Um;i.initialize(Um.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){this._pipeline.updateUBOs(t),e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(of),Cm.initInfo={name:"ForwardFlow",priority:zp.FORWARD,stages:[]},Nm=bm))||Nm);!function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(wm||(wm=e("C",{}))),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(Lm||(Lm=e("q",{}))),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(Mm||(Mm=e("r",{}))),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(Pm||(Pm=e("t",{}))),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Bm||(Bm=e("v",{})));var Hm=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],km=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],zm=[100,200,400,800],Vm=new r,Wm=new r,Ym=new _,Xm=(new _,e("w",Un.STENCIL<<1)),jm=[],Km=e("x",function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=wm.VERTICAL,this._fov=Oe(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Er(.2,.2,.2,1),this._viewport=new j(0,0,1,1),this._curTransform=kn.IDENTITY,this._isProjDirty=!0,this._matView=new _,this._matViewInv=null,this._matProj=new _,this._matProjInv=new _,this._matViewProj=new _,this._matViewProjInv=new _,this._frustum=new Fa,this._forward=new r,this._position=new r,this._view=null,this._visibility=nu,this._priority=0,this._aperture=Mm.F16_0,this._apertureValue=void 0,this._shutter=Bm.D125,this._shutterValue=0,this._iso=Pm.ISO100,this._isoValue=0,this._ec=0,this._poolHandle=Ft,this._frustumHandle=Ft,this._device=e,this._apertureValue=Hm[this._aperture],this._shutterValue=km[this._shutter],this._isoValue=zm[this._iso],this._aspect=this.screenScale=1,!jm.length){var t=e.screenSpaceSignY;jm[kn.IDENTITY]=new _(1,0,0,0,0,t),jm[kn.ROTATE_90]=new _(0,1,0,0,-t,0),jm[kn.ROTATE_180]=new _(-1,0,0,0,0,-t),jm[kn.ROTATE_270]=new _(0,-1,0,0,t,0)}}var t=e.prototype;return t.initialize=function(e){this._name=e.name,this._node=e.node,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1;var t=this._poolHandle=ui.alloc();ui.set(t,ri.WIDTH,1),ui.set(t,ri.HEIGHT,1),ui.set(t,ri.CLEAR_FLAG,Un.NONE),ui.set(t,ri.CLEAR_DEPTH,1),ui.set(t,ri.NODE,this._node.handle),this._scene&&ui.set(t,ri.SCENE,this._scene.handle),this.updateExposure(),this._view=u.director.root.createView({camera:this,name:this._name,priority:this._priority,flows:e.flows}),u.director.root.attachCamera(this),this.changeTargetWindow(e.window),console.log("Created Camera: "+this._name+" "+ui.get(t,ri.WIDTH)+"x"+ui.get(t,ri.HEIGHT))},t.destroy=function(){u.director.root.detachCamera(this),this._view&&(this._view.destroy(),this._view=null),this._name=null,this._poolHandle&&(ui.free(this._poolHandle),this._poolHandle=Ft,this._frustumHandle&&(Ei.free(this._frustumHandle),this._frustumHandle=Ft))},t.attachToScene=function(e){this._scene=e,ui.set(this._poolHandle,ri.SCENE,e.handle),this._view&&this._view.enable(!0)},t.detachFromScene=function(){this._scene=null,ui.set(this._poolHandle,ri.SCENE,0),this._view&&this._view.enable(!1)},t.resize=function(e,t){var i=this._poolHandle;ui.set(i,ri.WIDTH,e),ui.set(i,ri.HEIGHT,t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this._isProjDirty=!0},t.setFixedSize=function(e,t){var i=this._poolHandle;ui.set(i,ri.WIDTH,e),ui.set(i,ri.HEIGHT,t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this.isWindowSize=!1},t.update=function(e){if(void 0===e&&(e=!1),this._node){var t=!1;(this._node.hasChangedFlags||e)&&(_.invert(this._matView,this._node.worldMatrix),ui.setMat4(this._poolHandle,ri.MAT_VIEW,this._matView),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),ui.setVec3(this._poolHandle,ri.POSITION,this._position),ui.setVec3(this._poolHandle,ri.FORWARD,this._forward),t=!0);var i=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==i){this._curTransform=i;var n=this._device.screenSpaceSignY;if(this._view&&this._view.window.hasOffScreenAttachments&&(n*=this._device.UVSpaceSignY,i=kn.IDENTITY),this._proj===Lm.PERSPECTIVE)_.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===wm.VERTICAL,this._device.clipSpaceMinZ,n,i);else{var r=this._orthoHeight*this._aspect,s=this._orthoHeight;_.ortho(this._matProj,-r,r,-s,s,this._nearClip,this._farClip,this._device.clipSpaceMinZ,n,i)}_.invert(this._matProjInv,this._matProj),ui.setMat4(this._poolHandle,ri.MAT_PROJ,this._matProj),ui.setMat4(this._poolHandle,ri.MAT_PROJ_INV,this._matProjInv),t=!0,this._isProjDirty=!1}t&&(_.multiply(this._matViewProj,this._matProj,this._matView),_.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),ui.setMat4(this._poolHandle,ri.MAT_VIEW_PROJ,this._matViewProj),ui.setMat4(this._poolHandle,ri.MAT_VIEW_PROJ_INV,this._matViewProjInv),xa(this._frustumHandle,this._frustum))}},t.changeTargetWindow=function(e){void 0===e&&(e=null);var t=e||u.director.root.mainWindow;t&&this._view&&(this._view.window=t,this.resize(t.width,t.height))},t.screenPointToRay=function(e,t,i){if(!this._node)return null;var n=this._poolHandle,s=ui.get(n,ri.WIDTH),a=ui.get(n,ri.HEIGHT),o=this._viewport.x*s,h=this._viewport.y*a,u=this._viewport.width*s,l=this._viewport.height*a,_=this._proj===Lm.PERSPECTIVE,c=this._device.screenSpaceSignY,d=Re[this._curTransform];r.set(Vm,(t-o)/u*2-1,(i-h)/l*2-1,_?1:-1);var f=Vm.x,p=Vm.y;return Vm.x=f*d[0]+p*d[2]*c,Vm.y=f*d[1]+p*d[3]*c,r.transformMat4(_?Vm:e.o,Vm,this._matViewProjInv),_?(this._node.getWorldPosition(Wm),Rt.fromPoints(e,Wm,Vm)):r.transformQuat(e.d,r.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var i=this._poolHandle,n=ui.get(i,ri.WIDTH),s=ui.get(i,ri.HEIGHT),a=this._viewport.x*n,o=this._viewport.y*s,h=this._viewport.width*n,u=this._viewport.height*s,l=this._device.screenSpaceSignY,_=Re[this._curTransform];if(this._proj===Lm.PERSPECTIVE){r.set(e,(t.x-a)/h*2-1,(t.y-o)/u*2-1,1);var c=e.x,d=e.y;e.x=c*_[0]+d*_[2]*l,e.y=c*_[1]+d*_[3]*l,r.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(Vm),r.lerp(e,Vm,e,Ie(this._nearClip/this._farClip,1,t.z))}else{r.set(e,(t.x-a)/h*2-1,(t.y-o)/u*2-1,2*t.z-1);var f=e.x,p=e.y;e.x=f*_[0]+p*_[2]*l,e.y=f*_[1]+p*_[3]*l,r.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var i=this._poolHandle,n=ui.get(i,ri.WIDTH),s=ui.get(i,ri.HEIGHT),a=this._viewport.x*n,o=this._viewport.y*s,h=this._viewport.width*n,u=this._viewport.height*s,l=this._device.screenSpaceSignY,_=Re[this._curTransform];r.transformMat4(e,t,this._matViewProj);var c=e.x,d=e.y;return e.x=c*_[0]+d*_[2]*l,e.y=c*_[1]+d*_[3]*l,e.x=a+.5*(e.x+1)*h,e.y=o+.5*(e.y+1)*u,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,i,n){_.multiply(e,this._matViewProj,t),_.multiply(e,jm[this._curTransform],e);var s=i/2,a=n/2;return _.identity(Ym),_.transform(Ym,Ym,r.set(Vm,s,a,0)),_.scale(Ym,Ym,r.set(Vm,s,a,1)),_.multiply(e,Ym,e),e},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);ui.set(this._poolHandle,ri.EXPOSURE,.833333/Math.pow(2,e))},s(e,[{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"enabled",set:function(e){this._enabled=e,this._view&&this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"fovAxis",set:function(e){this._fovAxis=e,this._isProjDirty=!0},get:function(){return this._fovAxis}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w,ui.setVec4(this._poolHandle,ri.CLEAR_COLOR,e)},get:function(){return this._clearColor}},{key:"viewport",get:function(){return this._viewport},set:function(e){var t=e.x,i=e.width,n=e.height,r=this._device.screenSpaceSignY<0?1-e.y-n:e.y;switch(this._device.surfaceTransform){case kn.ROTATE_90:this._viewport.x=1-r-n,this._viewport.y=t,this._viewport.width=n,this._viewport.height=i;break;case kn.ROTATE_180:this._viewport.x=1-t-i,this._viewport.y=1-r-n,this._viewport.width=i,this._viewport.height=n;break;case kn.ROTATE_270:this._viewport.x=r,this._viewport.y=1-t-i,this._viewport.width=n,this._viewport.height=i;break;case kn.IDENTITY:this._viewport.x=t,this._viewport.y=r,this._viewport.width=i,this._viewport.height=n}ui.setVec4(this._poolHandle,ri.VIEW_PORT,this._viewport),this.resize(this.width,this.height)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return ui.get(this._poolHandle,ri.WIDTH)}},{key:"height",get:function(){return ui.get(this._poolHandle,ri.HEIGHT)}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",set:function(e){this._matView=e,ui.setMat4(this._poolHandle,ri.MAT_VIEW,this._matView)},get:function(){return this._matView}},{key:"matViewInv",set:function(e){this._matViewInv=e},get:function(){return this._matViewInv||this._node.worldMatrix}},{key:"matProj",set:function(e){this._matProj=e,ui.setMat4(this._poolHandle,ri.MAT_PROJ,this._matProj)},get:function(){return this._matProj}},{key:"matProjInv",set:function(e){this._matProjInv=e,ui.setMat4(this._poolHandle,ri.MAT_PROJ_INV,this._matProjInv)},get:function(){return this._matProjInv}},{key:"matViewProj",set:function(e){this._matViewProj=e,ui.setMat4(this._poolHandle,ri.MAT_VIEW_PROJ,this._matViewProj)},get:function(){return this._matViewProj}},{key:"matViewProjInv",set:function(e){this._matViewProjInv=e,ui.setMat4(this._poolHandle,ri.MAT_VIEW_PROJ_INV,this._matViewProjInv)},get:function(){return this._matViewProjInv}},{key:"frustum",set:function(e){this._frustum=e,xa(this._frustumHandle,e)},get:function(){return this._frustum}},{key:"forward",set:function(e){this._forward=e,ui.setVec3(this._poolHandle,ri.FORWARD,this._forward)},get:function(){return this._forward}},{key:"position",set:function(e){this._position=e,ui.setVec3(this._poolHandle,ri.POSITION,this._position)},get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view&&(this._view.visibility=e)},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view?this._view.priority:-1},set:function(e){this._priority=e,this._view&&(this._view.priority=this._priority)}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=Hm[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=km[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=zm[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return ui.get(this._poolHandle,ri.EXPOSURE)}},{key:"flows",set:function(e){this._view&&this._view.setExecuteFlows(e)}},{key:"clearFlag",get:function(){return ui.get(this._poolHandle,ri.CLEAR_FLAG)},set:function(e){ui.set(this._poolHandle,ri.CLEAR_FLAG,e)}},{key:"clearDepth",get:function(){return ui.get(this._poolHandle,ri.CLEAR_DEPTH)},set:function(e){ui.set(this._poolHandle,ri.CLEAR_DEPTH,e)}},{key:"clearStencil",get:function(){return ui.get(this._poolHandle,ri.CLEAR_STENCIL)},set:function(e){ui.set(this._poolHandle,ri.CLEAR_STENCIL,e)}},{key:"handle",get:function(){return this._poolHandle}}]),e}()),Zm=new r,Qm=new r,qm=new r,Jm=new _,$m=new Ia,eg=!1,tg=[],ig=nn.create(0,0,0,1),ng=new Ae((function(){return{model:null,depth:0}}),128),rg=new Ae((function(){return{model:null,depth:0}}),128);function sg(e,t){var i=0;e.node&&(r.subtract(Zm,e.node.worldPosition,t.position),i=r.dot(Zm,t.forward));var n=ng.alloc();return n.model=e,n.depth=i,n}function ag(e,t){var i=0;e.node&&(r.subtract(Zm,e.node.worldPosition,t.position),i=r.dot(Zm,t.forward));var n=rg.alloc();return n.model=e,n.depth=i,n}function og(e,t,i,n){var s=e.shadows;r.negate(Qm,i);var a=s.sphere.radius*vm.COEFFICIENT_OF_EXPANSION;return r.multiplyScalar(qm,Qm,a),r.add(qm,qm,s.sphere.center),n.set(qm),_.fromRT(Jm,t,qm),Jm}function hg(e,t){var i=t.camera,n=i.scene,s=n.mainLight,a=e.shadows,o=e.renderObjects;ng.freeArray(o),o.length=0,a.enabled&&Se.toArray(e.shadowUBO,a.shadowColor,Sh.SHADOW_COLOR_OFFSET),s&&a.type===mm.Planar&&function(e,t){var i=e.shadows,n=t.direction,s=i.normal,a=i.distance+.001,o=1/r.dot(s,n),h=n.x*o,u=n.y*o,l=n.z*o,c=s.x,d=s.y,f=s.z,p=i.matLight;p.m00=1-c*h,p.m01=-c*u,p.m02=-c*l,p.m03=0,p.m04=-d*h,p.m05=1-d*u,p.m06=-d*l,p.m07=0,p.m08=-f*h,p.m09=-f*u,p.m10=1-f*l,p.m11=0,p.m12=h*a,p.m13=u*a,p.m14=l*a,p.m15=1,_.toArray(e.shadowUBO,i.matLight,Sh.MAT_LIGHT_PLANE_PROJ_OFFSET)}(e,s),e.skybox.enabled&&e.skybox.model&&i.clearFlag&Xm&&o.push(sg(e.skybox.model,i));for(var h=n.models,u=0;u<h.length;u++){var l=h[u];if(l.enabled)if(t.visibility&lh.BitMask.UI_2D)(l.node&&t.visibility===l.node.layer||t.visibility===l.visFlags)&&o.push(sg(l,i));else if(l.node&&(t.visibility&l.node.layer)===l.node.layer||t.visibility&l.visFlags){if(l.worldBounds&&!ca.aabbFrustum(l.worldBounds,i.frustum))continue;o.push(sg(l,i))}}}var ug,lg,_g,cg,dg,fg,pg=new _,mg=new _,gg=new f,vg=new r,Eg=gl("shadow-caster"),Tg=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._shadowMapBuffer=void 0,this._device=void 0,this._shadowInfo=void 0,this._descriptorSet=void 0,this._shadowObjects=void 0,this._shadowUBO=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._device=e.device,this._shadowInfo=e.shadows,this._descriptorSet=e.descriptorSet,this._shadowObjects=e.shadowObjects,this._shadowUBO=e.shadowUBO,this._shadowMapBuffer=e.descriptorSet.getBuffer(Sh.BINDING),this._instancedQueue=new Zp,this._batchedQueue=new Kp}var t=e.prototype;return t.gatherLightPasses=function(e,t){if(this.clear(),e&&this._shadowInfo.enabled&&this._shadowInfo.type===mm.ShadowMap){this._updateUBOs(e);for(var i=0;i<this._shadowObjects.length;i++){var n=this._shadowObjects[i].model;switch(e.type){case qp.DIRECTIONAL:this.add(n,t);break;case qp.SPOT:var r=e;if(n.worldBounds&&(!ca.aabbWithAABB(n.worldBounds,r.aabb)||!ca.aabbFrustum(n.worldBounds,r.frustum)))continue;this.add(n,t)}}}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t){var i=e.subModels,n=function(e){for(var t=0;t<e.length;t++)for(var i=e[t].passes,n=0;n<i.length;n++)if(i[n].phase===Eg)return n;return-1}(i);if(!(n<0)){for(var r=0;r<i.length;r++){var s=i[r],a=s.passes[n],o=a.batchingScheme;if(s.descriptorSet.bindBuffer(Sh.BINDING,this._shadowMapBuffer),s.descriptorSet.update(),o===fl.INSTANCING){var h=Jp.get(a);h.merge(s,e.instancedAttributes,n),this._instancedQueue.queue.add(h)}else if(a.batchingScheme===fl.VB_MERGING){var u=Qp.get(a);u.merge(s,n,e),this._batchedQueue.queue.add(u)}else{var l=xt.get(qt.get(s.handle,Xt.SHADER_0+n));this._subModelsArray.push(s),this._shaderArray.push(l),this._passArray.push(a)}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._subModelsArray.length;++n){var r=this._subModelsArray[n],s=this._shaderArray[n],a=this._passArray[n],o=r.inputAssembler,h=Wp.getOrCreatePipelineState(e,a,s,t,o),u=a.descriptorSet;i.bindPipelineState(h),i.bindDescriptorSet(gh.MATERIAL,u),i.bindDescriptorSet(gh.LOCAL,r.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},t._updateUBOs=function(e){switch(e.type){case qp.DIRECTIONAL:var t,i=e;i.update();var n=0,s=0,a=0;if(this._shadowInfo.autoAdapt){var o;t=og(this._pipeline,null===(o=i.node)||void 0===o?void 0:o.getWorldRotation(),i.direction,vg);var h=this._shadowInfo.sphere.radius;n=h*this._shadowInfo.aspect,s=h;var u=r.distance(this._shadowInfo.sphere.center,vg);a=Math.min(u*vm.COEFFICIENT_OF_EXPANSION,vm.MAX_FAR)}else t=i.node.getWorldMatrix(),n=this._shadowInfo.orthoSize*this._shadowInfo.aspect,s=this._shadowInfo.orthoSize,a=this._shadowInfo.far;_.invert(pg,t);var l=this._device.screenSpaceSignY*this._device.UVSpaceSignY;_.ortho(mg,-n,n,-s,s,this._shadowInfo.near,a,this._device.clipSpaceMinZ,l);break;case qp.SPOT:var c=e;_.invert(pg,c.node.getWorldMatrix()),_.perspective(mg,c.spotAngle,c.aspect,.001,c.range)}_.multiply(mg,mg,pg),_.toArray(this._shadowUBO,mg,Sh.MAT_LIGHT_VIEW_PROJ_OFFSET),Se.toArray(this._shadowUBO,this._shadowInfo.shadowColor,Sh.SHADOW_COLOR_OFFSET),gg.set(this._shadowInfo.size.x,this._shadowInfo.size.y,this._shadowInfo.pcf,this._shadowInfo.bias),f.toArray(this._shadowUBO,gg,Sh.SHADOW_INFO_OFFSET),this._descriptorSet.getBuffer(Sh.BINDING).update(this._shadowUBO)},e}(),Ag=[new Er(1,1,1,1)],Sg=e("dJ",I("ShadowStage")((_g=lg=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._shadowFrameBuffer=null,t._renderArea=new gr,t._light=null,t}a(t,e);var i=t.prototype;return i.setUsage=function(e,t){this._light=e,this._shadowFrameBuffer=t},i.destroy=function(){this._additiveShadowQueue.clear()},i.render=function(e){var t=this._pipeline,i=t.shadows,n=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._additiveShadowQueue.gatherLightPasses(this._light,n);var r=e.camera,s=r.viewport,a=i.size;this._renderArea.x=s.x*a.x,this._renderArea.y=s.y*a.y,this._renderArea.width=s.width*a.x*t.shadingScale,this._renderArea.height=s.height*a.y*t.shadingScale;var o=t.device,h=this._shadowFrameBuffer.renderPass;n.beginRenderPass(h,this._shadowFrameBuffer,this._renderArea,Ag,r.clearDepth,r.clearStencil),n.bindDescriptorSet(gh.GLOBAL,t.descriptorSet),this._additiveShadowQueue.recordCommandBuffer(o,h,n),n.endRenderPass()}},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._additiveShadowQueue=new Tg(t)},t}(Qd),lg.initInfo={name:"ShadowStage",priority:kp.FORWARD,tag:0},ug=_g))||ug),yg=[Sn.LINEAR,Sn.LINEAR,Sn.NONE,yn.CLAMP,yn.CLAMP,yn.CLAMP],Rg=e("dI",I("ShadowFlow")((fg=dg=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._shadowRenderPass=null,t._globalBinding=!1,t}a(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new Sg;i.initialize(Sg.initInfo),this._stages.push(i)}return!0},i.render=function(e){var t=this._pipeline,i=t.shadows;if(i.type===mm.ShadowMap){var n=function(e,t){tg.length=0;var i=e.camera.scene;tg.push(i.mainLight);for(var n=i.spotLights,r=0;r<n.length;r++){var s=n[r];nn.set(ig,s.position.x,s.position.y,s.position.z,s.range),ca.sphereFrustum(ig,e.camera.frustum)&&t>tg.length&&tg.push(s)}return tg}(e,i.maxReceived);!function(e,t){var i=t.camera,n=i.scene,r=e.shadows,s=e.shadowObjects;rg.freeArray(s),s.length=0,eg=!1;for(var a=n.models,o=0;o<a.length;o++){var h=a[o];(h.node&&(t.visibility&h.node.layer)===h.node.layer||t.visibility&h.visFlags)&&h.castShadow&&h.worldBounds&&(eg||($m.copy(h.worldBounds),eg=!0),Ia.merge($m,$m,h.worldBounds),s.push(ag(h,i)))}$m&&Ia.toBoundingSphere(r.sphere,$m)}(t,e);for(var r=0;r<n.length;r++){var s=n[r];t.shadowFrameBufferMap.has(s)||this._initShadowFrameBuffer(t,s);var a=t.shadowFrameBufferMap.get(s);i.shadowMapDirty&&this.resizeShadowMap(s,i.size);for(var o=0;o<this._stages.length;o++){var h=this._stages[o];h.setUsage(s,a),h.render(e)}}}},i.destroy=function(){e.prototype.destroy.call(this);for(var t=Array.from(this._pipeline.shadowFrameBufferMap.values()),i=0;i<t.length;i++){var n=t[i];if(n){for(var r=n.colorTextures,s=0;s<r.length;s++){var a=r[i];a&&a.destroy()}r.length=0;var o=n.depthStencilTexture;o&&o.destroy(),n.destroy()}}this._pipeline.shadowFrameBufferMap.clear(),this._shadowRenderPass&&this._shadowRenderPass.destroy(),this._globalBinding=!1},i._initShadowFrameBuffer=function(e,t){var i=e.device,n=e.shadows.size;if(!this._shadowRenderPass){var r=new Br;r.format=hn.RGBA8,r.loadOp=Ln.CLEAR,r.storeOp=Mn.STORE,r.sampleCount=1,r.beginLayout=Pn.UNDEFINED,r.endLayout=Pn.PRESENT_SRC;var s=new Fr;s.format=i.depthStencilFormat,s.depthLoadOp=Ln.CLEAR,s.depthStoreOp=Mn.STORE,s.stencilLoadOp=Ln.CLEAR,s.stencilStoreOp=Mn.STORE,s.sampleCount=1,s.beginLayout=Pn.UNDEFINED,s.endLayout=Pn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL;var a=new Dr([r],s);this._shadowRenderPass=i.createRenderPass(a)}var o=[];o.push(i.createTexture(new jr(Rn.TEX2D,In.COLOR_ATTACHMENT|In.SAMPLED,hn.RGBA8,n.x,n.y)));var h=i.createTexture(new jr(Rn.TEX2D,In.DEPTH_STENCIL_ATTACHMENT,i.depthStencilFormat,n.x,n.y)),u=i.createFramebuffer(new ur(this._shadowRenderPass,o,h));if(e.shadowFrameBufferMap.set(t,u),!this._globalBinding){var l=Po(yg),_=jo.getSampler(i,l);e.descriptorSet.bindSampler(yh,_),e.descriptorSet.bindTexture(yh,ml.get("default-texture").getGFXTexture()),e.descriptorSet.bindSampler(bh,_),e.descriptorSet.bindTexture(bh,ml.get("default-texture").getGFXTexture()),this._globalBinding=!0}t&&t.type===qp.DIRECTIONAL&&e.descriptorSet.bindTexture(yh,u.colorTextures[0])},i.resizeShadowMap=function(e,t){var i=t.x,n=t.y,r=this._pipeline;if(r.shadowFrameBufferMap.has(e)){var s=r.shadowFrameBufferMap.get(e);if(!s)return;var a=s.colorTextures;if(a&&a.length>0)for(var o=0;o<a.length;o++){var h=a[o];h&&h.resize(i,n)}var u=s.depthStencilTexture;u&&u.resize(i,n);var l=s.renderPass;s.destroy(),s.initialize(new ur(l,a,u))}},t}(of),dg.initInfo={name:"ShadowFlow",priority:zp.SHADOW,tag:Pp.SCENE,stages:[]},cg=fg))||cg),Ig=e("e2",g({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3})).LAYERED+1,Og=function(){function e(){this._fogColor=new Se("#C8C8C8"),this._colorArray=new Float32Array([.2,.2,.2,1]),this._handle=Ft,this._handle=Ci.alloc()}s(e,[{key:"enabled",set:function(e){Ci.set(this._handle,yi.ENABLE,e?1:0),e||Ci.set(this._handle,yi.TYPE,Ig),e?this.activate():this._updatePipeline()},get:function(){return Ci.get(this._handle,yi.ENABLE)}},{key:"fogColor",set:function(e){this._fogColor.set(e),Se.toArray(this._colorArray,this._fogColor),Ci.setVec4(this._handle,yi.COLOR,this._fogColor)},get:function(){return this._fogColor}},{key:"type",get:function(){return Ci.get(this._handle,yi.TYPE)},set:function(e){Ci.set(this._handle,yi.TYPE,this.enabled?e:Ig),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return Ci.get(this._handle,yi.DENSITY)},set:function(e){Ci.set(this._handle,yi.DENSITY,e)}},{key:"fogStart",get:function(){return Ci.get(this._handle,yi.START)},set:function(e){Ci.set(this._handle,yi.START,e)}},{key:"fogEnd",get:function(){return Ci.get(this._handle,yi.END)},set:function(e){Ci.set(this._handle,yi.END,e)}},{key:"fogAtten",get:function(){return Ci.get(this._handle,yi.ATTEN)},set:function(e){Ci.set(this._handle,yi.ATTEN,e)}},{key:"fogTop",get:function(){return Ci.get(this._handle,yi.TOP)},set:function(e){Ci.set(this._handle,yi.TOP,e)}},{key:"fogRange",get:function(){return Ci.get(this._handle,yi.RANGE)},set:function(e){Ci.set(this._handle,yi.RANGE,e)}},{key:"colorArray",get:function(){return this._colorArray}},{key:"handle",get:function(){return this._handle}}]);var t=e.prototype;return t.initialize=function(e){Ci.set(this._handle,yi.ENABLE,e.enabled?1:0),Ci.set(this._handle,yi.TYPE,e.enabled?e.type:Ig),this._fogColor.set(e.fogColor),Se.toArray(this._colorArray,this._fogColor),Ci.setVec4(this._handle,yi.COLOR,this._fogColor),Ci.set(this._handle,yi.DENSITY,e.fogDensity),Ci.set(this._handle,yi.START,e.fogStart),Ci.set(this._handle,yi.END,e.fogEnd),Ci.set(this._handle,yi.ATTEN,e.fogAtten),Ci.set(this._handle,yi.TOP,e.fogTop),Ci.set(this._handle,yi.RANGE,e.fogRange)},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=u.director.root,t=this.enabled?this.type:Ig,i=e.pipeline;i.macros.CC_USE_FOG!==t&&(i.macros.CC_USE_FOG=t,e.onGlobalPipelineStateChanged())},t.destroy=function(){this._handle&&(Ci.free(this._handle),this._handle=Ft)},e}();u.Fog=Og;var Ng,Cg=e("o",function(){function e(){this._skyColor=new Se(51,128,204,1),this._groundAlbedo=new Se(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1]),this._handle=Ft,this._handle=Si.alloc()}s(e,[{key:"colorArray",get:function(){return this._colorArray}},{key:"albedoArray",get:function(){return this._albedoArray}},{key:"enabled",set:function(e){Si.set(this._handle,gi.ENABLE,e?1:0)},get:function(){return Si.get(this._handle,gi.ENABLE)}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor.set(e),Se.toArray(this._colorArray,this._skyColor),Si.setVec4(this._handle,gi.SKY_COLOR,this._skyColor)}},{key:"skyIllum",get:function(){return Si.get(this._handle,gi.ILLUM)},set:function(e){Si.set(this._handle,gi.ILLUM,e)}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo.set(e),r.toArray(this._albedoArray,this._groundAlbedo),Si.setVec4(this._handle,gi.GROUND_ALBEDO,this._groundAlbedo)}},{key:"handle",get:function(){return this._handle}}]);var t=e.prototype;return t.initialize=function(e){this._skyColor.set(e.skyColor),this._groundAlbedo.set(e.groundAlbedo),Se.toArray(this._colorArray,this._skyColor),r.toArray(this._albedoArray,this._groundAlbedo),Si.setVec4(this._handle,gi.SKY_COLOR,this._skyColor),Si.setVec4(this._handle,gi.GROUND_ALBEDO,this._groundAlbedo),Si.set(this._handle,gi.ILLUM,e.skyIllum)},t.destroy=function(){this._handle&&(Si.free(this._handle),this._handle=Ft)},e}());function bg(e,t){if(!t){var i=u.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}Cg.SUN_ILLUM=65e3,Cg.SKY_ILLUM=2e4,u.Ambient=Cg,u.find=bg,function(e){e[e.positions=an.ATTR_POSITION]="positions",e[e.normals=an.ATTR_NORMAL]="normals",e[e.uvs=an.ATTR_TEX_COORD]="uvs",e[e.colors=an.ATTR_COLOR]="colors"}(Ng||(Ng={}));var wg=[new fr(an.ATTR_POSITION,hn.RGB32F),new fr(an.ATTR_NORMAL,hn.RGB32F),new fr(an.ATTR_TEX_COORD,hn.RG32F),new fr(an.ATTR_TANGENT,hn.RGBA32F),new fr(an.ATTR_COLOR,hn.RGBA32F)],Lg=new r;function Mg(e,t,i){i=i||{};var n,s=[],a=0,o=[],h=0,u=e.positions.slice();if(u.length>0){if(n=null,e.attributes)for(var l,_=R(e.attributes);!(l=_()).done;){var c=l.value;if(c.name===an.ATTR_POSITION){n=c;break}}n||(n=wg[0]),s.push(n);var d=Xn[n.format];h=Math.max(h,Math.floor(u.length/d.count)),o.push({offset:a,data:u,attribute:n}),a+=d.size}if(e.normals&&e.normals.length>0){if(n=null,e.attributes)for(var f,p=R(e.attributes);!(f=p()).done;){var m=f.value;if(m.name===an.ATTR_NORMAL){n=m;break}}n||(n=wg[1]);var g=Xn[n.format];s.push(n),h=Math.max(h,Math.floor(e.normals.length/g.count)),o.push({offset:a,data:e.normals,attribute:n}),a+=g.size}if(e.uvs&&e.uvs.length>0){if(n=null,e.attributes)for(var v,E=R(e.attributes);!(v=E()).done;){var T=v.value;if(T.name===an.ATTR_TEX_COORD){n=T;break}}n||(n=wg[2]);var A=Xn[n.format];s.push(n),h=Math.max(h,Math.floor(e.uvs.length/A.count)),o.push({offset:a,data:e.uvs,attribute:n}),a+=A.size}if(e.tangents&&e.tangents.length>0){if(n=null,e.attributes)for(var S,y=R(e.attributes);!(S=y()).done;){var I=S.value;if(I.name===an.ATTR_TANGENT){n=I;break}}n||(n=wg[3]);var O=Xn[n.format];s.push(n),h=Math.max(h,Math.floor(e.tangents.length/O.count)),o.push({offset:a,data:e.tangents,attribute:n}),a+=O.size}if(e.colors&&e.colors.length>0){if(n=null,e.attributes)for(var N,C=R(e.attributes);!(N=C()).done;){var b=N.value;if(b.name===an.ATTR_COLOR){n=b;break}}n||(n=wg[4]);var w=Xn[n.format];s.push(n),h=Math.max(h,Math.floor(e.colors.length/w.count)),o.push({offset:a,data:e.colors,attribute:n}),a+=w.size}if(e.customAttributes)for(var L,M=R(e.customAttributes);!(L=M()).done;){var P=L.value,B=Xn[P.attr.format];s.push(P.attr),h=Math.max(h,Math.floor(P.values.length/B.count)),o.push({offset:a,data:P.values,attribute:P.attr}),a+=B.size}for(var F=new _o,x=new ArrayBuffer(h*a),D=new DataView(x),U=0,G=o;U<G.length;U++){var H=G[U];po(D,H.data,H.attribute.format,H.offset,a)}F.setNextAlignment(0);var k={attributes:s,view:{offset:F.getLength(),length:x.byteLength,count:h,stride:a}};F.addBuffer(x);var z=null,V=0;if(e.indices){var W=e.indices;V=W.length,z=new ArrayBuffer(2*V),po(new DataView(z),W,hn.R16UI)}var Y={primitiveMode:e.primitiveMode||dn.TRIANGLE_LIST,vertexBundelIndices:[0]};z&&(F.setNextAlignment(2),Y.indexView={offset:F.getLength(),length:z.byteLength,count:V,stride:2},F.addBuffer(z));var X=e.minPos;if(!X&&i.calculateBounds){X=r.set(new r,1/0,1/0,1/0);for(var j=0;j<h;++j)r.set(Lg,u[3*j+0],u[3*j+1],u[3*j+2]),r.min(X,X,Lg)}var K=e.maxPos;if(!K&&i.calculateBounds){K=r.set(new r,-1/0,-1/0,-1/0);for(var Z=0;Z<h;++Z)r.set(Lg,u[3*Z+0],u[3*Z+1],u[3*Z+2]),r.max(K,K,Lg)}var Q={vertexBundles:[k],primitives:[Y]};return X&&(Q.minPosition=new r(X.x,X.y,X.z)),K&&(Q.maxPosition=new r(K.x,K.y,K.z)),t||(t=new yu),t.reset({struct:Q,data:new Uint8Array(F.getCombined())}),t}function Pg(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function Bg(e){var t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,s=(e.width||1)/2,a=(e.height||1)/2,o=(e.length||1)/2,h=[r.set(jg,-s,-a,o),r.set(Kg,s,-a,o),r.set(Zg,s,a,o),r.set(Qg,-s,a,o),r.set(qg,s,-a,-o),r.set(Jg,-s,-a,-o),r.set($g,-s,a,-o),r.set(ev,s,a,-o)],u=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],_=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],c=[],d=[],f=[],p=[],m=[],g=new r(-s,-a,-o),v=new r(s,a,o),E=Math.sqrt(s*s+a*a+o*o);function T(e,t,i){var n,s,a,o,g=c.length/3,v=u[e],E=l[e],T=_[e];for(o=0;o<=i;o++)for(a=0;a<=t;a++)if(n=a/t,s=o/i,r.lerp(Vg,h[v[0]],h[v[1]],n),r.lerp(Wg,h[v[0]],h[v[2]],s),r.subtract(Yg,Wg,h[v[0]]),r.add(Xg,Vg,Yg),c.push(Xg.x,Xg.y,Xg.z),d.push(E[0],E[1],E[2]),f.push(n,s),p.push(T[0],T[1],T[2],T[3]),a<t&&o<i){var A=t+1,S=a+o*A,y=a+(o+1)*A,R=a+1+(o+1)*A,I=a+1+o*A;m.push(g+S,g+I,g+y),m.push(g+y,g+I,g+R)}}return T(0,t,i),T(4,n,i),T(1,t,i),T(5,n,i),T(3,t,n),T(2,t,n),{positions:c,normals:d,uvs:f,tangents:p,indices:m,minPos:g,maxPos:v,boundingRadius:E}}var Fg,xg,Dg,Ug,Gg,Hg,kg,zg,Vg=new r,Wg=new r,Yg=new r,Xg=new r,jg=new r,Kg=new r,Zg=new r,Qg=new r,qg=new r,Jg=new r,$g=new r,ev=new r,tv=new r(0,0,0),iv=new r(0,0,0),nv=new r(0,0,0),rv=new r(0,0,0),sv=new r(0,0,0),av=new r(0,0,0),ov=new r(0,0,0),hv=new r(0,0,0),uv=new r(0,0,0),lv=new r(0,0,0),_v=new r(0,0,0),cv=null,dv=null,fv=e("T",function(){function e(){this._envmap=null,this._globalDescriptorSet=null,this._model=null,this._default=null,this._handle=Ft,this._handle=Ii.alloc()}s(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return Ii.get(this._handle,Ai.ENABLE)},set:function(e){e?this.activate():this._updatePipeline(),Ii.set(this._handle,Ai.ENABLE,e?1:0)}},{key:"useIBL",get:function(){return Ii.get(this._handle,Ai.USE_IBL)},set:function(e){Ii.set(this._handle,Ai.USE_IBL,e?1:0),this._updatePipeline()}},{key:"isRGBE",get:function(){return Ii.get(this._handle,Ai.IS_RGBE)},set:function(e){e&&(dv&&dv.recompileShaders({USE_RGBE_CUBEMAP:e}),this._model&&this._model.setSubModelMaterial(0,dv)),Ii.set(this._handle,Ai.IS_RGBE,e?1:0),this._updatePipeline()}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e||this._default,this._envmap&&(u.director.root.pipeline.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}},{key:"handle",get:function(){return this._handle}}]);var t=e.prototype;return t.initialize=function(e){Ii.set(this._handle,Ai.ENABLE,e.enabled?1:0),Ii.set(this._handle,Ai.USE_IBL,e.useIBL?1:0),Ii.set(this._handle,Ai.IS_RGBE,e.isRGBE?1:0),this._envmap=e.envmap},t.activate=function(){var e=u.director.root.pipeline;if(this._globalDescriptorSet=e.descriptorSet,this._default=ml.get("default-cube-texture"),this._model||(this._model=u.director.root.createModel(u.renderer.scene.Model),this._model._initLocalDescriptors=function(){}),Ii.set(this._handle,Ai.MODEL,this._model.handle),this._envmap||(this._envmap=this._default),e.ambient.groundAlbedo[3]=this._envmap.mipmapLevel,dv)dv.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{var t=new a_;t.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),dv=new I_({parent:t})}cv||(cv=Mg(Bg({width:2,height:2,length:2}))),this._model.initSubModel(0,cv.renderingSubMeshes[0],dv),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=this.useIBL?this.isRGBE?2:1:0,t=u.director.root,i=t.pipeline;i.macros.CC_USE_IBL!==e&&(i.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())},t._updateGlobalBinding=function(){var e=this.envmap.getGFXTexture(),t=jo.getSampler(u.director._device,this.envmap.getSamplerHash());this._globalDescriptorSet.bindSampler(Oh,t),this._globalDescriptorSet.bindTexture(Oh,e)},t.destroy=function(){this._handle&&(Ii.free(this._handle),this._handle=Ft)},e}());u.Skybox=fv;var pv,mv,gv,vv,Ev,Tv,Av,Sv,yv,Rv,Iv,Ov,Nv,Cv,bv=[],wv=e("dL",(Fg=I("UIStage"),xg=U([Vp]),Dg=te(),Fg((zg=kg=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,b(t,"renderQueues",Hg,B(t)),t._renderQueues=[],t._renderArea=new gr,t}a(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var n=0;n<this.renderQueues.length;n++){for(var r=0,s=0;s<this.renderQueues[n].stages.length;s++)r|=gl(this.renderQueues[n].stages[s]);var a=Yp;switch(this.renderQueues[n].sortMode){case Fp.BACK_TO_FRONT:a=Xp;break;case Fp.FRONT_TO_BACK:a=Yp}this._renderQueues[n]=new jp({isTransparent:this.renderQueues[n].isTransparent,phases:r,sortFunc:a})}},i.destroy=function(){},i.render=function(e){var t=this._pipeline,i=t.isHDR;t.isHDR=!1;var n=t.device;this._renderQueues[0].clear();for(var r=t.renderObjects,s=0;s<r.length;s++)for(var a=r[s],o=a.model.subModels,h=0;h<o.length;h++)for(var u=o[h].passes,l=0;l<u.length;l++)this._renderQueues[0].insertRenderPass(a,h,l);this._renderQueues[0].sort();var _=e.camera,c=_.viewport,d=e.window.hasOnScreenAttachments&&n.surfaceTransform%2?_.height:_.width,f=e.window.hasOnScreenAttachments&&n.surfaceTransform%2?_.width:_.height;this._renderArea.x=c.x*d,this._renderArea.y=c.y*f,this._renderArea.width=c.width*d,this._renderArea.height=c.height*f,bv[0]=_.clearColor;var p=t.commandBuffers[0],m=e.window.framebuffer,g=m.colorTextures[0]?m.renderPass:t.getRenderPass(_.clearFlag);p.beginRenderPass(g,m,this._renderArea,bv,_.clearDepth,_.clearStencil),p.bindDescriptorSet(gh.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,p),p.endRenderPass(),t.isHDR=i},t}(Qd),kg.initInfo={name:"UIStage",priority:kp.UI,tag:0,renderQueues:[{isTransparent:!0,stages:["default"],sortMode:Fp.BACK_TO_FRONT}]},Hg=O((Gg=zg).prototype,"renderQueues",[xg,N,Dg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ug=Gg))||Ug)),Lv=e("dK",I("UIFlow")((gv=mv=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new wv;i.initialize(wv.initInfo),this._stages.push(i)}return!0},i.destroy=function(){e.prototype.destroy.call(this)},i.render=function(t){this._pipeline.updateUBOs(t),e.prototype.render.call(this,t)},t}(of),mv.initInfo={name:"UIFlow",priority:zp.UI,tag:Pp.UI,stages:[]},pv=gv))||pv),Mv=new _,Pv=new _,Bv=new r,Fv=(e("dF",(vv=I("ForwardPipeline"),Ev=U([xp]),Tv=te(),Av=U([Dp]),Sv=te(),vv((Nv=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,b(t,"renderTextures",Iv,B(t)),b(t,"materials",Ov,B(t)),t.fog=new Og,t.ambient=new Cg,t.skybox=new fv,t.shadows=new vm,t.renderObjects=[],t.shadowObjects=[],t.shadowFrameBufferMap=new Map,t._isHDR=!1,t._shadingScale=1,t._fpScale=1/1024,t._renderPasses=new Map,t._globalUBO=new Float32Array(Ah.COUNT),t._shadowUBO=new Float32Array(Sh.COUNT),t}a(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new Rg;i.initialize(Rg.initInfo),this._flows.push(i);var n=new Gm;n.initialize(Gm.initInfo),this._flows.push(n);var r=new Lv;r.initialize(Lv.initInfo),this._flows.push(r),r.activate(this)}return!0},i.activate=function(){return this._macros={},!(!e.prototype.activate.call(this)||!this._activeRenderer()&&(console.error("ForwardPipeline startup failed!"),1))},i.render=function(e){this._commandBuffers[0].begin();for(var t=0;t<e.length;t++){var i=e[t];hg(this,i);for(var n=0;n<i.flows.length;n++)i.flows[n].render(i)}this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)},i.getRenderPass=function(e){var t=this._renderPasses.get(e);if(t)return t;var i=this.device,n=new Br,r=new Fr;n.format=i.colorFormat,r.format=i.depthStencilFormat,e&Un.COLOR||(e&Xm?n.loadOp=Ln.DISCARD:(n.loadOp=Ln.LOAD,n.beginLayout=Pn.PRESENT_SRC)),(e&Un.DEPTH_STENCIL)!==Un.DEPTH_STENCIL&&(e&Un.DEPTH||(r.depthLoadOp=Ln.LOAD),e&Un.STENCIL||(r.stencilLoadOp=Ln.LOAD),r.beginLayout=Pn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL);var s=new Dr([n],r);return t=i.createRenderPass(s),this._renderPasses.set(e,t),t},i.updateUBOs=function(e){this._updateUBO(e);var t=e.camera.scene.mainLight,i=this.device,n=this.shadows;if(t&&n.enabled&&n.type===mm.ShadowMap){var s,a=0,o=0,h=0;if(n.autoAdapt){var u;s=og(this,null===(u=t.node)||void 0===u?void 0:u.getWorldRotation(),t.direction,Bv);var l=n.sphere.radius;a=l*n.aspect,o=l;var c=r.distance(n.sphere.center,Bv);h=Math.min(c*vm.COEFFICIENT_OF_EXPANSION,vm.MAX_FAR)}else s=t.node.getWorldMatrix(),a=n.orthoSize*n.aspect,o=n.orthoSize,h=n.far;_.invert(Mv,s);var d=i.screenSpaceSignY*i.UVSpaceSignY;_.ortho(Pv,-a,a,-o,o,n.near,h,i.clipSpaceMinZ,d),_.multiply(Pv,Pv,Mv),_.toArray(this._shadowUBO,Pv,Sh.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Sh.SHADOW_INFO_OFFSET]=n.size.x,this._shadowUBO[Sh.SHADOW_INFO_OFFSET+1]=n.size.y,this._shadowUBO[Sh.SHADOW_INFO_OFFSET+2]=n.pcf,this._shadowUBO[Sh.SHADOW_INFO_OFFSET+3]=n.bias}else t&&n.type===mm.Planar&&function(e,t,i){var n=t.direction,s=e.normal,a=e.distance+.001,o=1/r.dot(s,n),h=n.x*o,u=n.y*o,l=n.z*o,c=s.x,d=s.y,f=s.z,p=e.matLight;p.m00=1-c*h,p.m01=-c*u,p.m02=-c*l,p.m03=0,p.m04=-d*h,p.m05=1-d*u,p.m06=-d*l,p.m07=0,p.m08=-f*h,p.m09=-f*u,p.m10=1-f*l,p.m11=0,p.m12=h*a,p.m13=u*a,p.m14=l*a,p.m15=1,_.toArray(i,p,Sh.MAT_LIGHT_PLANE_PROJ_OFFSET)}(n,t,this._shadowUBO);Se.toArray(this._shadowUBO,n.shadowColor,Sh.SHADOW_COLOR_OFFSET),this._commandBuffers[0].updateBuffer(this._descriptorSet.getBuffer(Ah.BINDING),this._globalUBO),this._commandBuffers[0].updateBuffer(this._descriptorSet.getBuffer(Sh.BINDING),this._shadowUBO)},i._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=e.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,Ah.SIZE,Ah.SIZE));this._descriptorSet.bindBuffer(Ah.BINDING,t);var i=e.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,Sh.SIZE,Sh.SIZE));return this._descriptorSet.bindBuffer(Sh.BINDING,i),this._descriptorSet.update(),this.macros.CC_USE_HDR=this._isHDR,this.macros.CC_SUPPORT_FLOAT_TEXTURE=this.device.hasFeature(zn.TEXTURE_FLOAT),!0},i._updateUBO=function(e){this._descriptorSet.update();var t=u.director.root,i=e.camera,n=i.scene.mainLight,s=this.ambient,a=this.fog,o=this._globalUBO,h=this.device,l=Math.floor(h.width),c=Math.floor(h.height);o[Ah.TIME_OFFSET]=t.cumulativeTime,o[Ah.TIME_OFFSET+1]=t.frameTime,o[Ah.TIME_OFFSET+2]=u.director.getTotalFrames(),o[Ah.SCREEN_SIZE_OFFSET]=h.width,o[Ah.SCREEN_SIZE_OFFSET+1]=h.height,o[Ah.SCREEN_SIZE_OFFSET+2]=1/o[Ah.SCREEN_SIZE_OFFSET],o[Ah.SCREEN_SIZE_OFFSET+3]=1/o[Ah.SCREEN_SIZE_OFFSET+1],o[Ah.SCREEN_SCALE_OFFSET]=i.width/l*this.shadingScale,o[Ah.SCREEN_SCALE_OFFSET+1]=i.height/c*this.shadingScale,o[Ah.SCREEN_SCALE_OFFSET+2]=1/o[Ah.SCREEN_SCALE_OFFSET],o[Ah.SCREEN_SCALE_OFFSET+3]=1/o[Ah.SCREEN_SCALE_OFFSET+1],o[Ah.NATIVE_SIZE_OFFSET]=l,o[Ah.NATIVE_SIZE_OFFSET+1]=c,o[Ah.NATIVE_SIZE_OFFSET+2]=1/o[Ah.NATIVE_SIZE_OFFSET],o[Ah.NATIVE_SIZE_OFFSET+3]=1/o[Ah.NATIVE_SIZE_OFFSET+1],_.toArray(o,i.matView,Ah.MAT_VIEW_OFFSET),_.toArray(o,i.node.worldMatrix,Ah.MAT_VIEW_INV_OFFSET),_.toArray(o,i.matProj,Ah.MAT_PROJ_OFFSET),_.toArray(o,i.matProjInv,Ah.MAT_PROJ_INV_OFFSET),_.toArray(o,i.matViewProj,Ah.MAT_VIEW_PROJ_OFFSET),_.toArray(o,i.matViewProjInv,Ah.MAT_VIEW_PROJ_INV_OFFSET),r.toArray(o,i.position,Ah.CAMERA_POS_OFFSET);var d=h.screenSpaceSignY;e.window.hasOffScreenAttachments&&(d*=h.UVSpaceSignY),o[Ah.CAMERA_POS_OFFSET+3]=d;var p=i.exposure;if(o[Ah.EXPOSURE_OFFSET]=p,o[Ah.EXPOSURE_OFFSET+1]=1/p,o[Ah.EXPOSURE_OFFSET+2]=this._isHDR?1:0,o[Ah.EXPOSURE_OFFSET+3]=this._fpScale/p,n){if(r.toArray(o,n.direction,Ah.MAIN_LIT_DIR_OFFSET),r.toArray(o,n.color,Ah.MAIN_LIT_COLOR_OFFSET),n.useColorTemperature){var m=n.colorTemperatureRGB;o[Ah.MAIN_LIT_COLOR_OFFSET]*=m.x,o[Ah.MAIN_LIT_COLOR_OFFSET+1]*=m.y,o[Ah.MAIN_LIT_COLOR_OFFSET+2]*=m.z}this._isHDR?o[Ah.MAIN_LIT_COLOR_OFFSET+3]=n.illuminance*this._fpScale:o[Ah.MAIN_LIT_COLOR_OFFSET+3]=n.illuminance*p}else r.toArray(o,r.UNIT_Z,Ah.MAIN_LIT_DIR_OFFSET),f.toArray(o,f.ZERO,Ah.MAIN_LIT_COLOR_OFFSET);var g=s.colorArray;this._isHDR?g[3]=s.skyIllum*this._fpScale:g[3]=s.skyIllum*p,o.set(g,Ah.AMBIENT_SKY_OFFSET),o.set(s.albedoArray,Ah.AMBIENT_GROUND_OFFSET),a.enabled&&(o.set(a.colorArray,Ah.GLOBAL_FOG_COLOR_OFFSET),o[Ah.GLOBAL_FOG_BASE_OFFSET]=a.fogStart,o[Ah.GLOBAL_FOG_BASE_OFFSET+1]=a.fogEnd,o[Ah.GLOBAL_FOG_BASE_OFFSET+2]=a.fogDensity,o[Ah.GLOBAL_FOG_ADD_OFFSET]=a.fogTop,o[Ah.GLOBAL_FOG_ADD_OFFSET+1]=a.fogRange,o[Ah.GLOBAL_FOG_ADD_OFFSET+2]=a.fogAtten)},i.destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Ah.BINDING).destroy(),this._descriptorSet.getBuffer(Sh.BINDING).destroy())},i.destroy=function(){this.destroyUBOs();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),e.prototype.destroy.call(this)},s(t,[{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR!==e&&(this._isHDR=e,this._globalUBO[Ah.EXPOSURE_OFFSET+2]=this._isHDR?1:0)}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"fpScale",get:function(){return this._fpScale}},{key:"shadowUBO",get:function(){return this._shadowUBO}}]),t}(Bp),Iv=O((Rv=Nv).prototype,"renderTextures",[Ev,N,Tv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ov=O(Rv.prototype,"materials",[Av,N,Sv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yv=Rv))||yv)),new wt(Ct.ATTRIBUTE,(function(e,t){return t||new fr}))),xv=new _,Dv=new Ae((function(){return new Zd}),32),Uv=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.UI_BATCH=3]="UI_BATCH",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Cv||(Cv=e("H",{})));var Gv=Po([Sn.LINEAR,Sn.LINEAR,Sn.NONE,yn.CLAMP,yn.CLAMP,yn.CLAMP]),Hv=Po([Sn.LINEAR,Sn.LINEAR,Sn.LINEAR,yn.CLAMP,yn.CLAMP,yn.CLAMP]),kv=e("K",function(){function e(){this.type=Cv.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._handle=Ft,this._hWorldBounds=Ft,this._localData=new Float32Array(Mh.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new f,this._device=u.director.root.device}s(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return!!ei.get(this._handle,Zt.RECEIVE_SHADOW)},set:function(e){ei.set(this._handle,Zt.RECEIVE_SHADOW,e?1:0),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return!!ei.get(this._handle,Zt.CAST_SHADOW)},set:function(e){ei.set(this._handle,Zt.CAST_SHADOW,e?1:0)}},{key:"handle",get:function(){return this._handle}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,ei.set(this._handle,Zt.NODE,e.handle)}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e,ei.set(this._handle,Zt.TRANSFORM,e.handle)}},{key:"visFlags",get:function(){return ei.get(this._handle,Zt.VIS_FLAGS)},set:function(e){ei.set(this._handle,Zt.VIS_FLAGS,e)}},{key:"enabled",get:function(){return!!ei.get(this._handle,Zt.ENABLED)},set:function(e){ei.set(this._handle,Zt.ENABLED,e?1:0)}}]);var t=e.prototype;return t.initialize=function(){if(!this._inited){this._handle=ei.alloc();var e=Ht.alloc(),t=zt.alloc();ei.set(this._handle,Zt.INSTANCED_ATTR_ARRAY,t),ei.set(this._handle,Zt.SUB_MODEL_ARRAY,e),ei.set(this._handle,Zt.VIS_FLAGS,lh.Enum.NONE),ei.set(this._handle,Zt.ENABLED,1),ei.set(this._handle,Zt.RECEIVE_SHADOW,1),ei.set(this._handle,Zt.CAST_SHADOW,0),this._inited=!0}},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var i=this._subModels[t];i.destroy(),Dv.free(i)}if(this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._handle){var n=ei.get(this._handle,Zt.SUB_MODEL_ARRAY);n&&Ht.free(n);var r=ei.get(this._handle,Zt.INSTANCED_BUFFER);r&&Yt.free(r);var s=ei.get(this._handle,Zt.INSTANCED_ATTR_ARRAY);s&&Pt(s,zt,Fv),ei.free(this._handle),this._handle=Ft}this._hWorldBounds&&(ni.free(this._hWorldBounds),this._hWorldBounds=Ft)},t.attachToScene=function(e){this.scene=e},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._transformUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&(this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t),ni.setVec3(this._hWorldBounds,Jt.CENTER,t.center),ni.setVec3(this._hWorldBounds,Jt.HALF_EXTENSION,t.halfExtents))}},t.updateUBOs=function(e){for(var t=this._subModels,i=0;i<t.length;i++)t[i].update();if(this._updateStamp=e,this._transformUpdated){this._transformUpdated=!1;var n=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var s=this.instancedAttributes.views;!function(e,t,i,n){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,i[0]=e.m04,i[1]=e.m05,i[2]=e.m06,i[3]=e.m13,n[0]=e.m08,n[1]=e.m09,n[2]=e.m10,n[3]=e.m14}(n,s[r],s[r+1],s[r+2])}else this._localBuffer&&(_.toArray(this._localData,n,Mh.MAT_WORLD_OFFSET),_.inverseTranspose(xv,n),_.toArray(this._localData,xv,Mh.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=Ia.fromPoints(Ia.create(),e,t),this._worldBounds=Ia.clone(this._modelBounds),this._hWorldBounds===Ft&&(this._hWorldBounds=ni.alloc(),ei.set(this._handle,Zt.WORLD_BOUNDS,this._hWorldBounds)),ni.setVec3(this._hWorldBounds,Jt.CENTER,this._worldBounds.center),ni.setVec3(this._hWorldBounds,Jt.HALF_EXTENSION,this._worldBounds.halfExtents))},t.initSubModel=function(e,t,i){this.initialize();var n=!1;if(null==this._subModels[e]?(this._subModels[e]=Dv.alloc(),n=!0):this._subModels[e].destroy(),this._subModels[e].initialize(t,i.passes,this.getMacroPatches(e)),this._updateAttributesAndBinding(e),n){var r=ei.get(this._handle,Zt.SUB_MODEL_ARRAY);Ht.assign(r,e,this._subModels[e].handle)}},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){f.toArray(this._localData,t,Mh.LIGHTINGMAP_UVPARAM),this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=ml.get("empty-texture"));var i=e.getGFXTexture();if(i)for(var n=jo.getSampler(this._device,e.mipmaps.length>1?Hv:Gv),r=this._subModels,s=0;s<r.length;s++){var a=r[s].descriptorSet;a.bindTexture(qh,i),a.bindSampler(qh,n),a.update()}},t.getMacroPatches=function(){return this.receiveShadow?Uv:null},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet);var i=xt.get(qt.get(t.handle,Xt.SHADER_0));this._updateInstancedAttributes(i.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,i=0;i<t.length;i++)if(t[i].name===e)return i;return-1},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(zn.INSTANCED_ARRAYS)){var i=ei.get(this._handle,Zt.INSTANCED_BUFFER);i&&Yt.free(i);var n=ei.get(this._handle,Zt.INSTANCED_ATTR_ARRAY);n&&Pt(n,zt,Fv,!1);for(var r=0,s=0;s<e.length;s++){var a=e[s];a.isInstanced&&(r+=Xn[a.format].size)}var o=Yt.alloc(r),h=Yt.getBuffer(o);ei.set(this._handle,Zt.INSTANCED_BUFFER,o);var u=this.instancedAttributes;u.buffer=new Uint8Array(h),u.views.length=u.attributes.length=0;for(var l=0,_=0;_<e.length;_++){var c=e[_];if(c.isInstanced){var d=Fv.alloc(),f=Fv.get(d);f.format=c.format,f.name=c.name,f.isNormalized=c.isNormalized,f.location=c.location,u.attributes.push(f),zt.push(n,d);var p=Xn[c.format];u.views.push(new(qn(p))(h,l,p.count)),l+=p.size}}t.batchingScheme===fl.INSTANCING&&Jp.get(t).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex("a_matWorld0"),this._transformUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,Mh.SIZE,Mh.SIZE)))},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(Mh.BINDING,this._localBuffer)},e}()),zv=e("n",function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}a(t,e);var i=t.prototype;return i.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):void 0},i.initSubModel=function(t,i,n){return e.prototype.initSubModel.call(this,t,i,this._launderMaterial(n))},i.setSubModelMaterial=function(t,i){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(i))},i._updateLocalDescriptors=function(t,i){e.prototype._updateLocalDescriptors.call(this,t,i),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,i)},i._launderMaterial=function(e){return e},i.setMorphRendering=function(e){this._morphRenderingInstance=e},t}(kv)),Vv=[],Wv=new Map,Yv=[{name:"CC_USE_SKINNING",value:!0}];function Xv(e,t){for(var i=0,n=_.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){n=e.world,e.stamp=t;break}e.stamp=t,Vv[i++]=e,e=e.parent}for(;i>0;){var r=(e=Vv[--i]).node;_.fromRTS(e.local,r.rotation,r.position,r.scale),n=_.multiply(e.world,n,e.local)}return n}function jv(e,t){for(var i,n=null,r=0;e!==t;){var s=e.uuid;if(Wv.has(s)){n=Wv.get(s);break}n={node:e,local:new _,world:new _,stamp:-1,parent:null},Wv.set(s,n),Vv[r++]=n,e=e.parent,n=null}for(;r>0;)(i=Vv[--r]).parent=n,n=i;return n}function Kv(e){for(var t=Wv.get(e.uuid)||null;t;)Wv.delete(t.node.uuid),t=t.parent}function Zv(e,t,i,n){for(var r=0;r<i.length;r++){for(var s=i[r],a=-1,o=0;o<s.length;o++)if(s[o]===n){a=o;break}a>=0&&(t.push(r),e.push(a))}}var Qv=new r,qv=new r,Jv=new r,$v=new r,eE=new _,tE=new Ia,iE=(e("S",function(e){function t(){var t;return(t=e.call(this)||this).uploadAnimation=null,t._buffers=[],t._dataArray=[],t._joints=[],t._bufferIndices=null,t.type=Cv.SKINNING,t}a(t,e);var i=t.prototype;return i.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}e.prototype.destroy.call(this)},i.bindSkeleton=function(e,t,i){void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null);for(var n=0;n<this._joints.length;n++)Kv(this._joints[n].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&i){this.transform=t;var r=i.getBoneSpaceBounds(e),s=i.struct.jointMaps;this._ensureEnoughBuffers(s&&s.length||1),this._bufferIndices=i.jointBufferIndices;for(var a=0;a<e.joints.length;a++){var o=r[a],h=t.getChildByPath(e.joints[a]);if(o&&h){var u=jv(h,t),l=e.bindposes[a],_=[],c=[];s?Zv(_,c,s,a):(_.push(a),c.push(0)),this._joints.push({indices:_,buffers:c,bound:o,target:h,bindpose:l,transform:u})}}}},i.updateTransform=function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0),r.set(Qv,1/0,1/0,1/0),r.set(qv,-1/0,-1/0,-1/0);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],s=n.bound,a=Xv(n.transform,e);Ia.transform(tE,s,a),tE.getBoundary(Jv,$v),r.min(Qv,Qv,Jv),r.max(qv,qv,$v)}var o=this._worldBounds;this._modelBounds&&o&&(Ia.fromPoints(this._modelBounds,Qv,qv),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds),ni.setVec3(this._hWorldBounds,Jt.CENTER,o.center),ni.setVec3(this._hWorldBounds,Jt.HALF_EXTENSION,o.halfExtents))},i.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.indices,s=n.buffers,a=n.transform,o=n.bindpose;_.multiply(eE,a.world,o);for(var h=0;h<s.length;h++)cd(this._dataArray[s[h]],12*r[h],eE)}for(var u=0;u<this._buffers.length;u++)this._buffers[u].update(this._dataArray[u]);return!0},i.initSubModel=function(t,i,n){var r=i.vertexBuffers,s=i.iaInfo;s.vertexBuffers=i.jointMappedBuffers,e.prototype.initSubModel.call(this,t,i,n),s.vertexBuffers=r},i.getMacroPatches=function(t){var i=e.prototype.getMacroPatches.call(this,t);return i?Yv.concat(i):Yv},i._updateLocalDescriptors=function(t,i){e.prototype._updateLocalDescriptors.call(this,t,i);var n=this._buffers[this._bufferIndices[t]];n&&i.bindBuffer(Dh.BINDING,n)},i._ensureEnoughBuffers=function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,Dh.SIZE,Dh.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(Dh.COUNT))},t}(zv)),[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}]),nE=(e("m",function(e){function t(){var t;(t=e.call(this)||this).uploadedAnim=void 0,t._jointsMedium=void 0,t._skeleton=null,t._mesh=null,t._dataPoolManager=void 0,t._instAnimInfoIdx=-1,t.type=Cv.BAKED_SKINNING,t._dataPoolManager=u.director.root.dataPoolManager;var i=new Float32Array(4),n=t._dataPoolManager.jointAnimationInfo.getData();return t._jointsMedium={buffer:null,jointTextureInfo:i,animInfo:n,texture:null,boundsInfo:null},t}a(t,e);var i=t.prototype;return i.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),e.prototype.destroy.call(this)},i.bindSkeleton=function(e,t,i){if(void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null),this._skeleton=e,this._mesh=i,e&&t&&i){this.transform=t;var n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new tr(un.UNIFORM|un.TRANSFER_DST,ln.HOST|ln.DEVICE,Fh.SIZE,Fh.SIZE)))}},i.updateTransform=function(t){if(e.prototype.updateTransform.call(this,t),this.uploadedAnim){var i=this._jointsMedium,n=i.animInfo,r=i.boundsInfo[n.data[0]],s=this._worldBounds;if(s&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,s),ni.setVec3(this._hWorldBounds,Jt.CENTER,s.center),ni.setVec3(this._hWorldBounds,Jt.HALF_EXTENSION,s.halfExtents)}}},i.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);var i=this._jointsMedium.animInfo,n=this._instAnimInfoIdx;return n>=0?this.instancedAttributes.views[n][0]=i.data[0]:i.dirty&&(i.buffer.update(i.data),i.dirty=!1),!0},i.uploadAnimation=function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,i=null;e?(i=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._modelBounds=null):(i=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._modelBounds=i&&i.bounds.get(this._mesh.hash)[0]),this._applyJointTexture(i)}},i._applyJointTexture=function(e){void 0===e&&(e=null);var t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,e){var i=this._jointsMedium,n=i.buffer,r=i.jointTextureInfo;r[0]=e.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=e.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),n&&n.update(r);for(var s=e.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(Gh,s)}},i.getMacroPatches=function(t){var i=e.prototype.getMacroPatches.call(this,t);return i?i.concat(iE):iE},i._updateLocalDescriptors=function(t,i){e.prototype._updateLocalDescriptors.call(this,t,i);var n=this._jointsMedium,r=n.buffer,s=n.texture,a=n.animInfo;if(i.bindBuffer(Fh.BINDING,r),i.bindBuffer(xh.BINDING,a.buffer),s){var o=jo.getSampler(this._device,Gd);i.bindTexture(Gh,s.handle.texture),i.bindSampler(Gh,o)}},i._updateInstancedAttributes=function(t,i){e.prototype._updateInstancedAttributes.call(this,t,i),this._instAnimInfoIdx=this._getInstancedAttributeIndex("a_jointAnimInfo"),this.updateInstancedJointTextureInfo()},i.updateInstancedJointTextureInfo=function(){var e=this._jointsMedium,t=e.jointTextureInfo,i=e.animInfo,n=this._instAnimInfoIdx;if(n>=0){var r=this.instancedAttributes.views[n];r[0]=i.data[0],r[1]=t[1],r[2]=t[2]}},t}(zv)),e("R",function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._scenePoolHandle=Ft,this._modelArrayHandle=Ft,this._sphereLightsHandle=Ft,this._spotLightsHandle=Ft,this._root=e,this._createHandles()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}},s(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"rayResultCanvas",get:function(){return dE}},{key:"rayResultModels",get:function(){return lE}},{key:"rayResultAll",get:function(){return fE}},{key:"rayResultSingleModel",get:function(){return pE}},{key:"handle",get:function(){return this._scenePoolHandle}}]);var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._createHandles(),!0},t.update=function(e){var t=this._mainLight;t&&t.update();for(var i=this._sphereLights,n=0;n<i.length;n++)i[n].update();for(var r=this._spotLights,s=0;s<r.length;s++)r[s].update();for(var a=this._models,o=0;o<a.length;o++){var h=a[o];h.enabled&&(h.updateTransform(e),h.updateUBOs(e))}},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._modelArrayHandle&&(kt.free(this._modelArrayHandle),this._modelArrayHandle=Ft),this._scenePoolHandle&&(ai.free(this._scenePoolHandle),this._scenePoolHandle=Ft),this._sphereLightsHandle&&(Wt.free(this._sphereLightsHandle),this._sphereLightsHandle=Ft),this._spotLightsHandle&&(Wt.free(this._spotLightsHandle),this._spotLightsHandle=Ft)},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=R(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e,ai.set(this._scenePoolHandle,ti.MAIN_LIGHT,e.handle)},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;t.length?(this._mainLight=t[t.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Cc.ROTATION)):this._mainLight=null}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e),Wt.push(this._sphereLightsHandle,e.handle)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),this._sphereLights.splice(t,1),void Wt.erase(this._sphereLightsHandle,t)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e),Wt.push(this._spotLightsHandle,e.handle)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),this._spotLights.splice(t,1),void Wt.erase(this._spotLightsHandle,t)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0,Wt.clear(this._sphereLightsHandle)},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[],Wt.clear(this._spotLightsHandle)},t.addModel=function(e){e.attachToScene(this),this._models.push(e),kt.push(this._modelArrayHandle,e.handle)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),this._models.splice(t,1),void kt.erase(this._modelArrayHandle,t)},t.removeModels=function(){for(var e,t=R(this._models);!(e=t()).done;){var i=e.value;i.detachFromScene(),i.destroy()}this._models.length=0,kt.clear(this._modelArrayHandle)},t.onGlobalPipelineStateChanged=function(){for(var e,t=R(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t.raycastAll=function(e,t,i){void 0===t&&(t=lh.Enum.DEFAULT|lh.Enum.UI_2D),void 0===i&&(i=1/0);var n=this.raycastAllModels(e,t,i),r=this.raycastAllCanvas(e,t,i),s=n||r;return fE.length=0,s&&(Array.prototype.push.apply(fE,lE),Array.prototype.push.apply(fE,dE)),s},t.raycastAllModels=function(e,t,i){void 0===t&&(t=lh.Enum.DEFAULT),void 0===i&&(i=1/0),uE.reset();for(var n,s=R(this._models);!(n=s()).done;){var a=n.value,o=a.transform;if(o&&a.enabled&&a.node.layer&t&~lh.Enum.IGNORE_RAYCAST&&a.worldBounds){var h=ca.rayAABB(e,a.worldBounds);if(!(h<=0||h>=i)){if(a.type===Cv.DEFAULT){_.invert(aE,o.getWorldMatrix(aE)),r.transformMat4(rE.o,e.o,aE),r.normalize(rE.d,r.transformMat4Normal(rE.d,e.d,aE)),h=1/0;for(var u=a.subModels,l=0;l<u.length;++l){var c=u[l].subMesh;if(c&&c.geometricInfo){var d=c.geometricInfo,f=d.positions,p=d.indices,m=d.doubleSided;mE(f,p,c.primitiveMode,m,i),h=Math.min(h,oE*r.multiply(sE,rE.d,o.worldScale).length())}}}if(h<i){var g=uE.add();g.node=a.node,g.distance=h,lE[uE.length-1]=g}}}}return lE.length=uE.length,lE.length>0},t.raycastSingleModel=function(e,t,i,n){void 0===i&&(i=lh.Enum.DEFAULT),void 0===n&&(n=1/0),uE.reset();var s=t,a=s.transform;if(!(a&&s.enabled&&s.node.layer&i&~lh.Enum.IGNORE_RAYCAST&&s.worldBounds))return!1;var o=ca.rayAABB(e,s.worldBounds);if(o<=0||o>=n)return!1;if(s.type===Cv.DEFAULT){_.invert(aE,a.getWorldMatrix(aE)),r.transformMat4(rE.o,e.o,aE),r.normalize(rE.d,r.transformMat4Normal(rE.d,e.d,aE)),o=1/0;for(var h=s.subModels,u=0;u<h.length;++u){var l=h[u].subMesh;if(l&&l.geometricInfo){var c=l.geometricInfo,d=c.positions,f=c.indices,p=c.doubleSided;mE(d,f,l.primitiveMode,p,n),o=Math.min(o,oE*r.multiply(sE,rE.d,a.worldScale).length())}}}if(o<n){var m=uE.add();m.node=s.node,m.distance=o,pE[uE.length-1]=m}return pE.length=uE.length,pE.length>0},t.raycastAllCanvas=function(e,t,i){void 0===t&&(t=lh.Enum.UI_2D),void 0===i&&(i=1/0),cE.reset();var n=u.director.getScene().getComponentsInChildren(u.Canvas);if(null!=n&&n.length>0)for(var r=0;r<n.length;r++){var s=n[r].node;null!=s&&s.active&&this._raycastUI2DNodeRecursiveChildren(e,s,t,i)}return dE.length=cE.length,dE.length>0},t._raycastUI2DNode=function(e,t,i,n){void 0===i&&(i=lh.Enum.UI_2D),void 0===n&&(n=1/0);var r=t._uiProps.uiTransformComp;if(!(null==r||t.layer&lh.Enum.IGNORE_RAYCAST)&&t.layer&i){r.getComputeAABB(_E);var s=ca.rayAABB(e,_E);if(!(s<=0)&&s<n){var a=cE.add();return a.node=t,a.distance=s,a}}},t._raycastUI2DNodeRecursiveChildren=function(e,t,i,n){void 0===i&&(i=lh.Enum.UI_2D),void 0===n&&(n=1/0);var r=this._raycastUI2DNode(e,t,i,n);null!=r&&(dE[cE.length-1]=r);for(var s,a=R(t.children);!(s=a()).done;){var o=s.value;null!=o&&o.active&&this._raycastUI2DNodeRecursiveChildren(e,o,i,n)}},t._createHandles=function(){this._modelArrayHandle||(this._modelArrayHandle=kt.alloc(),this._scenePoolHandle=ai.alloc(),ai.set(this._scenePoolHandle,ti.MODEL_ARRAY,this._modelArrayHandle),this._spotLightsHandle=Wt.alloc(),ai.set(this._scenePoolHandle,ti.SPOT_LIGHT_ARRAY,this._spotLightsHandle),this._sphereLightsHandle=Wt.alloc(),ai.set(this._scenePoolHandle,ti.SPHERE_LIGHT_ARRAY,this._sphereLightsHandle))},e}())),rE=Rt.create(),sE=new r,aE=new _,oE=1/0,hE=rn.create(),uE=new Ee((function(){return{node:null,distance:1/0}}),8),lE=[],_E=new Ia,cE=new Ee((function(){return{node:null,distance:1/0}}),8),dE=[],fE=[],pE=[],mE=function(e,t,i,n,s){if(void 0===s&&(s=1/0),oE=s,i===dn.TRIANGLE_LIST)for(var a=t.length,o=0;o<a;o+=3){var h=3*t[o],u=3*t[o+1],l=3*t[o+2];r.set(hE.a,e[h],e[h+1],e[h+2]),r.set(hE.b,e[u],e[u+1],e[u+2]),r.set(hE.c,e[l],e[l+1],e[l+2]);var _=ca.rayTriangle(rE,hE,n);_<=0||_>=oE||(oE=_)}else if(i===dn.TRIANGLE_STRIP)for(var c=t.length-2,d=0,f=0;f<c;f+=1){var p=3*t[f-d],m=3*t[f+d+1],g=3*t[f+2];r.set(hE.a,e[p],e[p+1],e[p+2]),r.set(hE.b,e[m],e[m+1],e[m+2]),r.set(hE.c,e[g],e[g+1],e[g+2]),d=~d;var v=ca.rayTriangle(rE,hE,n);v<=0||v>=oE||(oE=v)}else if(i===dn.TRIANGLE_FAN){var E=t.length-1,T=3*t[0];r.set(hE.a,e[T],e[T+1],e[T+2]);for(var A=1;A<E;A+=1){var S=3*t[A],y=3*t[A+1];r.set(hE.b,e[S],e[S+1],e[S+2]),r.set(hE.c,e[y],e[y+1],e[y+2]);var R=ca.rayTriangle(rE,hE,n);R<=0||R>=oE||(oE=R)}}};h(nE.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastAllCanvas"},{name:"raycastUI2D",newName:"raycastAllCanvas"},{name:"raycast",newName:"raycastAllModels"},{name:"raycastModels",newName:"raycastAllModels"},{name:"raycastModel",newName:"raycastSingleModel"}]),l(nE.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Ne(nE.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect in geometry"},{name:"raycastAllModels",suggest:"using intersect in geometry"},{name:"raycastSingleModel",suggest:"using intersect in geometry"},{name:"raycastAllCanvas",suggest:"using intersect in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var gE=e("y",{});l(gE,"CameraVisFlags",[{name:"GENERAL"}]),h(gE,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:lh.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:lh.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:lh.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:lh.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:lh.BitMask,targetName:"UI_2D"}]),u.CameraVisFlags=gE;var vE=e("V",{});l(vE,"VisibilityFlags",[{name:"GENERAL"}]),h(vE,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:lh.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:lh.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:lh.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:lh.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:lh.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:lh.Enum,targetName:"UI_2D"}]),u.VisibilityFlags=vE,h(Al.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),l(Km.prototype,"Camera.prototype",[{name:"getSplitFrustum"}]);var EE,TE,AE,SE,yE,RE,IE,OE,NE,CE,bE,wE,LE,ME,PE,BE,FE,xE,DE,UE,GE,HE,kE,zE,VE,WE,YE,XE,jE,KE,ZE,QE,qE,JE,$E,eT,tT,iT,nT,rT,sT,aT=new r(0,0,-1),oT=new r,hT=(e("D",function(e){function t(){var t;return(t=e.call(this)||this)._dir=new r(1,-1,-1),t._shadowRange=1e3,t._shadowIntensity=0,t._shadowFadeDistance=0,t._shadowDistance=0,t._fadeStart=.8,t._splits=new f(1,0,0,0),t._biasAutoAdjust=1,t}a(t,e),s(t,[{key:"shadowRange",set:function(e){this._shadowRange=e},get:function(){return this._shadowRange}},{key:"shadowIntensitywRange",set:function(e){this._shadowIntensity=e}},{key:"shadowIntensity",get:function(){return this._shadowIntensity}},{key:"shadowFadeDistance",set:function(e){this._shadowFadeDistance=e},get:function(){return this._shadowFadeDistance}},{key:"shadowDistance",set:function(e){this._shadowDistance=e},get:function(){return this._shadowDistance}},{key:"fadeStart",set:function(e){this._fadeStart=e},get:function(){return this._fadeStart}},{key:"splits",set:function(e){this._splits=e},get:function(){return this._splits}},{key:"biasAutoAdjust",set:function(e){this._biasAutoAdjust=e},get:function(){return this._biasAutoAdjust}},{key:"direction",set:function(e){r.normalize(this._dir,e),Bi.setVec3(this._handle,wi.DIRECTION,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){Bi.set(this._handle,wi.ILLUMINANCE,e)},get:function(){return Bi.get(this._handle,wi.ILLUMINANCE)}}]);var i=t.prototype;return i.initialize=function(){e.prototype.initialize.call(this),Bi.set(this._handle,wi.ILLUMINANCE,Cg.SUN_ILLUM),Bi.setVec3(this._handle,wi.DIRECTION,this._dir),Bi.set(this._handle,wi.TYPE,qp.DIRECTIONAL)},i.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=r.transformQuat(oT,aT,this._node.worldRotation))},t}(tm)),e("U",function(e){function t(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._pos=void 0,t._aabb=void 0,t._hAABB=Ft,t._aabb=Ia.create(),t._pos=new r,t}a(t,e),s(t,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){Bi.set(this._handle,wi.SIZE,e)},get:function(){return Bi.get(this._handle,wi.SIZE)}},{key:"range",set:function(e){Bi.set(this._handle,wi.RANGE,e),this._needUpdate=!0},get:function(){return Bi.get(this._handle,wi.RANGE)}},{key:"luminance",set:function(e){Bi.set(this._handle,wi.ILLUMINANCE,e)},get:function(){return Bi.get(this._handle,wi.ILLUMINANCE)}},{key:"aabb",get:function(){return this._aabb}}]);var i=t.prototype;return i.initialize=function(){e.prototype.initialize.call(this),this._hAABB=ni.alloc(),Bi.set(this._handle,wi.TYPE,qp.SPHERE),Bi.set(this._handle,wi.SIZE,.15),Bi.set(this._handle,wi.RANGE,1),Bi.set(this._handle,wi.AABB,this._hAABB),Bi.set(this._handle,wi.ILLUMINANCE,1700/em(.15))},i.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=Bi.get(this._handle,wi.RANGE);Ia.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1,Bi.setVec3(this._handle,wi.POSITION,this._pos),ni.setVec3(this._hAABB,Jt.CENTER,this._aabb.center),ni.setVec3(this._hAABB,Jt.HALF_EXTENSION,this._aabb.halfExtents)}},i.destroy=function(){return this._hAABB&&(ni.free(this._hAABB),this._hAABB=Ft),e.prototype.destroy.call(this)},t}(tm)),new r(0,0,-1)),uT=new p,lT=new _,_T=new _,cT=new _,dT=new _,fT=(e("W",function(e){function t(){var t;return(t=e.call(this)||this)._dir=new r(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._hAABB=Ft,t._hFrustum=Ft,t._aabb=Ia.create(),t._frustum=Fa.create(),t._pos=new r,t}a(t,e),s(t,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){Bi.set(this._handle,wi.SIZE,e)},get:function(){return Bi.get(this._handle,wi.SIZE)}},{key:"range",set:function(e){this._range=e,Bi.set(this._handle,wi.RANGE,e),this._needUpdate=!0},get:function(){return Bi.get(this._handle,wi.RANGE)}},{key:"luminance",set:function(e){Bi.set(this._handle,wi.ILLUMINANCE,e)},get:function(){return Bi.get(this._handle,wi.ILLUMINANCE)}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return Bi.get(this._handle,wi.SPOT_ANGLE)},set:function(e){this._angle=e,Bi.set(this._handle,wi.SPOT_ANGLE,Math.cos(.5*e)),this._needUpdate=!0}},{key:"aspect",set:function(e){Bi.set(this._handle,wi.ASPECT,e),this._needUpdate=!0},get:function(){return Bi.get(this._handle,wi.ASPECT)}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]);var i=t.prototype;return i.initialize=function(){e.prototype.initialize.call(this),this._hAABB=ni.alloc(),this._hFrustum=Ei.alloc(),Bi.set(this._handle,wi.TYPE,qp.SPOT),Bi.set(this._handle,wi.SIZE,.15),Bi.set(this._handle,wi.AABB,this._hAABB),Bi.set(this._handle,wi.ILLUMINANCE,1700/em(.15)),Bi.set(this._handle,wi.RANGE,Math.cos(Math.PI/6)),Bi.set(this._handle,wi.ASPECT,1),Bi.setVec3(this._handle,wi.DIRECTION,this._dir)},i.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),r.transformQuat(this._dir,hT,this._node.getWorldRotation(uT)),r.normalize(this._dir,this._dir),Bi.setVec3(this._handle,wi.DIRECTION,this._dir),Ia.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(lT),_.invert(lT,lT),_.perspective(_T,this._angle,1,.001,this._range),_.multiply(cT,_T,lT),this._frustum.update(cT,dT),this._needUpdate=!1,Bi.setVec3(this._handle,wi.POSITION,this._pos),ni.setVec3(this._hAABB,Jt.CENTER,this._aabb.center),ni.setVec3(this._hAABB,Jt.HALF_EXTENSION,this._aabb.halfExtents),xa(this._hFrustum,this._frustum))},i.destroy=function(){return this._hAABB&&(ni.free(this._hAABB),this._hAABB=Ft),this._hFrustum&&(Ei.free(this._hFrustum),this._hFrustum=Ft),e.prototype.destroy.call(this)},t}(tm)),function(){this.material=null,this.vertexCount=0,this.indicesCount=0}),pT=e("e8",function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).vData=null,t.uvDirty=!0,t.vertDirty=!0,t._data=[],t._indices=[],t._pivotX=0,t._pivotY=0,t._width=0,t._height=0,t}a(t,e),t.add=function(){return vT.add()},t.remove=function(e){var t=vT.data.indexOf(e);-1!==t&&(vT.data[t].clear(),vT.removeAt(t))};var i=t.prototype;return i.updateSizeNPivot=function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)},i.clear=function(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0},s(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var i=t.length,n=0;for(n=e;n<i;n++)gT.free(t[n]);for(n=i;n<e;n++)t[n]=gT.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}(fT)),mT=e("eK",function(e){function t(t){var i;return void 0===t&&(t=9),(i=e.call(this)||this).vData=void 0,i.iData=void 0,i.vertexStart=0,i.indicesStart=0,i.byteStart=0,i.byteCount=0,i._formatByte=void 0,i._formatByte=t*Float32Array.BYTES_PER_ELEMENT,i.vData=new Float32Array(256*t*Float32Array.BYTES_PER_ELEMENT),i.iData=new Uint16Array(1536),i}a(t,e),t.add=function(){return ET.add()},t.remove=function(e){var t=ET.data.indexOf(e);-1!==t&&(ET.data[t].reset(),ET.removeAt(t))};var i=t.prototype;return i.request=function(e,t){var i=this.byteCount+e*this._formatByte;return this.reserve(e,t),this.vertexCount+=e,this.indicesCount+=t,this.byteCount=i,!0},i.reserve=function(e,t){var i=this.byteCount+e*this._formatByte,n=this.indicesCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,s=this.iData.length,a=this.vData.length,o=this.iData.length;if(i>r||n>s){for(;r<i||s<n;)r=4*(a*=2),s=o*=2;this._reallocBuffer(a,o)}return!0},i.advance=function(e,t){this.vertexCount+=e,this.indicesCount+=t,this.byteCount+=e*this._formatByte},i.reset=function(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0},i._reallocBuffer=function(e,t){var i=this.vData;this.vData=new Float32Array(e),this.vData.set(i,0);var n=this.iData;this.iData=new Uint16Array(t),this.iData.set(n,0)},s(t,[{key:"formatByte",set:function(e){this._formatByte=e},get:function(){return this._formatByte}},{key:"floatStride",get:function(){return this._formatByte>>2}},{key:"vDataOffset",get:function(){return this.byteCount>>>2}}]),t}(fT)),gT=(function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var i=t.prototype;i._fillQuadBuffer=function(){for(var e=this.iData.length/6,t=this.iData,i=0,n=0;i<e;i++){var r=4*i;t[n++]=r,t[n++]=r+1,t[n++]=r+2,t[n++]=r+1,t[n++]=r+3,t[n++]=r+2}},i._reallocBuffer=function(t,i){e.prototype._reallocBuffer.call(this,t,i),this._fillQuadBuffer()}}(mT),new Ae((function(){return{x:0,y:0,z:0,u:0,v:0,color:Se.WHITE.clone()}}),128)),vT=new Ee((function(){return new pT}),32),ET=new Ee((function(){return new mT}),32),TT={parent:null,owner:null,subModelIdx:0},AT=e("dW",(EE=I("cc.RenderableComponent"),TE=U([a_]),AE=U(a_),SE=te(),yE=Ce(),EE((CE=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,b(t,"_materials",OE,B(t)),b(t,"_visFlags",NE,B(t)),t._materialInstances=[],t._models=[],t}a(t,e);var i=t.prototype;return i.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},i.setMaterial=function(e,t){e&&e instanceof I_&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var i=this._materialInstances[t];i?i.parent!==this._materials[t]&&(i.destroy(),this._materialInstances[t]=null,this._onMaterialModified(t,this._materials[t])):this._onMaterialModified(t,this._materials[t])},i.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){TT.parent=this._materials[e],TT.owner=this,TT.subModelIdx=e;var t=new I_(TT);this.setMaterialInstance(e,t)}return this._materialInstances[e]},i.setMaterialInstance=function(e,t){t&&t.parent?t!==this._materialInstances[e]&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):t!==this._materials[e]&&this.setMaterial(t,e)},i.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},i._collectModels=function(){return this._models},i._attachToScene=function(){},i._detachFromScene=function(){},i._onMaterialModified=function(){},i._onRebuildPSO=function(){},i._clearMaterials=function(){},i._onVisibilityChange=function(){},s(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var i=this._materials.length-t;i<this._materials.length;++i)this.setMaterialInstance(i,null);for(var n=0;n<this._materialInstances.length;n++)this._materialInstances[n]!=e[n]&&this.setMaterialInstance(n,e[n])}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterialInstance(0,e)}}]),t}(ne),OE=O((IE=CE).prototype,"_materials",[TE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NE=O(IE.prototype,"_visFlags",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lh.Enum.NONE}}),O(IE.prototype,"sharedMaterials",[AE,SE,yE],Object.getOwnPropertyDescriptor(IE.prototype,"sharedMaterials"),IE.prototype),RE=IE))||RE));u.RenderableComponent=AT;var ST=g({OFF:0,ON:1}),yT=g({OFF:0,ON:1}),RT=(bE=I("cc.ModelLightmapSettings"),wE=be("_recieveShadow"),bE((GE=function(){function e(){b(this,"texture",PE,this),b(this,"uvParam",BE,this),b(this,"_bakeable",FE,this),b(this,"_castShadow",xE,this),b(this,"_receiveShadow",DE,this),b(this,"_lightmapSize",UE,this)}return s(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),PE=O((ME=GE).prototype,"texture",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BE=O(ME.prototype,"uvParam",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),FE=O(ME.prototype,"_bakeable",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xE=O(ME.prototype,"_castShadow",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),DE=O(ME.prototype,"_receiveShadow",[wE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UE=O(ME.prototype,"_lightmapSize",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),O(ME.prototype,"bakeable",[C],Object.getOwnPropertyDescriptor(ME.prototype,"bakeable"),ME.prototype),O(ME.prototype,"castShadow",[C],Object.getOwnPropertyDescriptor(ME.prototype,"castShadow"),ME.prototype),O(ME.prototype,"receiveShadow",[C],Object.getOwnPropertyDescriptor(ME.prototype,"receiveShadow"),ME.prototype),O(ME.prototype,"lightmapSize",[C],Object.getOwnPropertyDescriptor(ME.prototype,"lightmapSize"),ME.prototype),LE=ME))||LE),IT=e("dV",(HE=I("cc.MeshRenderer"),kE=$(),zE=ke(100),VE=ee(),WE=U(ST),YE=ie(),XE=U(yT),jE=ie(),KE=U(yu),ZE=ie(),QE=Le(),HE(qE=kE(qE=zE(qE=VE(qE=J((sT=rT=function(e){function t(){var t;return t=e.call(this)||this,b(t,"lightmapSettings",$E,B(t)),b(t,"_mesh",eT,B(t)),b(t,"_shadowCastingMode",tT,B(t)),b(t,"_shadowReceivingMode",iT,B(t)),t._modelType=void 0,t._model=null,t._morphInstance=null,b(t,"_enableMorph",nT,B(t)),t._modelType=kv,t}a(t,e),s(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t,i=this._mesh;this._mesh=e,null===(t=this._mesh)||void 0===t||t.initialize(),this._watchMorphInMesh(),this._onMeshChanged(i),this._updateModels(),this.enabledInHierarchy&&this._attachToScene()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]);var i=t.prototype;return i.onLoad=function(){var e;null===(e=this._mesh)||void 0===e||e.initialize(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},i.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},i.onEnable=function(){this._model||this._updateModels(),this._attachToScene()},i.onDisable=function(){this._model&&this._detachFromScene()},i.onDestroy=function(){this._model&&(u.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},i.setWeights=function(e,t){this._morphInstance&&this._morphInstance.setWeights(t,e)},i.setInstancedAttribute=function(e,t){if(this.model)for(var i=this.model.instancedAttributes,n=i.attributes,r=i.views,s=0;s<n.length;s++)if(n[s].name===e){r[s].set(t);break}},i._updateLightmap=function(e,t,i,n,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},i._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},i._createModel=function(){var e=this._morphInstance&&this._modelType===kv?zv:this._modelType,t=this._model=u.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof zv&&t.setMorphRendering(this._morphInstance)},i._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},i._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},i._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=Cc.POSITION,this._model.transform.hasChangedFlags|=Cc.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var i=0;i<e;++i){var n=this.getRenderMaterial(i);n&&!n.isValid&&(n=null);var r=t[i];r&&this._model.initSubModel(i,r,n||this._getBuiltinMaterial())}this._model.enabled=!0}},i._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},i._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},i._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())},i._onMeshChanged=function(){},i._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},i._getBuiltinMaterial=function(){return ml.get("missing-material")},i._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},i._updateCastShadow=function(){this._model&&(this._shadowCastingMode===ST.OFF?this._model.castShadow=!1:(k(this._shadowCastingMode===ST.ON,"ShadowCastingMode "+this._shadowCastingMode+" is not supported."),this._model.castShadow=!0))},i._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===yT.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},i._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var i=0;i<t.passes.length;++i)if(t.passes[i].batchingScheme)return!0}return!1},i._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){var e=this._mesh.struct.morph;this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,i=0;i<t;++i){var n=e.subMeshMorphs[i];if(n){var r=n.weights||e.weights,s=r?r.slice():new Array(n.targets.length).fill(0);this._morphInstance.setWeights(i,s)}}this._model&&this._model instanceof zv&&this._model.setMorphRendering(this._morphInstance)}},i._syncMorphWeights=function(e){if(this._morphInstance){var t=this._morphInstance[e];t&&t.renderResources&&t.renderResources.setWeights(t.weights)}},t}(AT),rT.ShadowCastingMode=ST,rT.ShadowReceivingMode=yT,$E=O((JE=sT).prototype,"lightmapSettings",[N,C,we],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RT}}),eT=O(JE.prototype,"_mesh",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tT=O(JE.prototype,"_shadowCastingMode",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ST.OFF}}),iT=O(JE.prototype,"_shadowReceivingMode",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yT.ON}}),O(JE.prototype,"shadowCastingMode",[WE,YE,we],Object.getOwnPropertyDescriptor(JE.prototype,"shadowCastingMode"),JE.prototype),O(JE.prototype,"receiveShadow",[XE,jE,we],Object.getOwnPropertyDescriptor(JE.prototype,"receiveShadow"),JE.prototype),O(JE.prototype,"mesh",[KE,ZE],Object.getOwnPropertyDescriptor(JE.prototype,"mesh"),JE.prototype),O(JE.prototype,"enableMorph",[QE,we],Object.getOwnPropertyDescriptor(JE.prototype,"enableMorph"),JE.prototype),nT=O(JE.prototype,"_enableMorph",[N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qE=JE))||qE)||qE)||qE)||qE)||qE));function OT(e,t){var i=e.sharedMaterials.length;if(i!==t.sharedMaterials.length)return!1;for(var n=0;n<i;n++)if(e.getRenderMaterial(n)!==t.getRenderMaterial(n))return!1;return!0}e("bB",function(){function e(){}return e.batchStaticModel=function(e,t){var i=e.getComponentsInChildren(IT);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var n=1;n<i.length;n++){if(!i[0].mesh.validateMergingMesh(i[n].mesh))return console.error("the meshes of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1;if(!OT(i[0],i[n]))return console.error("the materials of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1}var r=new yu,s=new _,a=new _;e.getWorldMatrix(a),_.invert(a,a);for(var o=0;o<i.length;o++){var h=i[o];h.node.getWorldMatrix(s),_.multiply(s,a,s),r.merge(i[o].mesh,s),h.enabled=!1}var u=t.addComponent(IT);return u.mesh=r,u.sharedMaterials=i[0].sharedMaterials,!0},e.unbatchStaticModel=function(e,t){for(var i=e.getComponentsInChildren("cc.MeshRenderer"),n=0;n<i.length;n++)i[n].enabled=!0;var r=t.getComponent("cc.MeshRenderer");return r&&r.destroy(),!0},e}());var NT=new r;function CT(e,t,i,n){n||(n=new r),e.convertToUINode(t,i,n);var s=i.position;return n.add(s),n}function bT(e,t,i){return i||(i=new r),e.worldToScreen(t,i),i.x=i.x/u.view.getScaleX(),i.y=i.y/u.view.getScaleY(),i}var wT=e("bF",{WorldNode3DToLocalNodeUI:CT,WorldNode3DToWorldNodeUI:bT});u.pipelineUtils=wT,h(u.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0],r=t[3]||NT;return n.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]);var LT=new X,MT=e("bZ",function(){function e(e,t,i){void 0===i&&(i=0),this._point=new X,this._prevPoint=new X,this._lastModified=0,this._id=0,this._startPoint=new X,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}s(e,[{key:"lastModified",get:function(){return this._lastModified}}]);var t=e.prototype;return t.getLocation=function(e){return e||(e=new X),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new X),e.set(this._point.x,this._point.y),u.view._convertPointWithScale(e),e},t.getUILocationX=function(){var e=u.view.getViewportRect();return(this._point.x-e.x)/u.view.getScaleX()},t.getUILocationY=function(){var e=u.view.getViewportRect();return(this._point.y-e.y)/u.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new X),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new X),e.set(this._prevPoint.x,this._prevPoint.y),u.view._convertPointWithScale(e),e},t.getStartLocation=function(e){return e||(e=new X),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new X),e.set(this._startPoint.x,this._startPoint.y),u.view._convertPointWithScale(e),e},t.getDelta=function(e){return e||(e=new X),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new X),LT.set(this._point),LT.subtract(this._prevPoint),e.set(u.view.getScaleX(),u.view.getScaleY()),X.divide(e,LT,e),e},t.getLocationInView=function(e){return e||(e=new X),e.set(this._point.x,u.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new X),e.set(this._prevPoint.x,u.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new X),e.set(this._startPoint.x,u.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,i){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new X(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new X(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=u.director.getCurrentTime()},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new X(e.x,e.y):new X(e||0,t||0),this._lastModified=u.director.getCurrentTime()},e}());u.Touch=MT;var PT,BT=D.TOUCH_TIMEOUT,FT=new X,xT=new X,DT=e("bS",(function(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=n}));u.internal.Acceleration=DT;var UT=new(function(){function e(){this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new X,this._prevMousePoint=new X,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._pointLocked=!1}var t=e.prototype;return t.handleTouchesBegin=function(e){for(var t=[],i=this._touchesIntegerDict,n=0;n<e.length;++n){var r=e[n],s=r.getID();if(null!==s&&void 0===i[s]){var a=this._getUnUsedIndex();if(-1===a){se(2300,a);continue}r.getLocation(FT);var o=new MT(FT.x,FT.y,s);this._touches[a]=o,r.getPreviousLocation(FT),o.setPrevPoint(FT),i[s]=a,t.push(o)}}if(t.length>0){var h=new D_(t,!1,D_.BEGAN,D.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Q_.dispatchEvent(h)}},t.handleTouchesMove=function(e){for(var t=[],i=this._touches,n=0;n<e.length;++n){var r=e[n],s=r.getID();if(null!==s){var a=this._touchesIntegerDict[s];void 0!==a&&i[a]&&(r.getLocation(FT),i[a].setPoint(FT),r.getPreviousLocation(FT),i[a].setPrevPoint(FT),t.push(i[a]))}}if(t.length>0){var o=new D_(t,!1,D_.MOVED,D.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Q_.dispatchEvent(o)}},t.handleTouchesEnd=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new D_(t,!1,D_.ENDED,D.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Q_.dispatchEvent(i)}this._preTouchPool.length=0},t.handleTouchesCancel=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new D_(t,!1,D_.CANCELLED,D.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Q_.dispatchEvent(i)}this._preTouchPool.length=0},t.getSetOfTouchesEndOrCancel=function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var s=e[r],a=s.getID();if(null!==a){var o=n[a];void 0!==o&&i[o]&&(s.getLocation(FT),i[o].setPoint(FT),s.getPreviousLocation(FT),i[o].setPrevPoint(FT),t.push(i[o]),this._removeUsedIndexBit(o),delete n[a])}}return t},t.getHTMLElementPosition=function(e){var t=document.documentElement,i=w.os===w.OS_IOS&&w.isBrowser?window.screenLeft:window.pageXOffset;i-=t.clientLeft;var n=w.os===w.OS_IOS&&w.isBrowser?window.screenTop:window.pageYOffset;if(n-=t.clientTop,e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+i,top:r.top+n,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}},t.getPreTouch=function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){t=i[r];break}return t||(t=e),t},t.setPreTouch=function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))},t.getTouchByXY=function(e,t,i,n){var r=this._preTouchPoint,s=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(s.x=r.x+e.movementX,s.y=r.y-e.movementY);var a=new MT(s.x,s.y,0);return a.setPrevPoint(r.x,r.y),r.x=s.x,r.y=s.y,a},t.getMouseEvent=function(e,t,i){var n=this._prevMousePoint,r=new x_(i,!1,n);return n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),r.setLocation(n.x,n.y),r},t.getPointByEvent=function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop,{x:e.clientX,y:e.clientY})},t.getTouchesByEvent=function(e,t){for(var i=[],n=this._glView,r=this._preTouchPoint,s=e.changedTouches.length,a=0;a<s;a++){var o=e.changedTouches[a];if(o){var h;h=w.BROWSER_TYPE_FIREFOX===w.browserType?n.convertToLocationInView(o.pageX,o.pageY,t,FT):n.convertToLocationInView(o.clientX,o.clientY,t,FT);var u=void 0;if(null!=o.identifier?(u=new MT(h.x,h.y,o.identifier),this.getPreTouch(u).getLocation(xT),u.setPrevPoint(xT.x,xT.y),this.setPreTouch(u)):(u=new MT(h.x,h.y)).setPrevPoint(r.x,r.y),r.x=h.x,r.y=h.y,i.push(u),!D.ENABLE_MULTI_TOUCH)break}}return i},t.registerSystemEvent=function(e){if(!this._isRegisterEvent&&e){this._glView=u.view;var t=w.isMobile,i="mouse"in w.capabilities,n="touches"in w.capabilities;i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),n&&this._registerTouchEvents(e),this._registerKeyboardEvent(),this._isRegisterEvent=!0}},t.setAccelerometerEnabled=function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=u.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}},t.didAccelerate=function(e){if(this._accelEnabled){var t=this._acceleration,i=0,n=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var s=e.accelerationIncludingGravity;s&&(i=this._accelMinus*(s.x||0)*.1,n=this._accelMinus*(s.y||0)*.1,r=.1*(s.z||0))}else{var a=e;i=(a.gamma||0)/90*.981,n=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(u.view._isRotated){var o=i;i=-n,n=o}t.x=i,t.y=n,t.z=r,t.timestamp=e.timeStamp||Date.now();var h=t.x;90===window.orientation?(t.x=-t.y,t.y=h):-90===window.orientation?(t.x=t.y,t.y=-h):180===window.orientation&&(t.x=-t.x,t.y=-t.y),u.sys.os===u.sys.OS_ANDROID&&u.sys.browserType!==u.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}},t.update=function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,Q_.dispatchEvent(new U_(this._acceleration))),this._accelCurTime+=e},t.setAccelerometerInterval=function(e){this._accelInterval!==e&&(this._accelInterval=e)},t._getUnUsedIndex=function(){for(var e=this._indexBitsUsed,t=u.director.getCurrentTime(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n.lastModified>BT){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1},t._removeUsedIndexBit=function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}},t._registerMouseEvents=function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=u.game.canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._registerWindowMouseEvents=function(e){var t=this;window.addEventListener("mousedown",(function(){t._mousePressed=!0}),!1),window.addEventListener("mouseup",(function(i){if(t._mousePressed){t._mousePressed=!1;var n=t.getHTMLElementPosition(e),r=t.getPointByEvent(i,n);if(!Me(n.left,n.top,n.width,n.height).contains(new X(r.x,r.y))){t.handleTouchesEnd([t.getTouchByXY(i,r.x,r.y,n)]);var s=t.getMouseEvent(r,n,x_.UP);s.setButton(i.button),Q_.dispatchEvent(s)}}}),!1)},t._registerElementMouseEvents=function(e,t){var i=this,n=function(t,n,r){e.addEventListener(t,(function(t){var s=i.getHTMLElementPosition(e),a=i.getPointByEvent(t,s),o=i.getMouseEvent(a,s,n);o.setButton(t.button),r(t,o,a,s),Q_.dispatchEvent(o),t.stopPropagation(),t.preventDefault()}))};t||(n("mousedown",x_.DOWN,(function(t,n,r,s){i._mousePressed=!0,i.handleTouchesBegin([i.getTouchByXY(t,r.x,r.y,s)]),e.focus()})),n("mouseup",x_.UP,(function(e,t,n,r){i._mousePressed=!1,i.handleTouchesEnd([i.getTouchByXY(e,n.x,n.y,r)])})),n("mousemove",x_.MOVE,(function(e,t,n,r){i.handleTouchesMove([i.getTouchByXY(e,n.x,n.y,r)]),i._mousePressed||t.setButton(x_.BUTTON_MISSING),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)}))),n("mousewheel",x_.SCROLL,(function(e,t){t.setScrollData(0,e.wheelDelta)})),n("DOMMouseScroll",x_.SCROLL,(function(e,t){t.setScrollData(0,-120*e.detail)}))},t._registerMousePointerEvents=function(e){var t=this,i={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel},n=function(n){var r=i[n];e.addEventListener(n,(function(i){var n=t.getHTMLElementPosition(e);n.left-=document.documentElement.scrollLeft,n.top-=document.documentElement.scrollTop,r.call(t,[t.getTouchByXY(i,i.clientX,i.clientY,n)]),i.stopPropagation()}),!1)};for(var r in i)n(r)},t._registerTouchEvents=function(e){var t=this,i=function(i){return function(n){if(n.changedTouches){var r=t.getHTMLElementPosition(e),s=document.body;r.left-=s.scrollLeft||0,r.top-=s.scrollTop||0,i(t.getTouchesByEvent(n,r)),n.stopPropagation(),n.preventDefault()}}};e.addEventListener("touchstart",i((function(i){t.handleTouchesBegin(i),e.focus()})),!1),e.addEventListener("touchmove",i((function(e){t.handleTouchesMove(e)})),!1),e.addEventListener("touchend",i((function(e){t.handleTouchesEnd(e)})),!1),e.addEventListener("touchcancel",i((function(e){t.handleTouchesCancel(e)})),!1)},t._registerKeyboardEvent=function(){var e=u.game.canvas;e.addEventListener("keydown",(function(e){Q_.dispatchEvent(new G_(e,!0)),e.stopPropagation(),e.preventDefault()}),!1),e.addEventListener("keyup",(function(e){Q_.dispatchEvent(new G_(e,!1)),e.stopPropagation(),e.preventDefault()}),!1)},t._registerAccelerometerEvent=function(){var e=this;this._acceleration=new DT,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,u.sys.browserType===u.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";PT=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,PT,!1)},t._unregisterAccelerometerEvent=function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";PT&&window.removeEventListener(e,PT,!1)},t._getUsefulTouches=function(){var e=[],t=this._touchesIntegerDict;for(var i in t){var n=t[parseInt(i)];if(null!=n){var r=this._touches[n];e.push(r)}}return e},e}());u.internal.inputManager=UT;var GT=e("b$",function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t._persistRootNodes={},t._paused=!0,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._rendererInitialized=!1,t._gfxDevice=null,t._intervalId=null,t.collisionMatrix=[],t.groupList=[],t}a(t,e);var i=t.prototype;return i.setFrameRate=function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._paused=!0,this._setAnimFrame(),this._runMainLoop()},i.getFrameRate=function(){return this.config.frameRate||0},i.step=function(){u.director.mainLoop()},i.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},i.resume=function(){this._paused&&(this._paused=!1,this._runMainLoop())},i.isPaused=function(){return this._paused},i.restart=function(){var e=this;return new Promise((function(e){return u.director.once(u.Director.EVENT_AFTER_DRAW,(function(){return e()}))})).then((function(){for(var i in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[i]);return u.director.getScene().destroy(),u.Object._deferredDestroy(),u.director.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},i.end=function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()},i.on=function(e,i,n,r){this._inited&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOn(e,i,n,r)},i.once=function(e,i,n){this._inited&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOnce(e,i,n)},i.init=function(e){var t=this;return this._initConfig(e),this.config.assetOptions&&u.assetManager.init(this.config.assetOptions),this._initEngine().then((function(){return t._initEvents(),u.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._inited}))},i.run=function(e,t){var i,n=this;return this._initEvents(),"function"!=typeof e&&e?(i=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Promise.resolve(i).then((function(){return n._setAnimFrame(),n._runMainLoop(),HT.config.registerSystemEvent&&UT.registerSystemEvent(HT.canvas),n._setRenderPipelineNShowSplash()}))},i.addPersistRootNode=function(e){if(u.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=u.director._scene;if(u.isValid(i))if(e.parent){if(!(e.parent instanceof u.Scene))return void L(3801);if(e.parent!==i)return void L(3802)}else e.parent=i;this._persistRootNodes[t]=e,e._persistNode=!0,u.assetManager._releaseManager._addPersistNodeRef(e)}}else L(3800)},i.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,u.assetManager._releaseManager._removePersistNodeRef(e))},i.isPersistRootNode=function(e){return e._persistNode},i._initEngine=function(){var e=this;return this._initDevice(),Promise.resolve(u.director._init()).then((function(){le("Cocos Creator v"+Pe),e.emit(t.EVENT_ENGINE_INITED),e._inited=!0}))},i._setAnimFrame=function(){this._lastTime=performance.now();var e=this.config.frameRate;this._frameTime=1e3/e,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0);var t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=t?this._stTimeWithRAF:this._stTime,window.cAF=this._ctTime):(window.rAF=t||this._stTime,window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)},i._stTimeWithRAF=function(e){var t=performance.now(),i=Math.max(0,t-HT._lastTime),n=Math.max(0,HT._frameTime-i),r=window.setTimeout((function(){window.requestAnimationFrame(e)}),n);return HT._lastTime=t+n,r},i._stTime=function(e){var t=performance.now(),i=Math.max(0,t-HT._lastTime),n=Math.max(0,HT._frameTime-i),r=window.setTimeout(e,n);return HT._lastTime=t+n,r},i._ctTime=function(e){window.clearTimeout(e)},i._runMainLoop=function(){var e=this,t=this.config,i=u.director,n=!0,r=t.frameRate;Be(!!t.showFPS),i.startAnimation(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF((function t(s){e._paused||(e._intervalId=window.rAF(t),30===r&&(n=!n)||i.mainLoop(s))})),this._paused=!1},i._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=Fe.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],xe(e.debugMode),this.config=e,this._configLoaded=!0},i._determineRenderType=function(){var e=this.config,i=parseInt(e.renderMode);this.renderType=t.RENDER_TYPE_CANVAS;var n=!1;if(0===i?u.sys.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,n=!0):u.sys.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):1===i&&u.sys.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):2===i&&u.sys.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,n=!0),!n)throw new Error(ce(3820,i))},i._initDevice=function(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var e=[],i=!!window.WebGL2RenderingContext,n=window.navigator.userAgent.toLowerCase();(-1!==n.indexOf("safari")&&-1===n.indexOf("chrome")||w.browserType===w.BROWSER_TYPE_UC)&&(i=!1),i&&u.WebGL2Device&&e.push(u.WebGL2Device),u.WebGLDevice&&e.push(u.WebGLDevice);for(var r=new or(this.canvas,D.ENABLE_WEBGL_ANTIALIAS,!1,window.devicePixelRatio,w.windowPixelResolution.width,w.windowPixelResolution.height,Th),s=0;s<e.length&&(this._gfxDevice=new e[s],!this._gfxDevice.initialize(r));s++);}if(!this._gfxDevice)return me("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!u._isContextMenuEnable)return!1}}},i._initEvents=function(){var e,i=this,n=window;this._setAnimFrame(),void 0!==document.hidden?e="hidden":void 0!==document.mozHidden?e="mozHidden":void 0!==document.msHidden?e="msHidden":void 0!==document.webkitHidden&&(e="webkitHidden");var r=!1,s=this;function a(){r||(r=!0,s.emit(t.EVENT_HIDE))}function o(e,i,n,a,o){r&&(r=!1,s.emit(t.EVENT_SHOW,e,i,n,a,o))}if(e)for(var h=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],u=0;u<h.length;u++)document.addEventListener(h[u],(function(t){var i=document[e];(i=i||t.hidden)?a():o()}));else n.addEventListener("blur",a),n.addEventListener("focus",o);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(n.onfocus=o),"onpageshow"in window&&"onpagehide"in window&&(n.addEventListener("pagehide",a),n.addEventListener("pageshow",o),document.addEventListener("pagehide",a),document.addEventListener("pageshow",o)),this.on(t.EVENT_HIDE,(function(){i.pause()})),this.on(t.EVENT_SHOW,(function(){i.resume()}))},i._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return e._safeEmit(t.EVENT_GAME_INITED),Promise.resolve(e._showSplashScreen()).then((function(){e.onStart&&e.onStart()}))}))},i._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;if(t)return new Promise((function(e,i){u.assetManager.loadAny(t,(function(t,n){return!t&&n instanceof Bp?e(n):i(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(i){z(i),z("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()}));this._setRenderPipeline()},i._showSplashScreen=function(){if(u.internal.SplashScreen){var e=u.internal.SplashScreen.instance;return e.main(u.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}},i._setRenderPipeline=function(e){u.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},i._safeEmit=function(e){this.emit(e)},s(t,[{key:"inited",get:function(){return this._inited}},{key:"frameTime",get:function(){return this._frameTime}}]),t}(De));GT.EVENT_HIDE="game_on_hide",GT.EVENT_SHOW="game_on_show",GT.EVENT_LOW_MEMORY="game_on_low_memory",GT.EVENT_GAME_INITED="game_inited",GT.EVENT_ENGINE_INITED="engine_inited",GT.EVENT_RENDERER_INITED="renderer_inited",GT.EVENT_RESTART="game_on_restart",GT.RENDER_TYPE_CANVAS=0,GT.RENDER_TYPE_WEBGL=1,GT.RENDER_TYPE_OPENGL=2,u.Game=GT;var HT=e("c0",u.game=new GT),kT=e("e3",{topLeft:u.v2(0,0),topRight:u.v2(0,0),top:u.v2(0,0),bottomLeft:u.v2(0,0),bottomRight:u.v2(0,0),bottom:u.v2(0,0),center:u.v2(0,0),left:u.v2(0,0),right:u.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,s=r+i,a=n+t;this.topLeft.x=n,this.topLeft.y=s,this.topRight.x=a,this.topRight.y=s,this.top.x=n+t/2,this.top.y=s,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=a,this.right.y=r+i/2}});u.visibleRect=kT;var zT=new(function(){function e(){this.html=void 0,this.meta={width:"device-width"},this.adaptationType=u.sys.browserType}var t=e.prototype;return t.init=function(){},t.availWidth=function(e){return u.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth},t.availHeight=function(e){return u.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight},e}());switch(u.sys.os===u.sys.OS_IOS&&(zT.adaptationType=u.sys.BROWSER_TYPE_SAFARI),zT.adaptationType){case u.sys.BROWSER_TYPE_SAFARI:zT.meta["minimal-ui"]="true";case u.sys.BROWSER_TYPE_SOUGOU:case u.sys.BROWSER_TYPE_UC:zT.availWidth=function(e){return e.clientWidth},zT.availHeight=function(e){return e.clientHeight}}var VT=e("bO",function(e){function t(){var t;(t=e.call(this)||this)._resizeWithBrowserSize=void 0,t._designResolutionSize=void 0,t._originalDesignResolutionSize=void 0,t._frameSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._devicePixelRatio=void 0,t._maxPixelRatio=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resizing=void 0,t._orientationChanging=void 0,t._isRotated=void 0,t._orientation=void 0,t._isAdjustViewport=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0,B(t);var i=WT,n=YT;return t._frameSize=new K(0,0),t._designResolutionSize=new K(0,0),t._originalDesignResolutionSize=new K(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new j(0,0,0,0),t._visibleRect=new j(0,0,0,0),t._autoFullScreen=!1,t._devicePixelRatio=1,t._maxPixelRatio=2,t._retinaEnabled=!1,t._resizeCallback=null,t._resizing=!1,t._resizeWithBrowserSize=!1,t._orientationChanging=!0,t._isRotated=!1,t._orientation=u.macro.ORIENTATION_AUTO,t._isAdjustViewport=!0,t._rpExactFit=new XT(i.EQUAL_TO_FRAME,n.EXACT_FIT),t._rpShowAll=new XT(i.EQUAL_TO_FRAME,n.SHOW_ALL),t._rpNoBorder=new XT(i.EQUAL_TO_FRAME,n.NO_BORDER),t._rpFixedHeight=new XT(i.EQUAL_TO_FRAME,n.FIXED_HEIGHT),t._rpFixedWidth=new XT(i.EQUAL_TO_FRAME,n.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,u.game.once(u.Game.EVENT_ENGINE_INITED,t.init,B(t)),t}a(t,e);var i=t.prototype;return i.init=function(){zT.init(),this._initFrameSize();var e=u.game.canvas.width,t=u.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,u.winSize.width=this._visibleRect.width,u.winSize.height=this._visibleRect.height,u.visibleRect&&u.visibleRect.init(this._visibleRect)},i.resizeWithBrowserSize=function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))},i.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},i.setOrientation=function(e){(e&=u.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)},i.adjustViewportMeta=function(e){this._isAdjustViewport=e},i.enableRetina=function(e){this._retinaEnabled=!!e},i.isRetinaEnabled=function(){return this._retinaEnabled},i.enableAutoFullScreen=function(e){e&&e!==this._autoFullScreen&&u.sys.isMobile&&u.sys.browserType!==u.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,u.screen.autoFullScreen(u.game.frame)):this._autoFullScreen=!1},i.isAutoFullScreenEnabled=function(){return this._autoFullScreen},i.setCanvasSize=function(e,t){var i=u.game.canvas,n=u.game.container;this._devicePixelRatio=window.devicePixelRatio,i.width=w.windowPixelResolution.width,i.height=w.windowPixelResolution.height,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()},i.getCanvasSize=function(){return new K(u.game.canvas.width,u.game.canvas.height)},i.getFrameSize=function(){return new K(this._frameSize.width,this._frameSize.height)},i.setFrameSize=function(e,t){this._frameSize.width=e,this._frameSize.height=t,u.frame.style.width=e+"px",u.frame.style.height=t+"px",this._resizeEvent()},i.getVisibleSize=function(){return new K(this._visibleRect.width,this._visibleRect.height)},i.getVisibleSizeInPixel=function(){return new K(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},i.getVisibleOrigin=function(){return new X(this._visibleRect.x,this._visibleRect.y)},i.getVisibleOriginInPixel=function(){return new X(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},i.getResolutionPolicy=function(){return this._resolutionPolicy},i.setResolutionPolicy=function(e){var t=this;if(e instanceof XT)t._resolutionPolicy=e;else{var i=XT;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}},i.setDesignResolutionSize=function(e,t,i){if(e>0&&t>0){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),u.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var s=this._viewportRect,a=this._visibleRect,o=r.viewport;s.x=o.x,s.y=o.y,s.width=o.width,s.height=o.height,a.x=0,a.y=0,a.width=o.width/this._scaleX,a.height=o.height/this._scaleY}n.postApply(this),u.winSize.width=this._visibleRect.width,u.winSize.height=this._visibleRect.height,kT&&kT.init(this._visibleRect),this.emit("design-resolution-changed")}else se(2201)}else F(2200)},i.getDesignResolutionSize=function(){return new K(this._designResolutionSize.width,this._designResolutionSize.height)},i.setRealPixelResolution=function(e,t,i){this.setDesignResolutionSize(e,t,i)},i.getViewportRect=function(){return this._viewportRect},i.getScaleX=function(){return this._scaleX},i.getScaleY=function(){return this._scaleY},i.getDevicePixelRatio=function(){return this._devicePixelRatio},i.convertToLocationInView=function(e,t,i,n){var r=n||new X,s=this._devicePixelRatio*(e-i.left),a=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=u.game.canvas.width-a,r.y=s):(r.x=s,r.y=a),u.GAME_VIEW&&(r.x/=u.gameView.canvas.width/u.game.canvas.width,r.y/=u.gameView.canvas.height/u.game.canvas.height),r},i._convertPointWithScale=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},i._resizeEvent=function(){var e=u.view,t=e._frameSize.width,i=e._frameSize.height,n=e._isRotated;if(u.sys.isMobile){var r=u.game.container.style,s=r.margin;r.margin="0",r.display="none",e._initFrameSize(),r.margin=s,r.display="block"}else e._initFrameSize();if(e._orientationChanging||e._isRotated!==n||e._frameSize.width!==t||e._frameSize.height!==i){var a=e._originalDesignResolutionSize.width,o=e._originalDesignResolutionSize.height;e._resizing=!0,a>0&&e.setDesignResolutionSize(a,o,e._resolutionPolicy),e._resizing=!1,e.emit("canvas-resize"),e._resizeCallback&&e._resizeCallback.call()}},i._orientationChange=function(){u.view._orientationChanging=!0,u.view._resizeEvent()},i._initFrameSize=function(){var e=this._frameSize,t=zT.availWidth(u.game.frame),i=zT.availHeight(u.game.frame),n=t>=i;!u.sys.isMobile||n&&this._orientation&u.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&u.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,u.game.container.style["-webkit-transform"]="rotate(0deg)",u.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,u.game.container.style["-webkit-transform"]="rotate(90deg)",u.game.container.style.transform="rotate(90deg)",u.game.container.style["-webkit-transform-origin"]="0px 0px 0px",u.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,u.game.canvas.style["-webkit-transform"]="translateZ(0px)",u.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((function(){u.view._orientationChanging=!1}),1e3)},i._adjustSizeKeepCanvasSize=function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;e>0&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)},i._setViewportMeta=function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,s,a=document.getElementsByName("viewport"),o=a?a[0]:null;for(r in n=o?o.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(s=new RegExp(r+"s*=s*[^,]+"),n=n.replace(s,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,o&&(o.content=n),document.head.appendChild(i)},i._adjustViewportMeta=function(){!this._isAdjustViewport||Ue||Ge||He||(this._setViewportMeta(zT.meta,!1),this._isAdjustViewport=!1)},i._convertMouseToLocation=function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y),u.GAME_VIEW&&(e.x/=u.gameView.canvas.width/u.game.canvas.width,e.y/=u.gameView.canvas.height/u.game.canvas.height)},i._convertTouchWidthScale=function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n},i._convertTouchesWithScale=function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,s=this._scaleY,a=0;a<e.length;a++){var o=e[a];t=o._point,i=o._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/s,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/s}},t}(De));VT.instance=void 0;var WT=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupContainer=function(e,t,i){var n=u.game.canvas,r=u.game.container;u.sys.os===u.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px",e._devicePixelRatio=1,e.isRetinaEnabled()&&(e._devicePixelRatio=Math.min(e._maxPixelRatio,window.devicePixelRatio||1)),n.width=t*e._devicePixelRatio,n.height=i*e._devicePixelRatio},t._fixContainer=function(){document.body.insertBefore(u.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=u.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0},e}();WT.EQUAL_TO_FRAME=void 0,WT.PROPORTION_TO_FRAME=void 0;var YT=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,i,n,r,s){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var a=new j(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,s],this._result.viewport=a,this._result},e}();YT.EXACT_FIT=void 0,YT.SHOW_ALL=void 0,YT.NO_BORDER=void 0,YT.FIXED_HEIGHT=void 0,YT.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="EqualToFrame",t}return a(t,e),t.prototype.apply=function(e){var t=e._frameSize.height,i=u.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"},t}(WT),t=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ProportionalToFrame",t}return a(t,e),t.prototype.apply=function(e,t){var i,n,r=e._frameSize.width,s=e._frameSize.height,a=u.game.container.style,o=t.width,h=t.height,l=r/o,_=s/h;l<_?(i=r,n=h*l):(i=o*_,n=s);var c=Math.round((r-i)/2),d=Math.round((s-n)/2);i=r-2*c,n=s-2*d,this._setupContainer(e,i,n),e._isRotated?a.margin="0 0 0 "+s+"px":a.margin="0px",a.paddingLeft=c+"px",a.paddingRight=c+"px",a.paddingTop=d+"px",a.paddingBottom=d+"px"},t}(WT),i=("undefined"==typeof window?global:window).__globalAdapter;i&&(i.adaptContainerStrategy&&i.adaptContainerStrategy(WT.prototype),i.adaptView&&i.adaptView(VT.prototype)),WT.EQUAL_TO_FRAME=new e,WT.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ExactFit",t}return a(t,e),t.prototype.apply=function(e,t){var i=u.game.canvas.width,n=u.game.canvas.height,r=i/t.width,s=n/t.height;return this._buildResult(i,n,i,n,r,s)},t}(YT),r=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ShowAll",t}return a(t,e),t.prototype.apply=function(e,t){var i,n,r=u.game.canvas.width,s=u.game.canvas.height,a=t.width,o=t.height,h=r/a,l=s/o,_=0;return h<l?(i=r,n=o*(_=h)):(i=a*(_=l),n=s),this._buildResult(r,s,i,n,_,_)},t}(YT),s=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="NoBorder",t}return a(t,e),t.prototype.apply=function(e,t){var i,n,r,s=u.game.canvas.width,a=u.game.canvas.height,o=t.width,h=t.height,l=s/o,_=a/h;return l<_?(n=o*(i=_),r=a):(n=s,r=h*(i=l)),this._buildResult(s,a,n,r,i,i)},t}(YT),o=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="FixedHeight",t}return a(t,e),t.prototype.apply=function(e,t){var i=u.game.canvas.width,n=u.game.canvas.height,r=n/t.height,s=i,a=n;return this._buildResult(i,n,s,a,r,r)},t}(YT),h=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="FixedWidth",t}return a(t,e),t.prototype.apply=function(e,t){var i=u.game.canvas.width,n=u.game.canvas.height,r=i/t.width,s=i,a=n;return this._buildResult(i,n,s,a,r,r)},t}(YT);YT.EXACT_FIT=new n,YT.SHOW_ALL=new r,YT.NO_BORDER=new s,YT.FIXED_HEIGHT=new o,YT.FIXED_WIDTH=new h}();var XT=e("bP",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof WT&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof YT&&(this._contentStrategy=e)},s(e,[{key:"canvasSize",get:function(){return u.v2(u.game.canvas.width,u.game.canvas.height)}}]),e}());XT.EXACT_FIT=0,XT.NO_BORDER=1,XT.SHOW_ALL=2,XT.FIXED_HEIGHT=3,XT.FIXED_WIDTH=4,XT.UNKNOWN=5,XT.ContainerStrategy=WT,XT.ContentStrategy=YT,u.ResolutionPolicy=XT,e("bQ",VT.instance=u.view=new VT),u.winSize=new K;var jT=null,KT=null,ZT=null,QT=null,qT=e("bT",function(e){function t(){return e.call(this)||this}a(t,e);var i=t.prototype;return i.setAccelerometerEnabled=function(e){e&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){console.log("Device Motion Event request permission: "+e),UT.setAccelerometerEnabled("granted"===e)})):UT.setAccelerometerEnabled(e)},i.setAccelerometerInterval=function(e){UT.setAccelerometerInterval(e)},i.on=function(t,i,n,r){return e.prototype.on.call(this,t,i,n,r),t!==o_.KEY_DOWN&&t!==o_.KEY_UP||jT||(jT=H_.create({event:H_.KEYBOARD,onKeyPressed:function(e,t){t.type=o_.KEY_DOWN,JT.emit(t.type,t)},onKeyReleased:function(e,t){t.type=o_.KEY_UP,JT.emit(t.type,t)}}),Q_.addListener(jT,256)),t===o_.DEVICEMOTION&&(KT||(KT=H_.create({event:H_.ACCELERATION,callback:function(e,t){t.type=o_.DEVICEMOTION,u.systemEvent.emit(t.type,t)}}),Q_.addListener(KT,256))),t!==o_.TOUCH_START&&t!==o_.TOUCH_MOVE&&t!==o_.TOUCH_END&&t!==o_.TOUCH_CANCEL||ZT||(ZT=H_.create({event:H_.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=o_.TOUCH_START,u.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=o_.TOUCH_MOVE,u.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=o_.TOUCH_END,u.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=o_.TOUCH_CANCEL,u.systemEvent.emit(t.type,e,t)}}),Q_.addListener(ZT,256)),t!==o_.MOUSE_DOWN&&t!==o_.MOUSE_MOVE&&t!==o_.MOUSE_UP&&t!==o_.MOUSE_WHEEL||QT||(QT=H_.create({event:H_.MOUSE,onMouseDown:function(e){e.type=o_.MOUSE_DOWN,u.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=o_.MOUSE_MOVE,u.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=o_.MOUSE_UP,u.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=o_.MOUSE_WHEEL,u.systemEvent.emit(e.type,e)}}),Q_.addListener(QT,256)),i},i.off=function(t,i,n){if(e.prototype.off.call(this,t,i,n),jT&&(t===o_.KEY_DOWN||t===o_.KEY_UP)){var r=this.hasEventListener(o_.KEY_DOWN),s=this.hasEventListener(o_.KEY_UP);r||s||(Q_.removeListener(jT),jT=null)}if(KT&&t===o_.DEVICEMOTION&&(Q_.removeListener(KT),KT=null),ZT&&(t===o_.TOUCH_START||t===o_.TOUCH_MOVE||t===o_.TOUCH_END||t===o_.TOUCH_CANCEL)){var a=this.hasEventListener(o_.TOUCH_START),o=this.hasEventListener(o_.TOUCH_MOVE),h=this.hasEventListener(o_.TOUCH_END),u=this.hasEventListener(o_.TOUCH_CANCEL);a||o||h||u||(Q_.removeListener(ZT),ZT=null)}if(QT&&(t===o_.MOUSE_DOWN||t===o_.MOUSE_MOVE||t===o_.MOUSE_UP||t===o_.MOUSE_WHEEL)){var l=this.hasEventListener(o_.MOUSE_DOWN),_=this.hasEventListener(o_.MOUSE_MOVE),c=this.hasEventListener(o_.MOUSE_UP),d=this.hasEventListener(o_.MOUSE_WHEEL);l||_||c||d||(Q_.removeListener(QT),QT=null)}},t}(De));qT.EventType=o_,u.SystemEvent=qT;var JT=e("bU",new qT);u.systemEvent=JT,h(o_,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}])}}}));
