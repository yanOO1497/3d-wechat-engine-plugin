System.register(["./deprecated-d2827829.js"],(function(e){"use strict";var t,n,i,r,o,a,s,c,l,u,_,f,h,d,v,m,p,g,y,x,S,C,T,E,A,b,w,I,R,O,P,N,D,z,M,L,F,k,U,B,G,j,V,H,q,W,X,Y,K,Q,J,Z,$,ee,te,ne,ie,re,oe,ae,se,ce,le,ue,_e,fe,he,de,ve,me,pe,ge,ye,xe,Se,Ce,Te,Ee,Ae,be,we,Ie,Re,Oe,Pe,Ne,De,ze,Me,Le,Fe,ke,Ue,Be,Ge,je,Ve,He,qe,We,Xe,Ye,Ke,Qe,Je,Ze,$e,et,tt,nt,it,rt,ot,at,st,ct,lt,ut,_t;return{setters:[function(e){t=e.aJ,n=e.aK,i=e.aL,r=e.j,o=e.d,a=e.l,s=e.V,c=e.b,l=e.e,u=e.f,_=e.E,f=e.M,h=e.O,d=e.$,v=e.K,m=e.aj,p=e.ar,g=e.k,y=e.ae,x=e.ad,S=e.af,C=e.ao,T=e.ap,E=e.c,A=e._,b=e.s,w=e.F,I=e.g,R=e.aM,O=e.aI,P=e.aN,N=e.D,D=e.aC,z=e.aO,M=e.i,L=e.y,F=e.t,k=e.ai,U=e.aP,B=e.aQ,G=e.x,j=e.w,V=e.aR,H=e.aS,q=e.aT,W=e.Q,X=e.H,Y=e.W,K=e.T,Q=e.aU,J=e.aV,Z=e.ay,$=e.z,ee=e.v,te=e.as,ne=e.aW,ie=e.p,re=e.aX,oe=e.o,ae=e.aY,se=e.aZ,ce=e.a_,le=e.C,ue=e.a$,_e=e.b0,fe=e.b1,he=e.h,de=e.m,ve=e.b2,me=e.a,pe=e.a2,ge=e.P,ye=e.Y,xe=e.a4,Se=e.a3,Ce=e.aq,Te=e.b3,Ee=e.b4,Ae=e.b5,be=e.b6,we=e.b7,Ie=e.b8,Re=e.b9,Oe=e.ba,Pe=e.bb,Ne=e.bc,De=e.bd,ze=e.be,Me=e.bf,Le=e.bg,Fe=e.bh,ke=e.bi,Ue=e.bj,Be=e.bk,Ge=e.bl,je=e.bm,Ve=e.bn,He=e.ak,qe=e.bo,We=e.bp,Xe=e.bq,Ye=e.br,Ke=e.n,Qe=e.bs,Je=e.aB,Ze=e.bt,$e=e.bu,et=e.ax,tt=e.ac,nt=e.X,it=e.aH,rt=e.bv,ot=e.az,at=e.av,st=e.bw,ct=e.r,lt=e.bx,ut=e.by,_t=e.bz}],execute:function(){e({B:void 0,D:void 0,E:void 0,F:void 0,G:void 0,H:void 0,O:mf,P:void 0,U:void 0,_:It,a:wt,a3:void 0,a4:void 0,a5:void 0,aA:Ff,aD:function(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)},aE:function(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t},aF:_o,aG:function(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;var o=e;for(;t>n&&o.length>1;){for(var a=o.length*(n/t)|0,s=fo(o,a),c=t-i(s),l=s,u=0,_=0;c>n&&_++<10;)a*=n/c,s=fo(o,a|=0),c=t-i(s);for(_=0;c<=n&&_++<10;){if(s){var f=ao.exec(s);u=f?f[0].length:1,l=s}s=fo(o,a+=u),c=t-i(s)}0===(a-=u)?(a=1,l=fo(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=fo(o,2));var h=fo(o,0,a),d=void 0;so.test(l||s)&&(d=co.exec(h),0===(a-=d?d[0].length:0)&&(a=1),l=fo(o,a),h=fo(o,0,a)),uo.test(l)&&(d=lo.exec(h))&&h!==d[0]&&(a-=d[0].length,l=fo(o,a),h=fo(o,0,a)),(0===r.length||(h=h.trim()).length>0)&&r.push(h),t=i(o=l||s)}(0===r.length||(o=o.trim()).length>0)&&r.push(o);return r},aI:ui,aJ:fd,aK:hd,aN:Id,aO:Vd,af:As,ag:bs,ah:void 0,ak:void 0,am:Lo,ao:yc,av:Ku,aw:Qu,az:function(e){for(var t=e,n=0;n<(arguments.length<=1?0:arguments.length-1);++n){var i=n+1<1||arguments.length<=n+1?void 0:arguments[n+1];if(Ku(i)){if(!(i in t))return j('Target object has no property "'.concat(i,'"')),null;t=t[i]}else t=i.get(t);if(null===t)break}return t},b:Et,bA:void 0,bB:void 0,bC:void 0,bD:void 0,bE:void 0,bF:void 0,bG:void 0,bH:void 0,bI:void 0,bJ:void 0,bK:void 0,bL:void 0,bM:void 0,bN:void 0,bO:void 0,bP:void 0,bQ:void 0,bR:void 0,bS:void 0,bT:void 0,bU:void 0,bV:void 0,bW:void 0,b_:void 0,bg:void 0,bu:void 0,bw:void 0,bx:void 0,by:void 0,bz:void 0,c:bt,c4:void 0,c8:Kn,c9:Qn,cC:function(e){return e>0&&0==(e&e-1)},cZ:zf,ca:Zn,cb:$n,cc:void 0,cd:void 0,d:At,d5:function(e,t){var n=e,i="";for(;null!==n&&n!==t;)i="".concat(n.name,"/").concat(i),n=n.parent;return i.slice(0,-1)},d6:t_,dG:void 0,dL:function(e){for(var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),o=e.struct,a=o.primitives[n],s=N(a.vertexBundelIndices);!(t=s()).done;)for(var c,l=t.value,u=o.vertexBundles[l],_=u.view.offset,f=u.view,h=f.length,d=f.stride,v=N(u.attributes);!(c=v()).done;){var m=c.value,p=Tf[m.name];p&&(i[p]=(i[p]||[]).concat(yo(r,m.format,_,h,d))),_+=Yn[m.format].size}var g=a.indexView;return i.indices=yo(r,on["R".concat(8*g.stride,"UI")],g.offset,g.length),i},dM:yo,dN:go,dO:xo,dQ:void 0,dR:void 0,dT:function(e){return"function"==typeof e.lerp},dU:void 0,dW:void 0,dZ:void 0,df:void 0,dj:void 0,dk:void 0,dm:void 0,dp:void 0,dq:void 0,ds:function(e,t,n){var i=a.loader._autoReleaseSetting,r=Be();if(t)for(var o=0;o<t.length;o++)r[t[o]]=!0;for(var s=0;s<n.length;s++)np(n[s],r);if(e)for(var c=0;c<e.length;c++){var l=e[c];!1===i[l]||r[l]||a.loader.release(l)}for(var u=Object.keys(i),_=0;_<u.length;_++){var f=u[_];!0!==i[f]||r[f]||a.loader.release(f)}},e:Ct,f:void 0,g:Ot,h:void 0,i:void 0,j:St,k:r_,m:Tt,o:I_,p:R_,q:O_,s:Rt,t:void 0,v:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=.5*n,o=i.radialSegments||32,a=i.heightSegments||1,c=void 0===i.capped||i.capped,l=i.arc||2*Math.PI,u=0;c||(e>0&&u++,t>0&&u++);var _=(o+1)*(a+1);c&&(_+=(o+1)*u+o*u);var f=o*a*2*3;c&&(f+=o*u*3);var h=new Array(f),d=new Array(3*_),v=new Array(3*_),m=new Array(2*_),p=Math.max(e,t),g=new s(-p,-r,-p),y=new s(p,r,p),x=Math.sqrt(p*p+r*r),S=0,C=0;T(),c&&(t>0&&E(!1),e>0&&E(!0));return{positions:d,normals:v,uvs:m,indices:h,minPos:g,maxPos:y,boundingRadius:x};function T(){for(var i=[],c=e-t,u=c*c/n*Math.sign(c),_=0;_<=a;_++){for(var f=[],p=_/a,g=p*c+t,y=0;y<=o;++y){var x=y/o,T=x*l,E=Math.sin(T),A=Math.cos(T);d[3*S]=g*E,d[3*S+1]=p*n-r,d[3*S+2]=g*A,s.normalize(Zf,s.set($f,E,-u,A)),v[3*S]=Zf.x,v[3*S+1]=Zf.y,v[3*S+2]=Zf.z,m[2*S]=2*(1-x)%1,m[2*S+1]=p,f.push(S),++S}i.push(f)}for(var b=0;b<a;++b)for(var w=0;w<o;++w){var I=i[b][w],R=i[b+1][w],O=i[b+1][w+1],P=i[b][w+1];h[C]=I,++C,h[C]=P,++C,h[C]=R,++C,h[C]=P,++C,h[C]=O,++C,h[C]=R,++C}}function E(n){for(var i=n?e:t,a=n?1:-1,s=S,c=1;c<=o;++c)d[3*S]=0,d[3*S+1]=r*a,d[3*S+2]=0,v[3*S]=0,v[3*S+1]=a,v[3*S+2]=0,m[2*S]=.5,m[2*S+1]=.5,++S;for(var u=S,_=0;_<=o;++_){var f=_/o*l,p=Math.cos(f),g=Math.sin(f);d[3*S]=i*g,d[3*S+1]=r*a,d[3*S+2]=i*p,v[3*S]=0,v[3*S+1]=a,v[3*S+2]=0,m[2*S]=.5-.5*g*a,m[2*S+1]=.5+.5*p,++S}for(var y=0;y<o;++y){var x=s+y,T=u+y;n?(h[C]=T+1,++C,h[C]=x,++C,h[C]=T,++C):(h[C]=x,++C,h[C]=T+1,++C,h[C]=T,++C)}}},w:kf,x:Uf,y:function(e){var t=function(e){return(e=kf(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),n=t.width,i=t.length,r=t.widthSegments,o=t.lengthSegments,a=.5*n,c=.5*i,l=[],u=[],_=[],f=new s(-a,0,-c),h=new s(a,0,c),d=Math.sqrt(n*n+i*i);s.set(rh,-a,0,c),s.set(oh,a,0,c),s.set(ah,-a,0,-c);for(var v=0;v<=o;v++)for(var m=0;m<=r;m++){var p=m/r,g=v/o;if(s.lerp(eh,rh,oh,p),s.lerp(th,rh,ah,g),s.subtract(nh,th,rh),s.add(ih,eh,nh),l.push(ih.x,ih.y,ih.z),t.includeUV&&u.push(p,g),m<r&&v<o){var y=r+1,x=m+v*y,S=m+(v+1)*y,C=m+1+(v+1)*y,T=m+1+v*y;_.push(x,T,S),_.push(T,C,S)}}var E={positions:l,indices:_,minPos:f,maxPos:h,boundingRadius:d};if(t.includeNormal){var A=(o+1)*(r+1),b=new Array(3*A);E.normals=b;for(var w=0;w<A;++w)b[3*w+0]=0,b[3*w+1]=1,b[3*w+2]=0}t.includeUV&&(E.uvs=u);return E},z:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=n-e-t,o=i.sides||32,a=i.heightSegments||32,c=t/n,l=r/n,u=e/n,_=Math.floor(a*c),f=Math.floor(a*u),h=Math.floor(a*l),d=r+t-n/2,v=t-n/2,m=t-n/2,p=i.arc||2*Math.PI,g=[],y=[],x=[],S=[],C=Math.max(e,t),T=new s(-C,-n/2,-C),E=new s(C,n/2,C),A=n/2,b=0,w=[];return R(),I(),O(),{positions:g,normals:y,uvs:x,indices:S,minPos:T,maxPos:E,boundingRadius:A};function I(){for(var n=(e-t)/r,i=0;i<=h;i++){for(var a=[],u=i/h,_=u*(e-t)+t,f=0;f<=o;++f){var d=f/o,m=u*l+c,C=d*p-p/4,T=Math.sin(C),E=Math.cos(C);g.push(_*T),g.push(u*r+v),g.push(_*E),s.normalize(sh,s.set(ch,T,-n,E)),y.push(sh.x),y.push(sh.y),y.push(sh.z),x.push(d,m),a.push(b),++b}w.push(a)}for(var A=0;A<h;++A)for(var I=0;I<o;++I){var R=w[A][I],O=w[A+1][I],P=w[A+1][I+1],N=w[A][I+1];S.push(R),S.push(N),S.push(O),S.push(N),S.push(P),S.push(O)}}function R(){for(var e=0;e<=_;++e)for(var n=e*Math.PI/_/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,u=r,f=Math.cos(c)*i,h=s/o,d=e/a;if(g.push(l*t,u*t+m,f*t),y.push(l,u,f),x.push(h,d),e<_&&s<o){var v=o+1,p=v*e+s,C=v*(e+1)+s,T=v*(e+1)+s+1,E=v*e+s+1;S.push(p,E,C),S.push(E,T,C)}++b}}function O(){for(var t=0;t<=f;++t)for(var n=t*Math.PI/f/2+Math.PI/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,_=r,v=Math.cos(c)*i,m=s/o,p=t/a+(1-u);if(g.push(l*e,_*e+d,v*e),y.push(l,_,v),x.push(m,p),t<f&&s<o){var C=o+1,T=C*t+s+w[h][o]+1,E=C*(t+1)+s+w[h][o]+1,A=C*(t+1)+s+1+w[h][o]+1,b=C*t+s+1+w[h][o]+1;S.push(T,b,E),S.push(b,A,E)}}}}});var ft=e("da",t("requireComponent")),ht=e("dd",t("executionOrder")),dt=e("d9",n("disallowMultiple")),vt=e("dP",(function(e,t,n){return i({__noImplicit:!0,override:!0})(e,t,n)})),mt=e("R",function(){function e(t,n){o(this,e),this._fn=void 0,this._count=0,this._data=void 0,this._fn=t,this._data=new Array(n);for(var i=0;i<n;++i)this._data[i]=t()}return r(e,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}()),pt=e("C",function(){function e(t,n){o(this,e),this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(t),this.length=0,this._compareFn=void 0!==n?n:function(e,t){return e-t}}return r(e,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[--this.length]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.length=0}},{key:"destroy",value:function(){this.length=0,this.array.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]}},{key:"fastRemove",value:function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}}},{key:"indexOf",value:function(e){return this.array.indexOf(e)}}]),e}()),gt=/(\.[^\.\/\?\\]*)(\?.*)?$/,yt=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,xt=/[^\.\/]+\/\.\.\//;function St(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function Ct(e){var t=gt.exec(e);return t?t[1]:""}function Tt(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function Et(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return"";var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function At(e){var t=yt.exec(e);return t?t[2]:""}function bt(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function wt(e,t,n){if(0===t.indexOf("."))return bt(e,t);var i=e.indexOf("?"),r="",o=n?Ct(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+o+r}function It(e){var t=e=String(e);do{t=e,e=e.replace(xt,"")}while(t.length!==e.length);return e}function Rt(e){return e.replace(/[\/\\]$/,"")}function Ot(){return a.sys.os===a.sys.OS_WINDOWS?"\\":"/"}e("aB",Object.freeze({__proto__:null,join:St,extname:Ct,mainFileName:Tt,basename:Et,dirname:At,changeExtname:bt,changeBasename:wt,_normalize:It,stripSep:Rt,getSeperator:Ot}));var Pt=e("dt",{SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512}),Nt=new s,Dt=new s,zt=new s,Mt=new s,Lt=new s,Ft=new s,kt=new Array(3),Ut=new Array(3);function Bt(e,t){return s.dot(t.n,e)-t.d}function Gt(e,t,n){return s.copy(e,t),s.subtract(Lt,n.center,n.halfExtents),s.add(Ft,n.center,n.halfExtents),e.x=e.x<Lt.x?Lt.x:e.x,e.y=e.y<Lt.x?Lt.y:e.y,e.z=e.z<Lt.x?Lt.z:e.z,e.x=e.x>Ft.x?Ft.x:e.x,e.y=e.y>Ft.x?Ft.y:e.y,e.z=e.z>Ft.x?Ft.z:e.z,e}function jt(e,t,n){s.set(Nt,n.orientation.m00,n.orientation.m01,n.orientation.m02),s.set(Dt,n.orientation.m03,n.orientation.m04,n.orientation.m05),s.set(zt,n.orientation.m06,n.orientation.m07,n.orientation.m08),kt[0]=Nt,kt[1]=Dt,kt[2]=zt,Ut[0]=n.halfExtents.x,Ut[1]=n.halfExtents.y,Ut[2]=n.halfExtents.z,s.subtract(Mt,t,n.center),s.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=s.dot(Mt,kt[i]);r>Ut[i]&&(r=Ut[i]),r<-Ut[i]&&(r=-Ut[i]),e.x+=r*kt[i].x,e.y+=r*kt[i].y,e.z+=r*kt[i].z}return e}e("du",Object.freeze({__proto__:null,point_plane:Bt,pt_point_plane:function(e,t,n){var i=Bt(t,n);return s.subtract(e,t,s.multiplyScalar(e,n.n,i))},pt_point_aabb:Gt,pt_point_obb:jt,pt_point_line:function(e,t,n,i){s.subtract(Nt,n,i);var r=Nt,o=s.lengthSqr(r);if(0==o)s.copy(e,n);else{s.subtract(Nt,t,n);var a=s.dot(Nt,r)/o;a<0?s.copy(e,n):a>1?s.copy(e,i):s.scaleAndAdd(e,n,r,a)}}}));var Vt=e("dy",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;o(this,e),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Pt.SHAPE_RAY,this.o=new s(t,n,i),this.d=new s(r,a,c)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;return new e(t,n,i,r,o,a)}},{key:"clone",value:function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}},{key:"copy",value:function(e,t){return s.copy(e.o,t.o),s.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,n){return s.copy(e.o,t),s.normalize(e.d,s.subtract(e.d,n,t)),e}},{key:"set",value:function(e,t,n,i,r,o,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=o,e.d.z=a,e}}]),r(e,[{key:"computeHit",value:function(e,t){s.normalize(e,this.d),s.scaleAndAdd(e,this.o,e,t)}}]),e}()),Ht=new s,qt=new s,Wt=new s,Xt=new s;function Yt(e){return Math.max(Math.max(e.x,e.y),e.z)}var Kt,Qt=e("dA",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;o(this,e),this.center=void 0,this.radius=void 0,this._type=void 0,this._type=Pt.SHAPE_SPHERE,this.center=new s(t,n,i),this.radius=r}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,n,i,r){return new e(t,n,i,r)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)}},{key:"copy",value:function(e,t){return s.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,n){return s.multiplyScalar(e.center,s.add(Ht,t,n),.5),e.radius=.5*s.subtract(Ht,n,t).length(),e}},{key:"set",value:function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e}},{key:"mergePoint",value:function(e,t,n){if(t.radius<0)return e.center=n,e.radius=0,e;s.subtract(qt,n,t.center);var i=qt.length();if(i>t.radius){var r=.5*(i-t.radius);e.radius+=r,s.multiplyScalar(qt,qt,r/i),s.add(e.center,e.center,qt)}return e}},{key:"mergeAABB",value:function(t,n,i){return i.getBoundary(Wt,Xt),e.mergePoint(t,n,Wt),e.mergePoint(t,n,Xt),t}}]),r(e,[{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}},{key:"getBoundary",value:function(e,t){s.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),s.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,n,i,r){s.transformMat4(r.center,this.center,e),r.radius=this.radius*Yt(i)}},{key:"translateAndRotate",value:function(e,t,n){s.transformMat4(n.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*Yt(e)}}]),e}()),Jt=e("dz",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,_=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;o(this,e),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Pt.SHAPE_TRIANGLE,this.a=new s(t,n,i),this.b=new s(r,a,c),this.c=new s(l,u,_)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return new e(t,n,i,r,o,a,s,c,l)}},{key:"clone",value:function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}},{key:"copy",value:function(e,t){return s.copy(e.a,t.a),s.copy(e.b,t.b),s.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,n,i){return s.copy(e.a,t),s.copy(e.b,n),s.copy(e.c,i),e}},{key:"set",value:function(e,t,n,i,r,o,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e}}]),e}()),Zt=e("bq",16),$t=e("br",16),en=e("bs",4),tn=e("bt",24);!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BUFFER=1]="BUFFER",e[e.TEXTURE=2]="TEXTURE",e[e.RENDER_PASS=3]="RENDER_PASS",e[e.FRAMEBUFFER=4]="FRAMEBUFFER",e[e.SAMPLER=5]="SAMPLER",e[e.SHADER=6]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=9]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=12]="COMMAND_BUFFER",e[e.FENCE=13]="FENCE",e[e.QUEUE=14]="QUEUE",e[e.WINDOW=15]="WINDOW"}(Kt||(Kt=e("bu",{})));var nn,rn,on,an,sn,cn,ln,un,_n,fn,hn,dn,vn,mn,pn,gn,yn,xn,Sn,Cn,Tn,En,An,bn,wn,In,Rn,On,Pn,Nn,Dn,zn,Mn=e("bv",function(){function e(t){o(this,e),this._gfxType=Kt.UNKNOWN,this._gfxType=t}return r(e,[{key:"gfxType",get:function(){return this._gfxType}}]),e}());!function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(nn||(nn=e("G",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.COUNT=32]="COUNT"}(rn||(rn=e("bw",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.D16=54]="D16",e[e.D16S8=55]="D16S8",e[e.D24=56]="D24",e[e.D24S8=57]="D24S8",e[e.D32F=58]="D32F",e[e.D32F_S8=59]="D32F_S8",e[e.BC1=60]="BC1",e[e.BC1_ALPHA=61]="BC1_ALPHA",e[e.BC1_SRGB=62]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",e[e.BC2=64]="BC2",e[e.BC2_SRGB=65]="BC2_SRGB",e[e.BC3=66]="BC3",e[e.BC3_SRGB=67]="BC3_SRGB",e[e.BC4=68]="BC4",e[e.BC4_SNORM=69]="BC4_SNORM",e[e.BC5=70]="BC5",e[e.BC5_SNORM=71]="BC5_SNORM",e[e.BC6H_UF16=72]="BC6H_UF16",e[e.BC6H_SF16=73]="BC6H_SF16",e[e.BC7=74]="BC7",e[e.BC7_SRGB=75]="BC7_SRGB",e[e.ETC_RGB8=76]="ETC_RGB8",e[e.ETC2_RGB8=77]="ETC2_RGB8",e[e.ETC2_SRGB8=78]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=81]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",e[e.EAC_R11=83]="EAC_R11",e[e.EAC_R11SN=84]="EAC_R11SN",e[e.EAC_RG11=85]="EAC_RG11",e[e.EAC_RG11SN=86]="EAC_RG11SN",e[e.PVRTC_RGB2=87]="PVRTC_RGB2",e[e.PVRTC_RGBA2=88]="PVRTC_RGBA2",e[e.PVRTC_RGB4=89]="PVRTC_RGB4",e[e.PVRTC_RGBA4=90]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=91]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=92]="PVRTC2_4BPP",e[e.ASTC_RGBA_4x4=93]="ASTC_RGBA_4x4",e[e.ASTC_RGBA_5x4=94]="ASTC_RGBA_5x4",e[e.ASTC_RGBA_5x5=95]="ASTC_RGBA_5x5",e[e.ASTC_RGBA_6x5=96]="ASTC_RGBA_6x5",e[e.ASTC_RGBA_6x6=97]="ASTC_RGBA_6x6",e[e.ASTC_RGBA_8x5=98]="ASTC_RGBA_8x5",e[e.ASTC_RGBA_8x6=99]="ASTC_RGBA_8x6",e[e.ASTC_RGBA_8x8=100]="ASTC_RGBA_8x8",e[e.ASTC_RGBA_10x5=101]="ASTC_RGBA_10x5",e[e.ASTC_RGBA_10x6=102]="ASTC_RGBA_10x6",e[e.ASTC_RGBA_10x8=103]="ASTC_RGBA_10x8",e[e.ASTC_RGBA_10x10=104]="ASTC_RGBA_10x10",e[e.ASTC_RGBA_12x10=105]="ASTC_RGBA_12x10",e[e.ASTC_RGBA_12x12=106]="ASTC_RGBA_12x12",e[e.ASTC_SRGBA_4x4=107]="ASTC_SRGBA_4x4",e[e.ASTC_SRGBA_5x4=108]="ASTC_SRGBA_5x4",e[e.ASTC_SRGBA_5x5=109]="ASTC_SRGBA_5x5",e[e.ASTC_SRGBA_6x5=110]="ASTC_SRGBA_6x5",e[e.ASTC_SRGBA_6x6=111]="ASTC_SRGBA_6x6",e[e.ASTC_SRGBA_8x5=112]="ASTC_SRGBA_8x5",e[e.ASTC_SRGBA_8x6=113]="ASTC_SRGBA_8x6",e[e.ASTC_SRGBA_8x8=114]="ASTC_SRGBA_8x8",e[e.ASTC_SRGBA_10x5=115]="ASTC_SRGBA_10x5",e[e.ASTC_SRGBA_10x6=116]="ASTC_SRGBA_10x6",e[e.ASTC_SRGBA_10x8=117]="ASTC_SRGBA_10x8",e[e.ASTC_SRGBA_10x10=118]="ASTC_SRGBA_10x10",e[e.ASTC_SRGBA_12x10=119]="ASTC_SRGBA_12x10",e[e.ASTC_SRGBA_12x12=120]="ASTC_SRGBA_12x12"}(on||(on=e("f",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(an||(an=e("h",{}))),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(sn||(sn=e("i",{}))),function(e){e[e.NONE=0]="NONE",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(cn||(cn=e("bx",{}))),function(e){e[e.NONE=0]="NONE",e[e.READ=1]="READ",e[e.WRITE=2]="WRITE"}(ln||(ln=e("by",{}))),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(un||(un=e("t",{}))),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(_n||(_n=e("bz",{}))),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(fn||(fn=e("bA",{}))),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(hn||(hn=e("bB",{}))),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(dn||(dn=e("bC",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(vn||(vn=e("bD",{}))),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(mn||(mn=e("bE",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(pn||(pn=e("bF",{}))),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(gn||(gn=e("bG",{}))),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(yn||(yn=e("bH",{}))),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(xn||(xn=e("bI",{}))),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Sn||(Sn=e("bJ",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",e[e.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(Cn||(Cn=e("bK",{}))),function(e){e[e.X1=0]="X1",e[e.X2=1]="X2",e[e.X4=2]="X4",e[e.X8=3]="X8",e[e.X16=4]="X16",e[e.X32=5]="X32",e[e.X64=6]="X64"}(Tn||(Tn=e("bL",{}))),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.CUBEMAP=2]="CUBEMAP",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(En||(En=e("bM",{}))),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(An||(An=e("bN",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER=16]="SAMPLER"}(bn||(bn=e("bO",{}))),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(wn||(wn=e("bP",{}))),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(In||(In=e("bQ",{}))),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Rn||(Rn=e("bR",{}))),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.GENERAL=1]="GENERAL",e[e.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",e[e.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",e[e.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",e[e.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",e[e.PREINITIALIZED=8]="PREINITIALIZED",e[e.PRESENT_SRC=9]="PRESENT_SRC"}(On||(On=e("bS",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Pn||(Pn=e("bT",{}))),function(e){e[e.NONE=0]="NONE",e[e.VIEWPORT=1]="VIEWPORT",e[e.SCISSOR=2]="SCISSOR",e[e.LINE_WIDTH=4]="LINE_WIDTH",e[e.DEPTH_BIAS=8]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(Nn||(Nn=e("bU",{}))),function(e){e[e.FRONT=0]="FRONT",e[e.BACK=1]="BACK",e[e.ALL=2]="ALL"}(Dn||(Dn=e("bV",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(zn||(zn=e("bW",{})));var Ln,Fn=e("bX",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;o(this,e),this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0,this.x=t,this.y=n,this.width=i,this.height=r})),kn=e("bY",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;o(this,e),this.left=void 0,this.top=void 0,this.width=void 0,this.height=void 0,this.minDepth=void 0,this.maxDepth=void 0,this.left=t,this.top=n,this.width=i,this.height=r,this.minDepth=a,this.maxDepth=s})),Un=e("bZ",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;o(this,e),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=t,this.g=n,this.b=i,this.a=r}));!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Ln||(Ln=e("b_",{})));var Bn,Gn=e("b$",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;o(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.x=t,this.y=n,this.z=i})),jn=e("c0",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;o(this,e),this.width=void 0,this.height=void 0,this.depth=void 0,this.width=t,this.height=n,this.depth=i})),Vn=e("c1",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;o(this,e),this.mipLevel=void 0,this.baseArrayLayer=void 0,this.layerCount=void 0,this.mipLevel=t,this.baseArrayLayer=n,this.layerCount=i})),Hn=e("c2",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Vn,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Gn,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Vn,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Gn,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new jn;o(this,e),this.srcSubres=void 0,this.srcOffset=void 0,this.dstSubres=void 0,this.dstOffset=void 0,this.extent=void 0,this.srcSubres=t,this.srcOffset=n,this.dstSubres=i,this.dstOffset=r,this.extent=a})),qn=e("c3",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Gn,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new jn,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Vn;o(this,e),this.buffStride=void 0,this.buffTexHeight=void 0,this.texOffset=void 0,this.texExtent=void 0,this.texSubres=void 0,this.buffStride=t,this.buffTexHeight=n,this.texOffset=i,this.texExtent=r,this.texSubres=a}));!function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Bn||(Bn=e("c4",{})));var Wn=e("c5",(function e(t,n,i,r,a,s,c,l){o(this,e),this.name=void 0,this.size=void 0,this.count=void 0,this.type=void 0,this.hasAlpha=void 0,this.hasDepth=void 0,this.hasStencil=void 0,this.isCompressed=void 0,this.name=t,this.size=n,this.count=i,this.type=r,this.hasAlpha=a,this.hasDepth=s,this.hasStencil=c,this.isCompressed=l})),Xn=e("c6",(function e(){o(this,e),this.bufferSize=0,this.textureSize=0})),Yn=e("c7",Object.freeze([new Wn("UNKNOWN",0,0,Bn.NONE,!1,!1,!1,!1),new Wn("A8",1,1,Bn.UNORM,!0,!1,!1,!1),new Wn("L8",1,1,Bn.UNORM,!1,!1,!1,!1),new Wn("LA8",1,2,Bn.UNORM,!0,!1,!1,!1),new Wn("R8",1,1,Bn.UNORM,!1,!1,!1,!1),new Wn("R8SN",1,1,Bn.SNORM,!1,!1,!1,!1),new Wn("R8UI",1,1,Bn.UINT,!1,!1,!1,!1),new Wn("R8I",1,1,Bn.INT,!1,!1,!1,!1),new Wn("R16F",2,1,Bn.FLOAT,!1,!1,!1,!1),new Wn("R16UI",2,1,Bn.UINT,!1,!1,!1,!1),new Wn("R16I",2,1,Bn.INT,!1,!1,!1,!1),new Wn("R32F",4,1,Bn.FLOAT,!1,!1,!1,!1),new Wn("R32UI",4,1,Bn.UINT,!1,!1,!1,!1),new Wn("R32I",4,1,Bn.INT,!1,!1,!1,!1),new Wn("RG8",2,2,Bn.UNORM,!1,!1,!1,!1),new Wn("RG8SN",2,2,Bn.SNORM,!1,!1,!1,!1),new Wn("RG8UI",2,2,Bn.UINT,!1,!1,!1,!1),new Wn("RG8I",2,2,Bn.INT,!1,!1,!1,!1),new Wn("RG16F",4,2,Bn.FLOAT,!1,!1,!1,!1),new Wn("RG16UI",4,2,Bn.UINT,!1,!1,!1,!1),new Wn("RG16I",4,2,Bn.INT,!1,!1,!1,!1),new Wn("RG32F",8,2,Bn.FLOAT,!1,!1,!1,!1),new Wn("RG32UI",8,2,Bn.UINT,!1,!1,!1,!1),new Wn("RG32I",8,2,Bn.INT,!1,!1,!1,!1),new Wn("RGB8",3,3,Bn.UNORM,!1,!1,!1,!1),new Wn("SRGB8",3,3,Bn.UNORM,!1,!1,!1,!1),new Wn("RGB8SN",3,3,Bn.SNORM,!1,!1,!1,!1),new Wn("RGB8UI",3,3,Bn.UINT,!1,!1,!1,!1),new Wn("RGB8I",3,3,Bn.INT,!1,!1,!1,!1),new Wn("RGB16F",6,3,Bn.FLOAT,!1,!1,!1,!1),new Wn("RGB16UI",6,3,Bn.UINT,!1,!1,!1,!1),new Wn("RGB16I",6,3,Bn.INT,!1,!1,!1,!1),new Wn("RGB32F",12,3,Bn.FLOAT,!1,!1,!1,!1),new Wn("RGB32UI",12,3,Bn.UINT,!1,!1,!1,!1),new Wn("RGB32I",12,3,Bn.INT,!1,!1,!1,!1),new Wn("RGBA8",4,4,Bn.UNORM,!0,!1,!1,!1),new Wn("BGRA8",4,4,Bn.UNORM,!0,!1,!1,!1),new Wn("SRGB8_A8",4,4,Bn.UNORM,!0,!1,!1,!1),new Wn("RGBA8SN",4,4,Bn.SNORM,!0,!1,!1,!1),new Wn("RGBA8UI",4,4,Bn.UINT,!0,!1,!1,!1),new Wn("RGBA8I",4,4,Bn.INT,!0,!1,!1,!1),new Wn("RGBA16F",8,4,Bn.FLOAT,!0,!1,!1,!1),new Wn("RGBA16UI",8,4,Bn.UINT,!0,!1,!1,!1),new Wn("RGBA16I",8,4,Bn.INT,!0,!1,!1,!1),new Wn("RGBA32F",16,4,Bn.FLOAT,!0,!1,!1,!1),new Wn("RGBA32UI",16,4,Bn.UINT,!0,!1,!1,!1),new Wn("RGBA32I",16,4,Bn.INT,!0,!1,!1,!1),new Wn("R5G6B5",2,3,Bn.UNORM,!1,!1,!1,!1),new Wn("R11G11B10F",4,3,Bn.FLOAT,!1,!1,!1,!1),new Wn("RGB5A1",2,4,Bn.UNORM,!0,!1,!1,!1),new Wn("RGBA4",2,4,Bn.UNORM,!0,!1,!1,!1),new Wn("RGB10A2",2,4,Bn.UNORM,!0,!1,!1,!1),new Wn("RGB10A2UI",2,4,Bn.UINT,!0,!1,!1,!1),new Wn("RGB9E5",2,4,Bn.FLOAT,!0,!1,!1,!1),new Wn("D16",2,1,Bn.UINT,!1,!0,!1,!1),new Wn("D16S8",3,2,Bn.UINT,!1,!0,!0,!1),new Wn("D24",3,1,Bn.UINT,!1,!0,!1,!1),new Wn("D24S8",4,2,Bn.UINT,!1,!0,!0,!1),new Wn("D32F",4,1,Bn.FLOAT,!1,!0,!1,!1),new Wn("D32FS8",5,2,Bn.FLOAT,!1,!0,!0,!1),new Wn("BC1",1,3,Bn.UNORM,!1,!1,!1,!0),new Wn("BC1_ALPHA",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("BC1_SRGB",1,3,Bn.UNORM,!1,!1,!1,!0),new Wn("BC1_SRGB_ALPHA",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("BC2",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("BC2_SRGB",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("BC3",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("BC3_SRGB",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("BC4",1,1,Bn.UNORM,!1,!1,!1,!0),new Wn("BC4_SNORM",1,1,Bn.SNORM,!1,!1,!1,!0),new Wn("BC5",1,2,Bn.UNORM,!1,!1,!1,!0),new Wn("BC5_SNORM",1,2,Bn.SNORM,!1,!1,!1,!0),new Wn("BC6H_UF16",1,3,Bn.UFLOAT,!1,!1,!1,!0),new Wn("BC6H_SF16",1,3,Bn.FLOAT,!1,!1,!1,!0),new Wn("BC7",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("BC7_SRGB",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ETC_RGB8",1,3,Bn.UNORM,!1,!1,!1,!0),new Wn("ETC2_RGB8",1,3,Bn.UNORM,!1,!1,!1,!0),new Wn("ETC2_SRGB8",1,3,Bn.UNORM,!1,!1,!1,!0),new Wn("ETC2_RGB8_A1",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ETC2_SRGB8_A1",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ETC2_RGBA8",2,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ETC2_SRGB8_A8",2,4,Bn.UNORM,!0,!1,!1,!0),new Wn("EAC_R11",1,1,Bn.UNORM,!1,!1,!1,!0),new Wn("EAC_R11SN",1,1,Bn.SNORM,!1,!1,!1,!0),new Wn("EAC_RG11",2,2,Bn.UNORM,!1,!1,!1,!0),new Wn("EAC_RG11SN",2,2,Bn.SNORM,!1,!1,!1,!0),new Wn("PVRTC_RGB2",2,3,Bn.UNORM,!1,!1,!1,!0),new Wn("PVRTC_RGBA2",2,4,Bn.UNORM,!0,!1,!1,!0),new Wn("PVRTC_RGB4",2,3,Bn.UNORM,!1,!1,!1,!0),new Wn("PVRTC_RGBA4",2,4,Bn.UNORM,!0,!1,!1,!0),new Wn("PVRTC2_2BPP",2,4,Bn.UNORM,!0,!1,!1,!0),new Wn("PVRTC2_4BPP",2,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_4x4",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_5x4",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_5x5",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_6x5",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_6x6",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_8x5",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_8x6",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_8x8",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_10x5",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_10x6",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_10x8",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_10x10",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_12x10",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_RGBA_12x12",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_4x4",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_5x4",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_5x5",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_6x5",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_6x6",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_8x5",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_8x6",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_8x8",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_10x5",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_10x6",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_10x8",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_10x10",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_12x10",1,4,Bn.UNORM,!0,!1,!1,!0),new Wn("ASTC_SRGBA_12x12",1,4,Bn.UNORM,!0,!1,!1,!0)]));function Kn(e,t,n,i){if(!Yn[e].isCompressed)return t*n*i*Yn[e].size;switch(e){case on.BC1:case on.BC1_ALPHA:case on.BC1_SRGB:case on.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case on.BC2:case on.BC2_SRGB:case on.BC3:case on.BC3_SRGB:case on.BC4:case on.BC4_SNORM:case on.BC6H_SF16:case on.BC6H_UF16:case on.BC7:case on.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case on.BC5:case on.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case on.ETC_RGB8:case on.ETC2_RGB8:case on.ETC2_SRGB8:case on.ETC2_RGB8_A1:case on.EAC_R11:case on.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case on.ETC2_RGBA8:case on.ETC2_SRGB8_A1:case on.EAC_RG11:case on.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case on.PVRTC_RGB2:case on.PVRTC_RGBA2:case on.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case on.PVRTC_RGB4:case on.PVRTC_RGBA4:case on.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case on.ASTC_RGBA_4x4:case on.ASTC_SRGBA_4x4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case on.ASTC_RGBA_5x4:case on.ASTC_SRGBA_5x4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case on.ASTC_RGBA_5x5:case on.ASTC_SRGBA_5x5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case on.ASTC_RGBA_6x5:case on.ASTC_SRGBA_6x5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case on.ASTC_RGBA_6x6:case on.ASTC_SRGBA_6x6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case on.ASTC_RGBA_8x5:case on.ASTC_SRGBA_8x5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case on.ASTC_RGBA_8x6:case on.ASTC_SRGBA_8x6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case on.ASTC_RGBA_8x8:case on.ASTC_SRGBA_8x8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case on.ASTC_RGBA_10x5:case on.ASTC_SRGBA_10x5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case on.ASTC_RGBA_10x6:case on.ASTC_SRGBA_10x6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case on.ASTC_RGBA_10x8:case on.ASTC_SRGBA_10x8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case on.ASTC_RGBA_10x10:case on.ASTC_SRGBA_10x10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case on.ASTC_RGBA_12x10:case on.ASTC_SRGBA_12x10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case on.ASTC_RGBA_12x12:case on.ASTC_SRGBA_12x12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function Qn(e,t,n,i,r){for(var o=0,a=0;a<r;++a)o+=Kn(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return o}var Jn=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Zn(e){return Jn[e]||0}function $n(e){var t=e.size/e.count;switch(e.type){case Bn.UNORM:case Bn.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Bn.SNORM:case Bn.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Bn.FLOAT:return Float32Array}return Float32Array}var ei,ti,ni=Object.freeze({__proto__:null,GFX_MAX_VERTEX_ATTRIBUTES:Zt,GFX_MAX_TEXTURE_UNITS:$t,GFX_MAX_ATTACHMENTS:en,GFX_MAX_BUFFER_BINDINGS:tn,get GFXObjectType(){return Kt},GFXObject:Mn,get GFXAttributeName(){return nn},get GFXType(){return rn},get GFXFormat(){return on},get GFXBufferUsageBit(){return an},get GFXMemoryUsageBit(){return sn},get GFXBufferFlagBit(){return cn},get GFXBufferAccessBit(){return ln},get GFXPrimitiveMode(){return un},get GFXPolygonMode(){return _n},get GFXShadeModel(){return fn},get GFXCullMode(){return hn},get GFXComparisonFunc(){return dn},get GFXStencilOp(){return vn},get GFXBlendOp(){return mn},get GFXBlendFactor(){return pn},get GFXColorMask(){return gn},get GFXFilter(){return yn},get GFXAddress(){return xn},get GFXTextureType(){return Sn},get GFXTextureUsageBit(){return Cn},get GFXSampleCount(){return Tn},get GFXTextureFlagBit(){return En},get GFXShaderStageFlagBit(){return An},get GFXDescriptorType(){return bn},get GFXCommandBufferType(){return wn},get GFXLoadOp(){return In},get GFXStoreOp(){return Rn},get GFXTextureLayout(){return On},get GFXPipelineBindPoint(){return Pn},get GFXDynamicStateFlagBit(){return Nn},get GFXStencilFace(){return Dn},get GFXQueueType(){return zn},GFXRect:Fn,GFXViewport:kn,GFXColor:Un,get GFXClearFlag(){return Ln},GFXOffset:Gn,GFXExtent:jn,GFXTextureSubres:Vn,GFXTextureCopy:Hn,GFXBufferTextureCopy:qn,get GFXFormatType(){return Bn},GFXFormatInfo:Wn,GFXMemoryStatus:Xn,GFXFormatInfos:Yn,GFXFormatSize:Kn,GFXFormatSurfaceSize:Qn,GFXGetTypeSize:Zn,getTypedArrayConstructor:$n}),ii=(e("bm",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;o(this,e),this.vertexCount=void 0,this.firstVertex=void 0,this.indexCount=void 0,this.firstIndex=void 0,this.vertexOffset=void 0,this.instanceCount=void 0,this.firstInstance=void 0,this.vertexCount=t,this.firstVertex=n,this.indexCount=i,this.firstIndex=r,this.vertexOffset=a,this.instanceCount=s,this.firstInstance=c})),e("bn",28),e("bo",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.BUFFER)))._device=void 0,n._usage=an.NONE,n._memUsage=sn.NONE,n._size=0,n._stride=1,n._count=0,n._flags=cn.NONE,n._bakcupBuffer=null,n._indirectBuffer=null,n._isBufferView=!1,n._device=e,n}return c(t,e),r(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}},{key:"backupBuffer",get:function(){return this._bakcupBuffer}}]),t}(Mn))),ri=e("bp",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.COMMAND_BUFFER)))._device=void 0,n._queue=null,n._type=wn.PRIMARY,n._numDrawCalls=0,n._numInstances=0,n._numTris=0,n._device=e,n}return c(t,e),r(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(Mn));_(on),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GL=1]="GL",e[e.GLES2=2]="GLES2",e[e.GLES3=3]="GLES3",e[e.METAL=4]="METAL",e[e.VULKAN=5]="VULKAN",e[e.DX12=6]="DX12",e[e.WEBGL=7]="WEBGL",e[e.WEBGL2=8]="WEBGL2"}(ei||(ei=e("cc",{}))),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_D16=7]="FORMAT_D16",e[e.FORMAT_D16S8=8]="FORMAT_D16S8",e[e.FORMAT_D24=9]="FORMAT_D24",e[e.FORMAT_D24S8=10]="FORMAT_D24S8",e[e.FORMAT_D32F=11]="FORMAT_D32F",e[e.FORMAT_D32FS8=12]="FORMAT_D32FS8",e[e.FORMAT_ETC1=13]="FORMAT_ETC1",e[e.FORMAT_ETC2=14]="FORMAT_ETC2",e[e.FORMAT_DXT=15]="FORMAT_DXT",e[e.FORMAT_PVRTC=16]="FORMAT_PVRTC",e[e.FORMAT_ASTC=17]="FORMAT_ASTC",e[e.FORMAT_RGB8=18]="FORMAT_RGB8",e[e.MSAA=19]="MSAA",e[e.ELEMENT_INDEX_UINT=20]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=21]="INSTANCED_ARRAYS",e[e.COUNT=22]="COUNT"}(ti||(ti=e("cd",{})));var oi=e("ce",(function e(){o(this,e),this.bufferOffsets=[],this.samplerOffsets=[]})),ai=e("cf",function(){function e(){o(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=ei.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(ti.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=tn,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._uboOffsetAlignment=1,this._depthBits=0,this._stencilBits=0,this._colorFmt=on.UNKNOWN,this._depthStencilFmt=on.UNKNOWN,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus={bufferSize:0,textureSize:0},this._clipSpaceMinZ=-1,this._screenSpaceSignY=1,this._UVSpaceSignY=-1}return r(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"genShaderId",value:function(){return this._shaderIdGen++}},{key:"defineMacro",value:function(e,t){var n=void 0!==t?t:"";this._macros.set(e,n)}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"maxTextureSize",get:function(){return this._maxTextureSize}},{key:"maxCubeMapTextureSize",get:function(){return this._maxCubeMapTextureSize}},{key:"uboOffsetAlignment",get:function(){return this._uboOffsetAlignment}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"clipSpaceMinZ",get:function(){return this._clipSpaceMinZ}},{key:"screenSpaceSignY",get:function(){return this._screenSpaceSignY}},{key:"UVSpaceSignY",get:function(){return this._UVSpaceSignY}}]),e}()),si=e("cg",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.FRAMEBUFFER)))._device=void 0,n._renderPass=null,n._colorTextures=[],n._depthStencilTexture=null,n._device=e,n}return c(t,e),r(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(Mn)),ci=String.prototype.charCodeAt;function li(e){return this[e]}function ui(e,t){for(var n=e.length,i=t^n,r=0,o="string"==typeof e?ci:li;n>=4;){var a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(e,r+2))<<16;case 2:i^=(255&o.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var _i=e("ch",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.INPUT_ASSEMBLER)))._device=void 0,n._attributes=[],n._vertexBuffers=[],n._indexBuffer=null,n._vertexCount=0,n._firstVertex=0,n._indexCount=0,n._firstIndex=0,n._vertexOffset=0,n._instanceCount=0,n._firstInstance=0,n._attributesHash=0,n._indirectBuffer=null,n._device=e,n}return c(t,e),r(t,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),r(t,[{key:"getVertexBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}},{key:"computeAttributesHash",value:function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=",".concat(n.name,",").concat(n.format,",").concat(n.isNormalized,",").concat(n.stream,",").concat(n.isInstanced)}return ui(e,666)}}]),t}(Mn)),fi=e("ck",function(){function e(){o(this,e),this.isDiscard=!1,this.polygonMode=_n.FILL,this.shadeModel=fn.GOURAND,this.cullMode=hn.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}return r(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}()),hi=e("cl",function(){function e(){o(this,e),this.depthTest=!0,this.depthWrite=!0,this.depthFunc=dn.LESS,this.stencilTestFront=!1,this.stencilFuncFront=dn.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=vn.KEEP,this.stencilZFailOpFront=vn.KEEP,this.stencilPassOpFront=vn.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=dn.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=vn.KEEP,this.stencilZFailOpBack=vn.KEEP,this.stencilPassOpBack=vn.KEEP,this.stencilRefBack=1}return r(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}()),di=e("cm",function(){function e(){o(this,e),this.blend=!1,this.blendSrc=pn.ONE,this.blendDst=pn.ZERO,this.blendEq=mn.ADD,this.blendSrcAlpha=pn.ONE,this.blendDstAlpha=pn.ZERO,this.blendAlphaEq=mn.ADD,this.blendColorMask=gn.ALL}return r(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}()),vi=e("cn",(function e(){o(this,e),this.isA2C=!1,this.isIndepend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.targets=[new di]})),mi=e("co",(function e(){o(this,e),this.attributes=[]})),pi=e("cp",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.PIPELINE_STATE)))._device=void 0,n._shader=null,n._pipelineLayout=null,n._primitive=un.TRIANGLE_LIST,n._is=null,n._rs=null,n._dss=null,n._bs=null,n._dynamicStates=Nn.NONE,n._renderPass=null,n._device=e,n}return c(t,e),r(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(Mn)),gi=e("cq",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.QUEUE)))._device=void 0,n._type=zn.GRAPHICS,n._isAsync=!1,n._device=e,n}return c(t,e),r(t,[{key:"type",get:function(){return this._type}}]),r(t,[{key:"isAsync",value:function(){return this._isAsync}}]),t}(Mn)),yi=e("cr",(function e(){o(this,e),this.format=on.UNKNOWN,this.sampleCount=1,this.loadOp=In.CLEAR,this.storeOp=Rn.STORE,this.beginLayout=On.UNDEFINED,this.endLayout=On.PRESENT_SRC})),xi=e("cs",(function e(){o(this,e),this.format=on.UNKNOWN,this.sampleCount=1,this.depthLoadOp=In.CLEAR,this.depthStoreOp=Rn.STORE,this.stencilLoadOp=In.CLEAR,this.stencilStoreOp=Rn.STORE,this.beginLayout=On.UNDEFINED,this.endLayout=On.DEPTH_STENCIL_ATTACHMENT_OPTIMAL})),Si=e("ct",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.RENDER_PASS)))._device=void 0,n._colorInfos=[],n._depthStencilInfo=null,n._subPasses=[],n._hash=0,n._device=e,n}return c(t,e),r(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subPasses}},{key:"hash",get:function(){return this._hash}}]),r(t,[{key:"computeHash",value:function(){var e="";if(this._subPasses.length)for(var t=0;t<this._subPasses.length;++t){var n=this._subPasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=",".concat(r.format,",").concat(r.sampleCount)}}if(n.colors.length){e+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];e+=",".concat(a.format,",").concat(a.sampleCount)}}if(void 0!==n.depthStencil){var s=this._colorInfos[n.depthStencil];e+="ds,".concat(s.format,",").concat(s.sampleCount)}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=",".concat(l.format,",").concat(l.sampleCount)}var u=this._depthStencilInfo;u&&(e+="ds,".concat(u.format,",").concat(u.sampleCount))}return ui(e,666)}}]),t}(Mn)),Ci=e("cu",function(){function e(){o(this,e),this.name="",this.minFilter=yn.LINEAR,this.magFilter=yn.LINEAR,this.mipFilter=yn.NONE,this.addressU=xn.WRAP,this.addressV=xn.WRAP,this.addressW=xn.WRAP,this.maxAnisotropy=16,this.cmpFunc=dn.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}return r(e,[{key:"compare",value:function(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}]),e}()),Ti=e("cv",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.SAMPLER)))._device=void 0,n._state=new Ci,n._device=e,n._state=new Ci,n}return c(t,e),r(t,[{key:"state",get:function(){return this._state}}]),t}(Mn)),Ei=(e("cw",(function e(){o(this,e),this.stage=An.NONE,this.source=""})),e("cx",(function e(){o(this,e),this.name="",this.type=rn.UNKNOWN,this.count=1})),e("cy",(function e(){o(this,e),this.set=-1,this.binding=-1,this.name="",this.members=[],this.count=1})),e("cz",(function e(){o(this,e),this.set=-1,this.binding=-1,this.name="",this.type=rn.UNKNOWN,this.count=1})),e("cA",(function e(){o(this,e),this.name="",this.stages=[],this.attributes=[],this.blocks=[],this.samplers=[]})),e("cB",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.SHADER)))._device=void 0,n._id=void 0,n._name="",n._stages=[],n._attributes=[],n._blocks=[],n._samplers=[],n._device=e,n._id=e.genShaderId(),n}return c(t,e),r(t,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(Mn)));var Ai,bi=e("cD",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.TEXTURE)))._device=void 0,n._type=Sn.TEX2D,n._usage=Cn.NONE,n._format=on.UNKNOWN,n._width=0,n._height=0,n._depth=1,n._layerCount=1,n._levelCount=1,n._samples=Tn.X1,n._flags=En.NONE,n._isPowerOf2=!1,n._size=0,n._buffer=null,n._device=e,n}return c(t,e),r(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),t}(Mn)),wi=e("bj",bn.UNIFORM_BUFFER|bn.DYNAMIC_UNIFORM_BUFFER|bn.STORAGE_BUFFER|bn.DYNAMIC_STORAGE_BUFFER),Ii=e("bk",bn.SAMPLER);e("bl",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.DESCRIPTOR_SET)))._device=void 0,n._layout=null,n._buffers=[],n._textures=[],n._samplers=[],n._isDirty=!1,n._device=e,n}return c(t,e),r(t,[{key:"layout",get:function(){return this._layout}}]),r(t,[{key:"bindBuffer",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this._layout.bindings[e],r=this._layout.descriptorIndices[e];i&&i.descriptorType&wi?this._buffers[r+n]!==t&&(this._buffers[r+n]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.UNIFORM_BUFFER.")}},{key:"bindSampler",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this._layout.bindings[e],r=this._layout.descriptorIndices[e];i&&i.descriptorType&Ii?this._samplers[r+n]!==t&&(this._samplers[r+n]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.SAMPLER.")}},{key:"bindTexture",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this._layout.bindings[e],r=this._layout.descriptorIndices[e];i&&i.descriptorType&Ii?this._textures[r+n]!==t&&(this._textures[r+n]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.SAMPLER.")}},{key:"getBuffer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._layout.descriptorIndices[e];return this._buffers[n+t]}},{key:"getSampler",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._layout.descriptorIndices[e];return this._samplers[n+t]}},{key:"getTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._layout.descriptorIndices[e];return this._textures[n+t]}}]),t}(Mn)),e("ci",bn.DYNAMIC_STORAGE_BUFFER|bn.DYNAMIC_UNIFORM_BUFFER),e("cj",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Kt.DESCRIPTOR_SET_LAYOUT)))._device=void 0,n._bindings=[],n._descriptorIndices=[],n._device=e,n}return c(t,e),r(t,[{key:"bindings",get:function(){return this._bindings}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(Mn));a.GFXDevice=ai,a.GFXBuffer=ii,a.GFXTexture=bi,a.GFXSampler=Ti,a.GFXShader=Ei,a.GFXInputAssembler=_i,a.GFXRenderPass=Si,a.GFXFramebuffer=si,a.GFXPipelineState=pi,a.GFXCommandBuffer=ri,a.GFXQueue=gi,Object.assign(a,ni),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(Ai||(Ai=e("dG",{})));var Ri,Oi,Pi,Ni,Di,zi,Mi=(Ri=new s(0,0,0),function(e,t){var n=s.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;s.multiplyScalar(Ri,t.n,t.d);var i=s.dot(s.subtract(Ri,Ri,e.o),t.n)/n;return i<0?0:i}),Li=(Oi=new s(0,0,0),Pi=new s(0,0,0),Ni=new s(0,0,0),Di=new s(0,0,0),zi=new s(0,0,0),function(e,t,n){s.subtract(Oi,t.b,t.a),s.subtract(Pi,t.c,t.a),s.cross(Ni,e.d,Pi);var i=s.dot(Oi,Ni);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;s.subtract(Di,e.o,t.a);var o=s.dot(Di,Ni)*r;if(o<0||o>1)return 0;s.cross(zi,Di,Oi);var a=s.dot(e.d,zi)*r;if(a<0||o+a>1)return 0;var c=s.dot(Pi,zi)*r;return c<0?0:c}),Fi=function(){var e=new s(0,0,0);return function(t,n){var i=n.radius,r=n.center,o=t.o,a=t.d,c=i*i;s.subtract(e,r,o);var l=e.lengthSqr(),u=s.dot(e,a),_=c-(l-u*u);if(_<0)return 0;var f=Math.sqrt(_),h=l<c?u+f:u-f;return h<0?0:h}}(),ki=function(){var e=new s,t=new s;return function(n,i){return s.subtract(e,i.center,i.halfExtents),s.add(t,i.center,i.halfExtents),Ui(n,e,t)}}();function Ui(e,t,n){var i=e.o,r=e.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(t.x-i.x)*o,l=(n.x-i.x)*o,u=(t.y-i.y)*a,_=(n.y-i.y)*a,f=(t.z-i.z)*s,h=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,_)),Math.min(f,h)),v=Math.min(Math.min(Math.max(c,l),Math.max(u,_)),Math.max(f,h));return v<0||d>v?0:d>0?d:v}var Bi,Gi,ji=function(){var e=new s,t=new s,n=new s,i=new s,r=new s,o=new s,a=new s,c=new Array(3),l=new Array(3),u=new Array(3),_=new Array(6);return function(f,h){c[0]=h.halfExtents.x,c[1]=h.halfExtents.y,c[2]=h.halfExtents.z,e=h.center,t=f.o,n=f.d,s.set(i,h.orientation.m00,h.orientation.m01,h.orientation.m02),s.set(r,h.orientation.m03,h.orientation.m04,h.orientation.m05),s.set(o,h.orientation.m06,h.orientation.m07,h.orientation.m08),s.subtract(a,e,t),l[0]=s.dot(i,n),l[1]=s.dot(r,n),l[2]=s.dot(o,n),u[0]=s.dot(i,a),u[1]=s.dot(r,a),u[2]=s.dot(o,a);for(var d=0;d<3;++d){if(0===l[d]){if(-u[d]-c[d]>0||-u[d]+c[d]<0)return 0;l[d]=1e-7}_[2*d+0]=(u[d]+c[d])/l[d],_[2*d+1]=(u[d]-c[d])/l[d]}var v=Math.max(Math.max(Math.min(_[0],_[1]),Math.min(_[2],_[3])),Math.min(_[4],_[5])),m=Math.min(Math.min(Math.max(_[0],_[1]),Math.max(_[2],_[3])),Math.max(_[4],_[5]));return m<0||v>m?0:v>0?v:m}}(),Vi=function(){var e=new s,t=new s,n=new s,i=new s,r=new s,o=new s,a=new s,c=new Qt;return function(l,u){var _=u.radius*u.radius,f=s.normalize(e,l.d),h=u.ellipseCenter0,d=u.ellipseCenter1,v=s.subtract(t,d,h);if(v.equals(s.ZERO))return c.radius=u.radius,c.center.set(u.ellipseCenter0),wr.ray_sphere(l,c);var m=l.o,p=s.subtract(n,m,h),g=s.cross(i,f,v),y=g.lengthSqr();if(0===y){c.radius=u.radius;var x=s.subtract(r,d,m);return p.lengthSqr()<x.lengthSqr()?c.center.set(u.ellipseCenter0):c.center.set(u.ellipseCenter1),wr.ray_sphere(l,c)}var S=s.cross(r,p,v),C=v.lengthSqr(),T=2*s.dot(g,S),E=T*T-4*y*(S.lengthSqr()-_*C);if(E<0)return 0;var A=(-T-Math.sqrt(E))/(2*y);if(A<0){c.radius=u.radius;var b=s.subtract(o,d,m);return p.lengthSqr()<b.lengthSqr()?c.center.set(u.ellipseCenter0):c.center.set(u.ellipseCenter1),wr.ray_sphere(l,c)}var w=s.scaleAndAdd(o,l.o,f,A),I=s.subtract(a,w,h),R=s.dot(I,v)/C;return R>=0&&R<=1?A:R<0?(c.radius=u.radius,c.center.set(u.ellipseCenter0),wr.ray_sphere(l,c)):R>1?(c.radius=u.radius,c.center.set(u.ellipseCenter1),wr.ray_sphere(l,c)):0}}(),Hi=function(){var e=Jt.create(),t={distance:1/0,doubleSided:!1,mode:Ai.ANY},n=0,i=function(e,t,i,r,o,a){e===Ai.CLOSEST?(n>t||0===n)&&(n=t,a&&(0===a.length?a.push({distance:t,vertexIndex0:i/3,vertexIndex1:r/3,vertexIndex2:o/3}):(a[0].distance=t,a[0].vertexIndex0=i/3,a[0].vertexIndex1=r/3,a[0].vertexIndex2=o/3))):(n=t,a&&a.push({distance:t,vertexIndex0:i/3,vertexIndex1:r/3,vertexIndex2:o/3}))};return function(r,o,a){if(n=0,0===o.geometricInfo.positions.length)return n;var c=void 0===a?t:a;if(Ui(r,o.geometricInfo.boundingBox.min,o.geometricInfo.boundingBox.max)){var l=o.primitiveMode,u=o.geometricInfo;!function(t,n,r,o,a){if(r===un.TRIANGLE_LIST)for(var c=n.length,l=0;l<c;l+=3){var u=3*n[l],_=3*n[l+1],f=3*n[l+2];s.set(e.a,t[u],t[u+1],t[u+2]),s.set(e.b,t[_],t[_+1],t[_+2]),s.set(e.c,t[f],t[f+1],t[f+2]);var h=wr.ray_triangle(o,e,a.doubleSided);if(!(0===h||h>a.distance)&&(i(a.mode,h,u,_,f,a.result),a.mode===Ai.ANY))return h}else if(r===un.TRIANGLE_STRIP)for(var d=n.length-2,v=0,m=0;m<d;m+=1){var p=3*n[m-v],g=3*n[m+v+1],y=3*n[m+2];s.set(e.a,t[p],t[p+1],t[p+2]),s.set(e.b,t[g],t[g+1],t[g+2]),s.set(e.c,t[y],t[y+1],t[y+2]),v=~v;var x=wr.ray_triangle(o,e,a.doubleSided);if(!(0===x||x>a.distance)&&(i(a.mode,x,p,g,y,a.result),a.mode===Ai.ANY))return x}else if(r===un.TRIANGLE_FAN){var S=n.length-1,C=3*n[0];s.set(e.a,t[C],t[C+1],t[C+2]);for(var T=1;T<S;T+=1){var E=3*n[T],A=3*n[T+1];s.set(e.b,t[E],t[E+1],t[E+2]),s.set(e.c,t[A],t[A+1],t[A+2]);var b=wr.ray_triangle(o,e,a.doubleSided);if(!(0===b||b>a.distance)&&(i(a.mode,b,C,E,A,a.result),a.mode===Ai.ANY))return b}}}(u.positions,u.indices,l,r,c)}return n}}(),qi=(Bi=0,Gi={distance:1/0,doubleSided:!1,mode:Ai.ANY},function(e,t,n){Bi=0;var i=void 0===n?Gi:n,r=t.renderingSubMeshes.length,o=t.struct.minPosition,a=t.struct.maxPosition;if(o&&a&&!Ui(e,o,a))return Bi;for(var s=0;s<r;s++){var c=t.renderingSubMeshes[s],l=Hi(e,c,i);if(l)if(i.mode===Ai.CLOSEST)(0===Bi||Bi>l)&&(Bi=l,i.subIndices&&(i.subIndices[0]=s));else if(Bi=l,i.subIndices&&i.subIndices.push(s),i.mode===Ai.ANY)return l}return Bi&&i.mode===Ai.CLOSEST&&(i.result&&(i.result[0].distance=Bi,i.result.length=1),i.subIndices&&(i.subIndices.length=1)),Bi}),Wi=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Ai.ANY},n=new Vt,i=new f;return function(r,o,a){e=0;var c=void 0===a?t:a,l=o.worldBounds;if(l&&!ki(r,l))return e;Vt.copy(n,r),o.node&&(f.invert(i,o.node.getWorldMatrix(i)),s.transformMat4(n.o,r.o,i),s.transformMat4Normal(n.d,r.d,i));for(var u=o.subModels,_=0;_<u.length;_++){var h=u[_].subMesh,d=Hi(n,h,c);if(d)if(c.mode===Ai.CLOSEST)(0===e||e>d)&&(e=d,c.subIndices&&(c.subIndices[0]=_));else if(e=d,c.subIndices&&c.subIndices.push(_),c.mode===Ai.ANY)return d}return e&&c.mode===Ai.CLOSEST&&(c.result&&(c.result[0].distance=e,c.result.length=1),c.subIndices&&(c.subIndices.length=1)),e}}(),Xi=function(){var e=new s(0,0,0);return function(t,n){s.subtract(e,t.e,t.s);var i=(n.d-s.dot(t.s,n.n))/s.dot(e,n.n);return i<0||i>1?0:i}}(),Yi=function(){var e=new s(0,0,0),t=new s(0,0,0),n=new s(0,0,0),i=new s(0,0,0),r=new s(0,0,0),o=new s(0,0,0);return function(a,c,l){s.subtract(e,c.b,c.a),s.subtract(t,c.c,c.a),s.subtract(n,a.s,a.e),s.cross(r,e,t);var u=s.dot(n,r);if(u<=0)return 0;s.subtract(i,a.s,c.a);var _=s.dot(i,r);if(_<0||_>u)return 0;s.cross(o,n,i);var f=s.dot(t,o);if(f<0||f>u)return 0;var h=-s.dot(e,o);if(h<0||f+h>u)return 0;if(l){var d=1/u,v=1-(f*=d)-(h*=d);s.set(l,c.a.x*v+c.b.x*f+c.c.x*h,c.a.y*v+c.b.y*f+c.c.y*h,c.a.z*v+c.b.z*f+c.c.z*h)}return 1}}(),Ki=new Vt;function Qi(e,t){Ki.o.set(e.s),s.subtract(Ki.d,e.e,e.s),Ki.d.normalize();var n=ki(Ki,t);return n<=e.length()?n:0}function Ji(e,t){Ki.o.set(e.s),s.subtract(Ki.d,e.e,e.s),Ki.d.normalize();var n=ji(Ki,t);return n<=e.length()?n:0}function Zi(e,t){Ki.o.set(e.s),s.subtract(Ki.d,e.e,e.s),Ki.d.normalize();var n=Fi(Ki,t);return n<=e.length()?n:0}var $i,er,tr,nr,ir=($i=new s,er=new s,tr=new s,nr=new s,function(e,t){return s.subtract($i,e.center,e.halfExtents),s.add(er,e.center,e.halfExtents),s.subtract(tr,t.center,t.halfExtents),s.add(nr,t.center,t.halfExtents),$i.x<=nr.x&&er.x>=tr.x&&$i.y<=nr.y&&er.y>=tr.y&&$i.z<=nr.z&&er.z>=tr.z});function rr(e,t,n,i,r,o){s.set(o[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),s.set(o[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),s.set(o[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),s.set(o[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),s.set(o[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),s.set(o[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),s.set(o[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),s.set(o[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function or(e,t){for(var n=s.dot(t,e[0]),i=n,r=1;r<8;++r){var o=s.dot(t,e[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var ar,sr,cr,lr=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new s(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new s(0,0,0),i[r]=new s(0,0,0);var o=new s,a=new s;return function(t,r){s.set(e[0],1,0,0),s.set(e[1],0,1,0),s.set(e[2],0,0,1),s.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),s.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),s.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var c=0;c<3;++c)s.cross(e[6+3*c+0],e[c],e[0]),s.cross(e[6+3*c+1],e[c],e[1]),s.cross(e[6+3*c+1],e[c],e[2]);s.subtract(o,t.center,t.halfExtents),s.add(a,t.center,t.halfExtents),function(e,t,n){s.set(n[0],e.x,t.y,t.z),s.set(n[1],e.x,t.y,e.z),s.set(n[2],e.x,e.y,t.z),s.set(n[3],e.x,e.y,e.z),s.set(n[4],t.x,t.y,t.z),s.set(n[5],t.x,t.y,e.z),s.set(n[6],t.x,e.y,t.z),s.set(n[7],t.x,e.y,e.z)}(o,a,n),rr(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var l=0;l<15;++l){var u=or(n,e[l]),_=or(i,e[l]);if(_[0]>u[1]||u[0]>_[1])return 0}return 1}}(),ur=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=s.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},_r=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===ur(e,t.planes[n]))return 0;return 1},fr=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new s(0,0,0);return function(i,r){for(var o=0,a=!1,c=0;c<r.planes.length;c++){if(-1===(o=ur(i,r.planes[c])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var l=0;l<r.vertices.length;l++)s.subtract(e[l],r.vertices[l],i.center);t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].x>i.halfExtents.x?t++:e[u].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var _=0;_<r.vertices.length;_++)e[_].y>i.halfExtents.y?t++:e[_].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var f=0;f<r.vertices.length;f++)e[f].z>i.halfExtents.z?t++:e[f].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),hr=(ar=new s(0,0,0),sr=new h,function(e,t){return s.subtract(ar,t,e.center),s.transformMat3(ar,ar,h.transpose(sr,e.orientation)),n=ar,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),dr=(cr=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*cr(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*cr(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*cr(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=s.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),vr=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===dr(e,t.planes[n]))return 0;return 1},mr=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new s(0,0,0);var o=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,a){for(var c=0,l=!1,u=0;u<a.planes.length;u++){if(-1===(c=dr(r,a.planes[u])))return 0;1===c&&(l=!0)}if(!l)return 1;for(var _=0;_<a.vertices.length;_++)s.subtract(e[_],a.vertices[_],r.center);n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=o(e[f],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=o(e[h],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var d=0;d<a.vertices.length;d++)(t=o(e[d],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),pr=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new s(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new s(0,0,0),i[r]=new s(0,0,0);return function(t,r){s.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),s.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),s.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),s.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),s.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),s.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)s.cross(e[6+3*o+0],e[o],e[0]),s.cross(e[6+3*o+1],e[o],e[1]),s.cross(e[6+3*o+1],e[o],e[2]);rr(t.center,t.halfExtents,e[0],e[1],e[2],n),rr(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var c=or(n,e[a]),l=or(i,e[a]);if(l[0]>c[1]||c[0]>l[1])return 0}return 1}}(),gr=function(){for(var e=new Qt,t=new s,n=new s,i=new s,r=new Array(8),o=0;o<8;o++)r[o]=new s;for(var a=new Array(8),c=0;c<8;c++)a[c]=new s;return function(o,c){if(0===s.squaredDistance(c.ellipseCenter0,c.ellipseCenter1))return e.radius=c.radius,e.center.set(c.ellipseCenter0),wr.sphere_obb(e,o);t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,rr(o.center,o.halfExtents,t,n,i,r);var l=a,u=s.copy(l[0],t),_=s.copy(l[1],n),f=s.copy(l[2],i);s.subtract(l[3],c.center,o.center).normalize();var h=s.subtract(l[4],c.ellipseCenter0,c.ellipseCenter1);h.normalize(),s.cross(l[5],u,h),s.cross(l[6],_,h),s.cross(l[7],f,h);for(var d=0;d<8;++d){var v=or(r,l[d]),m=s.dot(l[d],c.ellipseCenter0),p=s.dot(l[d],c.ellipseCenter1),g=Math.max(m,p),y=Math.min(m,p)-c.radius,x=g+c.radius;if(y>v[1]||v[0]>x)return 0}return 1}}(),yr=function(e,t){var n=s.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},xr=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===yr(e,t.planes[n]))return 0;return 1},Sr=function(){var e=new s(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,c=n.center,l=o.n,u=o.d,_=s.dot(l,c);if(_+a<u)return 0;if(!(_-a>u)){s.add(e,c,s.multiplyScalar(e,l,a));for(var f=0;f<6;f++)if(f!==r&&f!==r+t[r]){var h=i.planes[f];if(s.dot(h.n,e)<h.d)return 0}}}return 1}}(),Cr=function(e,t){var n=e.radius+t.radius;return s.squaredDistance(e.center,t.center)<n*n},Tr=function(){var e=new s;return function(t,n){return Gt(e,t.center,n),s.squaredDistance(t.center,e)<t.radius*t.radius}}(),Er=function(){var e=new s;return function(t,n){return jt(e,t.center,n),s.squaredDistance(t.center,e)<t.radius*t.radius}}(),Ar=function(){var e=new s,t=new s;return function(n,i){var r=n.radius+i.radius,o=r*r,a=s.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return s.squaredDistance(n.center,i.center)<o;s.subtract(e,n.center,i.ellipseCenter0),s.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var c=s.dot(e,t)/a;return c<0?s.squaredDistance(n.center,i.ellipseCenter0)<o:c>1?s.squaredDistance(n.center,i.ellipseCenter1)<o:(s.scaleAndAdd(e,i.ellipseCenter0,t,c),s.squaredDistance(n.center,e)<o)}}(),br=function(){var e=new s,t=new s,n=new s,i=new s,r=new s,o=new s;return function(a,c){var l,u,_,f,h=s.subtract(e,a.ellipseCenter1,a.ellipseCenter0),v=s.subtract(t,c.ellipseCenter1,c.ellipseCenter0),m=s.subtract(n,a.ellipseCenter0,c.ellipseCenter0),p=s.dot(h,h),g=s.dot(h,v),y=s.dot(v,v),x=s.dot(h,m),S=s.dot(v,m),C=p*y-g*g,T=C,E=C;C<d?(u=0,T=1,f=S,E=y):(f=p*S-g*x,(u=g*S-y*x)<0?(u=0,f=S,E=y):u>T&&(u=T,f=S+g,E=y)),f<0?(f=0,-x<0?u=0:-x>p?u=T:(u=-x,T=p)):f>E&&(f=E,-x+g<0?u=0:-x+g>p?u=T:(u=-x+g,T=p)),l=Math.abs(u)<d?0:u/T,_=Math.abs(f)<d?0:f/E;var A=i;A.set(m),A.add(s.multiplyScalar(r,h,l)),A.subtract(s.multiplyScalar(o,v,_));var b=a.radius+c.radius;return A.lengthSqr()<b*b}}(),wr=e("dv",{ray_sphere:Fi,ray_aabb:ki,ray_obb:ji,ray_plane:Mi,ray_triangle:Li,ray_capsule:Vi,ray_subMesh:Hi,ray_mesh:qi,ray_model:Wi,line_sphere:Zi,line_aabb:Qi,line_obb:Ji,line_plane:Xi,line_triangle:Yi,sphere_sphere:Cr,sphere_aabb:Tr,sphere_obb:Er,sphere_plane:yr,sphere_frustum:xr,sphere_frustum_accurate:Sr,sphere_capsule:Ar,aabb_aabb:ir,aabb_obb:lr,aabb_plane:ur,aabb_frustum:_r,aabb_frustum_accurate:fr,obb_obb:pr,obb_plane:dr,obb_frustum:vr,obb_frustum_accurate:mr,obb_point:hr,obb_capsule:gr,capsule_capsule:br,resolve:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=e._type,r=t._type,o=this[i|r];return i<r?o(e,t,n):o(t,e,n)}});wr[Pt.SHAPE_RAY|Pt.SHAPE_SPHERE]=Fi,wr[Pt.SHAPE_RAY|Pt.SHAPE_AABB]=ki,wr[Pt.SHAPE_RAY|Pt.SHAPE_OBB]=ji,wr[Pt.SHAPE_RAY|Pt.SHAPE_PLANE]=Mi,wr[Pt.SHAPE_RAY|Pt.SHAPE_TRIANGLE]=Li,wr[Pt.SHAPE_RAY|Pt.SHAPE_CAPSULE]=Vi,wr[Pt.SHAPE_LINE|Pt.SHAPE_SPHERE]=Zi,wr[Pt.SHAPE_LINE|Pt.SHAPE_AABB]=Qi,wr[Pt.SHAPE_LINE|Pt.SHAPE_OBB]=Ji,wr[Pt.SHAPE_LINE|Pt.SHAPE_PLANE]=Xi,wr[Pt.SHAPE_LINE|Pt.SHAPE_TRIANGLE]=Yi,wr[Pt.SHAPE_SPHERE]=Cr,wr[Pt.SHAPE_SPHERE|Pt.SHAPE_AABB]=Tr,wr[Pt.SHAPE_SPHERE|Pt.SHAPE_OBB]=Er,wr[Pt.SHAPE_SPHERE|Pt.SHAPE_PLANE]=yr,wr[Pt.SHAPE_SPHERE|Pt.SHAPE_FRUSTUM]=xr,wr[Pt.SHAPE_SPHERE|Pt.SHAPE_FRUSTUM_ACCURATE]=Sr,wr[Pt.SHAPE_SPHERE|Pt.SHAPE_CAPSULE]=Ar,wr[Pt.SHAPE_AABB]=ir,wr[Pt.SHAPE_AABB|Pt.SHAPE_OBB]=lr,wr[Pt.SHAPE_AABB|Pt.SHAPE_PLANE]=ur,wr[Pt.SHAPE_AABB|Pt.SHAPE_FRUSTUM]=_r,wr[Pt.SHAPE_AABB|Pt.SHAPE_FRUSTUM_ACCURATE]=fr,wr[Pt.SHAPE_OBB]=pr,wr[Pt.SHAPE_OBB|Pt.SHAPE_PLANE]=dr,wr[Pt.SHAPE_OBB|Pt.SHAPE_FRUSTUM]=vr,wr[Pt.SHAPE_OBB|Pt.SHAPE_FRUSTUM_ACCURATE]=mr,wr[Pt.SHAPE_OBB|Pt.SHAPE_CAPSULE]=gr,wr[Pt.SHAPE_CAPSULE]=br;var Ir=e("dw",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;o(this,e),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Pt.SHAPE_LINE,this.s=new s(t,n,i),this.e=new s(r,a,c)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)}},{key:"clone",value:function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}},{key:"copy",value:function(e,t){return s.copy(e.s,t.s),s.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,n){return s.copy(e.s,t),s.copy(e.e,n),e}},{key:"set",value:function(e,t,n,i,r,o,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=o,e.e.z=a,e}},{key:"len",value:function(e){return s.distance(e.s,e.e)}}]),r(e,[{key:"length",value:function(){return s.distance(this.s,this.e)}}]),e}()),Rr=new s(0,0,0),Or=new s(0,0,0),Pr=a.mat4(),Nr=a.v4(),Dr=e("dx",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;o(this,e),this.n=void 0,this.d=void 0,this._type=void 0,this._type=Pt.SHAPE_PLANE,this.n=new s(t,n,i),this.d=r}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,n,i,r){return new e(t,n,i,r)}},{key:"clone",value:function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)}},{key:"copy",value:function(e,t){return s.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,n,i){return s.subtract(Rr,n,t),s.subtract(Or,i,t),s.normalize(e.n,s.cross(e.n,Rr,Or)),e.d=s.dot(e.n,t),e}},{key:"set",value:function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,n){return s.copy(e.n,t),e.d=s.dot(t,n),e}},{key:"normalize",value:function(e,t){var n=t.n.length();return s.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e}}]),r(e,[{key:"transform",value:function(e){f.invert(Pr,e),f.transpose(Pr,Pr),v.set(Nr,this.n.x,this.n.y,this.n.z,this.d),v.transformMat4(Nr,Nr,Pr),s.set(this.n,Nr.x,Nr.y,Nr.z),this.d=Nr.w}}]),e}()),zr=new s,Mr=new s,Lr=new s,Fr=new s,kr=new h,Ur=function(e,t,n){kr.m00=Math.abs(n.m00),kr.m01=Math.abs(n.m01),kr.m02=Math.abs(n.m02),kr.m03=Math.abs(n.m04),kr.m04=Math.abs(n.m05),kr.m05=Math.abs(n.m06),kr.m06=Math.abs(n.m08),kr.m07=Math.abs(n.m09),kr.m08=Math.abs(n.m10),s.transformMat3(e,t,kr)},Br=e("dB",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;o(this,e),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=Pt.SHAPE_AABB,this.center=new s(t,n,i),this.halfExtents=new s(r,a,c)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}},{key:"copy",value:function(e,t){return s.copy(e.center,t.center),s.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,n){return s.add(zr,n,t),s.subtract(Mr,n,t),s.multiplyScalar(e.center,zr,.5),s.multiplyScalar(e.halfExtents,Mr,.5),e}},{key:"set",value:function(e,t,n,i,r,o,a){return s.set(e.center,t,n,i),s.set(e.halfExtents,r,o,a),e}},{key:"merge",value:function(t,n,i){return s.subtract(zr,n.center,n.halfExtents),s.subtract(Mr,i.center,i.halfExtents),s.add(Lr,n.center,n.halfExtents),s.add(Fr,i.center,i.halfExtents),s.max(Fr,Lr,Fr),s.min(Lr,zr,Mr),e.fromPoints(t,Lr,Fr)}},{key:"transform",value:function(e,t,n){return s.transformMat4(e.center,t.center,n),Ur(e.halfExtents,t.halfExtents,n),e}}]),r(e,[{key:"getBoundary",value:function(e,t){s.subtract(e,this.center,this.halfExtents),s.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,n,i,r){s.transformMat4(r.center,this.center,e),Ur(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}}]),e}()),Gr=new s,jr=new s,Vr=new h,Hr=(e("dC",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,_=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,f=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,d=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,v=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,m=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,p=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,g=arguments.length>14&&void 0!==arguments[14]?arguments[14]:1;o(this,e),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Pt.SHAPE_OBB,this.center=new s(t,n,i),this.halfExtents=new s(r,a,c),this.orientation=new h(l,u,_,f,d,v,m,p,g)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,n,i,r,o,a,s,c,l,u,_,f,h,d,v){return new e(t,n,i,r,o,a,s,c,l,u,_,f,h,d,v)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}},{key:"copy",value:function(e,t){return s.copy(e.center,t.center),s.copy(e.halfExtents,t.halfExtents),h.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,n){return s.multiplyScalar(e.center,s.add(Gr,t,n),.5),s.multiplyScalar(e.halfExtents,s.subtract(jr,n,t),.5),h.identity(e.orientation),e}},{key:"set",value:function(e,t,n,i,r,o,a,c,l,u,_,f,d,v,m,p){return s.set(e.center,t,n,i),s.set(e.halfExtents,r,o,a),h.set(e.orientation,c,l,u,_,f,d,v,m,p),e}}]),r(e,[{key:"getBoundary",value:function(e,t){!function(e,t,n){Vr.m00=Math.abs(n.m00),Vr.m01=Math.abs(n.m01),Vr.m02=Math.abs(n.m02),Vr.m03=Math.abs(n.m03),Vr.m04=Math.abs(n.m04),Vr.m05=Math.abs(n.m05),Vr.m06=Math.abs(n.m06),Vr.m07=Math.abs(n.m07),Vr.m08=Math.abs(n.m08),s.transformMat3(e,t,Vr)}(Gr,this.halfExtents,this.orientation),s.subtract(e,this.center,Gr),s.add(t,this.center,Gr)}},{key:"transform",value:function(e,t,n,i,r){s.transformMat4(r.center,this.center,e),h.fromQuat(r.orientation,n),s.multiply(r.halfExtents,this.halfExtents,i)}},{key:"translateAndRotate",value:function(e,t,n){s.transformMat4(n.center,this.center,e),h.fromQuat(n.orientation,t)}},{key:"setScale",value:function(e,t){s.multiply(t.halfExtents,this.halfExtents,e)}}]),e}()),new Array(8));Hr[0]=new s(1,1,1),Hr[1]=new s(-1,1,1),Hr[2]=new s(-1,-1,1),Hr[3]=new s(1,-1,1),Hr[4]=new s(1,1,-1),Hr[5]=new s(-1,1,-1),Hr[6]=new s(-1,-1,-1),Hr[7]=new s(1,-1,-1);var qr,Wr,Xr,Yr=e("dD",function(){function e(){o(this,e),this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=Pt.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=Dr.create(0,0,0,0);this.vertices=new Array(8);for(var n=0;n<8;++n)this.vertices[n]=new s}return r(e,[{key:"accurate",set:function(e){this._type=e?Pt.SHAPE_FRUSTUM_ACCURATE:Pt.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){return new e}},{key:"clone",value:function(t){return e.copy(new e,t)}},{key:"copy",value:function(e,t){e._type=t._type;for(var n=0;n<6;++n)Dr.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)s.copy(e.vertices[i],t.vertices[i]);return e}}]),r(e,[{key:"update",value:function(e,t){if(s.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),s.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),s.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),s.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),s.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),s.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===Pt.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();s.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)s.transformMat4(this.vertices[o],Hr[o],t)}}},{key:"transform",value:function(e){if(this._type===Pt.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)s.transformMat4(this.vertices[t],this.vertices[t],e);Dr.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),Dr.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),Dr.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),Dr.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),Dr.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),Dr.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),e}());Yr.createOrtho=(qr=new s,function(e,t,n,i,r,o){var a=t/2,c=n/2;s.set(qr,a,c,i),s.transformMat4(e.vertices[0],qr,o),s.set(qr,-a,c,i),s.transformMat4(e.vertices[1],qr,o),s.set(qr,-a,-c,i),s.transformMat4(e.vertices[2],qr,o),s.set(qr,a,-c,i),s.transformMat4(e.vertices[3],qr,o),s.set(qr,a,c,r),s.transformMat4(e.vertices[4],qr,o),s.set(qr,-a,c,r),s.transformMat4(e.vertices[5],qr,o),s.set(qr,-a,-c,r),s.transformMat4(e.vertices[6],qr,o),s.set(qr,a,-c,r),s.transformMat4(e.vertices[7],qr,o),Dr.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Dr.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Dr.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Dr.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Dr.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Dr.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])}),function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(Wr||(Wr=e("dW",{}))),function(e){e[e.Default=Wr.Default]="Default",e[e.Normal=Wr.Normal]="Normal",e[e.Reverse=Wr.Reverse]="Reverse",e[e.Loop=Wr.Loop]="Loop",e[e.LoopReverse=Wr.Loop|Wr.Reverse]="LoopReverse",e[e.PingPong=Wr.PingPong]="PingPong",e[e.PingPongReverse=Wr.PingPong|Wr.Reverse]="PingPongReverse"}(Xr||(Xr=e("dU",{}))),_(Xr);e("dV",function(){function e(t){o(this,e),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return r(e,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),e}());var Kr=m({Default:Wr.Default,Normal:Wr.Normal,Clamp:Wr.Clamp,Loop:Wr.Loop,PingPong:Wr.PingPong}),Qr=e("dE",(function e(){o(this,e),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}));p.fastDefine("cc.Keyframe",Qr,{time:0,value:0,inTangent:0,outTangent:0});var Jr=function(){function e(){o(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return r(e,[{key:"evaluate",value:function(e){return function(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}(e-this.time,this.coefficient)}}]),e}();var Zr=e("dF",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;o(this,e),this.keyFrames=void 0,this.preWrapMode=Kr.Loop,this.postWrapMode=Kr.Clamp,this.cachedKey=void 0,this.keyFrames=t||[].concat(e.defaultKF),this.cachedKey=new Jr}return r(e,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,n=e<0?this.preWrapMode:this.postWrapMode,i=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(n){case Kr.Loop:t=x(e-i,r-i)+i;break;case Kr.PingPong:t=y(e-i,r-i)+i;break;case Kr.Clamp:t=g(e,i,r)}var o=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)o=this.keyFrames.length-2;else for(var a=0;a<this.keyFrames.length-1;a++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[a+1].time){o=a;break}var s=this.keyFrames[o],c=this.keyFrames[o+1],l=S(s.time,c.time,t),u=c.time-s.time,_=s.outTangent*u,f=c.inTangent*u,h=l*l,d=h*l,v=d-2*h+l,m=d-h,p=-2*d+3*h;return(2*d-3*h+1)*s.value+v*_+m*f+p*c.value}},{key:"evaluate",value:function(e){var t=e,n=e<0?this.preWrapMode:this.postWrapMode,i=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(n){case Kr.Loop:t=x(e-i,r-i)+i;break;case Kr.PingPong:t=y(e-i,r-i)+i;break;case Kr.Clamp:t=g(e,i,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var o=this.findIndex(this.cachedKey,t),a=o+1;return a===this.keyFrames.length&&(a-=1),this.calcOptimizedKey(this.cachedKey,o,a),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,n){var i=this.keyFrames[t],r=this.keyFrames[n];e.index=t,e.time=i.time,e.endTime=r.time;var o=r.time-i.time,a=r.value-i.value,s=1/(o*o),c=i.outTangent*o,l=r.inTangent*o;e.coefficient[0]=(c+l-a-a)*s/o,e.coefficient[1]=(a+a+a-c-c-l)*s,e.coefficient[2]=i.outTangent,e.coefficient[3]=i.value}},{key:"findIndex",value:function(e,t){var n=e.index;if(-1!==n)if(t>this.keyFrames[n].time)for(var i=0;i<3;i++){var r=n+i;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var o=0;o<3;o++){var a=n-o;if(a>=0&&this.keyFrames[a-1].time<=t)return a-1}for(var s=0,c=this.keyFrames.length,l=Math.floor((s+c)/2);c-s>1;)this.keyFrames[l].time>=t?c=l:s=l+1,l=Math.floor((s+c)/2);return s}}]),e}());Zr.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],p.fastDefine("cc.AnimationCurve",Zr,{preWrapMode:Kr.Default,postWrapMode:Kr.Default,keyFrames:[]}),C(Ir.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),T(wr,"intersect",[{name:"line_quad"}]);e("aC",.26);var $r,eo,to,no,io,ro,oo,ao=/([a-zA-Z0-9--]+|\S)/,so=/^[!,.:;'}\]%\?>]/,co=/([a-zA-Z0-9--]+|\S)$/,lo=/[a-zA-Z0-9--]+$/,uo=/^[a-zA-Z0-9--]/;function _o(e,t){var n=e.measureText(t);return n&&n.width||0}function fo(e,t,n){var i=t,r=n,o=e[t];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==t){var a=e[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return e.substring(i,r)}var ho,vo=e("aH",E("cc.PrefabInfo")((to=A((eo=function e(){o(this,e),I(this,"root",to,this),I(this,"asset",no,this),I(this,"fileId",io,this),I(this,"sync",ro,this),I(this,"_synced",oo,this)}).prototype,"root",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),no=A(eo.prototype,"asset",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),io=A(eo.prototype,"fileId",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ro=A(eo.prototype,"sync",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oo=A(eo.prototype,"_synced",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),$r=eo))||$r);a._PrefabInfo=vo;var mo=(R(ho={},Bn.UNORM,"Uint"),R(ho,Bn.SNORM,"Int"),R(ho,Bn.UINT,"Uint"),R(ho,Bn.INT,"Int"),R(ho,Bn.UFLOAT,"Float"),R(ho,Bn.FLOAT,"Float"),R(ho,"default","Uint"),ho);function po(e){return(mo[e.type]||mo.default)+e.size/e.count*8}function go(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:on.R32F,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=Yn[n];r||(r=o.size);for(var a="set"+po(o),s=o.size/o.count,c=Math.floor(t.length/o.count),l=O.isLittleEndian,u=0;u<c;++u)for(var _=i+r*u,f=0;f<o.count;++f){var h=_+s*f;e[a](h,t[o.count*u+f],l)}}function yo(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:on.R32F,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.byteLength-n,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],a=Yn[t];r||(r=a.size);for(var s="get"+po(a),c=a.size/a.count,l=Math.floor(i/r),u=O.isLittleEndian,_=0;_<l;++_)for(var f=n+r*_,h=0;h<a.count;++h){var d=f+c*h;o[a.count*_+h]=e[s](d,u)}return o}function xo(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:on.R32F,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.byteLength-i,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6?arguments[6]:void 0;a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=Yn[n];o||(o=s.size);for(var c="set"+po(s),l="get"+po(s),u=s.size/s.count,_=Math.floor(r/o),f=O.isLittleEndian,h=0;h<_;++h)for(var d=i+o*h,v=0;v<s.count;++v){var m=d+u*v,p=e[l](m,f);a[c](m,t(p,v,e),f)}return a}var So=function(){function e(){o(this,e),this._arrayBufferOrPaddings=[],this._length=0}return r(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer}}]),e}();var Co,To,Eo,Ao,bo,wo,Io,Ro=1024;!function(e){e[e.RGB565=on.R5G6B5]="RGB565",e[e.RGB5A1=on.RGB5A1]="RGB5A1",e[e.RGBA4444=on.RGBA4]="RGBA4444",e[e.RGB888=on.RGB8]="RGB888",e[e.RGB32F=on.RGB32F]="RGB32F",e[e.RGBA8888=on.RGBA8]="RGBA8888",e[e.RGBA32F=on.RGBA32F]="RGBA32F",e[e.A8=on.A8]="A8",e[e.I8=on.L8]="I8",e[e.AI8=on.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=on.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=on.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=Ro++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=on.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=on.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=Ro++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=on.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=Ro++]="RGBA_ETC1",e[e.RGB_ETC2=on.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=on.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=on.ASTC_RGBA_4x4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=on.ASTC_RGBA_5x4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=on.ASTC_RGBA_5x5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=on.ASTC_RGBA_6x5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=on.ASTC_RGBA_6x6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=on.ASTC_RGBA_8x5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=on.ASTC_RGBA_8x6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=on.ASTC_RGBA_8x8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=on.ASTC_RGBA_10x5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=on.ASTC_RGBA_10x6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=on.ASTC_RGBA_10x8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=on.ASTC_RGBA_10x10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=on.ASTC_RGBA_12x10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=on.ASTC_RGBA_12x12]="RGBA_ASTC_12x12"}(Co||(Co=e("df",{}))),function(e){e[e.REPEAT=xn.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=xn.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=xn.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=xn.BORDER]="CLAMP_TO_BORDER"}(To||(To=e("dZ",{}))),function(e){e[e.NONE=yn.NONE]="NONE",e[e.LINEAR=yn.LINEAR]="LINEAR",e[e.NEAREST=yn.POINT]="NEAREST"}(Eo||(Eo=e("dQ",{})));var Oo,Po=e("aX",E("cc.ImageAsset")((Io=wo=function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this)))._nativeData=void 0,n._tex=void 0,n._url=void 0,n._exportedExts=void 0,n._format=Co.RGBA8888,n._width=0,n._height=0,n._url="",n.loaded=!1,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&n.reset(e),n}return c(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return(e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement?this._nativeData:this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Co.RGB_ETC1&&this._format<=Co.RGBA_ASTC_12x12||this._format>=Co.RGB_A_PVRTC_2BPPV1&&this._format<=Co.RGBA_ETC1}},{key:"url",get:function(){return this._url}},{key:"_texture",set:function(e){this._tex=e},get:function(){if(!this._tex){var e=new a.Texture2D;e.name=this._url,e.image=this,this._tex=e}return this._tex}}]),r(t,[{key:"reset",value:function(e){e instanceof HTMLElement?(this._nativeData=e,this._onDataComplete()):(this._nativeData=e,this._format=e.format,this._onDataComplete())}},{key:"destroy",value:function(){return this.data&&this.data instanceof HTMLImageElement&&(this.data.src="",this._setRawAsset(""),a.loader.removeItem(this.data.id)),P(u(t.prototype),"destroy",this).call(this)}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";for(var n,i=[],r=N(e);!(n=r()).done;){var o=n.value,a=o.split("@"),s=t.extnames.indexOf(a[0]),c=s<0?o:"".concat(s);a[1]&&(c+="@"+a[1]),i.push(c)}return{fmt:i.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,n){var i="";"string"==typeof e?i=e:(this._width=e.w,this._height=e.h,i=e.fmt);for(var r,o=a.director.root?a.director.root.device:null,s=i.split("_"),c=Number.MAX_VALUE,l=this._format,u="",_=a.macro.SUPPORT_TEXTURE_FORMATS,f=N(s);!(r=f()).done;){var h=r.value.split("@"),d=parseInt(h[0],void 0),v=t.extnames[d]||h.join(),m=_.indexOf(v);if(-1!==m&&m<c){var p=h[1]?parseInt(h[1]):this._format;if(!(".astc"!==v||o&&o.hasFeature(ti.FORMAT_ASTC)))continue;if(!(".pvr"!==v||o&&o.hasFeature(ti.FORMAT_PVRTC)))continue;if(!(p!==Co.RGB_ETC1&&p!==Co.RGBA_ETC1||o&&o.hasFeature(ti.FORMAT_ETC1)))continue;if(!(p!==Co.RGB_ETC2&&p!==Co.RGBA_ETC2||o&&o.hasFeature(ti.FORMAT_ETC2)))continue;if(".webp"===v&&!a.sys.capabilities.webp)continue;c=m,u=v,l=p}}u&&(this._setRawAsset(u),this._format=l);var g=n.customEnv,y=g&&g.uuid;y&&(this._uuid=y,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),t}(D),wo.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],A((bo=Io).prototype,"_nativeAsset",[vt],Object.getOwnPropertyDescriptor(bo.prototype,"_nativeAsset"),bo.prototype),Ao=bo))||Ao);a.ImageAsset=Po,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.minLOD=8]="minLOD",e[e.maxLOD=9]="maxLOD",e[e.mipLODBias=10]="mipLODBias",e[e.total=11]="total"}(Oo||(Oo=e("ak",{})));var No=[yn.LINEAR,yn.LINEAR,yn.NONE,xn.WRAP,xn.WRAP,xn.WRAP,8,dn.NEVER,0,0,0],Do=e("al",Lo(No)),zo={r:0,g:0,b:0,a:0},Mo={};function Lo(e){for(var t=0,n=0,i=0;i<No.length;i++)switch(t=e[i]||No[i],i){case Oo.minFilter:n|=t;break;case Oo.magFilter:n|=t<<2;break;case Oo.mipFilter:n|=t<<4;break;case Oo.addressU:n|=t<<6;break;case Oo.addressV:n|=t<<8;break;case Oo.addressW:n|=t<<10;break;case Oo.maxAnisotropy:n|=t<<12;break;case Oo.cmpFunc:n|=t<<16;break;case Oo.minLOD:n|=t<<20;break;case Oo.maxLOD:n|=t<<24;break;case Oo.mipLODBias:n|=t<<28}return n}var Fo,ko,Uo,Bo,Go,jo,Vo,Ho,qo,Wo,Xo,Yo,Ko=e("an",new(function(){function e(){o(this,e),this._cache={}}return r(e,[{key:"getSampler",value:function(e,t){t||(t=Do);var n=this._cache[t];return n||(Mo.minFilter=3&t,Mo.magFilter=t>>2&3,Mo.mipFilter=t>>4&3,Mo.addressU=t>>6&3,Mo.addressV=t>>8&3,Mo.addressW=t>>10&3,Mo.maxAnisotropy=t>>12&15,Mo.cmpFunc=t>>16&15,Mo.minLOD=t>>20&15,Mo.maxLOD=t>>24&15,Mo.mipLODBias=t>>28&15,Mo.borderColor=zo,this._cache[t]=e.createSampler(Mo))}}]),e}()));a.samplerLib=Ko;var Qo=new z("Tex"),Jo=e("de",E("cc.TextureBase")((Yo=Xo=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),I(e,"_format",Uo,M(e)),I(e,"_minFilter",Bo,M(e)),I(e,"_magFilter",Go,M(e)),I(e,"_mipFilter",jo,M(e)),I(e,"_wrapS",Vo,M(e)),I(e,"_wrapT",Ho,M(e)),I(e,"_wrapR",qo,M(e)),I(e,"_anisotropy",Wo,M(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=[],e._samplerHash=0,e._gfxSampler=null,e._gfxDevice=null,e._id=Qo.getNewId(),e.loaded=!1,e._gfxDevice=e._getGFXDevice(),e}return c(t,e),r(t,[{key:"isCompressed",get:function(){return this._format>=Co.RGB_ETC1&&this._format<=Co.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),r(t,[{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,n){this._wrapS=e,this._samplerInfo[Oo.addressU]=e,this._wrapT=t,this._samplerInfo[Oo.addressV]=t,void 0!==n&&(this._wrapR=n,this._samplerInfo[Oo.addressW]=n),this._samplerHash=Lo(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Ko.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[Oo.minFilter]=e,this._magFilter=t,this._samplerInfo[Oo.magFilter]=t,this._samplerHash=Lo(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Ko.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[Oo.mipFilter]=e,this._samplerInfo[Oo.maxLOD]=e===Eo.NONE?0:15,this._samplerHash=Lo(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Ko.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[Oo.maxAnisotropy]=e,this._samplerHash=Lo(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Ko.getSampler(this._gfxDevice,this._samplerHash))}},{key:"destroy",value:function(){return P(u(t.prototype),"destroy",this).call(this)}},{key:"getGFXTexture",value:function(){return null}},{key:"getSamplerHash",value:function(){return this._samplerHash}},{key:"getGFXSampler",value:function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=Ko.getSampler(this._gfxDevice,this._samplerHash):L(9302)),this._gfxSampler}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+this._mipFilter+","+this._anisotropy}},{key:"_deserialize",value:function(e,t){var n=e.split(",");n.unshift(""),n.length>=5&&(this.setFilters(parseInt(n[1]),parseInt(n[2])),this.setWrapMode(parseInt(n[3]),parseInt(n[4]))),n.length>=7&&(this.setMipFilter(parseInt(n[5])),this.setAnisotropy(parseInt(n[6])))}},{key:"_getGFXDevice",value:function(){return a.director.root&&a.director.root.device}},{key:"_getGFXFormat",value:function(){return this._getGFXPixelFormat(this._format)}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?Co.RGBA8888:e}},{key:"_getGFXPixelFormat",value:function(e){return e===Co.RGBA_ETC1?e=Co.RGB_ETC1:e===Co.RGB_A_PVRTC_4BPPV1?e=Co.RGB_PVRTC_4BPPV1:e===Co.RGB_A_PVRTC_2BPPV1&&(e=Co.RGB_PVRTC_2BPPV1),e}}]),t}(D),Xo.PixelFormat=Co,Xo.WrapMode=To,Xo.Filter=Eo,Uo=A((ko=Yo).prototype,"_format",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Co.RGBA8888}}),Bo=A(ko.prototype,"_minFilter",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Eo.LINEAR}}),Go=A(ko.prototype,"_magFilter",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Eo.LINEAR}}),jo=A(ko.prototype,"_mipFilter",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Eo.NONE}}),Vo=A(ko.prototype,"_wrapS",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return To.REPEAT}}),Ho=A(ko.prototype,"_wrapT",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return To.REPEAT}}),qo=A(ko.prototype,"_wrapR",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return To.REPEAT}}),Wo=A(ko.prototype,"_anisotropy",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),Fo=ko))||Fo);a.TextureBase=Jo;var Zo,$o=e("b8",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0});a.macro=$o;var ea=[{buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{mipLevel:0,baseArrayLayer:0,layerCount:1}}];function ta(e){return e&&0==(e&e-1)}var na,ia,ra,oa,aa,sa=E("cc.SimpleTexture")(Zo=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r))))._gfxTexture=null,n._mipmapLevel=1,n}return c(t,e),r(t,[{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"destroy",value:function(){return this._tryDestroyTexture(),P(u(t.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this._gfxTexture&&!(this._gfxTexture.levelCount<=t)){var i=this._getGFXDevice();if(i){var r=ea[0];r.texExtent.width=this._gfxTexture.width>>t,r.texExtent.height=this._gfxTexture.height>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,ea):i.copyTexImagesToTexture([e],this._gfxTexture,ea)}}}},{key:"_assignImage",value:function(e,t,n){var i=this,r=function(){var r=e.data;r&&(i.uploadData(r,t,n),i._checkTextureLoaded(),$o.CLEANUP_IMAGE_CACHE&&a.loader.release(e))};if(e.loaded)r();else{if(e.once("load",(function(){r()})),!this.isCompressed){var o=a.builtinResMgr.get("black-texture").image;this.uploadData(o.data,t,n)}a.textureUtil.postLoadImage(e)}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(e){return null}},{key:"_tryReset",value:function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}}},{key:"_createTexture",value:function(e){var t=En.NONE;this._mipFilter!==Eo.NONE&&function(e,t,n){return!(e.gfxAPI===ei.WEBGL)||ta(t)&&ta(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=En.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Cn.SAMPLED|Cn.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._gfxTexture=i}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}},{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(Jo))||Zo;a.SimpleTexture=sa;var ca=e("aY",(na=E("cc.Texture2D"),ia=F([Po]),na((aa=A((oa=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"_mipmaps",aa,M(n)),n}return c(t,e),r(t,[{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Co.RGBA8888,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.reset({width:e,height:t,format:n,mipmapLevel:i})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;if(!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],P(u(t.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(e){return{base:P(u(t.prototype),"_serialize",this).call(this,e),mipmaps:this._mipmaps.map((function(t){return t&&t._uuid?e?EditorExtends.UuidUtils.compressUuid(t._uuid,!0):t._uuid:null}))}}},{key:"_deserialize",value:function(e,n){var i=e;P(u(t.prototype),"_deserialize",this).call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new Po,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,"".concat(r),o),this._mipmaps[r]._texture=this}}},{key:"_getGfxTextureCreateInfo",value:function(e){return Object.assign({type:Sn.TEX2D,width:this._width,height:this._height},e)}},{key:"_checkTextureLoaded",value:function(){for(var e=!0,n=0;n<this._mipmaps.length;++n){if(!this._mipmaps[n].loaded){e=!1;break}}e&&P(u(t.prototype),"_textureReady",this).call(this)}},{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(sa)).prototype,"_mipmaps",[ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ra=oa))||ra));a.Texture2D=ca;var la={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},ua=e("cY",function(){function e(){o(this,e)}return r(e,null,[{key:"makeMaskInclude",value:function(e){for(var t,n=0,i=N(e);!(t=i()).done;){n|=t.value}return n}},{key:"makeMaskExclude",value:function(t){return~e.makeMaskInclude(t)}},{key:"addLayer",value:function(t,n){void 0!==n?n>19||n<0?console.warn("maximum layers reached."):(e.Enum[t]=1<<n,e.Enum[n]=t,e.BitMask[t]=1<<n,e.BitMask[n]=t):console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(t){t>19||t<0?console.warn("do not change buildin layers."):(delete e.Enum[e.Enum[t]],delete e.Enum[t],delete e.BitMask[e.BitMask[t]],delete e.BitMask[t])}}]),e}());ua.Enum=m(la),ua.BitMask=k(Object.assign({},la)),a.Layers=ua;var _a,fa;!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(_a||(_a={})),a.RenderPassStage=_a,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(fa||(fa=e("dk",{})));var ha,da={bindings:[],record:{}},va={bindings:[],record:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_SHADOW=1]="UBO_SHADOW",e[e.SAMPLER_ENVIRONMENT=2]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.COUNT=4]="COUNT"}(ha||(ha={}));var ma,pa=ha.SAMPLER_ENVIRONMENT,ga=ha.COUNT-pa;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTING_MAP=9]="SAMPLER_LIGHTING_MAP",e[e.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",e[e.COUNT=11]="COUNT"}(ma||(ma=e("dq",{})));var ya,xa=ma.SAMPLER_JOINTS,Sa=ma.COUNT-xa,Ca=function(e){return e!==ya.MATERIAL};!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(ya||(ya=e("dm",{})));var Ta=new oi;Ta.bufferOffsets=[0,pa+xa,pa],Ta.samplerOffsets=[0,ga+Sa,ga];var Ea=function e(){o(this,e)};Ea.SIZE=4*(Ea.COUNT=(Ea.GLOBAL_FOG_ADD_OFFSET=(Ea.GLOBAL_FOG_BASE_OFFSET=(Ea.GLOBAL_FOG_COLOR_OFFSET=(Ea.AMBIENT_GROUND_OFFSET=(Ea.AMBIENT_SKY_OFFSET=(Ea.MAIN_LIT_COLOR_OFFSET=(Ea.MAIN_LIT_DIR_OFFSET=(Ea.EXPOSURE_OFFSET=(Ea.CAMERA_POS_OFFSET=(Ea.MAT_VIEW_PROJ_INV_OFFSET=(Ea.MAT_VIEW_PROJ_OFFSET=(Ea.MAT_PROJ_INV_OFFSET=(Ea.MAT_PROJ_OFFSET=(Ea.MAT_VIEW_INV_OFFSET=(Ea.MAT_VIEW_OFFSET=(Ea.NATIVE_SIZE_OFFSET=(Ea.SCREEN_SCALE_OFFSET=(Ea.SCREEN_SIZE_OFFSET=(Ea.TIME_OFFSET=0)+4)+4)+4)+4)+16)+16)+16)+16)+16)+16)+4)+4)+4)+4)+4)+4)+4)+4)+4),Ea.BLOCK={stageFlags:An.ALL,descriptorType:bn.UNIFORM_BUFFER,count:1,set:ya.GLOBAL,binding:ha.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:rn.FLOAT4,count:1},{name:"cc_screenSize",type:rn.FLOAT4,count:1},{name:"cc_screenScale",type:rn.FLOAT4,count:1},{name:"cc_nativeSize",type:rn.FLOAT4,count:1},{name:"cc_matView",type:rn.MAT4,count:1},{name:"cc_matViewInv",type:rn.MAT4,count:1},{name:"cc_matProj",type:rn.MAT4,count:1},{name:"cc_matProjInv",type:rn.MAT4,count:1},{name:"cc_matViewProj",type:rn.MAT4,count:1},{name:"cc_matViewProjInv",type:rn.MAT4,count:1},{name:"cc_cameraPos",type:rn.FLOAT4,count:1},{name:"cc_exposure",type:rn.FLOAT4,count:1},{name:"cc_mainLitDir",type:rn.FLOAT4,count:1},{name:"cc_mainLitColor",type:rn.FLOAT4,count:1},{name:"cc_ambientSky",type:rn.FLOAT4,count:1},{name:"cc_ambientGround",type:rn.FLOAT4,count:1},{name:"cc_fogColor",type:rn.FLOAT4,count:1},{name:"cc_fogBase",type:rn.FLOAT4,count:1},{name:"cc_fogAdd",type:rn.FLOAT4,count:1}]},da.record[Ea.BLOCK.name]=Ea.BLOCK,da.bindings[Ea.BLOCK.binding]=Ea.BLOCK;var Aa=function e(){o(this,e)};Aa.SIZE=4*(Aa.COUNT=(Aa.SHADOW_SIZE_OFFSET=(Aa.SHADOW_PCF_OFFSET=(Aa.SHADOW_COLOR_OFFSET=(Aa.MAT_LIGHT_VIEW_PROJ_OFFSET=(Aa.MAT_LIGHT_PLANE_PROJ_OFFSET=0)+16)+16)+4)+4)+4),Aa.BLOCK={stageFlags:An.ALL,descriptorType:bn.UNIFORM_BUFFER,count:1,set:ya.GLOBAL,binding:ha.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:rn.MAT4,count:1},{name:"cc_matLightViewProj",type:rn.MAT4,count:1},{name:"cc_shadowColor",type:rn.FLOAT4,count:1},{name:"cc_shadowPCF",type:rn.FLOAT4,count:1},{name:"cc_shadowSize",type:rn.FLOAT4,count:1}]},da.record[Aa.BLOCK.name]=Aa.BLOCK,da.bindings[Aa.BLOCK.binding]=Aa.BLOCK;var ba={stageFlags:An.FRAGMENT,descriptorType:bn.SAMPLER,count:1,set:ya.GLOBAL,binding:ha.SAMPLER_SHADOWMAP,name:"cc_shadowMap",type:rn.SAMPLER2D};da.record[ba.name]=ba,da.bindings[ba.binding]=ba;var wa={stageFlags:An.FRAGMENT,descriptorType:bn.SAMPLER,count:1,set:ya.GLOBAL,binding:ha.SAMPLER_ENVIRONMENT,name:"cc_environment",type:rn.SAMPLER_CUBE};da.record[wa.name]=wa,da.bindings[wa.binding]=wa;var Ia=function e(){o(this,e)};Ia.SIZE=4*(Ia.COUNT=(Ia.LIGHTINGMAP_UVPARAM=(Ia.MAT_WORLD_IT_OFFSET=(Ia.MAT_WORLD_OFFSET=0)+16)+16)+4),Ia.BLOCK={stageFlags:An.VERTEX,descriptorType:bn.UNIFORM_BUFFER,count:1,set:ya.LOCAL,binding:ma.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:rn.MAT4,count:1},{name:"cc_matWorldIT",type:rn.MAT4,count:1},{name:"cc_lightingMapUVParam",type:rn.FLOAT4,count:1}]},va.record[Ia.BLOCK.name]=Ia.BLOCK,va.bindings[Ia.BLOCK.binding]=Ia.BLOCK;var Ra=function e(){o(this,e)};Ra.BATCHING_COUNT=10,Ra.MAT_WORLDS_OFFSET=0,Ra.SIZE=4*(Ra.COUNT=16*Ra.BATCHING_COUNT),Ra.BLOCK={stageFlags:An.VERTEX,descriptorType:bn.UNIFORM_BUFFER,count:1,set:ya.LOCAL,binding:ma.UBO_LOCAL,name:"CCLocalBatched",members:[{name:"cc_matWorlds",type:rn.MAT4,count:Ra.BATCHING_COUNT}]},va.record[Ra.BLOCK.name]=Ra.BLOCK,va.bindings[Ra.BLOCK.binding]=Ra.BLOCK;var Oa=function e(){o(this,e)};Oa.LIGHTS_PER_PASS=1,Oa.SIZE=4*(Oa.COUNT=(Oa.LIGHT_DIR_OFFSET=(Oa.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Oa.LIGHT_COLOR_OFFSET=(Oa.LIGHT_POS_OFFSET=0)+4*Oa.LIGHTS_PER_PASS)+4*Oa.LIGHTS_PER_PASS)+4*Oa.LIGHTS_PER_PASS)+4*Oa.LIGHTS_PER_PASS),Oa.BLOCK={stageFlags:An.FRAGMENT,descriptorType:bn.DYNAMIC_UNIFORM_BUFFER,count:1,set:ya.LOCAL,binding:ma.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_lightPos",type:rn.FLOAT4,count:Oa.LIGHTS_PER_PASS},{name:"cc_lightColor",type:rn.FLOAT4,count:Oa.LIGHTS_PER_PASS},{name:"cc_lightSizeRangeAngle",type:rn.FLOAT4,count:Oa.LIGHTS_PER_PASS},{name:"cc_lightDir",type:rn.FLOAT4,count:Oa.LIGHTS_PER_PASS}]},va.record[Oa.BLOCK.name]=Oa.BLOCK,va.bindings[Oa.BLOCK.binding]=Oa.BLOCK;var Pa=e("dH",(function e(){o(this,e)}));Pa.JOINTS_TEXTURE_INFO_OFFSET=0,Pa.COUNT=Pa.JOINTS_TEXTURE_INFO_OFFSET+4,Pa.SIZE=4*Pa.COUNT,Pa.BLOCK={stageFlags:An.VERTEX,descriptorType:bn.UNIFORM_BUFFER,count:1,set:ya.LOCAL,binding:ma.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointTextureInfo",type:rn.FLOAT4,count:1}]},va.record[Pa.BLOCK.name]=Pa.BLOCK,va.bindings[Pa.BLOCK.binding]=Pa.BLOCK;var Na=e("dJ",(function e(){o(this,e)}));Na.JOINTS_ANIM_INFO_OFFSET=0,Na.COUNT=Na.JOINTS_ANIM_INFO_OFFSET+4,Na.SIZE=4*Na.COUNT,Na.BLOCK={stageFlags:An.VERTEX,descriptorType:bn.UNIFORM_BUFFER,count:1,set:ya.LOCAL,binding:ma.UBO_SKINNING_ANIMATION,name:"CCSkinningAnimation",members:[{name:"cc_jointAnimInfo",type:rn.FLOAT4,count:1}]},va.record[Na.BLOCK.name]=Na.BLOCK,va.bindings[Na.BLOCK.binding]=Na.BLOCK;var Da=e("dK","a_jointAnimInfo"),za=function e(){o(this,e)};za.SIZE=4*(za.COUNT=(za.JOINTS_OFFSET=0)+360),za.BLOCK={stageFlags:An.VERTEX,descriptorType:bn.UNIFORM_BUFFER,count:1,set:ya.LOCAL,binding:ma.UBO_SKINNING_TEXTURE,name:"CCSkinning",members:[{name:"cc_joints",type:rn.FLOAT4,count:90}]},va.record[za.BLOCK.name]=za.BLOCK,va.bindings[za.BLOCK.binding]=za.BLOCK;var Ma=function e(){o(this,e)};Ma.MAX_MORPH_TARGET_COUNT=60,Ma.OFFSET_OF_WEIGHTS=0,Ma.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=(Ma.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Ma.MAX_MORPH_TARGET_COUNT)+4,Ma.COUNT_BASE_4_BYTES=4*Math.ceil(Ma.MAX_MORPH_TARGET_COUNT/4)+4,Ma.SIZE=4*Ma.COUNT_BASE_4_BYTES,Ma.BLOCK={stageFlags:An.VERTEX,descriptorType:bn.UNIFORM_BUFFER,count:1,set:ya.LOCAL,binding:ma.UBO_MORPH,name:"CCMorph",members:[{name:"cc_displacementWeights",type:rn.FLOAT4,count:Ma.MAX_MORPH_TARGET_COUNT/4},{name:"cc_displacementTextureInfo",type:rn.FLOAT4,count:1}]},va.record[Ma.BLOCK.name]=Ma.BLOCK,va.bindings[Ma.BLOCK.binding]=Ma.BLOCK;var La=e("dI",{stageFlags:An.VERTEX,descriptorType:bn.SAMPLER,count:1,set:ya.LOCAL,binding:ma.SAMPLER_JOINTS,name:"cc_jointTexture",type:rn.SAMPLER2D});va.record[La.name]=La,va.bindings[La.binding]=La;var Fa={stageFlags:An.VERTEX,descriptorType:bn.SAMPLER,count:1,set:ya.LOCAL,binding:ma.SAMPLER_MORPH_POSITION,name:"cc_PositionDisplacements",type:rn.SAMPLER2D};va.record[Fa.name]=Fa,va.bindings[Fa.binding]=Fa;var ka={stageFlags:An.VERTEX,descriptorType:bn.SAMPLER,count:1,set:ya.LOCAL,binding:ma.SAMPLER_MORPH_NORMAL,name:"cc_NormalDisplacements",type:rn.SAMPLER2D};va.record[ka.name]=ka,va.bindings[ka.binding]=ka;var Ua={stageFlags:An.VERTEX,descriptorType:bn.SAMPLER,count:1,set:ya.LOCAL,binding:ma.SAMPLER_MORPH_TANGENT,name:"cc_TangentDisplacements",type:rn.SAMPLER2D};va.record[Ua.name]=Ua,va.bindings[Ua.binding]=Ua;var Ba={stageFlags:An.FRAGMENT,descriptorType:bn.SAMPLER,count:1,set:ya.LOCAL,binding:ma.SAMPLER_LIGHTING_MAP,name:"cc_lightingMap",type:rn.SAMPLER2D};va.record[Ba.name]=Ba,va.bindings[Ba.binding]=Ba;var Ga={stageFlags:An.FRAGMENT,descriptorType:bn.SAMPLER,count:1,set:ya.LOCAL,binding:ma.SAMPLER_SPRITE,name:"cc_spriteTexture",type:rn.SAMPLER2D};va.record[Ga.name]=Ga,va.bindings[Ga.binding]=Ga;var ja=e("dS",ua.makeMaskExclude([ua.BitMask.UI_2D,ua.BitMask.GIZMOS,ua.BitMask.EDITOR,ua.BitMask.SCENE_GIZMO,ua.BitMask.PROFILER])),Va=ua.makeMaskExclude([ua.BitMask.UI_2D,ua.BitMask.PROFILER]),Ha=ua.Enum.ALL;e("au",Object.freeze({__proto__:null,PIPELINE_FLOW_FORWARD:"ForwardFlow",PIPELINE_FLOW_SHADOW:"ShadowFlow",PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return _a},get RenderPriority(){return fa},globalDescriptorSetLayout:da,localDescriptorSetLayout:va,get PipelineGlobalBindings(){return ha},get ModelLocalBindings(){return ma},isBuiltinBinding:Ca,get SetIndex(){return ya},bindingMappingInfo:Ta,UBOGlobal:Ea,UBOShadow:Aa,UNIFORM_SHADOWMAP:ba,UNIFORM_ENVIRONMENT:wa,UBOLocal:Ia,INST_MAT_WORLD:"a_matWorld0",UBOLocalBatched:Ra,UBOForwardLight:Oa,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:Pa,UBOSkinningAnimation:Na,INST_JOINT_ANIM_INFO:Da,UBOSkinning:za,UBOMorph:Ma,UniformJointTexture:La,UniformPositionMorphTexture:Fa,UniformNormalMorphTexture:ka,UniformTangentMorphTexture:Ua,UniformLightingMapSampler:Ba,UniformSpriteSampler:Ga,CAMERA_DEFAULT_MASK:ja,CAMERA_EDITOR_MASK:Va,MODEL_ALWAYS_MASK:Ha}));var qa,Wa,Xa,Ya,Ka,Qa=function(){function e(t,n){if(o(this,e),this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(var r=0;r<i;++r){var a=this._mesh.struct.morph.subMeshMorphs[r];a&&(a.targets.length>Ma.MAX_MORPH_TARGET_COUNT?G(10002,Ma.MAX_MORPH_TARGET_COUNT,a.targets.length):this._subMeshRenderings[r]=new Ja(this._mesh,r,this._mesh.struct.morph,n))}}}return r(e,[{key:"createInstance",value:function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){U(e._mesh.struct.morph);var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null!==r){var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(nn.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(nn.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(nn.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,B(r.requiredPatches())),o}},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=N(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}}}]),e}(),Ja=function(){function e(t,n,i,r){o(this,e),this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._gfxDevice=r;var a=i.subMeshMorphs[n];this._subMeshMorph=a,function(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}(t,n,r);var s=t.struct.vertexBundles[t.struct.primitives[n].vertexBundelIndices[0]].view.count,c=a.targets.length,l=function(e,t){var n,i,r,o;e.hasFeature(ti.TEXTURE_FLOAT)?(n=t,r=16,i=ca.PixelFormat.RGBA32F,o=Float32Array):(n=4*t,r=4,i=ca.PixelFormat.RGBA8888,o=Uint8Array);var a=function(e){e<5&&(e=5);var t=H(e),n=q(t),i=n>>1;return{width:1<<(1&n?i+1:i),height:1<<i}}(n),s=a.width,c=a.height;return{width:s,height:c,create:function(){var t=new ArrayBuffer(s*c*r),n=new Float32Array(t),a=o===Float32Array?n:new o(t),l=new Po({width:s,height:c,_data:a,_compressed:!1,format:i}),u=new ca;u.setFilters(ca.Filter.NEAREST,ca.Filter.NEAREST),u.setMipFilter(ca.Filter.NONE),u.setWrapMode(ca.WrapMode.CLAMP_TO_EDGE,ca.WrapMode.CLAMP_TO_EDGE,ca.WrapMode.CLAMP_TO_EDGE),u.image=l,u.getGFXTexture()||j("Unexpected: failed to create morph texture?");var _=Ko.getSampler(e,u.getSamplerHash());return{get texture(){return u.getGFXTexture()},get sampler(){return _},get valueView(){return n},destroy:function(){u.destroy()},updatePixels:function(){u.uploadData(a)}}}}}(r,c+s*c);this._textureInfo={width:l.width,height:l.height},this._attributes=a.attributes.map((function(e,n){var i=l.create(),r=i.valueView,o=0,s=a.targets.length;return a.targets.forEach((function(e){var i=e.displacements[n],a=new Float32Array(t.data.buffer,t.data.byteOffset+i.offset,i.count),c=a.length/3;r[o]=s+.5;for(var l=4*s,u=0;u<c;++u)r[l+4*u+0]=a[3*u+0],r[l+4*u+1]=a[3*u+1],r[l+4*u+2]=a[3*u+2];o+=4,s+=c})),i.updatePixels(),{name:e,morphTexture:i}}))}return r(e,[{key:"destroy",value:function(){for(var e,t=N(this._attributes);!(e=t()).done;){e.value.morphTexture.destroy()}}},{key:"createInstance",value:function(){var e=this,t=new Za(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=N(e._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case nn.ATTR_POSITION:a=Fa.binding;break;case nn.ATTR_NORMAL:a=ka.binding;break;case nn.ATTR_TANGENT:a=Ua.binding;break;default:j("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(Ma.BLOCK.binding,t.buffer),n.update()},destroy:function(){}}}}]),e}(),Za=function(){function e(t,n){o(this,e),this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=n,this._localBuffer=new DataView(new ArrayBuffer(Ma.SIZE)),this._remoteBuffer=t.createBuffer({usage:an.UNIFORM|an.TRANSFER_DST,memUsage:sn.HOST|sn.DEVICE,size:Ma.SIZE,stride:Ma.SIZE})}return r(e,[{key:"destroy",value:function(){this._remoteBuffer.destroy()}},{key:"setWeights",value:function(e){V(e.length===this._targetCount);for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(Ma.OFFSET_OF_WEIGHTS+4*t,e[t],a.sys.isLittleEndian)}},{key:"setMorphTextureInfo",value:function(e,t){this._localBuffer.setFloat32(Ma.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,a.sys.isLittleEndian),this._localBuffer.setFloat32(Ma.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,a.sys.isLittleEndian)}},{key:"commit",value:function(){this._remoteBuffer.update(this._localBuffer.buffer,this._localBuffer.byteOffset,this._localBuffer.byteLength)}},{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function $a(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}var es=e("b4",function(){function e(t,n,i){o(this,e),this.vertexBuffers=void 0,this.attributes=void 0,this.primitiveMode=void 0,this.indexBuffer=void 0,this.indirectBuffer=void 0,this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=void 0,this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this.vertexBuffers=t,this.attributes=n,this.primitiveMode=i}return r(e,[{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:s.ZERO,max:s.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:s.ZERO,max:s.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,nn.ATTR_POSITION),i=e.readIndices(t),r=new s,o=new s,c=this.attributes.find((function(e){return e.name===a.GFXAttributeName.ATTR_POSITION}));if(c){var l=Yn[c.format].count;2===l?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var u=0;u<n.length;u+=l)2===l?(r.x=n[u]>r.x?n[u]:r.x,r.y=n[u+1]>r.y?n[u+1]:r.y,o.x=n[u]<o.x?n[u]:o.x,o.y=n[u+1]<o.y?n[u+1]:o.y):(r.x=n[u]>r.x?n[u]:r.x,r.y=n[u+1]>r.y?n[u+1]:r.y,r.z=n[u+2]>r.z?n[u+2]:r.z,o.x=n[u]<o.x?n[u]:o.x,o.y=n[u+1]<o.y?n[u+1]:o.y,o.z=n[u+2]<o.z?n[u+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){if(this._flatBuffers)return this._flatBuffers;var e=this._flatBuffers=[];if(!this.mesh||void 0===this.subMeshIdx)return e;var t=this.mesh,n=0,i=t.struct.primitives[this.subMeshIdx];i.indexView&&(n=i.indexView.count);for(var r,o=N(i.vertexBundelIndices);!(r=o()).done;){var a=r.value,s=t.struct.vertexBundles[a],c=i.indexView?i.indexView.count:s.view.count,l=s.view.stride,u=l*c,_=new Uint8Array(t.data.buffer,s.view.offset,s.view.length);if(i.indexView){for(var f=new Uint8Array(u),h=t.readIndices(this.subMeshIdx),d=0;d<n;++d)for(var v=d*l,m=h[d]*l,p=0;p<l;++p)f[v+p]=_[m+p];this._flatBuffers.push({stride:l,count:c,buffer:f})}else this._flatBuffers.push({stride:l,count:c,buffer:_})}return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,o=this.mesh.struct,s=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===s.jointMapIndex||!o.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var c=a.director.root.device,l=0;l<s.vertexBundelIndices.length;l++){var u=o.vertexBundles[s.vertexBundelIndices[l]];r=0,i=on.UNKNOWN;for(var _=0;_<u.attributes.length;_++){var f=u.attributes[_];if(f.name===nn.ATTR_JOINTS){i=f.format;break}r+=Yn[f.format].size}i?function(){var a=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),_=new DataView(a.slice().buffer),f=o.jointMaps[s.jointMapIndex];xo(_,(function(e){return f.indexOf(e)}),i,r,u.view.length,u.view.stride,_);var h=c.createBuffer({usage:an.VERTEX|an.TRANSFER_DST,memUsage:sn.DEVICE,size:u.view.length,stride:u.view.stride});h.update(_.buffer),t.push(h),n.push(l)}():t.push(this.vertexBuffers[s.vertexBundelIndices[l]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(c)),t}}]),r(e,[{key:"destroy",value:function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this.indirectBuffer&&(this.indirectBuffer.destroy(),this.indirectBuffer=void 0)}},{key:"enableVertexIdChannel",value:function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this.vertexBuffers.push(i),this.attributes.push({name:"a_vertexId",format:on.R32F,stream:t,isNormalized:!1}),this._vertexIdChannel={stream:t,index:n}}}},{key:"_allocVertexIdBuffer",value:function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer({usage:an.VERTEX|an.TRANSFER_DST,memUsage:sn.DEVICE,size:n.byteLength,stride:n.BYTES_PER_ELEMENT});return r.update(n),r}}]),e}()),ts=new s,ns=new s,is=new Uint8Array,rs=e("at",E("cc.Mesh")((Xa=A((Wa=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),I(e,"_struct",Xa,M(e)),I(e,"_dataLength",Ya,M(e)),I(e,"_hash",Ka,M(e)),e._data=is,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e.morphRendering=null,e.loaded=!1,e}return c(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),a.loader._cache[this.nativeUrl]&&(a.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=ui(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),r(t,[{key:"initialize",value:function(){var e=this;if(!this._initialized){var t,n;this._initialized=!0,this._data.byteLength!==this._dataLength&&(this._data=new Uint8Array(this._dataLength),(t=this).loaded?n&&n():t.nativeUrl?a.loader.load({url:t.nativeUrl},(function(e,i){i&&(t.loaded||(t._nativeAsset=i)),n&&n(e)})):n&&n());for(var i=this._data.buffer,r=a.director.root.device,o=this._createVertexBuffers(r,i),s=[],c=function(t){var n=e._struct.primitives[t];if(0===n.vertexBundelIndices.length)return"continue";var a=void 0,c=null;if(n.indexView){var l=n.indexView,u=l.stride,_=l.length;if(4===u&&!r.hasFeature(ti.ELEMENT_INDEX_UINT)){var f=e._struct.vertexBundles[n.vertexBundelIndices[0]].view.count;if(f>=65536)return G(10001,f,65536),"continue";u>>=1,_>>=1}a=r.createBuffer({usage:an.INDEX|an.TRANSFER_DST,memUsage:sn.DEVICE,size:_,stride:u}),c=new($a(l.stride))(i,l.offset,l.count),l.stride!==u&&(c=$a(u).from(c)),e.loaded?a.update(c):e.once("load",(function(){a.update(c)}))}var h=n.vertexBundelIndices.map((function(e){return o[e]})),d=[];if(n.vertexBundelIndices.length>0){var v=n.vertexBundelIndices[0];d=e._struct.vertexBundles[v].attributes}var m=new es(h,d,n.primitiveMode);m.mesh=e,m.subMeshIdx=t,m.indexBuffer=a,s.push(m)},l=0;l<this._struct.primitives.length;l++)c(l);this._renderingSubMeshes=s,this._struct.morph&&(this.morphRendering=function(e,t){return new Qa(e,t)}(this,r))}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),P(u(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._dataLength=this.data.byteLength,this._hash=0,this.loaded=!0,this.emit("load")}},{key:"getBoneSpaceBounds",value:function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new Br(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var c=this.readAttribute(a,nn.ATTR_JOINTS),l=this.readAttribute(a,nn.ATTR_WEIGHTS),u=this.readAttribute(a,nn.ATTR_POSITION);if(c&&l&&u)for(var _=Math.min(c.length/4,l.length/4,u.length/3),f=0;f<_;f++){s.set(ts,u[3*f+0],u[3*f+1],u[3*f+2]);for(var h=0;h<4;++h){var d=4*f+h,v=c[d];if(!(0===l[d]||v>=i.length)){s.transformMat4(ns,ts,i[v]),n[v]=!0;var m=t[v];s.min(m.center,m.center,ns),s.max(m.halfExtents,m.halfExtents,ns)}}}}for(var p=0;p<i.length;p++){var g=t[p];n[p]?Br.fromPoints(g,g.center,g.halfExtents):t[p]=null}return t}},{key:"merge",value:function(e,t,n){if(n&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;var i=new s,r=t&&new W,o=t&&new Br;if(r&&t.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(e._struct)),c=e._data.slice();if(t){a.maxPosition&&a.minPosition&&(s.add(o.center,a.maxPosition,a.minPosition),s.multiplyScalar(o.center,o.center,.5),s.subtract(o.halfExtents,a.maxPosition,a.minPosition),s.multiplyScalar(o.halfExtents,o.halfExtents,.5),Br.transform(o,o,t),s.add(a.maxPosition,o.center,o.halfExtents),s.subtract(a.minPosition,o.center,o.halfExtents));for(var l=0;l<a.vertexBundles.length;l++)for(var u=a.vertexBundles[l],_=0;_<u.attributes.length;_++)if(u.attributes[_].name===nn.ATTR_POSITION||u.attributes[_].name===nn.ATTR_NORMAL){var f=u.attributes[_].format,h=new DataView(c.buffer,u.view.offset+os(u.attributes,_)),d=fs(h,f),v=hs(h,f);if(!d||!v)continue;for(var m=u.view.count,p=u.view.stride,g=_s(f),y=0;y<m;y++){var x=y*p,S=x+g,C=S+g;switch(i.set(d(x),d(S),d(C)),u.attributes[_].name){case nn.ATTR_POSITION:i.transformMat4(t);break;case nn.ATTR_NORMAL:s.transformQuat(i,i,r)}v(x,i.x),v(S,i.y),v(C,i.z)}}}return this.reset({struct:a,data:c}),this.initialize(),!0}for(var T,E,A,b,w,I=new So,R=0,O=0,P=0,D=0,z=0,M=0,L=0,F=0,k=!1,U=new Array(this._struct.vertexBundles.length),B=0;B<this._struct.vertexBundles.length;++B){var G=this._struct.vertexBundles[B],j=e._struct.vertexBundles[B];P=G.view.offset,D=j.view.offset,O=G.view.stride,R=G.view.count+j.view.count,T=new ArrayBuffer(R*O),E=new Uint8Array(T),P+=(A=this._data.subarray(P,P+G.view.length)).length,D+=(b=e._data.subarray(D,D+j.view.length)).length,E.set(A),z=0;for(var V,H=N(G.attributes);!(V=H()).done;){var q=V.value;L=0,k=!1;for(var X,Y=N(j.attributes);!(X=Y()).done;){var K=X.value;if(q.name===K.name&&q.format===K.format){k=!0;break}L+=Yn[K.format].size}if(k){F=Yn[q.format].size,M=G.view.length+z;for(var Q=0;Q<j.view.count;++Q){if(w=b.subarray(L,L+F),E.set(w,M),(q.name===nn.ATTR_POSITION||q.name===nn.ATTR_NORMAL)&&t){var J=new Float32Array(E.buffer,M,3);switch(i.set(J[0],J[1],J[2]),q.name){case nn.ATTR_POSITION:i.transformMat4(t);break;case nn.ATTR_NORMAL:s.transformQuat(i,i,r)}J[0]=i.x,J[1]=i.y,J[2]=i.z}M+=G.view.stride,L+=j.view.stride}}z+=Yn[q.format].size}U[B]={attributes:G.attributes,view:{offset:I.getLength(),length:T.byteLength,count:R,stride:O}},I.addBuffer(T)}for(var Z,$,ee,te=0,ne=2,ie=0,re=new Array(this._struct.primitives.length),oe=0;oe<this._struct.primitives.length;++oe){var ae=this._struct.primitives[oe],se=e._struct.primitives[oe];re[oe]={primitiveMode:ae.primitiveMode,vertexBundelIndices:ae.vertexBundelIndices};for(var ce,le=N(ae.vertexBundelIndices);!(ce=le()).done;){var ue=ce.value;ie=Math.max(ie,this._struct.vertexBundles[ue].view.count)}if(ae.indexView&&se.indexView){te=ae.indexView.count,te+=se.indexView.count,P=ae.indexView.offset,D=se.indexView.offset,ne=te<256?1:te<65536?2:4;var _e=new ArrayBuffer(te*ne);if(Z=2===ne?new Uint16Array(_e):1===ne?new Uint8Array(_e):new Uint32Array(_e),$=2===ae.indexView.stride?new Uint16Array(this._data.buffer,P,ae.indexView.count):1===ae.indexView.stride?new Uint8Array(this._data.buffer,P,ae.indexView.count):new Uint32Array(this._data.buffer,P,ae.indexView.count),ne===ae.indexView.stride)Z.set($);else for(var fe=0;fe<ae.indexView.count;++fe)Z[fe]=$[fe];P+=ae.indexView.length,ee=2===se.indexView.stride?new Uint16Array(e._data.buffer,D,se.indexView.count):1===se.indexView.stride?new Uint8Array(e._data.buffer,D,se.indexView.count):new Uint32Array(e._data.buffer,D,se.indexView.count);for(var he=0;he<se.indexView.count;++he)Z[ae.indexView.count+he]=ie+ee[he];D+=se.indexView.length,re[oe].indexView={offset:I.getLength(),length:_e.byteLength,count:te,stride:ne},I.setNextAlignment(ne),I.addBuffer(_e)}}var de={vertexBundles:U,primitives:re,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return de.minPosition&&e._struct.minPosition&&de.maxPosition&&e._struct.maxPosition&&(t?(s.add(o.center,e._struct.maxPosition,e._struct.minPosition),s.multiplyScalar(o.center,o.center,.5),s.subtract(o.halfExtents,e._struct.maxPosition,e._struct.minPosition),s.multiplyScalar(o.halfExtents,o.halfExtents,.5),Br.transform(o,o,t),s.add(i,o.center,o.halfExtents),s.max(de.maxPosition,de.maxPosition,i),s.subtract(i,o.center,o.halfExtents),s.min(de.minPosition,de.minPosition,i)):(s.min(de.minPosition,de.minPosition,e._struct.minPosition),s.max(de.maxPosition,de.maxPosition,e._struct.maxPosition))),this.reset({struct:de,data:new Uint8Array(I.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=e._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,o=e.attributes[t].format,a=$n(Yn[o]);if(0===r)return new a;var s=new DataView(n._data.buffer,e.view.offset+os(e.attributes,t)),c=Yn[o],l=fs(s,o);if(a&&l){for(var u=c.count,_=new a(r*u),f=e.view.stride,h=0;h<r;++h)for(var d=0;d<u;++d)_[u*h+d]=l(f*h+_.BYTES_PER_ELEMENT*d);i=_}})),i}},{key:"copyAttribute",value:function(e,t,n,i,r){var o=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(o._data.buffer,e.view.offset+os(e.attributes,t)),u=new DataView(n,r),_=Yn[c],f=fs(l,c),h=hs(u,c);if(f&&h){for(var d=_.count,v=e.view.stride,m=_s(c),p=i,g=m,y=0;y<s;++y)for(var x=0;x<d;++x){h(p*y+g*x,f(v*y+m*x))}a=!0}}else a=!0})),a}},{key:"readIndices",value:function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)}},{key:"copyIndices",value:function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?on.R8UI:2===n.indexView.stride?on.R16UI:on.R32UI,o=fs(new DataView(this._data.buffer),r),a=0;a<i;++a)t[a]=o(n.indexView.offset+Yn[r].size*a);return!0}},{key:"_accessAttribute",value:function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=this._struct.primitives[e],o=N(r.vertexBundelIndices);!(i=o()).done;){var a=i.value,s=this._struct.vertexBundles[a],c=s.attributes.findIndex((function(e){return e.name===t}));if(!(c<0)){n(s,c);break}}}},{key:"_createVertexBuffers",value:function(e,t){var n=this;return this._struct.vertexBundles.map((function(i){var r=e.createBuffer({usage:an.VERTEX|an.TRANSFER_DST,memUsage:sn.DEVICE,size:i.view.length,stride:i.view.stride}),o=new Uint8Array(t,i.view.offset,i.view.length);return n.loaded?r.update(o):n.once("load",(function(){r.update(o)})),r}))}}]),t}(D)).prototype,"_struct",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),Ya=A(Wa.prototype,"_dataLength",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ka=A(Wa.prototype,"_hash",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qa=Wa))||qa);function os(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=Yn[r.format].size}return n}a.Mesh=rs;var as,ss,cs,ls,us=O.isLittleEndian;function _s(e){var t=Yn[e];return t.size/t.count}function fs(e,t){var n=Yn[t],i=n.size/n.count;switch(n.type){case Bn.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,us)};case 4:return function(t){return e.getUint32(t,us)}}break;case Bn.SNORM:case Bn.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,us)};case 4:return function(t){return e.getInt32(t,us)}}break;case Bn.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,us)};case 4:return function(t){return e.getUint32(t,us)}}break;case Bn.FLOAT:return function(t){return e.getFloat32(t,us)}}return null}function hs(e,t){var n=Yn[t],i=n.size/n.count;switch(n.type){case Bn.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,us)};case 4:return function(t,n){return e.setUint32(t,n,us)}}break;case Bn.SNORM:case Bn.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,us)};case 4:return function(t,n){return e.setInt32(t,n,us)}}break;case Bn.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,us)};case 4:return function(t,n){return e.setUint32(t,n,us)}}break;case Bn.FLOAT:return function(t,n){return e.setFloat32(t,n,us)}}return null}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(as||(as=e("a3",{}))),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(ss||(ss=e("a4",{})));var ds;!function(e){e[e.UBO=0]="UBO",e[e.SAMPLER=1]="SAMPLER"}(ds||(ds=e("a5",{})));var vs,ms=e("a6",(function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return e<<28&4026531840|i<<22&264241152|t<<20&3145728|n<<14&1032192|16383&r})),ps=e("a7",(function(e){return(4026531840&e)>>>28})),gs=e("a8",(function(e){return(264241152&e)>>>22})),ys=(e("a9",(function(e){return(3145728&e)>>>20})),e("aa",(function(e){return(1032192&e)>>>14}))),xs=e("ab",(function(e){return 16383&e})),Ss=e("ac",(function(e,t){return-264241153&e|t<<22&264241152})),Cs=e("ad",(R(cs={},rn.UNKNOWN,(function(e,t){return console.warn("illegal uniform handle")})),R(cs,rn.INT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]})),R(cs,rn.INT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return X.fromArray(t,e,n)})),R(cs,rn.INT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return s.fromArray(t,e,n)})),R(cs,rn.INT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return v.fromArray(t,e,n)})),R(cs,rn.FLOAT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]})),R(cs,rn.FLOAT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return X.fromArray(t,e,n)})),R(cs,rn.FLOAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return s.fromArray(t,e,n)})),R(cs,rn.FLOAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return v.fromArray(t,e,n)})),R(cs,rn.MAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return h.fromArray(t,e,n)})),R(cs,rn.MAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return f.fromArray(t,e,n)})),cs)),Ts=e("ae",(R(ls={},rn.UNKNOWN,(function(e,t){return console.warn("illegal uniform handle")})),R(ls,rn.INT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]=t})),R(ls,rn.INT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return X.toArray(e,t,n)})),R(ls,rn.INT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return s.toArray(e,t,n)})),R(ls,rn.INT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return v.toArray(e,t,n)})),R(ls,rn.FLOAT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]=t})),R(ls,rn.FLOAT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return X.toArray(e,t,n)})),R(ls,rn.FLOAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return s.toArray(e,t,n)})),R(ls,rn.FLOAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return v.toArray(e,t,n)})),R(ls,rn.MAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return h.toArray(e,t,n)})),R(ls,rn.MAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return f.toArray(e,t,n)})),ls)),Es=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function As(e){switch(e){case rn.BOOL:case rn.INT:case rn.UINT:case rn.FLOAT:return Es[0];case rn.BOOL2:case rn.INT2:case rn.UINT2:case rn.FLOAT2:return Es[1];case rn.BOOL4:case rn.INT4:case rn.UINT4:case rn.FLOAT4:return Es[2];case rn.MAT4:return Es[3];case rn.SAMPLER2D:return"default-texture";case rn.SAMPLER_CUBE:return"default-cube-texture"}return Es[0]}function bs(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var ws,Is,Rs,Os,Ps,Ns,Ds=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],zs=e("b7",E("cc.SpriteFrame")(vs=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this))).vertices=null,e.uv=[],e.uvHash=0,e.uvSliced=[],e._rect=new Y,e._offset=new X,e._originalSize=new K,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._flipUv=!1,e}return c(t,e),r(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){e&&(this._refreshTexture(e),this._calculateUV())}}],[{key:"createWithImage",value:function(e){var n=e instanceof Po?e:new Po(e),i=new ca;i.image=n;var r=new t;return r.texture=i,r}}]),r(t,[{key:"textureLoaded",value:function(){return this.texture&&this.texture.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this.rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this.rect=e}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this.originalSize=e}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this.offset=e}},{key:"getGFXTexture",value:function(){return this._texture.getGFXTexture()}},{key:"getGFXSampler",value:function(){return this._texture.getGFXSampler()}},{key:"reset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this.loaded=!1,this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._flipUv=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(L(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height)||(L(3301,this.name+"/"+e.name,i,e.height),!1)}},{key:"onLoaded",value:function(){this.loaded=!0,this.emit("load")}},{key:"destroy",value:function(){return P(u(t.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,n=t.width,i=t.height,r=this._capInsets[0],o=this._capInsets[2],a=e.width-r-o,s=this._capInsets[1],c=this._capInsets[3],l=e.height-s-c,u=this.uvSliced;if(u.length=0,this._rotated){Ds[0].u=(e.x+.5)/n,Ds[1].u=(e.x+c)/n,Ds[2].u=(e.x+c+l)/n,Ds[3].u=(e.x+e.height-.5)/n,Ds[3].v=(e.y+.5)/i,Ds[2].v=(e.y+r)/i,Ds[1].v=(e.y+r+a)/i,Ds[0].v=(e.y+e.width-.5)/i;for(var _=0;_<4;++_)for(var f=Ds[_],h=0;h<4;++h){var d=Ds[3-h];u.push({u:f.u,v:d.v})}}else{Ds[0].u=(e.x+.5)/n,Ds[1].u=(e.x+r)/n,Ds[2].u=(e.x+r+a)/n,Ds[3].u=(e.x+e.width-.5)/n,Ds[3].v=(e.y+.5)/i,Ds[2].v=(e.y+s)/i,Ds[1].v=(e.y+s+l)/i,Ds[0].v=(e.y+e.height-.5)/i;for(var v=0;v<4;++v)for(var m=Ds[v],p=0;p<4;++p){var g=Ds[p];u.push({u:g.u,v:m.v})}}}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,n=this.texture,i=n.width,r=n.height;if(this._rotated){var o=0===i?0:(e.x+.5)/i,a=0===i?0:(e.x+e.height-.5)/i,s=0===r?0:(e.y+.5)/r,c=0===r?0:(e.y+e.width-.5)/r;this._flipUv,t[0]=o,t[1]=s,t[2]=o,t[3]=c,t[4]=a,t[5]=s,t[6]=a,t[7]=c}else{var l=0===i?0:(e.x+.5)/i,u=0===i?0:(e.x+e.width-.5)/i,_=0===r?0:(e.y+e.height-.5)/r,f=0===r?0:(e.y+.5)/r;this._flipUv?(t[0]=l,t[1]=f,t[2]=u,t[3]=f,t[4]=l,t[5]=_,t[6]=u,t[7]=_):(t[0]=l,t[1]=_,t[2]=u,t[3]=_,t[4]=l,t[5]=f,t[6]=u,t[7]=f)}for(var h="",d=0;d<t.length;d++)h+=t[d];this.uvHash=ui(h,666);var v=this.vertices;if(v){v.nu.length=0,v.nv.length=0;for(var m=0;m<v.u.length;m++)v.nu[m]=v.u[m]/i,v.nv[m]=v.v[m]/r}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,n,i=this._rect,r=this._offset,o=this._originalSize,a=this._uuid;return this._texture&&(t=this._texture._uuid),a&&e&&(a=EditorExtends.UuidUtils.compressUuid(a,!0)),t&&e&&(t=EditorExtends.UuidUtils.compressUuid(t,!0)),this.vertices&&(n={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{name:this._name,atlas:e?void 0:this._atlasUuid,rect:i,offset:r,originalSize:o,rotated:this._rotated,capInsets:this._capInsets,vertices:n,texture:t}}},{key:"_deserialize",value:function(e,t){var n=e,i=n.rect;i&&(this._rect=new Y(i.x,i.y,i.width,i.height));var r=n.offset;n.offset&&(this._offset=new X(r.x,r.y));var o=n.originalSize;n.originalSize&&(this._originalSize=new K(o.width,o.height)),this._rotated=!!n.rotated,this._name=n.name;var a=n.capInsets;a&&(this._capInsets[0]=a[0],this._capInsets[1]=a[1],this._capInsets[2]=a[2],this._capInsets[3]=a[3]),n.texture&&t.result.push(this,"_textureSource",n.texture),this.vertices=n.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"_textureLoaded",value:function(){var e=this._texture,t={},n=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new Y(0,0,e.width,e.height),n=!0),(0===this._originalSize.width||0===this._originalSize.height||n)&&(t.originalSize=new K(e.width,e.height),n=!0),n&&(this.reset(t),this.onLoaded())}},{key:"_refreshTexture",value:function(e){this._texture=e,e.loaded?this._textureLoaded():e.once("load",this._textureLoaded,this)}}]),t}(D))||vs);a.SpriteFrame=zs,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(Ns||(Ns={}));var Ms=e("aZ",E("cc.TextureCube")((Ps=Os=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"_mipmaps",Rs,M(n)),n}return c(t,e),r(t,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1?arguments[1]:void 0;if(!(t>=this._mipmaps.length))for(var i=Math.min(void 0===n?this._mipmaps.length:n,this._mipmaps.length-t),r=function(n){var i=t+n;Ls(e._mipmaps[i],(function(t,n){e._assignImage(t,i,n)}))},o=0;o<i;++o)r(o)}},{key:"destroy",value:function(){return this._mipmaps=[],P(u(t.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(e){return{base:P(u(t.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map((function(t){return e?{front:EditorExtends.UuidUtils.compressUuid(t.front._uuid,!0),back:EditorExtends.UuidUtils.compressUuid(t.back._uuid,!0),left:EditorExtends.UuidUtils.compressUuid(t.left._uuid,!0),right:EditorExtends.UuidUtils.compressUuid(t.right._uuid,!0),top:EditorExtends.UuidUtils.compressUuid(t.top._uuid,!0),bottom:EditorExtends.UuidUtils.compressUuid(t.bottom._uuid,!0)}:{front:t.front._uuid,back:t.back._uuid,left:t.left._uuid,right:t.right._uuid,top:t.top._uuid,bottom:t.bottom._uuid}}))}}},{key:"_deserialize",value:function(e,n){var i=e;P(u(t.prototype),"_deserialize",this).call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new Po,back:new Po,left:new Po,right:new Po,top:new Po,bottom:new Po};var o=i.mipmaps[r];n.result.push(this._mipmaps[r],"front",o.front),n.result.push(this._mipmaps[r],"back",o.back),n.result.push(this._mipmaps[r],"left",o.left),n.result.push(this._mipmaps[r],"right",o.right),n.result.push(this._mipmaps[r],"top",o.top),n.result.push(this._mipmaps[r],"bottom",o.bottom)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=Object.assign({type:Sn.CUBE,width:this._width,height:this._height,layerCount:6},e);return t.flags=(t.flags||0)|En.CUBEMAP,t}},{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){Ls(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,n){for(var i=[],r=e.length/6,o=0;o<r;o++){var a=6*o;i.push({front:e[a+Ns.front].image,back:e[a+Ns.back].image,left:e[a+Ns.left].image,right:e[a+Ns.right].image,top:e[a+Ns.top].image,bottom:e[a+Ns.bottom].image})}return(n=n||new t).mipmaps=i,n}}]),t}(sa),Os.FaceIndex=Ns,Rs=A((Is=Ps).prototype,"_mipmaps",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ws=Is))||ws);function Ls(e,t){t(e.front,Ns.front),t(e.back,Ns.back),t(e.left,Ns.left),t(e.right,Ns.right),t(e.top,Ns.top),t(e.bottom,Ns.bottom)}a.TextureCube=Ms;var Fs,ks,Us,Bs=e("d1",[{name:"builtin-billboard",_uuid:"711ebe11-f673-4cd9-9a83-63c60ba54c5b",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:2143664850,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(set = 1, binding = 1) uniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 3) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 2) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"builtin-graphics",_uuid:"1c02ae6f-4492-4915-b8f8-7492a3b1e4cd",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-graphics|vs:vert|fs:frag"}]}],shaders:[{name:"builtin-graphics|vs:vert|fs:frag",hash:3946667351,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    float aa = fwidth(v_dist);\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    #ifdef GL_OES_standard_derivatives\n      float aa = fwidth(v_dist);\n    #else\n      float aa = 0.05;\n    #endif\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 2) in float a_dist;\nlayout(location = 1) out float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    float aa = fwidth(v_dist);\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"builtin-particle-gpu",_uuid:"971bdb23-3ff6-43eb-b422-1c30165a3663",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:3696836305,glsl3:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord;\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  layout(std140) uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  layout(std140) uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  layout(std140) uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  layout(std140) uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  layout(std140) uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  layout(std140) uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord;\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  uniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  uniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  uniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  uniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  uniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  uniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture2D(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(set = 1, binding = 1) uniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nlayout(set = 1, binding = 2) uniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nlayout(location = 0) in vec4 a_position_starttime;\nlayout(location = 1) in vec4 a_size_uv;\nlayout(location = 2) in vec4 a_rotation_uv;\nlayout(location = 3) in vec4 a_color;\nlayout(location = 4) in vec4 a_dir_life;\nlayout(location = 5) in float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  layout(location = 6) in vec3 a_texCoord;\n  layout(location = 7) in vec3 a_texCoord3;\n  layout(location = 8) in vec3 a_normal;\n  layout(location = 9) in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 10) uniform sampler2D color_over_time_tex0;\n  layout(set = 1, binding = 3) uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 11) uniform sampler2D rotation_over_time_tex0;\n  layout(set = 1, binding = 4) uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 12) uniform sampler2D size_over_time_tex0;\n  layout(set = 1, binding = 5) uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 13) uniform sampler2D force_over_time_tex0;\n  layout(set = 1, binding = 6) uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 14) uniform sampler2D velocity_over_time_tex0;\n  layout(set = 1, binding = 7) uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  layout(set = 1, binding = 15) uniform sampler2D texture_animation_tex0;\n  layout(set = 1, binding = 8) uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 16) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 9) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"builtin-particle-trail",_uuid:"17debcc3-0a6b-4b8a-b00b-dc58b885581e",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:4115155772,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  layout(std140) uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  layout(location = 2) out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  layout(location = 0) in vec2 uv;\n  layout(location = 1) in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    layout(location = 2) in vec3 vBarycentric;\n  #endif\n  layout(set = 1, binding = 2) uniform sampler2D mainTexture;\n  layout(set = 1, binding = 1) uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"builtin-particle",_uuid:"d1346436-ac96-4271-b863-1f4fdead95b0",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:66662317,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\n  in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\n  attribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_RENDER_MODE == 1\n  layout(location = 5) in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  layout(location = 6) in vec3 a_texCoord3;\n  layout(location = 7) in vec3 a_normal;\n  layout(location = 5) in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:5},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"builtin-sprite",_uuid:"60f7195c-ec2a-45eb-ba94-8955f60e81d0",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:2679078392,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture(tex, uv);\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture2D(tex, uv);\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 color;\nlayout(location = 1) out vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture(tex, uv);\n#endif\n}\nlayout(location = 0) in vec4 color;\n#if USE_TEXTURE\n  layout(location = 1) in vec2 uv0;\n  layout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"builtin-standard",_uuid:"1baf0fc9-befa-459c-8bdd-af1a450a0319",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"builtin-standard|standard-vs:vert|standard-fs:frag",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"builtin-standard|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:3803722737,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nout vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if USE_VERTEX_COLOR\n  in vec3 a_color;\n  out vec3 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\nout float v_fog_factor;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  out vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  in vec2 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(std140) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nin vec4 v_shadowPos;\nuniform sampler2D cc_shadowMap;\nfloat CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float closestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  float shadow = step(closestDepth, clipPos.z - 0.001);\n  return shadow;\n}\nfloat CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  float closestDepth = 0.0;\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  return shadow /= 5.0;\n}\nfloat CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 9.0;\n}\nfloat CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 25.0;\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      float pcf = cc_shadowPCF.x + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) {shadowAttenuation = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadowAttenuation = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadowAttenuation = CCGetShadowFactorX5();}\n      else {shadowAttenuation = CCGetShadowFactorX1();}\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor * (1.0 - cc_shadowColor.a);\n      finalColor = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\nin float v_fog_factor;\n#if USE_VERTEX_COLOR\n  in vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nvarying vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if USE_VERTEX_COLOR\n  attribute vec3 a_color;\n  varying vec3 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying float v_fog_factor;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  attribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  varying vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform lowp vec4 cc_shadowColor;\nuniform lowp vec4 cc_shadowPCF;\nuniform lowp vec4 cc_shadowSize;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return texture2DLodEXT(tex, coord, lod);\n    #else\n      return texture2D(tex, coord, lod);\n    #endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return textureCubeLodEXT(tex, coord, lod);\n    #else\n      return textureCube(tex, coord, lod);\n    #endif\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  varying vec2 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nuniform highp vec4 cc_lightPos[1];\nuniform vec4 cc_lightColor[1];\nuniform vec4 cc_lightSizeRangeAngle[1];\nuniform vec4 cc_lightDir[1];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nvarying vec4 v_shadowPos;\nuniform sampler2D cc_shadowMap;\nfloat CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  float shadow = step(closestDepth, clipPos.z - 0.001);\n  return shadow;\n}\nfloat CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  float closestDepth = 0.0;\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  return shadow /= 5.0;\n}\nfloat CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 9.0;\n}\nfloat CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 25.0;\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture2D(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      float pcf = cc_shadowPCF.x + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) {shadowAttenuation = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadowAttenuation = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadowAttenuation = CCGetShadowFactorX5();}\n      else {shadowAttenuation = CCGetShadowFactorX1();}\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor * (1.0 - cc_shadowColor.a);\n      finalColor = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\n  varying vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture2D(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture2D(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nlayout(location = 0) out vec4 v_shadowPos;\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if USE_VERTEX_COLOR\n  layout(location = 13) in vec3 a_color;\n  layout(location = 1) out vec3 v_color;\n#endif\nlayout(location = 2) out vec3 v_position;\nlayout(location = 3) out vec3 v_normal;\nlayout(location = 4) out vec2 v_uv;\nlayout(location = 5) out vec2 v_uv1;\nlayout(location = 6) out float v_fog_factor;\n#if USE_NORMAL_MAP\n  layout(location = 7) out vec3 v_tangent;\n  layout(location = 8) out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  layout(location = 14) in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  layout(location = 9) out vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if CC_USE_IBL\nlayout(set = 0, binding = 3) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  layout(location = 9) in vec2 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(set = 2, binding = 1) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nlayout(location = 0) in vec4 v_shadowPos;\nlayout(set = 0, binding = 4) uniform sampler2D cc_shadowMap;\nfloat CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float closestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  float shadow = step(closestDepth, clipPos.z - 0.001);\n  return shadow;\n}\nfloat CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  float closestDepth = 0.0;\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  return shadow /= 5.0;\n}\nfloat CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 9.0;\n}\nfloat CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 25.0;\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      float pcf = cc_shadowPCF.x + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) {shadowAttenuation = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadowAttenuation = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadowAttenuation = CCGetShadowFactorX5();}\n      else {shadowAttenuation = CCGetShadowFactorX1();}\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor * (1.0 - cc_shadowColor.a);\n      finalColor = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(location = 2) in vec3 v_position;\nlayout(location = 4) in vec2 v_uv;\nlayout(location = 5) in vec2 v_uv1;\nlayout(location = 3) in vec3 v_normal;\nlayout(location = 6) in float v_fog_factor;\n#if USE_VERTEX_COLOR\n  layout(location = 1) in vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  layout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  layout(location = 7) in vec3 v_tangent;\n  layout(location = 8) in vec3 v_bitangent;\n  layout(set = 1, binding = 2) uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  layout(set = 1, binding = 3) uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  layout(set = 1, binding = 4) uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  layout(set = 1, binding = 5) uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  layout(set = 1, binding = 6) uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_shadowMap",defines:["!CC_FORWARD_ADD","CC_RECEIVE_SHADOW"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:15,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:32,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"builtin-standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:868488122,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  in vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  attribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture2D(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  layout(location = 13) in vec2 a_texCoord1;\n#endif\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out vec2 v_uv1;\nlayout(location = 2) out vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in vec2 v_uv1;\nlayout(location = 2) in vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  layout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"builtin-terrain",_uuid:"1d08ef62-a503-4ce2-8b9a-46c90873f7d3",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},lightMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:298856331,glsl3:{vert:"\n  precision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  in vec3 a_position;\n  in vec3 a_normal;\n  in vec2 a_texCoord;\n  out vec2 uvw;\n  out vec2 uv0;\n  out vec2 uv1;\n  out vec2 uv2;\n  out vec2 uv3;\n  out vec2 luv;\n  out vec3 diffuse;\n  out float factor_fog;\n  layout(std140) uniform TexCoords {\n    vec4 UVScale;\n    vec4 lightMapUVParam;\n  };\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  in vec2 luv;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\n  uniform sampler2D lightMap;\n  in float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\n  precision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  attribute vec3 a_position;\n  attribute vec3 a_normal;\n  attribute vec2 a_texCoord;\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec2 luv;\n  varying vec3 diffuse;\n  varying float factor_fog;\n  uniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  varying vec2 luv;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\n  uniform sampler2D lightMap;\n  varying float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture2D(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n  precision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  layout(location = 0) in vec3 a_position;\n  layout(location = 1) in vec3 a_normal;\n  layout(location = 2) in vec2 a_texCoord;\n  layout(location = 0) out vec2 uvw;\n  layout(location = 1) out vec2 uv0;\n  layout(location = 2) out vec2 uv1;\n  layout(location = 3) out vec2 uv2;\n  layout(location = 4) out vec2 uv3;\n  layout(location = 5) out vec2 luv;\n  layout(location = 6) out vec3 diffuse;\n  layout(location = 7) out float factor_fog;\n  layout(set = 1, binding = 0) uniform TexCoords {\n    vec4 UVScale;\n    vec4 lightMapUVParam;\n  };\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  layout(location = 0) in vec2 uvw;\n  layout(location = 1) in vec2 uv0;\n  layout(location = 2) in vec2 uv1;\n  layout(location = 3) in vec2 uv2;\n  layout(location = 4) in vec2 uv3;\n  layout(location = 6) in vec3 diffuse;\n  layout(location = 5) in vec2 luv;\n  layout(set = 1, binding = 1) uniform sampler2D weightMap;\n  layout(set = 1, binding = 2) uniform sampler2D detailMap0;\n  layout(set = 1, binding = 3) uniform sampler2D detailMap1;\n  layout(set = 1, binding = 4) uniform sampler2D detailMap2;\n  layout(set = 1, binding = 5) uniform sampler2D detailMap3;\n  layout(set = 1, binding = 6) uniform sampler2D lightMap;\n  layout(location = 7) in float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"LIGHT_MAP",type:"number",range:[0,3]},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"builtin-unlit",_uuid:"a3cd009f-0ab0-420d-9278-b9fdab939bbc",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:4280240937,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  in lowp vec4 a_color;\n  out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  out vec2 v_uv;\n  layout(std140) uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nout float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  in lowp vec4 v_color;\n#endif\nin float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  attribute lowp vec4 a_color;\n  varying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nvarying float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\n  varying lowp vec4 v_color;\n#endif\nvarying float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  layout(location = 13) in lowp vec4 a_color;\n  layout(location = 0) out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  layout(location = 1) out vec2 v_uv;\n  layout(set = 1, binding = 0) uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nlayout(location = 2) out float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  layout(location = 1) in vec2 v_uv;\n  layout(set = 1, binding = 2) uniform sampler2D mainTexture;\n#endif\nlayout(set = 1, binding = 1) uniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  layout(location = 0) in lowp vec4 v_color;\n#endif\nlayout(location = 2) in float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"pipeline/planar-shadow",_uuid:"9361fd90-ba52-4f84-aa93-6e878fd576ca",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2804795238,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"pipeline/skybox",_uuid:"511d2633-09a7-4bdd-ac42-f778032124b3",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:629379420,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(location = 0) out mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 3) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(location = 0) in mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"util/profiler",_uuid:"871c3b6c-7379-419d-bda3-794b239ab90d",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:4021376818,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\n  vec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform mediump vec4 cc_screenSize;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 offset;\n};\nlayout(set = 1, binding = 1) uniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"util/splash-screen",_uuid:"970b0598-bcb0-4714-91fb-2e81440dccd8",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:2106901053,glsl3:{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nlayout(std140) uniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform float u_precent;\nvec4 frag () {\n  vec4 color = texture2D(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 1) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 0) uniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[{name:"splashFrag",defines:[],binding:0,stageFlags:16,members:[{name:"u_precent",type:13,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]),Gs=function(){function e(){o(this,e),this._device=null,this._resources={}}return r(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,n=document.createElement("canvas"),i=n.getContext("2d"),r=new Po(n),o=n.width=n.height=2;i.fillStyle="#000",i.fillRect(0,0,o,o);var s=new ca;s._uuid="black-texture",s.image=r,t[s._uuid]=s,i.fillStyle="rgba(0,0,0,0)",i.fillRect(0,0,o,o);for(var c=new Uint8Array(16),l=0;l<c.length;++l)c[l]=0;var u=new ca;u._uuid="empty-texture",u.image=r,u.uploadData(c),t[u._uuid]=u;var _=new Ms;_._uuid="black-cube-texture",_.setMipFilter(Ms.Filter.LINEAR),_.image={front:new Po(n),back:new Po(n),left:new Po(n),right:new Po(n),top:new Po(n),bottom:new Po(n)},t[_._uuid]=_,i.fillStyle="#777",i.fillRect(0,0,o,o);var f=new ca;f._uuid="grey-texture",f.image=r,t[f._uuid]=f,i.fillStyle="#fff",i.fillRect(0,0,o,o);var h=new ca;h._uuid="white-texture",h.image=r,t[h._uuid]=h;var d=new Ms;d._uuid="white-cube-texture",d.setMipFilter(Ms.Filter.LINEAR),d.image={front:new Po(n),back:new Po(n),left:new Po(n),right:new Po(n),top:new Po(n),bottom:new Po(n)},t[d._uuid]=d,i.fillStyle="#7f7fff",i.fillRect(0,0,o,o);var v=new ca;v._uuid="normal-texture",v.image=r,t[v._uuid]=v,n.width=n.height=16,i.fillStyle="#ddd",i.fillRect(0,0,16,16),i.fillStyle="#555",i.fillRect(0,0,8,8),i.fillStyle="#555",i.fillRect(8,8,8,8);var m=new ca;m._uuid="default-texture",m.image=r,t[m._uuid]=m;var p=new Ms;p.setMipFilter(Ms.Filter.LINEAR),p._uuid="default-cube-texture",p.image={front:new Po(n),back:new Po(n),left:new Po(n),right:new Po(n),top:new Po(n),bottom:new Po(n)},t[p._uuid]=p;var g=new zs,y=r._texture;g.texture=y,g._uuid="default-spriteframe",t[g._uuid]=g,Bs.forEach((function(e){Object.assign(new a.EffectAsset,e).onLoaded()}));var x=new a.Material;x._uuid="standard-material",x.initialize({effectName:"builtin-standard"}),t[x._uuid]=x;var S=new a.Material;S._uuid="missing-effect-material",S.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),S.setProperty("mainColor",a.color("#ffff00")),t[S._uuid]=S;var C=new a.Material;C._uuid="missing-material",C.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),C.setProperty("mainColor",a.color("#ff00ff")),t[C._uuid]=C;var T=new a.Material;T._uuid="ui-base-material",T.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),t[T._uuid]=T;var E=new a.Material;E._uuid="ui-sprite-material",E.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"builtin-sprite"}),t[E._uuid]=E;var A=new a.Material;A._uuid="ui-sprite-gray-material",A.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"builtin-sprite"}),t[A._uuid]=A;var b=new a.Material;b._uuid="ui-sprite-alpha-sep-material",b.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"builtin-sprite"}),t[b._uuid]=b;var w=new a.Material;w._uuid="ui-sprite-gray-alpha-sep-material",w.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"builtin-sprite"}),t[w._uuid]=w;var I=new a.Material;I._uuid="ui-graphics-material",I.initialize({effectName:"builtin-graphics"}),t[I._uuid]=I;var R=new a.Material;R._uuid="default-particle-material",R.initialize({effectName:"builtin-particle"}),t[R._uuid]=R;var O=new a.Material;O._uuid="default-particle-gpu-material",O.initialize({effectName:"builtin-particle-gpu"}),t[O._uuid]=O;var P=new a.Material;P._uuid="default-trail-material",P.initialize({effectName:"builtin-particle-trail"}),t[P._uuid]=P;var N=new a.Material;N._uuid="default-billboard-material",N.initialize({effectName:"builtin-billboard"}),t[N._uuid]=N}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),js=e("d2",a.builtinResMgr=new Gs),Vs=(Fs=new Map,ks=0,function(e){return"number"==typeof e?e:(Fs.has(e)||(Fs.set(e,1<<ks),ks++),Fs.get(e))}),Hs=function(){function e(t,n,i){o(this,e),this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=i*(1<<n)}return r(e,[{key:"allocateNewChunk",value:function(){return new ArrayBuffer(this._chunkSize)}}]),e}(),qs=function e(t,n){o(this,e)},Ws=function(){function e(t,n,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8;o(this,e),this._viewCtor=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freelists=[],this._bufferViews=[],this._nativePool=void 0,this._viewCtor=n,this._elementCount=i.COUNT,this._entryBits=r;var a=n.BYTES_PER_ELEMENT||1;this._stride=a*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Hs(t,r,this._stride)}return r(e,[{key:"alloc",value:function(){for(var e=0;e<this._freelists.length;e++){var t=this._freelists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=0;a<this._entriesPerChunk;a++)r.push(new this._viewCtor(i,this._stride*a,this._elementCount)),a&&o.push(a);return this._arrayBuffers.push(i),this._bufferViews.push(r),this._freelists.push(o),(e<<this._entryBits)+this._poolFlag}},{key:"get",value:function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e;return this._bufferViews[n][i][t]}},{key:"set",value:function(e,t,n){var i=(this._chunkMask&e)>>this._entryBits,r=this._entryMask&e;this._bufferViews[i][r][t]=n}},{key:"free",value:function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;this._bufferViews[t][n].fill(0),this._freelists[t].push(n)}}]),e}(),Xs=function(){function e(t,n,i){o(this,e),this._ctor=void 0,this._dtor=void 0,this._indexMask=void 0,this._poolFlag=void 0,this._array=[],this._freelist=[],this._nativePool=void 0,this._ctor=n,i&&(this._dtor=i),this._poolFlag=1<<29,this._indexMask=~this._poolFlag,this._nativePool=new qs(t,this._array)}return r(e,[{key:"alloc",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._freelist,r=-1;if(i.length&&(r=i[i.length-1],i.length--,this._array[r]=this._ctor(arguments,this._array[r])),r<0){r=this._array.length;var o=this._ctor(arguments);if(!o)return 0;this._array.push(o)}return r+this._poolFlag}},{key:"get",value:function(e){var t=this._indexMask&e;return this._array[t]}},{key:"free",value:function(e){var t=this._indexMask&e;this._dtor&&this._dtor(this._array[t]),this._freelist.push(t)}}]),e}();!function(e){e[e.RASTERIZER_STATE=0]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=1]="DEPTH_STENCIL_STATE",e[e.BLEND_STATE=2]="BLEND_STATE",e[e.DESCRIPTOR_SETS=3]="DESCRIPTOR_SETS",e[e.SHADER=4]="SHADER",e[e.INPUT_ASSEMBLER=5]="INPUT_ASSEMBLER",e[e.PIPELINE_LAYOUT=6]="PIPELINE_LAYOUT",e[e.PASS=7]="PASS",e[e.SUB_MODEL=8]="SUB_MODEL"}(Us||(Us={}));var Ys,Ks=e("dh",0),Qs=new Xs(Us.RASTERIZER_STATE,(function(){return new fi})),Js=new Xs(Us.DEPTH_STENCIL_STATE,(function(){return new hi})),Zs=new Xs(Us.BLEND_STATE,(function(){return new vi})),$s=e("dY",new Xs(Us.SHADER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createShader(e[1])}),(function(e){return e&&e.destroy()}))),ec=e("dl",new Xs(Us.DESCRIPTOR_SETS,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createDescriptorSet(e[1])}),(function(e){return e&&e.destroy()}))),tc=e("dg",new Xs(Us.INPUT_ASSEMBLER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createInputAssembler(e[1])}),(function(e){return e&&e.destroy()}))),nc=new Xs(Us.PIPELINE_LAYOUT,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createPipelineLayout(e[1])}),(function(e){return e&&e.destroy()}));!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.BATCHING_SCHEME=3]="BATCHING_SCHEME",e[e.PRIMITIVE=4]="PRIMITIVE",e[e.DYNAMIC_STATES=5]="DYNAMIC_STATES",e[e.HASH=6]="HASH",e[e.RASTERIZER_STATE=7]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=8]="DEPTH_STENCIL_STATE",e[e.BLEND_STATE=9]="BLEND_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.PIPELINE_LAYOUT=11]="PIPELINE_LAYOUT",e[e.COUNT=12]="COUNT"}(Ys||(Ys=e("dp",{})));var ic,rc=e("dn",new Ws(Us.PASS,Uint32Array,Ys));!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.PASS_COUNT=1]="PASS_COUNT",e[e.PASS_0=2]="PASS_0",e[e.PASS_1=3]="PASS_1",e[e.PASS_2=4]="PASS_2",e[e.PASS_3=5]="PASS_3",e[e.SHADER_0=6]="SHADER_0",e[e.SHADER_1=7]="SHADER_1",e[e.SHADER_2=8]="SHADER_2",e[e.SHADER_3=9]="SHADER_3",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COUNT=12]="COUNT"}(ic||(ic=e("dj",{})));var oc=e("di",new Ws(Us.SUB_MODEL,Uint32Array,ic));function ac(e){return Math.ceil(Math.log2(Math.max(e,2)))}function sc(e,t){switch(e.type){case"boolean":return("number"==typeof t?t:t?1:0)+"";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"-1"}function cc(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:"".concat(e,"|").concat(t.name).concat(t.value)}),"")}function lc(e,t,n){for(var i=e.builtins[n],r=e.blocks,o=0;o<i.blocks.length;o++){var a=i.blocks[o],s=t.record[a.name];if(s&&t.bindings[s.binding].descriptorType&wi){var c=Object.assign({size:uc(s)},s);r.push(c)}else console.warn("builtin UBO '".concat(a.name,"' not available!"))}for(var l=e.samplers,u=0;u<i.samplers.length;u++){var _=i.samplers[u],f=t.record[_.name];f&&t.bindings[f.binding].descriptorType&Ii?l.push(f):console.warn("builtin sampler '".concat(_.name,"' not available!"))}}function uc(e){return e.members.reduce((function(e,t){return e+Zn(t.type)*t.count}),0)}function _c(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}var fc=null,hc=e("aj",new(function(){function e(){o(this,e),this._templates={},this._pipelineLayouts={},this._cache={}}return r(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){for(var n=e,i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var o=t.range;r=ac(o[1]-o[0]+1),t._map=function(e){return e-o[0]}}else"string"===t.type?(r=ac(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);i>31&&(n.uber=!0),n.samplerStartBinding=n.blocks.length,n.bindings=n.blocks.concat(n.samplers);for(var a=0;a<n.blocks.length;a++){var s=n.blocks[a];s.count=1,s.size=uc(s),s.set=ya.MATERIAL,s.descriptorType||(s.descriptorType=bn.UNIFORM_BUFFER)}for(var c=0;c<n.samplers.length;c++){var l=n.samplers[c];l.set=ya.MATERIAL,l.descriptorType||(l.descriptorType=bn.SAMPLER)}n.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=ms(ds.UBO,i.set,i.binding,s.type,o),o+=(Zn(s.type)>>2)*s.count}for(var c=0;c<e.samplers.length;c++){var l=e.samplers[c];t[l.name]=ms(ds.SAMPLER,l.set,l.binding,l.type)}return t}(n),this._templates[e.name]=n,this._pipelineLayouts[e.name]={hPipelineLayout:Ks,setLayouts:[]}}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"getPipelineLayout",value:function(e){return this._pipelineLayouts[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=t[a.name];if(s&&a._map){var c=a._map(s);r+=a._offset+(c+"|")}}return r+n.hash}for(var l=0,u=0;u<i.length;u++){var _=i[u],f=t[_.name];if(f&&_._map)l|=_._map(f)<<_._offset}return"".concat(l.toString(16),"|").concat(n.hash)}},{key:"destroyShaderByDefines",value:function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test($s.get(t._cache[e]).name)}))})),o=0;o<r.length;o++){var a=r[o],s=$s.get(this._cache[a]);console.log("destroyed shader ".concat(s.name)),s.destroy(),delete this._cache[a]}}},{key:"getGFXShader",value:function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._pipelineLayouts[t];s.hPipelineLayout||(lc(a,i.globalDescriptorSetLayout,"globals"),lc(a,i.localDescriptorSetLayout,"locals"),s.setLayouts[ya.GLOBAL]=i.descriptorSetLayout,s.setLayouts[ya.MATERIAL]||(s.setLayouts[ya.MATERIAL]=e.createDescriptorSetLayout({bindings:a.bindings})),s.setLayouts[ya.LOCAL]=fc=fc||e.createDescriptorSetLayout({bindings:i.localDescriptorSetLayout.bindings}),s.hPipelineLayout=nc.alloc(e,{setLayouts:s.setLayouts}));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=r.name,a=e[o],s=sc(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=c.reduce((function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.value,"\n")}),"")+"\n",u=a.glsl3;switch(e.gfxAPI){case ei.GLES2:case ei.WEBGL:u=a.glsl1;break;case ei.GLES3:case ei.WEBGL2:u=a.glsl3;break;case ei.VULKAN:case ei.METAL:u=a.glsl4;break;default:console.error("Invalid GFX API!")}var _=[];return function(e,t,n){for(var i=e.attributes,r=0;r<i.length;r++){var o=i[r];_c(o.defines,t)&&n.push(o)}}(a,n,_),this._cache[r]=$s.alloc(e,{name:cc(t,c),blocks:a.blocks,samplers:a.samplers,attributes:_,stages:[{stage:An.VERTEX,source:l+u.vert},{stage:An.FRAGMENT,source:l+u.frag}]})}}]),e}()));a.programLib=hc;var dc,vc={memUsage:sn.HOST|sn.DEVICE,usage:an.UNIFORM,size:0},mc={buffer:null,offset:0,range:0},pc={layout:null};!function(e){e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(dc||(dc=e("ah",{})));var gc=e("ai",function(){function e(t){o(this,e),this._rootBuffer=null,this._rootBufferDirty=!1,this._buffers=[],this._descriptorSet=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._root=void 0,this._device=void 0,this._hShaderDefault=Ks,this._handle=Ks,this._root=t,this._device=t.device}return r(e,null,[{key:"fillPipelineInfo",value:function(e,t){void 0!==t.priority&&rc.set(e,Ys.PRIORITY,t.priority),void 0!==t.primitive&&rc.set(e,Ys.PRIMITIVE,t.primitive),void 0!==t.stage&&rc.set(e,Ys.STAGE,t.stage),void 0!==t.dynamicStates&&rc.set(e,Ys.DYNAMIC_STATES,t.dynamicStates),void 0!==t.phase&&rc.set(e,Ys.PHASE,Vs(t.phase));var n=Zs.get(rc.get(e,Ys.BLEND_STATE));if(t.blendState){var i=t.blendState;i.targets&&i.targets.forEach((function(e,t){return Object.assign(n.targets[t]||(n.targets[t]=new di),e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&Object.assign(n.blendColor,i.blendColor)}Object.assign(Qs.get(rc.get(e,Ys.RASTERIZER_STATE)),t.rasterizerState),Object.assign(Js.get(rc.get(e,Ys.DEPTH_STENCIL_STATE)),t.depthStencilState)}},{key:"getPassHash",value:function(e,t){var n,i=t+","+rc.get(e,Ys.PRIMITIVE)+","+rc.get(e,Ys.DYNAMIC_STATES);return i+=function(e){for(var t,n=",bs,".concat(e.isA2C,",").concat(e.blendColor),i=N(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,".concat(r.blend,",").concat(r.blendEq,",").concat(r.blendAlphaEq,",").concat(r.blendColorMask),n+=",".concat(r.blendSrc,",").concat(r.blendDst,",").concat(r.blendSrcAlpha,",").concat(r.blendDstAlpha)}return n}(Zs.get(rc.get(e,Ys.BLEND_STATE))),i+=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)}(Js.get(rc.get(e,Ys.DEPTH_STENCIL_STATE))),ui(i+=",rs,"+(n=Qs.get(rc.get(e,Ys.RASTERIZER_STATE))).cullMode+","+n.depthBias+","+n.isFrontFaceCCW,666)}}]),r(e,[{key:"initialize",value:function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:rn.UNKNOWN,i=this._propertyHandleMap[e];return i?(n?i=Ss(i,n):t&&(i=Ss(i,gs(i)-t)),i+t):0}},{key:"getBinding",value:function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1}},{key:"setUniform",value:function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._blocks[i];Ts[r](a,n,o),this._rootBufferDirty=!0}},{key:"getUniform",value:function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._blocks[i];return Cs[r](a,n,o)}},{key:"setUniformArray",value:function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=Zn(r)>>2,a=this._blocks[i],s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=o)null!==n[c]&&Ts[r](a,n[c],s);this._rootBufferDirty=!0}},{key:"bindTexture",value:function(e,t,n){this._descriptorSet.bindTexture(e,t,n)}},{key:"bindSampler",value:function(e,t,n){this._descriptorSet.bindSampler(e,t,n)}},{key:"setDynamicState",value:function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){console.warn("base pass cannot override states, please use pass instance instead.")}},{key:"update",value:function(){this._rootBufferDirty&&this._rootBuffer&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()}},{key:"destroy",value:function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];Ca(t.set)||this._buffers[t.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBlock=null),this._descriptorSet=null,this._handle&&(Qs.free(rc.get(this._handle,Ys.RASTERIZER_STATE)),Js.free(rc.get(this._handle,Ys.DEPTH_STENCIL_STATE)),Zs.free(rc.get(this._handle,Ys.BLEND_STATE)),ec.free(rc.get(this._handle,Ys.DESCRIPTOR_SET)),rc.free(this._handle),this._handle=Ks)}},{key:"resetUniform",value:function(t){var n=this.getHandle(t);if(n){var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),o=e.getOffsetFromHandle(n),a=this._blocks[r],s=this._properties[t],c=s&&s.value||As(i);Ts[i](a,c,o),this._rootBufferDirty=!0}}},{key:"resetTexture",value:function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),o=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":As(r),l=js.get(c),u=l&&l.getGFXTexture(),_=a&&void 0!==a.samplerHash?a.samplerHash:l&&l.getSamplerHash(),f=Ko.getSampler(this._device,_);this._descriptorSet.bindSampler(o,f,n),this._descriptorSet.bindTexture(o,u,n)}}},{key:"resetUBOs",value:function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];if(!Ca(t.set))for(var n=this._blocks[t.binding],i=0,r=0;r<t.members.length;r++){for(var o=t.members[r],a=this._properties[o.name],s=a&&a.value,c=s||As(o.type),l=(Zn(o.type)>>2)*o.count,u=0;u+c.length<=l;u+=c.length)n.set(c,i+u);i+=l}}this._rootBufferDirty=!0}},{key:"resetTextures",value:function(){for(var e=0;e<this._shaderInfo.samplers.length;e++){var t=this._shaderInfo.samplers[e];if(!Ca(t.set))for(var n=0;n<t.count;n++)this.resetTexture(t.name,n)}}},{key:"tryCompile",value:function(){var t=this._root.pipeline;return t?(this._syncBatchingScheme(),this._hShaderDefault=hc.getGFXShader(this._device,this._programName,this._defines,t),this._hShaderDefault?(rc.set(this._handle,Ys.PIPELINE_LAYOUT,hc.getPipelineLayout(this._programName).hPipelineLayout),rc.set(this._handle,Ys.HASH,e.getPassHash(this._handle,this._hShaderDefault)),!0):(console.warn("create shader ".concat(this._programName," failed")),!1)):null}},{key:"getShaderVariant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this._hShaderDefault&&!this.tryCompile())return console.warn("pass resources incomplete"),Ks;if(!e)return this._hShaderDefault;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=hc.getGFXShader(this._device,this._programName,this._defines,t),o=0;o<e.length;o++){var a=e[o];delete this._defines[a.name]}return r}},{key:"beginChangeStatesSilently",value:function(){}},{key:"endChangeStatesSilently",value:function(){}},{key:"_doInit",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this._handle=rc.alloc();rc.set(i,Ys.PRIORITY,fa.DEFAULT),rc.set(i,Ys.STAGE,_a.DEFAULT),rc.set(i,Ys.PHASE,Vs("default")),rc.set(i,Ys.PRIMITIVE,un.TRIANGLE_LIST),rc.set(i,Ys.RASTERIZER_STATE,Qs.alloc()),rc.set(i,Ys.DEPTH_STENCIL_STATE,Js.alloc()),rc.set(i,Ys.BLEND_STATE,Zs.alloc()),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?Object.assign({},t.defines):t.defines,this._shaderInfo=hc.getTemplate(t.program),this._properties=t.properties||this._properties;var r=this._device;e.fillPipelineInfo(i,t),t.stateOverrides&&e.fillPipelineInfo(i,t.stateOverrides);var o=hc.getPipelineLayout(t.program).setLayouts;o[ya.MATERIAL]||(o[ya.MATERIAL]=r.createDescriptorSetLayout({bindings:this._shaderInfo.bindings})),pc.layout=o[ya.MATERIAL];var a=ec.alloc(this._device,pc);rc.set(this._handle,Ys.DESCRIPTOR_SET,a),this._descriptorSet=ec.get(a);for(var s=this._shaderInfo.blocks,c=r.uboOffsetAlignment,l=[],u=0,_=0,f=0;f<s.length;f++){var h=s[f],d=h.size,v=h.set;Ca(v)||(l.push(_),_+=Math.ceil(d/c)*c,u=d)}var m=l[l.length-1]+u;m&&(vc.size=16*Math.ceil(m/16),this._rootBuffer=r.createBuffer(vc),this._rootBlock=new ArrayBuffer(m));for(var p=0,g=0;p<s.length;p++){var y=s[p],x=y.size,S=y.set,C=y.binding;if(!Ca(S)){mc.buffer=this._rootBuffer,mc.offset=l[g++],mc.range=16*Math.ceil(x/16);var T=this._buffers[C]=r.createBuffer(mc);this._blocks[C]=new Float32Array(this._rootBlock,mc.offset,x/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(C,T)}}var E=this._propertyHandleMap=this._shaderInfo.handleMap,A={};for(var b in this._properties){var w=this._properties[b];w.handleInfo&&(A[b]=this.getHandle.apply(this,w.handleInfo))}Object.assign(E,A)}},{key:"_syncBatchingScheme",value:function(){this._defines.USE_INSTANCING?this._device.hasFeature(ti.INSTANCED_ARRAYS)?rc.set(this._handle,Ys.BATCHING_SCHEME,dc.INSTANCING):(this._defines.USE_INSTANCING=!1,rc.set(this._handle,Ys.BATCHING_SCHEME,0)):this._defines.USE_BATCHING?rc.set(this._handle,Ys.BATCHING_SCHEME,dc.VB_MERGING):rc.set(this._handle,Ys.BATCHING_SCHEME,0)}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"setLayouts",get:function(){return hc.getPipelineLayout(this._programName).setLayouts}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"handle",get:function(){return this._handle}},{key:"priority",get:function(){return rc.get(this._handle,Ys.PRIORITY)}},{key:"primitive",get:function(){return rc.get(this._handle,Ys.PRIMITIVE)}},{key:"stage",get:function(){return rc.get(this._handle,Ys.STAGE)}},{key:"phase",get:function(){return rc.get(this._handle,Ys.PHASE)}},{key:"rasterizerState",get:function(){return Qs.get(rc.get(this._handle,Ys.RASTERIZER_STATE))}},{key:"depthStencilState",get:function(){return Js.get(rc.get(this._handle,Ys.DEPTH_STENCIL_STATE))}},{key:"blendState",get:function(){return Zs.get(rc.get(this._handle,Ys.BLEND_STATE))}},{key:"dynamicStates",get:function(){return rc.get(this._handle,Ys.DYNAMIC_STATES)}},{key:"batchingScheme",get:function(){return rc.get(this._handle,Ys.BATCHING_SCHEME)}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return rc.get(this._handle,Ys.HASH)}}]),e}());function yc(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function xc(e,t){return Math.ceil(e/t)*t}gc.PropertyType=ds,gc.getPropertyTypeFromHandle=ps,gc.getTypeFromHandle=gs,gc.getBindingFromHandle=ys,gc.getOffsetFromHandle=xs;var Sc,Cc,Tc,Ec,Ac,bc,wc,Ic,Rc,Oc,Pc,Nc,Dc,zc,Mc,Lc,Fc=e("ap",function(){function e(t){o(this,e),this._device=void 0,this._format=on.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new qn,this._region1=new qn,this._region2=new qn,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}return r(e,[{key:"initialize",value:function(e){var t=Yn[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=$n(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e){this._chunks[e].texture.destroy()}this._chunks.length=0,this._handles.length=0}},{key:"alloc",value:function(e,t){e=xc(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,yc(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"createChunk",value:function(e){var t=e*e*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture({type:Sn.TEX2D,usage:Cn.SAMPLED|Cn.TRANSFER_DST,format:this._format,width:e,height:e,levelCount:1}),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++}},{key:"update",value:function(e,t){var n=[],i=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)}},{key:"_findAvailableSpace",value:function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1}},{key:"_McDonaldAlloc",value:function(e){e=xc(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var o={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,yc(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l}}]),e}()),kc={},Uc=e("b2",E("cc.EffectAsset")((wc=bc=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"techniques",Tc,M(n)),I(n,"shaders",Ec,M(n)),I(n,"combinations",Ac,M(n)),n}return c(t,e),r(t,[{key:"onLoaded",value:function(){this.shaders.forEach((function(e){return hc.define(e)})),a.game.once(a.Game.EVENT_ENGINE_INITED,this._precompile,this),t.register(this)}},{key:"_precompile",value:function(){for(var e=this,t=a.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){var i=r[t],o=[n].concat(B(Array(i.length-1)).map((function(){return Object.assign({},n)})));return o.forEach((function(e,n){return e[t]=i[n]})),e.concat(o)}),[])}),[{}]).forEach((function(e){return hc.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)}}],[{key:"register",value:function(e){kc[e.name]=e}},{key:"remove",value:function(e){if(kc[e])delete kc[e];else for(var t in kc)if(kc[t]._uuid===e)return void delete kc[t]}},{key:"get",value:function(e){if(kc[e])return kc[e];for(var t in kc)if(kc[t]._uuid===e)return kc[t];return null}},{key:"getAll",value:function(){return kc}}]),t}(D),bc._effects={},Tc=A((Cc=wc).prototype,"techniques",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ec=A(Cc.prototype,"shaders",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ac=A(Cc.prototype,"combinations",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sc=Cc))||Sc);a.EffectAsset=Uc;var Bc=new yi;Bc.endLayout=On.SHADER_READONLY_OPTIMAL;var Gc,jc,Vc,Hc,qc,Wc,Xc,Yc,Kc,Qc={colorAttachments:[Bc],depthStencilAttachment:new xi},Jc={width:1,height:1,renderPassInfo:Qc},Zc=e("b6",(Ic=E("cc.RenderTexture"),Rc=Q(),Oc=J(),Pc=Q(),Nc=J(),Ic((Mc=A((zc=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"_width",Mc,M(n)),I(n,"_height",Lc,M(n)),n._window=null,n}return c(t,e),r(t,[{key:"initialize",value:function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){this._window&&(a.director.root.destroyWindow(this._window),this._window=null);return P(u(t.prototype),"destroy",this).call(this)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._window&&this._window.resize(e,t),this.emit("resize",this._window)}},{key:"getGFXTexture",value:function(){return this._window&&this._window.framebuffer.colorTextures[0]}},{key:"getGFXSampler",value:function(){var e=a.director.root;return Ko.getSampler(e.device,Do)}},{key:"onLoaded",value:function(){this._initWindow(),this.loaded=!0,this.emit("load")}},{key:"_initWindow",value:function(e){var t=a.director.root;Jc.title=this._name,Jc.width=this._width,Jc.height=this._height,Jc.renderPassInfo=e&&e.passInfo?e.passInfo:Qc,this._window?(this._window.destroy(),this._window.initialize(t.device,Jc)):this._window=t.createWindow(Jc)}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"window",get:function(){return this._window}}]),t}(D)).prototype,"_width",[b,Rc,Oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Lc=A(zc.prototype,"_height",[b,Pc,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Dc=zc))||Dc));a.RenderTexture=Zc;var $c=e("b3",(Gc=E("cc.Material"),jc=F(Uc),Gc((qc=A((Hc=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),I(e,"_effectAsset",qc,M(e)),I(e,"_techIdx",Wc,M(e)),I(e,"_defines",Xc,M(e)),I(e,"_states",Yc,M(e)),I(e,"_props",Kc,M(e)),e._passes=[],e._hash=0,e.loaded=!1,e}return c(t,e),r(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}],[{key:"getHash",value:function(e){for(var t,n=0,i=N(e.passes);!(t=i()).done;){n^=t.value.hash}return n}}]),r(t,[{key:"initialize",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=Uc.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){return this._doDestroy(),P(u(t.prototype),"destroy",this).call(this)}},{key:"recompileShaders",value:function(e,t){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}},{key:"overridePipelineStates",value:function(e,t){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"resetUniforms",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=N(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}}},{key:"setProperty",value:function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: ".concat(n,"."));var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=Object.assign({},e._props[t]);this._defines.length=e._defines.length;for(var n=0;n<e._defines.length;n++)this._defines[n]=Object.assign({},e._defines[n]);this._states.length=e._states.length;for(var i=0;i<e._states.length;i++)this._states[i]=Object.assign({},e._states[i]);this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var n=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(n).fill(e)}for(var i=0;i<e.length;++i)Object.assign(t[i]||(t[i]={}),e[i])}},{key:"_createPasses",value:function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var r=e.passes[i],o=r.passIndex=i,s=r.defines=this._defines[o]||(this._defines[o]={}),c=r.stateOverrides=this._states[o]||(this._states[o]={});if(void 0!==r.propertyIndex&&(Object.assign(s,this._defines[r.propertyIndex]),Object.assign(c,this._states[r.propertyIndex])),void 0!==r.embeddedMacros&&Object.assign(s,r.embeddedMacros),!r.switch||s[r.switch]){var l=new gc(a.director.root);l.initialize(r),n.push(l)}}return n}},{key:"_update",value:function(){var e=this,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._effectAsset){if(this._passes&&this._passes.length)for(var i,r=N(this._passes);!(i=r()).done;){var o=i.value;o.destroy()}this._passes=this._createPasses();var a=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=a,n)this._passes.forEach((function(t,n){var i=e._props[n];for(var r in i||(i=e._props[n]={}),i=e._props[t.propertyIndex])e._uploadProperty(t,r,i[r])}));else for(var s=0;s<this._props.length;s++)this._props[s]={}}else{var c=js.get("missing-effect-material");c&&(this._passes=c._passes.slice())}this._hash=t.getHash(this)}},{key:"_uploadProperty",value:function(e,t,n){var i=e.getHandle(t);if(!i)return!1;var r=gc.getPropertyTypeFromHandle(i);if(r===ds.UBO)Array.isArray(n)?e.setUniformArray(i,n):null!==n?e.setUniform(i,n):e.resetUniform(t);else if(r===ds.SAMPLER)if(Array.isArray(n))for(var o=0;o<n.length;o++)this._bindTexture(e,i,n[o],o);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0}},{key:"_bindTexture",value:function(e,t,n,i){var r=gc.getBindingFromHandle(t);if(n instanceof bi)e.bindTexture(r,n,i);else if(n instanceof Jo||n instanceof zs||n instanceof Zc){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return!1;e.bindTexture(r,o,i),e.bindSampler(r,n.getGFXSampler(),i)}}},{key:"_doDestroy",value:function(){if(this._passes&&this._passes.length)for(var e,t=N(this._passes);!(e=t()).done;){e.value.destroy()}this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0}}]),t}(D)).prototype,"_effectAsset",[jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wc=A(Hc.prototype,"_techIdx",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xc=A(Hc.prototype,"_defines",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yc=A(Hc.prototype,"_states",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kc=A(Hc.prototype,"_props",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vc=Hc))||Vc));a.Material=$c;var el,tl=e("ar",function(e){function t(e,n){var i;o(this,t),(i=l(this,u(t).call(this,e.root)))._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=e,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var a=i._shaderInfo.blocks[r];if(!Ca(a.set)){var s=i._blocks[a.binding],c=i._parent.blocks[a.binding];s.set(c)}}i._rootBufferDirty=!0;for(var _=i._parent,f=0;f<i._shaderInfo.samplers.length;f++){var h=i._shaderInfo.samplers[f];if(!Ca(h.set))for(var d=0;d<h.count;d++){var v=_._descriptorSet.getSampler(h.binding,d),m=_._descriptorSet.getTexture(h.binding,d);i._descriptorSet.bindSampler(h.binding,v,d),i._descriptorSet.bindTexture(h.binding,m,d)}}return P(u(t.prototype),"tryCompile",M(i)).call(M(i)),i}return c(t,e),r(t,[{key:"parent",get:function(){return this._parent}}]),r(t,[{key:"overridePipelineStates",value:function(e,t){Zs.free(rc.get(this._handle,Ys.BLEND_STATE)),Qs.free(rc.get(this._handle,Ys.RASTERIZER_STATE)),Js.free(rc.get(this._handle,Ys.DEPTH_STENCIL_STATE)),rc.set(this._handle,Ys.BLEND_STATE,Zs.alloc()),rc.set(this._handle,Ys.RASTERIZER_STATE,Qs.alloc()),rc.set(this._handle,Ys.DEPTH_STENCIL_STATE,Js.alloc()),gc.fillPipelineInfo(this._handle,e),gc.fillPipelineInfo(this._handle,t),this._onStateChange()}},{key:"tryCompile",value:function(e){if(e&&!bs(this._defines,e))return!1;var n=P(u(t.prototype),"tryCompile",this).call(this);return this._onStateChange(),n}},{key:"beginChangeStatesSilently",value:function(){this._dontNotify=!0}},{key:"endChangeStatesSilently",value:function(){this._dontNotify=!1}},{key:"_syncBatchingScheme",value:function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,rc.set(this._handle,Ys.BATCHING_SCHEME,0)}},{key:"_onStateChange",value:function(){rc.set(this._handle,Ys.HASH,gc.getPassHash(this._handle,this._hShaderDefault)),this._owner.onPassStateChange(this._dontNotify)}}]),t}(gc)),nl=e("aq",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this)))._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=e.parent,n._owner=e.owner||null,n._subModelIdx=e.subModelIdx||0,n.copy(n._parent),n}return c(t,e),r(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),r(t,[{key:"recompileShaders",value:function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=N(this._passes);!(n=i()).done;){n.value.tryCompile(e)}else this._passes[t].tryCompile(e)}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in e)o[a]=e[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}}},{key:"destroy",value:function(){return this._doDestroy(),!0}},{key:"onPassStateChange",value:function(e){this._hash=$c.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}},{key:"_createPasses",value:function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new tl(t[n],this));return e}}]),t}($c));!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed"}(el||(el=e("bg",{}))),_(el),a.SystemEventType=el;var il=new X,rl=e("bb",function(e){function t(e,n,i){var r;return o(this,t),(r=l(this,u(t).call(this,Z.MOUSE,n))).movementX=0,r.movementY=0,r.eventType=void 0,r._button=t.BUTTON_MISSING,r._x=0,r._y=0,r._prevX=0,r._prevY=0,r._scrollX=0,r._scrollY=0,r.eventType=e,i&&(r._prevX=i.x,r._prevY=i.y),r}return c(t,e),r(t,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e||(e=new X),X.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e||(e=new X),X.set(e,this._x,a.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e||(e=new X),X.set(e,this._x,this._y),a.view._convertPointWithScale(e),e}},{key:"getPreviousLocation",value:function(e){return e||(e=new X),X.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new X),X.set(e,this._prevX,this._prevY),a.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new X),X.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e||(e=new X),X.set(e,(this._x-this._prevX)/a.view.getScaleX(),(this._y-this._prevY)/a.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/a.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/a.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=a.view.getViewportRect();return(this._x-e.x)/a.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=a.view.getViewportRect();return(this._y-e.y)/a.view.getScaleY()}}]),t}(Z));rl.NONE=0,rl.DOWN=1,rl.UP=2,rl.MOVE=3,rl.SCROLL=4,rl.BUTTON_MISSING=-1,rl.BUTTON_LEFT=0,rl.BUTTON_RIGHT=2,rl.BUTTON_MIDDLE=1,rl.BUTTON_4=3,rl.BUTTON_5=4,rl.BUTTON_6=5,rl.BUTTON_7=6,rl.BUTTON_8=7;var ol=e("bc",function(e){function t(e,n,i,r){var a;return o(this,t),(a=l(this,u(t).call(this,Z.TOUCH,n))).touch=null,a.simulate=!1,a._eventCode=void 0,a._touches=void 0,a._allTouches=void 0,a._eventCode=i||0,a._touches=e||[],a._allTouches=r||[],a}return c(t,e),r(t,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"getAllTouches",value:function(){return this._allTouches}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new X}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new X}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new X}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new X}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new X}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new X}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new X}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new X}},{key:"getDeltaX",value:function(){return this.touch?this.touch.getDelta(il).x:0}},{key:"getDeltaY",value:function(){return this.touch?this.touch.getDelta(il).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),t}(Z));ol.MAX_TOUCHES=5,ol.BEGAN=0,ol.MOVED=1,ol.ENDED=2,ol.CANCELLED=3;var al=e("bd",function(e){function t(e,n){var i;return o(this,t),(i=l(this,u(t).call(this,Z.ACCELERATION,n))).acc=void 0,i.acc=e,i}return c(t,e),t}(Z)),sl=e("be",function(e){function t(e,n,i){var r;return o(this,t),(r=l(this,u(t).call(this,Z.KEYBOARD,i))).keyCode=void 0,r.rawEvent=void 0,r.isPressed=void 0,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r.isPressed=n,r}return c(t,e),t}(Z));Z.EventMouse=rl,Z.EventTouch=ol,Z.EventAcceleration=al,Z.EventKeyboard=sl;var cl=e("d8",function(){function e(t,n,i){o(this,e),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=t||0,this._listenerID=n||""}return r(e,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){$(e&&e.event,1900);var t=e.event;delete e.event;var n=null;if(t===a.EventListener.TOUCH_ONE_BY_ONE?n=new _l:t===a.EventListener.TOUCH_ALL_AT_ONCE?n=new fl:t===a.EventListener.MOUSE?n=new ul:t===a.EventListener.KEYBOARD?n=new dl:t===a.EventListener.ACCELERATION&&(n=new hl(e.callback),delete e.callback),n)for(var i=0,r=Object.keys(e);i<r.length;i++){var o=r[i];n[o]=e[o]}return n}}]),r(e,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),e}());cl.UNKNOWN=0,cl.TOUCH_ONE_BY_ONE=1,cl.TOUCH_ALL_AT_ONCE=2,cl.KEYBOARD=3,cl.MOUSE=4,cl.ACCELERATION=6,cl.CUSTOM=8,cl.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var ll=cl.ListenerID,ul=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this,cl.MOUSE,ll.MOUSE,null))).onMouseDown=null,e.onMouseUp=null,e.onMouseMove=null,e.onMouseScroll=null,e._onEvent=function(t){return e._callback(t)},e}return c(t,e),r(t,[{key:"_callback",value:function(e){var t=a.Event.EventMouse;switch(e.eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new t;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),t}(cl),_l=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this,cl.TOUCH_ONE_BY_ONE,ll.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return c(t,e),r(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(ee(1801),!1)}}]),t}(cl),fl=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this,cl.TOUCH_ALL_AT_ONCE,ll.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return c(t,e),r(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(ee(1802),!1)}}]),t}(cl),hl=function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,cl.ACCELERATION,ll.ACCELERATION,null)))._onAccelerationEvent=null,n._onEvent=function(e){return n._callback(e)},n._onAccelerationEvent=e,n}return c(t,e),r(t,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return $(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new t(this._onAccelerationEvent)}}]),t}(cl),dl=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this,cl.KEYBOARD,ll.KEYBOARD,null))).onKeyPressed=null,e.onKeyReleased=null,e._onEvent=function(t){return e._callback(t)},e}return c(t,e),r(t,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new t;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(ee(1800),!1)}}]),t}(cl);a.EventListener=cl;var vl=cl.ListenerID;var ml=function(){function e(){o(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return r(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();var pl=e("b9",new(function(){function e(){o(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}return r(e,[{key:"pauseTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof a._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var i=0;i<n.length;++i){var r=n[i];r._setPaused(!0)}if(!0===t){var o=e.children;if(o)for(var s=0;s<o.length;++s){var c=o[s];this.pauseTarget(c,!0)}}}else G(3506)}},{key:"resumeTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof a._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var i=0;i<n.length;++i){var r=n[i];r._setPaused(!1)}if(this._setDirtyForNode(e),!0===t&&e.children.length>0){var o=e.children;if(o)for(var s=0;s<o.length;++s){var c=o[s];this.resumeTarget(c,!0)}}}else G(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var n in e)e[n].empty()&&(delete t[n],delete e[n]);var i=this._toAddedListeners;if(0!==i.length){for(var r=0,o=i.length;r<o;r++)this._forceAddEventListener(i[r]);i.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if($(e&&t,3503),a.js.isNumber(t)||t instanceof a._BaseNode){if(e instanceof a.EventListener){if(e._isRegistered())return void ee(3505)}else $(!a.js.isNumber(t),3504),e=a.EventListener.create(e);if(e.checkAvailable()){if(a.js.isNumber(t)){if(0===t)return void ee(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!(n=t)||!n.getComponent("cc.UITransform"))return void ee(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}var n;return e}}else G(3506)}},{key:"addCustomListener",value:function(e,t){var n=cl.create({event:a.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(n,1),n}},{key:"removeListener",value:function(e){if(null!=e){var t=!1,n=this._listenersMap;for(var i in n){var r=n[i],o=r.getFixedPriorityListeners(),s=r.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(s,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(o,e))&&this._setDirty(e._getListenerID(),1),r.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete n[i]),t)break}if(!t)for(var c=this._toAddedListeners,l=c.length-1;l>=0;l--){var u=c[l];if(u===e){a.js.array.removeAt(c,l),u._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(a.js.isNumber(e)||e instanceof a._BaseNode)if(void 0!==e._id){var n=this._nodeListenersMap[e._id];if(n){for(var i=a.js.array.copy(n),r=0;r<i.length;++r){var o=i[r];this.removeListener(o)}delete this._nodeListenersMap[e._id]}for(var s=this._toAddedListeners,c=0;c<s.length;){var l=s[c];l._getSceneGraphPriority()===e?(l._setSceneGraphPriority(null),l._setRegistered(!1),s.splice(c,1)):++c}if(!0===t)for(var u=e.getChildren(),_=0;_<u.length;++_){var f=u[_];this.removeListeners(f,!0)}}else e===a.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(vl.TOUCH_ONE_BY_ONE):e===a.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(vl.TOUCH_ALL_AT_ONCE):e===a.EventListener.MOUSE?this._removeListenersForListenerID(vl.MOUSE):e===a.EventListener.ACCELERATION?this._removeListenersForListenerID(vl.ACCELERATION):e===a.EventListener.KEYBOARD?this._removeListenersForListenerID(vl.KEYBOARD):ee(3501);else G(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var n in e)-1===t.indexOf(n)&&this._removeListenersForListenerID(n)}},{key:"setPriority",value:function(e,t){if(null!=e){var n=this._listenersMap;for(var i in n){var r=n[i].getFixedPriorityListeners();if(r)if(-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&ee(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(a.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=Z,n=e.type;return n===t.ACCELERATION?vl.ACCELERATION:n===t.KEYBOARD?vl.KEYBOARD:n.startsWith(t.MOUSE)?vl.MOUSE:(n.startsWith(t.TOUCH)&&ee(2e3),"")}(e);this._sortEventListeners(t);var n=this._listenersMap[t];null!=n&&(this._dispatchEventToListeners(n,this._onListenerCallback,e),this._onUpdateListeners(n)),this._inDispatch--}else L(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var n=e.onEvent;return n&&n(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var n=new a.Event.EventCustom(e);n.setUserData(t),this.dispatchEvent(n)}},{key:"_setDirtyForNode",value:function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var n=0,i=t.length;n<i;n++){var r=t[n]._getListenerID();null==this._dirtyListeners[r]&&(this._dirtyListeners[r]=!0)}if(e.children.length>0)for(var o=e.children,a=0,s=o?o.length:0;a<s;a++)this._setDirtyForNode(o[a])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),n=this._listenersMap[t];if(n||(n=new ml,this._listenersMap[t]=n),n.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var i=e._getSceneGraphPriority();null===i&&ee(3507),this._associateNodeAndEventListener(i,e),i.activeInHierarchy&&this.resumeTarget(i)}else this._setDirty(t,1)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2);this._dirtyListeners.length=0}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,n=e.length-1;n>=0;n--)(t=e[n])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&a.js.array.removeAt(e,n)}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var n=t.getFixedPriorityListeners(),i=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(i),this._removeAllListenersInVector(n),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,o=r.length-1;o>=0;o--){var s=r[o];s&&s._getListenerID()===e&&a.js.array.removeAt(r,o)}}},{key:"_sortEventListeners",value:function(e){var t=0,n=this._priorityDirtyFlagMap;(n[e]&&(t=n[e]),0!==t)&&(n[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&a.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))}},{key:"_sortListenersOfSceneGraphPriority",value:function(e){var t=this._getListeners(e);if(t){var n=t.getSceneGraphPriorityListeners();n&&0!==n.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var n=e._getSceneGraphPriority(),i=t._getSceneGraphPriority();if(!(t&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return 1;var r=n,o=i,a=!1,s=n._uiProps.uiTransformComp,c=i._uiProps.uiTransformComp;if(s.visibility!==c.visibility)return c.visibility-s.visibility;for(;r.parent._id!==o.parent._id;)r=null===r.parent.parent?(a=!0)&&i:r.parent,o=null===o.parent.parent?(a=!0)&&n:o.parent;if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var l=r.getSiblingIndex(),u=o.getSiblingIndex();return a?l-u:u-l}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var n=t.getFixedPriorityListeners();if(n&&0!==n.length){n.sort(this._sortListenersOfFixedPriorityAsc);for(var i=0,r=n.length;i<r&&!(n[i]._getFixedPriority()>=0);)++i;t.gt0Index=i}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),n=e.getSceneGraphPriorityListeners(),i=this._toRemovedListeners;if(n)for(var r=n.length-1;r>=0;r--){var o=n[r];if(!o._isRegistered()){a.js.array.removeAt(n,r);var s=i.indexOf(o);-1!==s&&i.splice(s,1)}}if(t)for(var c=t.length-1;c>=0;c--){var l=t[c];if(!l._isRegistered()){a.js.array.removeAt(t,c);var u=i.indexOf(l);-1!==u&&i.splice(u,1)}}n&&0===n.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if($(t>0,3508),!(t>1)){var n;(n=this._listenersMap[vl.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(n),(n=this._listenersMap[vl.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(n),$(1===t,3509);var i=this._toAddedListeners;if(0!==i.length){for(var r=0,o=i.length;r<o;r++)this._forceAddEventListener(i[r]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var n=e[t],i=this._listenersMap[n._getListenerID()];if(i){var r=i.getFixedPriorityListeners(),o=i.getSceneGraphPriorityListeners();if(o){var a=o.indexOf(n);-1!==a&&o.splice(a,1)}if(r){var s=r.indexOf(n);-1!==s&&r.splice(s,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var n=t.event,i=n.touch;n.currentTarget=e._getSceneGraphPriority();var r=!1,o=-1,a=n.getEventCode();if(a===ol.BEGAN){if(!$o.ENABLE_MULTI_TOUCH&&pl._currentTouch){var s=pl._currentTouchListener._node;if(!s||s.activeInHierarchy)return!1}e.onTouchBegan&&(r=e.onTouchBegan(i,n))&&e._isRegistered()&&(e._claimedTouches.push(i),!$o.ENABLE_MULTI_TOUCH&&pl._currentTouch||(pl._currentTouch=i),pl._currentTouchListener=e)}else if(e._claimedTouches.length>0&&-1!==(o=e._claimedTouches.indexOf(i))){if(r=!0,!$o.ENABLE_MULTI_TOUCH&&pl._currentTouch&&pl._currentTouch!==i)return!1;a===ol.MOVED&&e.onTouchMoved?e.onTouchMoved(i,n):a===ol.ENDED?(e.onTouchEnded&&e.onTouchEnded(i,n),e._isRegistered()&&e._claimedTouches.splice(o,1),($o.ENABLE_MULTI_TOUCH||pl._currentTouch===i)&&(pl._currentTouch=null),pl._currentTouchListener=null):a===ol.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(i,n),e._isRegistered()&&e._claimedTouches.splice(o,1),($o.ENABLE_MULTI_TOUCH||pl._currentTouch===i)&&(pl._currentTouch=null),pl._currentTouchListener=null)}return n.isStopped()?(pl._updateTouchListeners(n),!0):!!(r&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(i,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(vl.TOUCH_ONE_BY_ONE),this._sortEventListeners(vl.TOUCH_ALL_AT_ONCE);var t=this._getListeners(vl.TOUCH_ONE_BY_ONE),n=this._getListeners(vl.TOUCH_ALL_AT_ONCE);if(null!==t||null!==n){var i=e.getTouches(),r=a.js.array.copy(i),o={event:e,needsMutableSet:t&&n,touches:r,selTouch:null};if(t)for(var s=0;s<i.length;++s){var c=i[s];e.touch=c,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,o)}n&&r.length>0&&(this._dispatchEventToListeners(n,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var n=t.event,i=t.touches,r=n.getEventCode();return n.currentTarget=e._getSceneGraphPriority(),r===ol.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(i,n):r===ol.MOVED&&e.onTouchesMoved?e.onTouchesMoved(i,n):r===ol.ENDED&&e.onTouchesEnded?e.onTouchesEnded(i,n):r===ol.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(i,n),!!n.isStopped()&&(pl._updateTouchListeners(n),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var n=this._nodeListenersMap[e.uuid];n||(n=[],this._nodeListenersMap[e.uuid]=n),n.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var n=this._nodeListenersMap[e.uuid];n&&(a.js.array.remove(n,t),0===n.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,n){var i=!1,r=e.getFixedPriorityListeners(),o=e.getSceneGraphPriorityListeners(),a=0;if(r&&0!==r.length)for(;a<e.gt0Index;++a){var s=r[a];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&t(s,n)){i=!0;break}}if(o&&!i)for(var c=0;c<o.length;++c){var l=o[c];if(l.isEnabled()&&!l._isPaused()&&l._isRegistered()&&t(l,n)){i=!0;break}}if(r&&!i)for(;a<r.length;++a){var u=r[a];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,n)){i=!0;break}}}},{key:"_setDirty",value:function(e,t){var n=this._priorityDirtyFlagMap;null==n[e]?n[e]=t:n[e]=t|n[e]}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var n=e.length-1;n>=0;n--){var i=e[n];if(i._onCustomEvent===t||i.onEvent===t)return i._setRegistered(!1),null!=i._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(i._getSceneGraphPriority(),i),i._setSceneGraphPriority(null)),0===this._inDispatch?a.js.array.removeAt(e,n):this._toRemovedListeners.push(i),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var n=e.length-1;n>=0;n--){var i=e[n];if(i===t)return i._setRegistered(!1),null!=i._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(i._getSceneGraphPriority(),i),i._setSceneGraphPriority(null)),0===this._inDispatch?a.js.array.removeAt(e,n):this._toRemovedListeners.push(i),!0}return!1}}]),e}()));a.eventManager=pl;te.Flags.Destroying;var gl=new Array(16),yl=null,xl=new X,Sl=[el.TOUCH_START.toString(),el.TOUCH_MOVE.toString(),el.TOUCH_END.toString(),el.TOUCH_CANCEL.toString()],Cl=[el.MOUSE_DOWN.toString(),el.MOUSE_ENTER.toString(),el.MOUSE_MOVE.toString(),el.MOUSE_LEAVE.toString(),el.MOUSE_UP.toString(),el.MOUSE_WHEEL.toString()];function Tl(e,t){var n=this.owner;return!(!n||!n._uiProps.uiTransformComp)&&(e.getUILocation(xl),!!n._uiProps.uiTransformComp.isHit(xl,this)&&(t.type=el.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t),!0))}function El(e,t){var n=this.owner;if(!n||!n._uiProps.uiTransformComp)return!1;t.type=el.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t)}function Al(e,t){var n=this.owner;n&&n._uiProps.uiTransformComp&&(e.getUILocation(xl),n._uiProps.uiTransformComp.isHit(xl,this)?t.type=el.TOUCH_END.toString():t.type=el.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t))}function bl(e,t){var n=this.owner;n&&n._uiProps.uiTransformComp&&(t.type=el.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t))}function wl(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(xl=e.getUILocation(),t._uiProps.uiTransformComp.isHit(xl,this)&&(e.type=el.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function Il(e){var t=this.owner;if(t&&t._uiProps.uiTransformComp){if(xl=e.getUILocation(),t._uiProps.uiTransformComp.isHit(xl,this))this._previousIn||(yl&&yl.eventProcessor.mouseListener&&(e.type=el.MOUSE_LEAVE,yl.dispatchEvent(e),yl.eventProcessor.mouseListener&&(yl.eventProcessor.mouseListener._previousIn=!1)),yl=t,e.type=el.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=el.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=el.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,yl=null}e.propagationStopped=!0}}function Rl(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(xl=e.getUILocation(),t._uiProps.uiTransformComp.isHit(xl,this)&&(e.type=el.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Ol(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(xl=e.getUILocation(),t._uiProps.uiTransformComp.isHit(xl,this)&&(e.type=el.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Pl(e){var t=a.Mask;if(t)for(var n=0,i=e;i&&a.Node.isNode(i);i=i.parent,++n)if(i.getComponent(t))return{index:n,node:i};return null}function Nl(e,t){if(!e._persistNode){if(e.eventProcessor.bubblingTargets)for(var n=0;n<t.length;++n)if(e.eventProcessor.bubblingTargets.hasEventListener(t[n]))return!0;if(e.eventProcessor.capturingTargets)for(var i=0;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}return!0}var Dl,zl,Ml,Ll,Fl,kl,Ul,Bl,Gl,jl=function(){function e(t){o(this,e),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=t}return r(e,[{key:"node",get:function(){return this._node}}]),r(e,[{key:"reattach",value:function(){if(this.touchListener){var e=this.touchListener.mask=Pl(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=Pl(this._node))}},{key:"destroy",value:function(){yl===this._node&&(yl=null),(this.touchListener||this.mouseListener)&&(pl.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()}},{key:"on",value:function(e,t,n,i){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,n,i):(this.bubblingTargets||(this.bubblingTargets=new ne),this.bubblingTargets.on(e,t,n))}},{key:"once",value:function(e,t,n,i){var r,o=this;(r=this._checknSetupSysEvent(e)&&i?this.capturingTargets=this.capturingTargets||new ne:this.bubblingTargets=this.bubblingTargets||new ne).on(e,t,n,!0),r.on(e,(function(){o.off(e,t,n)}),void 0,!0)}},{key:"off",value:function(e,t,n,i){var r=-1!==Sl.indexOf(e),o=!r&&-1!==Cl.indexOf(e);r||o?(this._offDispatch(e,t,n,i),r?this.touchListener&&!Nl(this._node,Sl)&&(pl.removeListener(this.touchListener),this.touchListener=null):o&&this.mouseListener&&!Nl(this._node,Cl)&&(pl.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,n)}},{key:"emit",value:function(e,t,n,i,r,o){this.bubblingTargets&&this.bubblingTargets.emit(e,t,n,i,r,o)}},{key:"dispatchEvent",value:function(e){!function(e,t){var n,i=0;for(t.target=e,gl.length=0,e.eventProcessor.getCapturingTargets(t.type,gl),t.eventPhase=1,i=gl.length-1;i>=0;--i)if((n=gl[i]).eventProcessor.capturingTargets&&(t.currentTarget=n,n.eventProcessor.capturingTargets.emit(t.type,t,gl),t.propagationStopped))return void(gl.length=0);if(gl.length=0,t.eventPhase=2,t.currentTarget=e,e.eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,gl),t.eventPhase=3,i=0;i<gl.length;++i)if((n=gl[i]).eventProcessor.bubblingTargets&&(t.currentTarget=n,n.eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(gl.length=0);gl.length=0}(this._node,e),gl.length=0}},{key:"hasEventListener",value:function(e,t,n){var i=!1;return this.bubblingTargets&&(i=this.bubblingTargets.hasEventListener(e,t,n)),!i&&this.capturingTargets&&(i=this.capturingTargets.hasEventListener(e,t,n)),i}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e),this.touchListener&&!Nl(this.node,Sl)&&(pl.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!Nl(this.node,Cl)&&(pl.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var n=this._node.parent;n;)n.eventProcessor.capturingTargets&&n.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(n),n=n.parent}},{key:"getBubblingTargets",value:function(e,t){for(var n=this._node.parent;n;)n.eventProcessor.bubblingTargets&&n.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(n),n=n.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,n=!1,i=!1;return-1!==Sl.indexOf(e)?(this.touchListener||(this.touchListener=a.EventListener.create({event:a.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:Pl(this._node),onTouchBegan:Tl,onTouchMoved:El,onTouchEnded:Al,onTouchCancelled:bl}),pl.addListener(this.touchListener,this._node),n=!0),i=!0):-1!==Cl.indexOf(e)&&(this.mouseListener||(this.mouseListener=a.EventListener.create({event:a.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:Pl(this._node),onMouseDown:wl,onMouseMove:Il,onMouseUp:Rl,onMouseScroll:Ol}),pl.addListener(this.mouseListener,this._node),n=!0),i=!0),n&&!this._node.activeInHierarchy&&a.director.getScheduler().schedule((function(){t._node.activeInHierarchy||pl.pauseTarget(t._node)}),this._node,0,0,0,!1),i}},{key:"_onDispatch",value:function(e,t,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,t){var r=null;return(r=i?this.capturingTargets=this.capturingTargets||new ne:this.bubblingTargets=this.bubblingTargets||new ne).hasEventListener(e,t,n)||r.on(e,t,n),t}L(6800)}},{key:"_offDispatch",value:function(e,t,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,t){var r=i?this.capturingTargets:this.bubblingTargets;r&&r.off(e,t,n)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),e}();a.NodeEventProcessor=jl;var Vl=te.Flags.Destroying,Hl=te.Flags.DontDestroy,ql=te.Flags.Deactivating,Wl=(te.Flags.Activating,new z("Node"));function Xl(e){return e?"string"==typeof e?_e(e):e:(L(3804),null)}var Yl,Kl,Ql,Jl,Zl,$l,eu,tu,nu,iu,ru,ou,au,su,cu,lu,uu,_u,fu=e("cV",E("cc.BaseNode")((Gl=Bl=function(e){function t(e){var n;return o(this,t),n=l(this,u(t).call(this,e)),I(n,"_parent",Ml,M(n)),I(n,"_children",Ll,M(n)),I(n,"_active",Fl,M(n)),I(n,"_components",kl,M(n)),I(n,"_prefab",Ul,M(n)),n._scene=null,n._activeInHierarchy=!1,n._id=Wl.getNewId(),n._name=void 0,n._eventProcessor=new jl(M(n)),n._eventMask=0,n._siblingIndex=0,n._registerIfAttached=void 0,n._name=void 0!==e?e:"New Node",n}return c(t,e),r(t,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&Hl)>0},set:function(e){e?this._objFlags|=Hl:this._objFlags&=~Hl}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&a.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"_setScene",value:function(e){e instanceof a.Scene?e._scene=e:null==e._parent?ie("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===t)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null}},{key:"_findComponents",value:function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===t&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}}},{key:"_findChildComponent",value:function(e,n){for(var i=0;i<e.length;++i){var r=e[i],o=t._findComponent(r,n);if(o)return o;if(r._children.length>0&&(o=t._findChildComponent(r._children,n)))return o}return null}},{key:"_findChildComponents",value:function(e,n,i){for(var r=0;r<e.length;++r){var o=e[r];t._findComponents(o,n,i),o._children.length>0&&t._findChildComponents(o._children,n,i)}}}]),r(t,[{key:"attr",value:function(e){re(this,e)}},{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(el.PARENT_CHANGED,n),n&&!(n._objFlags&Vl)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(el.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(el.CHILD_ADDED,this)),this._onHierarchyChanged(n)}}},{key:"getChildByUuid",value:function(e){if(!e)return oe("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null}},{key:"getChildByName",value:function(e){if(!e)return oe("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null}},{key:"getChildByPath",value:function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var o=i(r);switch(o){case"continue":continue;default:if("object"===ae(o))return o.v}}return n}},{key:"addChild",value:function(e){$(e,1606),$(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&ql)L(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,n){var i=1,r=null,o=null,a=0,s=t._stacks[t._stackId];s||(s=[],t._stacks.push(s)),t._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&e?e(o):l&&n&&n(o),s[i]=null,l){if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,t._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){this._children.indexOf(e)>-1&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var n=Xl(e);return n?t._findComponent(this,n):null}},{key:"getComponents",value:function(e){var n=Xl(e),i=[];return n&&t._findComponents(this,n,i),i}},{key:"getComponentInChildren",value:function(e){var n=Xl(e);return n?t._findChildComponent(this._children,n):null}},{key:"getComponentsInChildren",value:function(e){var n=Xl(e),i=[];return n&&(t._findComponents(this,n,i),t._findChildComponents(this._children,n,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=_e(e)))throw a._RF.peek()&&L(3808,e),TypeError(se(3807,e))}else{if(!e)throw TypeError(se(3804));t=e}if("function"!=typeof t)throw TypeError(se(3809));if(!ce(t,a.Component))throw TypeError(se(3810));var n=t._requireComponent;n&&!this.getComponent(n)&&this.addComponent(n);var i=new t;return i.node=this,this._components.push(i),this._activeInHierarchy&&a.director._nodeActivator.activateComp(i),i}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof le?e:this.getComponent(e))&&t.destroy()}else L(3813)}},{key:"on",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(e){case el.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)}},{key:"off",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this._eventProcessor.off(e,t,n,i);var r=this._eventProcessor.hasEventListener(e);if(!r)switch(e){case el.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,n,i){this._eventProcessor.once(e,t,n,i)}},{key:"emit",value:function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(el.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"destroy",value:function(){return!!P(u(t.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&Vl)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&L(3815)}}else L(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk((function(e){t._setScene(e)})))}},{key:"_onPostActivated",value:function(e){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e||(e=a.instantiate._clone(this,this));var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof a.Scene||a.game.removePersistRootNode(this);var n=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==n&&a.director._nodeActivator.activateNode(this,n)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=Vl;var e=this._parent,t=!!e&&0!=(e._objFlags&Vl);if(!t&&ue&&this._registerIfAttached(!1),this._persistNode&&a.game.removePersistRootNode(this),!t&&e){this.emit(el.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e.emit&&e.emit(el.CHILD_REMOVED,this)}this.emit(el.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var o=this._components,s=0;s<o.length;++s)o[s]._destroyImmediate();return t}},{key:"_disableChildComps",value:function(){for(var e=this._components,t=0;t<e.length;++t){var n=e[t];n._enabled&&a.director._compScheduler.disableComp(n)}for(var i=this._children,r=0;r<i.length;++r){var o=i[r];o._active&&o._disableChildComps()}}}]),t}(te),Bl.idGenerator=Wl,Bl._stacks=[[]],Bl._stackId=0,A((zl=Gl).prototype,"_persistNode",[i],Object.getOwnPropertyDescriptor(zl.prototype,"_persistNode"),zl.prototype),A(zl.prototype,"name",[w],Object.getOwnPropertyDescriptor(zl.prototype,"name"),zl.prototype),A(zl.prototype,"children",[w],Object.getOwnPropertyDescriptor(zl.prototype,"children"),zl.prototype),A(zl.prototype,"active",[w],Object.getOwnPropertyDescriptor(zl.prototype,"active"),zl.prototype),A(zl.prototype,"activeInHierarchy",[w],Object.getOwnPropertyDescriptor(zl.prototype,"activeInHierarchy"),zl.prototype),A(zl.prototype,"parent",[w],Object.getOwnPropertyDescriptor(zl.prototype,"parent"),zl.prototype),Ml=A(zl.prototype,"_parent",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ll=A(zl.prototype,"_children",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fl=A(zl.prototype,"_active",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kl=A(zl.prototype,"_components",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ul=A(zl.prototype,"_prefab",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Dl=zl))||Dl);a._BaseNode=fu,function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(Yl||(Yl={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(Kl||(Kl=e("dR",{}))),a.internal.TransformBit=Kl;var hu,du,vu,mu,pu,gu,yu,xu,Su,Cu,Tu,Eu,Au,bu,wu,Iu,Ru,Ou=new X,Pu=new X,Nu=new f,Du=new f,zu=new f,Mu=new f(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),Lu=new Y,Fu=e("db",(Ql=E("cc.UITransform"),Jl=he(),Zl=ht(110),$l=de(),eu=ve(),tu=me(),nu=ve(),iu=me(),ru=me(),Ql(ou=Jl(ou=Zl(ou=$l(ou=fe((_u=uu=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"_priority",su,M(n)),n._canvas=null,I(n,"_contentSize",cu,M(n)),I(n,"_anchorPoint",lu,M(n)),n}return c(t,e),r(t,[{key:"__preload",value:function(){this.node._uiProps.uiTransformComp=this}},{key:"onEnable",value:function(){this._updateVisibility(),this.node.on(el.PARENT_CHANGED,this._parentChanged,this),this._sortSiblings()}},{key:"onDisable",value:function(){this.node.off(el.PARENT_CHANGED,this._parentChanged,this),this._canvas=null}},{key:"onDestroy",value:function(){this.node._uiProps.uiTransformComp=null}},{key:"setContentSize",value:function(e,t){var n=this._contentSize;if(void 0===t){if((e=e).width===n.width&&e.height===n.height)return;n.width=e.width,n.height=e.height}else{if(e===n.width&&t===n.height)return;n.width=e,n.height=t}this.node.emit(el.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(el.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var n=this._contentSize.width,i=this._contentSize.height,r=Ou,o=Pu,s=this._canvas;if(s){s.node.getWorldRT(Nu);var c=Nu.m12,l=Nu.m13,u=a.visibleRect.center;if(Nu.m12=u.x-(Nu.m00*c+Nu.m04*l),Nu.m13=u.y-(Nu.m01*c+Nu.m05*l),f.invert(Nu,Nu),X.transformMat4(r,e,Nu),this.node.getWorldMatrix(zu),f.invert(Nu,zu),f.strictEquals(Nu,Mu))return!1;if(X.transformMat4(o,r,Nu),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i,o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i){if(t&&t.mask){for(var _=t.mask,h=this.node,d=0;h&&d<_.index;++d,h=h.parent);if(h===_.node){var v=h.getComponent(a.Mask);return!v||!v.enabledInHierarchy||v.isHit(r)}return t.mask=null,!0}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(zu),f.invert(Nu,zu),t||(t=new s),s.transformMat4(t,e,Nu)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(zu),t||(t=new s),s.transformMat4(t,e,zu)}},{key:"getBoundingBox",value:function(){f.fromRTS(Du,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new Y(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(Du),n}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(zu),this.getBoundingBoxTo(zu)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){f.fromRTS(Du,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new Y(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(f.multiply(zu,e,Du),r.transformMat4(zu),!this.node.children)return r;for(var o,a=this.node.children,s=N(a);!(o=s()).done;){var c=o.value;if(c&&c.active){var l=c.getComponent(t);if(l){var u=l.getBoundingBoxTo(e);u&&Y.union(r,r,u)}}}return r}},{key:"getComputeAABB",value:function(e){var t=this._contentSize.width,n=this._contentSize.height;Lu.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),Lu.transformMat4(this.node.worldMatrix);var i=Lu.x+.5*Lu.width,r=Lu.y+.5*Lu.height,o=this.node.worldPosition.z,a=Lu.width/2,s=Lu.height/2;if(null==e)return new Br(i,r,o,a,s,.001);Br.set(e,i,r,o,a,s,.001)}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent("cc.Canvas");if(t){this._canvas=t;break}}e=e.parent}}},{key:"_parentChanged",value:function(e){this._canvas&&this._canvas.node===this.node||this._sortSiblings()}},{key:"_sortSiblings",value:function(){var e=this.node.parent&&this.node.parent.children;e&&(e.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n.priority:0)-(i?i.priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r})),this.node.parent._updateSiblingIndex())}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(el.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(el.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(el.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(el.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(el.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(el.ANCHOR_CHANGED,this._anchorPoint))}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._canvas&&this._canvas.node===this.node?G(9200):(this._priority=e,this._sortSiblings()))}},{key:"visibility",get:function(){return this._canvas?this._canvas.visibility:-1}}]),t}(le),uu.EventType=el,A((au=_u).prototype,"contentSize",[eu,tu],Object.getOwnPropertyDescriptor(au.prototype,"contentSize"),au.prototype),A(au.prototype,"anchorPoint",[nu,iu],Object.getOwnPropertyDescriptor(au.prototype,"anchorPoint"),au.prototype),A(au.prototype,"priority",[ru],Object.getOwnPropertyDescriptor(au.prototype,"priority"),au.prototype),su=A(au.prototype,"_priority",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cu=A(au.prototype,"_contentSize",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K(100,100)}}),lu=A(au.prototype,"_anchorPoint",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new X(.5,.5)}}),ou=au))||ou)||ou)||ou)||ou)||ou)),ku=function(){function e(t){o(this,e),this.uiComp=null,this.opacity=1,this._uiTransformComp=null,this._node=void 0,this._node=t}return r(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent(Fu)),this._uiTransformComp},set:function(e){this._uiTransformComp=e}}]),e}(),Uu=new s,Bu=new W,Gu=new W,ju=new Array(10),Vu=new W,Hu=new h,qu=new h,Wu=new f,Xu=new Map,Yu=e("cW",(hu=E("cc.Node"),du=F(s),hu((Tu=Cu=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r))))._uiProps=new ku(M(n)),n._static=!1,n._pos=new s,n._rot=new W,n._scale=new s(1,1,1),n._mat=new f,I(n,"_lpos",pu,M(n)),I(n,"_lrot",gu,M(n)),I(n,"_lscale",yu,M(n)),I(n,"_layer",xu,M(n)),I(n,"_euler",Su,M(n)),n._dirtyFlags=Kl.NONE,n._eulerDirty=!1,n}return c(t,e),r(t,[{key:"setParent",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n&&this.updateWorldTransform(),P(u(t.prototype),"setParent",this).call(this,e,n)}},{key:"_onSetParent",value:function(e,n){if(P(u(t.prototype),"_onSetParent",this).call(this,e,n),n){var i=this._parent;i?(i.updateWorldTransform(),f.multiply(Wu,f.invert(Wu,i._mat),this._mat),f.toRTS(Wu,this._lrot,this._lpos,this._lscale)):(s.copy(this._lpos,this._pos),W.copy(this._lrot,this._rot),s.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Kl.TRS)}},{key:"_onBatchCreated",value:function(){P(u(t.prototype),"_onBatchCreated",this).call(this),Xu.set(this._id,Kl.TRS),this._dirtyFlags=Kl.TRS;for(var e=this._children.length,n=0;n<e;++n)this._children[n]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"_onPostActivated",value:function(e){e?(pl.resumeTarget(this),this.eventProcessor.reattach(),this.invalidateChildren(Kl.TRS)):pl.pauseTarget(this)}},{key:"translate",value:function(e,t){var n=t||Yl.LOCAL;if(n===Yl.LOCAL)s.transformQuat(Uu,e,this._lrot),this._lpos.x+=Uu.x,this._lpos.y+=Uu.y,this._lpos.z+=Uu.z;else if(n===Yl.WORLD)if(this._parent){W.invert(Bu,this._parent.worldRotation),s.transformQuat(Uu,e,Bu);var i=this.worldScale;this._lpos.x+=Uu.x/i.x,this._lpos.y+=Uu.y/i.y,this._lpos.z+=Uu.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(Kl.POSITION),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.POSITION)}},{key:"rotate",value:function(e,t){var n=t||Yl.LOCAL;if(W.normalize(Bu,e),n===Yl.LOCAL)W.multiply(this._lrot,this._lrot,Bu);else if(n===Yl.WORLD){var i=this.worldRotation;W.multiply(Gu,Bu,i),W.invert(Bu,i),W.multiply(Gu,Bu,Gu),W.multiply(this._lrot,this._lrot,Gu)}this._eulerDirty=!0,this.invalidateChildren(Kl.ROTATION),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.ROTATION)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(Uu),s.subtract(Uu,Uu,e),s.normalize(Uu,Uu),W.fromViewUp(Bu,Uu,t),this.setWorldRotation(Bu)}},{key:"invalidateChildren",value:function(e){if((this._dirtyFlags&this.hasChangedFlags&e)!==e){this._dirtyFlags|=e,Xu.set(this._id,this.hasChangedFlags|e),e|=Kl.POSITION;for(var t=this._children.length,n=0;n<t;++n){var i=this._children[n];i.isValid&&i.invalidateChildren(e)}}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)ju[n++]=t,t=t._parent;for(var i=0;n;)i|=(e=ju[--n])._dirtyFlags,t?(i&Kl.POSITION&&(s.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&Kl.RS&&(f.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),f.multiply(e._mat,t._mat,e._mat),i&Kl.ROTATION&&W.multiply(e._rot,t._rot,e._lrot),h.fromQuat(Hu,W.conjugate(Vu,e._rot)),h.multiplyMat4(Hu,Hu,e._mat),e._scale.x=Hu.m00,e._scale.y=Hu.m04,e._scale.z=Hu.m08)):(i&Kl.POSITION&&(s.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&Kl.RS&&(i&Kl.ROTATION&&W.copy(e._rot,e._lrot),i&Kl.SCALE&&s.copy(e._scale,e._lscale),f.fromRTS(e._mat,e._rot,e._pos,e._scale))),e._dirtyFlags=Kl.NONE,t=e}}},{key:"setPosition",value:function(e,t,n){void 0===t||void 0===n?s.copy(this._lpos,e):s.set(this._lpos,e,t,n),this.invalidateChildren(Kl.POSITION),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.POSITION)}},{key:"getPosition",value:function(e){return e?s.set(e,this._lpos.x,this._lpos.y,this._lpos.z):s.copy(new s,this._lpos)}},{key:"setRotation",value:function(e,t,n,i){void 0===t||void 0===n||void 0===i?W.copy(this._lrot,e):W.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(Kl.ROTATION),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.ROTATION)}},{key:"setRotationFromEuler",value:function(e,t,n){s.set(this._euler,e,t,n),W.fromEuler(this._lrot,e,t,n),this._eulerDirty=!1,this.invalidateChildren(Kl.ROTATION),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.ROTATION)}},{key:"getRotation",value:function(e){return e?W.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):W.copy(new W,this._lrot)}},{key:"setScale",value:function(e,t,n){void 0===t||void 0===n?s.copy(this._lscale,e):s.set(this._lscale,e,t,n),this.invalidateChildren(Kl.SCALE),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.SCALE)}},{key:"getScale",value:function(e){return e?s.set(e,this._lscale.x,this._lscale.y,this._lscale.z):s.copy(new s,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){s.copy(e,t);for(var n=this,i=0;n._parent;)ju[i++]=n,n=n._parent;for(;i>=0;)s.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=ju[--i];return e}},{key:"setWorldPosition",value:function(e,t,n){void 0===t||void 0===n?s.copy(this._pos,e):s.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),s.transformMat4(r,this._pos,f.invert(Wu,i._mat))):s.copy(r,this._pos),this.invalidateChildren(Kl.POSITION),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.POSITION)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?s.copy(e,this._pos):s.copy(new s,this._pos)}},{key:"setWorldRotation",value:function(e,t,n,i){void 0===t||void 0===n||void 0===i?W.copy(this._rot,e):W.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),W.multiply(this._lrot,W.conjugate(this._lrot,this._parent._rot),this._rot)):W.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Kl.ROTATION),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.ROTATION)}},{key:"setWorldRotationFromEuler",value:function(e,t,n){W.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),W.multiply(this._lrot,W.conjugate(this._lrot,this._parent._rot),this._rot)):W.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Kl.ROTATION),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.ROTATION)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?W.copy(e,this._rot):W.copy(new W,this._rot)}},{key:"setWorldScale",value:function(e,t,n){void 0===t||void 0===n?s.copy(this._scale,e):s.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),h.fromQuat(Hu,W.conjugate(Vu,i._rot)),h.multiplyMat4(Hu,Hu,i._mat),qu.m00=this._scale.x,qu.m04=this._scale.y,qu.m08=this._scale.z,h.multiply(Hu,qu,h.invert(Hu,Hu)),this._lscale.x=s.set(Uu,Hu.m00,Hu.m01,Hu.m02).length(),this._lscale.y=s.set(Uu,Hu.m03,Hu.m04,Hu.m05).length(),this._lscale.z=s.set(Uu,Hu.m06,Hu.m07,Hu.m08).length()):s.copy(this._lscale,this._scale),this.invalidateChildren(Kl.SCALE),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.SCALE)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?s.copy(e,this._scale):s.copy(new s,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransform(),e||(e=new f),f.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransform(),e||(e=new f),f.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e||(e=new f),f.fromRT(e,this._rot,this._pos)}},{key:"setRTS",value:function(e,t,n){var i=0;e&&(i|=Kl.ROTATION,void 0!==e.w?(W.copy(this._lrot,e),this._eulerDirty=!0):(s.copy(this._euler,e),W.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(s.copy(this._lpos,t),i|=Kl.POSITION),n&&(s.copy(this._lscale,n),i|=Kl.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,i))}},{key:"pauseSystemEvents",value:function(e){pl.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){pl.resumeTarget(this,e)}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(W.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){f.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Kl.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(el.TRANSFORM_CHANGED,Kl.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return s.transformQuat(new s,s.FORWARD,this.worldRotation)},set:function(e){var t=e.length();s.multiplyScalar(Uu,e,-1/t),W.fromViewUp(Bu,Uu),this.setWorldRotation(Bu)}},{key:"layer",set:function(e){this._layer=e},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return Xu.get(this._id)||0},set:function(e){Xu.set(this._id,e)}}],[{key:"isNode",value:function(e){return e instanceof t&&(e.constructor===t||!(e instanceof a.Scene))}}]),t}(fu),Cu.bookOfChange=Xu,Cu.EventType=el,Cu.NodeSpace=Yl,Cu.TransformDirtyBit=Kl,Cu.TransformBit=Kl,pu=A((mu=Tu).prototype,"_lpos",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s}}),gu=A(mu.prototype,"_lrot",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new W}}),yu=A(mu.prototype,"_lscale",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s(1,1,1)}}),xu=A(mu.prototype,"_layer",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ua.Enum.DEFAULT}}),Su=A(mu.prototype,"_euler",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s}}),A(mu.prototype,"eulerAngles",[du],Object.getOwnPropertyDescriptor(mu.prototype,"eulerAngles"),mu.prototype),A(mu.prototype,"layer",[w],Object.getOwnPropertyDescriptor(mu.prototype,"layer"),mu.prototype),vu=mu))||vu));function Ku(e){return"string"==typeof e||"number"==typeof e}function Qu(e,t){return e instanceof t}a.Node=Yu;var Ju=e("ax",E("cc.animation.HierarchyPath")((bu=A((Au=function(){function e(t){o(this,e),I(this,"path",bu,this),this.path=t||""}return r(e,[{key:"get",value:function(e){if(!(e instanceof Yu))return j("Target of hierarchy path should be of type Node."),null;var t=e.getChildByPath(this.path);return t||(j('Node "'.concat(e.name,'" has no path "').concat(this.path,'"')),null)}}]),e}()).prototype,"path",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Eu=Au))||Eu);e("ay",E("cc.animation.ComponentPath")((Ru=A((Iu=function(){function e(t){o(this,e),I(this,"component",Ru,this),this.component=t||""}return r(e,[{key:"get",value:function(e){if(!(e instanceof Yu))return j("Target of component path should be of type Node."),null;var t=e.getComponent(this.component);return t||(j('Node "'.concat(e.name,'" has no component "').concat(this.component,'"')),null)}}]),e}()).prototype,"component",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wu=Iu))||wu);var Zu=e("d4",function(){function e(){o(this,e)}return r(e,null,[{key:"getOrExtract",value:function(t){var n=e.pool.get(t);return n&&n.info.sample===t.sample||(n&&a.director.root.dataPoolManager.releaseAnimationClip(t),n=function(e){var t={};e.curves.forEach((function(e){if(!e.valueAdapter&&Qu(e.modifiers[0],Ju)&&Ku(e.modifiers[1])){var n=e.modifiers[0].path,i=t[n];i||(i=t[n]={}),i[e.modifiers[1]]={values:e.data.values,keys:e.data.keys}}}));for(var n=Math.ceil(e.sample*e.duration)+1,i=function(){var i=o[r],a=t[i];if(!a)return"continue";Object.defineProperty(a,"worldMatrix",{get:function(){if(!a._worldMatrix){var r=a.position,o=a.rotation,s=a.scale;$u(e,r,n),$u(e,o,n),$u(e,s,n),function(e,t,n){var i=n.position.values,r=n.rotation.values,o=n.scale.values,a=i.map((function(){return new f})),s=t.lastIndexOf("/"),c=null;if(s>0){var l=t.substring(0,s),u=e[l];if(!u)return void console.warn("no data for parent bone?");c=u.worldMatrix.values}for(var _=0;_<i.length;_++){var h=i[_],d=r[_],v=o[_],m=a[_];f.fromRTS(m,d,h,v),c&&f.multiply(m,c[_],m)}Object.keys(n).forEach((function(e){return delete n[e]})),n._worldMatrix={keys:0,interpolate:!1,values:a}}(t,i,a)}return a._worldMatrix}})},r=0,o=Object.keys(t);r<o.length;r++)i();return{info:{frames:n,sample:e.sample},data:t}}(t),e.pool.set(t,n)),n}},{key:"destroy",value:function(t){e.pool.delete(t)}}]),e}());function $u(e,t,n){var i=e.keys[t.keys],r=[];if(i&&1!==i.length)for(var o=t.values[0]instanceof W,a=0,s=0;a<n;a++){for(var c=a/e.sample;i[s]<=c;)s++;s>i.length-1?c=i[s=i.length-1]:0===s&&(s=1);var l=t.values[s-1].clone(),u=i[s]-i[s-1],_=u?pe((c-i[s-1])/u):1;o?l.slerp(t.values[s],_):l.lerp(t.values[s],_),r[a]=l}else for(var f=0;f<n;f++)r[f]=t.values[0].clone();t.values=r}Zu.pool=new Map;var e_=new f;function t_(e,t,n){for(f.identity(n);e!==t;)f.fromRTS(e_,e.rotation,e.position,e.scale),f.multiply(n,e_,n),e=e.parent;return n}var n_=e("u",(function(e,t,n,i){e[t+0]=n.m00,e[t+1]=n.m01,e[t+2]=n.m02,e[t+3]=n.m12,e[t+4]=n.m04,e[t+5]=n.m05,e[t+6]=n.m06,e[t+7]=n.m13,e[t+8]=n.m08,e[t+9]=n.m09,e[t+10]=n.m10,e[t+11]=n.m14})),i_=e("M",480);function r_(e){return e.hasFeature(ti.TEXTURE_FLOAT)?on.RGBA32F:on.RGBA8}new W,new W,new s,new W,new s;function o_(e,t){var n=4/Math.sqrt(t);return 12*Math.ceil(Math.max(i_*n,e)/12)}e("l",Lo([yn.POINT,yn.POINT,yn.NONE,xn.CLAMP,xn.CLAMP,xn.CLAMP]));var a_=new s,s_=new s,c_=new s,l_=new s,u_=new f,__=new f,f_=new Br,h_=Number.MAX_SAFE_INTEGER,d_=(e("J",function(){function e(t){o(this,e),this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var n=r_(this._device);this._formatSize=Yn[n].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new Fc(t),this._pool.initialize({format:n,roundUpFn:o_}),this._customPool=new Fc(t),this._customPool.initialize({format:n,roundUpFn:o_})}return r(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),r(e,[{key:"clear",value:function(){this._pool.destroy(),this._textureBuffers.clear()}},{key:"registerCustomTextureLayouts",value:function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}}},{key:"getDefaultPoseTexture",value:function(e,t,n){var i=0^e.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var o=e.joints,a=e.bindposes,c=null,l=!1,u=o.length;if(r)r.refCount++;else{var _=12*u,h=this._chunkIdxMap.get(i),d=void 0!==h?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!d)return r;r={pixelOffset:d.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:d},c=new Float32Array(_),l=!0}s.set(c_,h_,h_,h_),s.set(l_,-h_,-h_,-h_);for(var v=t.getBoneSpaceBounds(e),m=0,p=0;m<u;m++,p+=12){var g=n.getChildByPath(o[m]),y=g?t_(g,n,u_):e.inverseBindposes[m],x=v[m];x&&(Br.transform(f_,x,y),f_.getBoundary(a_,s_),s.min(c_,c_,a_),s.max(l_,l_,s_)),l&&(g&&f.multiply(y,y,a[m]),n_(c,p,g?y:f.IDENTITY))}var S=[new Br];return r.bounds.set(t.hash,S),Br.fromPoints(S[0],c_,l_),l&&(this._pool.update(r.handle,c.buffer),this._textureBuffers.set(i,r)),r}},{key:"getSequencePoseTexture",value:function(e,t,n,i){var r=e.hash^t.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=e.joints,c=e.bindposes,l=Zu.getOrExtract(t).info.frames,u=null,_=!1,h=a.length;if(o)o.refCount++;else{var d=12*h*l,v=this._chunkIdxMap.get(r),m=void 0!==v?this._customPool.alloc(d*Float32Array.BYTES_PER_ELEMENT,v):this._pool.alloc(d*Float32Array.BYTES_PER_ELEMENT);if(!m)return null;var p=this._createAnimInfos(e,t,i);o={pixelOffset:m.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:m,animInfos:p},u=new Float32Array(d),_=!0}var g=n.getBoneSpaceBounds(e),y=[];o.bounds.set(n.hash,y);for(var x=0;x<l;x++)y.push(new Br(h_,h_,h_,-h_,-h_,-h_));for(var S=0,C=0;S<l;S++){for(var T=y[S],E=0;E<h;E++,C+=12){var A=o.animInfos[E],b=A.curveData,w=A.downstream,I=A.bindposeIdx,R=A.bindposeCorrection,O=void 0,P=!0;b&&w?O=f.multiply(u_,b[S],w):b?O=b[S]:w?O=w:(O=e.inverseBindposes[I],P=!1);var N=g[E];if(N){var D=R?f.multiply(__,O,R):O;Br.transform(f_,N,D),f_.getBoundary(a_,s_),s.min(T.center,T.center,a_),s.max(T.halfExtents,T.halfExtents,s_)}_&&(P&&f.multiply(u_,O,c[I]),n_(u,C,P?u_:f.IDENTITY))}Br.fromPoints(T,T.center,T.halfExtents)}return _&&(this._pool.update(o.handle,u.buffer),this._textureBuffers.set(r,o)),o}},{key:"releaseHandle",value:function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}}},{key:"releaseSkeleton",value:function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.skeletonHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}}},{key:"releaseAnimationClip",value:function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.clipHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}}},{key:"_createAnimInfos",value:function(e,t,n){for(var i=[],r=e.joints,o=e.bindposes,a=r.length,s=Zu.getOrExtract(t),c=0;c<a;c++){for(var l=r[c],u=s.data[l],_=n.getChildByPath(l),h=void 0,d=void 0;!u;){var v=l.lastIndexOf("/");if(l=l.substring(0,v),u=s.data[l],_?(h||(h=new f),f.fromRTS(u_,_.rotation,_.position,_.scale),f.multiply(h,u_,h),_=_.parent):d=l,v<0)break}var m=c,p=void 0;if(void 0!==d&&u){m=c-1;for(var g=0;g<a;g++)if(r[g]===d){m=g,p=new f,f.multiply(p,o[g],e.inverseBindposes[c]);break}}i.push({curveData:u&&u.worldMatrix.values,downstream:h,bindposeIdx:m,bindposeCorrection:p})}return i}}]),e}()),e("n",function(){function e(t){o(this,e),this._pool=new Map,this._device=void 0,this._device=t}return r(e,[{key:"getData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"-1",t=this._pool.get(e);if(t)return t;var n=this._device.createBuffer({usage:an.UNIFORM|an.TRANSFER_DST,memUsage:sn.HOST|sn.DEVICE,size:Na.SIZE,stride:Na.SIZE}),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1};return this._pool.set(e,r),r}},{key:"destroy",value:function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))}},{key:"switchClip",value:function(e,t){return e.data[0]=0,e.buffer.update(e.data),e.dirty=!1,e}},{key:"clear",value:function(){for(var e,t=N(this._pool.values());!(e=t()).done;){e.value.buffer.destroy()}this._pool.clear()}}]),e}()),{layout:null}),v_=e("a2",function(){function e(){o(this,e),this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=Ks,this._priority=fa.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}return r(e,[{key:"initialize",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._device=a.director.root.device,this._subMesh=e,this._patches=n,this._passes=t,this._handle=oc.alloc(),this._flushPassInfo(),d_.layout=t[0].setLayouts[ya.LOCAL];var i=ec.alloc(this._device,d_),r=tc.alloc(this._device,e);oc.set(this._handle,ic.PRIORITY,fa.DEFAULT),oc.set(this._handle,ic.INPUT_ASSEMBLER,r),oc.set(this._handle,ic.DESCRIPTOR_SET,i),this._inputAssembler=tc.get(r),this._descriptorSet=ec.get(i)}},{key:"destroy",value:function(){ec.free(oc.get(this._handle,ic.DESCRIPTOR_SET)),tc.free(oc.get(this._handle,ic.INPUT_ASSEMBLER)),oc.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=fa.DEFAULT,this._handle=Ks,this._patches=null,this._subMesh=null,this._passes=null}},{key:"update",value:function(){for(var e=0;e<this._passes.length;++e){this._passes[e].update()}this._descriptorSet.update()}},{key:"onPipelineStateChanged",value:function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}}},{key:"onMacroPatchesStateChanged",value:function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}},{key:"_flushPassInfo",value:function(){var e=this._passes;if(e){oc.set(this._handle,ic.PASS_COUNT,e.length);for(var t=0;t<e.length;t++)oc.set(this._handle,ic.PASS_0+t,e[t].handle),oc.set(this._handle,ic.SHADER_0+t,e[t].getShaderVariant(this._patches))}}},{key:"passes",set:function(e){this._passes=e,this._flushPassInfo()},get:function(){return this._passes}},{key:"subMesh",set:function(e){this._subMesh=e,this._inputAssembler.destroy(),this._inputAssembler.initialize(e)},get:function(){return this._subMesh}},{key:"priority",set:function(e){this._priority=e,oc.set(this._handle,ic.PRIORITY,e)},get:function(){return this._priority}},{key:"handle",get:function(){return this._handle}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}()),m_=function(){function e(t){o(this,e),this.instances=[],this.hPass=Ks,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.hPass=t.handle}return r(e,null,[{key:"get",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e._buffers;i.has(t)||i.set(t,{});var r=i.get(t);return r[n]||(r[n]=new e(t))}}]),r(e,[{key:"destroy",value:function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0}},{key:"merge",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=t.buffer.length;if(r){for(var o=e.inputAssembler,a=e.descriptorSet.getTexture(Ba.binding),s=i||oc.get(e.handle,ic.SHADER_0+n),c=oc.get(e.handle,ic.DESCRIPTOR_SET),l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a){if(u.stride!==r)return;if(u.count>=u.capacity){u.capacity<<=1;var _=u.stride*u.capacity,f=u.data;u.data=new Uint8Array(_),u.data.set(f),u.vb.resize(_)}return u.hShader!==s&&(u.hShader=s),u.hDescriptorSet!==c&&(u.hDescriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var h=this._device.createBuffer({usage:an.VERTEX|an.TRANSFER_DST,memUsage:sn.HOST|sn.DEVICE,size:32*r,stride:r}),d=new Uint8Array(32*r),v=o.vertexBuffers.slice(),m=o.attributes.slice(),p=o.indexBuffer||void 0,g=0;g<t.list.length;g++){var y=t.list[g],x={name:y.name,format:y.format,stream:v.length,isInstanced:!0};void 0!==y.isNormalized&&(x.isNormalized=y.isNormalized),m.push(x)}d.set(t.buffer),v.push(h);var S=this._device.createInputAssembler({attributes:m,vertexBuffers:v,indexBuffer:p});this.instances.push({count:1,capacity:32,vb:h,data:d,ia:S,stride:r,hShader:s,hDescriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}}},{key:"uploadBuffers",value:function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.count&&(t.ia.instanceCount=t.count,t.vb.update(t.data))}}},{key:"clear",value:function(){for(var e=0;e<this.instances.length;++e){this.instances[e].count=0}this.hasPendingModels=!1}}]),e}();m_._buffers=new Map;var p_,g_=new f,y_=new ge((function(){return new v_}),32),x_=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.UI_BATCH=3]="UI_BATCH",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(p_||(p_=e("U",{})));var S_=Lo([yn.LINEAR,yn.LINEAR,yn.NONE,xn.CLAMP,xn.CLAMP,xn.CLAMP]),C_=Lo([yn.LINEAR,yn.LINEAR,yn.LINEAR,xn.CLAMP,xn.CLAMP,xn.CLAMP]),T_=e("W",function(){function e(){o(this,e),this.type=p_.DEFAULT,this.scene=null,this.node=null,this.transform=null,this.enabled=!0,this.visFlags=ua.Enum.NONE,this.castShadow=!1,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,list:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._localData=new Float32Array(Ia.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new v,this._receiveShadow=!0,this._device=a.director.root.device}return r(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e,this.onMacroPatchesStateChanged()}}]),r(e,[{key:"initialize",value:function(e){this.transform=this.node=e}},{key:"destroy",value:function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];n.destroy(),y_.free(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this.isDynamicBatching=!1}},{key:"attachToScene",value:function(e){this.scene=e}},{key:"detachFromScene",value:function(){this.scene=null}},{key:"updateTransform",value:function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0,this._modelBounds&&this._worldBounds&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds))}},{key:"updateUBOs",value:function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._transformUpdated){this._transformUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.list;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,o[r].view,o[r+1].view,o[r+2].view)}else f.toArray(this._localData,i,Ia.MAT_WORLD_OFFSET),f.inverseTranspose(g_,i),f.toArray(this._localData,g_,Ia.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData)}}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=Br.fromPoints(Br.create(),e,t),this._worldBounds=Br.clone(this._modelBounds))}},{key:"initSubModel",value:function(e,t,n){null==this._subModels[e]?this._subModels[e]=y_.alloc():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._updateAttributesAndBinding(e),this._inited=!0}},{key:"setSubModelMesh",value:function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)}},{key:"setSubModelMaterial",value:function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()}},{key:"onMacroPatchesStateChanged",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))}},{key:"updateLightingmap",value:function(e,t){v.toArray(this._localData,t,Ia.LIGHTINGMAP_UVPARAM),this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=js.get("empty-texture"));var n=e.getGFXTexture();if(null!==n)for(var i=Ko.getSampler(this._device,e.mipmaps.length>1?C_:S_),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(Ba.binding,n),a.bindSampler(Ba.binding,i),a.update()}}},{key:"getMacroPatches",value:function(e){return this.receiveShadow?x_:null}},{key:"_updateAttributesAndBinding",value:function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet);var n=$s.get(oc.get(t.handle,ic.SHADER_0));this._updateInstancedAttributes(n.attributes,t.passes[0])}}},{key:"_getInstancedAttributeIndex",value:function(e){for(var t=this.instancedAttributes.list,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1}},{key:"_updateInstancedAttributes",value:function(e,t){if(t.device.hasFeature(ti.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=Yn[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.list.length=0;for(var a=0,s=o.buffer.buffer,c=0;c<e.length;c++){var l=e[c];if(l.isInstanced){var u=l.format,_=Yn[u],f=new($n(_))(s,a,_.count),h=l.isNormalized;a+=_.size,o.list.push({name:l.name,format:u,isNormalized:h,view:f})}}t.batchingScheme===dc.INSTANCING&&m_.get(t).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex("a_matWorld0"),this._transformUpdated=!0}}},{key:"_initLocalDescriptors",value:function(e){this._localBuffer||(this._localBuffer=this._device.createBuffer({usage:an.UNIFORM|an.TRANSFER_DST,memUsage:sn.HOST|sn.DEVICE,size:Ia.SIZE,stride:Ia.SIZE}))}},{key:"_updateLocalDescriptors",value:function(e,t){t.bindBuffer(Ia.BLOCK.binding,this._localBuffer)}}]),e}()),E_=e("r",function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r))))._morphRenderingInstance=null,n._usedMaterials=new Set,n}return c(t,e),r(t,[{key:"getMacroPatches",value:function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):void 0}},{key:"initSubModel",value:function(e,n,i){return P(u(t.prototype),"initSubModel",this).call(this,e,n,this._launderMaterial(i))}},{key:"setSubModelMaterial",value:function(e,n){return P(u(t.prototype),"setSubModelMaterial",this).call(this,e,this._launderMaterial(n))}},{key:"_updateLocalDescriptors",value:function(e,n){P(u(t.prototype),"_updateLocalDescriptors",this).call(this,e,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,n)}},{key:"_launderMaterial",value:function(e){return e}},{key:"setMorphRendering",value:function(e){this._morphRenderingInstance=e}}]),t}(T_)),A_=[],b_=new Map,w_=[{name:"CC_USE_SKINNING",value:!0}];function I_(e,t){for(var n=0,i=f.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,A_[n++]=e,e=e.parent}for(;n>0;){var r=(e=A_[--n]).node;f.fromRTS(e.local,r.rotation,r.position,r.scale),i=f.multiply(e.world,i,e.local)}return i}function R_(e,t){for(var n,i=null,r=0;e!==t;){var o=e.uuid;if(b_.has(o)){i=b_.get(o);break}i={node:e,local:new f,world:new f,stamp:-1,parent:null},b_.set(o,i),A_[r++]=i,e=e.parent,i=null}for(;r>0;)(n=A_[--r]).parent=i,i=n;return i}function O_(e){for(var t=b_.get(e.uuid)||null;t;)b_.delete(t.node.uuid),t=t.parent}function P_(e,t,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(t.push(r),e.push(a))}}var N_,D_,z_,M_,L_,F_=new s,k_=new s,U_=new s,B_=new s,G_=new f,j_=new Br,V_=(e("S",function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this))).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=p_.SKINNING,e}return c(t,e),r(t,[{key:"destroy",value:function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}P(u(t.prototype),"destroy",this).call(this)}},{key:"bindSkeleton",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=0;i<this._joints.length;i++)O_(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&n){this.transform=t;var r=n.getBoneSpaceBounds(e),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<e.joints.length;a++){var s=r[a],c=t.getChildByPath(e.joints[a]);if(s&&c){var l=R_(c,t),u=e.bindposes[a],_=[],f=[];o?P_(_,f,o,a):(_.push(a),f.push(0)),this._joints.push({indices:_,buffers:f,bound:s,target:c,bindpose:u,transform:l})}}}}},{key:"updateTransform",value:function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0),s.set(F_,1/0,1/0,1/0),s.set(k_,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=I_(i.transform,e);Br.transform(j_,r,o),j_.getBoundary(U_,B_),s.min(F_,F_,U_),s.max(k_,k_,B_)}this._modelBounds&&this._worldBounds&&(Br.fromPoints(this._modelBounds,F_,k_),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds))}},{key:"updateUBOs",value:function(e){P(u(t.prototype),"updateUBOs",this).call(this,e);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;f.multiply(G_,a.world,s);for(var c=0;c<o.length;c++)n_(this._dataArray[o[c]],12*r[c],G_)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0}},{key:"initSubModel",value:function(e,n,i){var r=n.vertexBuffers;n.vertexBuffers=n.jointMappedBuffers,P(u(t.prototype),"initSubModel",this).call(this,e,n,i),n.vertexBuffers=r}},{key:"getMacroPatches",value:function(e){var n=P(u(t.prototype),"getMacroPatches",this).call(this,e);return n?w_.concat(n):w_}},{key:"_updateLocalDescriptors",value:function(e,n){P(u(t.prototype),"_updateLocalDescriptors",this).call(this,e,n);var i=this._buffers[this._bufferIndices[e]];i&&n.bindBuffer(za.BLOCK.binding,i)}},{key:"_ensureEnoughBuffers",value:function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer({usage:an.UNIFORM|an.TRANSFER_DST,memUsage:sn.HOST|sn.DEVICE,size:za.SIZE,stride:za.SIZE})),this._dataArray[t]||(this._dataArray[t]=new Float32Array(za.COUNT))}}]),t}(E_)),e("A",function(){function e(){o(this,e),this._enabled=!0,this._skyColor=new ye(51,128,204,1),this._skyIllum=e.SKY_ILLUM,this._groundAlbedo=new ye(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1])}return r(e,[{key:"activate",value:function(){ye.toArray(this._colorArray,this._skyColor),s.toArray(this._albedoArray,this._groundAlbedo)}},{key:"colorArray",get:function(){return this._colorArray}},{key:"albedoArray",get:function(){return this._albedoArray}},{key:"enabled",set:function(e){this._enabled!==e&&(this._enabled=e,this.activate())},get:function(){return this._enabled}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e,ye.toArray(this._colorArray,this._skyColor)}},{key:"skyIllum",get:function(){return this._skyIllum},set:function(e){this._skyIllum=e}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e,s.toArray(this._albedoArray,this._groundAlbedo)}}]),e}()));V_.SUN_ILLUM=65e3,V_.SKY_ILLUM=2e4,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(N_||(N_=e("B",{}))),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(D_||(D_=e("D",{}))),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(z_||(z_=e("E",{}))),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(M_||(M_=e("F",{}))),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(L_||(L_=e("H",{})));var H_=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],q_=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],W_=[100,200,400,800],X_=new s,Y_=new s,K_=new f,Q_=new f,J_=e("I",Ln.STENCIL<<1),Z_=(e("K",function(){function e(t){o(this,e),this.isWindowSize=!0,this.screenScale=void 0,this.clearStencil=0,this.clearDepth=1,this.clearFlag=Ln.NONE,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._width=void 0,this._height=void 0,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=N_.VERTICAL,this._fov=xe(45),this._nearClip=1,this._farClip=1e3,this._clearColor={r:.2,g:.2,b:.2,a:1},this._viewport=new Y(0,0,1,1),this._isProjDirty=!0,this._matView=new f,this._matViewInv=null,this._matProj=new f,this._matProjInv=new f,this._matViewProj=new f,this._matViewProjInv=new f,this._frustum=new Yr,this._forward=new s,this._position=new s,this._view=null,this._visibility=ja,this._priority=0,this._aperture=z_.F16_0,this._apertureValue=void 0,this._shutter=L_.D125,this._shutterValue=0,this._iso=M_.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._device=t,this._apertureValue=H_[this._aperture],this._shutterValue=q_[this._shutter],this._isoValue=W_[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this.screenScale=1}return r(e,[{key:"initialize",value:function(e){this._name=e.name,this._node=e.node,this._proj=e.projection,this._priority=e.priority||0,this._view=a.director.root.createView({camera:this,name:this._name,priority:this._priority,flows:e.flows}),a.director.root.attachCamera(this),this.changeTargetWindow(e.window),console.log("Created Camera: "+this._name+" "+this._width+"x"+this._height)}},{key:"destroy",value:function(){a.director.root.detachCamera(this),this._view&&(this._view.destroy(),this._view=null),this._name=null}},{key:"attachToScene",value:function(e){this._scene=e,this._view&&this._view.enable(!0)}},{key:"detachFromScene",value:function(){this._scene=null,this._view&&this._view.enable(!1)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width*this._viewport.width/(this._height*this._viewport.height),this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width*this._viewport.width/(this._height*this._viewport.height),this.isWindowSize=!1}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._node){if((this._node.hasChangedFlags||e)&&(f.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty){var t=this._device.screenSpaceSignY;if(this._view&&this._view.window.hasOffScreenAttachments&&(t*=this._device.UVSpaceSignY),this._proj===D_.PERSPECTIVE)f.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===N_.VERTICAL,this._device.clipSpaceMinZ,t);else{var n=this._orthoHeight*this._aspect,i=this._orthoHeight;f.ortho(this._matProj,-n,n,-i,i,this._nearClip,this._farClip,this._device.clipSpaceMinZ,t)}f.invert(this._matProjInv,this._matProj)}(this._node.hasChangedFlags||this._isProjDirty||e)&&(f.multiply(this._matViewProj,this._matProj,this._matView),f.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,n){if(this._node){if(t=Math.max(t,this._nearClip),n=Math.min(n,this._farClip),f.invert(this._matView,this._node.worldMatrix),this._proj===D_.PERSPECTIVE)f.perspective(K_,this._fov,this._aspect,t,n,this._fovAxis===N_.VERTICAL,this._device.clipSpaceMinZ,this._device.screenSpaceSignY);else{var i=this._orthoHeight*this._aspect,r=this._orthoHeight;f.ortho(K_,-i,i,-r,r,t,n,this._device.clipSpaceMinZ,this._device.screenSpaceSignY)}f.multiply(Q_,K_,this._matView),f.invert(K_,Q_),e.update(Q_,K_)}}},{key:"changeTargetWindow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=e||a.director.root.mainWindow;t&&this._view&&(this._view.window=t,this.resize(t.width,t.height))}},{key:"screenPointToRay",value:function(e,t,n){var i=this._viewport.x*this._width,r=this._viewport.y*this._height,o=this._viewport.width*this._width,a=this._viewport.height*this._height;return s.set(X_,(t-i)/o*2-1,(n-r)/a*2-1,1),X_.y*=this._device.screenSpaceSignY,s.transformMat4(X_,X_,this._matViewProjInv),this._proj===D_.PERSPECTIVE?this._node&&this._node.getWorldPosition(Y_):(s.set(Y_,(t-i)/o*2-1,(n-r)/a*2-1,-1),Y_.y*=this._device.screenSpaceSignY,s.transformMat4(Y_,Y_,this._matViewProjInv)),Vt.fromPoints(e,Y_,X_)}},{key:"screenToWorld",value:function(e,t){var n=this._viewport.x*this._width,i=this._viewport.y*this._height,r=this._viewport.width*this._width,o=this._viewport.height*this._height;return this._proj===D_.PERSPECTIVE?(s.set(e,(t.x-n)/r*2-1,(t.y-i)/o*2-1,1),s.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(X_),s.lerp(e,X_,e,Se(this._nearClip/this._farClip,1,t.z))):(s.set(e,(t.x-n)/r*2-1,(t.y-i)/o*2-1,2*t.z-1),s.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var n=this._viewport.x*this._width,i=this._viewport.y*this._height,r=this._viewport.width*this._width,o=this._viewport.height*this._height;return s.transformMat4(e,t,this.matViewProj),e.x=n+.5*(e.x+1)*r,e.y=i+.5*(e.y+1)*o,e.z=.5*e.z+.5,e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"enabled",set:function(e){this._enabled=e,this._view&&this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"fovAxis",set:function(e){this._fovAxis=e,this._isProjDirty=!0},get:function(){return this._fovAxis}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.r=e.r,this._clearColor.g=e.g,this._clearColor.b=e.b,this._clearColor.a=e.a},get:function(){return this._clearColor}},{key:"viewport",get:function(){return this._viewport},set:function(e){var t=this._device.screenSpaceSignY;this._viewport.x=e.x,this._viewport.y=t>0?e.y:1-e.y-e.height,this._viewport.width=e.width,this._viewport.height=e.height,this.resize(this._width,this._height)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",set:function(e){this._matView=e},get:function(){return this._matView}},{key:"matViewInv",set:function(e){this._matViewInv=e},get:function(){return this._matViewInv||this._node.worldMatrix}},{key:"matProj",set:function(e){this._matProj=e},get:function(){return this._matProj}},{key:"matProjInv",set:function(e){this._matProjInv=e},get:function(){return this._matProjInv}},{key:"matViewProj",set:function(e){this._matViewProj=e},get:function(){return this._matViewProj}},{key:"matViewProjInv",set:function(e){this._matViewProjInv=e},get:function(){return this._matViewProjInv}},{key:"frustum",set:function(e){this._frustum=e},get:function(){return this._frustum}},{key:"forward",set:function(e){this._forward=e},get:function(){return this._forward}},{key:"position",set:function(e){this._position=e},get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view&&(this._view.visibility=e)},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view?this._view.priority:-1},set:function(e){this._priority=e,this._view&&(this._view.priority=this._priority)}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=H_[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=q_[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=W_[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return this._exposure}},{key:"flows",set:function(e){this._view&&this._view.setExecuteFlows(e)}}]),e}()),e("$",function(){function e(t){o(this,e),this._root=void 0,this._name="",this._cameras=[],this._models=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t}return r(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"rayResultCanvas",get:function(){return lf}},{key:"rayResultModels",get:function(){return af}},{key:"rayResultAll",get:function(){return uf}},{key:"rayResultSingleModel",get:function(){return _f}}],[{key:"registerCreateFunc",value:function(t){t._createSceneFun=function(t){return new e(t)}}}]),r(e,[{key:"initialize",value:function(e){return this._name=e.name,!0}},{key:"update",value:function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++){n[i].update()}for(var r=this._spotLights,o=0;o<r.length;o++){r[o].update()}for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}}},{key:"destroy",value:function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels()}},{key:"addCamera",value:function(e){e.attachToScene(this),this._cameras.push(e)}},{key:"removeCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()}},{key:"removeCameras",value:function(){for(var e,t=N(this._cameras);!(e=t()).done;){e.value.detachFromScene()}this._cameras.splice(0)}},{key:"setMainLight",value:function(e){this._mainLight=e}},{key:"unsetMainLight",value:function(e){if(this._mainLight===e){var t=this._directionalLights;t.length?(this._mainLight=t[t.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Kl.ROTATION)):this._mainLight=null}}},{key:"addDirectionalLight",value:function(e){e.attachToScene(this),this._directionalLights.push(e)}},{key:"removeDirectionalLight",value:function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)}},{key:"addSphereLight",value:function(e){e.attachToScene(this),this._sphereLights.push(e)}},{key:"removeSphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)}},{key:"addSpotLight",value:function(e){e.attachToScene(this),this._spotLights.push(e)}},{key:"removeSpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)}},{key:"removeSphereLights",value:function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0}},{key:"removeSpotLights",value:function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]}},{key:"addModel",value:function(e){e.attachToScene(this),this._models.push(e)}},{key:"removeModel",value:function(e){for(var t=a.director.root.pipeline,n=0;n<this._models.length;++n)if(this._models[n]===e)return t.shadows.destroyShadowData(e),e.detachFromScene(),void this._models.splice(n,1)}},{key:"removeModels",value:function(){for(var e,t=a.director.root.pipeline,n=N(this._models);!(e=n()).done;){var i=e.value;t.shadows.destroyShadowData(i),i.detachFromScene(),i.destroy()}this._models.length=0}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e,t=N(this._models);!(e=t()).done;){e.value.onGlobalPipelineStateChanged()}}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycastAll",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ua.Enum.DEFAULT|ua.Enum.UI_2D,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0,i=this.raycastAllModels(e,t,n),r=this.raycastAllCanvas(e,t,n),o=i||r;return uf.length=0,o&&(Array.prototype.push.apply(uf,af),Array.prototype.push.apply(uf,lf)),o}},{key:"raycastAllModels",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ua.Enum.DEFAULT,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;of.reset();for(var i,r=N(this._models);!(i=r()).done;){var o=i.value,a=o.transform;if(a&&o.enabled&&o.node.layer&t&~ua.Enum.IGNORE_RAYCAST&&o.worldBounds){var c=wr.ray_aabb(e,o.worldBounds);if(!(c<=0||c>=n)){if(o.type===p_.DEFAULT){f.invert(tf,a.getWorldMatrix(tf)),s.transformMat4($_.o,e.o,tf),s.normalize($_.d,s.transformMat4Normal($_.d,e.d,tf)),c=1/0;for(var l=o.subModels,u=0;u<l.length;++u){var _=l[u].subMesh;if(_&&_.geometricInfo){var h=_.geometricInfo,d=h.positions,v=h.indices,m=h.doubleSided;ff(d,v,_.primitiveMode,m,n),c=Math.min(c,nf*s.multiply(ef,$_.d,a.worldScale).length())}}}if(c<n){var p=of.add();p.node=o.node,p.distance=c,af[of.length-1]=p}}}}return af.length=of.length,af.length>0}},{key:"raycastSingleModel",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ua.Enum.DEFAULT,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0;of.reset();var r=t,o=r.transform;if(!(o&&r.enabled&&r.node.layer&n&~ua.Enum.IGNORE_RAYCAST&&r.worldBounds))return!1;var a=wr.ray_aabb(e,r.worldBounds);if(a<=0||a>=i)return!1;if(r.type===p_.DEFAULT){f.invert(tf,o.getWorldMatrix(tf)),s.transformMat4($_.o,e.o,tf),s.normalize($_.d,s.transformMat4Normal($_.d,e.d,tf)),a=1/0;for(var c=r.subModels,l=0;l<c.length;++l){var u=c[l].subMesh;if(u&&u.geometricInfo){var _=u.geometricInfo,h=_.positions,d=_.indices,v=_.doubleSided;ff(h,d,u.primitiveMode,v,i),a=Math.min(a,nf*s.multiply(ef,$_.d,o.worldScale).length())}}}if(a<i){var m=of.add();m.node=r.node,m.distance=a,_f[of.length-1]=m}return _f.length=of.length,_f.length>0}},{key:"raycastAllCanvas",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ua.Enum.UI_2D,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;cf.reset();var i=a.director.getScene().getComponentsInChildren(a.Canvas);if(null!=i&&i.length>0)for(var r=0;r<i.length;r++){var o=i[r].node;null!=o&&o.active&&this._raycastUI2DNodeRecursiveChildren(e,o,t,n)}return lf.length=cf.length,lf.length>0}},{key:"_raycastUI2DNode",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ua.Enum.UI_2D,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0,r=t._uiProps.uiTransformComp;if(!(null==r||t.layer&ua.Enum.IGNORE_RAYCAST)&&t.layer&n){r.getComputeAABB(sf);var o=wr.ray_aabb(e,sf);if(!(o<=0)&&o<i){var a=cf.add();return a.node=t,a.distance=o,a}}}},{key:"_raycastUI2DNodeRecursiveChildren",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ua.Enum.UI_2D,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0,r=this._raycastUI2DNode(e,t,n,i);null!=r&&(lf[cf.length-1]=r);for(var o,a=N(t.children);!(o=a()).done;){var s=o.value;null!=s&&s.active&&this._raycastUI2DNodeRecursiveChildren(e,s,n,i)}}}]),e}())),$_=Vt.create(),ef=new s,tf=new f,nf=1/0,rf=Jt.create(),of=new mt((function(){return{node:null,distance:1/0}}),8),af=[],sf=new Br,cf=new mt((function(){return{node:null,distance:1/0}}),8),lf=[],uf=[],_f=[],ff=function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1/0;if(nf=r,n===un.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var c=3*t[a],l=3*t[a+1],u=3*t[a+2];s.set(rf.a,e[c],e[c+1],e[c+2]),s.set(rf.b,e[l],e[l+1],e[l+2]),s.set(rf.c,e[u],e[u+1],e[u+2]);var _=wr.ray_triangle($_,rf,i);_<=0||_>=nf||(nf=_)}else if(n===un.TRIANGLE_STRIP)for(var f=t.length-2,h=0,d=0;d<f;d+=1){var v=3*t[d-h],m=3*t[d+h+1],p=3*t[d+2];s.set(rf.a,e[v],e[v+1],e[v+2]),s.set(rf.b,e[m],e[m+1],e[m+2]),s.set(rf.c,e[p],e[p+1],e[p+2]),h=~h;var g=wr.ray_triangle($_,rf,i);g<=0||g>=nf||(nf=g)}else if(n===un.TRIANGLE_FAN){var y=t.length-1,x=3*t[0];s.set(rf.a,e[x],e[x+1],e[x+2]);for(var S=1;S<y;S+=1){var C=3*t[S],T=3*t[S+1];s.set(rf.b,e[C],e[C+1],e[C+2]),s.set(rf.c,e[T],e[T+1],e[T+2]);var E=wr.ray_triangle($_,rf,i);E<=0||E>=nf||(nf=E)}}};C(Z_.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastAllCanvas"},{name:"raycastUI2D",newName:"raycastAllCanvas"},{name:"raycast",newName:"raycastAllModels"},{name:"raycastModels",newName:"raycastAllModels"},{name:"raycastModel",newName:"raycastSingleModel"}]),T(Z_.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Ce(Z_.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect in geometry"},{name:"raycastAllModels",suggest:"using intersect in geometry"},{name:"raycastSingleModel",suggest:"using intersect in geometry"},{name:"raycastAllCanvas",suggest:"using intersect in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var hf=e("L",{});T(hf,"CameraVisFlags",[{name:"GENERAL"}]),C(hf,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:ua.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:ua.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:ua.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:ua.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:ua.BitMask,targetName:"UI_2D"}]),a.CameraVisFlags=hf;var df,vf=e("V",{});function mf(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}T(vf,"VisibilityFlags",[{name:"GENERAL"}]),C(vf,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:ua.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:ua.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:ua.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:ua.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:ua.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:ua.Enum,targetName:"UI_2D"}]),a.VisibilityFlags=vf,C(gc.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(df||(df=e("P",{})));var pf=e("Q",(function(e){return 4*Math.PI*Math.PI*e*e})),gf=e("T",function(){function e(){o(this,e),this._color=new s(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new s(1,1,1),this._scene=null,this._node=null,this._type=void 0,this._name=null,this._type=df.UNKNOWN}return r(e,[{key:"color",set:function(e){this._color.set(e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){this._useColorTemp=e},get:function(){return this._useColorTemp}},{key:"colorTemperature",set:function(e){this._colorTemp=e,mf(this._colorTempRGB,this._colorTemp)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=Kl.ROTATION)},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}}]),r(e,[{key:"initialize",value:function(e,t){this._name=e,this._type=df.UNKNOWN,this._node=t}},{key:"attachToScene",value:function(e){this._scene=e}},{key:"detachFromScene",value:function(){this._scene=null}},{key:"destroy",value:function(){this._name=null,this._type=df.UNKNOWN,this._node=null}},{key:"update",value:function(){}}]),e}()),yf=new s(0,0,-1),xf=new s,Sf=new W,Cf=(e("N",function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this)))._dir=new s(1,-1,-1),e._illum=V_.SUN_ILLUM,e._shadowRange=1e3,e._shadowIntensity=0,e._shadowFadeDistance=0,e._shadowDistance=0,e._fadeStart=.8,e._splits=new v(1,0,0,0),e._biasAutoAdjust=1,e._type=df.DIRECTIONAL,e}return c(t,e),r(t,[{key:"shadowRange",set:function(e){this._shadowRange=e},get:function(){return this._shadowRange}},{key:"shadowIntensitywRange",set:function(e){this._shadowIntensity=e}},{key:"shadowIntensity",get:function(){return this._shadowIntensity}},{key:"shadowFadeDistance",set:function(e){this._shadowFadeDistance=e},get:function(){return this._shadowFadeDistance}},{key:"shadowDistance",set:function(e){this._shadowDistance=e},get:function(){return this._shadowDistance}},{key:"fadeStart",set:function(e){this._fadeStart=e},get:function(){return this._fadeStart}},{key:"splits",set:function(e){this._splits=e},get:function(){return this._splits}},{key:"biasAutoAdjust",set:function(e){this._biasAutoAdjust=e},get:function(){return this._biasAutoAdjust}},{key:"direction",set:function(e){this._dir=e,s.normalize(this._dir,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){this._illum=e},get:function(){return this._illum}}]),r(t,[{key:"update",value:function(){this._node&&this._node.hasChangedFlags&&(this._dir=s.transformQuat(xf,yf,this._node.getWorldRotation(Sf)),s.normalize(this._dir,this._dir))}}]),t}(gf)),e("dX",function(){function e(){o(this,e)}return r(e,null,[{key:"getOrCreatePipelineState",value:function(e,t,n,i,r){var o=rc.get(t,Ys.HASH)^i.hash^r.attributesHash^n.id,a=this._PSOHashMap.get(o);if(!a){var s=nc.get(rc.get(t,Ys.PIPELINE_LAYOUT)),c=new mi;c.attributes=r.attributes,a=e.createPipelineState({primitive:rc.get(t,Ys.PRIMITIVE),rasterizerState:Qs.get(rc.get(t,Ys.RASTERIZER_STATE)),depthStencilState:Js.get(rc.get(t,Ys.DEPTH_STENCIL_STATE)),blendState:Zs.get(rc.get(t,Ys.BLEND_STATE)),dynamicStates:rc.get(t,Ys.DYNAMIC_STATES),inputState:c,renderPass:i,shader:n,pipelineLayout:s}),this._PSOHashMap.set(o,a)}return a}}]),e}()));Cf._PSOHashMap=new Map;var Tf,Ef=new s(0,0,-1),Af=new s,bf=new Br,wf=new W,If=(new s(0,1,0),new s),Rf=new s,Of=new f,Pf=e("X",m({Planar:0,ShadowMap:1})),Nf=e("Y",m({HARD:0,FILTER_X5:1,FILTER_X9:2,FILTER_X25:3})),Df=e("Z",function(){function e(){o(this,e),this._enabled=!1,this._type=Pf.Planar,this._normal=new s(0,1,0),this._distance=0,this._shadowColor=new ye(0,0,0,76),this._matLight=new f,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._record=new Map,this._pendingModels=[],this._material=null,this._instancingMaterial=null,this._device=null,this._globalDescriptorSet=null,this._dirty=!0,this._sphere=new Qt(0,0,0,.01),this.near=1,this.far=30,this.aspect=1,this.orthoSize=1,this.size=new X(512,512),this.pcf=Nf.HARD}return r(e,[{key:"activate",value:function(){var e=a.director.root.pipeline;this._globalDescriptorSet=e.descriptorSet,this._data=e.shadowUBO,ye.toArray(this._data,this._shadowColor,Aa.SHADOW_COLOR_OFFSET),this._globalDescriptorSet.getBuffer(Aa.BLOCK.binding).update(this._data),this._type===Pf.ShadowMap?this._updatePipeline():this._updatePlanarInfo()}},{key:"getWorldMatrix",value:function(e,t){s.negate(If,t);var n=Math.sqrt(2)*this._sphere.radius;return s.multiplyScalar(Rf,If,n),s.add(Rf,Rf,this._sphere.center),f.fromRT(Of,e,Rf),Of}},{key:"_updatePlanarInfo",value:function(){this._dirty=!0,this._material||(this._material=new $c,this._material.initialize({effectName:"pipeline/planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new $c,this._instancingMaterial.initialize({effectName:"pipeline/planar-shadow",defines:{USE_INSTANCING:!0}}))}},{key:"_updatePipeline",value:function(){var e=a.director.root,t=e.pipeline;this._enabled&&this._type===Pf.ShadowMap?delete t.macros.CC_RECEIVE_SHADOW:t.macros.CC_RECEIVE_SHADOW=!1,e.onGlobalPipelineStateChanged()}},{key:"updateSphereLight",value:function(e){if(e.node.hasChangedFlags||this._dirty){this._dirty=!1,e.node.getWorldPosition(Af);var t=this._normal,n=this._distance+.001,i=s.dot(t,Af),r=Af.x,o=Af.y,a=Af.z,c=t.x,l=t.y,u=t.z,_=this._matLight;_.m00=i-n-r*c,_.m01=-o*c,_.m02=-a*c,_.m03=-c,_.m04=-r*l,_.m05=i-n-o*l,_.m06=-a*l,_.m07=-l,_.m08=-r*u,_.m09=-o*u,_.m10=i-n-a*u,_.m11=-u,_.m12=r*n,_.m13=o*n,_.m14=a*n,_.m15=i,f.toArray(this._data,this._matLight,Aa.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalDescriptorSet.getBuffer(Aa.BLOCK.binding).update(this.data)}}},{key:"updateDirLight",value:function(e){if(e.node.hasChangedFlags||this._dirty){this._dirty=!1,e.node.getWorldRotation(wf),s.transformQuat(Af,Ef,wf);var t=this._normal,n=this._distance+.001,i=1/s.dot(t,Af),r=Af.x*i,o=Af.y*i,a=Af.z*i,c=t.x,l=t.y,u=t.z,_=this._matLight;_.m00=1-c*r,_.m01=-c*o,_.m02=-c*a,_.m03=0,_.m04=-l*r,_.m05=1-l*o,_.m06=-l*a,_.m07=0,_.m08=-u*r,_.m09=-u*o,_.m10=1-u*a,_.m11=0,_.m12=r*n,_.m13=o*n,_.m14=a*n,_.m15=1,f.toArray(this._data,this._matLight,Aa.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalDescriptorSet.getBuffer(Aa.BLOCK.binding).update(this.data)}}},{key:"updateShadowList",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._pendingModels.length=0,e.mainLight&&n)for(var i=e.models,r=0;r<i.length;r++){var o=i[r];if(o.enabled&&o.node&&o.castShadow&&(!o.worldBounds||(Br.transform(bf,o.worldBounds,this._matLight),wr.aabb_frustum(bf,t)))){var a=this._record.get(o);a&&!!a.instancedBuffer!==o.isInstancingEnabled&&(this.destroyShadowData(o),a=void 0),a||(a=this.createShadowData(o),this._record.set(o,a)),this._pendingModels.push(a)}}}},{key:"recordCommandBuffer",value:function(e,t,n){this._device=e;var i=this._pendingModels,r=i.length;if(r){var o=m_.get(this._instancingMaterial.passes[0]);o&&o.clear();var a=this._material.passes[0].handle,s=ec.get(rc.get(a,Ys.DESCRIPTOR_SET));n.bindDescriptorSet(ya.MATERIAL,s);for(var c=0;c<r;c++)for(var l=i[c],u=l.model,_=l.hShaders,f=l.instancedBuffer,h=0;h<_.length;h++){var d=u.subModels[h],v=_[h];if(f)f.merge(d,u.instancedAttributes,0,v);else{var m=d.inputAssembler,p=$s.get(v),g=Cf.getOrCreatePipelineState(e,a,p,t,m);n.bindPipelineState(g),n.bindDescriptorSet(ya.LOCAL,d.descriptorSet),n.bindInputAssembler(m),n.draw(m)}}if(o&&o.hasPendingModels){o.uploadBuffers(),s=ec.get(rc.get(o.hPass,Ys.DESCRIPTOR_SET)),n.bindDescriptorSet(ya.MATERIAL,s);for(var y=null,x=0;x<o.instances.length;++x){var S=o.instances[x];if(S.count){var C=$s.get(S.hShader),T=Cf.getOrCreatePipelineState(e,o.hPass,C,t,S.ia);y!==T&&(n.bindPipelineState(T),n.bindDescriptorSet(ya.LOCAL,ec.get(S.hDescriptorSet)),y=T),n.bindInputAssembler(S.ia),n.draw(S.ia)}}}}}},{key:"createShadowData",value:function(e){for(var t=[],n=e.isInstancingEnabled?this._instancingMaterial:this._material,i=e.isInstancingEnabled?m_.get(n.passes[0]):null,r=e.subModels,o=0;o<r.length;o++){var a=n.passes[0].getShaderVariant(e.getMacroPatches(o));t.push(a)}return{model:e,hShaders:t,instancedBuffer:i}}},{key:"destroyShadowData",value:function(e){this._record.delete(e)}},{key:"destroy",value:function(){this._record.clear(),this._material&&this._material.destroy()}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._dirty=!0,this._enabled?this.activate():this._updatePipeline())}},{key:"normal",get:function(){return this._normal},set:function(e){s.copy(this._normal,e),this._dirty=!0}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._dirty=!0}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e,this._enabled&&(ye.toArray(this._data,e,Aa.SHADOW_COLOR_OFFSET),this._globalDescriptorSet&&this._globalDescriptorSet.getBuffer(Aa.BLOCK.binding).update(this.data)),this._dirty=!0}},{key:"type",get:function(){return this._enabled?this._type:-1},set:function(e){this._type=e,this._updatePipeline(),this._updatePlanarInfo()}},{key:"matLight",get:function(){return this._matLight}},{key:"data",get:function(){return this._data}},{key:"sphere",get:function(){return this._sphere}}]),e}());function zf(e,t){if(!t){var n=a.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}a.find=zf,function(e){e[e.positions=nn.ATTR_POSITION]="positions",e[e.normals=nn.ATTR_NORMAL]="normals",e[e.uvs=nn.ATTR_TEX_COORD]="uvs",e[e.colors=nn.ATTR_COLOR]="colors"}(Tf||(Tf={}));var Mf=[{name:nn.ATTR_POSITION,format:on.RGB32F},{name:nn.ATTR_NORMAL,format:on.RGB32F},{name:nn.ATTR_TEX_COORD,format:on.RG32F},{name:nn.ATTR_TANGENT,format:on.RGBA32F},{name:nn.ATTR_COLOR,format:on.RGBA32F}],Lf=new s;function Ff(e,t,n){n=n||{};var i,r=[],o=0,a=[],c=0,l=e.positions.slice();if(l.length>0){if(i=null,e.attributes)for(var u,_=N(e.attributes);!(u=_()).done;){var f=u.value;if(f.name===nn.ATTR_POSITION){i=f;break}}i||(i=Mf[0]),r.push(i);var h=Yn[i.format];c=Math.max(c,Math.floor(l.length/h.count)),a.push({offset:o,data:l,attribute:i}),o+=h.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var d,v=N(e.attributes);!(d=v()).done;){var m=d.value;if(m.name===nn.ATTR_NORMAL){i=m;break}}i||(i=Mf[1]);var p=Yn[i.format];r.push(i),c=Math.max(c,Math.floor(e.normals.length/p.count)),a.push({offset:o,data:e.normals,attribute:i}),o+=p.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var g,y=N(e.attributes);!(g=y()).done;){var x=g.value;if(x.name===nn.ATTR_TEX_COORD){i=x;break}}i||(i=Mf[2]);var S=Yn[i.format];r.push(i),c=Math.max(c,Math.floor(e.uvs.length/S.count)),a.push({offset:o,data:e.uvs,attribute:i}),o+=S.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var C,T=N(e.attributes);!(C=T()).done;){var E=C.value;if(E.name===nn.ATTR_TANGENT){i=E;break}}i||(i=Mf[3]);var A=Yn[i.format];r.push(i),c=Math.max(c,Math.floor(e.tangents.length/A.count)),a.push({offset:o,data:e.tangents,attribute:i}),o+=A.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var b,w=N(e.attributes);!(b=w()).done;){var I=b.value;if(I.name===nn.ATTR_COLOR){i=I;break}}i||(i=Mf[4]);var R=Yn[i.format];r.push(i),c=Math.max(c,Math.floor(e.colors.length/R.count)),a.push({offset:o,data:e.colors,attribute:i}),o+=R.size}if(e.customAttributes)for(var O,P=N(e.customAttributes);!(O=P()).done;){var D=O.value,z=Yn[D.attr.format];r.push(D.attr),c=Math.max(c,Math.floor(D.values.length/z.count)),a.push({offset:o,data:D.values,attribute:D.attr}),o+=z.size}for(var M=new So,L=new ArrayBuffer(c*o),F=new DataView(L),k=0,U=a;k<U.length;k++){var B=U[k];go(F,B.data,B.attribute.format,B.offset,o)}M.setNextAlignment(0);var G={attributes:r,view:{offset:M.getLength(),length:L.byteLength,count:c,stride:o}};M.addBuffer(L);var j=null,V=0;if(e.indices){var H=e.indices;V=H.length,j=new ArrayBuffer(2*V),go(new DataView(j),H,on.R16UI)}var q={primitiveMode:e.primitiveMode||un.TRIANGLE_LIST,vertexBundelIndices:[0]};j&&(M.setNextAlignment(2),q.indexView={offset:M.getLength(),length:j.byteLength,count:V,stride:2},M.addBuffer(j));var W=e.minPos;if(!W&&n.calculateBounds){W=s.set(new s,1/0,1/0,1/0);for(var X=0;X<c;++X)s.set(Lf,l[3*X+0],l[3*X+1],l[3*X+2]),s.min(W,W,Lf)}var Y=e.maxPos;if(!Y&&n.calculateBounds){Y=s.set(new s,-1/0,-1/0,-1/0);for(var K=0;K<c;++K)s.set(Lf,l[3*K+0],l[3*K+1],l[3*K+2]),s.max(Y,Y,Lf)}var Q={vertexBundles:[G],primitives:[q]};return W&&(Q.minPosition=new s(W.x,W.y,W.z)),Y&&(Q.maxPosition=new s(Y.x,Y.y,Y.z)),t||(t=new rs),t.reset({struct:Q,data:new Uint8Array(M.getCombined())}),t}function kf(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function Uf(e){var t=(e=e||{}).widthSegments||1,n=e.heightSegments||1,i=e.lengthSegments||1,r=(e.width||1)/2,o=(e.height||1)/2,a=(e.length||1)/2,c=[s.set(Hf,-r,-o,a),s.set(qf,r,-o,a),s.set(Wf,r,o,a),s.set(Xf,-r,o,a),s.set(Yf,r,-o,-a),s.set(Kf,-r,-o,-a),s.set(Qf,-r,o,-a),s.set(Jf,r,o,-a)],l=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],u=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],_=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],f=[],h=[],d=[],v=[],m=[],p=new s(-r,-o,-a),g=new s(r,o,a),y=Math.sqrt(r*r+o*o+a*a);function x(e,t,n){var i,r,o,a,p=f.length/3,g=l[e],y=u[e],x=_[e];for(a=0;a<=n;a++)for(o=0;o<=t;o++)if(i=o/t,r=a/n,s.lerp(Bf,c[g[0]],c[g[1]],i),s.lerp(Gf,c[g[0]],c[g[2]],r),s.subtract(jf,Gf,c[g[0]]),s.add(Vf,Bf,jf),f.push(Vf.x,Vf.y,Vf.z),h.push(y[0],y[1],y[2]),d.push(i,r),v.push(x[0],x[1],x[2],x[3]),o<t&&a<n){var S=t+1,C=o+a*S,T=o+(a+1)*S,E=o+1+(a+1)*S,A=o+1+a*S;m.push(p+C,p+A,p+T),m.push(p+T,p+A,p+E)}}return x(0,t,n),x(4,i,n),x(1,t,n),x(5,i,n),x(3,t,i),x(2,t,i),{positions:f,normals:h,uvs:d,tangents:v,indices:m,minPos:p,maxPos:g,boundingRadius:y}}var Bf=new s,Gf=new s,jf=new s,Vf=new s,Hf=new s,qf=new s,Wf=new s,Xf=new s,Yf=new s,Kf=new s,Qf=new s,Jf=new s,Zf=new s(0,0,0),$f=new s(0,0,0);var eh=new s(0,0,0),th=new s(0,0,0),nh=new s(0,0,0),ih=new s(0,0,0),rh=new s(0,0,0),oh=new s(0,0,0),ah=new s(0,0,0);var sh=new s(0,0,0),ch=new s(0,0,0);var lh,uh,_h,fh,hh,dh,vh,mh,ph,gh,yh,xh,Sh,Ch,Th,Eh,Ah,bh,wh,Ih,Rh,Oh,Ph,Nh,Dh,zh,Mh,Lh,Fh,kh,Uh,Bh,Gh,jh,Vh,Hh,qh,Wh,Xh=null,Yh=null,Kh=e("a0",function(){function e(){o(this,e),this._enabled=!1,this._isRGBE=!1,this._useIBL=!1,this._envmap=null,this._globalDescriptorSet=null,this._model=null,this._default=null}return r(e,[{key:"activate",value:function(){var e=a.director.root.pipeline;if(this._globalDescriptorSet=e.descriptorSet,this._default=js.get("default-cube-texture"),this._model||(this._model=new T_),Yh)Yh.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE});else{var t=new $c;t.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:this._isRGBE}}),Yh=new nl({parent:t})}Xh||(Xh=Ff(Uf({width:2,height:2,length:2}))),this._model.initSubModel(0,Xh.renderingSubMeshes[0],Yh),this.envmap=this._envmap,this._updatePipeline()}},{key:"_updatePipeline",value:function(){var e=this._useIBL?this._isRGBE?2:1:0,t=a.director.root,n=t.pipeline;n.macros.CC_USE_IBL!==e&&(n.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())}},{key:"_updateGlobalBinding",value:function(){var e=this.envmap.getGFXTexture(),t=Ko.getSampler(a.director._device,this.envmap.getSamplerHash());this._globalDescriptorSet.bindSampler(wa.binding,t),this._globalDescriptorSet.bindTexture(wa.binding,e)}},{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._enabled?this.activate():this._updatePipeline())}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._updatePipeline()}},{key:"isRGBE",get:function(){return this._isRGBE},set:function(e){this._isRGBE=e,this._enabled&&(Yh&&Yh.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this._model&&this._model.setSubModelMaterial(0,Yh)),this._updatePipeline()}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e||this._default,this._envmap&&(a.director.root.pipeline.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}}]),e}()),Qh=new s(0,0,-1),Jh=new W,Zh=new f,$h=new f,ed=new f,td=new f,nd=(e("a1",function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this)))._dir=new s(1,-1,-1),e._size=.15,e._range=5,e._luminance=1700/pf(e._size),e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._type=df.SPOT,e._aabb=Br.create(),e._frustum=Yr.create(),e._pos=new s,e}return c(t,e),r(t,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e,this._needUpdate=!0},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),r(t,[{key:"update",value:function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),s.transformQuat(this._dir,Qh,this._node.getWorldRotation(Jh)),s.normalize(this._dir,this._dir),Br.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Zh),f.invert(Zh,Zh),f.perspective($h,this._angle,1,.001,this._range),f.multiply(ed,$h,Zh),this._frustum.update(ed,td),this._needUpdate=!1)}}]),t}(gf)),function e(){o(this,e),this.material=null,this.vertexCount=0,this.indicesCount=0}),id=e("dc",function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r)))).vData=null,n.uvDirty=!0,n.vertDirty=!0,n._data=[],n._indices=[],n._pivotX=0,n._pivotY=0,n._width=0,n._height=0,n}return c(t,e),r(t,[{key:"updateSizeNPivot",value:function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)}},{key:"clear",value:function(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0}},{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)rd.free(t[i]);for(i=n;i<e;i++)t[i]=rd.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}],[{key:"add",value:function(){return od.add()}},{key:"remove",value:function(e){var t=od.data.indexOf(e);-1!==t&&(od.data[t].clear(),od.removeAt(t))}}]),t}(nd)),rd=(e("d_",function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),n.iData=new Uint16Array(1536),n.vertexStart=0,n.indicesStart=0,n.byteStart=0,n.byteCount=0,n._formatByte=9*Float32Array.BYTES_PER_ELEMENT,n}return c(t,e),r(t,[{key:"request",value:function(e,t){var n=this.byteCount+e*this._formatByte,i=this.indicesCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;var c=new Float32Array(this.vData.buffer);this.vData=new Float32Array(a),this.vData.set(c,0);var l=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(s),this.iData.set(l,0)}return this.vertexCount+=e,this.indicesCount+=t,this.byteCount=n,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0}}]),t}(nd)),new ge((function(){return{x:0,y:0,z:0,u:0,v:0,color:ye.WHITE.clone()}}),128)),od=new mt((function(){return new id}),32),ad={parent:null,owner:null,subModelIdx:0},sd=e("d3",(lh=E("cc.RenderableComponent"),uh=F([$c]),_h=F($c),fh=Te(),lh((vh=A((dh=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"_materials",vh,M(n)),I(n,"_visFlags",mh,M(n)),n._materialInstances=[],n._models=[],n}return c(t,e),r(t,[{key:"getMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t){e&&e instanceof nl&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n?n.parent!==this._materials[t]&&(n.destroy(),this._materialInstances[t]=null,this._onMaterialModified(t,this._materials[t])):this._onMaterialModified(t,this._materials[t])}},{key:"getMaterialInstance",value:function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){ad.parent=this._materials[e],ad.owner=this,ad.subModelIdx=e;var t=new nl(ad);this.setMaterialInstance(e,t)}return this._materialInstances[e]}},{key:"setMaterialInstance",value:function(e,t){t&&t.parent?t!==this._materialInstances[e]&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):t!==this._materials[e]&&this.setMaterial(t,e)}},{key:"getRenderMaterial",value:function(e){return this._materialInstances[e]||this._materials[e]}},{key:"_collectModels",value:function(){return this._models}},{key:"_attachToScene",value:function(){}},{key:"_detachFromScene",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisibilityChange",value:function(e){}},{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var n=this._materials.length-t;n<this._materials.length;++n)this.setMaterialInstance(n,null);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=e[i]&&this.setMaterialInstance(i,e[i])}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterialInstance(0,e)}}]),t}(le)).prototype,"_materials",[uh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mh=A(dh.prototype,"_visFlags",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ua.Enum.NONE}}),A(dh.prototype,"sharedMaterials",[_h,fh],Object.getOwnPropertyDescriptor(dh.prototype,"sharedMaterials"),dh.prototype),hh=dh))||hh));a.RenderableComponent=sd;var cd=m({OFF:0,ON:1}),ld=m({OFF:0,ON:1}),ud=(ph=E("cc.ModelLightmapSettings"),gh=Ee("_recieveShadow"),ph((Sh=A((xh=function(){function e(){o(this,e),I(this,"texture",Sh,this),I(this,"uvParam",Ch,this),I(this,"_bakeable",Th,this),I(this,"_castShadow",Eh,this),I(this,"_receiveShadow",Ah,this),I(this,"_lightmapSize",bh,this)}return r(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}()).prototype,"texture",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ch=A(xh.prototype,"uvParam",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v}}),Th=A(xh.prototype,"_bakeable",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Eh=A(xh.prototype,"_castShadow",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ah=A(xh.prototype,"_receiveShadow",[gh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bh=A(xh.prototype,"_lightmapSize",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),A(xh.prototype,"bakeable",[w],Object.getOwnPropertyDescriptor(xh.prototype,"bakeable"),xh.prototype),A(xh.prototype,"castShadow",[w],Object.getOwnPropertyDescriptor(xh.prototype,"castShadow"),xh.prototype),A(xh.prototype,"receiveShadow",[w],Object.getOwnPropertyDescriptor(xh.prototype,"receiveShadow"),xh.prototype),A(xh.prototype,"lightmapSize",[w],Object.getOwnPropertyDescriptor(xh.prototype,"lightmapSize"),xh.prototype),yh=xh))||yh),_d=(e("as",(wh=E("cc.MeshRenderer"),Ih=he(),Rh=ht(100),Oh=de(),Ph=F(cd),Nh=me(),Dh=F(ld),zh=me(),Mh=F(rs),Lh=me(),Fh=Ae(),wh(kh=Ih(kh=Rh(kh=Oh(kh=fe((Wh=qh=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),I(e,"lightmapSettings",Bh,M(e)),I(e,"_mesh",Gh,M(e)),I(e,"_shadowCastingMode",jh,M(e)),I(e,"_shadowReceivingMode",Vh,M(e)),e._modelType=void 0,e._model=null,e._morphInstance=null,I(e,"_enableMorph",Hh,M(e)),e._modelType=T_,e}return c(t,e),r(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t,n=this._mesh;this._mesh=e,null===(t=this._mesh)||void 0===t||t.initialize(),this._watchMorphInMesh(),this._onMeshChanged(n),this._updateModels(),this.enabledInHierarchy&&this._attachToScene()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),r(t,[{key:"onLoad",value:function(){var e;null===(e=this._mesh)||void 0===e||e.initialize(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onRestore",value:function(){this._updateModels()}},{key:"onEnable",value:function(){this._model||this._updateModels(),this._attachToScene()}},{key:"onDisable",value:function(){this._model&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(a.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}},{key:"setWeights",value:function(e,t){this._morphInstance&&this._morphInstance.setWeights(t,e)}},{key:"setInstancedAttribute",value:function(e,t){if(this.model)for(var n=this.model.instancedAttributes.list,i=0;i<n.length;i++)if(n[i].name===e){n[i].view.set(t);break}}},{key:"_updateLightmap",value:function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()}},{key:"_updateModels",value:function(){this.enabledInHierarchy&&this._mesh&&(this._model?(this._model.destroy(),this._model.initialize(this.node)):this._createModel(),this._updateModelParams(),this._onUpdateLightingmap())}},{key:"_createModel",value:function(){var e=!!this._morphInstance&&this._modelType===T_?E_:this._modelType;this._model=a.director.root.createModel(e),this._model.visFlags=this.visibility,this._model.initialize(this.node),this._models.length=0,this._models.push(this._model),this._morphInstance&&this._model instanceof E_&&this._model.setMorphRendering(this._morphInstance)}},{key:"_attachToScene",value:function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!=this._model.scene&&this._detachFromScene(),e.addModel(this._model)}}},{key:"_detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=Kl.POSITION,this._model.transform.hasChangedFlags|=Kl.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.subMeshCount:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n),r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._model.enabled=!0}}},{key:"_onUpdateLightingmap",value:function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}},{key:"_onMaterialModified",value:function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)}},{key:"_getBuiltinMaterial",value:function(){return js.get("missing-material")}},{key:"_onVisibilityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===cd.OFF?this._model.castShadow=!1:(V(this._shadowCastingMode===cd.ON,"ShadowCastingMode ".concat(this._shadowCastingMode," is not supported.")),this._model.castShadow=!0))}},{key:"_updateReceiveShadow",value:function(){this._model&&(this._shadowReceivingMode===ld.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}},{key:"_isBatchingEnabled",value:function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n){if(t.passes[n].batchingScheme)return!0}}return!1}},{key:"_watchMorphInMesh",value:function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){var e=this._mesh.struct.morph;this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,n=0;n<t;++n){var i=e.subMeshMorphs[n];if(i){var r=i.weights||e.weights,o=r?r.slice():new Array(i.targets.length).fill(0);this._morphInstance.setWeights(n,o)}}this._model&&this._model instanceof E_&&this._model.setMorphRendering(this._morphInstance)}}},{key:"_syncMorphWeights",value:function(e){if(this._morphInstance){var t=this._morphInstance[e];t&&t.renderResources&&t.renderResources.setWeights(t.weights)}}}]),t}(sd),qh.ShadowCastingMode=cd,qh.ShadowReceivingMode=ld,Bh=A((Uh=Wh).prototype,"lightmapSettings",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ud}}),Gh=A(Uh.prototype,"_mesh",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jh=A(Uh.prototype,"_shadowCastingMode",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cd.OFF}}),Vh=A(Uh.prototype,"_shadowReceivingMode",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ld.ON}}),A(Uh.prototype,"shadowCastingMode",[Ph,Nh],Object.getOwnPropertyDescriptor(Uh.prototype,"shadowCastingMode"),Uh.prototype),A(Uh.prototype,"receiveShadow",[Dh,zh],Object.getOwnPropertyDescriptor(Uh.prototype,"receiveShadow"),Uh.prototype),A(Uh.prototype,"mesh",[Mh,Lh],Object.getOwnPropertyDescriptor(Uh.prototype,"mesh"),Uh.prototype),A(Uh.prototype,"enableMorph",[Fh],Object.getOwnPropertyDescriptor(Uh.prototype,"enableMorph"),Uh.prototype),Hh=A(Uh.prototype,"_enableMorph",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kh=Uh))||kh)||kh)||kh)||kh)||kh)),new s);function fd(e,t,n,i){i||(i=new s),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function hd(e,t,n){return n||(n=new s),e.worldToScreen(t,n),n.x=n.x/a.view.getScaleX(),n.y=n.y/a.view.getScaleY(),n}var dd=e("aL",{WorldNode3DToLocalNodeUI:fd,WorldNode3DToWorldNodeUI:hd});a.pipelineUtils=dd,C(a.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||_d;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]);var vd,md,pd,gd,yd,xd,Sd,Cd=Object.freeze({__proto__:null,ccclass:E,property:i,requireComponent:ft,executionOrder:ht,disallowMultiple:dt,executeInEditMode:fe,menu:de,playOnFocus:be,inspector:we,icon:Ie,help:he,type:F,integer:Re,float:Oe,boolean:Pe,string:Ne});e("aM",Cd);var Td=E("cc.MissingClass")((pd=A((md=function e(){o(this,e),I(this,"_$erialized",pd,this)}).prototype,"_$erialized",[b,De],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vd=md))||vd,Ed=e("d0",E("cc.MissingScript")(gd=we()((xd=A((yd=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),I(e,"compiled",xd,M(e)),I(e,"_$erialized",Sd,M(e)),e}return c(t,e),r(t,null,[{key:"safeFindClass",value:function(e,n){var i=Me(e);return i||(e?(a.deserialize.reportMissingClass(e),t.getMissingWrapper(e,n)):null)}},{key:"getMissingWrapper",value:function(e,n){return n.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||ze.test(e))?t:Td}}]),r(t,[{key:"onLoad",value:function(){G(4600,this.node.name)}}]),t}(le)).prototype,"compiled",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Sd=A(yd.prototype,"_$erialized",[b,De],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gd=yd))||gd)||gd);a._MissingScript=Ed;var Ad=function(){function e(){o(this,e),this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=Be(!0)}return r(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,Fe(this._stillUseUrl)}},{key:"push",value:function(e,t,n,i){i&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(n),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();Ad.pool=void 0,Ad.pool=new Le((function(e){e.reset()}),10),Ad.pool.get=function(){return this._get()||new Ad};function bd(e,t,n,i,r){var o;i.hasOwnProperty("__deserialize__")?o=i.__deserialize__:(o=function(e,t){var n,i=ze.test(Ve(t)),r=a.js.isChildClassOf(t,a._BaseNode)||a.js.isChildClassOf(t,a.Component),o=[],s=o,c=[],l=c,u=[],_=[];return function(){var e=t.__values__;n="_$erialized"===e[e.length-1];for(var r=ke(t),f=Ge+"type",h=Ge+"default",d=Ge+"saveUrlAsAsset",v=Ge+"formerlySerializedAs",m=0;m<e.length;m++){var g=e[m],y=g;r[g+v]&&(y=r[g+v]);var x=r[g+d],S=p.getDefault(r[g+h]),C=!1;if(i){var T=r[g+f];if(void 0===S&&T)C=T===a.String||T===a.Integer||T===a.Float||T===a.Boolean;else{var E=ae(S);C="string"===E&&!x||"number"===E||"boolean"===E}}i&&C?(y!==g&&s===o&&(s=o.slice()),o.push(g),s!==o&&s.push(y)):(y!==g&&l===c&&(l=c.slice()),c.push(g),l!==c&&l.push(y),u.push(x),_.push(S instanceof a.ValueType&&S.constructor))}}(),function(e,t,a,f,h){for(var d=0;d<o.length;++d){var v=a[s[d]];void 0!==v&&(t[o[d]]=v)}for(var m=0;m<c.length;++m){var p=c[m],g=a[l[m]];if(void 0!==g)if(i||"object"===ae(g)){var y=_[m];y?i||g?e._deserializeTypedObject(t[p],g,y):t[p]=null:g?e._deserializeObjField(t,g,p,null,u[m]):t[p]=null}else t[p]=g}r&&a._id&&(t._id=a._id),n&&(t._$erialized=JSON.parse(JSON.stringify(a)),e._deserializePrimitiveObject(t._$erialized,a))}}(0,i),je(i,"__deserialize__",o,!0)),o(e,t,n,i,r)}var wd=function(){function e(t,n,i,r,a){o(this,e),this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=t,this.customEnv=r,this.deserializedList=[],this.deserializedData=null,this._classFinder=i,this._idList=[],this._idObjList=[],this._idPropList=[]}return r(e,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,n=t.length;this.deserializedList.length=n;for(var i=0;i<n;i++)t[i]&&(this.deserializedList[i]=this._deserializeObject(t[i],!1));this.deserializedData=n>0?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){var t,n,i,r=e.deserializedList,o=e._idPropList,a=e._idList,s=e._idObjList;for(e._classFinder&&e._classFinder.onDereferenced,t=0;t<a.length;t++)n=o[t],i=a[t],s[t][n]=r[i]}(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,t,n,i,r){var o,s=null,c=null,l=e.__type__;if("TypedArray"===l){var u=e.array;s=new window[e.ctor](u.length);for(var _=0;_<u.length;++_)s[_]=u[_];return s}if(l){if(!(c=this._classFinder(l,e,i,r)))return this._classFinder===Me&&a.deserialize.reportMissingClass(l),null;var f=this;(s=new c)._deserialize?s._deserialize(e.content,f):a.Class._isCCClass(c)?bd(f,s,e,c,n):f._deserializeTypedObject(s,e,c)}else if(Array.isArray(e)){s=new Array(e.length);for(var h=0;h<e.length;h++)o=e[h],"object"===ae(o)&&o?this._deserializeObjField(s,o,""+h,null,t):s[h]=o}else s={},this._deserializePrimitiveObject(s,e);return s}},{key:"_deserializeObjField",value:function(e,t,n,i,r){var o=t.__id__;if(void 0===o){var a=t.__uuid__;a?this.result.push(e,n,a,r):e[n]=this._deserializeObject(t,r)}else{var s=this.deserializedList[o];s?e[n]=s:(this._idList.push(o),this._idObjList.push(e),this._idPropList.push(n))}}},{key:"_deserializePrimitiveObject",value:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!==ae(i)?"__type__"!==n&&(e[n]=i):i?this._deserializeObjField(e,i,n):e[n]=null}}},{key:"_deserializeTypedObject",value:function(e,t,n){if(n===a.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===a.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==a.Color){if(n===a.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var i=Ge+"default",r=ke(n),o=n.__props__||Object.keys(e),s=0;s<o.length;s++){var c=o[s],l=t[c];void 0!==l&&t.hasOwnProperty(c)||(l=p.getDefault(r[c+i])),"object"!==ae(l)?e[c]=l:l?this._deserializeObjField(e,l,c):e[c]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var u=t.a;e.a=void 0===u?255:u}}}]),e}();function Id(e,t,n){var i=(n=n||{}).classFinder||Me,r=n.createAssetRefs||a.sys.platform===a.sys.EDITOR_CORE,o=Ue,s=n.customEnv,c=n.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var l=!t;t=t||Ad.pool.get();var u=wd.pool.get(t,o,i,s,c);a.game._isCloning=!0;var _=u.deserialize(e);return a.game._isCloning=!1,wd.pool.put(u),r&&t.assignAssetsBy(EditorExtends.serialize.asAsset),l&&Ad.pool.put(t),_}wd.pool=void 0,wd.pool=new Le((function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0}),1),wd.pool.get=function(e,t,n,i,r){var o=this._get();return o?(o.result=e,o.customEnv=i,o._classFinder=n,o):new wd(e,t,n,i,r)},Id.Details=Ad,Id.reportMissingClass=function(e){G(5302,e)},a.deserialize=Id;var Rd,Od,Pd,Nd,Dd,zd,Md,Ld,Fd,kd,Ud,Bd=te.Flags.Destroyed,Gd=te.Flags.PersistentMask,jd=[];function Vd(e,t){var n;if(e instanceof te){if(e._instantiate)return a.game._isCloning=!0,n=e._instantiate(),a.game._isCloning=!1,n;if(e instanceof a.Asset)throw new TypeError(se(6903))}return a.game._isCloning=!0,n=Hd(e),a.game._isCloning=!1,n}function Hd(e,t){var n;if(e._iN$t)n=e._iN$t;else if(e.constructor){n=new(0,e.constructor)}else n=Object.create(null);qd(e,n,t);for(var i=0,r=jd.length;i<r;++i)jd[i]._iN$t=null;return jd.length=0,n}function qd(e,t,n){je(e,"_iN$t",t,!0),jd.push(e);var i=e.constructor;if(a.Class._isCCClass(i))!function(e,t,n,i){for(var r=e.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];if("object"===ae(s)&&s){var c=n[a];c instanceof He&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||Wd(s,i)}else n[a]=s}}(i,e,t,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var o=e[r];if("object"===ae(o)&&o){if(o===t)continue;t[r]=o._iN$t||Wd(o,n)}else t[r]=o}e instanceof te&&(t._objFlags&=Gd)}function Wd(e,t){if(e instanceof He)return e.clone();if(e instanceof a.Asset)return e;var n;if(Array.isArray(e)){var i=e.length;n=new Array(i),e._iN$t=n;for(var r=0;r<i;++r){var o=e[r];"object"===ae(o)&&o?n[r]=o._iN$t||Wd(o,t):n[r]=o}return jd.push(e),n}if(e._objFlags&Bd)return null;var s=e.constructor;if(a.Class._isCCClass(s)){if(t)if(t instanceof a.Component){if(e instanceof a._BaseNode||e instanceof a.Component)return e}else if(t instanceof a._BaseNode)if(e instanceof a._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof a.Component&&!e.node.isChildOf(t))return e;n=new s}else if(s===Object)n={};else{if(s)return e;n=Object.create(null)}return qd(e,n,t),n}Vd._clone=Hd,a.instantiate=Vd,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(kd||(kd={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(Ud||(Ud={}));function Xd(e,t){return(t<<3)+e}e("aP",E("cc.CompactValueTypeArray")((Ld=Md=function(){function e(){o(this,e),I(this,"_byteOffset",Pd,this),I(this,"_unitCount",Nd,this),I(this,"_unitElement",Dd,this),I(this,"_length",zd,this)}return r(e,[{key:"decompress",value:function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=Yd(n.elementType),o=new(Kd(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a}}],[{key:"lengthFor",value:function(e,t,n){return Yd(t).requiredUnits*e.length*Kd(n).BYTES_PER_ELEMENT}},{key:"compress",value:function(t,n,i,r,o,a){for(var s=Yd(n),c=Kd(i),l=s.requiredUnits*t.length,u=new c(r,o,l),_=0;_<t.length;++_)s.compress(u,_,t[_]);var f=new e;return f._unitElement=Xd(i,n),f._byteOffset=a,f._unitCount=l,f._length=t.length,f}}]),e}(),Md.StorageUnit=kd,Md.ElementType=Ud,Pd=A((Od=Ld).prototype,"_byteOffset",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nd=A(Od.prototype,"_unitCount",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dd=A(Od.prototype,"_unitElement",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xd(kd.Uint8,Ud.Scalar)}}),zd=A(Od.prototype,"_length",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rd=Od))||Rd);function Yd(e){return Qd[e]}function Kd(e){switch(e){case kd.Uint8:return Uint8Array;case kd.Uint16:return Uint16Array;case kd.Uint32:return Uint32Array;case kd.Int8:return Int8Array;case kd.Int16:return Int16Array;case kd.Int32:return Int32Array;case kd.Float32:return Float32Array;case kd.Float64:return Float64Array}}var Qd=(R(Fd={},Ud.Scalar,{requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}}),R(Fd,Ud.Vec2,{requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new s(e[2*t],e[2*t+1])}}),R(Fd,Ud.Vec3,{requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new s(e[3*t],e[3*t+1],e[3*t+2])}}),R(Fd,Ud.Vec4,{requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new v(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),R(Fd,Ud.Quat,{requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new W(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),R(Fd,Ud.Mat4,{requiredUnits:16,compress:function(e,t,n){f.toArray(e,n,16*t)},decompress:function(e,t){return f.fromArray(new f,e,16*t)}}),Fd);function Jd(e){var t=[];return function e(t,n){for(var i,r=N(n);!(i=r()).done;){var o=i.value;Array.isArray(o)?e(t,o):t.push(o)}}(t,e),t.join("")}a._decorator=Cd;var Zd=te.Flags.Destroyed,$d=te.Flags.PersistentMask,ev=Ge+"default",tv=p.IDENTIFIER_RE,nv={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},iv=p.escapeForJS,rv=function(){function e(t,n){o(this,e),this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=n}return r(e,[{key:"toString",value:function(){return"var "+this.varName+"="+this.expression+";"}}]),e}();function ov(e,t){return t instanceof rv?new rv(t.varName,e+t.expression):e+t}function av(e,t,n){Array.isArray(n)?(n[0]=ov(t,n[0]),e.push(n)):e.push(ov(t,n)+";")}var sv=function(){function e(t){o(this,e),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}return r(e,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];av(e,t+cv(i[0])+"=",i[1])}}}]),e}();function cv(e){return tv.test(e)?"."+e:"["+iv(e)+"]"}sv.pool=void 0,sv.pool=new Le((function(e){e._exps.length=0,e._targetExp=null}),1),sv.pool.get=function(e){var t=this._get()||new sv;return t._targetExp=e,t};var lv,uv,_v,fv,hv,dv,vv,mv=function(){function e(t,n){var i;o(this,e),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=n,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Be(),re(this.funcModuleCache,nv),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(i="var "+this.globalVariables.join(",")+";");var r=Jd(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",r)(this.objs,this.funcs);for(var a=0,s=this.objsToClear_iN$t.length;a<s;++a)this.objsToClear_iN$t[a]._iN$t=null;this.objsToClear_iN$t.length=0}return r(e,[{key:"getFuncModule",value:function(e,t){var n=qe(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var o=this.funcs.indexOf(e);o<0&&(o=this.funcs.length,this.funcs.push(e));var a="F["+o+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,n,i){var r=sv.pool.get(i),o=t.constructor.__props__;o||(o=Object.keys(t));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),sv.pool.put(r)}},{key:"enumerateCCClass",value:function(e,t,n){for(var i=n.__values__,r=ke(n),o=0;o<i.length;o++){var s=i[o],c=t[s],l=r[s+ev];if(!pv(l,c))if("object"===ae(c)&&c instanceof a.ValueType&&(l=p.getDefault(l))&&l.constructor===c.constructor){var u="o"+cv(s);this.setValueType(e,l,c,u)}else this.setObjProp(e,t,s,c)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new rv(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i){av(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]))}return n}},{key:"enumerateField",value:function(e,t,n){if("object"===ae(n)&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=ov(r+"=",o)}return r}return Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?iv(n):("_objFlags"===t&&e instanceof te&&(n&=$d),n)}},{key:"setObjProp",value:function(e,t,n,i){av(e,"o"+cv(n)+"=",this.enumerateField(t,n,i))}},{key:"enumerateObject",value:function(e,t){var n=t.constructor;if(a.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=t[i];"object"===ae(r)&&r&&r===t._iN$t||this.setObjProp(e,t,i,r)}}},{key:"instantiateObj",value:function(e){if(e instanceof a.ValueType)return p.getNewValueTypeCode(e);if(e instanceof a.Asset)return this.getObjRef(e);if(e._objFlags&Zd)return null;var t,n=e.constructor;if(a.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof a.Component){if(e instanceof a._BaseNode||e instanceof a.Component)return this.getObjRef(e)}else if(this.parent instanceof a._BaseNode)if(e instanceof a._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof a.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new rv("o","new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new rv("o","{}");else{if(n)return this.getObjRef(e);t=new rv("o","Object.create(null)")}var i=[t];return e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e),this.enumerateObject(i,e),["(function(){",i,"return o;})();"]}}]),e}();function pv(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof a.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}var gv,yv,xv,Sv,Cv=m({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Tv=e("aR",E("cc.Prefab")((vv=dv=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),I(e,"data",_v,M(e)),I(e,"optimizationPolicy",fv,M(e)),I(e,"asyncLoadAssets",hv,M(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return c(t,e),r(t,[{key:"createNode",value:function(e){var t=a.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){var e,t;this._createFunction=(e=this.data,t=e instanceof a._BaseNode&&e,new mv(e,t).result)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:G(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e;return this.data._prefab._synced=!0,e=this.data._instantiate(),++this._instantiatedTimes,e}}]),t}(D),dv.OptimizationPolicy=Cv,dv.OptimizationPolicyThreshold=3,_v=A((uv=vv).prototype,"data",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fv=A(uv.prototype,"optimizationPolicy",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cv.AUTO}}),hv=A(uv.prototype,"asyncLoadAssets",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lv=uv))||lv);a.Prefab=Tv,We(a,"cc._Prefab","Prefab");var Ev,Av,bv,wv=e("aS",E("cc.SceneAsset")((xv=A((yv=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"scene",xv,M(n)),I(n,"asyncLoadAssets",Sv,M(n)),n}return c(t,e),t}(D)).prototype,"scene",[w,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sv=A(yv.prototype,"asyncLoadAssets",[w,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gv=yv))||gv);a.SceneAsset=wv;var Iv,Rv,Ov,Pv=e("aT",E("cc.SpriteAtlas")((bv=A((Av=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"spriteFrames",bv,M(n)),n}return c(t,e),r(t,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e}},{key:"_serialize",value:function(e){for(var t=[],n=0,i=Object.keys(this.spriteFrames);n<i.length;n++){var r=i[n],o=this.spriteFrames[r],a=o?o._uuid:"";a&&e&&(a=EditorExtends.UuidUtils.compressUuid(a,!0)),t.push(r),t.push(a)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=Be();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1])}}]),t}(D)).prototype,"spriteFrames",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Be()}}),Ev=Av))||Ev);a.SpriteAtlas=Pv;var Nv,Dv,zv,Mv=e("aU",E("cc.TextAsset")((Ov=A((Rv=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"text",Ov,M(n)),n}return c(t,e),r(t,[{key:"toString",value:function(){return this.text}}]),t}(D)).prototype,"text",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Iv=Rv))||Iv);a.TextAsset=Mv;var Lv=e("aV",E("cc.JsonAsset")((zv=A((Dv=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"json",zv,M(n)),n}return c(t,e),t}(D)).prototype,"json",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nv=Dv))||Nv);a.JsonAsset=Lv;var Fv="0123456789abcdef".split(""),kv=["","","",""],Uv=kv.concat(kv,"-",kv,"-",kv,"-",kv,"-",kv,kv,kv),Bv=Uv.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function Gv(e){var t=e.split("@")[0];if(22!==t.length)return e;Uv[0]=e[0],Uv[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=Xe[e.charCodeAt(n)],o=Xe[e.charCodeAt(n+1)];Uv[Bv[i++]]=Fv[r>>2],Uv[Bv[i++]]=Fv[(3&r)<<2|o>>4],Uv[Bv[i++]]=Fv[15&o]}return e.replace(t,Uv.join(""))}var jv=e("cP",{_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=a.loader._getResUuid(e.slice(10),a.Asset,null,!0);if(t)return a.AssetLibrary.getLibUrlNoExt(t,!0)+Ct(e)}else L(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=Rt(e)+"/"}});a.url=jv;var Vv=function e(t,n){o(this,e),this.uuid=void 0,this.type=void 0,this.uuid=t,this.type=n};function Hv(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}var qv,Wv=function(){function e(){o(this,e),this._pathToUuid=void 0,this._pathToUuid=Be(!0)}return r(e,[{key:"getUuid",value:function(e,t){e=jv.normalize(e);var n=this._pathToUuid[e];if(n)if(Array.isArray(n)){if(!t)return n[0].uuid;for(var i=0;i<n.length;i++){var r=n[i];if(ce(r.type,t))return r.uuid}}else if(!t||ce(n.type,t))return n.uuid;return""}},{key:"getUuidArray",value:function(e,t,n){"/"===(e=jv.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var i=this._pathToUuid,r=[];for(var o in i)if(o.startsWith(e)&&Hv(o,e)||!e){var a=i[o];if(Array.isArray(a))for(var s=0;s<a.length;s++){var c=a[s];t&&!ce(c.type,t)||(r.push(c.uuid),n&&n.push(o))}else t&&!ce(a.type,t)||(r.push(a.uuid),n&&n.push(o))}return r}},{key:"add",value:function(e,t,n,i){i&&(e=e.substring(0,e.length-Ct(e).length));var r=new Vv(t,n);Ye(this._pathToUuid,e,r,i)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var n=this._pathToUuid,i=Object.keys(n),r=0;r<i.length;++r){var o=i[r],a=n[o];if(Array.isArray(a))for(var s=0;s<a.length;s++){var c=a[s];if(c.uuid===e)return t.path=o,t.type=c.type,!0}else if(a.uuid===e)return t.path=o,t.type=a.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=Be(!0)}}]),e}(),Xv=0|998*Math.random(),Yv=Be(!0),Kv=[];!function(e){e[e.WORKING=0]="WORKING",e[e.COMPLETE=1]="COMPLETE",e[e.ERROR=2]="ERROR"}(qv||(qv={}));var Qv=Be(!0);function Jv(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var n={};return t[1].split("&").forEach((function(e){var t=e.split("=");n[t[0]]=t[1]})),n}}}function Zv(e,t){var n="object"===ae(e)?e.url:e,i={queueId:t,id:n,url:n,rawUrl:void 0,urlParam:Jv(n),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:e.uuid&&a.game._sceneInfos.find((function(t){return t.uuid===e.uuid}))};if("object"===ae(e)&&(re(i,e),e.skips))for(var r=0;r<e.skips.length;r++){var o=e.skips[r];i.states[o]=qv.COMPLETE}return i.rawUrl=i.url,n&&!i.type&&(i.type=Ct(n).toLowerCase().substr(1)),i}var $v=[];function em(e,t,n){if(!e||!t)return!1;var i=!1;if($v.push(t.id),t.deps){var r,o,a=t.deps;for(r=0;r<a.length;r++){if((o=a[r]).id===e.id){i=!0;break}if(!($v.indexOf(o.id)>=0)&&(o.deps&&em(e,o,!0))){i=!0;break}}}return n||($v.length=0),i}var tm=e("cU",function(e){function t(e,n,i,r){var a;return o(this,t),(a=l(this,u(t).call(this))).onProgress=void 0,a.onComplete=void 0,a.map=Be(!0),a.completed={},a.totalCount=0,a.completedCount=0,a.active=void 0,a._id=void 0,a._pipeline=void 0,a._errorUrls=[],a._appending=!1,a._ownerQueue=null,a._id=++Xv,Yv[a._id]=M(a),a._pipeline=e,a.onProgress=i,a.onComplete=r,a._pipeline?a.active=!0:a.active=!1,n&&(n.length>0?a.append(n):a.allComplete()),a}return c(t,e),r(t,[{key:"append",value:function(e,n){var i=this;if(!this.active)return[];n&&!n.deps&&(n.deps=[]),this._appending=!0;var r,o,a,s,c=[];for(r=0;r<e.length;++r){if((o=e[r]).queueId&&!this.map[o.id]){if(this.map[o.id]=o,n&&n.deps.push(o),o.complete||em(n,o)){this.totalCount++,this.itemComplete(o.id);continue}if("continue"===function(){var e=i,r=Yv[o.queueId];return r&&(i.totalCount++,t.registerQueueDep(n||i._id,o.id),r.addListener(o.id,(function(t){e.itemComplete(t.id)}))),"continue"}())continue}if("string"==typeof((s=o).url||s)){var l=(a=Zv(o,this._id)).id;this.map[l]||(this.map[l]=a,this.totalCount++,n&&n.deps.push(a),t.registerQueueDep(n||this._id,l),c.push(a))}}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(c),c}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=Qv[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],n=null;return t&&(t.content?n=t.content:t.alias&&(n=t.alias.content)),n}},{key:"getError",value:function(e){var t=this.map[e],n=null;return t&&(t.error?n=t.error:t.alias&&(n=t.alias.error)),n}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var n=this.map[e];if(n){var i=this._errorUrls.indexOf(e);if(n.error&&-1===i?this._errorUrls.push(e):n.error||-1===i||this._errorUrls.splice(i,1),t.finishDep(n.id),this.emit(e,n),this.removeAll(e),this.completed[e]=n,this.completedCount++,this.onProgress){var r=Qv[this._id];this.onProgress(r?r.completed.length:this.completedCount,r?r.deps.length:this.totalCount,n)}!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=void 0,this.onComplete=void 0,this.map=Be(!0),this.completed={},this.totalCount=0,this.completedCount=0,this.clear(),Yv[this._id]=null,Qv[this._id]&&(Qv[this._id].completed.length=0,Qv[this._id].deps.length=0),-1===Kv.indexOf(this)&&Kv.length<10&&Kv.push(this)}},{key:"addListener",value:function(e,n,i){return P(u(t.prototype),"on",this).call(this,e,n,i)}},{key:"hasListener",value:function(e,n,i){return P(u(t.prototype),"hasEventListener",this).call(this,e,n,i)}},{key:"removeListener",value:function(e,n,i){return P(u(t.prototype),"off",this).call(this,e,n,i)}},{key:"removeAllListeners",value:function(e){P(u(t.prototype),"removeAll",this).call(this,e)}}],[{key:"create",value:function(e,n,i,r){void 0===i?"function"==typeof n&&(r=n,n=i=null):void 0===r&&("function"==typeof n?(r=i,i=n,n=null):(r=i,i=null));var o=Kv.pop();return o?(o._pipeline=e,o.onProgress=i,o.onComplete=r,Yv[o._id]=o,o._pipeline&&(o.active=!0),n&&o.append(n)):o=new t(e,n,i,r),o}},{key:"getQueue",value:function(e){return e.queueId?Yv[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=Yv[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=Qv[e._id];t?(t.completed.length=0,t.deps.length=0):t=Qv[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var n=e.queueId||e;if(!n)return!1;var i=Qv[n];if(i)-1===i.deps.indexOf(t)&&i.deps.push(t);else if(e.id)for(var r in Qv){var o=Qv[r];-1!==o.deps.indexOf(e.id)&&-1===o.deps.indexOf(t)&&o.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in Qv){var n=Qv[t];-1!==n.deps.indexOf(e)&&-1===n.completed.indexOf(e)&&n.completed.push(e)}}}]),t}(ne));tm.ItemState=new a.Enum(qv),a.LoadingItems=tm;var nm=tm.ItemState;function im(e,t){var n=e.id,i=t.states[n],r=e.next,o=e.pipeline;if(!t.error&&i!==nm.WORKING&&i!==nm.ERROR)if(i===nm.COMPLETE)r?im(r,t):o.flowOut(t);else{t.states[n]=nm.WORKING;var a=e.handle(t,(function(e,i){e?(t.error=e,t.states[n]=nm.ERROR,o.flowOut(t)):(i&&(t.content=i),t.states[n]=nm.COMPLETE,r?im(r,t):o.flowOut(t))}));a instanceof Error?(t.error=a,t.states[n]=nm.ERROR,o.flowOut(t)):void 0!==a&&(null!==a&&(t.content=a),t.states[n]=nm.COMPLETE,r?im(r,t):o.flowOut(t))}}var rm=e("cS",function(){function e(t){o(this,e),this._pipes=void 0,this._cache=Be(!0),this._pipes=t;for(var n=0;n<t.length;++n){var i=t[n];i.handle&&i.id&&(i.pipeline=this,i.next=n<t.length-1?t[n+1]:null)}}return r(e,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)G(4921);else if(this._pipes.indexOf(e)>0)G(4922);else{e.pipeline=this;var n=null;t<this._pipes.length&&(n=this._pipes[t]);var i=null;t>0&&(i=this._pipes[t-1]),i&&(i.next=e),e.next=n,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var n=this._pipes.indexOf(e);n<0||this.insertPipe(t,n+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,this._pipes.length>0&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,n,i=this._pipes[0];if(i){for(t=0;t<e.length;t++)(n=e[t]).isScene||(this._cache[n.id]=n);for(t=0;t<e.length;t++)im(i,n=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,n){return tm.create(this,(function(e,t){n(e,t),t.destroy()})).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,tm.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var n=0;n<t.length;++n)t[n].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t?(t.alias&&(t=t.alias),t):t}},{key:"removeItem",value:function(e){var t=this._cache[e];return t&&t.complete&&delete this._cache[e],t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),e}());rm.ItemState=nm,a.Pipeline=rm;var om="MD5Pipe",am=/(\.[^.\n\\/]*)$/,sm=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var cm=function(){function e(t,n,i){o(this,e),this.id=om,this.async=!1,this.pipeline=null,this.md5AssetsMap=void 0,this.md5NativeAssetsMap=void 0,this.libraryBase=void 0,this.id=om,this.async=!1,this.pipeline=null,this.md5AssetsMap=t,this.md5NativeAssetsMap=n,this.libraryBase=i}return r(e,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var n=function(e){var t=e.match(sm);return t?t[1]:""}(e);if(n){var i=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[n];if(i)if(t){var r=a.path.dirname(e),o=a.path.basename(e);e="".concat(r,".").concat(i,"/").concat(o)}else{var s=!1;e=e.replace(am,(function(e,t){return s=!0,"."+i+t})),s||(e=e+"."+i)}}return e}}]),e}();cm.ID=om,rm.MD5Pipe=cm;var lm,um=function(){function e(){o(this,e),this.jsons={}}return r(e,[{key:"load",value:function(e,t){t.length!==e.length&&L(4915);for(var n=0;n<e.length;n++){var i=e[n],r=t[n];this.jsons[i]=r}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),_m=function(){function e(){o(this,e),this.contents={}}return r(e,[{key:"load",value:function(e,t){var n=t.data;n.length!==e.length&&L(4915);for(var i=0;i<e.length;i++)this.contents[e[i]]={base:n[i][0],mipmaps:n[i][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:Ke._getClassId(ca),content:t}:null}}]),e}(),fm=/\?/;function hm(e){return a.game.config.noCache&&"string"==typeof e&&(fm.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function dm(e,t){if(Array.isArray(e))for(var n=0,i=e.length;n<i;n++)dm(e[n],t);else if("object"===ae(e))for(var r in e)dm(e[r],t),Number.isNaN(Number(r))||(e[t[r]]=e[r],delete e[r]);return null}!function(e){e[e.Invalid=0]="Invalid",e[e.Removed=1]="Removed",e[e.Downloading=2]="Downloading",e[e.Loaded=3]="Loaded"}(lm||(lm={}));var vm=function e(){o(this,e),this.unpacker=void 0,this.state=void 0,this.unpacker=null,this.state=lm.Invalid},mm={},pm={},gm={};function ym(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function xm(e){for(var t in pm=e,e)for(var n=e[t],i=0;i<n.length;i++){var r=n[i],o=1===n.length;Ye(mm,r,t,o)}}function Sm(e,t,n){var i=a.AssetLibrary.getLibUrlNoExt(t)+".json";a.loader.load({url:i,ignoreMaxConcurrency:!0},(function(i,r){if(i)return L(4916,e),n(i);var o=Cm(e,t,r);o?n(null,o):n(ym(e,t))}))}function Cm(e,t,n){var i=gm[t];if(i.state!==lm.Loaded){if("string"==typeof n&&(n=JSON.parse(n)),n.keys&&n.data){var r=n.keys;dm(n=n.data,r)}Array.isArray(n)?i.unpacker=new um:n.type===Ve(ca)&&(i.unpacker=new _m),i.unpacker.load(pm[t],n),i.state=lm.Loaded}return i.unpacker.retrieve(e)}function Tm(e){for(var t=lm.Invalid,n="",i=0;i<e.length;i++){var r=e[i],o=gm[r];if(o){var a=o.state;if(a===lm.Loaded)return r;a>t&&(t=a,n=r)}}return t!==lm.Invalid?n:e[0]}function Em(e,t){var n=e.uuid,i=mm[n];if(i){Array.isArray(i)&&(i=Tm(i));var r=gm[i];if(r&&r.state===lm.Loaded){var o=r.unpacker.retrieve(n);return o||ym(n,i)}return r||(console.log("Create unpacker %s for %s",i,n),(r=gm[i]=new vm).state=lm.Downloading),Sm(n,i,t),null}}var Am=Object.freeze({__proto__:null,initPacks:xm,_loadNewPack:Sm,_doPreload:function(e,t){var n=gm[e];n||((n=gm[e]=new vm).state=lm.Downloading),n.state!==lm.Loaded&&(n.unpacker=new um,n.unpacker.load(pm[e],t),n.state=lm.Loaded)},_doLoadNewPack:Cm,_selectLoadedPack:Tm,load:Em}),bm=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var wm=Object.create(null),Im=function(){function e(t){o(this,e),this.id="SubPackPipe",this.async=!1,this.pipeline=null;var n=function(e){var n=t[e];n.uuids&&n.uuids.forEach((function(e){var t=Gv(e),i=t.split("@").map((function(e){return encodeURIComponent(e)}));t=i.join("@"),wm[t]=n.path}))};for(var i in t)n(i)}return r(e,[{key:"handle",value:function(e){return e.url=this.transformURL(e.url),null}},{key:"transformURL",value:function(e){var t=function(e){var t=e.match(bm);return t?t[1]:""}(e);if(t){var n=wm[t];if(n)return e.replace("res/raw-assets/",n+"raw-assets/")}return e}}]),e}();Im.ID="SubPackPipe",rm.SubPackPipe=Im;var Rm="",Om="",Pm=Be(!0);function Nm(e,t){this.url=e,this.type=t}var Dm,zm=e("aW",{_uuidToAsset:{},loadAsset:function(e,t,n){if("string"!=typeof e)return Qe(t,new Error("[AssetLibrary] uuid must be string"),null);var i={uuid:e,type:"uuid"};n&&n.existingAsset&&(i.existingAsset=n.existingAsset),a.loader.load(i,(function(e,n){e||!n?e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(e?e.message:"Unknown error")):(n.constructor,a.SceneAsset),t&&t(e,n)}))},getLibUrlNoExt:function(e,t){var n=(e=Gv(e)).split("@").map((function(e){return encodeURIComponent(e)}));return e=n.join("@"),(t?Om+"assets/":Rm)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){t(new Error("Unable to load resource: EditorExtends is not defined."))},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var n=Pm[e];return n&&!ce(n.type,a.Asset)?(t.url=Om+n.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in Pm},queryAssetInfo:function(e,t){var n=this._getAssetInfoInRuntime(e);t(null,n.url,n.raw)},parseUuidInEditor:function(e){},loadJson:function(e,t){var n=""+((new Date).getTime()+Math.random()),i={uuid:n,type:"uuid",content:e,skips:[a.loader.assetLoader.id,a.loader.downloader.id]};a.loader.load(i,(function(e,i){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else if(function(e){return e&&(e.constructor===a.SceneAsset||e instanceof a.Scene)}(i)){var r=a.loader._getReferenceKey(n);a.loader.removeItem(r)}i._uuid="",t&&t(e,i)}))},getAssetByUuid:function(e){return zm._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),Rm=a.path.stripSep(t)+"/",Om=e.rawAssetsBase;var n=e.md5AssetsMap;if(n&&n.import){var i=0,r=Be(!0),o=n.import;for(i=0;i<o.length;i+=2){var s=Gv(o[i]).split("@").map((function(e){return encodeURIComponent(e)}));r[s.join("@")]=o[i+1]}var c=Be(!0);for(o=n["raw-assets"],i=0;i<o.length;i+=2){var l=Gv(o[i]).split("@").map((function(e){return encodeURIComponent(e)}));c[l.join("@")]=o[i+1]}var u=new cm(r,c,Rm);a.loader.insertPipeAfter(a.loader.assetLoader,u),a.loader.md5Pipe=u}var _=e.subPackages;if(_){a.loader.downloader.setSubPackages(_);var f=new Im(_);a.loader.insertPipeAfter(a.loader.assetLoader,f),a.loader.subPackPipe=f}var h=a.loader._assetTables;for(var d in h)h[d].reset();var v=e.rawAssets;if(v)for(var m in v){var p=v[m];for(var g in p){var y=p[g],x=y[0],S=y[1],C=Me(S);if(C){Pm[g]=new Nm(m+"/"+x,C);var T=1===y[2];h[m]||(h[m]=new Wv),h[m].add(x,g,C,!T)}else ie("Cannot get",S)}}e.packedAssets&&xm(e.packedAssets),a.url._init(e.mountPaths&&e.mountPaths.assets||Om+"assets")}});a.AssetLibrary=zm;var Mm,Lm,Fm,km=e("b1",E("cc.Font")(Dm=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),t}(D))||Dm);a.Font=km;var Um,Bm,Gm,jm,Vm,Hm,qm,Wm,Xm=e("a_",E("cc.TTFFont")((Fm=A((Lm=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"_fontFamily",Fm,M(n)),n}return c(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),t}(km)).prototype,"_fontFamily",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A(Lm.prototype,"_nativeAsset",[vt,Ne],Object.getOwnPropertyDescriptor(Lm.prototype,"_nativeAsset"),Lm.prototype),Mm=Lm))||Mm);a.TTFFont=Xm;var Ym,Km=e("b0",(Um=E("cc.BitmapFont"),Bm=F(zs),Um((Vm=A((jm=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"fntDataStr",Vm,M(n)),I(n,"spriteFrame",Hm,M(n)),I(n,"fontSize",qm,M(n)),I(n,"fntConfig",Wm,M(n)),n}return c(t,e),t}(km)).prototype,"fntDataStr",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hm=A(jm.prototype,"spriteFrame",[Bm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qm=A(jm.prototype,"fontSize",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Wm=A(jm.prototype,"fntConfig",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gm=jm))||Gm));a.BitmapFont=Km;var Qm=e("a$",E("cc.LabelAtlas")(Ym=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),t}(Km))||Ym);a.LabelAtlas=Qm;var Jm=[],Zm=function(){function e(){o(this,e),this.id="AssetLoader",this.async=!0,this.pipeline=null}return r(e,[{key:"handle",value:function(e,t){var n=e.uuid;if(!n)return e.content||null;a.AssetLibrary.queryAssetInfo(n,(function(i,r,o){if(i)t(i);else if(e.url=e.rawUrl=r,e.isRawAsset=o,o){var a=Ct(r).toLowerCase();if(!a)return void t(new Error(se(4931,n,r)));a=a.substr(1);var s=tm.getQueue(e);Jm[0]={queueId:e.queueId,id:r,url:r,type:a,error:null,alias:e,complete:!0},s&&s.append(Jm),e.type=a,t(null,e.content)}else e.type="uuid",t(null,e.content)}))}}]),e}();function $m(e,t){var n=a.loader.getItem(e);if(n){var i=n.dependKeys;if(i)for(var r=0;r<i.length;r++){var o=i[r];t[o]||(t[o]=!0,$m(o,t))}}}function ep(e,t){if(e._uuid){var n=a.loader._getReferenceKey(e);t[n]||(t[n]=!0,$m(n,t))}}function tp(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=e[n[i]];if("object"===ae(r)&&r)if(Array.isArray(r))for(var o=0;o<r.length;o++){var a=r[o];a instanceof Je&&ep(a,t)}else if(r.constructor&&r.constructor!==Object)r instanceof Je&&ep(r,t);else for(var s=Object.getOwnPropertyNames(r),c=0;c<s.length;c++){var l=r[s[c]];l instanceof Je&&ep(l,t)}}}function np(e,t){for(var n=0;n<e._components.length;n++)tp(e._components[n],t);for(var i=0;i<e._children.length;i++)np(e._children[i],t)}function ip(e){var t={};return $m(e,t),Object.keys(t)}function rp(e,t){var n=e.url,i=a.loader.getXMLHttpRequest(),r="Load binary data failed: "+n;i.open("GET",n,!0),i.responseType="arraybuffer",i.onload=function(){var e=i.response;e?t(null,e):t({status:i.status,errorMessage:r+"(no response)"})},i.onerror=function(){t({status:i.status,errorMessage:r+"(error)"})},i.ontimeout=function(){t({status:i.status,errorMessage:r+"(time out)"})},i.send(null)}function op(e,t){var n=e.url;n=hm(n);var i=a.loader.getXMLHttpRequest(),r="Load text file failed: "+n;i.open("GET",n,!0),i.overrideMimeType&&i.overrideMimeType("text/plain; charset=utf-8"),i.onload=function(){4===i.readyState?200===i.status||0===i.status?t(null,i.responseText):t({status:i.status,errorMessage:r+"(wrong status)"}):t({status:i.status,errorMessage:r+"(wrong readyState)"})},i.onerror=function(){t({status:i.status,errorMessage:r+"(error)"})},i.ontimeout=function(){t({status:i.status,errorMessage:r+"(time out)"})},i.send(null)}function ap(){return null}function sp(e,t,n){var i=e.url,r=document,o=document.createElement("script");function a(){o.parentNode&&o.parentNode.removeChild(o),o.removeEventListener("load",a,!1),o.removeEventListener("error",s,!1),t(null,i)}function s(){o.parentNode&&o.parentNode.removeChild(o),o.removeEventListener("load",a,!1),o.removeEventListener("error",s,!1),t(new Error(se(4928,i)))}o.async=!!n,o.src=hm(i),o.addEventListener("load",a,!1),o.addEventListener("error",s,!1),r.body.appendChild(o)}function cp(e,t,n,i){void 0===n&&(n=!0);var r=hm(e.url);function o(){i.removeEventListener("load",o),i.removeEventListener("error",a),i.id=e.id,t(null,i)}function a(){i.removeEventListener("load",o),i.removeEventListener("error",a),"https:"!==window.location.protocol&&i.crossOrigin&&"anonymous"===i.crossOrigin.toLowerCase()?cp(e,t,!1,i):t(new Error(se(4930,r)))}if(i=i||new Image,n&&"file:"!==window.location.protocol?i.crossOrigin="anonymous":i.crossOrigin=null,i.complete&&i.naturalWidth>0&&i.src===r)return i;i.addEventListener("load",o),i.addEventListener("error",a),i.src=r}Zm.ID="AssetLoader",rm.AssetLoader=Zm;var lp={js:sp,png:cp,jpg:cp,bmp:cp,jpeg:cp,gif:cp,ico:cp,tiff:cp,webp:cp,image:cp,pvr:rp,pkm:rp,astc:rp,mp3:Ze,ogg:Ze,wav:Ze,m4a:Ze,txt:op,xml:op,vsh:op,fsh:op,atlas:op,tmx:op,tsx:op,json:op,ExportJson:op,plist:op,fnt:op,font:ap,eot:ap,ttf:ap,woff:ap,svg:ap,ttc:ap,uuid:function(e,t){var n=Em(e,t);return void 0===n?this.extMap.json(e,t):n||void 0},binary:rp,bin:rp,default:op},up=e("cQ",function(){function e(t){o(this,e),this.id="Downloader",this.async=!0,this.pipeline=null,this.extMap=void 0,this._curConcurrent=0,this._loadQueue=[],this._subPackages={},this.extMap=re(t,lp)}return r(e,[{key:"setSubPackages",value:function(e){this._subPackages=e}},{key:"addHandlers",value:function(e){re(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<a.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,t){var n=this,i=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<a.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(r=i.call(this,e,(function(e,i){n._curConcurrent=Math.max(0,n._curConcurrent-1),n._handleLoadQueue(),t&&t(e,i)}))))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(void 0!==(r=i.call(this,e,t)))return r}else this._loadQueue.push({item:e,callback:t})}},{key:"loadSubpackage",value:function(e,t){var n=this._subPackages[e];n?n.loaded?t&&t():sp({url:n.path},(function(e){e||(n.loaded=!0),t&&t(e)})):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),e}());up.ID="Downloader",up.PackDownloader=Am,rm.Downloader=up;var _p=new(function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"parse",value:function(e){var t=this._parseXML(e),n=t.documentElement;if("plist"!==n.tagName)return G(5100),{};for(var i=null,r=0,o=n.childNodes.length;r<o&&1!==(i=n.childNodes[r]).nodeType;r++);return t=null,this._parseNode(i)}},{key:"_parseNode",value:function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},n=null,i=0,r=e.childNodes.length;i<r;i++){var o=e.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:t[n]=this._parseNode(o))}return t}}]),t}(function(){function e(){o(this,e),this._isSupportDOMParser=void 0,this._parser=void 0,window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return r(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}()));function fp(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function hp(e,t){var n,i;if("string"==typeof e.content)try{if(n=JSON.parse(e.content),!$e&&n.keys&&n.data){var r=n.keys;dm(n=n.data,r)}}catch(t){return new Error(se(4923,e.id,t.stack))}else{if("object"!==ae(e.content))return new Error(se(4924));n=e.content}if(null==n)return new Error(se(4923,e.id));var o=fp(n);i=o?a._MissingScript.safeFindClass:function(e){var t=Me(e);return t||(G(4903,e),Object)};var s,c=a.deserialize.Details.pool.get();try{s=a.deserialize(n,c,{classFinder:i,target:e.existingAsset,customEnv:e})}catch(t){return a.deserialize.Details.pool.put(c),console.error(t),new Error("Failed to load asset ".concat(e.id,", exception occurs during deserialization: ").concat(t.stack,"."))}s._uuid=e.uuid;var l=function(e,t,n,i){var r,o,s,c=n.uuidList,l=n.uuidObjList,u=n.uuidPropList,_=n._stillUseUrl,f=e.dependKeys=[];if(i)for(r=[],o=0;o<c.length;o++){s=c[o];var h=l[o],d=u[o],v=a.AssetLibrary._getAssetInfoInRuntime(s);if(v.raw){var m=v.url;h[d]=m,f.push(m)}else r.push({type:"uuid",uuid:s,deferredLoadRaw:!0,_owner:h,_ownerProp:d,_stillUseUrl:_[o]})}else{for(r=new Array(c.length),o=0;o<c.length;o++)s=c[o],r[o]={type:"uuid",uuid:s,_owner:l[o],_ownerProp:u[o],_stillUseUrl:_[o]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(e,s,c,function(e,t,n){var i=t.deferredLoadRaw;return i?e instanceof a.Asset&&e.constructor.preventDeferredLoadDependents&&(i=!1):n&&(e instanceof a.SceneAsset||e instanceof a.Prefab)&&(i=e.asyncLoadAssets),i}(s,e,o));a.deserialize.Details.pool.put(c);var u=function(e,n){if(!e&&n.onLoaded)try{n.onLoaded()}catch(t){e=t}t(e,n)};if(0===l.length)return u(null,s);!function(e,t,n,i,r){t.content=n;var o=t.dependKeys;e.flowInDeps(t,i,(function(e,t){var s,c=t.map;for(var l in c)(s=c[l]).uuid&&s.content&&(s.content._uuid=s.uuid);for(var u=0;u<i.length;u++){var _=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==n._uuid&&o.indexOf(e.id)<0&&o.push(e.id)},f=i[u],h=f.uuid,d=f.url;f._owner,f._ownerProp;if(s=c[d]){var v=f;if(s.complete||s.content)s.error?a._throw(s.error):_.call(v,s);else{var m=tm.getQueue(s);m&&m.addListener(h,_,v)}}}n instanceof a.SceneAsset&&n.scene&&function(){for(var e=Object.create(null),t=0,i=o.length;t<i;t++)e[o[t]]=!0,ip(o[t]).forEach((function(t){e[t]=!0}));n.scene.dependAssets=Object.keys(e)}(),r(e,n)}))}(this.pipeline,e,s,l,u)}hp.isSceneObj=fp;var dp,vp=null,mp={},pp=-1,gp=[],yp=function(){if(!dp)if(window.FontFace){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);dp=e?parseInt(e[1],10)>42:!t}else dp=!1;return dp};function xp(){for(var e=!0,t=Date.now(),n=gp.length-1;n>=0;n--){var i=gp[n],r=i.fontFamilyName;if(t-i.startTime>3e3)G(4933,r),i.callback(null,r),gp.splice(n,1);else{var o=i.refWidth;vp.font="40px "+r,o!==_o(vp,"BES bswy:->@123")?(gp.splice(n,1),i.callback(null,r)):e=!1}}e&&(clearInterval(pp),pp=-1)}function Sp(e,t){var n=e.url,i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL";-1!==n.indexOf(" ")&&(n='"'+n+'"');return n}(n);if(mp[i])return i;if(!vp){var r=document.createElement("canvas");r.width=100,r.height=100,vp=r.getContext("2d")}var o="40px "+i;vp.font=o;var a=_o(vp,"BES bswy:->@123"),s=document.createElement("style");s.type="text/css";var c="";isNaN(i-0)?c+="@font-face { font-family:"+i+"; src:":c+="@font-face { font-family:'"+i+"'; src:",c+="url('"+n+"');",s.textContent=c+"}",document.body.appendChild(s);var l=document.createElement("div"),u=l.style;if(u.fontFamily=i,l.innerHTML=".",u.position="absolute",u.left="-100px",u.top="-100px",document.body.appendChild(l),yp())!function(e,t,n){var i,r=new Promise((function(n,i){!function r(){Date.now()-e>=3e3?i():document.fonts.load("40px "+t).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),o=new Promise((function(e,t){i=setTimeout(t,3e3)}));Promise.race([o,r]).then((function(){i&&(clearTimeout(i),i=null),n(null,t)}),(function(){G(4933,t),n(null,t)}))}(Date.now(),i,t);else{var _={fontFamilyName:i,refWidth:a,callback:t,startTime:Date.now()};gp.push(_),-1===pp&&(pp=setInterval(xp,100))}mp[i]=s}function Cp(e){if("string"!=typeof e.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(e.content)}catch(t){return new Error("JSON Loader: Parse json ["+e.id+"] failed : "+t)}}function Tp(e){if(e._owner instanceof a.Asset)return null;var t=e.content;if(a.sys.platform!==a.sys.FB_PLAYABLE_ADS&&!(t instanceof Image))return new Error("Image Loader: Input item doesn't contain Image content");var n=e.rawUrl,i=e.imageAsset||new Po;return i._uuid=e.uuid,i._url=n,i._setRawAsset(n,!1),i._nativeAsset=t,i}function Ep(e,t){if(e._owner instanceof a.Asset)return null;var n=new a.AudioClip;return n._setRawAsset(e.rawUrl,!1),n._nativeAsset=e.content,n}function Ap(e){return e.load?e.load(e.content):e.content}function bp(e,t){return e[t]<<8|e[t+1]}var wp={png:Tp,jpg:Tp,bmp:Tp,jpeg:Tp,gif:Tp,ico:Tp,tiff:Tp,webp:Tp,image:Tp,pvr:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,n=new Int32Array(t,0,13);if(55727696===n[0]){var i=n[7],r=n[6],o=n[12]+52;return t=t.slice(o,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:i,height:r}}if(559044176===n[11]){var a=n[0],s=n[1],c=n[2];return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:c,height:s}}return new Error("Invalid magic number in PVR header")},pkm:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,n=new Uint8Array(t),i=bp(n,6);if(0!==i&&1!==i&&3!==i)return new Error("Invalid magic number in ETC header");var r=bp(n,12),o=bp(n,14);return bp(n,8),bp(n,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:o}},astc:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,n=new Uint8Array(t);if(1554098963!==n[0]+(n[1]<<8)+(n[2]<<16)+(n[3]<<24))return new Error("Invalid magic number in ASTC header");var i=n[4],r=n[5],o=n[6];if((i<3||i>6||r<3||r>6||o<3||o>6)&&(i<4||7===i||9===i||11===i||i>12||r<4||7===r||9===r||11===r||r>12||1!==o))return new Error("Invalid block number in ASTC header");var a=function(e,t){return 4===e?Co.RGBA_ASTC_4x4:5===e?4===t?Co.RGBA_ASTC_5x4:Co.RGBA_ASTC_5x5:6===e?5===t?Co.RGBA_ASTC_6x5:Co.RGBA_ASTC_6x6:8===e?5===t?Co.RGBA_ASTC_8x5:6===t?Co.RGBA_ASTC_8x6:Co.RGBA_ASTC_8x8:10===e?5===t?Co.RGBA_ASTC_10x5:6===t?Co.RGBA_ASTC_10x6:8===t?Co.RGBA_ASTC_10x8:Co.RGBA_ASTC_10x10:10===t?Co.RGBA_ASTC_12x10:Co.RGBA_ASTC_12x12}(i,r),s=n[7]+(n[8]<<8)+(n[9]<<16),c=n[10]+(n[11]<<8)+(n[12]<<16);return t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:s,height:c,format:a}},mp3:Ep,ogg:Ep,wav:Ep,m4a:Ep,json:Cp,ExportJson:Cp,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=_p.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:hp,prefab:hp,fire:hp,scene:hp,binary:Ap,bin:Ap,font:Sp,eot:Sp,ttf:Sp,woff:Sp,svg:Sp,ttc:Sp,default:function(){return null}},Ip=e("cR",function(){function e(t){o(this,e),this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=void 0,this.extMap=re(t,wp)}return r(e,[{key:"addHandlers",value:function(e){this.extMap=re(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),e}());Ip.ID="Loader",rm.Loader=Ip;var Rp=Object.create(null);function Op(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}Rp.assets=new Wv,Rp.internal=new Wv;var Pp={url:null,raw:!1};function Np(e){var t,n,i;if("object"===ae(e)){if(n=e,e.url)return n;t=e.uuid}else n={},t=e;return i=n.type?"uuid"===n.type:a.AssetLibrary._uuidInSettings(t),a.AssetLibrary._getAssetInfoInRuntime(t,Pp),n.url=i?Pp.url:t,Pp.url&&"uuid"===n.type&&Pp.raw?(n.type=null,n.isRawAsset=!0):i||(n.isRawAsset=!0),n}var Dp=[],zp=[],Mp=function(e){function t(){var e;o(this,t);var n=new Zm,i=new up,r=new Ip;return(e=l(this,u(t).call(this,[n,i,r]))).getXMLHttpRequest=void 0,e.assetLoader=void 0,e.md5Pipe=void 0,e.downloader=void 0,e.loader=void 0,e.onProgress=void 0,e._assetTables=void 0,e._autoReleaseSetting=void 0,e._releasedAssetChecker_DEBUG=void 0,e.getXMLHttpRequest=Op,e.assetLoader=n,e.md5Pipe=null,e.downloader=i,e.loader=r,e.onProgress=null,e._assetTables=Rp,e._autoReleaseSetting=Be(!0),e}return c(t,e),r(t,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,n){void 0===n&&(n=t,t=this.onProgress||null);var i,r,o=this,a=!1;e instanceof Array?i=e:e?(a=!0,i=[e]):i=[],Dp.length=0;for(var s=0;s<i.length;++s){var c=i[s];if(c&&c.id&&(G(4920,c.id),c.uuid||c.url||(c.url=c.id)),(r=Np(c)).url||r.uuid){var l=this._cache[r.url];Dp.push(l||r)}}var u=tm.create(this,t,(function(e,t){Qe((function(){if(n){if(a){var i=r.url;n.call(o,t.getError(i),t.getContent(i))}else n.call(o,e,t);n=null}t.destroy()}))}));tm.initQueueDeps(u),u.append(Dp),Dp.length=0}},{key:"flowInDeps",value:function(e,t,n){zp.length=0;for(var i=0;i<t.length;++i){var r=Np(t[i]);if(r.url||r.uuid){var o=this._cache[r.url];o?zp.push(o):zp.push(r)}}var a=tm.create(this,e?function(e,t,n){a._ownerQueue&&a._ownerQueue.onProgress&&a._ownerQueue._childOnProgress(n)}:null,(function(t,i){n(t,i),e&&e.deps&&(e.deps.length=0),i.destroy()}));if(e){var s=tm.getQueue(e);a._ownerQueue=s&&s._ownerQueue||s}var c=a.append(zp,e);return zp.length=0,c}},{key:"loadRes",value:function(e,t,n,i,r){5!==arguments.length&&(r=i,i=n,n="assets");var o=this._parseLoadResArgs(t,i,r);t=o.type,i=o.onProgress,r=o.onComplete;var a=this,s=a._getResUuid(e,t,n,!0);s?this.load({type:"uuid",uuid:s},i,(function(e,t){t&&a.setAutoReleaseRecursively(s,!1),r&&r(e,t)})):a._urlNotFound(e,t,r)}},{key:"loadResDir",value:function(e,t,n,i,r){if(5!==arguments.length&&(r=i,i=n,n="assets"),Rp[n]){var o=this._parseLoadResArgs(t,i,r);t=o.type,i=o.onProgress,r=o.onComplete;var a=[],s=Rp[n].getUuidArray(e,t,a);this._loadResUuids(s,i,(function(e,t,n){for(var i=t.length,o=0;o<i;++o)if(t[o]instanceof Pv){var a=t[o].getSpriteFrames();for(var s in a){var c=a[s];t.push(c),n&&n.push("".concat(n[o],"/").concat(c.name))}}r&&r(e,t,n)}),a)}}},{key:"loadResArray",value:function(e,t,n,i,r){5!==arguments.length&&(r=i,i=n,n="assets");var o=this._parseLoadResArgs(t,i,r);t=o.type,i=o.onProgress,r=o.onComplete;for(var a=[],s=0;s<e.length;s++){var c=e[s],l=this._getResUuid(c,t,n,!0);if(!l)return void this._urlNotFound(c,t,r);a.push(l)}this._loadResUuids(a,i,r)}},{key:"getRes",value:function(e,t){var n=this._cache[e];if(!n){var i=this._getResUuid(e,t,null,!0);if(!i)return null;var r=this._getReferenceKey(i);n=this._cache[r]}return n&&n.alias&&(n=n.alias),n&&n.complete?n.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),n=ip(t);return n.push(t),n}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];this.release(n)}else if(e){var i=this._getReferenceKey(e),r=this.getItem(i);if(r){this.removeItem(i);if((e=r.content)instanceof D){var o=e.nativeUrl;o&&this.release(o),e.destroy()}}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,n){var i=this._getResUuid(e,t,n,!0);i?this.release(i):L(4914,e)}},{key:"releaseResDir",value:function(e,t,n){if(Rp[n=n||"assets"])for(var i=Rp[n].getUuidArray(e,t),r=0;r<i.length;r++){var o=i[r];this.release(o)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=rm.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var n=this._getReferenceKey(e);n&&(this._autoReleaseSetting[n]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var n=this._getReferenceKey(e);if(n){this._autoReleaseSetting[n]=t;for(var i=ip(n),r=0;r<i.length;r++){var o=i[r];this._autoReleaseSetting[o]=t}}}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,n,i){var r="",o=Rp[n=n||"assets"];if(e&&o){var a=e.indexOf("?");if(-1!==a&&(e=e.substr(0,a)),!(r=o.getUuid(e,t))){var s=Ct(e);s&&(e=e.slice(0,-s.length),(r=o.getUuid(e,t))&&!i&&G(4901,e,s))}}return!r&&t&&(ce(t,zs)||ce(t,ca)||ce(t,Ms))&&G(4934),r}},{key:"_getReferenceKey",value:function(e){var t;return"object"===ae(e)?t=e._uuid||null:"string"==typeof e&&(t=this._getResUuid(e,void 0,void 0,!0)||e),t?(a.AssetLibrary._getAssetInfoInRuntime(t,Pp),this._cache[Pp.url]?Pp.url:t):(G(4800,e),t)}},{key:"_urlNotFound",value:function(e,t,n){Qe((function(){e=a.url.normalize(e);var i="".concat(t?qe(t):"Asset",' in "resources/').concat(e,'" does not exist.');n&&n(new Error(i),[])}))}},{key:"_parseLoadResArgs",value:function(e,t,n){if(void 0===n){var i=ce(e,a.RawAsset);t?(n=t,i&&(t=this.onProgress||null)):void 0!==t||i||(n=e,t=this.onProgress||null,e=null),void 0===t||i||(t=e,e=null)}return{type:e,onProgress:t,onComplete:n}}},{key:"_loadResUuids",value:function(e,t,n,i){if(e.length>0){var r=this,o=e.map((function(e){return{type:"uuid",uuid:e}}));this.load(o,t,(function(e,t){if(n){for(var a=[],s=i&&[],c=0;c<o.length;++c){var l=o[c].uuid,u=r._getReferenceKey(l),_=t.getContent(u);_&&(r.setAutoReleaseRecursively(l,!1),a.push(_),s&&s.push(i[c]))}i?n(e,a,s):n(e,a)}}))}else n&&Qe((function(){i?n(null,[],[]):n(null,[])}))}}]),t}(rm),Lp=e("cT",a.loader=new Mp);var Fp,kp,Up,Bp,Gp,jp,Vp,Hp,qp=Object.freeze({__proto__:null,loadImage:function(e,t,n){$(!!e,3103);var i=Lp.getRes(e);return i?i.loaded?(t&&t.call(n,null,i),i):(i.once("load",(function(){t&&t.call(n,null,i)}),n),i):(i=new Po,Lp.load({url:e,imageAsset:i},(function(e,r){if(e)return t&&t.call(n,e||new Error("Unknown error")),i;t&&t.call(n,null,r)})),i)},cacheImage:function(e,t){if(e&&t){var n=new Po(t),i={id:e,url:e,error:null,content:n,complete:!1};return Lp.flowOut(i),n}},postLoadImage:function(e,t){e.loaded?t&&t():e.nativeUrl?Lp.load({url:e.nativeUrl,skips:e.isCompressed?void 0:["Loader"]},(function(n,i){i&&(e.loaded||(e._nativeAsset=i)),t&&t(n)})):t&&t()}});e("aQ",qp);var Wp,Xp,Yp,Kp,Qp,Jp,Zp,$p,eg,tg=e("b5",(Fp=E("cc.Skeleton"),kp=F([et]),Up=F([f]),Fp((jp=A((Gp=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"_joints",jp,M(n)),I(n,"_bindposes",Vp,M(n)),I(n,"_hash",Hp,M(n)),n._invBindposes=null,n}return c(t,e),r(t,[{key:"destroy",value:function(){return a.director.root.dataPoolManager.releaseSkeleton(this),P(u(t.prototype),"destroy",this).call(this)}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new f;f.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var n=this._bindposes[t];e+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=ui(e,666)}return this._hash}}]),t}(D)).prototype,"_joints",[kp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vp=A(Gp.prototype,"_bindposes",[Up],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hp=A(Gp.prototype,"_hash",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bp=Gp))||Bp));a.Skeleton=tg,C(rs.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),T(rs.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]),T(Jo.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),C(Zc.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]),a.textureUtil=qp;var ng,ig,rg,og,ag,sg,cg,lg,ug,_g,fg,hg,dg=e("cG",(Wp=E("RenderStage"),Xp=ve(),Yp=ve(),Kp=ve(),Wp((Zp=A((Jp=function(){function e(){o(this,e),I(this,"_name",Zp,this),I(this,"_priority",$p,this),I(this,"_tag",eg,this)}return r(e,[{key:"initialize",value:function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(e,t){this._pipeline=e,this._flow=t}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}}]),e}()).prototype,"_name",[Xp,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$p=A(Jp.prototype,"_priority",[Yp,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eg=A(Jp.prototype,"_tag",[Kp,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qp=Jp))||Qp));a.RenderStage=dg;var vg,mg,pg,gg,yg,xg,Sg,Cg,Tg=e("cF",(ng=E("RenderFlow"),ig=ve(),rg=ve(),og=ve(),ag=ve(),sg=F([dg]),ng((ug=A((lg=function(){function e(){o(this,e),I(this,"_name",ug,this),I(this,"_priority",_g,this),I(this,"_tag",fg,this),I(this,"_stages",hg,this)}return r(e,[{key:"initialize",value:function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)}},{key:"render",value:function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].render(e)}},{key:"destroy",value:function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}}]),e}()).prototype,"_name",[ig,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_g=A(lg.prototype,"_priority",[rg,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fg=A(lg.prototype,"_tag",[og,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hg=A(lg.prototype,"_stages",[ag,sg,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cg=lg))||cg));a.RenderFlow=Tg;var Eg,Ag,bg,wg,Ig,Rg,Og,Pg,Ng,Dg,zg,Mg,Lg,Fg,kg,Ug,Bg,Gg,jg,Vg,Hg,qg,Wg,Xg,Yg,Kg,Qg,Jg,Zg,$g,ey,ty,ny,iy,ry,oy,ay,sy,cy,ly,uy,_y,fy,hy,dy,vy,my,py,gy,yy,xy,Sy,Cy,Ty,Ey,Ay,by,wy,Iy,Ry,Oy,Py,Ny,Dy,zy,My,Ly,Fy,ky,Uy,By,Gy,jy,Vy,Hy,qy,Wy,Xy,Yy,Ky,Qy,Jy,Zy,$y=e("cE",(vg=E("cc.RenderPipeline"),mg=ve(),pg=ve(),gg=F([Tg]),vg((Sg=A((xg=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"_tag",Sg,M(n)),I(n,"_flows",Cg,M(n)),n._globalDescriptorSetLayout={bindings:[],record:{}},n._localDescriptorSetLayout={bindings:[],record:{}},n._macros={},n._commandBuffers=[],n}return c(t,e),r(t,[{key:"initialize",value:function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(){this._device=a.director.root.device,this._descriptorSetLayout=this._device.createDescriptorSetLayout({bindings:da.bindings}),this._descriptorSet=this._device.createDescriptorSet({layout:this._descriptorSetLayout});for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0}},{key:"render",value:function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=0;i<n.flows.length;i++)n.flows[i].render(n)}},{key:"destroy",value:function(){for(var e=0;e<this._flows.length;e++)this._flows[e].destroy();this._flows.length=0,this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null);for(var n=0;n<this._commandBuffers.length;n++)this._commandBuffers[n].destroy();return this._commandBuffers.length=0,P(u(t.prototype),"destroy",this).call(this)}},{key:"globalDescriptorSetLayout",get:function(){return this._globalDescriptorSetLayout}},{key:"localDescriptorSetLayout",get:function(){return this._localDescriptorSetLayout}},{key:"macros",get:function(){return this._macros}},{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"device",get:function(){return this._device}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}}]),t}(D)).prototype,"_tag",[mg,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cg=A(xg.prototype,"_flows",[pg,gg,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yg=xg))||yg));a.RenderPipeline=$y,_(Sn),_(Cn),_(Rn),_(In),_(On),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(Zy||(Zy={})),_(Zy);Eg=E("RenderTextureDesc"),Ag=F(Sn),bg=F(Cn),wg=F(on),Eg((Og=A((Rg=function e(){o(this,e),I(this,"name",Og,this),I(this,"type",Pg,this),I(this,"usage",Ng,this),I(this,"format",Dg,this),I(this,"width",zg,this),I(this,"height",Mg,this)}).prototype,"name",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Pg=A(Rg.prototype,"type",[Ag],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sn.TEX2D}}),Ng=A(Rg.prototype,"usage",[bg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cn.COLOR_ATTACHMENT}}),Dg=A(Rg.prototype,"format",[wg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return on.UNKNOWN}}),zg=A(Rg.prototype,"width",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Mg=A(Rg.prototype,"height",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ig=Rg));var ex,tx=(Lg=E("RenderTextureConfig"),Fg=F(Zc),Lg((Bg=A((Ug=function e(){o(this,e),I(this,"name",Bg,this),I(this,"texture",Gg,this)}).prototype,"name",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Gg=A(Ug.prototype,"texture",[Fg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kg=Ug))||kg),nx=(jg=E("MaterialConfig"),Vg=F($c),jg((Wg=A((qg=function e(){o(this,e),I(this,"name",Wg,this),I(this,"material",Xg,this)}).prototype,"name",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Xg=A(qg.prototype,"material",[Vg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hg=qg))||Hg),ix=(Yg=E("FrameBufferDesc"),Kg=F([et]),Qg=F(Zc),Yg(($g=A((Zg=function e(){o(this,e),I(this,"name",$g,this),I(this,"renderPass",ey,this),I(this,"colorTextures",ty,this),I(this,"depthStencilTexture",ny,this),I(this,"texture",iy,this)}).prototype,"name",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ey=A(Zg.prototype,"renderPass",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ty=A(Zg.prototype,"colorTextures",[Kg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ny=A(Zg.prototype,"depthStencilTexture",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),iy=A(Zg.prototype,"texture",[Qg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jg=Zg)),ry=E("ColorDesc"),oy=F(on),ay=F(In),sy=F(Rn),cy=F(On),ly=F(On),ry((fy=A((_y=function e(){o(this,e),I(this,"format",fy,this),I(this,"loadOp",hy,this),I(this,"storeOp",dy,this),I(this,"sampleCount",vy,this),I(this,"beginLayout",my,this),I(this,"endLayout",py,this)}).prototype,"format",[oy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return on.UNKNOWN}}),hy=A(_y.prototype,"loadOp",[ay],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return In.CLEAR}}),dy=A(_y.prototype,"storeOp",[sy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rn.STORE}}),vy=A(_y.prototype,"sampleCount",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),my=A(_y.prototype,"beginLayout",[cy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.UNDEFINED}}),py=A(_y.prototype,"endLayout",[ly],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.PRESENT_SRC}}),uy=_y))||uy),rx=(gy=E("DepthStencilDesc"),yy=F(on),xy=F(In),Sy=F(Rn),Cy=F(In),Ty=F(Rn),Ey=F(On),Ay=F(On),gy((Iy=A((wy=function e(){o(this,e),I(this,"format",Iy,this),I(this,"depthLoadOp",Ry,this),I(this,"depthStoreOp",Oy,this),I(this,"stencilLoadOp",Py,this),I(this,"stencilStoreOp",Ny,this),I(this,"sampleCount",Dy,this),I(this,"beginLayout",zy,this),I(this,"endLayout",My,this)}).prototype,"format",[yy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return on.UNKNOWN}}),Ry=A(wy.prototype,"depthLoadOp",[xy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return In.CLEAR}}),Oy=A(wy.prototype,"depthStoreOp",[Sy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rn.STORE}}),Py=A(wy.prototype,"stencilLoadOp",[Cy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return In.CLEAR}}),Ny=A(wy.prototype,"stencilStoreOp",[Ty],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rn.STORE}}),Dy=A(wy.prototype,"sampleCount",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),zy=A(wy.prototype,"beginLayout",[Ey],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.UNDEFINED}}),My=A(wy.prototype,"endLayout",[Ay],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),by=wy))||by);Ly=E("RenderPassDesc"),Fy=F([ix]),ky=F(rx),Ly((Gy=A((By=function e(){o(this,e),I(this,"index",Gy,this),I(this,"colorAttachments",jy,this),I(this,"depthStencilAttachment",Vy,this)}).prototype,"index",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),jy=A(By.prototype,"colorAttachments",[Fy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vy=A(By.prototype,"depthStencilAttachment",[ky],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rx}}),Uy=By));!function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(ex||(ex={})),_(ex);var ox,ax=(Hy=E("RenderQueueDesc"),qy=F(ex),Wy=F([et]),Hy((Ky=A((Yy=function e(){o(this,e),I(this,"isTransparent",Ky,this),I(this,"sortMode",Qy,this),I(this,"stages",Jy,this)}).prototype,"isTransparent",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qy=A(Yy.prototype,"sortMode",[qy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ex.FRONT_TO_BACK}}),Jy=A(Yy.prototype,"stages",[Wy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xy=Yy))||Xy);!function(e){e[e.GENERAL=100]="GENERAL"}(ox||(ox={}));var sx,cx;e("cH",function(){function e(){o(this,e),this._name="",this._window=null,this._priority=0,this._visibility=ja,this._isEnable=!1,this._flows=[]}return r(e,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,a.director.root&&a.director.root.sortViews()}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"flows",get:function(){return this._flows}}]),r(e,[{key:"initialize",value:function(e){return this._camera=e.camera,this._name=e.name,this.priority=e.priority,this.setExecuteFlows(e.flows),!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}},{key:"setExecuteFlows",value:function(e){this._flows.length=0;var t=a.director.root.pipeline.flows;if(e&&1===e.length&&"UIFlow"===e[0]){for(var n=0;n<t.length;n++)if("UIFlow"===t[n].name){this._flows.push(t[n]);break}}else for(var i=0;i<t.length;++i){var r=t[i];(r.tag===Zy.SCENE||e&&-1!==e.indexOf(r.name))&&this._flows.push(r)}}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=a.director.root.pipeline.flows,t=0;t<this._flows.length;++t)for(var n=this._flows[t],i=0;i<e.length;i++)if(e[i].name===n.name){this._flows[t]=e[i];break}}}]),e}());function lx(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function ux(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}!function(e){e[e.FORWARD=10]="FORWARD",e[e.UI=20]="UI"}(sx||(sx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(cx||(cx={}));var _x,fx,hx,dx,vx,mx,px,gx,yx,xx,Sx,Cx=function(){function e(t){o(this,e),this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new mt((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new pt(64,this._passDesc.sortFunc)}return r(e,[{key:"clear",value:function(){this.queue.clear(),this._passPool.reset()}},{key:"insertRenderPass",value:function(e,t,n){var i=e.model.subModels[t],r=oc.get(i.handle,ic.PASS_0+n);if(Zs.get(rc.get(r,Ys.BLEND_STATE)).targets[0].blend!==this._passDesc.isTransparent||!(rc.get(r,Ys.PHASE)&this._passDesc.phases))return!1;var o=0|rc.get(r,Ys.PRIORITY)<<16|i.priority<<8|n,a=this._passPool.add();return a.hash=o,a.depth=e.depth||0,a.shaderId=oc.get(i.handle,ic.SHADER_0+n),a.subModel=i,a.passIdx=n,this.queue.push(a),!0}},{key:"sort",value:function(){this.queue.sort()}},{key:"recordCommandBuffer",value:function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.handle,l=oc.get(c,ic.PASS_0+a),u=$s.get(oc.get(c,ic.SHADER_0+a)),_=Cf.getOrCreatePipelineState(e,l,u,t,s);n.bindPipelineState(_),n.bindDescriptorSet(ya.MATERIAL,ec.get(rc.get(l,Ys.DESCRIPTOR_SET))),n.bindDescriptorSet(ya.LOCAL,ec.get(oc.get(c,ic.DESCRIPTOR_SET))),n.bindInputAssembler(s),n.draw(s)}}}]),e}(),Tx=[],Ex=e("cO",(_x=E("UIStage"),fx=F([ax]),hx=ve(),_x((gx=px=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"renderQueues",mx,M(n)),n._renderQueues=[],n._renderArea={x:0,y:0,width:0,height:0},n}return c(t,e),r(t,[{key:"initialize",value:function(e){return P(u(t.prototype),"initialize",this).call(this,e),this.renderQueues=[{isTransparent:!0,stages:["default"],sortMode:ex.BACK_TO_FRONT}],!0}},{key:"activate",value:function(e,n){P(u(t.prototype),"activate",this).call(this,e,n);for(var i=0;i<this.renderQueues.length;i++){for(var r=0,o=0;o<this.renderQueues[i].stages.length;o++)r|=Vs(this.renderQueues[i].stages[o]);var a=lx;switch(this.renderQueues[i].sortMode){case ex.BACK_TO_FRONT:a=ux;break;case ex.FRONT_TO_BACK:a=lx}this._renderQueues[i]=new Cx({isTransparent:this.renderQueues[i].isTransparent,phases:r,sortFunc:a})}}},{key:"destroy",value:function(){}},{key:"render",value:function(e){var t=this._pipeline,n=t.isHDR;t.isHDR=!1;var i=t.device;this._renderQueues[0].clear();for(var r=t.renderObjects,o=0;o<r.length;o++)for(var a=r[o],s=a.model.subModels,c=0;c<s.length;c++)for(var l=s[c].passes,u=0;u<l.length;u++)this._renderQueues[0].insertRenderPass(a,c,u);this._renderQueues[0].sort();var _=e.camera,f=_.viewport;this._renderArea.x=f.x*_.width,this._renderArea.y=f.y*_.height,this._renderArea.width=f.width*_.width,this._renderArea.height=f.height*_.height,Tx[0]=_.clearColor;var h=t.commandBuffers[0],d=e.window.framebuffer,v=d.colorTextures[0]?d.renderPass:t.getRenderPass(_.clearFlag);h.begin(),h.beginRenderPass(v,d,this._renderArea,[_.clearColor],_.clearDepth,_.clearStencil),h.bindDescriptorSet(ya.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,v,h),h.endRenderPass(),h.end(),i.queue.submit(t.commandBuffers),t.isHDR=n}}]),t}(dg),px.initInfo={name:"UIStage",priority:sx.UI},mx=A((vx=gx).prototype,"renderQueues",[fx,b,hx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dx=vx))||dx)),Ax=e("cN",E("UIFlow")((Sx=xx=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"initialize",value:function(e){P(u(t.prototype),"initialize",this).call(this,e);var n=new Ex;return n.initialize(Ex.initInfo),this._stages.push(n),!0}},{key:"destroy",value:function(){P(u(t.prototype),"destroy",this).call(this)}},{key:"render",value:function(e){this._pipeline.updateUBOs(e),P(u(t.prototype),"render",this).call(this,e)}}]),t}(Tg),xx.initInfo={name:"UIFlow",priority:cx.UI,tag:Zy.UI},yx=Sx))||yx);var bx=function(){function e(){o(this,e),this.queue=new Set}return r(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"recordCommandBuffer",value:function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=0;o<r.value.batches.length;++o){var a=r.value.batches[o];if(a.mergeCount){for(var s=0;s<a.vbs.length;++s)a.vbs[s].update(a.vbDatas[s]);a.vbIdx.update(a.vbIdxData.buffer),a.ubo.update(a.uboData)}}r=i.next()}for(r=(i=this.queue.values()).next();!r.done;){for(var c=!1,l=0;l<r.value.batches.length;++l){var u=r.value.batches[l];if(u.mergeCount){if(!c){var _=$s.get(u.hShader),f=Cf.getOrCreatePipelineState(e,u.hPass,_,t,u.ia);n.bindPipelineState(f),n.bindDescriptorSet(ya.MATERIAL,ec.get(rc.get(u.hPass,Ys.DESCRIPTOR_SET))),c=!0}n.bindDescriptorSet(ya.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}r=i.next()}}}]),e}(),wx=function(){function e(){o(this,e),this.queue=new Set}return r(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"recordCommandBuffer",value:function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;)r.value.hasPendingModels&&r.value.uploadBuffers(),r=i.next();for(r=(i=this.queue.values()).next();!r.done;){var o=r.value,a=o.instances,s=o.hPass;if(o.hasPendingModels){n.bindDescriptorSet(ya.MATERIAL,ec.get(rc.get(s,Ys.DESCRIPTOR_SET)));for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var _=$s.get(u.hShader),f=Cf.getOrCreatePipelineState(e,s,_,t,u.ia);c!==f&&(n.bindPipelineState(f),c=f),n.bindDescriptorSet(ya.LOCAL,ec.get(u.hDescriptorSet),r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}}}]),e}(),Ix=function(){function e(t){o(this,e),this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}return r(e,null,[{key:"get",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e._buffers;i.has(t)||i.set(t,{});var r=i.get(t);return r[n]||(r[n]=new e(t))}}]),r(e,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0}},{key:"merge",value:function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=oc.get(e.handle,ic.PASS_0+t),c=oc.get(e.handle,ic.SHADER_0+t),l=e.descriptorSet,u=!1,_=0;_<this.batches.length;++_){var h=this.batches[_];if(h.vbs.length===i.length&&h.mergeCount<Ra.BATCHING_COUNT){u=!0;for(var d=0;d<h.vbs.length;++d){if(h.vbs[d].stride!==i[d].stride){u=!1;break}}if(u){for(var v=0;v<h.vbs.length;++v){var m=i[v],p=h.vbs[v],g=h.vbDatas[v];(r=(a+h.vbCount)*m.stride)>p.size&&(p.resize(r),h.vbDatas[v]=new Uint8Array(r),h.vbDatas[v].set(g)),h.vbDatas[v].set(m.buffer,h.vbCount*m.stride)}var y=h.vbIdxData;(o=4*(a+h.vbCount))>h.vbIdx.size&&(h.vbIdx.resize(o),h.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),h.vbIdxData.set(y),y=h.vbIdxData);var x=h.vbCount,S=x+a,C=h.mergeCount;if(y[x]!==C||y[S-1]!==C)for(var T=x;T<S;T++)y[T]=C+.1;return f.toArray(h.uboData,n.model.transform.worldMatrix,Ra.MAT_WORLDS_OFFSET+16*h.mergeCount),h.mergeCount||(l.bindBuffer(Ra.BLOCK.binding,h.ubo),l.update(),h.hPass=s,h.hShader=c,h.descriptorSet=l),++h.mergeCount,h.vbCount+=a,void(h.ia.vertexCount+=a)}}}for(var E=[],A=[],b=[],w=0;w<i.length;++w){var I=i[w],R=this._device.createBuffer({usage:an.VERTEX|an.TRANSFER_DST,memUsage:sn.HOST|sn.DEVICE,size:I.count*I.stride,stride:I.stride});R.update(I.buffer.buffer),E.push(R),A.push(new Uint8Array(R.size)),b.push(R)}var O=this._device.createBuffer({usage:an.VERTEX|an.TRANSFER_DST,memUsage:sn.HOST|sn.DEVICE,size:4*a,stride:4}),P=new Float32Array(a);P.fill(0),O.update(P),b.push(O);for(var N=e.inputAssembler.attributes,D=new Array(N.length+1),z=0;z<N.length;++z)D[z]=N[z];D[N.length]={name:"a_dyn_batch_id",format:on.R32F,stream:i.length};var M=this._device.createInputAssembler({attributes:D,vertexBuffers:b}),L=this._device.createBuffer({usage:an.UNIFORM|an.TRANSFER_DST,memUsage:sn.HOST|sn.DEVICE,size:Ra.SIZE});l.bindBuffer(Ra.BLOCK.binding,L),l.update();var F=new Float32Array(Ra.COUNT);f.toArray(F,n.model.transform.worldMatrix,Ra.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:E,vbDatas:A,vbIdx:O,vbIdxData:P,vbCount:a,ia:M,ubo:L,uboData:F,hPass:s,hShader:c,descriptorSet:l})}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}}]),e}();Ix._buffers=new Map;var Rx=new ge((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[]}}),16),Ox=new Float32Array(4),Px=Qt.create(0,0,0,1),Nx=[],Dx=[];function zx(e,t){return!(!t.worldBounds||wr.aabb_aabb(t.worldBounds,e.aabb))}function Mx(e,t){return!(!t.worldBounds||wr.aabb_aabb(t.worldBounds,e.aabb)&&wr.aabb_frustum(t.worldBounds,e.frustum))}var Lx=Vs("forward-add");function Fx(e){for(var t=0;t<e.length;t++)for(var n=e[t].passes,i=0;i<n.length;i++)if(n[i].phase===Lx)return i;return-1}var kx,Ux,Bx,Gx,jx,Vx,Hx,qx,Wx,Xx,Yx,Kx,Qx,Jx,Zx,$x,eS,tS,nS,iS,rS,oS,aS,sS,cS,lS,uS=function(){function e(t){o(this,e),this._device=void 0,this._validLights=[],this._lightPasses=[],this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstlightBufferView=void 0,this._lightBufferData=void 0,this._isHDR=void 0,this._fpScale=void 0,this._renderObjects=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._device=t.device,this._isHDR=t.isHDR,this._fpScale=t.fpScale,this._renderObjects=t.renderObjects,this._instancedQueue=new wx,this._batchedQueue=new bx,this._lightBufferStride=Math.ceil(Oa.SIZE/this._device.uboOffsetAlignment)*this._device.uboOffsetAlignment,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer({memUsage:sn.HOST|sn.DEVICE,usage:an.UNIFORM,stride:this._lightBufferStride,size:this._lightBufferStride*this._lightBufferCount}),this._firstlightBufferView=this._device.createBuffer({buffer:this._lightBuffer,offset:0,range:Oa.SIZE}),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}return r(e,[{key:"gatherLightPasses",value:function(e){var t=this._validLights,n=e.camera.scene.sphereLights;this._instancedQueue.clear(),this._batchedQueue.clear(),t.length=0;for(var i=0;i<this._lightPasses.length;i++){this._lightPasses[i].dynamicOffsets.length=0}Rx.freeArray(this._lightPasses),this._lightPasses.length=0;for(var r=0;r<n.length;r++){var o=n[r];Qt.set(Px,o.position.x,o.position.y,o.position.z,o.range),wr.sphere_frustum(Px,e.camera.frustum)&&t.push(o)}for(var a=e.camera.scene.spotLights,s=0;s<a.length;s++){var c=a[s];Qt.set(Px,c.position.x,c.position.y,c.position.z,c.range),wr.sphere_frustum(Px,e.camera.frustum)&&t.push(c)}if(t.length){this._updateUBOs(e);for(var l=0;l<this._renderObjects.length;l++){var u=this._renderObjects[l],_=u.model,f=_.subModels,h=Fx(f);if(!(h<0)){Dx.length=0;for(var d=0;d<t.length;d++){var v=t[d],m=!1;switch(v.type){case df.SPHERE:m=zx(v,_);break;case df.SPOT:m=Mx(v,_)}m||Dx.push(d)}if(Dx.length)for(var p=0;p<f.length;p++){var g=f[p],y=g.passes[h],x=y.batchingScheme;if(g.descriptorSet.bindBuffer(Oa.BLOCK.binding,this._firstlightBufferView),g.descriptorSet.update(),x===dc.INSTANCING)for(var S=0;S<Dx.length;S++){var C=Dx[S],T=m_.get(y,C);T.merge(g,_.instancedAttributes,h),T.dynamicOffsets[0]=this._lightBufferStride*C,this._instancedQueue.queue.add(T)}else if(x===dc.VB_MERGING)for(var E=0;E<Dx.length;E++){var A=Dx[E],b=Ix.get(y,A);b.merge(g,h,u),b.dynamicOffsets[0]=this._lightBufferStride*A,this._batchedQueue.queue.add(b)}else{var w=Rx.alloc();w.subModel=g,w.passIdx=h;for(var I=0;I<Dx.length;I++)w.dynamicOffsets.push(this._lightBufferStride*Dx[I]);this._lightPasses.push(w)}}}}}}},{key:"recordCommandBuffer",value:function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._lightPasses.length;i++){var r=this._lightPasses[i],o=r.subModel,a=r.passIdx,s=r.dynamicOffsets,c=$s.get(oc.get(o.handle,ic.SHADER_0+a)),l=o.passes[a],u=o.inputAssembler,_=Cf.getOrCreatePipelineState(e,l.handle,c,t,u),f=ec.get(rc.get(l.handle,Ys.DESCRIPTOR_SET)),h=o.descriptorSet;n.bindPipelineState(_),n.bindDescriptorSet(ya.MATERIAL,f),n.bindInputAssembler(u);for(var d=0;d<s.length;++d)Nx[0]=s[d],n.bindDescriptorSet(ya.LOCAL,h,Nx),n.draw(u)}}},{key:"_updateUBOs",value:function(e){var t=e.camera.exposure;this._validLights.length>this._lightBufferCount&&(this._firstlightBufferView.destroy(),this._lightBufferCount=tt(this._validLights.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstlightBufferView.initialize({buffer:this._lightBuffer,offset:0,range:Oa.SIZE}));for(var n=0,i=0;n<this._validLights.length;n++,i+=this._lightBufferElementCount){var r=this._validLights[n];switch(r.type){case df.SPHERE:var o=r;if(s.toArray(Ox,o.position),Ox[3]=0,this._lightBufferData.set(Ox,i+Oa.LIGHT_POS_OFFSET),Ox[0]=o.size,Ox[1]=o.range,Ox[2]=0,this._lightBufferData.set(Ox,i+Oa.LIGHT_SIZE_RANGE_ANGLE_OFFSET),s.toArray(Ox,r.color),r.useColorTemperature){var a=r.colorTemperatureRGB;Ox[0]*=a.x,Ox[1]*=a.y,Ox[2]*=a.z}this._isHDR?Ox[3]=o.luminance*this._fpScale*this._lightMeterScale:Ox[3]=o.luminance*t*this._lightMeterScale,this._lightBufferData.set(Ox,i+Oa.LIGHT_COLOR_OFFSET);break;case df.SPOT:var c=r;if(s.toArray(Ox,c.position),Ox[3]=1,this._lightBufferData.set(Ox,i+Oa.LIGHT_POS_OFFSET),Ox[0]=c.size,Ox[1]=c.range,Ox[2]=c.spotAngle,this._lightBufferData.set(Ox,i+Oa.LIGHT_SIZE_RANGE_ANGLE_OFFSET),s.toArray(Ox,c.direction),this._lightBufferData.set(Ox,i+Oa.LIGHT_DIR_OFFSET),s.toArray(Ox,r.color),r.useColorTemperature){var l=r.colorTemperatureRGB;Ox[0]*=l.x,Ox[1]*=l.y,Ox[2]*=l.z}this._isHDR?Ox[3]=c.luminance*this._fpScale*this._lightMeterScale:Ox[3]=c.luminance*t*this._lightMeterScale,this._lightBufferData.set(Ox,i+Oa.LIGHT_COLOR_OFFSET)}}this._lightBuffer.update(this._lightBufferData)}}]),e}(),_S=[{r:0,g:0,b:0,a:1}],fS=e("cK",(kx=E("ForwardStage"),Ux=F([ax]),Bx=ve(),kx((qx=Hx=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),I(e,"renderQueues",Vx,M(e)),e._renderQueues=[],e._renderArea={x:0,y:0,width:0,height:0},e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Vs("default"),e._batchedQueue=new bx,e._instancedQueue=new wx,e}return c(t,e),r(t,[{key:"initialize",value:function(e){return P(u(t.prototype),"initialize",this).call(this,e),this.renderQueues=[{isTransparent:!1,sortMode:ex.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:ex.BACK_TO_FRONT,stages:["default","planarShadow"]}],!0}},{key:"activate",value:function(e,n){P(u(t.prototype),"activate",this).call(this,e,n);for(var i=0;i<this.renderQueues.length;i++){for(var r=0,o=0;o<this.renderQueues[i].stages.length;o++)r|=Vs(this.renderQueues[i].stages[o]);var a=lx;switch(this.renderQueues[i].sortMode){case ex.BACK_TO_FRONT:a=ux;break;case ex.FRONT_TO_BACK:a=lx}this._renderQueues[i]=new Cx({isTransparent:this.renderQueues[i].isTransparent,phases:r,sortFunc:a})}this._additiveLightQueue=new uS(this._pipeline)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(this.renderQueueClearFunc);for(var i=t.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],_=u.passes;for(o=0;o<_.length;++o){var f=_[o];if(f.phase===this._phaseID){var h=f.batchingScheme;if(h===dc.INSTANCING){var d=m_.get(f);d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(h===dc.VB_MERGING){var v=Ix.get(f);v.merge(u,o,c),this._batchedQueue.queue.add(v)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(this.renderQueueSortFunc),this._additiveLightQueue.gatherLightPasses(e);var m,p,g=e.camera,y=t.commandBuffers[0],x=g.viewport;if(this._renderArea.x=x.x*g.width,this._renderArea.y=x.y*g.height,this._renderArea.width=x.width*g.width*t.shadingScale,this._renderArea.height=x.height*g.height*t.shadingScale,g.clearFlag&Ln.COLOR)if(t.isHDR){m=_S[0],p=g.clearColor,m.r=p.r*p.r,m.g=p.g*p.g,m.b=p.b*p.b;var S=t.fpScale/g.exposure;_S[0].r*=S,_S[0].g*=S,_S[0].b*=S}else _S[0].r=g.clearColor.r,_S[0].g=g.clearColor.g,_S[0].b=g.clearColor.b;_S[0].a=g.clearColor.a;var C=e.window.framebuffer,T=C.colorTextures[0]?C.renderPass:t.getRenderPass(g.clearFlag);y.begin(),y.beginRenderPass(T,C,this._renderArea,_S,g.clearDepth,g.clearStencil),y.bindDescriptorSet(ya.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,T,y),this._instancedQueue.recordCommandBuffer(n,T,y),this._batchedQueue.recordCommandBuffer(n,T,y),this._additiveLightQueue.recordCommandBuffer(n,T,y),t.shadows.type===Pf.Planar&&t.shadows.recordCommandBuffer(n,T,y),this._renderQueues[1].recordCommandBuffer(n,T,y),y.endRenderPass(),y.end(),n.queue.submit(t.commandBuffers)}},{key:"renderQueueClearFunc",value:function(e){e.clear()}},{key:"renderQueueSortFunc",value:function(e){e.sort()}}]),t}(dg),Hx.initInfo={name:"ForwardStage",priority:sx.FORWARD},Vx=A((jx=qx).prototype,"renderQueues",[Ux,b,Bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gx=jx))||Gx)),hS=e("cJ",E("ForwardFlow")((Yx=Xx=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"initialize",value:function(e){P(u(t.prototype),"initialize",this).call(this,e);var n=new fS;return n.initialize(fS.initInfo),this._stages.push(n),!0}},{key:"activate",value:function(e){P(u(t.prototype),"activate",this).call(this,e)}},{key:"render",value:function(e){this._pipeline.updateUBOs(e),P(u(t.prototype),"render",this).call(this,e)}},{key:"destroy",value:function(){P(u(t.prototype),"destroy",this).call(this)}}]),t}(Tg),Xx.initInfo={name:"ForwardFlow",priority:cx.FORWARD},Wx=Yx))||Wx),dS=function(){function e(){o(this,e),this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._shadowMapBuffer=null,this._phaseID=Vs("shadow-add"),this._instancedQueue=new wx,this._batchedQueue=new bx}return r(e,[{key:"clear",value:function(e){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear(),this._shadowMapBuffer=e}},{key:"add",value:function(e,t,n){var i=e.model.subModels[t],r=i.passes[n];if(r.phase===this._phaseID)if(this._shadowMapBuffer)if(r.batchingScheme===dc.INSTANCING){var o=m_.get(r);o.merge(i,e.model.instancedAttributes,n),this._instancedQueue.queue.add(o)}else if(r.batchingScheme===dc.VB_MERGING){var a=Ix.get(r);a.merge(i,n,e),this._batchedQueue.queue.add(a)}else{var s=$s.get(oc.get(i.handle,ic.SHADER_0+n));this._subModelsArray.push(i),this._shaderArray.push(s),this._passArray.push(r.handle)}else this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()}},{key:"recordCommandBuffer",value:function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=Cf.getOrCreatePipelineState(e,a,o,t,s),l=ec.get(rc.get(a,Ys.DESCRIPTOR_SET));n.bindPipelineState(c),n.bindDescriptorSet(ya.MATERIAL,l),n.bindDescriptorSet(ya.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}}}]),e}(),vS=[{r:1,g:1,b:1,a:1}],mS=[],pS=e("cM",E("ShadowStage")((Jx=Qx=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this)))._additiveShadowQueue=void 0,e._shadowFrameBuffer=null,e._renderArea={x:0,y:0,width:0,height:0},e._additiveShadowQueue=new dS,e}return c(t,e),r(t,[{key:"setShadowFrameBuffer",value:function(e){this._shadowFrameBuffer=e}}]),r(t,[{key:"destroy",value:function(){}},{key:"render",value:function(e){var t=this._pipeline,n=t.shadows;this._additiveShadowQueue.clear(t.descriptorSet.getBuffer(Aa.BLOCK.binding));for(var i=t.shadowObjects,r=0,o=0,a=0;a<i.length;++a){var s=i[a],c=s.model.subModels;for(r=0;r<c.length;r++){var l=c[r].passes;for(o=0;o<l.length;o++)this._additiveShadowQueue.add(s,r,o)}}var u=e.camera,_=t.commandBuffers[0],f=u.viewport,h=n.size;this._renderArea.x=f.x*h.x,this._renderArea.y=f.y*h.y,this._renderArea.width=f.width*h.x*t.shadingScale,this._renderArea.height=f.height*h.y*t.shadingScale;var d=t.device,v=this._shadowFrameBuffer.renderPass;_.begin(),_.beginRenderPass(v,this._shadowFrameBuffer,this._renderArea,vS,u.clearDepth,u.clearStencil),_.bindDescriptorSet(ya.GLOBAL,t.descriptorSet),this._additiveShadowQueue.recordCommandBuffer(d,v,_),_.endRenderPass(),_.end(),mS[0]=_,d.queue.submit(mS)}}]),t}(dg),Qx.initInfo={name:"ShadowStage",priority:sx.FORWARD},Kx=Jx))||Kx),gS=[yn.LINEAR,yn.LINEAR,yn.NONE,xn.CLAMP,xn.CLAMP,xn.CLAMP],yS=e("cL",E("ShadowFlow")((eS=$x=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r))))._shadowRenderPass=null,n._shadowRenderTargets=[],n._shadowFrameBuffer=null,n._depth=null,n._width=0,n._height=0,n}return c(t,e),r(t,[{key:"initialize",value:function(e){P(u(t.prototype),"initialize",this).call(this,e);var n=new pS;return n.initialize(pS.initInfo),this._stages.push(n),!0}},{key:"activate",value:function(e){P(u(t.prototype),"activate",this).call(this,e);var n=e.device,i=e.shadows.size;this._width=i.x,this._height=i.y,this._shadowRenderPass||(this._shadowRenderPass=n.createRenderPass({colorAttachments:[{format:on.RGBA8,loadOp:In.CLEAR,storeOp:Rn.STORE,sampleCount:1,beginLayout:On.UNDEFINED,endLayout:On.PRESENT_SRC}],depthStencilAttachment:{format:n.depthStencilFormat,depthLoadOp:In.CLEAR,depthStoreOp:Rn.STORE,stencilLoadOp:In.CLEAR,stencilStoreOp:Rn.STORE,sampleCount:1,beginLayout:On.UNDEFINED,endLayout:On.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}})),this._shadowRenderTargets.length<1&&this._shadowRenderTargets.push(n.createTexture({type:Sn.TEX2D,usage:Cn.COLOR_ATTACHMENT|Cn.SAMPLED,format:on.RGBA8,width:this._width,height:this._height})),this._depth||(this._depth=n.createTexture({type:Sn.TEX2D,usage:Cn.DEPTH_STENCIL_ATTACHMENT,format:n.depthStencilFormat,width:this._width,height:this._height})),this._shadowFrameBuffer||(this._shadowFrameBuffer=n.createFramebuffer({renderPass:this._shadowRenderPass,colorTextures:this._shadowRenderTargets,depthStencilTexture:this._depth}));for(var r=0;r<this._stages.length;++r)this._stages[r].setShadowFrameBuffer(this._shadowFrameBuffer);var o=Lo(gS),a=Ko.getSampler(n,o);e.descriptorSet.bindSampler(ba.binding,a),e.descriptorSet.bindTexture(ba.binding,this._shadowRenderTargets[0])}},{key:"render",value:function(e){var n=this._pipeline,i=n.shadows;if(i.type===Pf.ShadowMap){var r=i.size;this._width===r.x&&this._height===r.y||(this.resizeShadowMap(r.x,r.y),this._width=r.x,this._height=r.y),n.updateUBOs(e),P(u(t.prototype),"render",this).call(this,e)}}},{key:"resizeShadowMap",value:function(e,t){if(this._depth&&this._depth.resize(e,t),this._shadowRenderTargets.length>0)for(var n=0;n<this._shadowRenderTargets.length;n++){var i=this._shadowRenderTargets[n];i&&i.resize(e,t)}this._shadowFrameBuffer&&(this._shadowFrameBuffer.destroy(),this._shadowFrameBuffer.initialize({renderPass:this._shadowRenderPass,colorTextures:this._shadowRenderTargets,depthStencilTexture:this._depth}))}},{key:"shadowFrameBuffer",get:function(){return this._shadowFrameBuffer}}]),t}(Tg),$x.initInfo={name:"ShadowFlow",priority:cx.SHADOW,tag:Zy.SCENE},Zx=eS))||Zx),xS=m({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),SS=function(){function e(){o(this,e),this._type=xS.LINEAR,this._fogColor=new ye("#C8C8C8"),this._enabled=!1,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2,this._currType=0,this._colorArray=new Float32Array([.2,.2,.2,1])}return r(e,[{key:"activate",value:function(){ye.toArray(this._colorArray,this._fogColor),this._currType=this._enabled?this._type+1:0,this._updatePipeline()}},{key:"_updatePipeline",value:function(){var e=a.director.root,t=this._currType,n=e.pipeline;n.macros.CC_USE_FOG!==t&&(n.macros.CC_USE_FOG=t,e.onGlobalPipelineStateChanged())}},{key:"enabled",set:function(e){this._enabled!==e&&(this._enabled=e,this._currType=e?this._type+1:0,this._enabled?this.activate():this._updatePipeline())},get:function(){return this._enabled}},{key:"fogColor",set:function(e){this._fogColor.set(e),ye.toArray(this._colorArray,this._fogColor)},get:function(){return this._fogColor}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._enabled&&(this._currType=e+1,this._updatePipeline())}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"currType",get:function(){return this._currType}},{key:"colorArray",get:function(){return this._colorArray}}]),e}(),CS=new s,TS=new ge((function(){return{model:null,depth:0}}),128),ES=new ge((function(){return{model:null,depth:0}}),128);function AS(e,t){var n=0;e.node&&(s.subtract(CS,e.node.worldPosition,t.position),n=s.dot(CS,t.forward));var i=TS.alloc();return i.model=e,i.depth=n,i}function bS(e,t){var n=0;e.node&&(s.subtract(CS,e.node.worldPosition,t.position),n=s.dot(CS,t.forward));var i=ES.alloc();return i.model=e,i.depth=n,i}function wS(e,t){var n=t.camera,i=n.scene,r=e.renderObjects;TS.freeArray(r),r.length=0;var o=e.shadowObjects;ES.freeArray(o),o.length=0;var a=i.mainLight,s=e.shadows,c=s.sphere;c.center.set(0,0,0),c.radius=.01,a&&(a.update(),s.type===Pf.Planar&&s.updateDirLight(a)),e.skybox.enabled&&e.skybox.model&&n.clearFlag&J_&&r.push(AS(e.skybox.model,n));for(var l=i.models,u=0;u<l.length;u++){var _=l[u];if(_.enabled)if(t.visibility&ua.BitMask.UI_2D)(_.node&&t.visibility===_.node.layer||t.visibility===_.visFlags)&&r.push(AS(_,n));else if(_.node&&(t.visibility&_.node.layer)===_.node.layer||t.visibility&_.visFlags){if(_.castShadow&&(Qt.mergeAABB(c,c,_.worldBounds),o.push(bS(_,n))),_.worldBounds&&!wr.aabb_frustum(_.worldBounds,n.frustum))continue;r.push(AS(_,n))}}s.type===Pf.Planar&&s.updateShadowList(i,n.frustum,0!=(n.visibility&ua.BitMask.DEFAULT))}var IS=new f,RS=new f,OS=new v,PS=(e("cI",(tS=E("ForwardPipeline"),nS=F([tx]),iS=ve(),rS=F([nx]),oS=ve(),tS((cS=A((sS=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),I(n,"renderTextures",cS,M(n)),I(n,"materials",lS,M(n)),n.fog=new SS,n.ambient=new V_,n.skybox=new Kh,n.shadows=new Df,n.renderObjects=[],n.shadowObjects=[],n._isHDR=!1,n._shadingScale=1,n._fpScale=1/1024,n._renderPasses=new Map,n._globalUBO=new Float32Array(Ea.COUNT),n._shadowUBO=new Float32Array(Aa.COUNT),n}return c(t,e),r(t,[{key:"initialize",value:function(e){P(u(t.prototype),"initialize",this).call(this,e);var n=new yS;n.initialize(yS.initInfo),this._flows.push(n);var i=new hS;i.initialize(hS.initInfo),this._flows.push(i);var r=new Ax;return r.initialize(Ax.initInfo),this._flows.push(r),!0}},{key:"activate",value:function(){return this._globalDescriptorSetLayout=da,this._localDescriptorSetLayout=va,this._macros={},!!P(u(t.prototype),"activate",this).call(this)&&(!!this._activeRenderer()||(console.error("ForwardPipeline startup failed!"),!1))}},{key:"render",value:function(e){for(var t=0;t<e.length;t++){var n=e[t];wS(this,n);for(var i=0;i<n.flows.length;i++)n.flows[i].render(n)}}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);if(t)return t;var n=this.device,i=new yi,r=new xi;return i.format=n.colorFormat,r.format=n.depthStencilFormat,e&Ln.COLOR||(e&J_?i.loadOp=In.DISCARD:(i.loadOp=In.LOAD,i.beginLayout=On.PRESENT_SRC)),(e&Ln.DEPTH_STENCIL)!==Ln.DEPTH_STENCIL&&(e&Ln.DEPTH||(r.depthLoadOp=In.LOAD),e&Ln.STENCIL||(r.stencilLoadOp=In.LOAD),r.beginLayout=On.DEPTH_STENCIL_ATTACHMENT_OPTIMAL),t=n.createRenderPass({colorAttachments:[i],depthStencilAttachment:r}),this._renderPasses.set(e,t),t}},{key:"updateUBOs",value:function(e){this._updateUBO(e);var t=e.camera.scene.mainLight,n=this.device,i=this.shadows;if(t&&i.type===Pf.ShadowMap){var r=i.getWorldMatrix(t.node.worldRotation,t.direction);f.invert(IS,r);var o=0,a=0;i.orthoSize>i.sphere.radius?(o=i.orthoSize*i.aspect,a=i.orthoSize):(o=i.sphere.radius*i.aspect,a=i.sphere.radius);var s=n.screenSpaceSignY*n.UVSpaceSignY;f.ortho(RS,-o,o,-a,a,i.near,i.far,n.clipSpaceMinZ,s),f.multiply(RS,RS,IS),f.toArray(this._shadowUBO,RS,Aa.MAT_LIGHT_VIEW_PROJ_OFFSET),OS.set(i.pcf),v.toArray(this._shadowUBO,OS,Aa.SHADOW_PCF_OFFSET),OS.set(i.size.x,i.size.y),v.toArray(this._shadowUBO,OS,Aa.SHADOW_SIZE_OFFSET)}this._descriptorSet.getBuffer(Ea.BLOCK.binding).update(this._globalUBO),this._descriptorSet.getBuffer(Aa.BLOCK.binding).update(this._shadowUBO)}},{key:"_activeRenderer",value:function(){var e=this.device;this._commandBuffers.push(e.createCommandBuffer({type:wn.PRIMARY,queue:this._device.queue}));var t=e.createBuffer({usage:an.UNIFORM|an.TRANSFER_DST,memUsage:sn.HOST|sn.DEVICE,size:Ea.SIZE});this._descriptorSet.bindBuffer(Ea.BLOCK.binding,t);var n=e.createBuffer({usage:an.UNIFORM|an.TRANSFER_DST,memUsage:sn.HOST|sn.DEVICE,size:Aa.SIZE});return this._descriptorSet.bindBuffer(Aa.BLOCK.binding,n),this.macros.CC_USE_HDR=this._isHDR,this.macros.CC_SUPPORT_FLOAT_TEXTURE=this.device.hasFeature(ti.TEXTURE_FLOAT),!0}},{key:"_updateUBO",value:function(e){this._descriptorSet.update();var t=a.director.root,n=e.camera,i=n.scene.mainLight,r=this.ambient,o=this.fog,c=this._globalUBO,l=this.device,u=Math.floor(l.width),_=Math.floor(l.height);c[Ea.TIME_OFFSET]=t.cumulativeTime,c[Ea.TIME_OFFSET+1]=t.frameTime,c[Ea.TIME_OFFSET+2]=a.director.getTotalFrames(),c[Ea.SCREEN_SIZE_OFFSET]=l.width,c[Ea.SCREEN_SIZE_OFFSET+1]=l.height,c[Ea.SCREEN_SIZE_OFFSET+2]=1/c[Ea.SCREEN_SIZE_OFFSET],c[Ea.SCREEN_SIZE_OFFSET+3]=1/c[Ea.SCREEN_SIZE_OFFSET+1],c[Ea.SCREEN_SCALE_OFFSET]=n.width/u*this.shadingScale,c[Ea.SCREEN_SCALE_OFFSET+1]=n.height/_*this.shadingScale,c[Ea.SCREEN_SCALE_OFFSET+2]=1/c[Ea.SCREEN_SCALE_OFFSET],c[Ea.SCREEN_SCALE_OFFSET+3]=1/c[Ea.SCREEN_SCALE_OFFSET+1],c[Ea.NATIVE_SIZE_OFFSET]=u,c[Ea.NATIVE_SIZE_OFFSET+1]=_,c[Ea.NATIVE_SIZE_OFFSET+2]=1/c[Ea.NATIVE_SIZE_OFFSET],c[Ea.NATIVE_SIZE_OFFSET+3]=1/c[Ea.NATIVE_SIZE_OFFSET+1],f.toArray(c,n.matView,Ea.MAT_VIEW_OFFSET),f.toArray(c,n.node.worldMatrix,Ea.MAT_VIEW_INV_OFFSET),f.toArray(c,n.matProj,Ea.MAT_PROJ_OFFSET),f.toArray(c,n.matProjInv,Ea.MAT_PROJ_INV_OFFSET),f.toArray(c,n.matViewProj,Ea.MAT_VIEW_PROJ_OFFSET),f.toArray(c,n.matViewProjInv,Ea.MAT_VIEW_PROJ_INV_OFFSET),s.toArray(c,n.position,Ea.CAMERA_POS_OFFSET);var h=l.screenSpaceSignY;e.window.hasOffScreenAttachments&&(h*=l.UVSpaceSignY),c[Ea.CAMERA_POS_OFFSET+3]=h;var d=n.exposure;if(c[Ea.EXPOSURE_OFFSET]=d,c[Ea.EXPOSURE_OFFSET+1]=1/d,c[Ea.EXPOSURE_OFFSET+2]=this._isHDR?1:0,c[Ea.EXPOSURE_OFFSET+3]=this._fpScale/d,i){if(s.toArray(c,i.direction,Ea.MAIN_LIT_DIR_OFFSET),s.toArray(c,i.color,Ea.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var m=i.colorTemperatureRGB;c[Ea.MAIN_LIT_COLOR_OFFSET]*=m.x,c[Ea.MAIN_LIT_COLOR_OFFSET+1]*=m.y,c[Ea.MAIN_LIT_COLOR_OFFSET+2]*=m.z}this._isHDR?c[Ea.MAIN_LIT_COLOR_OFFSET+3]=i.illuminance*this._fpScale:c[Ea.MAIN_LIT_COLOR_OFFSET+3]=i.illuminance*d}else s.toArray(c,s.UNIT_Z,Ea.MAIN_LIT_DIR_OFFSET),v.toArray(c,v.ZERO,Ea.MAIN_LIT_COLOR_OFFSET);var p=r.colorArray;this._isHDR?p[3]=r.skyIllum*this._fpScale:p[3]=r.skyIllum*d,c.set(p,Ea.AMBIENT_SKY_OFFSET),c.set(r.albedoArray,Ea.AMBIENT_GROUND_OFFSET),o.enabled&&(c.set(o.colorArray,Ea.GLOBAL_FOG_COLOR_OFFSET),c[Ea.GLOBAL_FOG_BASE_OFFSET]=o.fogStart,c[Ea.GLOBAL_FOG_BASE_OFFSET+1]=o.fogEnd,c[Ea.GLOBAL_FOG_BASE_OFFSET+2]=o.fogDensity,c[Ea.GLOBAL_FOG_ADD_OFFSET]=o.fogTop,c[Ea.GLOBAL_FOG_ADD_OFFSET+1]=o.fogRange,c[Ea.GLOBAL_FOG_ADD_OFFSET+2]=o.fogAtten)}},{key:"destroyUBOs",value:function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Ea.BLOCK.binding).destroy(),this._descriptorSet.getBuffer(Aa.BLOCK.binding).destroy())}},{key:"destroy",value:function(){this.destroyUBOs();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return P(u(t.prototype),"destroy",this).call(this)}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR!==e&&(this._isHDR=e,this._globalUBO[Ea.EXPOSURE_OFFSET+2]=this._isHDR?1:0)}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"fpScale",get:function(){return this._fpScale}},{key:"shadowUBO",get:function(){return this._shadowUBO}}]),t}($y)).prototype,"renderTextures",[nS,b,iS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lS=A(sS.prototype,"materials",[rS,b,oS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aS=sS))||aS)),new X),NS=e("bf",function(){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;o(this,e),this._point=new X,this._prevPoint=new X,this._lastModified=0,this._id=0,this._startPoint=new X,this._startPointCaptured=!1,this.setTouchInfo(i,t,n)}return r(e,[{key:"lastModified",get:function(){return this._lastModified}}]),r(e,[{key:"getLocation",value:function(e){return e||(e=new X),e.set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return e||(e=new X),e.set(this._point.x,this._point.y),a.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=a.view.getViewportRect();return(this._point.x-e.x)/a.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=a.view.getViewportRect();return(this._point.y-e.y)/a.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return e||(e=new X),e.set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new X),e.set(this._prevPoint.x,this._prevPoint.y),a.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return e||(e=new X),e.set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return e||(e=new X),e.set(this._startPoint.x,this._startPoint.y),a.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new X),e.set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e||(e=new X),PS.set(this._point),PS.subtract(this._prevPoint),e.set(a.view.getScaleX(),a.view.getScaleY()),X.divide(e,PS,e),e}},{key:"getLocationInView",value:function(e){return e||(e=new X),e.set(this._point.x,a.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return e||(e=new X),e.set(this._prevPoint.x,a.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return e||(e=new X),e.set(this._startPoint.x,a.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;this._prevPoint=this._point,this._point=new X(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new X(this._point),this._startPointCaptured=!0)}},{key:"setPoint",value:function(e,t){"object"===ae(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=a.director.getCurrentTime()}},{key:"setPrevPoint",value:function(e,t){"object"===ae(e)?this._prevPoint=new X(e.x,e.y):this._prevPoint=new X(e||0,t||0),this._lastModified=a.director.getCurrentTime()}}]),e}());a.Touch=NS;var DS,zS=$o.TOUCH_TIMEOUT,MS=new X,LS=new X,FS=e("ba",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;o(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=n,this.z=i,this.timestamp=r}));a.internal.Acceleration=FS;var kS=e("d7",new(function(){function e(){o(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new X,this._prevMousePoint=new X,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._pointLocked=!1}return r(e,[{key:"handleTouchesBegin",value:function(e){for(var t=[],n=this._touchesIntegerDict,i=0;i<e.length;++i){var r=e[i],o=r.getID();if(null!==o)if(void 0===n[o]){var a=this._getUnUsedIndex();if(-1===a){ee(2300,a);continue}r.getLocation(MS);var s=new NS(MS.x,MS.y,o);this._touches[a]=s,r.getPreviousLocation(MS),s.setPrevPoint(MS),n[o]=a,t.push(s)}}if(t.length>0){var c=new ol(t,!1,ol.BEGAN,$o.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);pl.dispatchEvent(c)}}},{key:"handleTouchesMove",value:function(e){for(var t=[],n=this._touches,i=0;i<e.length;++i){var r=e[i],o=r.getID();if(null!==o){var a=this._touchesIntegerDict[o];void 0!==a&&n[a]&&(r.getLocation(MS),n[a].setPoint(MS),r.getPreviousLocation(MS),n[a].setPrevPoint(MS),t.push(n[a]))}}if(t.length>0){var s=new ol(t,!1,ol.MOVED,$o.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);pl.dispatchEvent(s)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var n=new ol(t,!1,ol.ENDED,$o.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);pl.dispatchEvent(n)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var n=new ol(t,!1,ol.CANCELLED,$o.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);pl.dispatchEvent(n)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){for(var t=[],n=this._touches,i=this._touchesIntegerDict,r=0;r<e.length;++r){var o=e[r],a=o.getID();if(null!==a){var s=i[a];void 0!==s&&n[s]&&(o.getLocation(MS),n[s].setPoint(MS),o.getPreviousLocation(MS),n[s].setPrevPoint(MS),t.push(n[s]),this._removeUsedIndexBit(s),delete i[a])}}return t}},{key:"getHTMLElementPosition",value:function(e){var t=document.documentElement,n=O.os===O.OS_IOS&&O.isBrowser?window.screenLeft:window.pageXOffset;n-=t.clientLeft;var i=O.os===O.OS_IOS&&O.isBrowser?window.screenTop:window.pageYOffset;if(i-=t.clientTop,e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+n,top:r.top+i,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:n,top:i,width:e.width,height:e.height}:{left:n,top:i,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,n=this._preTouchPool,i=e.getID(),r=n.length-1;r>=0;r--)if(n[r].getID()===i){t=n[r];break}return t||(t=e),t}},{key:"setPreTouch",value:function(e){for(var t=!1,n=this._preTouchPool,i=e.getID(),r=n.length-1;r>=0;r--)if(n[r].getID()===i){n[r]=e,t=!0;break}t||(n.length<=50?n.push(e):(n[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,n,i){var r=this._preTouchPoint,o=this._glView.convertToLocationInView(t,n,i);this._pointLocked&&(o.x=r.x+e.movementX,o.y=r.y-e.movementY);var a=new NS(o.x,o.y,0);return a.setPrevPoint(r.x,r.y),r.x=o.x,r.y=o.y,a}},{key:"getMouseEvent",value:function(e,t,n){var i=this._prevMousePoint,r=new rl(n,!1,i);return i.x=e.x,i.y=e.y,this._glView._convertMouseToLocation(i,t),r.setLocation(i.x,i.y),r}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop,{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var n=[],i=this._glView,r=this._preTouchPoint,o=e.changedTouches.length,a=0;a<o;a++){var s=e.changedTouches[a];if(s){var c=void 0;c=O.BROWSER_TYPE_FIREFOX===O.browserType?i.convertToLocationInView(s.pageX,s.pageY,t,MS):i.convertToLocationInView(s.clientX,s.clientY,t,MS);var l=void 0;if(null!=s.identifier?(l=new NS(c.x,c.y,s.identifier),this.getPreTouch(l).getLocation(LS),l.setPrevPoint(LS.x,LS.y),this.setPreTouch(l)):(l=new NS(c.x,c.y)).setPrevPoint(r.x,r.y),r.x=c.x,r.y=c.y,n.push(l),!$o.ENABLE_MULTI_TOUCH)break}}return n}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent&&e){this._glView=a.view;var t=O.isMobile,n="mouse"in O.capabilities,i="touches"in O.capabilities;n&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),i&&this._registerTouchEvents(e),this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=a.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,n=0,i=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var o=e.accelerationIncludingGravity;o&&(n=this._accelMinus*(o.x||0)*.1,i=this._accelMinus*(o.y||0)*.1,r=.1*(o.z||0))}else{var s=e;n=(s.gamma||0)/90*.981,i=-(s.beta||0)/90*.981,r=(s.alpha||0)/90*.981}if(a.view._isRotated){var c=n;n=-i,i=c}t.x=n,t.y=i,t.z=r,t.timestamp=e.timeStamp||Date.now();var l=t.x;90===window.orientation?(t.x=-t.y,t.y=l):-90===window.orientation?(t.x=t.y,t.y=-l):180===window.orientation&&(t.x=-t.x,t.y=-t.y),a.sys.os===a.sys.OS_ANDROID&&a.sys.browserType!==a.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,pl.dispatchEvent(new al(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=a.director.getCurrentTime(),n=0;n<this._maxTouches;n++){if(!(1&e))return this._indexBitsUsed|=1<<n,n;var i=this._touches[n];if(t-i.lastModified>zS){this._removeUsedIndexBit(n);var r=i.getID();return null!==r&&delete this._touchesIntegerDict[r],n}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){var e=this,t=function(){var t=a.game.canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)}},{key:"_registerWindowMouseEvents",value:function(e){var t=this;window.addEventListener("mousedown",(function(){t._mousePressed=!0}),!1),window.addEventListener("mouseup",(function(n){if(t._mousePressed){t._mousePressed=!1;var i=t.getHTMLElementPosition(e),r=t.getPointByEvent(n,i);if(!nt(i.left,i.top,i.width,i.height).contains(new X(r.x,r.y))){t.handleTouchesEnd([t.getTouchByXY(n,r.x,r.y,i)]);var o=t.getMouseEvent(r,i,rl.UP);o.setButton(n.button),pl.dispatchEvent(o)}}}),!1)}},{key:"_registerElementMouseEvents",value:function(e,t){var n=this,i=function(t,i,r){e.addEventListener(t,(function(t){var o=n.getHTMLElementPosition(e),a=n.getPointByEvent(t,o),s=n.getMouseEvent(a,o,i);s.setButton(t.button),r(t,s,a,o),pl.dispatchEvent(s),t.stopPropagation(),t.preventDefault()}))};t||(i("mousedown",rl.DOWN,(function(t,i,r,o){n._mousePressed=!0,n.handleTouchesBegin([n.getTouchByXY(t,r.x,r.y,o)]),e.focus()})),i("mouseup",rl.UP,(function(e,t,i,r){n._mousePressed=!1,n.handleTouchesEnd([n.getTouchByXY(e,i.x,i.y,r)])})),i("mousemove",rl.MOVE,(function(e,t,i,r){n.handleTouchesMove([n.getTouchByXY(e,i.x,i.y,r)]),n._mousePressed||t.setButton(rl.BUTTON_MISSING),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)}))),i("mousewheel",rl.SCROLL,(function(e,t,n,i){t.setScrollData(0,e.wheelDelta)})),i("DOMMouseScroll",rl.SCROLL,(function(e,t,n,i){t.setScrollData(0,-120*e.detail)}))}},{key:"_registerMousePointerEvents",value:function(e){var t=this,n={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel},i=function(i){var r=n[i];e.addEventListener(i,(function(n){var i=t.getHTMLElementPosition(e);i.left-=document.documentElement.scrollLeft,i.top-=document.documentElement.scrollTop,r.call(t,[t.getTouchByXY(n,n.clientX,n.clientY,i)]),n.stopPropagation()}),!1)};for(var r in n)i(r)}},{key:"_registerTouchEvents",value:function(e){var t=this,n=function(n){return function(i){if(i.changedTouches){var r=t.getHTMLElementPosition(e),o=document.body;r.left-=o.scrollLeft||0,r.top-=o.scrollTop||0,n(t.getTouchesByEvent(i,r)),i.stopPropagation(),i.preventDefault()}}};e.addEventListener("touchstart",n((function(n){t.handleTouchesBegin(n),e.focus()})),!1),e.addEventListener("touchmove",n((function(e){t.handleTouchesMove(e)})),!1),e.addEventListener("touchend",n((function(e){t.handleTouchesEnd(e)})),!1),e.addEventListener("touchcancel",n((function(e){t.handleTouchesCancel(e)})),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=a.game.canvas;e.addEventListener("keydown",(function(e){pl.dispatchEvent(new sl(e,!0)),e.stopPropagation(),e.preventDefault()}),!1),e.addEventListener("keyup",(function(e){pl.dispatchEvent(new sl(e,!1)),e.stopPropagation(),e.preventDefault()}),!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new FS,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,a.sys.browserType===a.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";DS=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,DS,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";DS&&window.removeEventListener(e,DS,!1)}},{key:"_getUsefulTouches",value:function(){var e=[],t=this._touchesIntegerDict;for(var n in t){var i=t[parseInt(n)];if(null!=i){var r=this._touches[i];e.push(r)}}return e}}]),e}()));a.internal.inputManager=kS;var US=e("bh",function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r)))).frame=null,n.container=null,n.canvas=null,n.renderType=-1,n.eventTargetOn=P(u(t.prototype),"on",M(n)),n.eventTargetOnce=P(u(t.prototype),"once",M(n)),n.config={},n.onStart=null,n._persistRootNodes={},n._paused=!0,n._configLoaded=!1,n._isCloning=!1,n._inited=!1,n._rendererInitialized=!1,n._gfxDevice=null,n._intervalId=null,n._lastTime=null,n._frameTime=null,n._sceneInfos=[],n.collisionMatrix=[],n.groupList=[],n}return c(t,e),r(t,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate||0}},{key:"step",value:function(){a.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){a.director.once(a.Director.EVENT_AFTER_DRAW,(function(){for(var e in a.game._persistRootNodes)a.game.removePersistRootNode(a.game._persistRootNodes[e]);a.director.getScene().destroy(),a.Object._deferredDestroy(),a.director.reset(),a.game.pause(),a.game._loadRenderPipeline((function(){a.game.resume(),a.game._safeEmit(a.Game.EVENT_RESTART)}))}))}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,n,i,r){this._inited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOn(e,n,i,r)}},{key:"once",value:function(e,n,i){this._inited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)}},{key:"init",value:function(e){return this._initConfig(e),this.config.assetOptions&&zm.init(this.config.assetOptions),this._initEngine(),this._initEvents(),a.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),this._inited}},{key:"run",value:function(e,t){if(this._initEvents(),"function"!=typeof e&&t){var n=this.onStart;this.init(n),this.onStart=t}else this.onStart=e;this._setAnimFrame(),this._runMainLoop(),bT.config.registerSystemEvent&&kS.registerSystemEvent(bT.canvas),this._loadRenderPipeline(null)}},{key:"addPersistRootNode",value:function(e){if(a.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=a.director._scene;if(a.isValid(n))if(e.parent){if(!(e.parent instanceof a.Scene))return void G(3801);if(e.parent!==n)return void G(3802)}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0}}else G(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"_initEngine",value:function(){this._initDevice(),a.director._init(),console.log("Cocos Creator 3D v"+a.ENGINE_VERSION),this.emit(t.EVENT_ENGINE_INITED),this._inited=!0}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=a.game.config.frameRate;this._frameTime=1e3/e,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),60!==e&&30!==e?(window.rAF=this._stTime,window.cAF=this._ctTime):(window.rAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),n=Math.max(0,t-a.game._lastTime),i=Math.max(0,a.game._frameTime-n),r=window.setTimeout(e,i);return a.game._lastTime=t+i,r}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var e,t=this,n=this.config,i=a.director,r=!0,o=n.frameRate;it(!!n.showFPS),i.startAnimation(),e=function(n){t._paused||(t._intervalId=window.rAF(e),30===o&&(r=!r)||i.mainLoop(n))},this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(e),this._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],rt(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,n=parseInt(e.renderMode);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(0===n?a.sys.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):a.sys.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):1===n&&a.sys.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):2===n&&a.sys.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(se(3820,n))}},{key:"_initDevice",value:function(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var e=[],n=!!window.WebGL2RenderingContext,i=window.navigator.userAgent.toLowerCase();(-1!==i.indexOf("safari")&&-1===i.indexOf("chrome")||O.browserType===O.BROWSER_TYPE_UC)&&(n=!1),n&&a.WebGL2Device&&e.push(a.WebGL2Device),a.WebGLDevice&&e.push(a.WebGLDevice);for(var r={canvasElm:this.canvas,debug:!0,isAntialias:$o.ENABLE_WEBGL_ANTIALIAS,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*window.devicePixelRatio),nativeHeight:Math.floor(screen.height*window.devicePixelRatio),bindingMappingInfo:Ta},o=0;o<e.length&&(this._gfxDevice=new e[o],!this._gfxDevice.initialize(r));o++);}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!a._isContextMenuEnable)return!1}}}},{key:"_initEvents",value:function(){var e,n=window;void 0!==document.hidden?e="hidden":void 0!==document.mozHidden?e="mozHidden":void 0!==document.msHidden?e="msHidden":void 0!==document.webkitHidden&&(e="webkitHidden");var i=!1;function r(){i||(i=!0,a.game.emit(t.EVENT_HIDE))}function o(){i&&(i=!1,a.game.emit(t.EVENT_SHOW))}if(e)for(var s=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],c=0;c<s.length;c++)document.addEventListener(s[c],(function(t){var n=document[e];(n=n||t.hidden)?r():o()}));else n.addEventListener("blur",r),n.addEventListener("focus",o);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(n.onfocus=o),"onpageshow"in window&&"onpagehide"in window&&(n.addEventListener("pagehide",r),n.addEventListener("pageshow",o),document.addEventListener("pagehide",r),document.addEventListener("pageshow",o)),this.on(t.EVENT_HIDE,(function(){a.game.pause()})),this.on(t.EVENT_SHOW,(function(){a.game.resume()}))}},{key:"_loadRenderPipeline",value:function(e){var n=this,i=a.internal.SplashScreen,r=this.config.renderPipeline;if(r)a.loader.load({uuid:r},(function(o,s){if(!o&&s instanceof $y)try{n._setRenderPipeline(s)}catch(e){console.warn(e),console.warn("Failed load renderpipeline: ".concat(r,", engine failed to initialize, will fallback to default pipeline")),n._setRenderPipeline()}else console.warn("Failed load renderpipeline: ".concat(r,", engine failed to initialize, will fallback to default pipeline")),console.warn(o),n._setRenderPipeline();if(n._safeEmit(t.EVENT_GAME_INITED),i){var c=a.internal.SplashScreen.instance;c.main(a.director.root),c.setOnFinish((function(){n.onStart&&n.onStart(),e&&e()})),c.loadFinish=!0}else n.onStart&&n.onStart(),e&&e()}));else if(this._setRenderPipeline(),this._safeEmit(t.EVENT_GAME_INITED),i){var o=a.internal.SplashScreen.instance;o.main(a.director.root),o.setOnFinish((function(){n.onStart&&n.onStart(),e&&e()})),o.loadFinish=!0}else this.onStart&&this.onStart(),e&&e()}},{key:"_setRenderPipeline",value:function(e){a.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)}},{key:"_safeEmit",value:function(e){this.emit(e)}},{key:"inited",get:function(){return this._inited}}]),t}(ot));US.EVENT_HIDE="game_on_hide",US.EVENT_SHOW="game_on_show",US.EVENT_GAME_INITED="game_inited",US.EVENT_ENGINE_INITED="engine_inited",US.EVENT_RENDERER_INITED="renderer_inited",US.EVENT_RESTART="game_on_restart",US.RENDER_TYPE_CANVAS=0,US.RENDER_TYPE_WEBGL=1,US.RENDER_TYPE_OPENGL=2,a.Game=US;var BS,GS,jS,VS,HS,qS,WS,XS,YS,KS,QS,JS,ZS,$S,eC,tC,nC,iC,rC,oC,aC,sC,cC,lC,uC,_C,fC,hC,dC,vC,mC,pC,gC,yC,xC,SC,CC,TC,EC,AC,bC,wC,IC,RC,OC,PC,NC,DC,zC,MC,LC,FC,kC,UC,BC,GC,jC,VC,HC,qC,WC,XC,YC,KC,QC,JC,ZC,$C,eT,tT,nT,iT,rT,oT,aT,sT,cT,lT,uT,_T,fT,hT,dT,vT,mT,pT,gT,yT,xT,ST,CT,TT,ET,AT,bT=e("bi",a.game=new US),wT=new s(0,1,0),IT=new s,RT=new W,OT=(BS=E("cc.AmbientInfo"),GS=F(at),BS((HS=A((VS=function(){function e(){o(this,e),I(this,"_skyColor",HS,this),I(this,"_skyIllum",qS,this),I(this,"_groundAlbedo",WS,this),this._resource=null}return r(e,[{key:"activate",value:function(e){this._resource=e,this._resource.skyColor=this._skyColor,this._resource.skyIllum=this._skyIllum,this._resource.groundAlbedo=this._groundAlbedo}},{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&(this._resource.skyColor=this._skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)},get:function(){return this._groundAlbedo}}]),e}()).prototype,"_skyColor",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ye(51,128,204,1)}}),qS=A(VS.prototype,"_skyIllum",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return V_.SKY_ILLUM}}),WS=A(VS.prototype,"_groundAlbedo",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ye(51,51,51,255)}}),A(VS.prototype,"skyColor",[w],Object.getOwnPropertyDescriptor(VS.prototype,"skyColor"),VS.prototype),A(VS.prototype,"skyIllum",[w,GS],Object.getOwnPropertyDescriptor(VS.prototype,"skyIllum"),VS.prototype),A(VS.prototype,"groundAlbedo",[w],Object.getOwnPropertyDescriptor(VS.prototype,"groundAlbedo"),VS.prototype),jS=VS))||jS);a.AmbientInfo=OT;var PT=(XS=E("cc.SkyboxInfo"),YS=F(Ms),KS=F(Ms),XS((ZS=A((JS=function(){function e(){o(this,e),I(this,"_envmap",ZS,this),I(this,"_isRGBE",$S,this),I(this,"_enabled",eC,this),I(this,"_useIBL",tC,this),this._resource=null}return r(e,[{key:"activate",value:function(e){this._resource=e,this._resource.activate(),this._resource.enabled=this._enabled,this._resource.isRGBE=this._isRGBE,this._resource.envmap=this._envmap,this._resource.useIBL=this._useIBL}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}}]),e}()).prototype,"_envmap",[YS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$S=A(JS.prototype,"_isRGBE",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eC=A(JS.prototype,"_enabled",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tC=A(JS.prototype,"_useIBL",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),A(JS.prototype,"enabled",[w],Object.getOwnPropertyDescriptor(JS.prototype,"enabled"),JS.prototype),A(JS.prototype,"useIBL",[w],Object.getOwnPropertyDescriptor(JS.prototype,"useIBL"),JS.prototype),A(JS.prototype,"envmap",[w,KS],Object.getOwnPropertyDescriptor(JS.prototype,"envmap"),JS.prototype),A(JS.prototype,"isRGBE",[w],Object.getOwnPropertyDescriptor(JS.prototype,"isRGBE"),JS.prototype),QS=JS))||QS);a.SkyboxInfo=PT;var NT=(nC=E("cc.FogInfo"),iC=F(xS),rC=Ae(),oC=F(at),aC=ct(),sC=lt(),cC=ve(),lC=Ae(),uC=F(at),_C=lt(),fC=ve(),hC=Ae(),dC=F(at),vC=lt(),mC=ve(),pC=Ae(),gC=F(at),yC=Q(),xC=lt(),SC=ve(),CC=Ae(),TC=F(at),EC=lt(),AC=ve(),bC=Ae(),wC=F(at),IC=lt(),RC=ve(),nC((jC=GC=function(){function e(){o(this,e),I(this,"_type",NC,this),I(this,"_fogColor",DC,this),I(this,"_enabled",zC,this),I(this,"_fogDensity",MC,this),I(this,"_fogStart",LC,this),I(this,"_fogEnd",FC,this),I(this,"_fogAtten",kC,this),I(this,"_fogTop",UC,this),I(this,"_fogRange",BC,this),this._resource=null}return r(e,[{key:"activate",value:function(e){this._resource=e,this._resource.enabled=this._enabled,this._resource.fogColor=this._fogColor,this._resource.type=this._type,this._resource.fogDensity=this._fogDensity,this._resource.fogStart=this._fogStart,this._resource.fogEnd=this._fogEnd,this._resource.fogAtten=this._fogAtten,this._resource.fogTop=this._fogTop,this._resource.fogRange=this._fogRange}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"fogColor",set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)},get:function(){return this._fogColor}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),GC.FogType=xS,NC=A((PC=jC).prototype,"_type",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xS.LINEAR}}),DC=A(PC.prototype,"_fogColor",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ye("#C8C8C8")}}),zC=A(PC.prototype,"_enabled",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),MC=A(PC.prototype,"_fogDensity",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),LC=A(PC.prototype,"_fogStart",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),FC=A(PC.prototype,"_fogEnd",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),kC=A(PC.prototype,"_fogAtten",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),UC=A(PC.prototype,"_fogTop",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),BC=A(PC.prototype,"_fogRange",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),A(PC.prototype,"enabled",[w],Object.getOwnPropertyDescriptor(PC.prototype,"enabled"),PC.prototype),A(PC.prototype,"fogColor",[w],Object.getOwnPropertyDescriptor(PC.prototype,"fogColor"),PC.prototype),A(PC.prototype,"type",[w,iC],Object.getOwnPropertyDescriptor(PC.prototype,"type"),PC.prototype),A(PC.prototype,"fogDensity",[rC,oC,aC,sC,st,cC],Object.getOwnPropertyDescriptor(PC.prototype,"fogDensity"),PC.prototype),A(PC.prototype,"fogStart",[lC,uC,_C,fC],Object.getOwnPropertyDescriptor(PC.prototype,"fogStart"),PC.prototype),A(PC.prototype,"fogEnd",[hC,dC,vC,mC],Object.getOwnPropertyDescriptor(PC.prototype,"fogEnd"),PC.prototype),A(PC.prototype,"fogAtten",[pC,gC,yC,xC,SC],Object.getOwnPropertyDescriptor(PC.prototype,"fogAtten"),PC.prototype),A(PC.prototype,"fogTop",[CC,TC,EC,AC],Object.getOwnPropertyDescriptor(PC.prototype,"fogTop"),PC.prototype),A(PC.prototype,"fogRange",[bC,wC,IC,RC],Object.getOwnPropertyDescriptor(PC.prototype,"fogRange"),PC.prototype),OC=PC))||OC),DT=(VC=E("cc.ShadowsInfo"),HC=F(Pf),qC=Ae(),WC=F(at),XC=Ae(),YC=F(Nf),KC=Ae(),QC=F(at),JC=Ae(),ZC=F(at),$C=Ae(),eT=F(at),tT=Ae(),nT=Ae(),iT=F(at),rT=Ae(),VC((sT=A((aT=function(){function e(){o(this,e),I(this,"_type",sT,this),I(this,"_enabled",cT,this),I(this,"_normal",lT,this),I(this,"_distance",uT,this),I(this,"_shadowColor",_T,this),I(this,"_pcf",fT,this),I(this,"_near",hT,this),I(this,"_far",dT,this),I(this,"_aspect",vT,this),I(this,"_orthoSize",mT,this),I(this,"_size",pT,this),this._resource=null}return r(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(RT),this.normal=s.transformQuat(IT,wT,RT),e.getWorldPosition(IT),this.distance=s.dot(this._normal,IT)}},{key:"activate",value:function(e){this._resource=e,this._resource.type=this._type,this._resource.near=this._near,this._resource.far=this._far,this._resource.orthoSize=this._orthoSize,this._resource.size=this._size,this._resource.normal=this._normal,this._resource.distance=this._distance,this._resource.shadowColor=this._shadowColor,this._resource.pcf=this._pcf,this._resource.enabled=this._enabled}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"type",set:function(e){this._type=e,this._resource&&(this._resource.type=e)},get:function(){return this._type}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"normal",set:function(e){s.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"pcf",set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)},get:function(){return this._pcf}},{key:"near",set:function(e){this._near=e,this._resource&&(this._resource.near=e)},get:function(){return this._near}},{key:"far",set:function(e){this._far=e,this._resource&&(this._resource.far=e)},get:function(){return this._far}},{key:"orthoSize",set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)},get:function(){return this._orthoSize}},{key:"shadowMapSize",set:function(e){this._size.set(e),this._resource&&(this._resource.size=e)},get:function(){return this._size}},{key:"aspect",set:function(e){this._aspect=e,this._resource&&(this._resource.aspect=e)},get:function(){return this._aspect}}]),e}()).prototype,"_type",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pf.Planar}}),cT=A(aT.prototype,"_enabled",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lT=A(aT.prototype,"_normal",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s(0,1,0)}}),uT=A(aT.prototype,"_distance",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_T=A(aT.prototype,"_shadowColor",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ye(0,0,0,76)}}),fT=A(aT.prototype,"_pcf",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nf.HARD}}),hT=A(aT.prototype,"_near",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),dT=A(aT.prototype,"_far",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),vT=A(aT.prototype,"_aspect",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mT=A(aT.prototype,"_orthoSize",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),pT=A(aT.prototype,"_size",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new X(512,512)}}),A(aT.prototype,"enabled",[w],Object.getOwnPropertyDescriptor(aT.prototype,"enabled"),aT.prototype),A(aT.prototype,"type",[w,HC],Object.getOwnPropertyDescriptor(aT.prototype,"type"),aT.prototype),A(aT.prototype,"shadowColor",[w],Object.getOwnPropertyDescriptor(aT.prototype,"shadowColor"),aT.prototype),A(aT.prototype,"normal",[qC],Object.getOwnPropertyDescriptor(aT.prototype,"normal"),aT.prototype),A(aT.prototype,"distance",[WC,XC],Object.getOwnPropertyDescriptor(aT.prototype,"distance"),aT.prototype),A(aT.prototype,"pcf",[YC,KC],Object.getOwnPropertyDescriptor(aT.prototype,"pcf"),aT.prototype),A(aT.prototype,"near",[QC,JC],Object.getOwnPropertyDescriptor(aT.prototype,"near"),aT.prototype),A(aT.prototype,"far",[ZC,$C],Object.getOwnPropertyDescriptor(aT.prototype,"far"),aT.prototype),A(aT.prototype,"orthoSize",[eT,tT],Object.getOwnPropertyDescriptor(aT.prototype,"orthoSize"),aT.prototype),A(aT.prototype,"shadowMapSize",[nT],Object.getOwnPropertyDescriptor(aT.prototype,"shadowMapSize"),aT.prototype),A(aT.prototype,"aspect",[iT,rT],Object.getOwnPropertyDescriptor(aT.prototype,"aspect"),aT.prototype),oT=aT))||oT);a.ShadowsInfo=DT;var zT,MT,LT,FT,kT=(gT=E("cc.SceneGlobals"),yT=F(PT),gT((CT=A((ST=function(){function e(){o(this,e),I(this,"ambient",CT,this),I(this,"shadows",TT,this),I(this,"_skybox",ET,this),I(this,"fog",AT,this)}return r(e,[{key:"activate",value:function(){var e=a.director.root.pipeline;this.ambient.activate(e.ambient),this.skybox.activate(e.skybox),this.shadows.activate(e.shadows),this.fog.activate(e.fog)}},{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}()).prototype,"ambient",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OT}}),TT=A(ST.prototype,"shadows",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new DT}}),ET=A(ST.prototype,"_skybox",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new PT}}),AT=A(ST.prototype,"fog",[w,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new NT}}),A(ST.prototype,"skybox",[w,yT],Object.getOwnPropertyDescriptor(ST.prototype,"skybox"),ST.prototype),xT=ST))||xT);a.SceneGlobals=kT;var UT,BT=e("cX",E("cc.Scene")((A((MT=function(e){function t(e){var n;return o(this,t),n=l(this,u(t).call(this,e)),I(n,"autoReleaseAssets",LT,M(n)),I(n,"_globals",FT,M(n)),n._renderScene=null,n.dependAssets=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=s.ZERO,n._rot=W.IDENTITY,n._scale=s.ONE,n._mat=f.IDENTITY,n._dirtyFlags=0,n._activeInHierarchy=!1,a.director&&a.director.root&&(n._renderScene=a.director.root.createScene({})),n._inited=!a.game||!a.game._isCloning,n}return c(t,e),r(t,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),r(t,[{key:"destroy",value:function(){var e=P(u(t.prototype),"destroy",this).call(this);return a.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"addComponent",value:function(e){throw new Error(se(3822))}},{key:"_onHierarchyChanged",value:function(){}},{key:"_onBatchCreated",value:function(){P(u(t.prototype),"_onBatchCreated",this).call(this);for(var e=this._children.length,n=0;n<e;++n)this._children[n]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"getPosition",value:function(e){return s.copy(e||new s,s.ZERO)}},{key:"getRotation",value:function(e){return W.copy(e||new W,W.IDENTITY)}},{key:"getScale",value:function(e){return s.copy(e||new s,s.ONE)}},{key:"getWorldPosition",value:function(e){return s.copy(e||new s,s.ZERO)}},{key:"getWorldRotation",value:function(e){return W.copy(e||new W,W.IDENTITY)}},{key:"getWorldScale",value:function(e){return s.copy(e||new s,s.ONE)}},{key:"getWorldMatrix",value:function(e){return f.copy(e||new f,f.IDENTITY)}},{key:"getWorldRS",value:function(e){return f.copy(e||new f,f.IDENTITY)}},{key:"getWorldRT",value:function(e){return f.copy(e||new f,f.IDENTITY)}},{key:"updateWorldTransform",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(fu._setScene)}},{key:"_activate",value:function(e){e=!1!==e,a.director._nodeActivator.activateNode(this,e),this._globals.activate()}},{key:"position",get:function(){return s.ZERO}},{key:"worldPosition",get:function(){return s.ZERO}},{key:"rotation",get:function(){return W.IDENTITY}},{key:"worldRotation",get:function(){return W.IDENTITY}},{key:"scale",get:function(){return s.ONE}},{key:"worldScale",get:function(){return s.ONE}},{key:"eulerAngles",get:function(){return s.ZERO}},{key:"worldMatrix",get:function(){return f.IDENTITY}}]),t}(fu)).prototype,"globals",[w],Object.getOwnPropertyDescriptor(MT.prototype,"globals"),MT.prototype),LT=A(MT.prototype,"autoReleaseAssets",[b,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FT=A(MT.prototype,"_globals",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kT}}),zT=MT))||zT);a.Scene=BT;var GT=te.Flags.HideInHierarchy,jT=e("c_",E("cc.PrivateNode")(UT=function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,e)))._objFlags|=GT,n}return c(t,e),t}(Yu))||UT);a.PrivateNode=jT;var VT=ut.fastRemoveAt,HT=te.Flags.IsStartCalled,qT=te.Flags.IsOnEnableCalled;te.Flags.IsEditorOnEnableCalled;function WT(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function XT(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r._enabled&&r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}var YT=function e(t){o(this,e),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var n=_t;this._zero=new n([]),this._neg=new n([]),this._pos=new n([]),this._invoke=t};function KT(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}YT.stableRemoveInactive=XT;var QT=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){XT(this._zero,e),XT(this._neg,e),XT(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;e.array.length>0&&(e.array.sort(KT),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(KT),this._invoke(t),t.array.length=0)}}]),t}(YT),JT=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=WT(n,e);i<0&&n.splice(~i,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=WT(n.array,e);i>=0&&n.removeAt(i)}}},{key:"invoke",value:function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)}}]),t}(YT);function ZT(e,t,n){return function(i,r){try{t(i,r)}catch(t){a._throw(t);var o=i.array;for(n&&(o[i.i]._objFlags|=n),++i.i;i.i<o.length;++i.i)try{e(o[i.i],r)}catch(e){a._throw(e),n&&(o[i.i]._objFlags|=n)}}}}var $T=ZT((function(e){e.start(),e._objFlags|=HT}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var n=t[e.i];n.start(),n._objFlags|=HT}}),HT),eE=ZT((function(e,t){e.update(t)}),(function(e,t){var n=e.array;for(e.i=0;e.i<n.length;++e.i)n[e.i].update(t)})),tE=ZT((function(e,t){e.lateUpdate(t)}),(function(e,t){var n=e.array;for(e.i=0;e.i<n.length;++e.i)n[e.i].lateUpdate(t)})),nE=function(e){var t=a.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];if(i._enabled)i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i)}},iE=(e("dr",function(){function e(){o(this,e),this._deferredComps=[],this.unscheduleAll()}return r(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new QT($T),this.updateInvoker=new JT(eE),this.lateUpdateInvoker=new JT(tE),this._updating=!1}},{key:"_onEnabled",value:function(e){a.director.getScheduler().resumeTarget(e),e._objFlags|=qT,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){a.director.getScheduler().pauseTarget(e),e._objFlags&=~qT;var t=this._deferredComps.indexOf(e);t>=0?VT(this._deferredComps,t):(!e.start||e._objFlags&HT||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&qT)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&qT&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()}},{key:"_startForNewComps",value:function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}},{key:"_scheduleImmediate",value:function(e){"function"!=typeof e.start||e._objFlags&HT||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0}}]),e}()),te.Flags.IsPreloadStarted),rE=te.Flags.IsOnLoadStarted,oE=te.Flags.IsOnLoadCalled,aE=te.Flags.Deactivating,sE=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){YT.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),t}(YT),cE=ZT((function(e){e.__preload()}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i)t[e.i].__preload()})),lE=ZT((function(e){e.onLoad(),e._objFlags|=oE}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var n=t[e.i];n.onLoad(),n._objFlags|=oE}}),oE),uE=new Le(4);function _E(e,t,n){t?e._removeComponent(t):ut.removeAt(e._components,n)}uE.get=function(){var e=this._get()||{preload:new sE(cE),onLoad:new QT(lE),onEnable:new QT(nE)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};e("c$",function(){function e(){o(this,e),this.resetComp=void 0,this.reset()}return r(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var n=uE.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),uE.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=this._activatingStack,o=N(r);!(i=o()).done;){var a=i.value;a.preload.cancelInactive(iE),a.onLoad.cancelInactive(rE),a.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,n,i){if(e._objFlags&iE||(e._objFlags|=iE,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&rE||(e._objFlags|=rE,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=oE):e._objFlags|=oE),e._enabled){if(!e.node._activeInHierarchy)return;a.director._compScheduler.enableComp(e,i)}}},{key:"destroyComp",value:function(e){a.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&oE&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,n,i){if(e._objFlags&aE)L(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,o=0;o<r;++o){var s=e._components[o];s instanceof a.Component?this.activateComp(s,t,n,i):(_E(e,s,o),--o,--r)}e._childArrivalOrder=e._children.length;for(var c=0,l=e._children.length;c<l;++c){var u=e._children[c];u._active&&this._activateNodeRecursively(u,t,n,i)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=aE,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(a.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~aE)}for(var r=0,o=e._children.length;r<o;++r){var s=e._children[r];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~aE)}e._onPostActivated(!1),e._objFlags&=~aE}}]),e}());C(fu.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),C(Yu.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new X),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new K),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setContentSize(e,t)}}]),T(Yu.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),T(ua,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),C(ua,"Layers",[{name:"Default",newName:"DEFAULT",target:ua.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:ua.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:ua.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:ua.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:ua.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:ua.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:ua.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:ua.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:ua,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:ua,targetName:"Layers"}]),T(ua.Enum,"Layers.Enum",[{name:"ALWAYS"}]),T(ua.BitMask,"Layers.BitMask",[{name:"ALWAYS"}])}}}));
